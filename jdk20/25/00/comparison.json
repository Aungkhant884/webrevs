{"files":[{"patch":"@@ -38,1 +38,1 @@\n-    return;\t\t\t\/\/ Elided.\n+    return;\n@@ -63,0 +63,21 @@\n+static void z_cmpxchg_common(MacroAssembler& _masm, const MachNode* node, Register mem_reg, Register newval, Register tmp) {\n+  \/\/ Compare value (oldval) is in rax\n+   const Address mem = Address(mem_reg, 0);\n+\n+  if (node->barrier_data() != ZLoadBarrierElided) {\n+    __ movptr(tmp, rax);\n+  }\n+\n+  __ lock();\n+  __ cmpxchgptr(newval, mem);\n+\n+  if (node->barrier_data() != ZLoadBarrierElided) {\n+    Label good;\n+    z_load_barrier_cmpxchg(_masm, node, mem, rax, tmp, good);\n+    __ movptr(rax, tmp);\n+    __ lock();\n+    __ cmpxchgptr(newval, mem);\n+    __ bind(good);\n+  }\n+}\n+\n@@ -84,1 +105,1 @@\n-instruct zCompareAndExchangeP(memory mem, rax_RegP oldval, rRegP newval, rRegP tmp, rFlagsReg cr) %{\n+instruct zCompareAndExchangeP(indirect mem, rax_RegP oldval, rRegP newval, rRegP tmp, rFlagsReg cr) %{\n@@ -93,14 +114,2 @@\n-    if (barrier_data() != ZLoadBarrierElided) { \/\/ barrier could be elided by ZBarrierSetC2::analyze_dominating_barriers()\n-      __ movptr($tmp$$Register, $oldval$$Register);\n-    }\n-    __ lock();\n-    __ cmpxchgptr($newval$$Register, $mem$$Address);\n-\n-    if (barrier_data() != ZLoadBarrierElided) {\n-      Label good;\n-      z_load_barrier_cmpxchg(_masm, this, $mem$$Address, $oldval$$Register, $tmp$$Register, good);\n-      __ movptr($oldval$$Register, $tmp$$Register);\n-      __ lock();\n-      __ cmpxchgptr($newval$$Register, $mem$$Address);\n-      __ bind(good);\n-    }\n+    precond($oldval$$Register == rax);\n+    z_cmpxchg_common(_masm, this, $mem$$Register, $newval$$Register, $tmp$$Register);\n@@ -112,1 +121,1 @@\n-instruct zCompareAndSwapP(rRegI res, memory mem, rRegP newval, rRegP tmp, rFlagsReg cr, rax_RegP oldval) %{\n+instruct zCompareAndSwapP(rRegI res, indirect mem, rRegP newval, rRegP tmp, rFlagsReg cr, rax_RegP oldval) %{\n@@ -124,6 +133,2 @@\n-    if (barrier_data() != ZLoadBarrierElided) { \/\/ barrier could be elided by ZBarrierSetC2::analyze_dominating_barriers()\n-      __ movptr($tmp$$Register, $oldval$$Register);\n-    }\n-    __ lock();\n-    __ cmpxchgptr($newval$$Register, $mem$$Address);\n-\n+    precond($oldval$$Register == rax);\n+    z_cmpxchg_common(_masm, this, $mem$$Register, $newval$$Register, $tmp$$Register);\n@@ -131,7 +136,1 @@\n-      Label good;\n-      z_load_barrier_cmpxchg(_masm, this, $mem$$Address, $oldval$$Register, $tmp$$Register, good);\n-      __ movptr($oldval$$Register, $tmp$$Register);\n-      __ lock();\n-      __ cmpxchgptr($newval$$Register, $mem$$Address);\n-      __ bind(good);\n-      __ cmpptr($tmp$$Register, $oldval$$Register);\n+      __ cmpptr($tmp$$Register, rax);\n@@ -146,1 +145,1 @@\n-instruct zXChgP(memory mem, rRegP newval, rFlagsReg cr) %{\n+instruct zXChgP(indirect mem, rRegP newval, rFlagsReg cr) %{\n@@ -154,1 +153,1 @@\n-    __ xchgptr($newval$$Register, $mem$$Address);\n+    __ xchgptr($newval$$Register, Address($mem$$Register, 0));\n","filename":"src\/hotspot\/cpu\/x86\/gc\/z\/z_x86_64.ad","additions":31,"deletions":32,"binary":false,"changes":63,"status":"modified"},{"patch":"@@ -29,68 +29,0 @@\n-\n-java\/lang\/StackWalker\/AcrossThreads.java 8297235 generic-x64\n-java\/math\/BigInteger\/BigIntegerParallelMultiplyTest.java 8297235 generic-x64\n-java\/util\/Arrays\/SetAllTest.java 8297235 generic-x64\n-java\/util\/Arrays\/Sorting.java 8297235 generic-x64\n-java\/util\/Arrays\/largeMemory\/ParallelPrefix.java 8297235 generic-x64\n-java\/util\/BitSet\/stream\/BitSetStreamTest.java 8297235 generic-x64\n-java\/util\/Collection\/IteratorMicroBenchmark.java 8297235 generic-x64\n-java\/util\/Collections\/UnmodifiableMapEntrySet.java 8297235 generic-x64\n-java\/util\/DoubleStreamSums\/CompensatedSums.java 8297235 generic-x64\n-java\/util\/Random\/RandomTest.java 8297235 generic-x64\n-java\/util\/Scanner\/ScannerStreamTest.java 8297235 generic-x64\n-java\/util\/concurrent\/forkjoin\/AsyncShutdownNow.java 8297235 generic-x64\n-java\/util\/concurrent\/forkjoin\/AsyncShutdownNowInvokeAny.java 8297235 generic-x64\n-java\/util\/concurrent\/forkjoin\/AsyncShutdownNowInvokeAnyRace.java 8297235 generic-x64\n-java\/util\/concurrent\/forkjoin\/Integrate.java 8297235 generic-x64\n-java\/util\/concurrent\/forkjoin\/NQueensCS.java 8297235 generic-x64\n-java\/util\/concurrent\/tck\/JSR166TestCase.java 8297235 generic-x64\n-java\/util\/regex\/PatternStreamTest.java 8297235 generic-x64\n-java\/util\/stream\/CustomFJPoolTest.java 8297235 generic-x64\n-java\/util\/stream\/boottest\/java.base\/java\/util\/stream\/DoubleNodeTest.java 8297235 generic-x64\n-java\/util\/stream\/boottest\/java.base\/java\/util\/stream\/FlagOpTest.java 8297235 generic-x64\n-java\/util\/stream\/boottest\/java.base\/java\/util\/stream\/IntNodeTest.java 8297235 generic-x64\n-java\/util\/stream\/boottest\/java.base\/java\/util\/stream\/LongNodeTest.java 8297235 generic-x64\n-java\/util\/stream\/boottest\/java.base\/java\/util\/stream\/NodeTest.java 8297235 generic-x64\n-java\/util\/stream\/boottest\/java.base\/java\/util\/stream\/StreamReuseTest.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/SplittableRandomTest.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/CollectAndSummaryStatisticsTest.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/CollectorsTest.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/ConcatOpTest.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/CountTest.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/DistinctOpTest.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/DoublePrimitiveOpsTests.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/FilterOpTest.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/FindAnyOpTest.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/FindFirstOpTest.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/FlatMapOpTest.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/ForEachOpTest.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/GroupByOpTest.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/InfiniteStreamWithLimitOpTest.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/IntPrimitiveOpsTests.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/IntReduceTest.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/IntSliceOpTest.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/IntUniqOpTest.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/IterateTest.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/LongPrimitiveOpsTests.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/MapOpTest.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/MatchOpTest.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/MinMaxTest.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/PrimitiveAverageOpTest.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/PrimitiveSumTest.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/RangeTest.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/ReduceByOpTest.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/ReduceTest.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/SequentialOpTest.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/SliceOpTest.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/SortedOpTest.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/StreamBuilderTest.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/StreamLinkTest.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/StreamSpliteratorTest.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/TeeOpTest.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/ToArrayOpTest.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/ToListOpTest.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/WhileOpStatefulTest.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/WhileOpTest.java 8297235 generic-x64\n-java\/util\/stream\/test\/org\/openjdk\/tests\/java\/util\/stream\/mapMultiOpTest.java 8297235 generic-x64\n-\n-jdk\/internal\/vm\/Continuation\/Fuzz.java#default 8298058 generic-x64\n","filename":"test\/jdk\/ProblemList-zgc.txt","additions":0,"deletions":68,"binary":false,"changes":68,"status":"modified"}]}