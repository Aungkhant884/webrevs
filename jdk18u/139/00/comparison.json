{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2018, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2018, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -29,0 +29,1 @@\n+import java.nio.charset.Charset;\n@@ -34,1 +35,1 @@\n- * {@link System#setProperty) or {@link System#getProperties()} is ignored.\n+ * {@link System#setProperty} or {@link System#getProperties()} is ignored.\n@@ -55,0 +56,2 @@\n+    private static final String SUN_JNU_ENCODING;\n+    private static final Charset jnuCharset;\n@@ -72,0 +75,2 @@\n+        SUN_JNU_ENCODING = getProperty(props, \"sun.jnu.encoding\");\n+        jnuCharset = Charset.forName(SUN_JNU_ENCODING, Charset.defaultCharset());\n@@ -89,1 +94,1 @@\n-     * Return the {@code java.home} system property.\n+     * {@return the {@code java.home} system property}\n@@ -94,2 +99,0 @@\n-     *\n-     * @return the {@code java.home} system property\n@@ -102,1 +105,1 @@\n-     * Return the {@code user.home} system property.\n+     * {@return the {@code user.home} system property}\n@@ -107,2 +110,0 @@\n-     *\n-     * @return the {@code user.home} system property\n@@ -115,1 +116,1 @@\n-     * Return the {@code user.dir} system property.\n+     * {@return the {@code user.dir} system property}\n@@ -120,2 +121,0 @@\n-     *\n-     * @return the {@code user.dir} system property\n@@ -128,1 +127,1 @@\n-     * Return the {@code user.name} system property.\n+     * {@return the {@code user.name} system property}\n@@ -133,2 +132,0 @@\n-     *\n-     * @return the {@code user.name} system property\n@@ -141,1 +138,1 @@\n-     * Return the {@code java.library.path} system property.\n+     * {@return the {@code java.library.path} system property}\n@@ -146,2 +143,0 @@\n-     *\n-     * @return the {@code java.library.path} system property\n@@ -154,1 +149,1 @@\n-     * Return the {@code java.io.tmpdir} system property.\n+     * {@return the {@code java.io.tmpdir} system property}\n@@ -159,2 +154,0 @@\n-     *\n-     * @return the {@code java.io.tmpdir} system property\n@@ -167,1 +160,1 @@\n-     * Return the {@code sun.boot.library.path} system property.\n+     * {@return the {@code sun.boot.library.path} system property}\n@@ -172,2 +165,0 @@\n-     *\n-     * @return the {@code sun.boot.library.path} system property\n@@ -181,1 +172,1 @@\n-     * Return the {@code jdk.serialFilter} system property.\n+     * {@return the {@code jdk.serialFilter} system property}\n@@ -186,2 +177,0 @@\n-     *\n-     * @return the {@code jdk.serialFilter} system property\n@@ -195,1 +184,1 @@\n-     * Return the {@code jdk.serialFilterFactory} system property.\n+     * {@return the {@code jdk.serialFilterFactory} system property}\n@@ -200,2 +189,0 @@\n-     *\n-     * @return the {@code jdk.serialFilterFactory} system property\n@@ -208,1 +195,1 @@\n-     * Return the {@code native.encoding} system property.\n+     * {@return the {@code native.encoding} system property}\n@@ -213,2 +200,0 @@\n-     *\n-     * @return the {@code native.encoding} system property\n@@ -221,1 +206,1 @@\n-     * Return the {@code file.encoding} system property.\n+     * {@return the {@code file.encoding} system property}\n@@ -226,2 +211,0 @@\n-     *\n-     * @return the {@code file.encoding} system property\n@@ -234,1 +217,1 @@\n-     * Return the {@code java.properties.date} system property.\n+     * {@return the {@code java.properties.date} system property}\n@@ -238,2 +221,0 @@\n-     *\n-     * @return the {@code java.properties.date} system property\n@@ -244,0 +225,21 @@\n+\n+    \/**\n+     * {@return the {@code sun.jnu.encoding} system property}\n+     *\n+     * <strong>{@link SecurityManager#checkPropertyAccess} is NOT checked\n+     * in this method. The caller of this method should take care to ensure\n+     * that the returned property is not made accessible to untrusted code.<\/strong>\n+     *\/\n+    public static String jnuEncoding() {\n+        return SUN_JNU_ENCODING;\n+    }\n+\n+    \/**\n+     * {@return {@code Charset} for {@code sun.jnu.encoding} system property}\n+     *\n+     * <strong>If {@code sun.jnu.encoding} system property has invalid\n+     * encoding name, {@link Charset#defaultCharset()} is returned.<\/strong>\n+     *\/\n+    public static Charset jnuCharset() {\n+        return jnuCharset;\n+    }\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/util\/StaticProperty.java","additions":40,"deletions":38,"binary":false,"changes":78,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2003, 2011, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2003, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -58,0 +58,1 @@\n+import java.nio.charset.Charset;\n@@ -59,0 +60,1 @@\n+import jdk.internal.util.StaticProperty;\n@@ -166,1 +168,1 @@\n-            return new Variable(str, str.getBytes());\n+            return new Variable(str, str.getBytes(StaticProperty.jnuCharset()));\n@@ -175,1 +177,1 @@\n-            return new Variable(new String(bytes), bytes);\n+            return new Variable(new String(bytes, StaticProperty.jnuCharset()), bytes);\n@@ -199,1 +201,1 @@\n-            return new Value(str, str.getBytes());\n+            return new Value(str, str.getBytes(StaticProperty.jnuCharset()));\n@@ -208,1 +210,1 @@\n-            return new Value(new String(bytes), bytes);\n+            return new Value(new String(bytes, StaticProperty.jnuCharset()), bytes);\n","filename":"src\/java.base\/unix\/classes\/java\/lang\/ProcessEnvironment.java","additions":7,"deletions":5,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -38,0 +38,1 @@\n+import java.nio.charset.Charset;\n@@ -150,1 +151,1 @@\n-        byte[] bytes = s.getBytes();\n+        byte[] bytes = s.getBytes(StaticProperty.jnuCharset());\n@@ -174,1 +175,1 @@\n-            args[i] = cmdarray[i+1].getBytes();\n+            args[i] = cmdarray[i+1].getBytes(StaticProperty.jnuCharset());\n","filename":"src\/java.base\/unix\/classes\/java\/lang\/ProcessImpl.java","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -30,1 +30,1 @@\n- *      8067796 8224905 8263729 8265173 8272600 8231297 8282219\n+ *      8067796 8224905 8263729 8265173 8272600 8231297 8282219 8285517\n@@ -53,0 +53,1 @@\n+import java.nio.charset.Charset;\n@@ -601,1 +602,5 @@\n-            if (new String(tested.getBytes()).equals(tested)) {\n+            String jnuEncoding = System.getProperty(\"sun.jnu.encoding\");\n+            Charset cs = jnuEncoding != null\n+                ? Charset.forName(jnuEncoding, Charset.defaultCharset())\n+                : Charset.defaultCharset();\n+            if (new String(tested.getBytes(cs), cs).equals(tested)) {\n","filename":"test\/jdk\/java\/lang\/ProcessBuilder\/Basic.java","additions":7,"deletions":2,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -0,0 +1,183 @@\n+\/*\n+ * Copyright (c) 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/*\n+ * @test\n+ * @bug 8285517\n+ * @summary System.getenv() and argument don't return locale dependent data by JEP400\n+ * @requires (os.family == \"linux\")\n+ * @modules jdk.charsets\n+ * @library \/test\/lib\n+ * @build jdk.test.lib.process.*\n+ * @run main i18nEnvArg\n+ *\/\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.PrintStream;\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Method;\n+import java.nio.charset.Charset;\n+import java.util.Arrays;\n+import java.util.ArrayList;\n+import java.util.HexFormat;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import jdk.test.lib.process.ProcessTools;\n+\n+public class i18nEnvArg {\n+    final static String EUC_JP_TEXT = \"\\u6F22\\u5B57\";\n+\n+    \/*\n+     * Checks OS is Linux and OS has ja_JP.eucjp locale or not.\n+     * Sets EUC_JP's environment variable and argunments against ProcessBuilder\n+     *\/\n+    public static void main(String[] args) throws Exception {\n+        ProcessBuilder pb;\n+        List<String> cmds = new ArrayList<>();\n+        cmds.addAll(List.of(\n+            \"--add-modules=\" + System.getProperty(\"test.modules\"),\n+            \"-classpath\",\n+            System.getProperty(\"test.class.path\"),\n+            \"-Dtest.class.path=\" + System.getProperty(\"test.class.path\"),\n+            \"-Dtest.modules=\" + System.getProperty(\"test.modules\")));\n+        if (args.length == 0) {\n+            cmds.addAll(\n+                List.of(\"-Dtest.jdk=\" + System.getProperty(\"test.jdk\"),\n+                        \"i18nEnvArg\",\n+                        \"Start\"));\n+        } else {\n+            String jnuEncoding = System.getProperty(\"sun.jnu.encoding\");\n+            Charset dcs = jnuEncoding != null\n+                ? Charset.forName(jnuEncoding)\n+                : Charset.defaultCharset();\n+            Charset cs = Charset.forName(\"x-euc-jp-linux\");\n+            if (!dcs.equals(cs)) {\n+                return;\n+            }\n+            cmds.addAll(\n+                List.of(\"--add-opens=java.base\/java.lang=ALL-UNNAMED\",\n+                        \"i18nEnvArg$Verify\",\n+                        EUC_JP_TEXT));\n+        }\n+        pb = ProcessTools.createTestJvm(cmds);\n+        Map<String, String> environ = pb.environment();\n+        environ.clear();\n+        environ.put(\"LANG\", \"ja_JP.eucjp\");\n+        if (args.length != 0) {\n+            environ.put(EUC_JP_TEXT, EUC_JP_TEXT);\n+        }\n+        ProcessTools.executeProcess(pb)\n+            .outputTo(System.out)\n+            .errorTo(System.err)\n+            .shouldHaveExitValue(0);\n+    }\n+\n+    public static class Verify {\n+\n+        private static String toReadable(String s) {\n+            if (s == null)\n+                return \"null\";\n+            StringBuilder sb = new StringBuilder();\n+            for(char ch : s.toCharArray()) {\n+                sb.append(String.format(\"\\\\u%04X\", (int)ch));\n+            }\n+            return sb.toString();\n+        }\n+\n+        \/*\n+         * Verify environment variable and argument are encoded by Linux's\n+         * eucjp or not\n+         *\/\n+        public static void main(String[] args) throws Exception {\n+            Charset cs = Charset.forName(\"x-euc-jp-linux\");\n+            byte[] euc = EUC_JP_TEXT.getBytes(cs);\n+            try ( ByteArrayOutputStream baos = new ByteArrayOutputStream();\n+                PrintStream ps = new PrintStream(baos); ) {\n+                if (!EUC_JP_TEXT.equals(args[0])) {\n+                    ps.println(\"argument EUC_JP_TEXT is:\");\n+                    ps.println(\"  Actual:   \" + toReadable(args[0]));\n+                    ps.println(\"  Expected: \" + toReadable(EUC_JP_TEXT));\n+                }\n+                String s = System.getenv(EUC_JP_TEXT);\n+                if (!EUC_JP_TEXT.equals(s)) {\n+                    ps.println(\"getenv(\\\"EUC_JP_TEXT\\\") is:\");\n+                    ps.println(\"  Actual:   \" + toReadable(s));\n+                    ps.println(\"  Expected: \" + toReadable(EUC_JP_TEXT));\n+                } else {\n+                    try {\n+                        Class<?> ProcessEnvironment_cls =\n+                            Class.forName(\"java.lang.ProcessEnvironment\");\n+                        Field theEnvironment_fid =\n+                            ProcessEnvironment_cls.getDeclaredField(\"theEnvironment\");\n+                        theEnvironment_fid.setAccessible(true);\n+                        HashMap theEnvironment =\n+                            (HashMap) theEnvironment_fid.get(null);\n+                        Class<?> ExternalData_cls =\n+                            Class.forName(\"java.lang.ProcessEnvironment$ExternalData\");\n+                        Method getBytes_mid =\n+                            ExternalData_cls.getDeclaredMethod(\"getBytes\");\n+                        getBytes_mid.setAccessible(true);\n+                        HexFormat hf = HexFormat.of()\n+                            .withUpperCase()\n+                            .withPrefix(\"\\\\x\");\n+                        for (Object k : theEnvironment.keySet()) {\n+                            if (EUC_JP_TEXT.equals(k.toString())) {\n+                                byte[] ba = (byte[]) getBytes_mid.invoke(k,\n+                                    (Object[])null);\n+                                if (!Arrays.equals(euc, ba)) {\n+                                    ps.println(\n+                                        \"Variable EUC_JP_TEXT is encoded by:\");\n+                                    ps.println(\"  Actual:   \"\n+                                        + hf.formatHex(ba));\n+                                    ps.println(\"  Expected: \"\n+                                        + hf.formatHex(euc));\n+                                }\n+                                ba = (byte[]) getBytes_mid.invoke(\n+                                    theEnvironment.get(k),\n+                                    (Object[])null);\n+                                if (!Arrays.equals(euc, ba)) {\n+                                    ps.println(\n+                                        \"Value EUC_JP_TEXT is encoded by:\");\n+                                    ps.println(\"  Actual:   \"\n+                                        + hf.formatHex(ba));\n+                                    ps.println(\"  Expected: \"\n+                                        + hf.formatHex(euc));\n+                                }\n+                            }\n+                        }\n+                    } catch (Exception e) {\n+                        ps.println(\n+                            \"Check ProcessEnvironment class implementation\");\n+                        e.printStackTrace(ps);\n+                    }\n+                }\n+                byte[] ba = baos.toByteArray();\n+                if (ba.length > 0) {\n+                    System.err.write(ba);\n+                    System.exit(1);\n+                }\n+            }\n+        }\n+    }\n+}\n","filename":"test\/jdk\/java\/lang\/System\/i18nEnvArg.java","additions":183,"deletions":0,"binary":false,"changes":183,"status":"added"}]}