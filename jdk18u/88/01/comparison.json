{"files":[{"patch":"@@ -961,1 +961,2 @@\n-      x = new Constant(t, patch_state);\n+      bool kills_memory = stream()->is_dynamic_constant(); \/\/ arbitrary memory effects from running BSM during linkage\n+      x = new Constant(t, patch_state, kills_memory);\n","filename":"src\/hotspot\/share\/c1\/c1_GraphBuilder.cpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -367,0 +367,1 @@\n+    KillsMemoryFlag,\n@@ -722,1 +723,1 @@\n-  Constant(ValueType* type, ValueStack* state_before):\n+  Constant(ValueType* type, ValueStack* state_before, bool kills_memory = false):\n@@ -727,2 +728,2 @@\n-    \/\/ since it's patching it needs to be pinned\n-    pin();\n+    set_flag(KillsMemoryFlag, kills_memory);\n+    pin(); \/\/ since it's patching it needs to be pinned\n@@ -740,0 +741,2 @@\n+  bool kills_memory() const { return check_flag(KillsMemoryFlag); }\n+\n","filename":"src\/hotspot\/share\/c1\/c1_Instruction.hpp","additions":6,"deletions":3,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -168,1 +168,6 @@\n-  void do_Constant       (Constant*        x) { \/* nothing to do *\/ }\n+  void do_Constant       (Constant*        x) {\n+    if (x->kills_memory()) {\n+      assert(x->can_trap(), \"already linked\");\n+      kill_memory();\n+    }\n+  }\n","filename":"src\/hotspot\/share\/c1\/c1_ValueMap.hpp","additions":6,"deletions":1,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -254,0 +254,8 @@\n+\/\/ ------------------------------------------------------------------\n+\/\/ ciBytecodeStream::get_raw_pool_tag\n+\/\/\n+constantTag ciBytecodeStream::get_raw_pool_tag(int index) const {\n+  VM_ENTRY_MARK;\n+  return _method->get_Method()->constants()->tag_at(index);\n+}\n+\n","filename":"src\/hotspot\/share\/ci\/ciStreams.cpp","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -233,0 +233,2 @@\n+  constantTag get_raw_pool_tag(int index) const;\n+\n@@ -239,0 +241,11 @@\n+  bool is_dynamic_constant() const {\n+    assert(cur_bc() == Bytecodes::_ldc    ||\n+           cur_bc() == Bytecodes::_ldc_w  ||\n+           cur_bc() == Bytecodes::_ldc2_w, \"not supported: %s\", Bytecodes::name(cur_bc()));\n+\n+    int index = get_constant_pool_index();\n+    constantTag tag = get_raw_pool_tag(index);\n+    return tag.is_dynamic_constant() ||\n+           tag.is_dynamic_constant_in_error();\n+  }\n+\n","filename":"src\/hotspot\/share\/ci\/ciStreams.hpp","additions":13,"deletions":0,"binary":false,"changes":13,"status":"modified"}]}