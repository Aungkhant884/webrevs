{"files":[{"patch":"@@ -876,1 +876,1 @@\n-  return metaspace::chunklevel::MAX_CHUNK_WORD_SIZE;\n+  return metaspace::chunklevel::MAX_CHUNK_WORD_SIZE - KlassAlignmentInWords;\n","filename":"src\/hotspot\/share\/memory\/metaspace.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -250,0 +250,4 @@\n+\n+    MetaWord* salvage = nullptr;\n+    size_t salvage_words = alignment_padding_needed;\n+\n@@ -252,1 +256,1 @@\n-      \/\/ a new chunk to be created. No need to salvage the alignment gap.\n+      \/\/ a new chunk to be created. Salvage the trailing alignment gap.\n@@ -254,0 +258,1 @@\n+      salvage = k + word_size;\n@@ -255,10 +260,2 @@\n-      if (alignment_padding_needed > FreeBlocks::MinWordSize) {\n-        \/\/ If alignment gap is large enough to be reused, squirrel it away\n-        UL2(trace, \"Save off alignment gap \" PTR_FORMAT \", \" SIZE_FORMAT \" words.\",\n-            p2i(all), alignment_padding_needed);\n-        DEBUG_ONLY(InternalStats::inc_num_klass_alignment_splinters_added();)\n-        \/\/ Note: Don't use deallocate here; it is only for external use since it does size\n-        \/\/ adjustment\n-        add_allocation_to_fbl(all, alignment_padding_needed);\n-      }\n-      \/\/ Adjust Klass location to be properly aligned\n+      \/\/ The new allocation is not aligned; we expanded the current chunk. Salvage the leading\n+      \/\/ alignment padding.\n@@ -266,0 +263,11 @@\n+      salvage = all;\n+    }\n+\n+    \/\/ If alignment gap is large enough to be reused, squirrel it away\n+    if (alignment_padding_needed > FreeBlocks::MinWordSize) {\n+      UL2(trace, \"Save off alignment gap \" PTR_FORMAT \", \" SIZE_FORMAT \" words.\",\n+          p2i(salvage), alignment_padding_needed);\n+      DEBUG_ONLY(InternalStats::inc_num_klass_alignment_splinters_added();)\n+      \/\/ Note: Don't use deallocate here; it is only for external use since it does size\n+      \/\/ adjustment\n+      add_allocation_to_fbl(salvage, alignment_padding_needed);\n@@ -267,0 +275,1 @@\n+\n@@ -268,0 +277,1 @@\n+\n","filename":"src\/hotspot\/share\/memory\/metaspace\/metaspaceArena.cpp","additions":21,"deletions":11,"binary":false,"changes":32,"status":"modified"},{"patch":"@@ -380,2 +380,0 @@\n- -runtime\/Metaspace\/elastic\/TestMetaspaceAllocationMT1.java \\\n- -runtime\/Metaspace\/elastic\/TestMetaspaceAllocationMT2.java \\\n","filename":"test\/hotspot\/jtreg\/TEST.groups","additions":0,"deletions":2,"binary":false,"changes":2,"status":"modified"}]}