{"files":[{"patch":"@@ -59,1 +59,1 @@\n-  jmpb(next);\n+  jmp(next);\n","filename":"src\/hotspot\/cpu\/x86\/interp_masm_x86.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -4541,1 +4541,1 @@\n-void MacroAssembler::load_klass(Register dst, Register src, Register tmp) {\n+void MacroAssembler::load_klass(Register dst, Register src, Register tmp, bool null_check_src) {\n@@ -4545,4 +4545,53 @@\n-  if (UseCompressedClassPointers) {\n-    movl(dst, Address(src, oopDesc::klass_offset_in_bytes()));\n-    decode_klass_not_null(dst, tmp);\n-  } else\n+  assert(UseCompressedClassPointers, \"expect compressed class pointers\");\n+\n+  Label slow, done;\n+  if (null_check_src) {\n+    null_check(src, oopDesc::mark_offset_in_bytes());\n+  }\n+  movq(tmp, Address(src, oopDesc::mark_offset_in_bytes()));\n+  \/\/ NOTE: While it would seem nice to use xorb instead (for which we don't have an encoding in our assembler),\n+  \/\/ the encoding for xorq uses the signed version (0x81\/6) of xor, which encodes as compact as xorb would,\n+  \/\/ and does't make a difference performance-wise.\n+  xorq(tmp, markWord::unlocked_value);\n+  testb(tmp, markWord::lock_mask_in_place);\n+  jccb(Assembler::notZero, slow);\n+\n+  movq(dst, tmp);\n+  shrq(dst, markWord::klass_shift);\n+  decode_klass_not_null(dst, tmp);\n+  jmpb(done);\n+  bind(slow);\n+\n+  if (dst != rax) {\n+    push(rax);\n+  }\n+  push(rdi);\n+  push(rsi);\n+  push(rdx);\n+  push(rcx);\n+  push(r8);\n+  push(r9);\n+  push(r10);\n+  push(r11);\n+\n+  MacroAssembler::call_VM_leaf(CAST_FROM_FN_PTR(address, oopDesc::load_klass_runtime), src);\n+\n+  pop(r11);\n+  pop(r10);\n+  pop(r9);\n+  pop(r8);\n+  pop(rcx);\n+  pop(rdx);\n+  pop(rsi);\n+  pop(rdi);\n+  if (dst != rax) {\n+    mov(dst, rax);\n+    pop(rax);\n+  }\n+\n+  bind(done);\n+#else\n+  if (null_check_src) {\n+    null_check(src, oopDesc::klass_offset_in_bytes());\n+  }\n+  movptr(dst, Address(src, oopDesc::klass_offset_in_bytes()));\n@@ -4550,1 +4599,0 @@\n-    movptr(dst, Address(src, oopDesc::klass_offset_in_bytes()));\n","filename":"src\/hotspot\/cpu\/x86\/macroAssembler_x86.cpp","additions":54,"deletions":6,"binary":false,"changes":60,"status":"modified"},{"patch":"@@ -342,1 +342,1 @@\n-  void load_klass(Register dst, Register src, Register tmp);\n+  void load_klass(Register dst, Register src, Register tmp, bool null_check_src = false);\n","filename":"src\/hotspot\/cpu\/x86\/macroAssembler_x86.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -367,2 +367,1 @@\n-        __ null_check(receiver_reg, oopDesc::klass_offset_in_bytes());\n-        __ load_klass(temp1_recv_klass, receiver_reg, temp2);\n+        __ load_klass(temp1_recv_klass, receiver_reg, temp2, true);\n","filename":"src\/hotspot\/cpu\/x86\/methodHandles_x86.cpp","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -3660,1 +3660,0 @@\n-  __ null_check(recv, oopDesc::klass_offset_in_bytes());\n@@ -3662,1 +3661,1 @@\n-  __ load_klass(rax, recv, tmp_load_klass);\n+  __ load_klass(rax, recv, tmp_load_klass, true);\n@@ -3753,1 +3752,0 @@\n-  __ null_check(rcx, oopDesc::klass_offset_in_bytes());\n@@ -3755,1 +3753,1 @@\n-  __ load_klass(rlocals, rcx, tmp_load_klass);\n+  __ load_klass(rlocals, rcx, tmp_load_klass, true);\n@@ -3777,2 +3775,1 @@\n-  __ null_check(rcx, oopDesc::klass_offset_in_bytes());\n-  __ load_klass(rdx, rcx, tmp_load_klass);\n+  __ load_klass(rdx, rcx, tmp_load_klass, true);\n@@ -4188,1 +4185,1 @@\n-  __ jmpb(resolved);\n+  __ jmp(resolved);\n","filename":"src\/hotspot\/cpu\/x86\/templateTable_x86.cpp","additions":4,"deletions":7,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -221,1 +221,1 @@\n-  const ptrdiff_t estimate = 136;\n+  const ptrdiff_t estimate = 199;\n","filename":"src\/hotspot\/cpu\/x86\/vtableStubs_x86_64.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -37,0 +37,1 @@\n+#include \"runtime\/interfaceSupport.inline.hpp\"\n@@ -176,0 +177,5 @@\n+JRT_LEAF(Klass*, oopDesc::load_klass_runtime(oopDesc* o))\n+  assert(o != NULL, \"null-check\");\n+  return oop(o)->klass();\n+JRT_END\n+\n","filename":"src\/hotspot\/share\/oops\/oop.cpp","additions":6,"deletions":0,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -322,0 +322,3 @@\n+  \/\/ Runtime entry\n+  static Klass* load_klass_runtime(oopDesc* o);\n+\n","filename":"src\/hotspot\/share\/oops\/oop.hpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"}]}