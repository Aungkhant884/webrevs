{"files":[{"patch":"@@ -86,0 +86,3 @@\n+    public static final String CUSTOM_MAIN_WRAPPER = \"-mainWrapper\";\n+\n+    public static final String CUSTOM_MAIN_WRAPPER_PATH = \"-mainWrapperPath\";\n@@ -147,0 +150,3 @@\n+    private String customMainWrapper;\n+\n+    private String customMainWrapperPath;\n@@ -176,1 +182,5 @@\n-            } else {\n+            } else if (arg.equals(CUSTOM_MAIN_WRAPPER) && i + 1 < args.length) {\n+                customMainWrapper = args[++i];\n+            } else if (arg.equals(CUSTOM_MAIN_WRAPPER_PATH) && i + 1 < args.length) {\n+                customMainWrapperPath = args[++i];\n+        }   else {\n@@ -306,0 +316,2 @@\n+                    .customMainWrapper(customMainWrapper)\n+                    .customMainWrapperPath(customMainWrapperPath)\n","filename":"src\/share\/classes\/com\/sun\/javatest\/regtest\/agent\/AgentServer.java","additions":13,"deletions":1,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -0,0 +1,105 @@\n+\/*\n+ * Copyright (c) 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package com.sun.javatest.regtest.agent;\n+\n+import java.lang.reflect.Constructor;\n+import java.lang.reflect.InvocationTargetException;\n+import java.net.MalformedURLException;\n+import java.net.URL;\n+import java.net.URLClassLoader;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+public interface CustomMainWrapper {\n+    static CustomMainWrapper getInstance(String mainWrapper, String path) {\n+        String[] args = mainWrapper.split(\"=\", 2);\n+        String className = args[0];\n+        String options = args.length > 1 ? args[1] : \"\";\n+        ClassLoader loader = ClassLoader.getSystemClassLoader();\n+        if (path != null) {\n+            SearchPath classpath = new SearchPath(path);\n+            List<URL> urls = new ArrayList<>();\n+            for (Path f : classpath.asList()) {\n+                try {\n+                    urls.add(f.toUri().toURL());\n+                } catch (MalformedURLException e) {\n+                }\n+            }\n+            loader = new URLClassLoader(urls.toArray(new URL[urls.size()]), loader);\n+        }\n+        try {\n+            Class<? extends CustomMainWrapper> clz = loader.loadClass(className).asSubclass(CustomMainWrapper.class);\n+            Constructor<? extends CustomMainWrapper> ctor = clz.getDeclaredConstructor();\n+            CustomMainWrapper wrapper = ctor.newInstance();\n+            wrapper.setOption(options);\n+            return wrapper;\n+        } catch (ClassNotFoundException | NoSuchMethodException | InstantiationException | IllegalAccessException |\n+                 InvocationTargetException e) {\n+            throw new RuntimeException(e);\n+        }\n+    }\n+\n+    default void setOption(String options) {\n+    }\n+\n+    default Thread createThread(ThreadGroup tg, Runnable task) {\n+        return new Thread(tg, task);\n+    }\n+\n+    default List<String> getAdditionalVMOpts() {\n+        return Collections.emptyList();\n+    }\n+}\n+\n+class TestThread extends Thread {\n+    public TestThread(ThreadGroup group, Runnable target) {\n+        super(group, target);\n+    }\n+}\n+class TestMainWrapper implements CustomMainWrapper {\n+    private List<String>vmOpts = new ArrayList<>();\n+\n+    public TestMainWrapper() {\n+        vmOpts.add(\"-Dtest.property=test\");\n+    }\n+\n+    @Override\n+    public void setOption(String options) {\n+        System.setProperty(\"main.wrapper\", options);\n+    }\n+\n+    @Override\n+    public Thread createThread(ThreadGroup tg, Runnable task) {\n+        return new TestThread(tg, task);\n+    }\n+\n+    @Override\n+    public List<String> getAdditionalVMOpts() {\n+        return vmOpts;\n+    }\n+}\n","filename":"src\/share\/classes\/com\/sun\/javatest\/regtest\/agent\/CustomMainWrapper.java","additions":105,"deletions":0,"binary":false,"changes":105,"status":"added"},{"patch":"@@ -60,0 +60,3 @@\n+    private String customMainWrapper;\n+\n+    private String customMainWrapperPath;\n@@ -116,0 +119,10 @@\n+    MainActionHelper customMainWrapper(String customMainWrapper) {\n+        this.customMainWrapper = customMainWrapper;\n+        return this;\n+    }\n+\n+    MainActionHelper customMainWrapperPath(String customMainWrapperPath) {\n+        this.customMainWrapperPath = customMainWrapperPath;\n+        return this;\n+    }\n+\n@@ -186,0 +199,3 @@\n+            AgentVMRunnable avmr = new AgentVMRunnable(method, methodArgs, err);\n+\n+            \/\/ Main and Thread are same here\n@@ -188,2 +204,7 @@\n-            AgentVMRunnable avmr = new AgentVMRunnable(method, methodArgs, err);\n-            Thread t = new Thread(tg, avmr, \"AgentVMThread\");\n+            Thread t;\n+            if (customMainWrapper == null) {\n+                t = new Thread(tg, avmr);\n+            } else {\n+                t = CustomMainWrapper.getInstance(customMainWrapper, customMainWrapperPath).createThread(tg, avmr);\n+            }\n+\n@@ -196,0 +217,1 @@\n+            t.setName(\"AgentVMThread\");\n","filename":"src\/share\/classes\/com\/sun\/javatest\/regtest\/agent\/MainActionHelper.java","additions":24,"deletions":2,"binary":false,"changes":26,"status":"modified"},{"patch":"@@ -38,0 +38,4 @@\n+\n+    public static String MAIN_WRAPPER = \"jtreg.custom.main.wrapper\";\n+    public static String MAIN_WRAPPER_PATH = \"jtreg.custom.main.wrapper.path\";\n+\n@@ -68,2 +72,11 @@\n-        MainThreadGroup tg = new  MainThreadGroup();\n-        Thread t = new Thread(tg, new MainThread(moduleName, className, classArgs), \"MainThread\");\n+        MainThreadGroup tg = new MainThreadGroup();\n+        Runnable task = new MainTask(moduleName, className, classArgs);\n+        Thread t;\n+        String customWrapper = System.getProperty(MAIN_WRAPPER);\n+        String customWrapperPath = System.getProperty(MAIN_WRAPPER_PATH);\n+        if (customWrapper == null) {\n+            t = new Thread(tg, task);\n+        } else {\n+            t = CustomMainWrapper.getInstance(customWrapper, customWrapperPath).createThread(tg, task);\n+        }\n+        t.setName(\"MainThread\");\n@@ -97,2 +110,2 @@\n-    static class MainThread extends Thread {\n-        MainThread(String moduleName, String className, String[] args) {\n+    static class MainTask implements Runnable {\n+        MainTask(String moduleName, String className, String[] args) {\n@@ -222,0 +235,1 @@\n+\n@@ -223,0 +237,1 @@\n+\n","filename":"src\/share\/classes\/com\/sun\/javatest\/regtest\/agent\/MainWrapper.java","additions":19,"deletions":4,"binary":false,"changes":23,"status":"modified"},{"patch":"@@ -1248,0 +1248,19 @@\n+    \/\/---------------------------------------------------------------------\n+\n+    public void setCustomMainWrapper(String customMainWrapper) {\n+        this.customMainWrapper = customMainWrapper;\n+    }\n+\n+    String getCustomMainWrapper() {\n+        return customMainWrapper;\n+    }\n+\n+    private String customMainWrapper;\n+\n+    public void setCustomMainWrapperPath(List<Path>  customMainWrapperPath) {\n+        this.customMainWrapperPath = customMainWrapperPath;\n+    }\n+\n+    List<Path>  getCustomMainWrapperPath() {\n+        return customMainWrapperPath;\n+    }\n@@ -1249,0 +1268,1 @@\n+    private List<Path>  customMainWrapperPath;\n","filename":"src\/share\/classes\/com\/sun\/javatest\/regtest\/config\/RegressionParameters.java","additions":20,"deletions":0,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -97,1 +97,1 @@\n-            File policyFile, float timeoutFactor, Logger logger) throws Fault {\n+            File policyFile, float timeoutFactor, Logger logger, String customMainWrapper, String customMainWrapperPath) throws Fault {\n@@ -137,0 +137,9 @@\n+            if (customMainWrapper != null) {\n+                cmd.add(AgentServer.CUSTOM_MAIN_WRAPPER);\n+                cmd.add(customMainWrapper);\n+            }\n+\n+            if (customMainWrapperPath != null) {\n+                cmd.add(CUSTOM_MAIN_WRAPPER_PATH);\n+                cmd.add(customMainWrapperPath);\n+            }\n@@ -703,0 +712,8 @@\n+        public void setCustomMainWrapper(String wrapper) {\n+            this.customMainWrapper = wrapper;\n+        }\n+\n+        public void setCustomMainWrapperPath(String wrapperPath) {\n+            this.customMainWrapperPath = wrapperPath;\n+        }\n+\n@@ -759,1 +776,1 @@\n-                a = new Agent(dir, jdk, vmOpts, envVars, policyFile, timeoutFactor, logger);\n+                a = new Agent(dir, jdk, vmOpts, envVars, policyFile, timeoutFactor, logger, customMainWrapper, customMainWrapperPath);\n@@ -915,0 +932,2 @@\n+        private String customMainWrapper;\n+        private String customMainWrapperPath;\n","filename":"src\/share\/classes\/com\/sun\/javatest\/regtest\/exec\/Agent.java","additions":21,"deletions":2,"binary":false,"changes":23,"status":"modified"},{"patch":"@@ -91,0 +91,1 @@\n+import com.sun.javatest.regtest.agent.CustomMainWrapper;\n@@ -124,0 +125,1 @@\n+import com.sun.javatest.regtest.agent.MainWrapper;\n@@ -536,0 +538,14 @@\n+       new Option(OLD, MAIN, \"\", \"-mw\", \"-mainWrapper\") {\n+            @Override\n+            public void process(String opt, String arg) {\n+                customMainWrapper = arg;\n+            }\n+        },\n+\n+        new Option(STD, MAIN, \"\", \"-mwp\", \"-mainWrapperPath\") {\n+            @Override\n+            public void process(String opt, String arg) {\n+                customMainWrapperPathArg = arg;\n+            }\n+        },\n+\n@@ -1206,0 +1222,11 @@\n+        if (customMainWrapper != null) {\n+            CustomMainWrapper cmw = CustomMainWrapper.getInstance(customMainWrapper, customMainWrapperPathArg);\n+            testVMOpts.add(\"-D\" + MainWrapper.MAIN_WRAPPER + \"=\" + customMainWrapper);\n+            testVMOpts.addAll(cmw.getAdditionalVMOpts());\n+        }\n+\n+        if (customMainWrapperPathArg != null) {\n+            testVMOpts.add(\"-D\" + MainWrapper.MAIN_WRAPPER_PATH + \"=\" + customMainWrapperPathArg);\n+        }\n+\n+\n@@ -1288,0 +1315,6 @@\n+                    if (customMainWrapper != null) {\n+                        p.setCustomMainWrapper(customMainWrapper);\n+                    }\n+                    if (customMainWrapperPathArg != null) {\n+                        p.setCustomMainWrapperPath(customMainWrapperPathArg);\n+                    }\n@@ -1606,1 +1639,0 @@\n-\n@@ -2281,0 +2313,2 @@\n+    private String customMainWrapper;\n+    private String customMainWrapperPathArg;\n","filename":"src\/share\/classes\/com\/sun\/javatest\/regtest\/tool\/Tool.java","additions":35,"deletions":1,"binary":false,"changes":36,"status":"modified"},{"patch":"@@ -174,0 +174,4 @@\n+help.main.mw.arg=<classname>=[options]\n+help.main.mw.desc=Main wrapper classname and arguments.\n+help.main.mwp.arg=Main wrapper classpath\n+help.main.mwp.desc=Specifies classspath with custom main wrapper implementation.\n","filename":"src\/share\/classes\/com\/sun\/javatest\/regtest\/tool\/i18n.properties","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -0,0 +1,44 @@\n+\/*\n+ * Copyright (c) 2017, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/*\n+ * @test\n+ * @run driver DriverTest\n+ *\/\n+\n+public class DriverTest {\n+    public static void main(String... args) throws Exception {\n+        if (!\"Test\".equals(System.getProperty(\"main.wrapper\"))) {\n+            throw new Exception(\"Property 'main.wrapper' = \" + System.getProperty(\"main.wrapper\"));\n+        }\n+\n+        if (!\"test\".equals(System.getProperty(\"test.property\"))) {\n+            throw new Exception(\"Property 'test.property'  = \" + System.getProperty(\"test.property\"));\n+        }\n+\n+        String threadClassName = Thread.currentThread().getClass().getName();\n+        if (!threadClassName.equals(\"com.sun.javatest.regtest.agent.TestThread\")) {\n+            throw new Exception(\"Main Thread is expected : \" + threadClassName);\n+        }\n+    }\n+}\n","filename":"test\/mainWrapper\/DriverTest.java","additions":44,"deletions":0,"binary":false,"changes":44,"status":"added"},{"patch":"","filename":"test\/mainWrapper\/TEST.ROOT","additions":0,"deletions":0,"binary":false,"changes":0,"previous_filename":"test\/4499340\/test\/TEST.ROOT","status":"copied"},{"patch":"@@ -0,0 +1,49 @@\n+\/*\n+ * Copyright (c) 2017, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/*\n+ * @test\n+ * @run main\/othervm Test\n+ *\/\n+\n+\/*\n+ * @test\n+ * @run main Test\n+ *\/\n+\n+public class Test {\n+    public static void main(String... args) throws Exception {\n+        if (!\"Test\".equals(System.getProperty(\"main.wrapper\"))) {\n+            throw new Exception(\"Property 'main.wrapper' = \" + System.getProperty(\"main.wrapper\"));\n+        }\n+\n+        if (!\"test\".equals(System.getProperty(\"test.property\"))) {\n+            throw new Exception(\"Property 'test.property'  = \" + System.getProperty(\"test.property\"));\n+        }\n+\n+        String threadClassName = Thread.currentThread().getClass().getName();\n+        if (!threadClassName.equals(\"com.sun.javatest.regtest.agent.TestThread\")) {\n+            throw new Exception(\"Main Thread is expected : \" + threadClassName);\n+        }\n+    }\n+}\n","filename":"test\/mainWrapper\/Test.java","additions":49,"deletions":0,"binary":false,"changes":49,"status":"added"},{"patch":"@@ -0,0 +1,49 @@\n+#\n+# Copyright (c) 1997, 2022, Oracle and\/or its affiliates. All rights reserved.\n+# DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+#\n+# This code is free software; you can redistribute it and\/or modify it\n+# under the terms of the GNU General Public License version 2 only, as\n+# published by the Free Software Foundation.  Oracle designates this\n+# particular file as subject to the \"Classpath\" exception as provided\n+# by Oracle in the LICENSE file that accompanied this code.\n+#\n+# This code is distributed in the hope that it will be useful, but WITHOUT\n+# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+# FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+# version 2 for more details (a copy is included in the LICENSE file that\n+# accompanied this code).\n+#\n+# You should have received a copy of the GNU General Public License version\n+# 2 along with this work; if not, write to the Free Software Foundation,\n+# Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+#\n+# Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+# or visit www.oracle.com if you need additional information or have any\n+# questions.\n+#\n+\n+#----------------------------------------------------------------------\n+\n+JTREG_OPTS += \\\n+\t-mainWrapper:com.sun.javatest.regtest.agent.TestMainWrapper=Test\n+\n+$(BUILDTESTDIR)\/TestMainWrapper.ok: $(JTREG_IMAGEDIR)\/lib\/javatest.jar \\\n+\t\t$(JTREG_IMAGEDIR)\/lib\/jtreg.jar \\\n+\t\t$(JTREG_IMAGEDIR)\/bin\/jtreg\n+\tJTREG_JAVA=$(JDKJAVA) $(JTREG_IMAGEDIR)\/bin\/jtreg $(JTREG_OPTS) \\\n+\t\t-jdk:$(JDKHOME) \\\n+\t\t-w:$(@:%.ok=%)\/cmd.othervm\/work \\\n+\t\t-r:$(@:%.ok=%)\/cmd.othervm\/report \\\n+\t\t-verbose:fail \\\n+\t\t$(TESTDIR)\/mainWrapper\n+\tJTREG_JAVA=$(JDKJAVA) $(JTREG_IMAGEDIR)\/bin\/jtreg $(JTREG_OPTS) \\\n+\t\t-jdk:$(JDKHOME) \\\n+                -agentvm \\\n+\t\t-w:$(@:%.ok=%)\/cmd.agentvm\/work \\\n+\t\t-r:$(@:%.ok=%)\/cmd.agentvm\/report \\\n+\t\t-verbose:fail \\\n+\t\t$(TESTDIR)\/mainWrapper\n+\techo \"test passed at `date`\" > $@\n+\n+TESTS.jtreg += $(BUILDTESTDIR)\/TestMainWrapper.ok\n","filename":"test\/mainWrapper\/TestMainWrapper.gmk","additions":49,"deletions":0,"binary":false,"changes":49,"status":"added"}]}