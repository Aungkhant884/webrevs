{"files":[{"patch":"@@ -12,0 +12,2 @@\n+  * Improve per-class reporting of JUnit tests, in `.jtr` file.\n+    [CODETOOLS-7903324](https:\/\/bugs.openjdk.org\/browse\/CODETOOLS-7903324)\n","filename":"CHANGELOG.md","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -28,0 +28,2 @@\n+import org.junit.platform.engine.TestExecutionResult;\n+import org.junit.platform.engine.TestSource;\n@@ -29,1 +31,3 @@\n-import org.junit.platform.launcher.Launcher;\n+import org.junit.platform.engine.reporting.ReportEntry;\n+import org.junit.platform.engine.support.descriptor.MethodSource;\n+import org.junit.platform.launcher.LauncherConstants;\n@@ -32,0 +36,3 @@\n+import org.junit.platform.launcher.TestExecutionListener;\n+import org.junit.platform.launcher.TestIdentifier;\n+import org.junit.platform.launcher.core.LauncherConfig;\n@@ -37,0 +44,1 @@\n+import java.io.PrintStream;\n@@ -40,0 +48,3 @@\n+import java.util.Optional;\n+import java.util.concurrent.locks.Lock;\n+import java.util.concurrent.locks.ReentrantLock;\n@@ -116,1 +127,0 @@\n-            String testQuery = System.getProperty(\"test.query\");\n@@ -118,0 +128,1 @@\n+            String testQuery = System.getProperty(\"test.query\");\n@@ -126,4 +137,7 @@\n-            try (LauncherSession session = LauncherFactory.openSession()) {\n-                Launcher launcher = session.getLauncher();\n-                launcher.registerTestExecutionListeners(summaryGeneratingListener);\n-                launcher.execute(request);\n+            LauncherConfig launcherConfig = LauncherConfig.builder()\n+                .addTestExecutionListeners(new PrintingListener(System.err))\n+                .addTestExecutionListeners(summaryGeneratingListener)\n+                .build();\n+\n+            try (LauncherSession session = LauncherFactory.openSession(launcherConfig)) {\n+                session.getLauncher().execute(request);\n@@ -133,9 +147,1 @@\n-            StringWriter sw = new StringWriter();\n-            try (PrintWriter pw = new PrintWriter(sw)) {\n-                if (summary.getTotalFailureCount() > 0) {\n-                    pw.println(\"JavaTest Message: JUnit Platform Failure(s): \" + summary.getTotalFailureCount());\n-                    pw.println();\n-                    for (TestExecutionSummary.Failure failure : summary.getFailures()) {\n-                        failure.getException().printStackTrace(pw);\n-                    }\n-                }\n+            System.err.println(summarize(summary));\n@@ -143,24 +149,2 @@\n-                \/\/ The format of the following output is assumed in the JUnit SummaryReporter\n-                pw.println();\n-                pw.print(\"[ JUnit Containers: \");\n-                pw.print(\"found \" + summary.getContainersFoundCount());\n-                pw.print(\", started \" + summary.getContainersStartedCount());\n-                pw.print(\", succeeded \" + summary.getContainersSucceededCount());\n-                pw.print(\", failed \" + summary.getContainersFailedCount());\n-                pw.print(\", aborted \" + summary.getContainersAbortedCount());\n-                pw.print(\", skipped \" + summary.getContainersSkippedCount());\n-                pw.println(\"]\");\n-                pw.print(\"[ JUnit Tests: \");\n-                pw.print(\"found \" + summary.getTestsFoundCount());\n-                pw.print(\", started \" + summary.getTestsStartedCount());\n-                pw.print(\", succeeded \" + summary.getTestsSucceededCount());\n-                pw.print(\", failed \" + summary.getTestsFailedCount());\n-                pw.print(\", aborted \" + summary.getTestsAbortedCount());\n-                pw.print(\", skipped \" + summary.getTestsSkippedCount());\n-                pw.println(\"]\");\n-\n-                System.err.println(sw);\n-\n-                if (summary.getTotalFailureCount() > 0) {\n-                    throw new Exception(\"JUnit test failure\");\n-                }\n+            if (summary.getTotalFailureCount() > 0) {\n+                throw new Exception(\"JUnit test failure\");\n@@ -173,0 +157,121 @@\n+\n+    static String summarize(TestExecutionSummary summary) {\n+        StringWriter sw = new StringWriter();\n+        try (PrintWriter pw = new PrintWriter(sw)) {\n+            if (summary.getTotalFailureCount() > 0) {\n+                pw.println(\"JavaTest Message: JUnit Platform Failure(s): \" + summary.getTotalFailureCount());\n+            }\n+\n+            \/\/ The format of the following output is assumed in the JUnit SummaryReporter\n+            pw.println();\n+            pw.print(\"[ JUnit Containers: \");\n+            pw.print(\"found \" + summary.getContainersFoundCount());\n+            pw.print(\", started \" + summary.getContainersStartedCount());\n+            pw.print(\", succeeded \" + summary.getContainersSucceededCount());\n+            pw.print(\", failed \" + summary.getContainersFailedCount());\n+            pw.print(\", aborted \" + summary.getContainersAbortedCount());\n+            pw.print(\", skipped \" + summary.getContainersSkippedCount());\n+            pw.println(\"]\");\n+            pw.print(\"[ JUnit Tests: \");\n+            pw.print(\"found \" + summary.getTestsFoundCount());\n+            pw.print(\", started \" + summary.getTestsStartedCount());\n+            pw.print(\", succeeded \" + summary.getTestsSucceededCount());\n+            pw.print(\", failed \" + summary.getTestsFailedCount());\n+            pw.print(\", aborted \" + summary.getTestsAbortedCount());\n+            pw.print(\", skipped \" + summary.getTestsSkippedCount());\n+            pw.println(\"]\");\n+        }\n+        return sw.toString();\n+    }\n+\n+    static class PrintingListener implements TestExecutionListener {\n+\n+        final PrintWriter printer;\n+        final Lock lock;\n+\n+        PrintingListener(PrintStream stream) {\n+            this(new PrintWriter(stream, true));\n+        }\n+\n+        PrintingListener(PrintWriter printer) {\n+            this.printer = printer;\n+            this.lock = new ReentrantLock();\n+        }\n+\n+        @Override\n+        public void executionSkipped(TestIdentifier identifier, String reason) {\n+            if (identifier.isTest()) {\n+                String status = \"SKIPPED\";\n+                String source = toSourceString(identifier);\n+                String name = identifier.getDisplayName();\n+                lock.lock();\n+                try {\n+                    printer.printf(\"%-10s %s '%s' %s%n\", status, source, name, reason);\n+                }\n+                finally {\n+                    lock.unlock();\n+                }\n+            }\n+        }\n+\n+        @Override\n+        public void executionStarted(TestIdentifier identifier) {\n+            if (identifier.isTest()) {\n+                String status = \"STARTED\";\n+                String source = toSourceString(identifier);\n+                String name = identifier.getDisplayName();\n+                lock.lock();\n+                try {\n+                    printer.printf(\"%-10s %s '%s'%n\", status, source, name);\n+                }\n+                finally {\n+                    lock.unlock();\n+                }\n+            }\n+        }\n+\n+        @Override\n+        public void executionFinished(TestIdentifier identifier, TestExecutionResult result) {\n+            if (identifier.isTest()) {\n+                lock.lock();\n+                try {\n+                    TestExecutionResult.Status status = result.getStatus();\n+                    if (status == TestExecutionResult.Status.ABORTED) {\n+                        result.getThrowable().ifPresent(printer::println); \/\/ not the entire stack trace\n+                    }\n+                    if (status == TestExecutionResult.Status.FAILED) {\n+                        result.getThrowable().ifPresent(throwable -> throwable.printStackTrace(printer));\n+                    }\n+                    String source = toSourceString(identifier);\n+                    String name = identifier.getDisplayName();\n+                    printer.printf(\"%-10s %s '%s'%n\", status, source, name);\n+                }\n+                finally {\n+                    lock.unlock();\n+                }\n+            }\n+        }\n+\n+        @Override\n+        public void reportingEntryPublished(TestIdentifier identifier, ReportEntry entry) {\n+            lock.lock();\n+            try {\n+                printer.println(identifier.getDisplayName() + \" -> \" + entry.getTimestamp());\n+                entry.getKeyValuePairs().forEach((key, value) -> printer.println(key + \" -> \" + value));\n+            }\n+            finally {\n+                lock.unlock();\n+            }\n+        }\n+\n+        private static String toSourceString(TestIdentifier identifier) {\n+            Optional<TestSource> optionalTestSource = identifier.getSource();\n+            if (!optionalTestSource.isPresent()) return \"<no test source>\";\n+            TestSource testSource = optionalTestSource.get();\n+            if (testSource instanceof MethodSource) {\n+                MethodSource source = (MethodSource) testSource;\n+                return source.getClassName() + \"::\" + source.getMethodName();\n+            }\n+            return testSource.toString();\n+        }\n+    }\n","filename":"src\/share\/classes\/com\/sun\/javatest\/regtest\/agent\/JUnitRunner.java","additions":144,"deletions":39,"binary":false,"changes":183,"status":"modified"},{"patch":"@@ -51,0 +51,2 @@\n+INITIAL_TESTS += \\\n+\t$(BUILDTESTDIR)\/JUnitTrace.agentvm.ok\n","filename":"test\/junitTrace\/JUnitTrace.gmk","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -49,1 +49,1 @@\n-        Assertions.fail(\"test should have been executed\");\n+        Assertions.fail(\"test should NOT be executed\");\n@@ -61,1 +61,1 @@\n-    @ValueSource(strings = {\" \", \"   \", \"\\t\", \"\\n\", \"\\r\\n\"})\n+    @ValueSource(strings = {\" \", \"   \", \"\\t\"})\n@@ -66,0 +66,9 @@\n+    @Disabled\n+    @ParameterizedTest\n+    @ValueSource(ints = {0, 1, 2})\n+    void test(int i) {\n+        System.err.println(\"i=\" + i);\n+        Assertions.assertNotEquals(1, i);\n+        System.err.println(i + \" is not 1\");\n+    }\n+\n","filename":"test\/junitTrace\/JupiterTests.java","additions":11,"deletions":2,"binary":false,"changes":13,"status":"modified"}]}