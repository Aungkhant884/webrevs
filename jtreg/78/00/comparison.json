{"files":[{"patch":"@@ -114,1 +114,1 @@\n-AGENT_JAVAC_SOURCE_TARGET = --release 8\n+AGENT_JAVAC_SOURCE_TARGET = --release 11\n","filename":"make\/Defs.gmk","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -28,0 +28,5 @@\n+import org.junit.platform.engine.discovery.DiscoverySelectors;\n+import org.junit.platform.launcher.core.LauncherDiscoveryRequestBuilder;\n+import org.junit.platform.launcher.core.LauncherFactory;\n+import org.junit.platform.launcher.listeners.SummaryGeneratingListener;\n+\n@@ -32,1 +37,0 @@\n-\n@@ -38,1 +42,1 @@\n-        JUNIT_NO_DRIVER        = \"No JUnit 4 driver (install junit.jar next to jtreg.jar)\";\n+        JUNIT_NO_DRIVER        = \"No JUnit driver (install junit-platform-console-standalone.jar next to jtreg.jar)\";\n@@ -72,0 +76,5 @@\n+        \/\/ runWithJUnit4(mainClass);\n+        runWithJUnitPlatform(mainClass);\n+    }\n+\n+    private static void runWithJUnit4(Class<?> mainClass) throws Exception {\n@@ -94,0 +103,32 @@\n+    private static void runWithJUnitPlatform(Class<?> mainClass) throws Exception {\n+        \/\/ https:\/\/junit.org\/junit5\/docs\/current\/user-guide\/#launcher-api-execution\n+        Thread.currentThread().setContextClassLoader(mainClass.getClassLoader());\n+        try {\n+\n+            var request = LauncherDiscoveryRequestBuilder.request()\n+                .selectors(DiscoverySelectors.selectClass(mainClass))\n+                .build();\n+\n+            var summaryGeneratingListener = new SummaryGeneratingListener();\n+\n+            try (var session = LauncherFactory.openSession()) {\n+                var launcher = session.getLauncher();\n+                launcher.registerTestExecutionListeners(summaryGeneratingListener);\n+                launcher.execute(request);\n+            }\n+\n+            var summary = summaryGeneratingListener.getSummary();\n+            if (summary.getTotalFailureCount() > 0) {\n+                var sw = new StringWriter();\n+                try (var pw = new PrintWriter(sw)) {\n+                    pw.println(\"JavaTest Message: JUnit Platform Failure(s): \" + summary.getTotalFailureCount());\n+                    summary.printTo(pw);\n+                }\n+                System.err.println(sw);\n+                throw new Exception(\"JUnit test failure\");\n+            }\n+\n+        } catch (NoClassDefFoundError ex) {\n+            throw new Exception(JUNIT_NO_DRIVER, ex);\n+        }\n+    }\n","filename":"src\/share\/classes\/com\/sun\/javatest\/regtest\/agent\/JUnitRunner.java","additions":43,"deletions":2,"binary":false,"changes":45,"status":"modified"}]}