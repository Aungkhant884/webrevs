{"files":[{"patch":"@@ -114,1 +114,1 @@\n-AGENT_JAVAC_SOURCE_TARGET = --release 8\n+AGENT_JAVAC_SOURCE_TARGET = --release 11\n","filename":"make\/Defs.gmk","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -28,0 +28,5 @@\n+import org.junit.platform.engine.discovery.DiscoverySelectors;\n+import org.junit.platform.launcher.core.LauncherDiscoveryRequestBuilder;\n+import org.junit.platform.launcher.core.LauncherFactory;\n+import org.junit.platform.launcher.listeners.SummaryGeneratingListener;\n+\n@@ -32,1 +37,0 @@\n-\n@@ -38,1 +42,1 @@\n-        JUNIT_NO_DRIVER        = \"No JUnit 4 driver (install junit.jar next to jtreg.jar)\";\n+        JUNIT_NO_DRIVER        = \"No JUnit driver (install junit-platform-console-standalone.jar next to jtreg.jar)\";\n@@ -72,0 +76,5 @@\n+        \/\/ runWithJUnit4(mainClass);\n+        runWithJUnitPlatform(mainClass);\n+    }\n+\n+    private static void runWithJUnit4(Class<?> mainClass) throws Exception {\n@@ -94,0 +103,36 @@\n+    private static void runWithJUnitPlatform(Class<?> mainClass) throws Exception {\n+        \/\/ https:\/\/junit.org\/junit5\/docs\/current\/user-guide\/#launcher-api-execution\n+        Thread.currentThread().setContextClassLoader(mainClass.getClassLoader());\n+        try {\n+\n+            var request = LauncherDiscoveryRequestBuilder.request()\n+                .selectors(DiscoverySelectors.selectClass(mainClass))\n+                .build();\n+\n+            var summaryGeneratingListener = new SummaryGeneratingListener();\n+\n+            try (var session = LauncherFactory.openSession()) {\n+                var launcher = session.getLauncher();\n+                launcher.registerTestExecutionListeners(summaryGeneratingListener);\n+                launcher.execute(request);\n+            }\n+\n+            var summary = summaryGeneratingListener.getSummary();\n+            if (summary.getTotalFailureCount() > 0) {\n+                var sw = new StringWriter();\n+                try (var pw = new PrintWriter(sw)) {\n+                    pw.println(\"JavaTest Message: JUnit Platform Failure(s): \" + summary.getTotalFailureCount());\n+                    pw.println();\n+                    for (var failure : summary.getFailures()) {\n+                        failure.getException().printStackTrace(pw);\n+                    }\n+                    summary.printTo(pw);\n+                }\n+                System.err.println(sw);\n+                throw new Exception(\"JUnit test failure\");\n+            }\n+\n+        } catch (NoClassDefFoundError ex) {\n+            throw new Exception(JUNIT_NO_DRIVER, ex);\n+        }\n+    }\n","filename":"src\/share\/classes\/com\/sun\/javatest\/regtest\/agent\/JUnitRunner.java","additions":47,"deletions":2,"binary":false,"changes":49,"status":"modified"},{"patch":"@@ -38,2 +38,2 @@\n-\t    true \"non-zero exit code from JavaTest intentionally ignored\"\n-\t$(GREP) -s 'Test results: passed: 1; failed: 1' $(@:%.ok=%\/jt.log)  > \/dev\/null\n+\t\ttrue \"non-zero exit code from JavaTest intentionally ignored\"\n+\t$(GREP) -s 'Test results: passed: 2; failed: 1' $(@:%.ok=%\/jt.log)  > \/dev\/null\n@@ -48,0 +48,1 @@\n+INITIAL_TESTS += $(BUILDTESTDIR)\/JUnitTrace.ok\n","filename":"test\/junitTrace\/JUnitTrace.gmk","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -24,0 +24,2 @@\n+import org.junit.jupiter.api.Test;\n+\n@@ -26,1 +28,1 @@\n- * @run junit Pass\n+ * @run junit JupiterTests\n@@ -28,4 +30,1 @@\n-\n-import org.junit.*;\n-\n-public class Pass {\n+class JupiterTests {\n@@ -33,1 +32,1 @@\n-    public void test() {\n+    void test() {\n@@ -37,1 +36,0 @@\n-\n","filename":"test\/junitTrace\/JupiterTests.java","additions":5,"deletions":7,"binary":false,"changes":12,"previous_filename":"test\/junitTrace\/Pass.java","status":"copied"},{"patch":"@@ -37,1 +37,0 @@\n-\n","filename":"test\/junitTrace\/Pass.java","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"}]}