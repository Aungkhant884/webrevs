{"files":[{"patch":"@@ -110,0 +110,3 @@\n+            String headless = System.getProperty(\"java.awt.headless\");\n+            if (headless != null)\n+                cmd.add(\"-Djava.awt.headless=\" + headless);\n","filename":"src\/share\/classes\/com\/sun\/javatest\/regtest\/exec\/Agent.java","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -66,0 +66,8 @@\n+$(BUILDTESTDIR)\/Basic.classes.ok: \\\n+\t\t$(ALL_JTREG_JARS) \\\n+\t\t$(TESTDIR)\/basic\/Basic.java\n+\t$(MKDIR) -p $(BUILDTESTDIR)\/basic\/classes\n+\tCLASSPATH=\"$(CLASSDIR)$(PS)$(JAVADIR)$(PS)$(JAVATEST_JAR)\" \\\n+\t\t$(JDKJAVAC) -Xlint -Werror -encoding ASCII -d $(BUILDTESTDIR)\/basic\/classes $(TESTDIR)\/basic\/Basic.java\n+\techo Basic.java compiled at `date` > $@\n+\n@@ -68,2 +76,1 @@\n-                $(ALL_JTREG_JARS) \\\n-\t\t$(TESTDIR)\/basic\/Basic.java \\\n+\t\t$(BUILDTESTDIR)\/Basic.classes.ok \\\n@@ -75,3 +82,1 @@\n-\t$(MKDIR) -p $(@:%.ok=%\/work\/scratch) $(@:%.ok=%\/report) $(BUILDTESTDIR)\/basic\/classes\n-\tCLASSPATH=\"$(CLASSDIR)$(PS)$(JAVADIR)$(PS)$(JAVATEST_JAR)\" \\\n-\t\t$(JDKJAVAC) -Xlint -Werror -encoding ASCII -d $(BUILDTESTDIR)\/basic\/classes $(TESTDIR)\/basic\/Basic.java\n+\t$(MKDIR) -p $(@:%.ok=%\/work\/scratch) $(@:%.ok=%\/report)\n@@ -98,1 +103,0 @@\n-ifndef HEADLESS\n@@ -102,1 +106,0 @@\n-endif\n","filename":"test\/basic\/Basic.gmk","additions":10,"deletions":7,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -26,1 +26,0 @@\n-import java.io.IOException;\n@@ -28,0 +27,1 @@\n+import java.util.ArrayList;\n@@ -30,0 +30,1 @@\n+import java.util.List;\n@@ -42,1 +43,0 @@\n-import com.sun.javatest.regtest.config.RegressionTestFinder;\n@@ -45,1 +45,0 @@\n-import com.sun.javatest.regtest.exec.RegressionScript;\n@@ -59,0 +58,3 @@\n+    public static final String headlessProperty = System.getProperty(\"java.awt.headless\");\n+    public static final boolean isHeadless = java.awt.GraphicsEnvironment.isHeadless();\n+\n@@ -79,0 +81,2 @@\n+        System.out.println(\"headless:  \" + isHeadless);\n+        System.out.println(\"java.awt.headless: \" + headlessProperty);\n@@ -94,1 +98,2 @@\n-            String[] regtest_args = {\n+            List<String> regtest_args = new ArrayList<>();\n+            regtest_args.addAll(List.of(\n@@ -102,1 +107,12 @@\n-                modeOpt,\n+                modeOpt));\n+\n+            if (headlessProperty != null) {\n+                \/\/ propagate system property if set\n+                regtest_args.add(\"-Djava.awt.headless=\" + headlessProperty);\n+            }\n+\n+            if (isHeadless) {\n+                \/\/ deselect tests that need a display\n+                regtest_args.add(\"-k:!needDisplay\");\n+            }\n+            regtest_args.add(\n@@ -104,1 +120,1 @@\n-            };\n+            );\n@@ -109,1 +125,1 @@\n-            m.run(regtest_args);\n+            m.run(regtest_args.toArray(new String[0]));\n@@ -160,2 +176,2 @@\n-        numPassed += 2; numFailed += 4; numError  += 11;\n-        numApplet += 17;\n+        numPassed += (isHeadless ? 0 : 2); numFailed += (isHeadless ? 0 : 4); numError  += 11;\n+        numApplet += 11 + (isHeadless ? 0 : 6);\n@@ -359,1 +375,5 @@\n-            rp.setKeywordsExpr(\"!manual\");\n+            if (isHeadless) {\n+                rp.setKeywordsExpr(\"!manual & !needDisplay\");\n+            } else {\n+                rp.setKeywordsExpr(\"!manual\");\n+            }\n","filename":"test\/basic\/Basic.java","additions":30,"deletions":10,"binary":false,"changes":40,"status":"modified"},{"patch":"@@ -28,0 +28,8 @@\n+ifdef HEADLESS\n+REPORT_EXPECT_PASS = 91\n+REPORT_EXPECT_FAIL = 40\n+else\n+REPORT_EXPECT_PASS = 93\n+REPORT_EXPECT_FAIL = 44\n+endif\n+\n@@ -41,1 +49,1 @@\n-\t$(GREP) -s 'Test results: passed: 93; failed: 44; error: 88' $(@:%.ok=%.jt.log)  > \/dev\/null\n+\t$(GREP) -s 'Test results: passed: $(REPORT_EXPECT_PASS); failed: $(REPORT_EXPECT_FAIL); error: 88' $(@:%.ok=%.jt.log)  > \/dev\/null\n@@ -44,1 +52,0 @@\n-ifndef HEADLESS\n@@ -46,1 +53,0 @@\n-endif\n","filename":"test\/basic\/ReportOnlyTest.gmk","additions":9,"deletions":3,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -28,0 +28,4 @@\n+ifdef HEADLESS\n+ENV_JTREG_OPT = -k:!needDisplay\n+endif\n+\n@@ -40,2 +44,2 @@\n-\t  echo \"test.jdk=$(JDK6HOME)\"; \\\n-\t  echo \"compile.jdk=$(JDK6HOME)\" ) > $(@:%.ok=%\/ref.properties)\n+\t  echo \"test.jdk=$(JDK8HOME)\"; \\\n+\t  echo \"compile.jdk=$(JDK8HOME)\" ) > $(@:%.ok=%\/ref.properties)\n@@ -44,1 +48,1 @@\n-\t\t-jdk:$(JDK6HOME) \\\n+\t\t-jdk:$(JDK8HOME) \\\n@@ -47,0 +51,1 @@\n+\t\t$(ENV_JTREG_OPT) \\\n@@ -64,2 +69,2 @@\n-\t  echo \"test.jdk=$(JDK7HOME)\"; \\\n-\t  echo \"compile.jdk=$(JDK6HOME)\" ) > $(@:%.ok=%\/ref.properties)\n+\t  echo \"test.jdk=$(JDK9HOME)\"; \\\n+\t  echo \"compile.jdk=$(JDK8HOME)\" ) > $(@:%.ok=%\/ref.properties)\n@@ -68,2 +73,2 @@\n-\t\t-compilejdk:$(JDK6HOME) \\\n-\t\t-testjdk:$(JDK7HOME) \\\n+\t\t-compilejdk:$(JDK8HOME) \\\n+\t\t-testjdk:$(JDK9HOME) \\\n@@ -75,0 +80,1 @@\n+\t\t$(ENV_JTREG_OPT) \\\n@@ -82,3 +88,2 @@\n-ifdef JDK6HOME\n-ifdef JDK7HOME\n-ifndef HEADLESS\n+ifdef JDK8HOME\n+ifdef JDK9HOME\n@@ -91,1 +96,0 @@\n-endif\n","filename":"test\/env\/EnvTest.gmk","additions":15,"deletions":11,"binary":false,"changes":26,"status":"modified"},{"patch":"@@ -2,0 +2,1 @@\n+keys = needDisplay\n","filename":"test\/env\/TEST.ROOT","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -27,0 +27,1 @@\n+  @key needDisplay\n","filename":"test\/env\/applet\/AppletTest1.html","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -27,0 +27,1 @@\n+  @key needDisplay\n","filename":"test\/env\/applet\/AppletTest2.html","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -27,0 +27,1 @@\n+  @key needDisplay\n","filename":"test\/env\/applet\/AppletTest3.html","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -27,0 +27,1 @@\n+  @key needDisplay\n","filename":"test\/env\/applet\/AppletTest4.html","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -32,0 +32,7 @@\n+ifdef HEADLESS\n+RERUN_JTREG_OPT = -k:!needDisplay\n+RERUN_EXPECT_PASS = 9\n+else\n+RERUN_EXPECT_PASS = 10\n+endif\n+\n@@ -46,1 +53,2 @@\n-                -ignore:run \\\n+\t\t-ignore:run \\\n+\t\t$(RERUN_JTREG_OPT) \\\n@@ -50,1 +58,1 @@\n-\t$(GREP) -s 'Test results: passed: 10' $(@:%.ok=%\/jt.log)  > \/dev\/null\n+\t$(GREP) -s 'Test results: passed: $(RERUN_EXPECT_PASS)' $(@:%.ok=%\/jt.log)  > \/dev\/null\n@@ -52,0 +60,1 @@\n+\t    if [ -n \"$(HEADLESS)\" -a $$i = std\/AppletTest.java ]; then continue; fi ; \\\n@@ -80,1 +89,0 @@\n-ifndef HEADLESS\n@@ -86,1 +94,0 @@\n-endif\n","filename":"test\/rerun\/RerunTest.gmk","additions":11,"deletions":4,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -3,0 +3,1 @@\n+keys = needDisplay\n","filename":"test\/rerun\/TEST.ROOT","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -25,0 +25,1 @@\n+ * @key needDisplay\n","filename":"test\/rerun\/std\/AppletTest.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -7,1 +7,1 @@\n-keys=2d dnd i18n\n+keys=2d dnd i18n needDisplay\n","filename":"test\/share\/basic\/TEST.ROOT","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -26,0 +26,1 @@\n+ * @key needDisplay\n","filename":"test\/share\/basic\/applet\/ExitNonZero.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -26,0 +26,1 @@\n+ * @key needDisplay\n","filename":"test\/share\/basic\/applet\/ExitZero.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -26,0 +26,1 @@\n+ * @key needDisplay\n@@ -31,0 +32,1 @@\n+ * @key needDisplay\n@@ -36,0 +38,1 @@\n+ * @key needDisplay\n@@ -41,0 +44,1 @@\n+ * @key needDisplay\n@@ -46,0 +50,1 @@\n+ * @key needDisplay\n@@ -51,0 +56,1 @@\n+ * @key needDisplay\n@@ -56,0 +62,1 @@\n+ * @key needDisplay\n@@ -61,0 +68,1 @@\n+ * @key needDisplay\n","filename":"test\/share\/basic\/applet\/Fail.java","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -26,0 +26,1 @@\n+ * @key needDisplay\n@@ -31,0 +32,1 @@\n+ * @key needDisplay\n@@ -36,0 +38,1 @@\n+ * @key needDisplay\n@@ -41,0 +44,1 @@\n+ * @key needDisplay\n@@ -46,0 +50,1 @@\n+ * @key needDisplay\n@@ -51,0 +56,1 @@\n+ * @key needDisplay\n@@ -56,0 +62,1 @@\n+ * @key needDisplay\n@@ -61,0 +68,1 @@\n+ * @key needDisplay\n","filename":"test\/share\/basic\/applet\/Pass.java","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"}]}