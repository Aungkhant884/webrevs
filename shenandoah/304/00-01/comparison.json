{"files":[{"patch":"@@ -392,0 +392,3 @@\n+  size_t mixed_evac_live = old_candidates * region_size_bytes - (candidates_garbage + unfragmented);\n+  set_unprocessed_old_collection_candidates_live_memory(mixed_evac_live);\n+\n@@ -398,5 +401,2 @@\n-  size_t mixed_evac_live = old_candidates * region_size_bytes - (candidates_garbage + unfragmented);\n-  set_unprocessed_old_collection_candidates_live_memory(mixed_evac_live);\n-  if (unprocessed_old_collection_candidates() == 0) {\n-    _old_generation->transition_to(ShenandoahOldGeneration::IDLE);\n-  } else {\n+\n+  if (unprocessed_old_collection_candidates() > 0) {\n@@ -404,0 +404,4 @@\n+  } else if (has_coalesce_and_fill_candidates()) {\n+    _old_generation->transition_to(ShenandoahOldGeneration::WAITING_FOR_FILL);\n+  } else {\n+    _old_generation->transition_to(ShenandoahOldGeneration::IDLE);\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/heuristics\/shenandoahOldHeuristics.cpp","additions":9,"deletions":5,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -148,0 +148,2 @@\n+  bool has_coalesce_and_fill_candidates() const { return _last_old_region > 0; }\n+  size_t coalesce_and_fill_candidates() const { return _last_old_region; }\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/heuristics\/shenandoahOldHeuristics.hpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -796,1 +796,1 @@\n-          \/\/ under the same condition (established in preprare_concurrent_roots) after strong\n+          \/\/ under the same condition (established in prepare_concurrent_roots) after strong\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahConcurrentGC.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -99,7 +99,0 @@\n-    if (_generation->is_global()) {\n-      \/\/ We can only get to a degenerated global cycle _after_ a concurrent global cycle\n-      \/\/ has been cancelled. In which case, we expect the concurrent global cycle to have\n-      \/\/ cancelled the old gc already.\n-      assert(!heap->is_old_gc_active(), \"Old GC should not be active during global cycle\");\n-    }\n-\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahDegeneratedGC.cpp","additions":0,"deletions":7,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -672,0 +672,17 @@\n+\n+      if (is_global()) {\n+        \/\/ We have just chosen a collection set for a global cycle. The mark bitmap covering old regions is complete, so\n+        \/\/ the remembered set scan can use that to avoid walking into garbage. When the next old mark begins, we will\n+        \/\/ use the mark bitmap to make the old regions parseable by coalescing and filling any unmarked objects. Thus,\n+        \/\/ we prepare for old collections by remembering which regions are old at this time. Note that any objects\n+        \/\/ promoted into old regions will be above TAMS, and so will be considered marked. However, free regions that\n+        \/\/ become old after this point will not be covered correctly by the mark bitmap, so we must be careful not to\n+        \/\/ coalesce those regions. Only the old regions which are not part of the collection set at this point are\n+        \/\/ eligible for coalescing. As implemented now, this has the side effect of possibly initiating mixed-evacuations\n+        \/\/ after a global cycle for old regions that were not included in this collection set.\n+        assert(heap->old_generation()->is_mark_complete(), \"Expected old generation mark to be complete after global cycle.\");\n+        heap->old_heuristics()->prepare_for_old_collections();\n+        log_info(gc)(\"After choosing global collection set, mixed candidates: \" UINT32_FORMAT \", coalescing candidates: \" SIZE_FORMAT,\n+                heap->old_heuristics()->unprocessed_old_collection_candidates(),\n+                heap->old_heuristics()->coalesce_and_fill_candidates());\n+      }\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahGeneration.cpp","additions":17,"deletions":0,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -383,1 +383,3 @@\n-\/\/ global and full collections, both of which cancel any old generation activity.\n+\/\/ cancellation of old collections by global or full collections. However, it does\n+\/\/ depict a transition from IDLE to WAITING_FOR_FILL, which is allowed after a global\n+\/\/ cycle ends.\n@@ -385,38 +387,38 @@\n-\/\/                              +-----------------+\n-\/\/               +------------> |      IDLE       |\n-\/\/               |   +--------> |                 |\n-\/\/               |   |          +-----------------+\n-\/\/               |   |            |\n-\/\/               |   |            | Begin Old Mark\n-\/\/               |   |            v\n-\/\/               |   |          +-----------------+     +--------------------+\n-\/\/               |   |          |     FILLING     | <-> |      YOUNG GC      |\n-\/\/               |   |    +---> |                 |     | (RSet Uses Bitmap) |\n-\/\/               |   |    |     +-----------------+     +--------------------+\n-\/\/               |   |    |       |\n-\/\/               |   |    |       | Reset Bitmap\n-\/\/               |   |    |       v\n-\/\/               |   |    |     +-----------------+\n-\/\/               |   |    |     |    BOOTSTRAP    |\n-\/\/               |   |    |     |                 |\n-\/\/               |   |    |     +-----------------+\n-\/\/               |   |    |       |\n-\/\/               |   |    |       | Continue Marking\n-\/\/               |   |    |       v\n-\/\/               |   |    |     +-----------------+     +----------------------+\n-\/\/               |   |    |     |    MARKING      | <-> |       YOUNG GC       |\n-\/\/               |   +----|-----|                 |     | (RSet Parses Region) |\n-\/\/               |        |     +-----------------+     +----------------------+\n-\/\/               |        |       |\n-\/\/               |        |       | Has Candidates\n-\/\/               |        |       v\n-\/\/               |        |     +-----------------+\n-\/\/               |        |     |    WAITING FOR  |\n-\/\/               +--------|---- |    EVACUATIONS  |\n-\/\/                        |     +-----------------+\n-\/\/                        |       |\n-\/\/                        |       | All Candidates are Pinned\n-\/\/                        |       v\n-\/\/                        |     +-----------------+\n-\/\/                        |     |    WAITING FOR  |\n-\/\/                        +-----|    FILLING      |\n+\/\/           +----------------- +-----------------+\n+\/\/           |   +------------> |      IDLE       |\n+\/\/           |   |   +--------> |                 |\n+\/\/           |   |   |          +-----------------+\n+\/\/           |   |   |            |\n+\/\/           |   |   |            | Begin Old Mark\n+\/\/           |   |   |            v\n+\/\/           |   |   |          +-----------------+     +--------------------+\n+\/\/           |   |   |          |     FILLING     | <-> |      YOUNG GC      |\n+\/\/           |   |   |    +---> |                 |     | (RSet Uses Bitmap) |\n+\/\/           |   |   |    |     +-----------------+     +--------------------+\n+\/\/           |   |   |    |       |\n+\/\/           |   |   |    |       | Reset Bitmap\n+\/\/           |   |   |    |       v\n+\/\/           |   |   |    |     +-----------------+\n+\/\/           |   |   |    |     |    BOOTSTRAP    |\n+\/\/           |   |   |    |     |                 |\n+\/\/           |   |   |    |     +-----------------+\n+\/\/           |   |   |    |       |\n+\/\/           |   |   |    |       | Continue Marking\n+\/\/           |   |   |    |       v\n+\/\/           |   |   |    |     +-----------------+     +----------------------+\n+\/\/           |   |   |    |     |    MARKING      | <-> |       YOUNG GC       |\n+\/\/           |   |   +----|-----|                 |     | (RSet Parses Region) |\n+\/\/           |   |        |     +-----------------+     +----------------------+\n+\/\/           |   |        |       |\n+\/\/           |   |        |       | Has Candidates\n+\/\/           |   |        |       v\n+\/\/           |   |        |     +-----------------+\n+\/\/           |   |        |     |    WAITING FOR  |\n+\/\/           |   +--------|---> |    EVACUATIONS  |\n+\/\/           |            |     +-----------------+\n+\/\/           |            |       |\n+\/\/           |            |       | All Candidates are Pinned\n+\/\/           |            |       v\n+\/\/           |            |     +-----------------+\n+\/\/           |            +---- |    WAITING FOR  |\n+\/\/           +----------------> |    FILLING      |\n@@ -431,2 +433,1 @@\n-      assert(!heap->mode()->is_generational() ||\n-             (_old_heuristics->unprocessed_old_collection_candidates() == 0), \"Cannot become idle with collection candidates\");\n+      assert(_old_heuristics->unprocessed_old_collection_candidates() == 0, \"Cannot become idle with collection candidates\");\n@@ -451,1 +452,1 @@\n-      assert(_state == MARKING, \"Cannot have old collection candidates without first marking, state is '%s'\", state_name(_state));\n+      assert(_state == IDLE || _state == MARKING, \"Cannot have old collection candidates without first marking, state is '%s'\", state_name(_state));\n@@ -455,2 +456,2 @@\n-      assert(_state == MARKING || _state == WAITING_FOR_EVAC, \"Cannot begin filling without first marking or evacuating, state is '%s'\", state_name(_state));\n-      assert(_old_heuristics->unprocessed_old_collection_candidates() > 0, \"Cannot wait for fill without something to fill.\");\n+      assert(_state == IDLE || _state == MARKING || _state == WAITING_FOR_EVAC, \"Cannot begin filling without first marking or evacuating, state is '%s'\", state_name(_state));\n+      assert(_old_heuristics->has_coalesce_and_fill_candidates(), \"Cannot wait for fill without something to fill.\");\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahOldGeneration.cpp","additions":45,"deletions":44,"binary":false,"changes":89,"status":"modified"}]}