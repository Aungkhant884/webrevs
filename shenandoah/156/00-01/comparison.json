{"files":[{"patch":"@@ -126,1 +126,2 @@\n-        } else if (r->age() >= InitialTenuringThreshold) {\n+        } else if (cset->is_preselected(r->index())) {\n+          assert(r->age() >= InitialTenuringThreshold, \"Preselected regions must have tenure age\");\n@@ -131,1 +132,6 @@\n-        } else {\n+          \/\/ Since all live data in this region is being evacuated from young-gen, it is as if this memory\n+          \/\/ is garbage insofar as young-gen is concerned.  Counting this as garbage reduces the need to\n+          \/\/ reclaim highly utilized young-gen regions just for the sake of finding min_garbage to reclaim\n+          \/\/ within youn-gen memory\n+          cur_young_garbage += r->get_live_data_bytes();\n+        } else if (r->age() < InitialTenuringThreshold) {\n@@ -142,0 +148,2 @@\n+        \/\/ Note that we do not add aged regions if they were not pre-selected.  The reason they were not preselected\n+        \/\/ is because there is not sufficient room in old-gen to hold their to-be-promoted live objects.\n@@ -148,1 +156,2 @@\n-      \/\/ This is young-gen collection.\n+      \/\/ This is young-gen collection or a mixed evacuation.  If this is mixed evacuation, the old-gen candidate regions\n+      \/\/ have already been added.\n@@ -163,13 +172,31 @@\n-        if (r->age() >= InitialTenuringThreshold) {\n-          \/\/ Entire region will be promoted, This region does not impact young-gen evacuation reserve.  Memory has already\n-          \/\/ been set aside to hold evacuation results as advance_promotion_reserve.\n-          new_cset = cur_cset;\n-        } else {\n-          new_cset = cur_cset + r->get_live_data_bytes();\n-        }\n-        bool add_regardless = (region_garbage > ignore_threshold) && (new_garbage < min_garbage);\n-        if ((new_cset <= max_cset) &&\n-            (add_regardless || (region_garbage > garbage_threshold) || (r->age() >= InitialTenuringThreshold))) {\n-          cset->add_region(r);\n-          cur_cset = new_cset;\n-          cur_young_garbage = new_garbage;\n+        bool add_region = false;\n+\n+        if (!r->is_old()) {\n+          if (cset->is_preselected(r->index())) {\n+            assert(r->age() >= InitialTenuringThreshold, \"Preselected regions must have tenure age\");\n+            \/\/ Entire region will be promoted, This region does not impact young-gen evacuation reserve.  Memory has already\n+            \/\/ been set aside to hold evacuation results as advance_promotion_reserve.\n+            add_region = true;\n+            new_cset = cur_cset;\n+            \/\/ Since all live data in this region is being evacuated from young-gen, it is as if this memory\n+            \/\/ is garbage insofar as young-gen is concerned.  Counting this as garbage reduces the need to\n+            \/\/ reclaim highly utilized young-gen regions just for the sake of finding min_garbage to reclaim\n+            \/\/ within youn-gen memory\n+            cur_young_garbage += r->get_live_data_bytes();\n+          } else if  (r->age() < InitialTenuringThreshold) {\n+            new_cset = cur_cset + r->get_live_data_bytes();\n+            size_t region_garbage = r->garbage();\n+            size_t new_garbage = cur_young_garbage + region_garbage;\n+            bool add_regardless = (region_garbage > ignore_threshold) && (new_garbage < min_garbage);\n+            if ((new_cset <= max_cset) && (add_regardless || (region_garbage > garbage_threshold))) {\n+              add_region = true;\n+              cur_cset = new_cset;\n+              cur_young_garbage = new_garbage;\n+            }\n+          }\n+          \/\/ Note that we do not add aged regions if they were not pre-selected.  The reason they were not preselected\n+          \/\/ is because there is not sufficient room in old-gen to hold their to-be-promoted live objects.\n+\n+          if (add_region) {\n+            cset->add_region(r);\n+          }\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/heuristics\/shenandoahAdaptiveHeuristics.cpp","additions":43,"deletions":16,"binary":false,"changes":59,"status":"modified"}]}