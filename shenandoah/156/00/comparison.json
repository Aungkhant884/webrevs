{"files":[{"patch":"@@ -130,1 +130,0 @@\n-  _old_region_count = 0;\n@@ -133,0 +132,2 @@\n+\n+  _old_region_count = 0;\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahCollectionSet.cpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -441,0 +441,1 @@\n+\n@@ -449,0 +450,5 @@\n+\n+      \/\/ If we shrink old_evacuation_reserve by more than a region size, we can expand regions_available_to_loan.\n+      \/\/ Can only give back regions that are fully unused, so round down.\n+      size_t old_evac_regions_unused = (old_evacuation_reserve - old_evacuated_committed) \/ region_size_bytes;\n+      regions_available_to_loan += old_evac_regions_unused;\n@@ -473,0 +479,1 @@\n+\n@@ -475,1 +482,1 @@\n-      regions_available_to_loan -= old_regions_loaned_for_young_evac;\n+      regions_available_to_loan -= revised_loan_for_young_evacuation;\n@@ -507,2 +514,3 @@\n-    \/\/  1. old_gen->available - (old_evacuation_committed + old_bytes_loaned_for_young_evac + consumed_by_advance_promotion)\n-    \/\/  2. young bytes reserved for evacuation\n+    \/\/  1. old_gen->available - (old_evacuation_committed + old_bytes_loaned_for_young_evac + consumed_by_advance_promotion\n+    \/\/                           + old_bytes_[already]_ reserved_for_alloc_supplement)\n+    \/\/  2. young bytes reserved for evacuation (we can't promote more than young is evacuating)\n@@ -519,2 +527,4 @@\n-    size_t promotion_reserve = old_available - (old_evacuated_committed + consumed_by_advance_promotion +\n-                                                old_bytes_loaned_for_young_evac + old_bytes_reserved_for_alloc_supplement);\n+    size_t promotion_reserve = regions_available_to_loan * region_size_bytes;\n+    assert(promotion_reserve <= old_available - (old_evacuated_committed + consumed_by_advance_promotion +\n+                                                 old_bytes_loaned_for_young_evac + old_bytes_reserved_for_alloc_supplement),\n+           \"Byte reserves do not match region reserves\");\n@@ -555,0 +565,4 @@\n+\n+    size_t promotion_regions = (promotion_reserve + region_size_bytes - 1) \/ region_size_bytes;\n+    assert(regions_available_to_loan >= promotion_regions, \"Promoting more regions than memory is available\");\n+    regions_available_to_loan -= promotion_regions;\n@@ -618,1 +632,1 @@\n-    assert(old_available > old_evacuation_reserve + promotion_reserve + old_bytes_loaned_for_young_evac + allocation_supplement,\n+    assert(old_available >= old_evacuation_reserve + promotion_reserve + old_bytes_loaned_for_young_evac + allocation_supplement,\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahGeneration.cpp","additions":20,"deletions":6,"binary":false,"changes":26,"status":"modified"}]}