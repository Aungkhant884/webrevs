{"files":[{"patch":"@@ -624,4 +624,1 @@\n-     * near-miss scenarios for inactivate\/activate races. Because idle\n-     * workers are often not yet blocked (parked), we use the\n-     * WorkQueue parker field to advertise that a waiter actually\n-     * needs unparking upon signal.\n+     * near-miss scenarios for inactivate\/activate races.\n@@ -1047,1 +1044,1 @@\n-    static final int TRIMMED          = 1 << 31;  \/\/ timed out while idle\n+    static final int DEREGISTERED     = 1 << 31;  \/\/ worker terminating\n@@ -1217,2 +1214,1 @@\n-        volatile ForkJoinWorkerThread owner; \/\/ null if shared or terminated\n-        volatile Thread parker;    \/\/ set when parking in awaitWork\n+        final ForkJoinWorkerThread owner; \/\/ null if shared or terminated\n@@ -1231,1 +1227,1 @@\n-        volatile int source;       \/\/ source queue id (or TRIMMED if trimmed)\n+        volatile int source;       \/\/ source queue id (or DEREGISTERED)\n@@ -1834,3 +1830,1 @@\n-                if (stop != 0 || (qs = queues) == null || (n = qs.length) <= 0)\n-                    w.owner = null;             \/\/ terminating\n-                else {\n+                if (stop == 0 && (qs = queues) != null && (n = qs.length) > 0) {\n@@ -1884,7 +1878,6 @@\n-            src = w.source;\n-            w.owner = null;               \/\/ disable signals\n-            if (phase != 0) {             \/\/ else failed to start\n-                replaceable = true;\n-                if ((phase & IDLE) != 0)\n-                    reactivate(w);        \/\/ pool stopped before released\n-                if (w.top - w.base > 0) {\n+            if ((src = w.source) != DEREGISTERED) { \/\/ else trimmed on timeout\n+                w.source = DEREGISTERED;\n+                if (phase != 0) {             \/\/ else failed to start\n+                    replaceable = true;\n+                    if ((phase & IDLE) != 0)\n+                        reactivate(w);        \/\/ pool stopped before released\n@@ -1892,4 +1885,4 @@\n-                         try {\n-                             t.cancel(false);\n-                         } catch (Throwable ignore) {\n-                         }\n+                        try {\n+                            t.cancel(false);\n+                        } catch (Throwable ignore) {\n+                        }\n@@ -1901,1 +1894,1 @@\n-        if (src != TRIMMED)               \/\/ decrement counts\n+        if (src != DEREGISTERED)          \/\/ decrement counts\n@@ -1953,1 +1946,0 @@\n-                    Thread t;\n@@ -1955,2 +1947,1 @@\n-                    if ((t = v.parker) != null)\n-                        U.unpark(t);\n+                    U.unpark(v.owner);\n@@ -1978,2 +1969,1 @@\n-                if ((t = v.parker) != null)\n-                    U.unpark(t);\n+                U.unpark(v.owner);\n@@ -2007,4 +1997,3 @@\n-                     (!transition ||\n-                      casRunState(e, ((e & SHUTDOWN) == 0 ?\n-                                      e + RS_EPOCH :  \/\/ advance\n-                                      e | STOP))))    \/\/ terminate\n+                     casRunState(e, !transition ? e : \/\/ confirm\n+                                 (e & SHUTDOWN) == 0 ? e + RS_EPOCH : \/\/ advance\n+                                 e | STOP))           \/\/ terminate\n@@ -2161,1 +2150,0 @@\n-                w.parker = Thread.currentThread();\n@@ -2175,1 +2163,1 @@\n-                            w.source = TRIMMED; \/\/ sentinel for deregisterWorker\n+                            w.source = DEREGISTERED; \/\/ deregisterWorker sentinel\n@@ -2182,1 +2170,0 @@\n-                w.parker = null;\n@@ -2241,2 +2228,1 @@\n-                if ((t = v.parker) != null)\n-                    U.unpark(t);\n+                U.unpark(v.owner);\n@@ -2788,1 +2774,1 @@\n-        if ((e & STOP) != 0) { \/\/ help terminate; similar to isQuiescent\n+        if ((e & (STOP | TERMINATED)) == STOP) { \/\/ similar to isQuiescent\n@@ -2797,1 +2783,2 @@\n-                        if ((o = q.owner) != null && !o.isInterrupted()) {\n+                        if ((o = q.owner) != null && q.source != DEREGISTERED &&\n+                            !o.isInterrupted()) {\n@@ -2823,0 +2810,1 @@\n+                        break;\n@@ -3833,0 +3821,1 @@\n+                        break;\n","filename":"src\/java.base\/share\/classes\/java\/util\/concurrent\/ForkJoinPool.java","additions":28,"deletions":39,"binary":false,"changes":67,"status":"modified"}]}