{"files":[{"patch":"@@ -2163,1 +2163,1 @@\n-                    if ((p = w.phase) != idlePhase)\n+                    if ((runState & STOP) != 0 || (p = w.phase) != idlePhase)\n@@ -2166,1 +2166,1 @@\n-                    if ((p = w.phase) != idlePhase)\n+                    if ((p = w.phase) != idlePhase || (runState & STOP) != 0)\n@@ -2169,2 +2169,0 @@\n-                    if ((runState & STOP) != 0)\n-                        break;\n@@ -2787,1 +2785,1 @@\n-                    e = STOP | SHUTDOWN;\n+                    e = runState;\n@@ -2790,3 +2788,4 @@\n-        if ((e & (STOP | TERMINATED)) == STOP) { \/\/ similar to isQuiescent\n-            for (int r = ThreadLocalRandom.nextSecondarySeed();;) { \/\/ stagger\n-                int prevRunState = e;\n+        if ((e & STOP) != 0) { \/\/ help terminate; similar to isQuiescent\n+            int r = (int)Thread.currentThread().threadId(); \/\/ stagger traversals\n+            long c = ctl;\n+            for (int prevRunState = 0; ; prevRunState = e) {\n@@ -2812,4 +2811,5 @@\n-                if (((e = runState) & TERMINATED) != 0)\n-                    break;\n-                if (e == prevRunState && (e & RS_LOCK) == 0) {\n-                    if (ctl != 0L)        \/\/ another thread will finish\n+                if (c == (c = ctl) && (e = runState) == prevRunState &&\n+                     (e & RS_LOCK) == 0) {\n+                    if ((e & TERMINATED) != 0)\n+                        break;\n+                    if (c != 0L)        \/\/ another thread will finish\n@@ -2823,1 +2823,0 @@\n-                        break;\n@@ -3824,1 +3823,1 @@\n-        if (workerNamePrefix != null && (runState & TERMINATED) == 0) {\n+        if (workerNamePrefix != null) {\n@@ -3827,1 +3826,1 @@\n-            boolean interrupted = false; \/\/ Thread.interrupted();\n+            boolean interrupted = false;\n@@ -3834,1 +3833,0 @@\n-                        break;\n","filename":"src\/java.base\/share\/classes\/java\/util\/concurrent\/ForkJoinPool.java","additions":14,"deletions":16,"binary":false,"changes":30,"status":"modified"}]}