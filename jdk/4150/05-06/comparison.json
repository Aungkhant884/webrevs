{"files":[{"patch":"@@ -69,1 +69,1 @@\n-        JceSecurityManager dummy = AccessController.doPrivileged(\n+        JceSecurityManager dummySecurityManager = AccessController.doPrivileged(\n@@ -71,1 +71,1 @@\n-        INSTANCE = dummy;\n+        INSTANCE = dummySecurityManager;\n@@ -73,2 +73,0 @@\n-        PrivilegedAction<StackWalker> pa =\n-                () -> StackWalker.getInstance(Option.RETAIN_CLASS_REFERENCE);\n@@ -76,1 +74,4 @@\n-        StackWalker dummyWalker = AccessController.doPrivileged(pa);\n+        StackWalker dummyWalker = AccessController.doPrivileged(\n+                (PrivilegedAction<StackWalker>) (() -> StackWalker.getInstance(\n+                        Option.RETAIN_CLASS_REFERENCE)));\n+\n@@ -107,3 +108,3 @@\n-        return WALKER.walk(s -> s.map(\n-                f -> {\n-                    Class<?> cls = f.getDeclaringClass();\n+        return WALKER.walk(s -> s.map(StackFrame::getDeclaringClass)\n+                .filter(c -> !c.getPackageName().equals(\"javax.crypto\"))\n+                .map(cls -> {\n@@ -111,13 +112,4 @@\n-                    if (callerCodeBase != null) {\n-                        return getCryptoPermissionFromURL(\n-                                callerCodeBase, alg, defaultPerm);\n-                    } else {\n-                        if (cls.getName().startsWith(\"javax.crypto.\")) {\n-                            \/\/ skip JCE classes since they aren't the callers\n-                            return null;\n-                        }\n-                        return defaultPerm;\n-                    }\n-                })\n-                .filter(Objects::nonNull)  \/\/ Filter javax.crypto frames\n-                .findFirst().get()         \/\/ Optional nulls not possible\n+                    return (callerCodeBase != null) ?\n+                            getCryptoPermissionFromURL(callerCodeBase,\n+                                    alg, defaultPerm) : defaultPerm;})\n+                .findFirst().get()         \/\/ nulls not possible for Optional\n","filename":"src\/java.base\/share\/classes\/javax\/crypto\/JceSecurityManager.java","additions":13,"deletions":21,"binary":false,"changes":34,"status":"modified"}]}