{"files":[{"patch":"@@ -33,0 +33,2 @@\n+import java.lang.StackWalker.*;\n+import java.util.stream.Stream;\n@@ -42,2 +44,0 @@\n- * <p>Note that this security manager is never installed, only instantiated.\n- *\n@@ -48,3 +48,1 @@\n-\n-@SuppressWarnings(\"removal\")\n-final class JceSecurityManager extends SecurityManager {\n+final class JceSecurityManager {\n@@ -69,1 +67,3 @@\n-        INSTANCE = AccessController.doPrivileged(\n+\n+        @SuppressWarnings(\"removal\")\n+        JceSecurityManager dummy = AccessController.doPrivileged(\n@@ -75,0 +75,1 @@\n+        INSTANCE = dummy;\n@@ -86,0 +87,1 @@\n+\n@@ -103,1 +105,6 @@\n-        Class<?>[] context = getClassContext();\n+        PrivilegedAction<StackWalker> pa =\n+                () -> StackWalker.getInstance(Option.RETAIN_CLASS_REFERENCE);\n+        @SuppressWarnings(\"removal\")\n+        List<StackFrame> stack =\n+                AccessController.doPrivileged(pa).walk(Stream::toList);\n+\n@@ -105,3 +112,2 @@\n-        int i;\n-        for (i=0; i<context.length; i++) {\n-            Class<?> cls = context[i];\n+        for (StackFrame stackFrame : stack) {\n+            Class<?> cls = stackFrame.getDeclaringClass();\n@@ -121,1 +127,1 @@\n-        if (i == context.length) {\n+        if (callerCodeBase == null) {\n@@ -235,3 +241,7 @@\n-        \/\/ Get the caller and its codebase.\n-        Class<?>[] context = getClassContext();\n-        if (context.length >= 3) {\n+        PrivilegedAction<StackWalker> pa =\n+                () -> StackWalker.getInstance(Option.RETAIN_CLASS_REFERENCE);\n+        @SuppressWarnings(\"removal\")\n+        Optional<StackFrame> stackFrame = AccessController.doPrivileged(pa)\n+                .walk((s) -> s.skip(2).findFirst());\n+\n+        if (stackFrame.isPresent()) {\n@@ -241,1 +251,1 @@\n-            Class<?> caller = context[2];\n+            Class<?> caller = stackFrame.get().getDeclaringClass();\n","filename":"src\/java.base\/share\/classes\/javax\/crypto\/JceSecurityManager.java","additions":25,"deletions":15,"binary":false,"changes":40,"status":"modified"}]}