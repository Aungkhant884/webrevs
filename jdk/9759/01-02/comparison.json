{"files":[{"patch":"@@ -389,0 +389,3 @@\n+  template <typename T> T get_src_obj(T dumped_addr) const {\n+    return (T)get_src_obj((address)dumped_addr);\n+  }\n","filename":"src\/hotspot\/share\/cds\/archiveBuilder.hpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -77,4 +77,0 @@\n-\n-  \/\/ The saved cp entries array is not modified by the ArchiveBuilder, so there's\n-  \/\/ no need to make a deep copy. It will be freed when the holder class is removed.\n-  _saved_cpcache_entries = src._saved_cpcache_entries;\n@@ -94,12 +90,0 @@\n-void DumpTimeClassInfo::save_cpcache_entries(ConstantPoolCacheEntry* entries) {\n-  free_saved_cpcache_entries(); \/\/ in case of class redefinition\n-  _saved_cpcache_entries = entries;\n-}\n-\n-void DumpTimeClassInfo::free_saved_cpcache_entries() {\n-  if (_saved_cpcache_entries != NULL) {\n-    FREE_C_HEAP_ARRAY(ConstantPoolCacheEntry, _saved_cpcache_entries);\n-    _saved_cpcache_entries = NULL;\n-  }\n-}\n-\n@@ -220,2 +204,1 @@\n-  assert(p->_klass == k || p->_klass == ArchiveBuilder::get_relocated_klass(k),\n-         \"Sanity\");\n+  assert(p->_klass == k, \"Sanity\");\n","filename":"src\/hotspot\/share\/cds\/dumpTimeClassInfo.cpp","additions":1,"deletions":18,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -36,1 +36,0 @@\n-class ConstantPoolCacheEntry;\n@@ -132,1 +131,0 @@\n-  ConstantPoolCacheEntry*              _saved_cpcache_entries;\n@@ -149,1 +147,0 @@\n-    _saved_cpcache_entries = NULL;\n@@ -220,7 +217,0 @@\n-\n-  ConstantPoolCacheEntry* get_saved_cpcache_entries() const {\n-    return _saved_cpcache_entries;\n-  }\n-\n-  void save_cpcache_entries(ConstantPoolCacheEntry* entries);\n-  void free_saved_cpcache_entries();\n","filename":"src\/hotspot\/share\/cds\/dumpTimeClassInfo.hpp","additions":0,"deletions":10,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -83,0 +83,1 @@\n+SystemDictionaryShared::SavedCpCacheEntriesTable* SystemDictionaryShared::_saved_cpcache_entries_table = NULL;\n@@ -507,0 +508,1 @@\n+    _saved_cpcache_entries_table = new (ResourceObj::C_HEAP, mtClass) SavedCpCacheEntriesTable;\n@@ -518,1 +520,0 @@\n-  get_info_locked(k)->free_saved_cpcache_entries();\n@@ -520,0 +521,5 @@\n+\n+  ConstantPoolCache* cpc = k->constants()->cache();\n+  if (cpc != NULL) {\n+    remove_saved_cpcache_entries_locked(cpc);\n+  }\n@@ -1333,2 +1339,4 @@\n-void SystemDictionaryShared::save_cpcache_entries(InstanceKlass* k, ConstantPoolCacheEntry* entries) {\n-  get_info(k)->save_cpcache_entries(entries);\n+void SystemDictionaryShared::set_saved_cpcache_entries(ConstantPoolCache* cpc, ConstantPoolCacheEntry* entries) {\n+  MutexLocker ml(DumpTimeTable_lock, Mutex::_no_safepoint_check_flag);\n+  bool is_new = _saved_cpcache_entries_table->put(cpc, entries);\n+  assert(is_new, \"saved entries must never changed\");\n@@ -1337,1 +1345,1 @@\n-ConstantPoolCacheEntry* SystemDictionaryShared::get_saved_cpcache_entries_locked(InstanceKlass* dumped_k) {\n+ConstantPoolCacheEntry* SystemDictionaryShared::get_saved_cpcache_entries_locked(ConstantPoolCache* cpc) {\n@@ -1339,2 +1347,20 @@\n-  InstanceKlass* orig_k = (InstanceKlass*)ArchiveBuilder::current()->get_src_obj((address)dumped_k);\n-  return get_info_locked(orig_k)->get_saved_cpcache_entries();\n+  ConstantPoolCacheEntry** p = _saved_cpcache_entries_table->get(cpc);\n+  if (p) {\n+    return *p;\n+  } else {\n+    return NULL;\n+  }\n+}\n+\n+void SystemDictionaryShared::remove_saved_cpcache_entries(ConstantPoolCache* cpc) {\n+  MutexLocker ml(DumpTimeTable_lock, Mutex::_no_safepoint_check_flag);\n+  remove_saved_cpcache_entries_locked(cpc);\n+}\n+\n+void SystemDictionaryShared::remove_saved_cpcache_entries_locked(ConstantPoolCache* cpc) {\n+  assert_lock_strong(DumpTimeTable_lock);\n+  ConstantPoolCacheEntry** p = _saved_cpcache_entries_table->get(cpc);\n+  if (p) {\n+    _saved_cpcache_entries_table->remove(cpc);\n+    FREE_C_HEAP_ARRAY(ConstantPoolCacheEntry, *p);\n+  }\n","filename":"src\/hotspot\/share\/classfile\/systemDictionaryShared.cpp","additions":32,"deletions":6,"binary":false,"changes":38,"status":"modified"},{"patch":"@@ -37,0 +37,1 @@\n+#include \"utilities\/resourceHash.hpp\"\n@@ -111,0 +112,1 @@\n+class ConstantPoolCache;\n@@ -169,0 +171,9 @@\n+  \/\/ Doesn't need to be cloned as it's not modified during dump time.\n+  using SavedCpCacheEntriesTable = ResourceHashtable<\n+    ConstantPoolCache*,\n+    ConstantPoolCacheEntry*,\n+    15889, \/\/ prime number\n+    ResourceObj::C_HEAP,\n+    mtClassShared>;\n+  static SavedCpCacheEntriesTable* _saved_cpcache_entries_table;\n+\n@@ -240,2 +251,4 @@\n-  static void save_cpcache_entries(InstanceKlass* k, ConstantPoolCacheEntry* entries);\n-  static ConstantPoolCacheEntry* get_saved_cpcache_entries_locked(InstanceKlass* k);\n+  static void set_saved_cpcache_entries(ConstantPoolCache* cpc, ConstantPoolCacheEntry* entries);\n+  static ConstantPoolCacheEntry* get_saved_cpcache_entries_locked(ConstantPoolCache* k);\n+  static void remove_saved_cpcache_entries(ConstantPoolCache* cpc);\n+  static void remove_saved_cpcache_entries_locked(ConstantPoolCache* cpc);\n","filename":"src\/hotspot\/share\/classfile\/systemDictionaryShared.hpp","additions":15,"deletions":2,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -693,1 +693,1 @@\n-  SystemDictionaryShared::save_cpcache_entries(constant_pool()->pool_holder(), copy);\n+  SystemDictionaryShared::set_saved_cpcache_entries(this, copy);\n@@ -700,2 +700,2 @@\n-  InstanceKlass* ik = constant_pool()->pool_holder();\n-  ConstantPoolCacheEntry* saved = SystemDictionaryShared::get_saved_cpcache_entries_locked(ik);\n+  ConstantPoolCache* orig_cpc = ArchiveBuilder::current()->get_src_obj(this);\n+  ConstantPoolCacheEntry* saved = SystemDictionaryShared::get_saved_cpcache_entries_locked(orig_cpc);\n@@ -716,0 +716,6 @@\n+\n+#if INCLUDE_CDS\n+  if (Arguments::is_dumping_archive()) {\n+    SystemDictionaryShared::remove_saved_cpcache_entries(this);\n+  }\n+#endif\n","filename":"src\/hotspot\/share\/oops\/cpCache.cpp","additions":9,"deletions":3,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -579,0 +579,1 @@\n+  SystemDictionaryShared::handle_class_unloading(this);\n@@ -694,2 +695,0 @@\n-\n-  SystemDictionaryShared::handle_class_unloading(this);\n","filename":"src\/hotspot\/share\/oops\/instanceKlass.cpp","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"}]}