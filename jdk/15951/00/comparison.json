{"files":[{"patch":"@@ -408,2 +408,0 @@\n-    private Main() { }\n-\n@@ -412,1 +410,14 @@\n-        kt.run(args, System.out);\n+        try {\n+            kt.run(args, System.out);\n+        } catch (ExitException ee) {\n+            System.exit(ee.errorCode);\n+        }\n+    }\n+\n+    private static class ExitException extends RuntimeException {\n+        @java.io.Serial\n+        static final long serialVersionUID = 0L;\n+        private final int errorCode;\n+        public ExitException(int errorCode) {\n+            this.errorCode = errorCode;\n+        }\n@@ -415,1 +426,1 @@\n-    private void run(String[] args, PrintStream out) throws Exception {\n+    public void run(String[] args, PrintStream out) throws Exception {\n@@ -417,1 +428,1 @@\n-            args = parseArgs(args);\n+            parseArgs(args);\n@@ -421,0 +432,2 @@\n+        } catch (ExitException ee) {\n+            throw ee;\n@@ -427,1 +440,1 @@\n-                System.exit(1);\n+                throw new ExitException(1);\n@@ -5250,1 +5263,1 @@\n-            System.exit(1);\n+            throw new ExitException(1);\n","filename":"src\/java.base\/share\/classes\/sun\/security\/tools\/keytool\/Main.java","additions":20,"deletions":7,"binary":false,"changes":27,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2000, 2012, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -95,0 +95,1 @@\n+        Kinit kinit = new Kinit();\n@@ -96,1 +97,3 @@\n-            Kinit self = new Kinit(args);\n+            kinit.run(args);\n+        } catch (Exception e) {\n+            System.exit(-1);\n@@ -98,1 +101,33 @@\n-        catch (Exception e) {\n+    }\n+\n+    \/**\n+     * Run the Kinit command.\n+     * @param args array of ticket request options.\n+     * Available options are: -f, -p, -c, principal, password.\n+     * @exception IOException if an I\/O error occurs.\n+     * @exception RealmException if the Realm could not be instantiated.\n+     * @exception KrbException if error occurs during Kerberos operation.\n+     *\/\n+    public void run(String[] args)\n+            throws IOException, RealmException, KrbException {\n+        try {\n+            if (args == null || args.length == 0) {\n+                options = new KinitOptions();\n+            } else {\n+                options = new KinitOptions(args);\n+            }\n+            switch (options.action) {\n+                case 0:\n+                    \/\/ Help, already displayed in new KinitOptions().\n+                    break;\n+                case 1:\n+                    acquire();\n+                    break;\n+                case 2:\n+                    renew();\n+                    break;\n+                default:\n+                    throw new KrbException(\"kinit does not support action \"\n+                            + options.action);\n+            }\n+        } catch (Exception e) {\n@@ -102,1 +137,1 @@\n-                    ((KrbException)e).returnCodeMessage();\n+                        ((KrbException)e).returnCodeMessage();\n@@ -112,30 +147,1 @@\n-            System.exit(-1);\n-        }\n-        return;\n-    }\n-\n-    \/**\n-     * Constructs a new Kinit object.\n-     * @param args array of ticket request options.\n-     * Available options are: -f, -p, -c, principal, password.\n-     * @exception IOException if an I\/O error occurs.\n-     * @exception RealmException if the Realm could not be instantiated.\n-     * @exception KrbException if error occurs during Kerberos operation.\n-     *\/\n-    private Kinit(String[] args)\n-        throws IOException, RealmException, KrbException {\n-        if (args == null || args.length == 0) {\n-            options = new KinitOptions();\n-        } else {\n-            options = new KinitOptions(args);\n-        }\n-        switch (options.action) {\n-            case 1:\n-                acquire();\n-                break;\n-            case 2:\n-                renew();\n-                break;\n-            default:\n-                throw new KrbException(\"kinit does not support action \"\n-                        + options.action);\n+            throw e;\n","filename":"src\/java.security.jgss\/windows\/classes\/sun\/security\/krb5\/internal\/tools\/Kinit.java","additions":40,"deletions":34,"binary":false,"changes":74,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2000, 2018, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -49,1 +49,1 @@\n-    \/\/ 1. acquire, 2. renew, 3. validate\n+    \/\/ 0. Help, 1. acquire, 2. renew, 3. validate, 4. Help\n@@ -146,1 +146,2 @@\n-                System.exit(0);\n+                action = 0;\n+                return;\n","filename":"src\/java.security.jgss\/windows\/classes\/sun\/security\/krb5\/internal\/tools\/KinitOptions.java","additions":4,"deletions":3,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2003, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2003, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -81,0 +81,17 @@\n+        try {\n+            klist.run(args);\n+        } catch (ExitException ee) {\n+            System.exit(ee.errorCode);\n+        }\n+    }\n+\n+    private static class ExitException extends RuntimeException {\n+        @java.io.Serial\n+        static final long serialVersionUID = 0L;\n+        private final int errorCode;\n+        public ExitException(int errorCode) {\n+            this.errorCode = errorCode;\n+        }\n+    }\n+\n+    public void run(String[] args) throws ExitException {\n@@ -82,1 +99,1 @@\n-            klist.action = 'c'; \/\/ default will list default credentials cache.\n+            action = 'c'; \/\/ default will list default credentials cache.\n@@ -84,1 +101,51 @@\n-            klist.processArgs(args);\n+            Character arg;\n+            for (int i = 0; i < args.length; i++) {\n+                if (args[i].equals(\"-?\") ||\n+                        args[i].equals(\"-h\") ||\n+                        args[i].equals(\"--help\")) {\n+                    printHelp();\n+                    return;\n+                }\n+                if ((args[i].length() >= 2) && (args[i].startsWith(\"-\"))) {\n+                    arg = Character.valueOf(args[i].charAt(1));\n+                    switch (arg.charValue()) {\n+                        case 'c':\n+                            action = 'c';\n+                            break;\n+                        case 'k':\n+                            action = 'k';\n+                            break;\n+                        case 'a':\n+                            options[2] = 'a';\n+                            break;\n+                        case 'n':\n+                            options[3] = 'n';\n+                            break;\n+                        case 'f':\n+                            options[1] = 'f';\n+                            break;\n+                        case 'e':\n+                            options[0] = 'e';\n+                            break;\n+                        case 'K':\n+                            options[1] = 'K';\n+                            break;\n+                        case 't':\n+                            options[2] = 't';\n+                            break;\n+                        default:\n+                            printHelp();\n+                            throw new ExitException(-1);\n+                    }\n+\n+                } else {\n+                    if (!args[i].startsWith(\"-\") && (i == args.length - 1)) {\n+                        \/\/ the argument is the last one.\n+                        name = args[i];\n+                        arg = null;\n+                    } else {\n+                        printHelp(); \/\/ incorrect input format.\n+                        throw new ExitException(-1);\n+                    }\n+                }\n+            }\n@@ -86,1 +153,1 @@\n-        switch (klist.action) {\n+        switch (action) {\n@@ -88,3 +155,3 @@\n-            if (klist.name == null) {\n-                klist.target = CredentialsCache.getInstance();\n-                klist.name = CredentialsCache.cacheName();\n+            if (name == null) {\n+                target = CredentialsCache.getInstance();\n+                name = CredentialsCache.cacheName();\n@@ -92,1 +159,1 @@\n-                klist.target = CredentialsCache.getInstance(klist.name);\n+                target = CredentialsCache.getInstance(name);\n@@ -94,2 +161,2 @@\n-            if (klist.target != null)  {\n-                klist.displayCache();\n+            if (target != null)  {\n+                displayCache();\n@@ -97,2 +164,2 @@\n-                klist.displayMessage(\"Credentials cache\");\n-                System.exit(-1);\n+                displayMessage(\"Credentials cache\");\n+                throw new ExitException(-1);\n@@ -102,1 +169,1 @@\n-            KeyTab ktab = KeyTab.getInstance(klist.name);\n+            KeyTab ktab = KeyTab.getInstance(name);\n@@ -104,2 +171,2 @@\n-                System.out.println(\"KeyTab \" + klist.name + \" not found.\");\n-                System.exit(-1);\n+                System.out.println(\"KeyTab \" + name + \" not found.\");\n+                throw new ExitException(-1);\n@@ -107,1 +174,1 @@\n-                System.out.println(\"KeyTab \" + klist.name\n+                System.out.println(\"KeyTab \" + name\n@@ -109,1 +176,1 @@\n-                System.exit(-1);\n+                throw new ExitException(-1);\n@@ -111,3 +178,3 @@\n-            klist.target = ktab;\n-            klist.name = ktab.tabName();\n-            klist.displayTab();\n+            target = ktab;\n+            name = ktab.tabName();\n+            displayTab();\n@@ -116,25 +183,1 @@\n-            if (klist.name != null) {\n-                klist.printHelp();\n-                System.exit(-1);\n-            } else {\n-                klist.target = CredentialsCache.getInstance();\n-                klist.name = CredentialsCache.cacheName();\n-                if (klist.target != null) {\n-                    klist.displayCache();\n-                } else {\n-                    klist.displayMessage(\"Credentials cache\");\n-                    System.exit(-1);\n-                }\n-            }\n-        }\n-    }\n-\n-    \/**\n-     * Parses the command line arguments.\n-     *\/\n-    void processArgs(String[] args) {\n-        Character arg;\n-        for (int i = 0; i < args.length; i++) {\n-            if (args[i].equals(\"-?\") ||\n-                args[i].equals(\"-h\") ||\n-                args[i].equals(\"--help\")) {\n+            if (name != null) {\n@@ -142,34 +185,1 @@\n-                System.exit(0);\n-            }\n-            if ((args[i].length() >= 2) && (args[i].startsWith(\"-\"))) {\n-                arg = Character.valueOf(args[i].charAt(1));\n-                switch (arg.charValue()) {\n-                case 'c':\n-                    action = 'c';\n-                    break;\n-                case 'k':\n-                    action = 'k';\n-                    break;\n-                case 'a':\n-                    options[2] = 'a';\n-                    break;\n-                case 'n':\n-                    options[3] = 'n';\n-                    break;\n-                case 'f':\n-                    options[1] = 'f';\n-                    break;\n-                case 'e':\n-                    options[0] = 'e';\n-                    break;\n-                case 'K':\n-                    options[1] = 'K';\n-                    break;\n-                case 't':\n-                    options[2] = 't';\n-                    break;\n-                default:\n-                    printHelp();\n-                    System.exit(-1);\n-                }\n-\n+                throw new ExitException(-1);\n@@ -177,4 +187,4 @@\n-                if (!args[i].startsWith(\"-\") && (i == args.length - 1)) {\n-                    \/\/ the argument is the last one.\n-                    name = args[i];\n-                    arg = null;\n+                target = CredentialsCache.getInstance();\n+                name = CredentialsCache.cacheName();\n+                if (target != null) {\n+                    displayCache();\n@@ -182,2 +192,2 @@\n-                    printHelp(); \/\/ incorrect input format.\n-                    System.exit(-1);\n+                    displayMessage(\"Credentials cache\");\n+                    throw new ExitException(-1);\n@@ -233,1 +243,1 @@\n-            System.exit(-1);\n+            throw new ExitException(-1);\n@@ -330,1 +340,1 @@\n-                    System.exit(-1);\n+                    throw new ExitException(-1);\n@@ -362,1 +372,1 @@\n-     * @param date the string form of Date object.\n+     * @param kt the string form of Date object.\n","filename":"src\/java.security.jgss\/windows\/classes\/sun\/security\/krb5\/internal\/tools\/Klist.java","additions":98,"deletions":88,"binary":false,"changes":186,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2003, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2003, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -76,0 +76,17 @@\n+        try {\n+            ktab.run(args);\n+        } catch (ExitException ee) {\n+            System.exit(ee.errorCode);\n+        }\n+    }\n+\n+    private static class ExitException extends RuntimeException {\n+        @java.io.Serial\n+        static final long serialVersionUID = 0L;\n+        private final int errorCode;\n+        public ExitException(int errorCode) {\n+            this.errorCode = errorCode;\n+        }\n+    }\n+\n+    public void run(String[] args) throws ExitException {\n@@ -82,2 +99,1 @@\n-            ktab.printHelp();\n-            System.exit(0);\n+            printHelp();\n@@ -86,1 +102,1 @@\n-            ktab.action = 'l';\n+            action = 'l';\n@@ -88,1 +104,1 @@\n-            ktab.processArgs(args);\n+            processArgs(args);\n@@ -90,3 +106,3 @@\n-        ktab.table = KeyTab.getInstance(ktab.name);\n-        if (ktab.table.isMissing() && ktab.action != 'a') {\n-            if (ktab.name == null) {\n+        table = KeyTab.getInstance(name);\n+        if (table.isMissing() && action != 'a') {\n+            if (name == null) {\n@@ -96,1 +112,1 @@\n-                        ktab.name + \" does not exist.\");\n+                        name + \" does not exist.\");\n@@ -98,1 +114,1 @@\n-            System.exit(-1);\n+            throw new ExitException(-1);\n@@ -100,2 +116,2 @@\n-        if (!ktab.table.isValid()) {\n-            if (ktab.name == null) {\n+        if (!table.isValid()) {\n+            if (name == null) {\n@@ -106,1 +122,1 @@\n-                        ktab.name + \" is incorrect.\");\n+                        name + \" is incorrect.\");\n@@ -108,1 +124,1 @@\n-            System.exit(-1);\n+            throw new ExitException(-1);\n@@ -110,1 +126,1 @@\n-        switch (ktab.action) {\n+        switch (action) {\n@@ -112,1 +128,1 @@\n-            ktab.listKt();\n+            listKt();\n@@ -115,1 +131,1 @@\n-            ktab.addEntry();\n+            addEntry();\n@@ -118,1 +134,1 @@\n-            ktab.deleteEntry();\n+            deleteEntry();\n@@ -121,1 +137,1 @@\n-            ktab.error(\"A command must be provided\");\n+            error(\"A command must be provided\");\n@@ -270,1 +286,1 @@\n-            System.exit(-1);\n+            throw new ExitException(-1);\n@@ -279,1 +295,1 @@\n-            System.exit(-1);\n+            throw new ExitException(-1);\n@@ -291,1 +307,1 @@\n-                System.exit(-1);\n+                throw new ExitException(-1);\n@@ -316,1 +332,1 @@\n-            System.exit(-1);\n+            throw new ExitException(-1);\n@@ -320,1 +336,1 @@\n-            System.exit(-1);\n+            throw new ExitException(-1);\n@@ -402,2 +418,3 @@\n-                    answer.equalsIgnoreCase(\"Yes\"));\n-                else {\n+                    answer.equalsIgnoreCase(\"Yes\")) {\n+                    ;\n+                } else {\n@@ -405,1 +422,1 @@\n-                    System.exit(0);\n+                    return;\n@@ -412,1 +429,1 @@\n-            System.exit(-1);\n+            throw new ExitException(-1);\n@@ -417,1 +434,1 @@\n-            System.exit(-1);\n+            throw new ExitException(-1);\n@@ -425,1 +442,1 @@\n-            System.exit(-1);\n+            throw new ExitException(-1);\n@@ -433,1 +450,1 @@\n-                System.exit(-1);\n+                throw new ExitException(-1);\n@@ -444,1 +461,1 @@\n-        System.exit(-1);\n+        throw new ExitException(-1);\n","filename":"src\/java.security.jgss\/windows\/classes\/sun\/security\/krb5\/internal\/tools\/Ktab.java","additions":49,"deletions":32,"binary":false,"changes":81,"status":"modified"},{"patch":"@@ -138,1 +138,18 @@\n-        js.run(args);\n+        try {\n+            js.run(args);\n+        } catch (ExitException ee) {\n+            System.exit(ee.errorCode);\n+        }\n+    }\n+\n+    private static class ExitException extends RuntimeException {\n+        @java.io.Serial\n+        static final long serialVersionUID = 0L;\n+        private final int errorCode;\n+        public ExitException(int errorCode) {\n+            this.errorCode = errorCode;\n+        }\n+    }\n+\n+    private static void exit(int exitCode) {\n+        throw new ExitException(exitCode);\n@@ -235,1 +252,1 @@\n-            args = parseArgs(args);\n+            parseArgs(args);\n@@ -239,1 +256,1 @@\n-                for (String provName: providers) {\n+                for (String provName : providers) {\n@@ -266,1 +283,1 @@\n-                for (String provClass: providerClasses) {\n+                for (String provClass : providerClasses) {\n@@ -288,6 +305,1 @@\n-                        System.out.println(rb.getString(\"jarsigner.error.\") +\n-                                        e.getMessage());\n-                        if (debug) {\n-                            e.printStackTrace();\n-                        }\n-                        System.exit(1);\n+                        throw e;\n@@ -296,5 +308,0 @@\n-                \/*              if (debug) {\n-                    SignatureFileVerifier.setDebug(true);\n-                    ManifestEntryVerifier.setDebug(true);\n-                }\n-                *\/\n@@ -308,0 +315,6 @@\n+        } catch (ExitException ee) {\n+            if (ee.errorCode == 0) {\n+                return;\n+            } else {\n+                throw ee;\n+            }\n@@ -313,1 +326,1 @@\n-            System.exit(1);\n+            exit(1);\n@@ -347,1 +360,1 @@\n-                System.exit(exitCode);\n+                exit(exitCode);\n@@ -615,1 +628,1 @@\n-        System.exit(1);\n+        exit(1);\n@@ -620,1 +633,1 @@\n-        System.exit(0);\n+        exit(0);\n@@ -722,1 +735,1 @@\n-        System.exit(0);\n+        exit(0);\n@@ -1108,6 +1121,0 @@\n-            return;\n-        } catch (Exception e) {\n-            System.out.println(rb.getString(\"jarsigner.\") + e);\n-            if (debug) {\n-                e.printStackTrace();\n-            }\n@@ -1119,2 +1126,0 @@\n-\n-        System.exit(1);\n@@ -2472,1 +2477,1 @@\n-        System.exit(1);\n+        exit(1);\n@@ -2481,1 +2486,1 @@\n-        System.exit(1);\n+        exit(1);\n","filename":"src\/jdk.jartool\/share\/classes\/sun\/security\/tools\/jarsigner\/Main.java","additions":35,"deletions":30,"binary":false,"changes":65,"status":"modified"},{"patch":"@@ -0,0 +1,68 @@\n+\/*\n+ * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/*\n+ * @test\n+ * @bug 8316964\n+ * @summary check exit code in kinit, klist, and ktab\n+ * @requires os.family == \"windows\"\n+ * @library \/test\/lib\n+ * @modules java.security.jgss\/sun.security.krb5.internal.tools\n+ *\/\n+\n+import jdk.test.lib.SecurityTools;\n+\n+public class ExitOrNot {\n+    public static void main(String[] args) throws Exception {\n+\n+        \/\/ launching the tool still exits\n+        SecurityTools.kinit(\"u@R p1 p2\")\n+                .shouldHaveExitValue(-1);\n+\n+        SecurityTools.klist(\"-x\")\n+                .shouldHaveExitValue(-1);\n+\n+        SecurityTools.ktab(\"-x\")\n+                .shouldHaveExitValue(-1);\n+\n+        \/\/ calling the run() methods no longer\n+        try {\n+            new sun.security.krb5.internal.tools.Kinit()\n+                    .run(\"u@R p1 p2\".split(\" \"));\n+        } catch (Exception e) {\n+            \/\/ whatever\n+        }\n+        try {\n+            new sun.security.krb5.internal.tools.Klist()\n+                    .run(\"-x\".split(\" \"));\n+        } catch (Exception e) {\n+            \/\/ whatever\n+        }\n+        try {\n+            new sun.security.krb5.internal.tools.Ktab()\n+                    .run(\"-x\".split(\" \"));\n+        } catch (Exception e) {\n+            \/\/ whatever\n+        }\n+    }\n+}\n","filename":"test\/jdk\/sun\/security\/krb5\/tools\/ExitOrNot.java","additions":68,"deletions":0,"binary":false,"changes":68,"status":"added"},{"patch":"@@ -0,0 +1,59 @@\n+\/*\n+ * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/*\n+ * @test\n+ * @bug 8316964\n+ * @summary check exit code in jarsigner and keytool\n+ * @library \/test\/lib\n+ * @modules java.base\/sun.security.tools.keytool\n+ *          jdk.jartool\/sun.security.tools.jarsigner\n+ *\/\n+\n+import jdk.test.lib.SecurityTools;\n+\n+public class ExitOrNot {\n+    public static void main(String[] args) throws Exception {\n+\n+        \/\/ launching the tool still exits\n+        SecurityTools.jarsigner(\"1 2 3\")\n+                .shouldHaveExitValue(1);\n+        SecurityTools.keytool(\"-x\")\n+                .shouldHaveExitValue(1);\n+\n+        \/\/ calling the run() methods no longer\n+        try {\n+            new sun.security.tools.jarsigner.Main()\n+                    .run(\"1 2 3\".split(\" \"));\n+        } catch (Exception e) {\n+            \/\/ whatever\n+        }\n+\n+        try {\n+            new sun.security.tools.keytool.Main()\n+                    .run(\"-x\".split(\" \"), System.out);\n+        } catch (Exception e) {\n+            \/\/ whatever\n+        }\n+    }\n+}\n","filename":"test\/jdk\/sun\/security\/tools\/jarsigner\/ExitOrNot.java","additions":59,"deletions":0,"binary":false,"changes":59,"status":"added"}]}