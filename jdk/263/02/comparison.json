{"files":[{"patch":"@@ -49,0 +49,1 @@\n+import jdk.incubator.jpackage.internal.Arguments.CLIOptions;\n@@ -57,0 +58,1 @@\n+import static jdk.incubator.jpackage.internal.StandardBundlerParam.PREDEFINED_APP_IMAGE;\n@@ -136,2 +138,13 @@\n-        for (var launcherParams : launchers) {\n-            launcherParams = AddLauncherArguments.merge(params, launcherParams,\n+        \/\/ Read launchers information from predefine app image\n+        if (launchers.isEmpty() &&\n+                PREDEFINED_APP_IMAGE.fetchFrom(params) != null) {\n+            List<String> launcherPaths = AppImageFile.getLauncherNames(\n+                    PREDEFINED_APP_IMAGE.fetchFrom(params), params);\n+            if (!launcherPaths.isEmpty()) {\n+                launcherPaths.remove(0); \/\/ Remove main launcher\n+            }\n+            for (var launcherPath : launcherPaths) {\n+                Map<String, ? super Object> launcherParams = new HashMap<>();\n+                Arguments.putUnlessNull(launcherParams, CLIOptions.NAME.getId(),\n+                        launcherPath);\n+                launcherParams = AddLauncherArguments.merge(params, launcherParams,\n@@ -139,3 +152,12 @@\n-                    FILE_ASSOCIATIONS.getID());\n-            nestedIntegrations.add(new DesktopIntegration(thePackage,\n-                    launcherParams, params));\n+                    FILE_ASSOCIATIONS.getID(), PREDEFINED_APP_IMAGE.getID());\n+                nestedIntegrations.add(new DesktopIntegration(thePackage,\n+                        launcherParams, params));\n+            }\n+        } else {\n+            for (var launcherParams : launchers) {\n+                launcherParams = AddLauncherArguments.merge(params, launcherParams,\n+                        ICON.getID(), ICON_PNG.getID(), ADD_LAUNCHERS.getID(),\n+                        FILE_ASSOCIATIONS.getID());\n+                nestedIntegrations.add(new DesktopIntegration(thePackage,\n+                        launcherParams, params));\n+            }\n","filename":"src\/jdk.incubator.jpackage\/linux\/classes\/jdk\/incubator\/jpackage\/internal\/DesktopIntegration.java","additions":27,"deletions":5,"binary":false,"changes":32,"status":"modified"},{"patch":"@@ -35,0 +35,1 @@\n+import jdk.incubator.jpackage.internal.ApplicationLayout;\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/AdditionalLauncher.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -320,0 +320,5 @@\n+    public PackageTest addLauncherName(String name) {\n+        launchersName.add(name);\n+        return this;\n+    }\n+\n@@ -559,1 +564,6 @@\n-                    new WindowsHelper.DesktopIntegrationVerifier(cmd);\n+                    \/\/ Check main launcher\n+                    new WindowsHelper.DesktopIntegrationVerifier(cmd, null);\n+                    \/\/ Check additional launchers\n+                    launchersName.forEach(name -> {\n+                        new WindowsHelper.DesktopIntegrationVerifier(cmd, name);\n+                    });\n@@ -574,1 +584,6 @@\n-                    new WindowsHelper.DesktopIntegrationVerifier(cmd);\n+                    \/\/ Check main launcher\n+                    new WindowsHelper.DesktopIntegrationVerifier(cmd, null);\n+                    \/\/ Check additional launchers\n+                    launchersName.forEach(name -> {\n+                        new WindowsHelper.DesktopIntegrationVerifier(cmd, name);\n+                    });\n@@ -621,0 +636,1 @@\n+    private final List<String> launchersName = new ArrayList();\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/PackageTest.java","additions":18,"deletions":2,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -137,1 +137,1 @@\n-        DesktopIntegrationVerifier(JPackageCommand cmd) {\n+        DesktopIntegrationVerifier(JPackageCommand cmd, String name) {\n@@ -140,0 +140,1 @@\n+            this.name = (name == null ? cmd.name() : name);\n@@ -146,1 +147,1 @@\n-            boolean appInstalled = cmd.appLauncherPath().toFile().exists();\n+            boolean appInstalled = cmd.appLauncherPath(name).toFile().exists();\n@@ -162,1 +163,1 @@\n-            return Path.of(cmd.name() + \".lnk\");\n+            return Path.of(name + \".lnk\");\n@@ -186,1 +187,1 @@\n-            boolean appInstalled = cmd.appLauncherPath().toFile().exists();\n+            boolean appInstalled = cmd.appLauncherPath(name).toFile().exists();\n@@ -203,1 +204,1 @@\n-                    () -> \"Unknown\"), cmd.name() + \".lnk\");\n+                    () -> \"Unknown\"), name + \".lnk\");\n@@ -231,1 +232,1 @@\n-            boolean appInstalled = cmd.appLauncherPath().toFile().exists();\n+            boolean appInstalled = cmd.appLauncherPath(name).toFile().exists();\n@@ -282,0 +283,1 @@\n+        private final String name;\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/WindowsHelper.java","additions":8,"deletions":6,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -0,0 +1,92 @@\n+\/*\n+ * Copyright (c) 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+import java.nio.file.Path;\n+import java.io.IOException;\n+import jdk.jpackage.test.AdditionalLauncher;\n+import jdk.jpackage.test.PackageTest;\n+import jdk.jpackage.test.PackageType;\n+import jdk.jpackage.test.TKit;\n+import jdk.jpackage.test.Annotations.Test;\n+import jdk.jpackage.test.JPackageCommand;\n+\n+\/**\n+ * Test multiple launchers in two phases. First test creates app image and then\n+ * creates installer from this image. Output of the test should be\n+ * MultiLauncherTwoPhaseTest*.* installer. The output installer should be basic\n+ * installer with 3 launcher MultiLauncherTwoPhaseTest, bar and foo. On Windows\n+ * we should have start menu integration under MultiLauncherTwoPhaseTest and\n+ * desktop shortcuts for all 3 launchers. Linux should also create shortcuts for\n+ * all launchers.\n+ *\/\n+\n+\/*\n+ * @test\n+ * @summary Multiple launchers in two phases\n+ * @library ..\/helpers\n+ * @library \/test\/lib\n+ * @key jpackagePlatformPackage\n+ * @build jdk.jpackage.test.*\n+ * @modules jdk.incubator.jpackage\/jdk.incubator.jpackage.internal\n+ * @compile MultiLauncherTwoPhaseTest.java\n+ * @run main\/othervm\/timeout=360 -Xmx512m jdk.jpackage.test.Main\n+ *  --jpt-run=MultiLauncherTwoPhaseTest\n+ *\/\n+\n+public class MultiLauncherTwoPhaseTest {\n+\n+    @Test\n+    public static void test() throws IOException {\n+        Path appimageOutput = TKit.createTempDirectory(\"appimage\");\n+\n+        JPackageCommand appImageCmd = JPackageCommand.helloAppImage()\n+                .setArgumentValue(\"--dest\", appimageOutput);\n+\n+        AdditionalLauncher launcher1 = new AdditionalLauncher(\"bar\");\n+        launcher1.setDefaultArguments().applyTo(appImageCmd);\n+\n+        AdditionalLauncher launcher2 = new AdditionalLauncher(\"foo\");\n+        launcher2.applyTo(appImageCmd);\n+\n+        PackageTest packageTest = new PackageTest()\n+                .addLauncherName(\"bar\") \/\/ Add launchers name for verification\n+                .addLauncherName(\"foo\")\n+                .addRunOnceInitializer(() -> appImageCmd.execute())\n+                .addBundleDesktopIntegrationVerifier(true)\n+                .addInitializer(cmd -> {\n+                    cmd.addArguments(\"--app-image\", appImageCmd.outputBundle());\n+                    cmd.removeArgumentWithValue(\"--input\");\n+                })\n+                .forTypes(PackageType.WINDOWS)\n+                .addInitializer(cmd -> {\n+                    cmd.addArguments(\"--win-shortcut\", \"--win-menu\",\n+                            \"--win-menu-group\", \"MultiLauncherTwoPhaseTest\");\n+                })\n+                .forTypes(PackageType.LINUX)\n+                .addInitializer(cmd -> {\n+                    cmd.addArguments(\"--linux-shortcut\");\n+                });\n+\n+        packageTest.run();\n+    }\n+}\n","filename":"test\/jdk\/tools\/jpackage\/share\/MultiLauncherTwoPhaseTest.java","additions":92,"deletions":0,"binary":false,"changes":92,"status":"added"}]}