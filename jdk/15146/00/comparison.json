{"files":[{"patch":"@@ -1562,11 +1562,0 @@\n-        if (alias != null) {\n-            attrList.add(new CK_ATTRIBUTE(CKA_LABEL, alias));\n-            attrList.add(new CK_ATTRIBUTE(CKA_ID, alias));\n-        } else {\n-            \/\/ ibutton requires something to be set\n-            \/\/ - alias must be unique\n-            attrList.add(new CK_ATTRIBUTE(CKA_ID,\n-                        getID(cert.getSubjectX500Principal().getName\n-                                        (X500Principal.CANONICAL), cert)));\n-        }\n-\n@@ -1576,0 +1565,33 @@\n+            long[] ch = findObjects(session,\n+                    attrList.toArray(new CK_ATTRIBUTE[attrList.size()]));\n+            if (ch.length != 0) { \/\/ found a match\n+                if (debug != null) {\n+                    String certInfo = (alias == null?\n+                            \"CA cert \" + cert.getSubjectX500Principal() :\n+                            \"EE cert for alias \" + alias);\n+                    debug.println(\"storeCert: found a match for \" + certInfo);\n+                }\n+                if (alias != null) {\n+                    \/\/ Add the alias to the existing cert\n+                    CK_ATTRIBUTE[] attrs = new CK_ATTRIBUTE[] {\n+                        new CK_ATTRIBUTE(CKA_LABEL, alias),\n+                        new CK_ATTRIBUTE(CKA_ID, alias) };\n+                    token.p11.C_SetAttributeValue\n+                        (session.id(), ch[0], attrs);\n+                    if (debug != null) {\n+                        debug.println(\"storeCert: added alias: \" + alias);\n+                    }\n+                }\n+                \/\/ done; no need to create the cert\n+                return;\n+            }\n+            if (alias != null) {\n+                attrList.add(new CK_ATTRIBUTE(CKA_LABEL, alias));\n+                attrList.add(new CK_ATTRIBUTE(CKA_ID, alias));\n+            } else {\n+                \/\/ ibutton requires something to be set\n+                \/\/ - alias must be unique\n+                attrList.add(new CK_ATTRIBUTE(CKA_ID,\n+                        getID(cert.getSubjectX500Principal().getName\n+                                        (X500Principal.CANONICAL), cert)));\n+            }\n@@ -1577,1 +1599,7 @@\n-                        attrList.toArray(new CK_ATTRIBUTE[attrList.size()]));\n+                    attrList.toArray(new CK_ATTRIBUTE[attrList.size()]));\n+            if (debug != null) {\n+                String certInfo = (alias == null?\n+                        \"CA cert \" + cert.getSubjectX500Principal() :\n+                        \"EE cert for alias \" + alias);\n+                debug.println(\"storeCert: created \" + certInfo);\n+            }\n@@ -1590,1 +1618,0 @@\n-\n","filename":"src\/jdk.crypto.cryptoki\/share\/classes\/sun\/security\/pkcs11\/P11KeyStore.java","additions":40,"deletions":13,"binary":false,"changes":53,"status":"modified"},{"patch":"@@ -25,1 +25,1 @@\n- * @bug 8301154\n+ * @bug 8301154 8309214\n","filename":"test\/jdk\/sun\/security\/pkcs11\/KeyStore\/CertChainRemoval.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}