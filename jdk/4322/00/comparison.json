{"files":[{"patch":"@@ -112,0 +112,1 @@\n+    MutexLocker ml(DumpTimeTable_lock, Mutex::_no_safepoint_check_flag);\n","filename":"src\/hotspot\/share\/cds\/dynamicArchive.cpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -492,0 +492,1 @@\n+  MutexLocker ml(DumpTimeTable_lock, Mutex::_no_safepoint_check_flag);\n","filename":"src\/hotspot\/share\/cds\/metaspaceShared.cpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -355,0 +355,2 @@\n+\n+  InstanceKlass* caller_ik() const { return _caller_ik; }\n@@ -1237,0 +1239,5 @@\n+  return find_or_allocate_info_for_locked(k);\n+}\n+\n+DumpTimeSharedClassInfo* SystemDictionaryShared::find_or_allocate_info_for_locked(InstanceKlass* k) {\n+  assert_lock_strong(DumpTimeTable_lock);\n@@ -1470,0 +1477,1 @@\n+  assert_lock_strong(DumpTimeTable_lock);\n@@ -1471,1 +1479,1 @@\n-  DumpTimeSharedClassInfo* p = find_or_allocate_info_for(k);\n+  DumpTimeSharedClassInfo* p = find_or_allocate_info_for_locked(k);\n@@ -1502,0 +1510,5 @@\n+static bool is_class_alive(InstanceKlass* k) {\n+  assert_lock_strong(DumpTimeTable_lock);\n+  return k->class_loader_data()->is_alive();\n+}\n+\n@@ -1508,1 +1521,1 @@\n-    if (!info.is_excluded()) {\n+    if (is_class_alive(k) && !info.is_excluded()) {\n@@ -1521,3 +1534,5 @@\n-    info.metaspace_pointers_do(_it);\n-    key.metaspace_pointers_do(_it);\n-    return true;\n+    if (is_class_alive(key.caller_ik())) {\n+      info.metaspace_pointers_do(_it);\n+      key.metaspace_pointers_do(_it);\n+    }\n+    return true; \/\/ keep on iterating\n@@ -1528,1 +1543,1 @@\n-  assert_locked_or_safepoint(DumpTimeTable_lock);\n+  assert_lock_strong(DumpTimeTable_lock);\n@@ -2157,1 +2172,1 @@\n-  MutexLocker ml(DumpTimeTable_lock, Mutex::_no_safepoint_check_flag);\n+  assert_lock_strong(DumpTimeTable_lock);\n","filename":"src\/hotspot\/share\/classfile\/systemDictionaryShared.cpp","additions":22,"deletions":7,"binary":false,"changes":29,"status":"modified"},{"patch":"@@ -210,0 +210,1 @@\n+  static DumpTimeSharedClassInfo* find_or_allocate_info_for_locked(InstanceKlass* k);\n","filename":"src\/hotspot\/share\/classfile\/systemDictionaryShared.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"}]}