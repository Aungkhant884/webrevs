{"files":[{"patch":"@@ -137,1 +137,2 @@\n-  BINUTILS_DIR=\"$CONFIGURESUPPORT_OUTPUTDIR\/binutils\"\n+  BINUTILS_BUILD_DIR=\"$CONFIGURESUPPORT_OUTPUTDIR\/binutils\"\n+  BINUTILS_INSTALL_DIR=\"$CONFIGURESUPPORT_OUTPUTDIR\/binutils-install\"\n@@ -146,2 +147,2 @@\n-  if ! test -d $BINUTILS_DIR; then\n-    $MKDIR -p $BINUTILS_DIR\n+  if ! test -d $BINUTILS_BUILD_DIR; then\n+    $MKDIR -p $BINUTILS_BUILD_DIR\n@@ -150,5 +151,5 @@\n-  if test -e $BINUTILS_DIR\/bfd\/libbfd.a && \\\n-      test -e $BINUTILS_DIR\/opcodes\/libopcodes.a && \\\n-      test -e $BINUTILS_DIR\/libiberty\/libiberty.a && \\\n-      test -e $BINUTILS_DIR\/zlib\/libz.a; then\n-    AC_MSG_NOTICE([Found binutils binaries in binutils source directory -- not building])\n+  # We don't know the version, not checking for libsframe.a\n+  if test -e $BINUTILS_INSTALL_DIR\/lib\/libbfd.a && \\\n+     test -e $BINUTILS_INSTALL_DIR\/lib\/libopcodes.a && \\\n+     test -e $BINUTILS_INSTALL_DIR\/lib\/libiberty.a; then\n+    AC_MSG_NOTICE([Found binutils binaries in binutils install directory -- not building])\n@@ -193,1 +194,1 @@\n-    AC_MSG_NOTICE([configure command line: cd $BINUTILS_DIR && $BINUTILS_SRC\/configure --disable-nls CFLAGS=\"$binutils_cflags\" CC=\"$binutils_cc\" AR=\"$AR\" $binutils_target])\n+    AC_MSG_NOTICE([configure command line: cd $BINUTILS_BUILD_DIR && $BINUTILS_SRC\/configure --disable-werror --prefix=$BINUTILS_INSTALL_DIR --enable-install-libiberty --with-system-zlib --without-zstd --disable-nls CFLAGS=\"$binutils_cflags\" CC=\"$binutils_cc\" AR=\"$AR\" $binutils_target])\n@@ -195,3 +196,3 @@\n-    cd \"$BINUTILS_DIR\"\n-    $BINUTILS_SRC\/configure --disable-nls CFLAGS=\"$binutils_cflags\" CC=\"$binutils_cc\" AR=\"$AR\" $binutils_target\n-    if test $? -ne 0 || ! test -e $BINUTILS_DIR\/Makefile; then\n+    cd \"$BINUTILS_BUILD_DIR\"\n+    $BINUTILS_SRC\/configure --disable-werror --prefix=$BINUTILS_INSTALL_DIR --enable-install-libiberty --with-system-zlib --without-zstd --disable-nls CFLAGS=\"$binutils_cflags\" CC=\"$binutils_cc\" AR=\"$AR\" $binutils_target\n+    if test $? -ne 0 || ! test -e $BINUTILS_BUILD_DIR\/Makefile; then\n@@ -202,1 +203,1 @@\n-    $MAKE all-opcodes\n+    $MAKE all-opcodes all-libiberty\n@@ -207,0 +208,6 @@\n+    AC_MSG_NOTICE([Running binutils make install])\n+    $MAKE install-opcodes install-libiberty\n+    if test $? -ne 0; then\n+      AC_MSG_NOTICE([Automatic building, install step, of binutils failed on make. Try building it manually])\n+      AC_MSG_ERROR([Cannot continue])\n+    fi\n@@ -226,1 +233,1 @@\n-    # Try building the source first. If it succeeds, it sets $BINUTILS_DIR.\n+    # Try building the source first. If it succeeds, it sets $BINUTILS_INSTALL_DIR.\n@@ -231,1 +238,1 @@\n-    BINUTILS_DIR=\"$with_binutils\"\n+    BINUTILS_INSTALL_DIR=\"$with_binutils\"\n@@ -235,0 +242,1 @@\n+  HSDIS_LDFLAGS=\"\"\n@@ -236,1 +244,3 @@\n-  if test \"x$BINUTILS_DIR\" = xsystem; then\n+  disasm_header=\"<dis-asm.h>\"\n+\n+  if test \"x$BINUTILS_INSTALL_DIR\" = xsystem; then\n@@ -239,1 +249,0 @@\n-    AC_CHECK_LIB(iberty, xmalloc, [ HSDIS_LIBS=\"$HSDIS_LIBS -liberty\" ], [ binutils_system_error=\"libiberty not found\" ])\n@@ -241,0 +250,3 @@\n+    \/\/ If we find them\n+    AC_CHECK_LIB(iberty, xmalloc, [ HSDIS_LIBS=\"$HSDIS_LIBS -liberty\" ])\n+    AC_CHECK_LIB(sframe, frame, [ HSDIS_LIBS=\"$HSDIS_LIBS -lsframe\" ], )\n@@ -242,10 +254,10 @@\n-  elif test \"x$BINUTILS_DIR\" != x; then\n-    if test -e $BINUTILS_DIR\/bfd\/libbfd.a && \\\n-        test -e $BINUTILS_DIR\/opcodes\/libopcodes.a && \\\n-        test -e $BINUTILS_DIR\/libiberty\/libiberty.a && \\\n-        test -e $BINUTILS_DIR\/zlib\/libz.a; then\n-      HSDIS_CFLAGS=\"-DLIBARCH_$OPENJDK_TARGET_CPU_LEGACY_LIB\"\n-      if test -n \"$BINUTILS_SRC\"; then\n-        HSDIS_CFLAGS=\"$HSDIS_CFLAGS -I$BINUTILS_SRC\/include -I$BINUTILS_DIR\/bfd\"\n-      else\n-        HSDIS_CFLAGS=\"$HSDIS_CFLAGS -I$BINUTILS_DIR\/include -I$BINUTILS_DIR\/bfd\"\n+  elif test \"x$BINUTILS_INSTALL_DIR\" != x; then\n+    disasm_header=\"\\\"$BINUTILS_INSTALL_DIR\/include\/dis-asm.h\\\"\"\n+    if test -e $BINUTILS_INSTALL_DIR\/lib\/libbfd.a && \\\n+       test -e $BINUTILS_INSTALL_DIR\/lib\/libopcodes.a && \\\n+       test -e $BINUTILS_INSTALL_DIR\/lib\/libiberty.a; then\n+      HSDIS_CFLAGS=\"-DLIBARCH_$OPENJDK_TARGET_CPU_LEGACY_LIB -I$BINUTILS_INSTALL_DIR\/include\"\n+      HSDIS_LIBS=\"$BINUTILS_INSTALL_DIR\/lib\/libbfd.a $BINUTILS_INSTALL_DIR\/lib\/libopcodes.a $BINUTILS_INSTALL_DIR\/lib\/libiberty.a\"\n+      # If we have libsframe add it.\n+      if test -e $BINUTILS_INSTALL_DIR\/lib\/libsframe.a; then\n+        HSDIS_LIBS=\"$HSDIS_LIBS $BINUTILS_INSTALL_DIR\/lib\/libsframe.a\"\n@@ -253,2 +265,3 @@\n-      HSDIS_LDFLAGS=\"\"\n-      HSDIS_LIBS=\"$BINUTILS_DIR\/bfd\/libbfd.a $BINUTILS_DIR\/opcodes\/libopcodes.a $BINUTILS_DIR\/libiberty\/libiberty.a $BINUTILS_DIR\/zlib\/libz.a\"\n+      AC_CHECK_LIB(z, deflate, [ HSDIS_LIBS=\"$HSDIS_LIBS -lz\" ], AC_MSG_ERROR([libz not found]))\n+    else\n+      AC_MSG_ERROR([\"$BINUTILS_INSTALL_DIR\/libs\/ must contain libbfd.a, libopcodes.a, libiberty.a\"])\n@@ -258,0 +271,11 @@\n+  AC_MSG_CHECKING([Checking binutils API])\n+  AC_COMPILE_IFELSE([AC_LANG_PROGRAM([#include $disasm_header],[[void foo() {init_disassemble_info(0, 0, 0, 0);}]])],\n+    [\n+      AC_MSG_RESULT([New API])\n+      HSDIS_CFLAGS=\"$HSDIS_CFLAGS -DBINUTILS_NEW_API\"\n+    ],\n+    [\n+      AC_MSG_RESULT([Old API])\n+    ]\n+  )\n+\n@@ -259,1 +283,1 @@\n-  case \"x$BINUTILS_DIR\" in\n+  case \"x$BINUTILS_INSTALL_DIR\" in\n@@ -282,1 +306,1 @@\n-        AC_MSG_RESULT([$BINUTILS_DIR])\n+        AC_MSG_RESULT([$BINUTILS_INSTALL_DIR])\n@@ -285,1 +309,1 @@\n-        AC_MSG_ERROR([$BINUTILS_DIR does not contain a proper binutils installation])\n+        AC_MSG_ERROR([$BINUTILS_INSTALL_DIR does not contain a proper binutils installation])\n","filename":"make\/autoconf\/lib-hsdis.m4","additions":56,"deletions":32,"binary":false,"changes":88,"status":"modified"},{"patch":"@@ -52,4 +52,0 @@\n-#ifndef SYSTEM_BINUTILS\n-#include <config.h> \/* required by bfd.h *\/\n-#endif\n-\n@@ -60,1 +56,4 @@\n-#include <libiberty.h>\n+\/* defines for bfd.h *\/\n+#define PACKAGE \"hsdis\"\n+#define PACKAGE_VERSION 1\n+\n@@ -559,0 +558,17 @@\n+static fprintf_ftype target_fprintf_func = NULL;\n+\n+#ifdef BINUTILS_NEW_API\n+static int wrapper_fprintf_styled_ftype(void *v, enum disassembler_style style_unused, const char* fmt, ...) {\n+  char buffer[1024] = {};\n+  va_list args;\n+  int r;\n+  va_start(args, fmt);\n+  r = vsnprintf(buffer, sizeof(buffer), fmt, args);\n+  va_end(args);\n+  if (target_fprintf_func != NULL) {\n+    return target_fprintf_func(v, \"%s\", buffer);\n+  }\n+  return r;\n+}\n+#endif\n+\n@@ -564,0 +580,4 @@\n+  target_fprintf_func = fprintf_func;\n+#ifdef BINUTILS_NEW_API\n+  init_disassemble_info(dinfo, stream, fprintf_func, wrapper_fprintf_styled_ftype);\n+#else\n@@ -565,0 +585,1 @@\n+#endif\n","filename":"src\/utils\/hsdis\/binutils\/hsdis-binutils.c","additions":26,"deletions":5,"binary":false,"changes":31,"status":"modified"}]}