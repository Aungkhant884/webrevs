{"files":[{"patch":"@@ -40,4 +40,0 @@\n-#if ! defined(_ALLBSD_SOURCE)\n-void transfer(JNIEnv* env, jint dst, jint src, volatile jint* cancel);\n-#endif\n-\n@@ -75,0 +71,33 @@\n+\/\/ Transfer via user-space buffers\n+void transfer(JNIEnv* env, jint dst, jint src, volatile jint* cancel)\n+{\n+    char buf[8192];\n+\n+    for (;;) {\n+        ssize_t n, pos, len;\n+        RESTARTABLE(read((int)src, &buf, sizeof(buf)), n);\n+        if (n <= 0) {\n+            if (n < 0)\n+                throwUnixException(env, errno);\n+            return;\n+        }\n+        if (cancel != NULL && *cancel != 0) {\n+            throwUnixException(env, ECANCELED);\n+            return;\n+        }\n+        pos = 0;\n+        len = n;\n+        do {\n+            char* bufp = buf;\n+            bufp += pos;\n+            RESTARTABLE(write((int)dst, bufp, len), n);\n+            if (n == -1) {\n+                throwUnixException(env, errno);\n+                return;\n+            }\n+            pos += n;\n+            len -= n;\n+        } while (len > 0);\n+    }\n+}\n+\n@@ -96,1 +125,3 @@\n-                break;\n+                transfer(env, dst, src, cancel);\n+            } else {\n+                throwUnixException(env, errno);\n@@ -98,1 +129,0 @@\n-            throwUnixException(env, errno);\n@@ -106,2 +136,0 @@\n-\n-    transfer(env, dst, src, cancel);\n@@ -130,36 +158,0 @@\n-\n-\n-#if ! defined(_ALLBSD_SOURCE)\n-\/\/ Transfer via user-space buffers\n-void transfer(JNIEnv* env, jint dst, jint src, volatile jint* cancel)\n-{\n-    char buf[8192];\n-\n-    for (;;) {\n-        ssize_t n, pos, len;\n-        RESTARTABLE(read((int)src, &buf, sizeof(buf)), n);\n-        if (n <= 0) {\n-            if (n < 0)\n-                throwUnixException(env, errno);\n-            return;\n-        }\n-        if (cancel != NULL && *cancel != 0) {\n-            throwUnixException(env, ECANCELED);\n-            return;\n-        }\n-        pos = 0;\n-        len = n;\n-        do {\n-            char* bufp = buf;\n-            bufp += pos;\n-            RESTARTABLE(write((int)dst, bufp, len), n);\n-            if (n == -1) {\n-                throwUnixException(env, errno);\n-                return;\n-            }\n-            pos += n;\n-            len -= n;\n-        } while (len > 0);\n-    }\n-}\n-#endif\n","filename":"src\/java.base\/unix\/native\/libnio\/fs\/UnixCopyFile.c","additions":36,"deletions":44,"binary":false,"changes":80,"status":"modified"}]}