{"files":[{"patch":"@@ -1645,5 +1645,4 @@\n-void C2_MacroAssembler::minmax_fp_masked_v(VectorRegister dst, VectorRegister src1,\n-                                           VectorRegister src2, bool is_double, bool is_min,\n-                                           int vector_length, VectorRegister vmask) {\n-  assert_different_registers(dst, src1, src2);\n-\n+void C2_MacroAssembler::minmax_fp_masked_v(VectorRegister dst, VectorRegister src1, VectorRegister src2,\n+                                           VectorRegister vmask, int vector_length, VectorRegister tmp1,\n+                                           VectorRegister tmp2, bool is_double, bool is_min) {\n+  assert_different_registers(src1, src2, tmp1, tmp2);\n@@ -1651,1 +1650,0 @@\n-  vmmv_m(v0, vmask);\n@@ -1653,2 +1651,3 @@\n-  is_min ? vfmin_vv(dst, src1, src2, Assembler::v0_t)\n-         : vfmax_vv(dst, src1, src2, Assembler::v0_t);\n+  \/\/ Check vector elements of src1 and src2 for NaN.\n+  vmfeq_vv(tmp1, src1, src1);\n+  vmfeq_vv(tmp2, src2, src2);\n@@ -1656,4 +1655,3 @@\n-  vmfne_vv(v0, src1, src1, Assembler::v0_t);\n-  vfadd_vv(dst, src1, src1, Assembler::v0_t);\n-  vmmv_m(v0, vmask);\n-  vmfne_vv(v0, src2, src2, Assembler::v0_t);\n+  vmandn_mm(v0, vmask, tmp1);\n+  vfadd_vv(dst, src1, src1, Assembler::v0_t);  \n+  vmandn_mm(v0, vmask, tmp2);\n@@ -1661,0 +1659,5 @@\n+\n+  vmand_mm(tmp2, tmp1, tmp2);\n+  vmand_mm(v0, vmask, tmp2);\n+  is_min ? vfmin_vv(dst, src1, src2, Assembler::v0_t)\n+         : vfmax_vv(dst, src1, src2, Assembler::v0_t);\n","filename":"src\/hotspot\/cpu\/riscv\/c2_MacroAssembler_riscv.cpp","additions":15,"deletions":12,"binary":false,"changes":27,"status":"modified"},{"patch":"@@ -193,1 +193,2 @@\n-                         bool is_double, bool is_min, int vector_length, VectorRegister vmask);\n+                         VectorRegister vmask, int vector_length, VectorRegister tmp1,\n+                         VectorRegister tmp2, bool is_double, bool is_min);\n","filename":"src\/hotspot\/cpu\/riscv\/c2_MacroAssembler_riscv.hpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -726,1 +726,1 @@\n-instruct vmaxF_masked(vReg dst_src1, vReg src2, vRegMask vmask, vRegMask_V0 v0) %{\n+instruct vmaxF_masked(vReg dst_src1, vReg src2, vRegMask vmask, vReg tmp1, vReg tmp2, vRegMask_V0 v0) %{\n@@ -729,1 +729,1 @@\n-  effect(TEMP_DEF dst_src1, TEMP v0);\n+  effect(TEMP_DEF dst_src1, TEMP tmp1, TEMP tmp2, TEMP v0);\n@@ -731,1 +731,1 @@\n-  format %{ \"vmaxF_masked $dst_src1, $dst_src1, $src2, $vmask\\t# KILL $v0\" %}\n+  format %{ \"vmaxF_masked $dst_src1, $dst_src1, $src2, $vmask\\t# KILL $tmp1, $tmp2, $v0\" %}\n@@ -734,2 +734,3 @@\n-                          as_VectorRegister($src2$$reg), false \/* is_double *\/, false \/* is_min *\/,\n-                          Matcher::vector_length(this), as_VectorRegister($vmask$$reg));\n+                          as_VectorRegister($src2$$reg), as_VectorRegister($vmask$$reg),\n+                          Matcher::vector_length(this), as_VectorRegister($tmp1$$reg),\n+                          as_VectorRegister($tmp2$$reg), false \/* is_double *\/, false \/* is_min *\/);\n@@ -740,1 +741,1 @@\n-instruct vmaxD_masked(vReg dst_src1, vReg src2, vRegMask vmask, vRegMask_V0 v0) %{\n+instruct vmaxD_masked(vReg dst_src1, vReg src2, vRegMask vmask, vReg tmp1, vReg tmp2, vRegMask_V0 v0) %{\n@@ -743,1 +744,1 @@\n-  effect(TEMP_DEF dst_src1, TEMP v0);\n+  effect(TEMP_DEF dst_src1, TEMP tmp1, TEMP tmp2, TEMP v0);\n@@ -745,1 +746,1 @@\n-  format %{ \"vmaxD_masked $dst_src1, $dst_src1, $src2, $vmask\\t# KILL $v0\" %}\n+  format %{ \"vmaxD_masked $dst_src1, $dst_src1, $src2, $vmask\\t# KILL $tmp1, $tmp2, $v0\" %}\n@@ -748,2 +749,3 @@\n-                          as_VectorRegister($src2$$reg), true \/* is_double *\/, false \/* is_min *\/,\n-                          Matcher::vector_length(this), as_VectorRegister($vmask$$reg));\n+                          as_VectorRegister($src2$$reg), as_VectorRegister($vmask$$reg),\n+                          Matcher::vector_length(this), as_VectorRegister($tmp1$$reg),\n+                          as_VectorRegister($tmp2$$reg), true \/* is_double *\/, false \/* is_min *\/);\n@@ -754,1 +756,1 @@\n-instruct vminF_masked(vReg dst_src1, vReg src2, vRegMask vmask, vRegMask_V0 v0) %{\n+instruct vminF_masked(vReg dst_src1, vReg src2, vRegMask vmask, vReg tmp1, vReg tmp2, vRegMask_V0 v0) %{\n@@ -757,1 +759,1 @@\n-  effect(TEMP_DEF dst_src1, TEMP v0);\n+  effect(TEMP_DEF dst_src1, TEMP tmp1, TEMP tmp2, TEMP v0);\n@@ -759,1 +761,1 @@\n-  format %{ \"vminF_masked $dst_src1, $dst_src1, $src2, $vmask\\t# KILL $v0\" %}\n+  format %{ \"vminF_masked $dst_src1, $dst_src1, $src2, $vmask\\t# KILL $tmp1, $tmp2, $v0\" %}\n@@ -762,2 +764,3 @@\n-                          as_VectorRegister($src2$$reg), false \/* is_double *\/, true \/* is_min *\/,\n-                          Matcher::vector_length(this), as_VectorRegister($vmask$$reg));\n+                          as_VectorRegister($src2$$reg), as_VectorRegister($vmask$$reg),\n+                          Matcher::vector_length(this), as_VectorRegister($tmp1$$reg),\n+                          as_VectorRegister($tmp2$$reg), false \/* is_double *\/, true \/* is_min *\/);\n@@ -768,1 +771,1 @@\n-instruct vminD_masked(vReg dst_src1, vReg src2, vRegMask vmask, vRegMask_V0 v0) %{\n+instruct vminD_masked(vReg dst_src1, vReg src2, vRegMask vmask, vReg tmp1, vReg tmp2, vRegMask_V0 v0) %{\n@@ -771,1 +774,1 @@\n-  effect(TEMP_DEF dst_src1, TEMP v0);\n+  effect(TEMP_DEF dst_src1, TEMP tmp1, TEMP tmp2, TEMP v0);\n@@ -773,1 +776,1 @@\n-  format %{ \"vminD_masked $dst_src1, $dst_src1, $src2, $vmask\\t# KILL $v0\" %}\n+  format %{ \"vminD_masked $dst_src1, $dst_src1, $src2, $vmask\\t# KILL $tmp1, $tmp2, $v0\" %}\n@@ -776,2 +779,3 @@\n-                          as_VectorRegister($src2$$reg), true \/* is_double *\/, true \/* is_min *\/,\n-                          Matcher::vector_length(this), as_VectorRegister($vmask$$reg));\n+                          as_VectorRegister($src2$$reg), as_VectorRegister($vmask$$reg),\n+                          Matcher::vector_length(this), as_VectorRegister($tmp1$$reg),\n+                          as_VectorRegister($tmp2$$reg), true \/* is_double *\/, true \/* is_min *\/);\n","filename":"src\/hotspot\/cpu\/riscv\/riscv_v.ad","additions":24,"deletions":20,"binary":false,"changes":44,"status":"modified"}]}