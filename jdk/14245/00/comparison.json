{"files":[{"patch":"@@ -5525,2 +5525,5 @@\n-    if (esize == 8) {\n-      __ addpd($vtmp$$FloatRegister, $src$$FloatRegister);\n+    uint length_in_bytes = Matcher::vector_length_in_bytes(this, $src);\n+    Assembler::SIMD_Arrangement arrangement = Assembler::esize2arrangement(esize,\n+                                                                           \/* isQ *\/ length_in_bytes == 16);\n+    if (arrangement == __ T2D || arrangement == __ T2S) {\n+      __ addpv($vtmp$$FloatRegister, arrangement, $src$$FloatRegister, $src$$FloatRegister);\n@@ -5528,3 +5531,0 @@\n-      uint length_in_bytes = Matcher::vector_length_in_bytes(this, $src);\n-      Assembler::SIMD_Arrangement arrangement = Assembler::esize2arrangement(esize,\n-                                                                             \/* isQ *\/ length_in_bytes == 16);\n","filename":"src\/hotspot\/cpu\/aarch64\/aarch64_vector.ad","additions":5,"deletions":5,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -3835,2 +3835,5 @@\n-    if (esize == 8) {\n-      __ addpd($vtmp$$FloatRegister, $src$$FloatRegister);\n+    uint length_in_bytes = Matcher::vector_length_in_bytes(this, $src);\n+    Assembler::SIMD_Arrangement arrangement = Assembler::esize2arrangement(esize,\n+                                                                           \/* isQ *\/ length_in_bytes == 16);\n+    if (arrangement == __ T2D || arrangement == __ T2S) {\n+      __ addpv($vtmp$$FloatRegister, arrangement, $src$$FloatRegister, $src$$FloatRegister);\n@@ -3838,3 +3841,0 @@\n-      uint length_in_bytes = Matcher::vector_length_in_bytes(this, $src);\n-      Assembler::SIMD_Arrangement arrangement = Assembler::esize2arrangement(esize,\n-                                                                             \/* isQ *\/ length_in_bytes == 16);\n","filename":"src\/hotspot\/cpu\/aarch64\/aarch64_vector_ad.m4","additions":5,"deletions":5,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -45,1 +45,2 @@\n-    private static final VectorSpecies<Double> SPECIES = DoubleVector.SPECIES_PREFERRED;\n+    private static final VectorSpecies<Float> SPECIES_F = FloatVector.SPECIES_64;\n+    private static final VectorSpecies<Integer> SPECIES_I = IntVector.SPECIES_PREFERRED;\n@@ -60,1 +61,1 @@\n-    static int maskAndTrueCount(boolean[] a, boolean[] b, int idx) {\n+    static int maskAndTrueCountFloat(boolean[] a, boolean[] b, int idx) {\n@@ -62,1 +63,1 @@\n-        boolean[] c = new boolean[SPECIES.length()];\n+        boolean[] c = new boolean[SPECIES_F.length()];\n@@ -64,1 +65,1 @@\n-        for (int i = idx; i < idx + SPECIES.length(); i++) {\n+        for (int i = idx; i < idx + SPECIES_F.length(); i++) {\n@@ -75,3 +76,18 @@\n-    static void assertArrayEquals(int[] r, boolean[] a, boolean[] b) {\n-        for (int i = 0; i < a.length; i += SPECIES.length()) {\n-            Asserts.assertEquals(r[i], maskAndTrueCount(a, b, i));\n+    static int maskAndTrueCountInteger(boolean[] a, boolean[] b, int idx) {\n+        int trueCount = 0;\n+        boolean[] c = new boolean[SPECIES_I.length()];\n+\n+        for (int i = idx; i < idx + SPECIES_I.length(); i++) {\n+            c[i - idx] = a[i] & b[i];\n+        }\n+\n+        for (int i = 0; i < c.length; i++) {\n+            trueCount += c[i] ? 1 : 0;\n+        }\n+\n+        return trueCount;\n+    }\n+\n+    static void assertArrayEqualsFloat(int[] r, boolean[] a, boolean[] b) {\n+        for (int i = 0; i < a.length; i += SPECIES_F.length()) {\n+            Asserts.assertEquals(r[i], maskAndTrueCountFloat(a, b, i));\n@@ -81,0 +97,19 @@\n+    static void assertArrayEqualsInteger(int[] r, boolean[] a, boolean[] b) {\n+        for (int i = 0; i < a.length; i += SPECIES_I.length()) {\n+            Asserts.assertEquals(r[i], maskAndTrueCountInteger(a, b, i));\n+        }\n+    }\n+\n+    @Test\n+    @IR(counts = { IRNode.VSTOREMASK_TRUECOUNT, \">= 1\" })\n+    public static void testFloat() {\n+        int[] r = new int[LENGTH];\n+        for (int i = 0; i < LENGTH; i += SPECIES_F.length()) {\n+            VectorMask<Float> ma = VectorMask.fromArray(SPECIES_F, ba, i);\n+            VectorMask<Float> mb = VectorMask.fromArray(SPECIES_F, bb, i);\n+            r[i] = ma.and(mb).trueCount();\n+        }\n+\n+        assertArrayEqualsFloat(r, ba, bb);\n+    }\n+\n@@ -83,1 +118,1 @@\n-    public static void test() {\n+    public static void testInt() {\n@@ -85,3 +120,3 @@\n-        for (int i = 0; i < LENGTH; i += SPECIES.length()) {\n-            VectorMask<Double> ma = VectorMask.fromArray(SPECIES, ba, i);\n-            VectorMask<Double> mb = VectorMask.fromArray(SPECIES, bb, i);\n+        for (int i = 0; i < LENGTH; i += SPECIES_I.length()) {\n+            VectorMask<Integer> ma = VectorMask.fromArray(SPECIES_I, ba, i);\n+            VectorMask<Integer> mb = VectorMask.fromArray(SPECIES_I, bb, i);\n@@ -91,1 +126,1 @@\n-        assertArrayEquals(r, ba, bb);\n+        assertArrayEqualsInteger(r, ba, bb);\n","filename":"test\/hotspot\/jtreg\/compiler\/vectorapi\/TestVectorMaskTrueCount.java","additions":47,"deletions":12,"binary":false,"changes":59,"status":"modified"}]}