{"files":[{"patch":"@@ -1456,9 +1456,0 @@\n-                    String outputStringForChar = m_charInfo.getOutputStringForChar(ch);\n-                    if (null != outputStringForChar)\n-                    {\n-                        writer.write(outputStringForChar);\n-                    }\n-                    else if (escapingNotNeeded(ch))\n-                    {\n-                        writer.write(ch); \/\/ no escaping in this case\n-                    }\n@@ -1467,3 +1458,15 @@\n-                        writer.write(\"&#\");\n-                        writer.write(Integer.toString(ch));\n-                        writer.write(';');\n+                        String outputStringForChar = m_charInfo.getOutputStringForChar(ch);\n+                        if (null != outputStringForChar)\n+                        {\n+                            writer.write(outputStringForChar);\n+                        }\n+                        else if (escapingNotNeeded(ch))\n+                        {\n+                            writer.write(ch); \/\/ no escaping in this case\n+                        }\n+                        else\n+                        {\n+                            writer.write(\"&#\");\n+                            writer.write(Integer.toString(ch));\n+                            writer.write(';');\n+                        }\n","filename":"src\/java.xml\/share\/classes\/com\/sun\/org\/apache\/xml\/internal\/serializer\/ToHTMLStream.java","additions":15,"deletions":12,"binary":false,"changes":27,"status":"modified"},{"patch":"@@ -0,0 +1,159 @@\n+\/*\n+ * Copyright (c) 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.FileOutputStream;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.io.OutputStreamWriter;\n+\n+import javax.xml.parsers.SAXParser;\n+import javax.xml.parsers.SAXParserFactory;\n+import javax.xml.transform.Result;\n+import javax.xml.transform.Source;\n+import javax.xml.transform.Transformer;\n+import javax.xml.transform.TransformerFactory;\n+import javax.xml.transform.stream.StreamResult;\n+import javax.xml.transform.stream.StreamSource;\n+\n+import org.xml.sax.Attributes;\n+import org.xml.sax.SAXException;\n+import org.xml.sax.helpers.DefaultHandler;\n+\n+\/*\n+ * @test\n+ * @bug 8268457\n+ * @summary XML Transformer outputs Unicode supplementary character incorrectly to HTML\n+ *\/\n+public class SurrogateTest {\n+\n+    final static String TEST_SRC = System.getProperty(\"test.src\", \".\");\n+    static File baseDir = new File(TEST_SRC + File.separator + \"testdata\");\n+\n+    public static void main(String[] args) throws Exception {\n+        case01();\n+        case02();\n+    }\n+\n+    private static void case01() throws Exception {\n+        File out = new File(\"case01out.html\");\n+        File expected = new File(baseDir, \"case01ok.html\");\n+        FileInputStream tFis = null;\n+        FileInputStream fis = null;\n+        FileOutputStream fos = null;\n+\n+        try {\n+            tFis = new FileInputStream(new File(baseDir, \"case01.xslt\"));\n+            Source tSrc = new StreamSource(tFis);\n+\n+            TransformerFactory tf = TransformerFactory.newInstance();\n+            Transformer t = tf.newTransformer(tSrc);\n+            t.setOutputProperty(\"method\", \"html\");\n+\n+            fis = new FileInputStream(new File(baseDir, \"case01.xml\"));\n+            fos = new FileOutputStream(out);\n+\n+            Source src = new StreamSource(fis);\n+            Result res = new StreamResult(fos);\n+\n+            t.transform(src, res);\n+\n+        } finally {\n+            try {\n+                if (tFis != null) {\n+                    tFis.close();\n+                }\n+            } finally {\n+                try {\n+                    if (fis != null) {\n+                        fis.close();\n+                    }\n+                } finally {\n+                    if (fos != null) {\n+                        fos.flush();\n+                        fos.close();\n+                    }\n+                }\n+            }\n+        }\n+        verify(out, expected);\n+    }\n+\n+    private static void case02() throws Exception {\n+        File xmlFile = new File(baseDir, \"case02.xml\");\n+        SAXParserFactory spf = SAXParserFactory.newInstance();\n+        spf.setNamespaceAware(true);\n+        SAXParser sp = spf.newSAXParser();\n+\n+        TestHandler th = new TestHandler();\n+        sp.parse(xmlFile, th);\n+\n+        File out = new File(\"case02out.txt\");\n+        FileOutputStream fos = null;\n+        try {\n+            fos = new FileOutputStream(out);\n+            OutputStreamWriter osw = new OutputStreamWriter(fos, \"UTF-8\");\n+            osw.write(th.sb.toString());\n+            osw.flush();\n+        } finally {\n+            if (fos != null) {\n+                fos.close();\n+            }\n+        }\n+        verify(out, new File(baseDir, \"case02ok.txt\"));\n+    }\n+\n+    private static class TestHandler extends DefaultHandler {\n+        private StringBuilder sb = new StringBuilder();\n+\n+        @Override\n+        public void startElement(String uri, String localName, String qName, Attributes attributes) throws SAXException {\n+            sb.append( localName + \"@attr:\" + attributes.getValue(\"attr\") + '\\n');\n+        }\n+    }\n+\n+    \/*\n+     * Compare output of test run to expected output.\n+     * Throw an Error if they don't match.\n+     *\/\n+    public static void verify(File outputFile, File expectedOutputFile) throws IOException {\n+        BufferedReader thisRun =\n+            new BufferedReader(new FileReader(outputFile));\n+        BufferedReader expected =\n+            new BufferedReader(new FileReader(expectedOutputFile));\n+\n+        for (int lineNum = 1; true; lineNum++) {\n+            String line1 = thisRun.readLine();\n+            String line2 = expected.readLine();\n+            if (line1 == null && line2 == null) {\n+                return;         \/\/ EOF with all lines matching\n+            }\n+            if (line1 == null || !line1.trim().equals(line2.trim())) {\n+                throw new Error(outputFile + \":\" + lineNum +\n+                                \": output doesn't match\");\n+            }\n+        }\n+    }\n+}\n","filename":"test\/jdk\/javax\/xml\/jaxp\/transform\/8268457\/SurrogateTest.java","additions":159,"deletions":0,"binary":false,"changes":159,"status":"added"},{"patch":"@@ -0,0 +1,4 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<root>\n+    <tag1>𠮟<\/tag1>\n+<\/root>\n\\ No newline at end of file\n","filename":"test\/jdk\/javax\/xml\/jaxp\/transform\/8268457\/testdata\/case01.xml","additions":4,"deletions":0,"binary":false,"changes":4,"status":"added"},{"patch":"@@ -0,0 +1,26 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\r\n+<xsl:stylesheet xmlns:xsl=\"http:\/\/www.w3.org\/1999\/XSL\/Transform\" version=\"1.0\">\r\n+  <xsl:output doctype-public=\"-\/\/W3C\/\/DTD HTML 4.01 Transitional\/\/EN\"\r\n+   doctype-system=\"http:\/\/www.w3.org\/TR\/html4\/loose.dtd\"\r\n+   encoding=\"UTF-8\" indent=\"yes\" method=\"html\" omit-xml-declaration=\"yes\"\/>\r\n+  <xsl:template match=\"\/\">\r\n+    <html>\r\n+      <head>\r\n+        <META http-equiv=\"Content-Type\" content=\"text\/html; charset=UTF-8\"\/>\r\n+      <\/head>\r\n+      <body>\r\n+        <xsl:for-each select=\"root\">\r\n+          <form>\r\n+            <xsl:for-each select=\"tag1\">\r\n+              <input id=\"tag1\">\r\n+                <xsl:attribute name=\"value\">\r\n+                  <xsl:value-of select=\".\"\/>\r\n+                <\/xsl:attribute>\r\n+              <\/input>\r\n+            <\/xsl:for-each>\r\n+          <\/form>\r\n+        <\/xsl:for-each>\r\n+      <\/body>\r\n+    <\/html>\r\n+  <\/xsl:template>\r\n+<\/xsl:stylesheet>\n\\ No newline at end of file\n","filename":"test\/jdk\/javax\/xml\/jaxp\/transform\/8268457\/testdata\/case01.xslt","additions":26,"deletions":0,"binary":false,"changes":26,"status":"added"},{"patch":"@@ -0,0 +1,12 @@\n+<!DOCTYPE html PUBLIC \"-\/\/W3C\/\/DTD HTML 4.01 Transitional\/\/EN\" \"http:\/\/www.w3.org\/TR\/html4\/loose.dtd\">\r\n+<html>\r\n+    <head>\r\n+        <META http-equiv=\"Content-Type\" content=\"text\/html; charset=UTF-8\">\r\n+        <META http-equiv=\"Content-Type\" content=\"text\/html; charset=UTF-8\">\r\n+    <\/head>\r\n+    <body>\r\n+        <form>\r\n+            <input id=\"tag1\" value=\"𠮟\">\r\n+        <\/form>\r\n+    <\/body>\r\n+<\/html>\r\n","filename":"test\/jdk\/javax\/xml\/jaxp\/transform\/8268457\/testdata\/case01ok.html","additions":12,"deletions":0,"binary":false,"changes":12,"status":"added"},{"patch":"@@ -0,0 +1,6 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<root>\n+    <tag1 attr=\"𠮟\"\/>\n+    <tag2 attr=\"𠀋\"\/>\n+    <tag3 attr=\"𣱿\"\/>\n+<\/root>\n\\ No newline at end of file\n","filename":"test\/jdk\/javax\/xml\/jaxp\/transform\/8268457\/testdata\/case02.xml","additions":6,"deletions":0,"binary":false,"changes":6,"status":"added"},{"patch":"@@ -0,0 +1,4 @@\n+root@attr:null\n+tag1@attr:𠮟\n+tag2@attr:𠀋\n+tag3@attr:𣱿\n","filename":"test\/jdk\/javax\/xml\/jaxp\/transform\/8268457\/testdata\/case02ok.txt","additions":4,"deletions":0,"binary":false,"changes":4,"status":"added"}]}