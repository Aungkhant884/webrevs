{"files":[{"patch":"@@ -127,2 +127,5 @@\n-  if ((size_t)ret >= sizeof(buf)) {\n-    size_t newbuf_len = prefix_len + ret + 1;\n+  size_t newbuf_len = (size_t)ret + prefix_len + 1; \/\/ total bytes needed including prefix.\n+  if (newbuf_len <= sizeof(buf)) {\n+    log(level, buf);\n+  } else {\n+    \/\/ Buffer too small, allocate a large enough buffer by using of malloc\/free to avoid circularity.\n@@ -130,4 +133,18 @@\n-    if (newbuf == nullptr) {\n-      tty->print_cr(\"Out of memory at logging, allocate \" SIZE_FORMAT \" bytes\", newbuf_len);\n-      va_end(saved_args);\n-      return;\n+    if (newbuf != nullptr) {\n+      prefix_len = _write_prefix(newbuf, newbuf_len);\n+      ret = os::vsnprintf(newbuf + prefix_len, newbuf_len - prefix_len, fmt, saved_args);\n+      assert(ret >= 0, \"Log message buffer issue\");\n+      log(level, newbuf);\n+      ::free(newbuf);\n+    } else {\n+      \/\/ native OOM, use buf to output the least message, first we fill buffer full\n+      \/\/ then put trunc_msg at the end of buf\n+      const char* trunc_msg = \"..(truncated), native OOM\";\n+      const size_t ltr = strlen(trunc_msg);\n+      prefix_len = _write_prefix(buf, sizeof(buf));\n+      if (prefix_len < sizeof(buf)) {\n+        ret = os::vsnprintf(buf + prefix_len, sizeof(buf) - prefix_len, fmt, args);\n+        assert(ret >= 0, \"Log message buffer issue\");\n+      }\n+      os::snprintf(buf + sizeof(buf) - ltr - 1, ltr, \"%s\", trunc_msg);\n+      log(level, buf);\n@@ -135,7 +152,0 @@\n-    prefix_len = _write_prefix(newbuf, newbuf_len);\n-    ret = os::vsnprintf(newbuf + prefix_len, newbuf_len - prefix_len, fmt, saved_args);\n-    assert(ret >= 0, \"Log message buffer issue\");\n-    log(level, newbuf);\n-    ::free(newbuf);\n-  } else {\n-    log(level, buf);\n","filename":"src\/hotspot\/share\/logging\/logTagSet.cpp","additions":23,"deletions":13,"binary":false,"changes":36,"status":"modified"}]}