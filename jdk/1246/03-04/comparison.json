{"files":[{"patch":"@@ -124,1 +124,1 @@\n-    ret = os::vsnprintf(buf, sizeof(buf), fmt, args);\n+    ret = os::vsnprintf(nullptr, 0, fmt, args);\n@@ -126,0 +126,1 @@\n+\n@@ -127,0 +128,9 @@\n+  if (ret < 0) {\n+    \/\/ Error, just log contents in buf.\n+    log(level, buf);\n+    log(level, \"Log message buffer issue\");\n+    va_end(saved_args);\n+    return;\n+  }\n+\n+\n@@ -131,2 +141,2 @@\n-    \/\/ Buffer too small, allocate a large enough buffer by using of malloc\/free to avoid circularity.\n-    char* newbuf = (char*)::calloc(newbuf_len, sizeof(char));\n+    \/\/ Buffer too small, allocate a large enough buffer using malloc\/free to avoid circularity.\n+    char* newbuf = (char*)::malloc(newbuf_len * sizeof(char));\n@@ -136,1 +146,2 @@\n-      assert(ret >= 0, \"Log message buffer issue\");\n+      assert(ret >= 0, \"Log message newbuf issue\");\n+      \/\/ log the contents in newbuf even with error happened.\n@@ -138,0 +149,3 @@\n+      if (ret < 0) {\n+        log(level, \"Log message newbuf issue\");\n+      }\n@@ -140,2 +154,2 @@\n-      \/\/ native OOM, use buf to output the least message, first we fill buffer full\n-      \/\/ then put trunc_msg at the end of buf\n+      \/\/ Native OOM, use buf to output the least message. At this moment buf is full of either\n+      \/\/ truncated prefix or truncated prefix + string. Put trunc_msg at the end of buf.\n@@ -143,7 +157,4 @@\n-      const size_t ltr = strlen(trunc_msg);\n-      prefix_len = _write_prefix(buf, sizeof(buf));\n-      if (prefix_len < sizeof(buf)) {\n-        ret = os::vsnprintf(buf + prefix_len, sizeof(buf) - prefix_len, fmt, args);\n-        assert(ret >= 0, \"Log message buffer issue\");\n-      }\n-      os::snprintf(buf + sizeof(buf) - ltr - 1, ltr, \"%s\", trunc_msg);\n+      const size_t ltr = strlen(trunc_msg) + 1;\n+      ret = os::snprintf(buf + sizeof(buf) - ltr, ltr, \"%s\", trunc_msg);\n+      assert(ret >= 0, \"Log message buffer issue\");\n+      \/\/ log the contents in newbuf even with error happened.\n@@ -151,0 +162,3 @@\n+      if (ret < 0) {\n+        log(level, \"Log message buffer issue under OOM\");\n+      }\n","filename":"src\/hotspot\/share\/logging\/logTagSet.cpp","additions":27,"deletions":13,"binary":false,"changes":40,"status":"modified"}]}