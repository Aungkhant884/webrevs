{"files":[{"patch":"@@ -2,2 +2,2 @@\n- * Copyright (c) 2002, 2020, Oracle and\/or its affiliates. All rights reserved.\n- * Copyright (c) 2019, 2020, NTT DATA.\n+ * Copyright (c) 2002, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2019, 2021, NTT DATA.\n@@ -191,1 +191,1 @@\n-     uintptr_t base;\n+     uintptr_t base, memsz;\n@@ -197,1 +197,1 @@\n-     base = get_lib_base(ph, i);\n+     get_lib_addr_range(ph, i, &base, &memsz);\n@@ -202,1 +202,1 @@\n-     loadObject = env->CallObjectMethod(this_obj, createLoadObject_ID, str, (jlong)0, (jlong)base);\n+     loadObject = env->CallObjectMethod(this_obj, createLoadObject_ID, str, (jlong)memsz, (jlong)base);\n","filename":"src\/jdk.hotspot.agent\/linux\/native\/libsaproc\/LinuxDebuggerLocal.cpp","additions":5,"deletions":5,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2003, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2003, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -100,0 +100,3 @@\n+\/\/ get address range of lib\n+void get_lib_addr_range(struct ps_prochandle* ph, int index, uintptr_t* base, uintptr_t* memsz);\n+\n","filename":"src\/jdk.hotspot.agent\/linux\/native\/libsaproc\/libproc.h","additions":4,"deletions":1,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2003, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2003, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -162,1 +162,1 @@\n-static bool fill_instr_info(lib_info* lib) {\n+static bool fill_addr_info(lib_info* lib) {\n@@ -178,0 +178,1 @@\n+  lib->end = (uintptr_t)-1L;\n@@ -181,4 +182,4 @@\n-    if ((ph->p_type == PT_LOAD) && (ph->p_flags & PF_X)) {\n-      print_debug(\"[%d] vaddr = 0x%lx, memsz = 0x%lx, filesz = 0x%lx\\n\", cnt, ph->p_vaddr, ph->p_memsz, ph->p_filesz);\n-      if ((lib->exec_start == -1L) || (lib->exec_start > ph->p_vaddr)) {\n-        lib->exec_start = ph->p_vaddr;\n+    if (ph->p_type == PT_LOAD) {\n+      align = ph->p_align;\n+      if ((lib->end == (uintptr_t)-1L) || (lib->end < (ph->p_vaddr + ph->p_memsz))) {\n+        lib->end = ph->p_vaddr + ph->p_memsz;\n@@ -186,2 +187,8 @@\n-      if ((lib->exec_end == (uintptr_t)-1L) || (lib->exec_end < (ph->p_vaddr + ph->p_memsz))) {\n-        lib->exec_end = ph->p_vaddr + ph->p_memsz;\n+      if (ph->p_flags & PF_X) {\n+        print_debug(\"[%d] vaddr = 0x%lx, memsz = 0x%lx, filesz = 0x%lx\\n\", cnt, ph->p_vaddr, ph->p_memsz, ph->p_filesz);\n+        if ((lib->exec_start == -1L) || (lib->exec_start > ph->p_vaddr)) {\n+          lib->exec_start = ph->p_vaddr;\n+        }\n+        if ((lib->exec_end == (uintptr_t)-1L) || (lib->exec_end < (ph->p_vaddr + ph->p_memsz))) {\n+          lib->exec_end = ph->p_vaddr + ph->p_memsz;\n+        }\n@@ -189,1 +196,0 @@\n-      align = ph->p_align;\n@@ -196,1 +202,1 @@\n-  if ((lib->exec_start == -1L) || (lib->exec_end == -1L)) {\n+  if ((lib->end == -1L) || (lib->exec_start == -1L) || (lib->exec_end == -1L)) {\n@@ -199,0 +205,1 @@\n+    lib->end = (lib->end + lib->base + align) & ~(align - 1);\n@@ -278,1 +285,1 @@\n-   if (fill_instr_info(newlib)) {\n+   if (fill_addr_info(newlib)) {\n@@ -434,0 +441,15 @@\n+\/\/ get address range of lib\n+void get_lib_addr_range(struct ps_prochandle* ph, int index, uintptr_t* base, uintptr_t* memsz) {\n+   int count = 0;\n+   lib_info* lib = ph->libs;\n+   while (lib) {\n+      if (count == index) {\n+         *base = lib->base;\n+         *memsz = lib->end - lib->base;\n+         return;\n+      }\n+      count++;\n+      lib = lib->next;\n+   }\n+}\n+\n","filename":"src\/jdk.hotspot.agent\/linux\/native\/libsaproc\/libproc_impl.c","additions":33,"deletions":11,"binary":false,"changes":44,"status":"modified"},{"patch":"@@ -49,0 +49,1 @@\n+  uintptr_t        end;\n","filename":"src\/jdk.hotspot.agent\/linux\/native\/libsaproc\/libproc_impl.h","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2002, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2002, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -972,1 +972,1 @@\n-     uintptr_t base;\n+     uintptr_t base, memsz;\n@@ -978,1 +978,1 @@\n-     base = get_lib_base(ph, i);\n+     get_lib_addr_range(ph, i, &base, &memsz);\n@@ -983,1 +983,1 @@\n-                                            nameString, (jlong)0, (jlong)base);\n+                                            nameString, (jlong)memsz, (jlong)base);\n","filename":"src\/jdk.hotspot.agent\/macosx\/native\/libsaproc\/MacosxDebuggerLocal.m","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2003, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2003, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -135,0 +135,3 @@\n+\/\/ get address range of lib\n+void get_lib_addr_range(struct ps_prochandle* ph, int index, uintptr_t* base, uintptr_t* memsz);\n+\n","filename":"src\/jdk.hotspot.agent\/macosx\/native\/libsaproc\/libproc.h","additions":4,"deletions":1,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2003, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2003, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -489,0 +489,15 @@\n+\/\/ get address range of lib\n+void get_lib_addr_range(struct ps_prochandle* ph, int index, uintptr_t* base, uintptr_t* memsz) {\n+  int count = 0;\n+  lib_info* lib = ph->libs;\n+  while (lib) {\n+    if (count == index) {\n+      *base = lib->base;\n+      *memsz = lib->memsz;\n+      return;\n+    }\n+    count++;\n+    lib = lib->next;\n+  }\n+}\n+\n","filename":"src\/jdk.hotspot.agent\/macosx\/native\/libsaproc\/libproc_impl.c","additions":16,"deletions":1,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2002, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2002, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -27,1 +27,0 @@\n-import java.io.File;\n@@ -88,1 +87,1 @@\n-    private LoadObject createLoadObject(String fileName, long textsize,\n+    private LoadObject createLoadObject(String fileName, long size,\n@@ -90,1 +89,0 @@\n-       File f = new File(fileName);\n@@ -92,1 +90,1 @@\n-       return new SharedObject(this, fileName, f.length(), baseAddr);\n+       return new SharedObject(this, fileName, size, baseAddr);\n","filename":"src\/jdk.hotspot.agent\/share\/classes\/sun\/jvm\/hotspot\/debugger\/bsd\/BsdDebuggerLocal.java","additions":3,"deletions":5,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2002, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2002, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -27,1 +27,0 @@\n-import java.io.File;\n@@ -94,1 +93,1 @@\n-    private LoadObject createLoadObject(String fileName, long textsize,\n+    private LoadObject createLoadObject(String fileName, long size,\n@@ -96,1 +95,0 @@\n-       File f = new File(fileName);\n@@ -98,1 +96,1 @@\n-       return new SharedObject(this, fileName, f.length(), baseAddr);\n+       return new SharedObject(this, fileName, size, baseAddr);\n","filename":"src\/jdk.hotspot.agent\/share\/classes\/sun\/jvm\/hotspot\/debugger\/linux\/LinuxDebuggerLocal.java","additions":3,"deletions":5,"binary":false,"changes":8,"status":"modified"}]}