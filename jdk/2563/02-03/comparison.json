{"files":[{"patch":"@@ -162,0 +162,8 @@\n+static inline uintptr_t align_down(uintptr_t ptr, size_t size) {\n+  return (ptr & ~(size - 1));\n+}\n+\n+static inline uintptr_t align_up(uintptr_t ptr, size_t size) {\n+  return ((ptr + size - 1) & ~(size - 1));\n+}\n+\n@@ -168,1 +176,0 @@\n-  long align = sysconf(_SC_PAGE_SIZE);\n@@ -183,3 +190,4 @@\n-      align = ph->p_align;\n-      if ((lib->end == (uintptr_t)-1L) || (lib->end < (ph->p_vaddr + ph->p_memsz))) {\n-        lib->end = ph->p_vaddr + ph->p_memsz;\n+      uintptr_t aligned_start = align_down(lib->base + ph->p_vaddr, ph->p_align);\n+      uintptr_t aligned_end = align_up(aligned_start + ph->p_filesz, ph->p_align);\n+      if ((lib->end == (uintptr_t)-1L) || (lib->end < aligned_end)) {\n+        lib->end = aligned_end;\n@@ -187,0 +195,1 @@\n+      print_debug(\"%s [%d] 0x%lx-0x%lx: base = 0x%lx, vaddr = 0x%lx, memsz = 0x%lx, filesz = 0x%lx\\n\", lib->name, cnt, aligned_start, aligned_end, lib->base, ph->p_vaddr, ph->p_memsz, ph->p_filesz);\n@@ -188,3 +197,2 @@\n-        print_debug(\"[%d] vaddr = 0x%lx, memsz = 0x%lx, filesz = 0x%lx\\n\", cnt, ph->p_vaddr, ph->p_memsz, ph->p_filesz);\n-        if ((lib->exec_start == -1L) || (lib->exec_start > ph->p_vaddr)) {\n-          lib->exec_start = ph->p_vaddr;\n+        if ((lib->exec_start == -1L) || (lib->exec_start > aligned_start)) {\n+          lib->exec_start = aligned_start;\n@@ -192,2 +200,2 @@\n-        if ((lib->exec_end == (uintptr_t)-1L) || (lib->exec_end < (ph->p_vaddr + ph->p_memsz))) {\n-          lib->exec_end = ph->p_vaddr + ph->p_memsz;\n+        if ((lib->exec_end == (uintptr_t)-1L) || (lib->exec_end < aligned_end)) {\n+          lib->exec_end = aligned_end;\n@@ -202,9 +210,1 @@\n-  if ((lib->end == -1L) || (lib->exec_start == -1L) || (lib->exec_end == -1L)) {\n-    return false;\n-  } else {\n-    lib->end = (lib->end + lib->base + align) & ~(align - 1);\n-    lib->exec_start = (lib->exec_start + lib->base) & ~(align - 1);\n-    lib->exec_end = (lib->exec_end + lib->base + align) & ~(align - 1);\n-    return true;\n-  }\n-\n+  return (lib->end != -1L) && (lib->exec_start != -1L) && (lib->exec_end != -1L);\n","filename":"src\/jdk.hotspot.agent\/linux\/native\/libsaproc\/libproc_impl.c","additions":18,"deletions":18,"binary":false,"changes":36,"status":"modified"}]}