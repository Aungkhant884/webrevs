{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2017, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2017, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -1109,22 +1109,17 @@\n-  \/\/ Only grab the Threads_lock if we don't already own it and if we\n-  \/\/ are not reporting an error.\n-  \/\/ Note: Not grabbing the Threads_lock during error reporting is\n-  \/\/ dangerous because the data structures we want to print can be\n-  \/\/ freed concurrently. However, grabbing the Threads_lock during\n-  \/\/ error reporting can be equally dangerous since this thread might\n-  \/\/ block during error reporting or a nested error could leave the\n-  \/\/ Threads_lock held. The classic no win scenario.\n-  \/\/\n-  MutexLocker ml((Threads_lock->owned_by_self() || VMError::is_error_reported()) ? NULL : Threads_lock);\n-\n-  st->print_cr(\"Threads class SMR info:\");\n-  st->print_cr(\"_java_thread_list=\" INTPTR_FORMAT \", length=%u, \"\n-               \"elements={\", p2i(_java_thread_list),\n-               _java_thread_list->length());\n-  print_info_elements_on(st, _java_thread_list);\n-  st->print_cr(\"}\");\n-  if (_to_delete_list != NULL) {\n-    st->print_cr(\"_to_delete_list=\" INTPTR_FORMAT \", length=%u, \"\n-                 \"elements={\", p2i(_to_delete_list),\n-                 _to_delete_list->length());\n-    print_info_elements_on(st, _to_delete_list);\n+  bool needs_unlock = false;\n+  if (Threads_lock->try_lock()) {\n+    \/\/ We were able to grab the Threads_lock which makes things safe for\n+    \/\/ this call, but if we are error reporting, then a nested error\n+    \/\/ could happen with the Threads_lock held.\n+    needs_unlock = true;\n+  }\n+\n+  ThreadsList* saved_threads_list = NULL;\n+  {\n+    ThreadsListHandle tlh;  \/\/ make the current ThreadsList safe for reporting\n+    saved_threads_list = tlh.list();  \/\/ save for later comparison\n+\n+    st->print_cr(\"Threads class SMR info:\");\n+    st->print_cr(\"_java_thread_list=\" INTPTR_FORMAT \", length=%u, elements={\",\n+                 p2i(saved_threads_list), saved_threads_list->length());\n+    print_info_elements_on(st, saved_threads_list);\n@@ -1132,5 +1127,8 @@\n-    for (ThreadsList *t_list = _to_delete_list->next_list();\n-         t_list != NULL; t_list = t_list->next_list()) {\n-      st->print(\"next-> \" INTPTR_FORMAT \", length=%u, \"\n-                \"elements={\", p2i(t_list), t_list->length());\n-      print_info_elements_on(st, t_list);\n+  }\n+\n+  if (_to_delete_list != NULL) {\n+    if (Threads_lock->owned_by_self()) {\n+      \/\/ Only safe if we have the Threads_lock.\n+      st->print_cr(\"_to_delete_list=\" INTPTR_FORMAT \", length=%u, elements={\",\n+                   p2i(_to_delete_list), _to_delete_list->length());\n+      print_info_elements_on(st, _to_delete_list);\n@@ -1138,0 +1136,10 @@\n+      for (ThreadsList *t_list = _to_delete_list->next_list();\n+           t_list != NULL; t_list = t_list->next_list()) {\n+        st->print(\"next-> \" INTPTR_FORMAT \", length=%u, elements={\",\n+                  p2i(t_list), t_list->length());\n+        print_info_elements_on(st, t_list);\n+        st->print_cr(\"}\");\n+      }\n+    } else {\n+      st->print_cr(\"_to_delete_list=\" INTPTR_FORMAT, p2i(_to_delete_list));\n+      st->print_cr(\"Skipping _to_delete_list fields and contents for safety.\");\n@@ -1140,19 +1148,31 @@\n-  if (!EnableThreadSMRStatistics) {\n-    return;\n-  }\n-  st->print_cr(\"_java_thread_list_alloc_cnt=\" UINT64_FORMAT \", \"\n-               \"_java_thread_list_free_cnt=\" UINT64_FORMAT \", \"\n-               \"_java_thread_list_max=%u, \"\n-               \"_nested_thread_list_max=%u\",\n-               _java_thread_list_alloc_cnt,\n-               _java_thread_list_free_cnt,\n-               _java_thread_list_max,\n-               _nested_thread_list_max);\n-  if (_tlh_cnt > 0) {\n-    st->print_cr(\"_tlh_cnt=%u\"\n-                 \", _tlh_times=%u\"\n-                 \", avg_tlh_time=%0.2f\"\n-                 \", _tlh_time_max=%u\",\n-                 _tlh_cnt, _tlh_times,\n-                 ((double) _tlh_times \/ _tlh_cnt),\n-                 _tlh_time_max);\n+  if (EnableThreadSMRStatistics) {\n+    st->print_cr(\"_java_thread_list_alloc_cnt=\" UINT64_FORMAT \", \"\n+                 \"_java_thread_list_free_cnt=\" UINT64_FORMAT \", \"\n+                 \"_java_thread_list_max=%u, \"\n+                 \"_nested_thread_list_max=%u\",\n+                 _java_thread_list_alloc_cnt,\n+                 _java_thread_list_free_cnt,\n+                 _java_thread_list_max,\n+                 _nested_thread_list_max);\n+    if (_tlh_cnt > 0) {\n+      st->print_cr(\"_tlh_cnt=%u\"\n+                   \", _tlh_times=%u\"\n+                   \", avg_tlh_time=%0.2f\"\n+                   \", _tlh_time_max=%u\",\n+                   _tlh_cnt, _tlh_times,\n+                   ((double) _tlh_times \/ _tlh_cnt),\n+                   _tlh_time_max);\n+    }\n+    if (_deleted_thread_cnt > 0) {\n+      st->print_cr(\"_deleted_thread_cnt=%u\"\n+                   \", _deleted_thread_times=%u\"\n+                   \", avg_deleted_thread_time=%0.2f\"\n+                   \", _deleted_thread_time_max=%u\",\n+                   _deleted_thread_cnt, _deleted_thread_times,\n+                   ((double) _deleted_thread_times \/ _deleted_thread_cnt),\n+                   _deleted_thread_time_max);\n+    }\n+    st->print_cr(\"_delete_lock_wait_cnt=%u, _delete_lock_wait_max=%u\",\n+                 _delete_lock_wait_cnt, _delete_lock_wait_max);\n+    st->print_cr(\"_to_delete_list_cnt=%u, _to_delete_list_max=%u\",\n+                 _to_delete_list_cnt, _to_delete_list_max);\n@@ -1160,8 +1180,9 @@\n-  if (_deleted_thread_cnt > 0) {\n-    st->print_cr(\"_deleted_thread_cnt=%u\"\n-                 \", _deleted_thread_times=%u\"\n-                 \", avg_deleted_thread_time=%0.2f\"\n-                 \", _deleted_thread_time_max=%u\",\n-                 _deleted_thread_cnt, _deleted_thread_times,\n-                 ((double) _deleted_thread_times \/ _deleted_thread_cnt),\n-                 _deleted_thread_time_max);\n+  if (needs_unlock) {\n+    Threads_lock->unlock();\n+  } else {\n+    if (_java_thread_list != saved_threads_list) {\n+      st->print_cr(\"The _java_thread_list has changed from \" INTPTR_FORMAT\n+                   \" to \" INTPTR_FORMAT\n+                   \" so some of the above information may be stale.\",\n+                   p2i(saved_threads_list), p2i(_java_thread_list));\n+    }\n@@ -1169,4 +1190,0 @@\n-  st->print_cr(\"_delete_lock_wait_cnt=%u, _delete_lock_wait_max=%u\",\n-               _delete_lock_wait_cnt, _delete_lock_wait_max);\n-  st->print_cr(\"_to_delete_list_cnt=%u, _to_delete_list_max=%u\",\n-               _to_delete_list_cnt, _to_delete_list_max);\n","filename":"src\/hotspot\/share\/runtime\/threadSMR.cpp","additions":76,"deletions":59,"binary":false,"changes":135,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2017, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2017, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -96,2 +96,4 @@\n-        \/\/ We should have one nested ThreadsListHandle:\n-        Pattern.compile(\".*, _nested_thread_list_max=1\"),\n+        \/\/ We should have had a double nested ThreadsListHandle since\n+        \/\/ ThreadsSMRSupport::print_info_on() now protects itself with\n+        \/\/ a ThreadsListHandle in addition to what the test creates:\n+        Pattern.compile(\".*, _nested_thread_list_max=2\"),\n","filename":"test\/hotspot\/jtreg\/runtime\/ErrorHandling\/NestedThreadsListHandleInErrorHandlingTest.java","additions":5,"deletions":3,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2017, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2017, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -96,0 +96,4 @@\n+        \/\/ We should have had a single nested ThreadsListHandle since\n+        \/\/ ThreadsSMRSupport::print_info_on() now protects itself with\n+        \/\/ a ThreadsListHandle:\n+        Pattern.compile(\".*, _nested_thread_list_max=1\"),\n","filename":"test\/hotspot\/jtreg\/runtime\/ErrorHandling\/ThreadsListHandleInErrorHandlingTest.java","additions":5,"deletions":1,"binary":false,"changes":6,"status":"modified"}]}