{"files":[{"patch":"@@ -119,0 +119,2 @@\n+\n+static bool _rehashed = false;\n@@ -532,0 +534,8 @@\n+bool StringTable::should_grow() {\n+  return get_load_factor() > PREF_AVG_LIST_LEN && !_local_table->is_max_size_reached();\n+}\n+\n+uint StringTable::rehash_table_expected_workers() {\n+  return (!_needs_rehashing || should_grow() || _rehashed || !_local_table->is_safepoint_safe()) ? 0 : 1;\n+}\n+\n@@ -533,1 +543,0 @@\n-  static bool rehashed = false;\n@@ -537,2 +546,1 @@\n-  if (get_load_factor() > PREF_AVG_LIST_LEN &&\n-      !_local_table->is_max_size_reached()) {\n+  if (should_grow()) {\n@@ -545,1 +553,1 @@\n-  if (rehashed) {\n+  if (_rehashed) {\n@@ -555,1 +563,1 @@\n-      rehashed = true;\n+      _rehashed = true;\n","filename":"src\/hotspot\/share\/classfile\/stringTable.cpp","additions":13,"deletions":5,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -99,0 +99,5 @@\n+private:\n+  static bool should_grow();\n+\n+public:\n+  static uint rehash_table_expected_workers();\n","filename":"src\/hotspot\/share\/classfile\/stringTable.hpp","additions":5,"deletions":0,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -106,0 +106,1 @@\n+static bool _rehashed = false;\n@@ -808,0 +809,8 @@\n+bool SymbolTable::should_grow() {\n+  return get_load_factor() > PREF_AVG_LIST_LEN && !_local_table->is_max_size_reached();\n+}\n+\n+uint SymbolTable::rehash_table_expected_workers() {\n+  return (!_needs_rehashing || should_grow() || _rehashed || !_local_table->is_safepoint_safe()) ? 0 : 1;\n+}\n+\n@@ -809,1 +818,0 @@\n-  static bool rehashed = false;\n@@ -813,2 +821,1 @@\n-  if (get_load_factor() > PREF_AVG_LIST_LEN &&\n-      !_local_table->is_max_size_reached()) {\n+  if (should_grow()) {\n@@ -822,1 +829,1 @@\n-  if (rehashed) {\n+  if (_rehashed) {\n@@ -832,1 +839,1 @@\n-    rehashed = true;\n+    _rehashed = true;\n","filename":"src\/hotspot\/share\/classfile\/symbolTable.cpp","additions":12,"deletions":5,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -147,0 +147,5 @@\n+private:\n+  static bool should_grow();\n+\n+public:\n+  static uint rehash_table_expected_workers();\n","filename":"src\/hotspot\/share\/classfile\/symbolTable.hpp","additions":5,"deletions":0,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -164,0 +164,4 @@\n+uint InlineCacheBuffer::update_inline_caches_expected_workers() {\n+  return (buffer()->number_of_stubs() > 0 || pending_icholder_count() > 0) ? 1 : 0;\n+}\n+\n","filename":"src\/hotspot\/share\/code\/icBuffer.cpp","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -170,0 +170,1 @@\n+  static uint update_inline_caches_expected_workers();\n","filename":"src\/hotspot\/share\/code\/icBuffer.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -550,0 +550,14 @@\n+  uint expected_num_workers() const {\n+    uint workers = 0;\n+\n+    workers += SymbolTable::rehash_table_expected_workers();\n+    workers += StringTable::rehash_table_expected_workers();\n+    workers += InlineCacheBuffer::update_inline_caches_expected_workers();\n+\n+    if (_do_lazy_roots) {\n+      workers++;\n+    }\n+\n+    return MAX2<uint>(1, workers);\n+  }\n+\n@@ -604,1 +618,2 @@\n-  if (cleanup_workers != nullptr) {\n+  const uint expected_num_workers = cleanup.expected_num_workers();\n+  if (cleanup_workers != nullptr && expected_num_workers > 1) {\n@@ -606,1 +621,1 @@\n-    const uint num_workers = MIN2<uint>(SAFEPOINT_CLEANUP_NUM_TASKS, cleanup_workers->active_workers());\n+    const uint num_workers = MIN2(expected_num_workers, cleanup_workers->active_workers());\n","filename":"src\/hotspot\/share\/runtime\/safepoint.cpp","additions":17,"deletions":2,"binary":false,"changes":19,"status":"modified"}]}