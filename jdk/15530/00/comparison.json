{"files":[{"patch":"@@ -35,0 +35,1 @@\n+import java.util.function.IntPredicate;\n@@ -81,1 +82,1 @@\n-    private static final BitSet DONT_NEED_ENCODING;\n+    private static final IntPredicate DONT_NEED_ENCODING;\n@@ -123,6 +124,5 @@\n-        DONT_NEED_ENCODING = new BitSet(128);\n-\n-        DONT_NEED_ENCODING.set('a', 'z' + 1);\n-        DONT_NEED_ENCODING.set('A', 'Z' + 1);\n-        DONT_NEED_ENCODING.set('0', '9' + 1);\n-        DONT_NEED_ENCODING.set(' '); \/* encoding a space to a + is done\n+        var bitSet = new BitSet(128);\n+        bitSet.set('a', 'z' + 1);\n+        bitSet.set('A', 'Z' + 1);\n+        bitSet.set('0', '9' + 1);\n+        bitSet.set(' '); \/* encoding a space to a + is done\n@@ -130,4 +130,6 @@\n-        DONT_NEED_ENCODING.set('-');\n-        DONT_NEED_ENCODING.set('_');\n-        DONT_NEED_ENCODING.set('.');\n-        DONT_NEED_ENCODING.set('*');\n+        bitSet.set('-');\n+        bitSet.set('_');\n+        bitSet.set('.');\n+        bitSet.set('*');\n+\n+        DONT_NEED_ENCODING = bitSet.toPredicate();\n@@ -229,1 +231,1 @@\n-            if (DONT_NEED_ENCODING.get(c)) {\n+            if (DONT_NEED_ENCODING.test(c)) {\n@@ -272,1 +274,1 @@\n-                } while (i < s.length() && !DONT_NEED_ENCODING.get((c = s.charAt(i))));\n+                } while (i < s.length() && !DONT_NEED_ENCODING.test((c = s.charAt(i))));\n","filename":"src\/java.base\/share\/classes\/java\/net\/URLEncoder.java","additions":15,"deletions":13,"binary":false,"changes":28,"status":"modified"},{"patch":"@@ -33,0 +33,1 @@\n+import java.util.function.IntPredicate;\n@@ -36,0 +37,1 @@\n+import jdk.internal.ValueBased;\n@@ -37,0 +39,1 @@\n+import jdk.internal.vm.annotation.Stable;\n@@ -1401,0 +1404,44 @@\n+    \/**\n+     * {@return a new {@link IntPredicate} representing the {@link BitSet#get(int)} method applied\n+     * on an immutable snapshot of the current state of this BitSet}.\n+     * <p>\n+     * If the returned predicate is invoked with a {@code bitIndex} that is negative, the predicate\n+     * will throw an IndexOutOfBoundsException just as the {@link BitSet#get(int)} method would.\n+     * <p>\n+     * Returned predicates are threadsafe and can be used without external synchronisation.  Furthermore,\n+     * they are eligible for constant-folding optimization by the VM.\n+     *\n+     * @implNote The method is free to return a {@link ValueBased} implementation.\n+     *\n+     * @since 22\n+     *\/\n+    public IntPredicate toPredicate() {\n+        return OfImmutable.of(this);\n+    }\n+\n+    @ValueBased\n+    private static final class OfImmutable implements IntPredicate {\n+\n+        @Stable\n+        private final long[] words;\n+\n+        private OfImmutable(BitSet original) {\n+            this.words = original.toLongArray();\n+        }\n+\n+        @Override\n+        public boolean test(int bitIndex) {\n+            if (bitIndex < 0)\n+                throw new IndexOutOfBoundsException(\"bitIndex < 0: \" + bitIndex);\n+\n+            int wordIndex = wordIndex(bitIndex);\n+            return (wordIndex < words.length)\n+                    && ((words[wordIndex] & (1L << bitIndex)) != 0);\n+        }\n+\n+        private static IntPredicate of(BitSet original) {\n+            return new OfImmutable(original);\n+        }\n+\n+    }\n+\n","filename":"src\/java.base\/share\/classes\/java\/util\/BitSet.java","additions":47,"deletions":0,"binary":false,"changes":47,"status":"modified"},{"patch":"@@ -0,0 +1,90 @@\n+\/*\n+ * Copyright (c) 2013, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/**\n+ * @test\n+ * @summary Basic tests of immutable BitSets\n+ * @run junit ImmutableBitSet\n+ *\/\n+\n+import org.junit.jupiter.api.Test;\n+\n+import java.util.BitSet;\n+import java.util.Random;\n+import java.util.function.IntPredicate;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+public class ImmutableBitSet {\n+\n+    @Test\n+    void empty() {\n+        BitSet bs = new BitSet();\n+        IntPredicate ibs = bs.toPredicate();\n+        test(bs, ibs);\n+    }\n+\n+    @Test\n+    void negativeIndex() {\n+        BitSet bs = new BitSet();\n+        IntPredicate ibs = bs.toPredicate();\n+        assertThrows(IndexOutOfBoundsException.class, () -> {\n+            ibs.test(-1);\n+        });\n+    }\n+\n+    @Test\n+    void basic() {\n+        BitSet bs = createReference(147);\n+        IntPredicate ibs = bs.toPredicate();\n+        test(bs, ibs);\n+    }\n+\n+    @Test\n+    void clearedAtTheTail() {\n+        for (int i = Long.BYTES - 1; i < Long.BYTES + 2; i++) {\n+            BitSet bs = createReference(i);\n+            for (int j = bs.length() - 1; j > Long.BYTES - 1; j++) {\n+                bs.clear(j);\n+            }\n+            IntPredicate ibs = bs.toPredicate();\n+            test(bs, ibs);\n+        }\n+    }\n+\n+    static void test(BitSet expected, IntPredicate actual) {\n+        for (int i = 0; i < expected.length() + 17; i++) {\n+            assertEquals(expected.get(i), actual.test(i), \"at index \" + i);\n+        }\n+    }\n+\n+    private static BitSet createReference(int length) {\n+        BitSet result = new BitSet();\n+        Random random = new Random(length);\n+        for (int i = 0; i < length; i++) {\n+            result.set(i, random.nextBoolean());\n+        }\n+        return result;\n+    }\n+\n+}\n\\ No newline at end of file\n","filename":"test\/jdk\/java\/util\/BitSet\/ImmutableBitSet.java","additions":90,"deletions":0,"binary":false,"changes":90,"status":"added"}]}