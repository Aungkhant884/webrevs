{"files":[{"patch":"@@ -2427,1 +2427,1 @@\n-    ThreadTotalCPUTimeClosure tttc(_perf_parallel_gc_threads_cpu_time);\n+    ThreadTotalCPUTimeClosure tttc(_perf_parallel_worker_threads_cpu_time);\n","filename":"src\/hotspot\/share\/gc\/g1\/g1CollectedHeap.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -461,2 +461,2 @@\n-        PerfDataManager::create_variable(NULL_NS, \"g1_conc_mark_thread_time\",\n-                                         PerfData::U_Ticks, CHECK);\n+        PerfDataManager::create_counter(SUN_THREADS, \"g1_conc_mark_thread_time\",\n+                                        PerfData::U_Ticks, CHECK);\n","filename":"src\/hotspot\/share\/gc\/g1\/g1ConcurrentMark.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -364,1 +364,1 @@\n-  PerfVariable* _g1_concurrent_mark_threads_cpu_time;\n+  PerfCounter* _g1_concurrent_mark_threads_cpu_time;\n","filename":"src\/hotspot\/share\/gc\/g1\/g1ConcurrentMark.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -119,2 +119,2 @@\n-        PerfDataManager::create_variable(NULL_NS, \"g1_conc_refine_thread_time\",\n-                                         PerfData::U_Ticks, CHECK_JNI_ERR);\n+        PerfDataManager::create_counter(SUN_THREADS, \"g1_conc_refine_thread_time\",\n+                                        PerfData::U_Ticks, CHECK_JNI_ERR);\n@@ -171,3 +171,1 @@\n-  assert(Thread::current() == _threads[0],\n-         \"Must be called from G1ConcurrentRefineThreadControl::_threads[0] to \"\n-         \"avoid races\");\n+  assert_current_thread_is_primary_refinement_thread();\n","filename":"src\/hotspot\/share\/gc\/g1\/g1ConcurrentRefine.cpp","additions":3,"deletions":5,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -51,1 +51,1 @@\n-  PerfVariable* _g1_concurrent_refine_threads_cpu_time;\n+  PerfCounter* _g1_concurrent_refine_threads_cpu_time;\n","filename":"src\/hotspot\/share\/gc\/g1\/g1ConcurrentRefine.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -82,4 +82,1 @@\n-\n-    if (UsePerfData && os::is_thread_cpu_time_supported() && is_primary()) {\n-      _cr->update_concurrent_refine_threads_cpu_time();\n-    }\n+    maybe_update_threads_cpu_time();\n@@ -144,0 +141,1 @@\n+  void maybe_update_threads_cpu_time() override;\n@@ -189,0 +187,6 @@\n+void G1PrimaryConcurrentRefineThread::maybe_update_threads_cpu_time() {\n+  if (UsePerfData && os::is_thread_cpu_time_supported()) {\n+    cr()->update_concurrent_refine_threads_cpu_time();\n+  }\n+}\n+\n","filename":"src\/hotspot\/share\/gc\/g1\/g1ConcurrentRefineThread.cpp","additions":8,"deletions":4,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -74,0 +74,4 @@\n+  \/\/ Attempt to update concurrent refine threads stats.\n+  \/\/ Only overridden in G1PrimaryConcurrentRefineThread.\n+  virtual void maybe_update_threads_cpu_time() {};\n+\n","filename":"src\/hotspot\/share\/gc\/g1\/g1ConcurrentRefineThread.hpp","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -195,1 +195,1 @@\n-  update_parallel_gc_threads_cpu_time();\n+  update_parallel_worker_threads_cpu_time();\n@@ -889,1 +889,1 @@\n-void ParallelScavengeHeap::update_parallel_gc_threads_cpu_time() {\n+void ParallelScavengeHeap::update_parallel_worker_threads_cpu_time() {\n@@ -895,1 +895,1 @@\n-  ThreadTotalCPUTimeClosure tttc(_perf_parallel_gc_threads_cpu_time);\n+  ThreadTotalCPUTimeClosure tttc(_perf_parallel_worker_threads_cpu_time);\n","filename":"src\/hotspot\/share\/gc\/parallel\/parallelScavengeHeap.cpp","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -104,1 +104,1 @@\n-  void update_parallel_gc_threads_cpu_time();\n+  void update_parallel_worker_threads_cpu_time();\n","filename":"src\/hotspot\/share\/gc\/parallel\/parallelScavengeHeap.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -278,3 +278,3 @@\n-    _perf_parallel_gc_threads_cpu_time =\n-                PerfDataManager::create_variable(NULL_NS, \"par_gc_thread_time\",\n-                                                 PerfData::U_Ticks, CHECK);\n+    _perf_parallel_worker_threads_cpu_time =\n+                PerfDataManager::create_counter(SUN_THREADS, \"par_gc_thread_time\",\n+                                                PerfData::U_Ticks, CHECK);\n","filename":"src\/hotspot\/share\/gc\/shared\/collectedHeap.cpp","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -147,1 +147,1 @@\n-  PerfVariable* _perf_parallel_gc_threads_cpu_time;\n+  PerfCounter* _perf_parallel_worker_threads_cpu_time;\n@@ -564,2 +564,2 @@\n-  jlong _total;\n-  PerfVariable* _counter;\n+  jlong _time_diff;\n+  PerfCounter* _counter;\n@@ -568,2 +568,2 @@\n-  ThreadTotalCPUTimeClosure(PerfVariable* counter) :\n-      _total(0), _counter(counter) {}\n+  ThreadTotalCPUTimeClosure(PerfCounter* counter) :\n+      _time_diff(0), _counter(counter) {}\n@@ -572,1 +572,1 @@\n-    _counter->set_value(_total);\n+    _counter->inc(_time_diff);\n@@ -580,2 +580,1 @@\n-    jlong cpu_time = os::thread_cpu_time(thread);\n-    _total += cpu_time;\n+    _time_diff = os::thread_cpu_time(thread);\n","filename":"src\/hotspot\/share\/gc\/shared\/collectedHeap.hpp","additions":7,"deletions":8,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -49,1 +49,1 @@\n-PerfVariable* StringDedup::Processor::_g1_concurrent_dedup_thread_cpu_time = NULL;\n+PerfCounter* StringDedup::Processor::_concurrent_dedup_thread_cpu_time = NULL;\n@@ -192,1 +192,1 @@\n-      ThreadTotalCPUTimeClosure tttc(_g1_concurrent_dedup_thread_cpu_time);\n+      ThreadTotalCPUTimeClosure tttc(_concurrent_dedup_thread_cpu_time);\n","filename":"src\/hotspot\/share\/gc\/shared\/stringdedup\/stringDedupProcessor.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -51,1 +51,1 @@\n-  static PerfVariable* _g1_concurrent_dedup_thread_cpu_time;\n+  static PerfCounter* _concurrent_dedup_thread_cpu_time;\n","filename":"src\/hotspot\/share\/gc\/shared\/stringdedup\/stringDedupProcessor.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -109,1 +109,1 @@\n-PerfVariable*     VMThread::_perf_vm_thread_cpu_time = nullptr;\n+PerfCounter*      VMThread::_perf_vm_thread_cpu_time = nullptr;\n@@ -141,2 +141,2 @@\n-                 PerfDataManager::create_variable(NULL_NS, \"vm_thread_time\",\n-                                                  PerfData::U_Ticks, CHECK);\n+                 PerfDataManager::create_counter(SUN_THREADS, \"vm_thread_time\",\n+                                                 PerfData::U_Ticks, CHECK);\n","filename":"src\/hotspot\/share\/runtime\/vmThread.cpp","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -70,1 +70,1 @@\n-  static PerfVariable* _perf_vm_thread_cpu_time;\n+  static PerfCounter* _perf_vm_thread_cpu_time;\n","filename":"src\/hotspot\/share\/runtime\/vmThread.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}