{"files":[{"patch":"@@ -44,5 +44,2 @@\n-           isDstOpaque:(jboolean)isDstOpaque\n-    isDstPremultiplied:(jboolean)isDstPremultiplied\n-                  isAA:(jboolean)isAA\n-                  isText:(jboolean)isText\n-                  isLCD:(jboolean)isLCD;\n+         isAA:(jboolean)isAA\n+        isLCD:(jboolean)isLCD;\n@@ -67,1 +64,0 @@\n-    SurfaceRasterFlags _dstFlags;\n@@ -126,5 +122,3 @@\n-           isDstOpaque:(jboolean)isDstOpaque\n-    isDstPremultiplied:(jboolean)isDstPremultiplied\n-                  isAA:(jboolean)isAA\n-                  isText:(jboolean)isText\n-                  isLCD:(jboolean)isLCD {\n+         isAA:(jboolean)isAA\n+       isText:(jboolean)isText\n+        isLCD:(jboolean)isLCD {\n@@ -132,2 +126,0 @@\n-    _dstFlags.isOpaque = isDstOpaque;\n-    _dstFlags.isPremultiplied = isDstPremultiplied;\n@@ -291,1 +283,1 @@\n-  RenderOptions roptions = {JNI_FALSE, JNI_TRUE, INTERPOLATION_NEAREST_NEIGHBOR, defaultRasterFlags, {dstOps->isOpaque, JNI_TRUE}, JNI_FALSE, JNI_FALSE, JNI_FALSE};\n+  RenderOptions roptions = {JNI_FALSE, JNI_TRUE, INTERPOLATION_NEAREST_NEIGHBOR, defaultRasterFlags, JNI_FALSE, JNI_FALSE, JNI_FALSE};\n@@ -297,1 +289,1 @@\n-    RenderOptions roptions = {JNI_FALSE, JNI_FALSE, INTERPOLATION_NEAREST_NEIGHBOR, defaultRasterFlags, {dstOps->isOpaque, JNI_TRUE}, JNI_FALSE, JNI_FALSE, JNI_TRUE};\n+    RenderOptions roptions = {JNI_FALSE, JNI_FALSE, INTERPOLATION_NEAREST_NEIGHBOR, defaultRasterFlags, JNI_FALSE, JNI_FALSE, JNI_TRUE};\n@@ -304,1 +296,1 @@\n-    RenderOptions roptions = {JNI_FALSE, JNI_FALSE, INTERPOLATION_NEAREST_NEIGHBOR, defaultRasterFlags, {isOpaque, JNI_TRUE}, JNI_FALSE, JNI_FALSE, JNI_FALSE};\n+    RenderOptions roptions = {JNI_FALSE, JNI_FALSE, INTERPOLATION_NEAREST_NEIGHBOR, defaultRasterFlags, JNI_FALSE, JNI_FALSE, JNI_FALSE};\n@@ -332,1 +324,1 @@\n-    RenderOptions roptions = {JNI_TRUE, JNI_FALSE, INTERPOLATION_NEAREST_NEIGHBOR, {isSrcOpaque, JNI_TRUE }, {isDstOpaque, JNI_TRUE}, JNI_FALSE, JNI_TRUE, JNI_FALSE};\n+    RenderOptions roptions = {JNI_TRUE, JNI_FALSE, INTERPOLATION_NEAREST_NEIGHBOR, {isSrcOpaque, JNI_TRUE }, JNI_FALSE, JNI_TRUE, JNI_FALSE};\n@@ -342,1 +334,1 @@\n-    RenderOptions roptions = {JNI_TRUE, isAA, interpolation, { isSrcOpaque, JNI_TRUE }, {isDstOpaque, JNI_TRUE}, JNI_FALSE, JNI_FALSE, JNI_FALSE};\n+    RenderOptions roptions = {JNI_TRUE, isAA, interpolation, { isSrcOpaque, JNI_TRUE }, JNI_FALSE, JNI_FALSE, JNI_FALSE};\n@@ -357,1 +349,2 @@\n-    RenderOptions roptions = {JNI_TRUE, JNI_FALSE, INTERPOLATION_NEAREST_NEIGHBOR, { isSrcOpaque, JNI_TRUE }, {dstOps->isOpaque, JNI_TRUE}, JNI_TRUE, JNI_FALSE, JNI_FALSE};\n+    RenderOptions roptions = {JNI_TRUE, JNI_FALSE, INTERPOLATION_NEAREST_NEIGHBOR, { isSrcOpaque, JNI_TRUE },\n+                              JNI_TRUE, JNI_FALSE, JNI_FALSE};\n@@ -440,5 +433,3 @@\n-               isDstOpaque:renderOptions->dstFlags.isOpaque\n-        isDstPremultiplied:YES\n-                      isAA:renderOptions->isAA\n-                      isText:renderOptions->isText\n-                      isLCD:renderOptions->isLCD];\n+                     isAA:renderOptions->isAA\n+                   isText:renderOptions->isText\n+                    isLCD:renderOptions->isLCD];\n","filename":"src\/java.desktop\/macosx\/native\/libawt_lwawt\/java2d\/metal\/EncoderManager.m","additions":15,"deletions":24,"binary":false,"changes":39,"status":"modified"},{"patch":"@@ -598,2 +598,3 @@\n-            J2dTraceImpl(J2D_TRACE_VERBOSE, JNI_FALSE,\n-                    \"MTLBlitLoops_Blit [tx=%d, xf=%d, AC=%s]: bdst=%s, src=%p (%dx%d) O=%d premul=%d | (%d, %d, %d, %d)->(%1.2f, %1.2f, %1.2f, %1.2f)\",\n+            J2dTraceImpl(J2D_TRACE_VERBOSE, JNI_TRUE,\n+                    \"MTLBlitLoops_Blit srctype=%d [tx=%d, xf=%d, AC=%s]: bdst=%s, src=%p (%dx%d) O=%d premul=%d | (%d, \"\n+                    \"%d, %d, %d)->(%1.2f, %1.2f, %1.2f, %1.2f)\", srctype,\n","filename":"src\/java.desktop\/macosx\/native\/libawt_lwawt\/java2d\/metal\/MTLBlitLoops.m","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -61,1 +61,0 @@\n-    BOOL _clipReady;\n@@ -76,1 +75,0 @@\n-        _clipReady = NO;\n@@ -192,1 +190,0 @@\n-    _clipReady = NO;\n","filename":"src\/java.desktop\/macosx\/native\/libawt_lwawt\/java2d\/metal\/MTLClip.m","additions":0,"deletions":3,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -59,1 +59,1 @@\n-               jfloat extraAlpha, const SurfaceRasterFlags *srcFlags, const SurfaceRasterFlags *dstFlags, int mode);\n+               jfloat extraAlpha, const SurfaceRasterFlags *srcFlags, int mode);\n@@ -231,2 +231,2 @@\n-                       renderOptions->interpolation, NO, [mtlc.composite getExtraAlpha], &renderOptions->srcFlags,\n-                       &renderOptions->dstFlags, 1);\n+                       renderOptions->interpolation, NO, [mtlc.composite getExtraAlpha],\n+                       &renderOptions->srcFlags, 1);\n@@ -273,1 +273,1 @@\n-                       &renderOptions->srcFlags, &renderOptions->dstFlags, 1);\n+                       &renderOptions->srcFlags, 1);\n@@ -812,3 +812,2 @@\n-    setTxtUniforms(mtlc, 0, encoder,\n-                   renderOptions->interpolation, YES, [mtlc.composite getExtraAlpha],\n-                   &srcFlags, &renderOptions->dstFlags, 0);\n+    setTxtUniforms(mtlc, 0, encoder, renderOptions->interpolation, YES, [mtlc.composite getExtraAlpha],\n+                   &srcFlags, 0);\n@@ -896,2 +895,2 @@\n-               jfloat extraAlpha, const SurfaceRasterFlags *srcFlags, const SurfaceRasterFlags *dstFlags, int mode) {\n-    struct TxtFrameUniforms uf = {RGBA_TO_V4(color), mode, srcFlags->isOpaque, dstFlags->isOpaque, extraAlpha};\n+               jfloat extraAlpha, const SurfaceRasterFlags *srcFlags, int mode) {\n+    struct TxtFrameUniforms uf = {RGBA_TO_V4(color), mode, srcFlags->isOpaque, extraAlpha};\n@@ -959,2 +958,1 @@\n-                           &renderOptions->srcFlags,\n-                           &renderOptions->dstFlags, 0);\n+                           &renderOptions->srcFlags, 0);\n@@ -1001,1 +999,1 @@\n-                       &renderOptions->srcFlags, &renderOptions->dstFlags, 0);\n+                       &renderOptions->srcFlags, 0);\n@@ -1009,2 +1007,1 @@\n-                       &renderOptions->srcFlags,\n-                       &renderOptions->dstFlags, 0);\n+                       &renderOptions->srcFlags, 0);\n","filename":"src\/java.desktop\/macosx\/native\/libawt_lwawt\/java2d\/metal\/MTLPaints.m","additions":11,"deletions":14,"binary":false,"changes":25,"status":"modified"},{"patch":"@@ -87,1 +87,1 @@\n-    RenderOptions defaultOptions = {JNI_FALSE, JNI_FALSE, 0\/*unused*\/, {JNI_FALSE, JNI_TRUE}, {JNI_FALSE, JNI_TRUE}, JNI_FALSE, JNI_FALSE, JNI_FALSE};\n+    RenderOptions defaultOptions = {JNI_FALSE, JNI_FALSE, 0\/*unused*\/, {JNI_FALSE, JNI_TRUE}, JNI_FALSE, JNI_FALSE, JNI_FALSE};\n@@ -101,1 +101,1 @@\n-    RenderOptions defaultOptions = {JNI_FALSE, JNI_FALSE, 0\/*unused*\/, {JNI_FALSE, JNI_TRUE}, {JNI_FALSE, JNI_TRUE}, JNI_FALSE, JNI_FALSE, JNI_FALSE};\n+    RenderOptions defaultOptions = {JNI_FALSE, JNI_FALSE, 0\/*unused*\/, {JNI_FALSE, JNI_TRUE}, JNI_FALSE, JNI_FALSE, JNI_FALSE};\n@@ -110,0 +110,13 @@\n+\/\/ Pipeline state index\n+union StateIndex {\n+  uint32_t value;\n+  struct {\n+    uint32_t srcPremultiplied : 1,\n+             srcOpaque        : 1,\n+             stencil          : 1,\n+             aa               : 1,\n+             extAlpha         : 1,\n+             compositeRule    : 27;\n+  } bits;\n+};\n+\n@@ -126,1 +139,2 @@\n-    int subIndex = 0;\n+    union StateIndex index;\n+    index.value = 0;\n@@ -132,8 +146,2 @@\n-            if (!renderOptions->srcFlags.isPremultiplied)\n-                subIndex |= 1;\n-            if (renderOptions->srcFlags.isOpaque)\n-                subIndex |= 1 << 1;\n-            if (!renderOptions->dstFlags.isPremultiplied)\n-                subIndex |= 1 << 2;\n-            if (renderOptions->dstFlags.isOpaque)\n-                subIndex |= 1 << 3;\n+            index.bits.srcPremultiplied = renderOptions->srcFlags.isPremultiplied;\n+            index.bits.srcOpaque = renderOptions->srcFlags.isOpaque;\n@@ -144,13 +152,4 @@\n-    if (stencilNeeded) {\n-        subIndex |= 1 << 4;\n-    }\n-\n-    if (renderOptions->isAA) {\n-        subIndex |= 1 << 5;\n-    }\n-\n-    if ((composite != nil && FLT_LT([composite getExtraAlpha], 1.0f))) {\n-        subIndex |= 1 << 6;\n-    }\n-\n-    int index = compositeRule*128 + subIndex;\n+    index.bits.stencil = stencilNeeded;\n+    index.bits.aa = renderOptions->isAA;\n+    index.bits.extAlpha = composite != nil && FLT_LT([composite getExtraAlpha], 1.0f);\n+    index.bits.compositeRule = compositeRule;\n@@ -160,2 +159,2 @@\n-    if (index >= subStates.count) {\n-        subStates.count = (NSUInteger) (index + 1);\n+    if (index.value >= subStates.count) {\n+        subStates.count = index.value + 1;\n@@ -164,1 +163,1 @@\n-    id<MTLRenderPipelineState> result = [subStates pointerAtIndex:index];\n+    id<MTLRenderPipelineState> result = [subStates pointerAtIndex:index.value];\n@@ -225,1 +224,1 @@\n-            [subStates insertPointer:result atIndex:index];\n+            [subStates replacePointerAtIndex:index.value withPointer:result];\n","filename":"src\/java.desktop\/macosx\/native\/libawt_lwawt\/java2d\/metal\/MTLPipelineStatesStorage.m","additions":27,"deletions":28,"binary":false,"changes":55,"status":"modified"},{"patch":"@@ -38,1 +38,0 @@\n-    SurfaceRasterFlags dstFlags;\n","filename":"src\/java.desktop\/macosx\/native\/libawt_lwawt\/java2d\/metal\/RenderOptions.h","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -117,1 +117,0 @@\n-    int isDstOpaque;\n","filename":"src\/java.desktop\/macosx\/native\/libawt_lwawt\/java2d\/metal\/common.h","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"}]}