{"files":[{"patch":"@@ -375,1 +375,1 @@\n-            } else if (conContext.handshakeContext.handshakeFinished) {\n+            } else if (conContext.isHandshakeFinished()) {\n@@ -763,0 +763,1 @@\n+        HandshakeContext context = conContext.handshakeContext;\n@@ -764,4 +765,4 @@\n-            if (conContext.handshakeContext != null && \/\/ PRE or POST handshake\n-                    !conContext.handshakeContext.taskDelegated &&\n-                    !conContext.handshakeContext.delegatedActions.isEmpty()) {\n-                conContext.handshakeContext.taskDelegated = true;\n+            if (context != null && \/\/ PRE or POST handshake\n+                    !context.taskDelegated &&\n+                    !context.delegatedActions.isEmpty()) {\n+                context.taskDelegated = true;\n@@ -914,7 +915,1 @@\n-        engineLock.lock();\n-        try {\n-            return conContext.handshakeContext == null ?\n-                    null : conContext.handshakeContext.handshakeSession;\n-        } finally {\n-            engineLock.unlock();\n-        }\n+        return conContext.getHandshakeSession();\n@@ -1056,7 +1051,1 @@\n-        engineLock.lock();\n-        try {\n-            return conContext.handshakeContext == null ?\n-                    null : conContext.handshakeContext.applicationProtocol;\n-        } finally {\n-            engineLock.unlock();\n-        }\n+        return conContext.getHandshakeApplicationProtocol();\n","filename":"src\/java.base\/share\/classes\/sun\/security\/ssl\/SSLEngineImpl.java","additions":8,"deletions":19,"binary":false,"changes":27,"status":"modified"},{"patch":"@@ -654,1 +654,1 @@\n-            ProtocolVersion pv = conContext.handshakeContext.negotiatedProtocol;\n+            ProtocolVersion pv = conContext.getNegotiatedProtocol();\n@@ -1381,10 +1381,1 @@\n-        socketLock.lock();\n-        try {\n-            if (conContext.handshakeContext != null) {\n-                return conContext.handshakeContext.applicationProtocol;\n-            }\n-        } finally {\n-            socketLock.unlock();\n-        }\n-\n-        return null;\n+        return conContext.getHandshakeApplicationProtocol();\n","filename":"src\/java.base\/share\/classes\/sun\/security\/ssl\/SSLSocketImpl.java","additions":2,"deletions":11,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -38,2 +38,3 @@\n-import javax.net.ssl.HandshakeCompletedEvent;\n-import javax.net.ssl.HandshakeCompletedListener;\n+import java.util.concurrent.locks.Lock;\n+import java.util.concurrent.locks.ReentrantLock;\n+import javax.net.ssl.*;\n@@ -41,2 +42,0 @@\n-import javax.net.ssl.SSLException;\n-import javax.net.ssl.SSLSocket;\n@@ -92,0 +91,1 @@\n+    final Lock                      handshakeCtxLock = new ReentrantLock();\n@@ -436,4 +436,1 @@\n-        \/\/ terminate the handshake context\n-        if (handshakeContext != null) {\n-            handshakeContext = null;\n-        }\n+        terminateHandshakeContext();\n@@ -461,0 +458,9 @@\n+    private void terminateHandshakeContext() {\n+        handshakeCtxLock.lock();\n+        try {\n+            handshakeContext = null;\n+        } finally {\n+            handshakeCtxLock.unlock();\n+        }\n+    }\n+\n@@ -639,1 +645,1 @@\n-        handshakeContext = null;\n+        terminateHandshakeContext();\n@@ -664,1 +670,1 @@\n-        handshakeContext = null;\n+        terminateHandshakeContext();\n@@ -672,0 +678,42 @@\n+    public ProtocolVersion getNegotiatedProtocol() {\n+        handshakeCtxLock.lock();\n+        try {\n+            return handshakeContext != null\n+                    ? handshakeContext.negotiatedProtocol\n+                    : null;\n+        } finally {\n+            handshakeCtxLock.unlock();\n+        }\n+    }\n+\n+    public String getHandshakeApplicationProtocol() {\n+        handshakeCtxLock.lock();\n+        try {\n+            return handshakeContext != null\n+                    ? handshakeContext.applicationProtocol\n+                    : null;\n+        } finally {\n+            handshakeCtxLock.unlock();\n+        }\n+    }\n+\n+    public SSLSession getHandshakeSession() {\n+        handshakeCtxLock.lock();\n+        try {\n+            return handshakeContext != null\n+                    ? handshakeContext.handshakeSession\n+                    : null;\n+        } finally {\n+            handshakeCtxLock.unlock();\n+        }\n+    }\n+\n+    public boolean isHandshakeFinished() {\n+        handshakeCtxLock.lock();\n+        try {\n+            return handshakeContext == null || handshakeContext.handshakeFinished;\n+        } finally {\n+            handshakeCtxLock.unlock();\n+        }\n+    }\n+\n","filename":"src\/java.base\/share\/classes\/sun\/security\/ssl\/TransportContext.java","additions":58,"deletions":10,"binary":false,"changes":68,"status":"modified"}]}