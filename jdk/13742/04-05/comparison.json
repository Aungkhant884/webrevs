{"files":[{"patch":"@@ -653,2 +653,4 @@\n-            \/\/ The protocol version may have been negotiated.\n-            ProtocolVersion pv = conContext.getNegotiatedProtocol();\n+            \/\/ The protocol version may have been negotiated.  The\n+            \/\/ conContext.handshakeContext.negotiatedProtocol is not used as there\n+            \/\/ may be a race to set it to null.\n+            ProtocolVersion pv = conContext.protocolVersion;\n@@ -1381,1 +1383,9 @@\n-        return conContext.getHandshakeApplicationProtocol();\n+        socketLock.lock();\n+        try {\n+            if (conContext.handshakeContext != null) {\n+                return conContext.handshakeContext.applicationProtocol;\n+            }\n+        } finally {\n+            socketLock.unlock();\n+        }\n+        return null;\n","filename":"src\/java.base\/share\/classes\/sun\/security\/ssl\/SSLSocketImpl.java","additions":13,"deletions":3,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -38,3 +38,2 @@\n-import java.util.concurrent.locks.Lock;\n-import java.util.concurrent.locks.ReentrantLock;\n-import javax.net.ssl.*;\n+import javax.net.ssl.HandshakeCompletedEvent;\n+import javax.net.ssl.HandshakeCompletedListener;\n@@ -42,0 +41,2 @@\n+import javax.net.ssl.SSLException;\n+import javax.net.ssl.SSLSocket;\n@@ -91,1 +92,0 @@\n-    final Lock                      handshakeCtxLock = new ReentrantLock();\n@@ -436,1 +436,4 @@\n-        terminateHandshakeContext();\n+        \/\/ terminate the handshake context\n+        if (handshakeContext != null) {\n+            handshakeContext = null;\n+        }\n@@ -458,9 +461,0 @@\n-    private void terminateHandshakeContext() {\n-        handshakeCtxLock.lock();\n-        try {\n-            handshakeContext = null;\n-        } finally {\n-            handshakeCtxLock.unlock();\n-        }\n-    }\n-\n@@ -645,1 +639,1 @@\n-        terminateHandshakeContext();\n+        handshakeContext = null;\n@@ -670,1 +664,1 @@\n-        terminateHandshakeContext();\n+        handshakeContext = null;\n@@ -678,42 +672,0 @@\n-    public ProtocolVersion getNegotiatedProtocol() {\n-        handshakeCtxLock.lock();\n-        try {\n-            return handshakeContext != null\n-                    ? handshakeContext.negotiatedProtocol\n-                    : null;\n-        } finally {\n-            handshakeCtxLock.unlock();\n-        }\n-    }\n-\n-    public String getHandshakeApplicationProtocol() {\n-        handshakeCtxLock.lock();\n-        try {\n-            return handshakeContext != null\n-                    ? handshakeContext.applicationProtocol\n-                    : null;\n-        } finally {\n-            handshakeCtxLock.unlock();\n-        }\n-    }\n-\n-    public SSLSession getHandshakeSession() {\n-        handshakeCtxLock.lock();\n-        try {\n-            return handshakeContext != null\n-                    ? handshakeContext.handshakeSession\n-                    : null;\n-        } finally {\n-            handshakeCtxLock.unlock();\n-        }\n-    }\n-\n-    public boolean isHandshakeFinished() {\n-        handshakeCtxLock.lock();\n-        try {\n-            return handshakeContext == null || handshakeContext.handshakeFinished;\n-        } finally {\n-            handshakeCtxLock.unlock();\n-        }\n-    }\n-\n","filename":"src\/java.base\/share\/classes\/sun\/security\/ssl\/TransportContext.java","additions":10,"deletions":58,"binary":false,"changes":68,"status":"modified"}]}