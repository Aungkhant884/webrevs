{"files":[{"patch":"@@ -64,0 +64,1 @@\n+import java.util.concurrent.CompletionException;\n@@ -69,1 +70,1 @@\n-import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.*;\n@@ -100,1 +101,1 @@\n-        server.setExchangeSupplier(Http2LPPTestExchangeImpl::new);\n+        server.setExchangeSupplier(Http2PushPromiseContinuationExchangeImpl::new);\n@@ -169,0 +170,25 @@\n+    @Test\n+    public void testSendHeadersOnPushPromiseStream() throws Exception {\n+        \/\/ This test server sends a push promise that should be followed by a continuation but\n+        \/\/ incorrectly sends on Response Headers while the client awaits the continuation.\n+        Http2TestServer faultyServer = new Http2TestServer(false, 0);\n+        faultyServer.addHandler(new ServerPushHandler(), \"\/\");\n+        faultyServer.setExchangeSupplier(Http2PushPromiseHeadersExchangeImpl::new);\n+        System.err.println(\"PushPromiseContinuation: FaultyServer listening on port \" + faultyServer.getAddress().getPort());\n+        faultyServer.start();\n+\n+        int faultyPort = faultyServer.getAddress().getPort();\n+        URI faultyUri = new URI(\"http:\/\/localhost:\" + faultyPort + \"\/\");\n+\n+        HttpClient client = HttpClient.newHttpClient();\n+        \/\/ Server is making a request to an incorrect URI\n+        HttpRequest hreq = HttpRequest.newBuilder(faultyUri).version(HttpClient.Version.HTTP_2).GET().build();\n+        CompletableFuture<HttpResponse<String>> cf =\n+                client.sendAsync(hreq, HttpResponse.BodyHandlers.ofString(UTF_8), pph);\n+\n+        CompletionException t = expectThrows(CompletionException.class, () -> cf.join());\n+        assertEquals(t.getCause().getClass(), IOException.class, \"Expected an IOException but got \" + t.getCause());\n+        System.err.println(\"Client received the following expected exception: \" + t.getCause());\n+        faultyServer.stop();\n+    }\n+\n@@ -189,1 +215,32 @@\n-    static class Http2LPPTestExchangeImpl extends Http2TestExchangeImpl {\n+    static class Http2PushPromiseHeadersExchangeImpl extends Http2TestExchangeImpl {\n+\n+        Http2PushPromiseHeadersExchangeImpl(int streamid, String method, HttpHeaders reqheaders, HttpHeadersBuilder rspheadersBuilder, URI uri, InputStream is, SSLSession sslSession, BodyOutputStream os, Http2TestServerConnection conn, boolean pushAllowed) {\n+            super(streamid, method, reqheaders, rspheadersBuilder, uri, is, sslSession, os, conn, pushAllowed);\n+        }\n+\n+\n+        @Override\n+        public void serverPush(URI uri, HttpHeaders headers, InputStream content) {\n+            HttpHeadersBuilder headersBuilder = new HttpHeadersBuilder();\n+            headersBuilder.setHeader(\":method\", \"GET\");\n+            headersBuilder.setHeader(\":scheme\", uri.getScheme());\n+            headersBuilder.setHeader(\":authority\", uri.getAuthority());\n+            headersBuilder.setHeader(\":path\", uri.getPath());\n+            for (Map.Entry<String,List<String>> entry : headers.map().entrySet()) {\n+                for (String value : entry.getValue())\n+                    headersBuilder.addHeader(entry.getKey(), value);\n+            }\n+            HttpHeaders combinedHeaders = headersBuilder.build();\n+            OutgoingPushPromise pp = new OutgoingPushPromise(streamid, uri, combinedHeaders, content);\n+            \/\/ Indicates to the client that a continuation should be expected\n+            pp.setFlag(0x0);\n+            try {\n+                conn.outputQ.put(pp);\n+                \/\/ writeLoop will spin up thread to read the InputStream\n+            } catch (IOException ex) {\n+                System.err.println(\"TestServer: pushPromise exception: \" + ex);\n+            }\n+        }\n+    }\n+\n+    static class Http2PushPromiseContinuationExchangeImpl extends Http2TestExchangeImpl {\n@@ -194,4 +251,4 @@\n-        Http2LPPTestExchangeImpl(int streamid, String method, HttpHeaders reqheaders,\n-                                 HttpHeadersBuilder rspheadersBuilder, URI uri, InputStream is,\n-                                 SSLSession sslSession, BodyOutputStream os,\n-                                 Http2TestServerConnection conn, boolean pushAllowed) {\n+        Http2PushPromiseContinuationExchangeImpl(int streamid, String method, HttpHeaders reqheaders,\n+                                                 HttpHeadersBuilder rspheadersBuilder, URI uri, InputStream is,\n+                                                 SSLSession sslSession, BodyOutputStream os,\n+                                                 Http2TestServerConnection conn, boolean pushAllowed) {\n","filename":"test\/jdk\/java\/net\/httpclient\/http2\/PushPromiseContinuation.java","additions":64,"deletions":7,"binary":false,"changes":71,"status":"modified"},{"patch":"@@ -25,1 +25,0 @@\n-import jdk.internal.net.http.frame.ContinuationFrame;\n@@ -949,4 +948,5 @@\n-        if (pp.getFlags() != HeadersFrame.END_HEADERS) {\n-            for (ContinuationFrame cf : op.getContinuations())\n-                writeFrame(cf);\n-        }\n+        \/\/ No need to check for END_HEADERS flag here to allow for tests to simulate bad server side\n+        \/\/ behavior i.e Continuation Frames included with END_HEADERS flag set\n+        for (Http2Frame cf : op.getContinuations())\n+            writeFrame(cf);\n+\n","filename":"test\/jdk\/java\/net\/httpclient\/http2\/server\/Http2TestServerConnection.java","additions":5,"deletions":5,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -27,1 +27,0 @@\n-import java.util.LinkedList;\n@@ -31,1 +30,0 @@\n-import jdk.internal.net.http.frame.HeaderFrame;\n@@ -41,1 +39,1 @@\n-    private final List<ContinuationFrame> continuations;\n+    private final List<Http2Frame> continuations;\n@@ -47,6 +45,1 @@\n-        super(0,0);\n-        this.uri = uri;\n-        this.headers = headers;\n-        this.is = is;\n-        this.parentStream = parentStream;\n-        this.continuations = null;\n+        this(parentStream, uri, headers, is, List.of());\n@@ -61,1 +54,0 @@\n-        assert flags != HeaderFrame.END_HEADERS;\n@@ -69,1 +61,1 @@\n-    public List<ContinuationFrame> getContinuations() {\n+    public List<Http2Frame> getContinuations() {\n","filename":"test\/jdk\/java\/net\/httpclient\/http2\/server\/OutgoingPushPromise.java","additions":3,"deletions":11,"binary":false,"changes":14,"status":"modified"}]}