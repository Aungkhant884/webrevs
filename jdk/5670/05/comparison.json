{"files":[{"patch":"@@ -38,0 +38,1 @@\n+#include \"gc\/z\/zValue.inline.hpp\"\n@@ -145,0 +146,4 @@\n+static void free_pages(ZArray<ZPage*>* pages) {\n+  ZHeap::heap()->free_pages(pages, true \/* reclaimed *\/);\n+}\n+\n@@ -153,1 +158,1 @@\n-class ZRelocateSmallAllocator {\n+class ZRelocateSmallAllocator : public StackObj {\n@@ -155,0 +160,1 @@\n+  ResourceMark _rm;\n@@ -156,0 +162,14 @@\n+  ZArray<ZPage*>* _empty_pages;\n+  static const int BULK_FREE_LIMIT = 64;\n+\n+  ZArray<ZPage*>* bulk_free_pages() {\n+    return &_empty_pages[ZThread::worker_id()];\n+  }\n+\n+  void free_empty_pages(bool free_all) {\n+    if ((free_all && bulk_free_pages()->is_nonempty()) ||\n+        (bulk_free_pages()->length() == BULK_FREE_LIMIT)) {\n+      free_pages(bulk_free_pages());\n+      bulk_free_pages()->clear();\n+    }\n+  }\n@@ -159,1 +179,3 @@\n-      _in_place_count(0) {}\n+      _rm(),\n+      _in_place_count(0),\n+      _empty_pages(new ZArray<ZPage*>[ZPerWorkerStorage::count()]) {}\n@@ -162,0 +184,6 @@\n+    if (bulk_free_pages()->is_nonempty()) {\n+      ZPage* const page = bulk_free_pages()->pop();\n+      page->reset();\n+      return page;\n+    }\n+\n@@ -176,1 +204,1 @@\n-      free_page(page);\n+      bulk_free_pages()->push(page);\n@@ -178,0 +206,3 @@\n+\n+    free_empty_pages(true \/* free_all *\/);\n+    bulk_free_pages()->clear_and_deallocate();\n@@ -181,1 +212,3 @@\n-    free_page(page);\n+    bulk_free_pages()->push(page);\n+\n+    free_empty_pages(Atomic::load(&_in_place_count) > 0);\n","filename":"src\/hotspot\/share\/gc\/z\/zRelocate.cpp","additions":37,"deletions":4,"binary":false,"changes":41,"status":"modified"}]}