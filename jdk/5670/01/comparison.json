{"files":[{"patch":"@@ -193,1 +193,1 @@\n-    return _in_place_count;\n+    return Atomic::load(&_in_place_count);\n@@ -270,1 +270,1 @@\n-    return _in_place_count;\n+    return Atomic::load(&_in_place_count);\n@@ -280,0 +280,35 @@\n+  ZArray<ZPage*>   _relocated_pages;\n+  bool             _bulk_free_mode;\n+  static const int BULK_FREE_LEN = 64;\n+\n+  inline bool should_bulk_free() {\n+    return std::is_same<Allocator, ZRelocateSmallAllocator>::value && _bulk_free_mode;\n+  }\n+\n+  inline void append_relocated_pages(ZPage* page) {\n+    _relocated_pages.append(page);\n+  }\n+\n+  inline void bulk_free_relocated_page(int bulk) {\n+    if (_relocated_pages.length() >= bulk && _relocated_pages.is_nonempty()) {\n+      ZHeap::heap()->free_pages(&_relocated_pages, true \/* reclaimed *\/);\n+      _relocated_pages.clear();\n+    }\n+  }\n+\n+  inline ZPage* alloc_bulk_free_page() {\n+    if (_relocated_pages.length() > 0) {\n+      ZPage* result = _relocated_pages.last();\n+      _relocated_pages.pop();\n+      result->reset();\n+      return result;\n+    }\n+    return NULL;\n+  }\n+\n+  inline void bulk_free_mode_check() {\n+    if (_bulk_free_mode && _allocator->in_place_count() > 0) {\n+      _bulk_free_mode = false;\n+      bulk_free_relocated_page(0);\n+    }\n+  }\n@@ -320,0 +355,7 @@\n+      if (should_bulk_free()) {\n+        _target = alloc_bulk_free_page();\n+        bulk_free_mode_check();\n+        if (_target != NULL) {\n+          continue;\n+        }\n+      }\n@@ -341,1 +383,3 @@\n-      _target(NULL) {}\n+      _target(NULL),\n+      _relocated_pages(BULK_FREE_LEN),\n+      _bulk_free_mode(true) {}\n@@ -344,0 +388,3 @@\n+    if (should_bulk_free()) {\n+      bulk_free_relocated_page(0);\n+    }\n@@ -375,1 +422,7 @@\n-      _allocator->free_relocated_page(page);\n+      if (should_bulk_free()) {\n+        append_relocated_pages(page);\n+        bulk_free_relocated_page(BULK_FREE_LEN);\n+        bulk_free_mode_check();\n+      } else {\n+        _allocator->free_relocated_page(page);\n+      }\n","filename":"src\/hotspot\/share\/gc\/z\/zRelocate.cpp","additions":57,"deletions":4,"binary":false,"changes":61,"status":"modified"}]}