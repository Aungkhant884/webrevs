{"files":[{"patch":"@@ -1527,16 +1527,13 @@\n-  {\n-    ResourceMark rm(THREAD);\n-    const ClassFileStream* const stream = parser.clone_stream();\n-    assert(stream != NULL, \"invariant\");\n-    const jclass clazz = static_cast<jclass>(JfrJavaSupport::local_jni_handle(existing_klass->java_mirror(), THREAD));\n-    JfrUpcalls::on_retransform(JfrTraceId::load_raw(existing_klass),\n-                               clazz,\n-                               stream->length(),\n-                               stream->buffer(),\n-                               &size_of_new_bytes,\n-                               &new_bytes,\n-                               THREAD);\n-    JfrJavaSupport::destroy_local_jni_handle(clazz);\n-    if (has_pending_exception(THREAD)) {\n-      return NULL;\n-    }\n+  const ClassFileStream* const stream = parser.clone_stream();\n+  assert(stream != NULL, \"invariant\");\n+  const jclass clazz = static_cast<jclass>(JfrJavaSupport::local_jni_handle(existing_klass->java_mirror(), THREAD));\n+  JfrUpcalls::on_retransform(JfrTraceId::load_raw(existing_klass),\n+                              clazz,\n+                              stream->length(),\n+                              stream->buffer(),\n+                              &size_of_new_bytes,\n+                              &new_bytes,\n+                              THREAD);\n+  JfrJavaSupport::destroy_local_jni_handle(clazz);\n+  if (has_pending_exception(THREAD)) {\n+    return NULL;\n","filename":"src\/hotspot\/share\/jfr\/instrumentation\/jfrEventClassTransformer.cpp","additions":13,"deletions":16,"binary":false,"changes":29,"status":"modified"},{"patch":"@@ -144,3 +144,1 @@\n-  \/\/ memory space must be malloced as mtInternal\n-  \/\/ as it will be deallocated by JVMTI routines\n-  unsigned char* const new_bytes = (unsigned char* const)os::malloc(new_bytes_length, mtInternal);\n+  unsigned char* const new_bytes = NEW_RESOURCE_ARRAY_IN_THREAD_RETURN_NULL(THREAD, unsigned char, new_bytes_length);\n","filename":"src\/hotspot\/share\/jfr\/jni\/jfrUpcalls.cpp","additions":1,"deletions":3,"binary":false,"changes":4,"status":"modified"}]}