{"files":[{"patch":"@@ -87,0 +87,5 @@\n+size_t HeapShared::_alloc_count[HeapShared::ALLOC_STAT_SLOTS];\n+size_t HeapShared::_alloc_size[HeapShared::ALLOC_STAT_SLOTS];\n+size_t HeapShared::_total_obj_count;\n+size_t HeapShared::_total_obj_size;\n+\n@@ -304,0 +309,1 @@\n+    count_allocation(len);\n@@ -589,0 +595,1 @@\n+  count_allocation(roots()->size());\n@@ -834,0 +841,1 @@\n+  print_stats();\n@@ -1861,0 +1869,45 @@\n+void HeapShared::count_allocation(size_t size) {\n+  _total_obj_count ++;\n+  _total_obj_size += size;\n+  for (int i = 0; i < ALLOC_STAT_SLOTS; i++) {\n+    if (size <= (size_t(1) << i)) {\n+      _alloc_count[i] ++;\n+      _alloc_size[i] += size;\n+      return;\n+    }\n+  }\n+}\n+\n+static double avg_size(size_t size, size_t count) {\n+  double avg = 0;\n+  if (count > 0) {\n+    avg = double(size * HeapWordSize) \/ double(count);\n+  }\n+  return avg;\n+}\n+\n+void HeapShared::print_stats() {\n+  size_t huge_count = _total_obj_count;\n+  size_t huge_size = _total_obj_size;\n+\n+  for (int i = 0; i < ALLOC_STAT_SLOTS; i++) {\n+    size_t byte_size_limit = (size_t(1) << i) * HeapWordSize;\n+    size_t count = _alloc_count[i];\n+    size_t size = _alloc_size[i];\n+    log_info(cds, heap)(SIZE_FORMAT_W(8) \" objects are <= \" SIZE_FORMAT_W(-6)\n+                        \" bytes (total \" SIZE_FORMAT_W(8) \" bytes, avg %8.1f bytes)\",\n+                        count, byte_size_limit, size * HeapWordSize, avg_size(size, count));\n+    huge_count -= count;\n+    huge_size -= size;\n+  }\n+\n+  log_info(cds, heap)(SIZE_FORMAT_W(8) \" huge  objects               (total \"  SIZE_FORMAT_W(8) \" bytes\"\n+                      \", avg %8.1f bytes)\",\n+                      huge_count, huge_size * HeapWordSize,\n+                      avg_size(huge_size, huge_count));\n+  log_info(cds, heap)(SIZE_FORMAT_W(8) \" total objects               (total \"  SIZE_FORMAT_W(8) \" bytes\"\n+                      \", avg %8.1f bytes)\",\n+                      _total_obj_count, _total_obj_size * HeapWordSize,\n+                      avg_size(_total_obj_size, _total_obj_count));\n+}\n+\n","filename":"src\/hotspot\/share\/cds\/heapShared.cpp","additions":53,"deletions":0,"binary":false,"changes":53,"status":"modified"},{"patch":"@@ -165,0 +165,9 @@\n+  \/\/ statistics\n+  constexpr static int ALLOC_STAT_SLOTS = 16;\n+  static size_t _alloc_count[ALLOC_STAT_SLOTS];\n+  static size_t _alloc_size[ALLOC_STAT_SLOTS];\n+  static size_t _total_obj_count;\n+  static size_t _total_obj_size; \/\/ in HeapWords\n+\n+  static void count_allocation(size_t size);\n+  static void print_stats();\n","filename":"src\/hotspot\/share\/cds\/heapShared.hpp","additions":9,"deletions":0,"binary":false,"changes":9,"status":"modified"}]}