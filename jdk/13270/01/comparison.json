{"files":[{"patch":"@@ -511,19 +511,2 @@\n-  Handle loader;\n-  Handle domain;\n-  if (accessing_klass != nullptr) {\n-    loader = Handle(current, accessing_klass->loader());\n-    domain = Handle(current, accessing_klass->protection_domain());\n-  }\n-\n-  Klass* found_klass;\n-  {\n-    ttyUnlocker ttyul;  \/\/ release tty lock to avoid ordering problems\n-    MutexLocker ml(current, Compile_lock);\n-    Klass* kls;\n-    if (!require_local) {\n-      kls = SystemDictionary::find_constrained_instance_or_array_klass(current, sym, loader);\n-    } else {\n-      kls = SystemDictionary::find_instance_or_array_klass(current, sym, loader, domain);\n-    }\n-    found_klass = kls;\n-  }\n+  Klass* found_klass = SystemDictionary::find_constrained_or_local_klass(current, sym,\n+                                               accessing_klass->get_Klass(), require_local);\n","filename":"src\/hotspot\/share\/ci\/ciEnv.cpp","additions":2,"deletions":19,"binary":false,"changes":21,"status":"modified"},{"patch":"@@ -1356,5 +1356,1 @@\n-    { \/\/ Grabbing the Compile_lock prevents systemDictionary updates\n-      \/\/ during compilations.\n-      MutexLocker mu(THREAD, Compile_lock);\n-      update_dictionary(THREAD, loaded_class, loader_data);\n-    }\n+    update_dictionary(THREAD, loaded_class, loader_data);\n@@ -1421,6 +1417,3 @@\n-  {\n-    MutexLocker mu_r(THREAD, Compile_lock);\n-    \/\/ Add to systemDictionary - so other classes can see it.\n-    \/\/ Grabs and releases SystemDictionary_lock\n-    update_dictionary(THREAD, k, loader_data);\n-  }\n+  \/\/ Add to systemDictionary - so other classes can see it.\n+  \/\/ Grabs and releases SystemDictionary_lock\n+  update_dictionary(THREAD, k, loader_data);\n@@ -1687,5 +1680,1 @@\n-  \/\/ Compile_lock prevents systemDictionary updates during compilations\n-  assert_locked_or_safepoint(Compile_lock);\n-  Symbol* name  = k->name();\n-\n-  MutexLocker mu1(SystemDictionary_lock);\n+  MonitorLocker mu1(SystemDictionary_lock);\n@@ -1694,0 +1683,1 @@\n+  Symbol* name  = k->name();\n@@ -1699,1 +1689,1 @@\n-  SystemDictionary_lock->notify_all();\n+  mu1.notify_all();\n@@ -1745,0 +1735,16 @@\n+\/\/ Called by the compiler to find a loaded class directly or referenced in the loader constraint table.\n+Klass* SystemDictionary::find_constrained_or_local_klass(Thread* current, Symbol* sym,\n+                                                         Klass* accessing_klass,\n+                                                         bool require_local) {\n+  HandleMark hm(current);\n+  Handle loader;\n+  Handle domain;\n+  if (accessing_klass != nullptr) {\n+    loader = Handle(current, accessing_klass->class_loader());\n+    domain = Handle(current, accessing_klass->protection_domain());\n+  }\n+\n+  return require_local ? find_instance_or_array_klass(current, sym, loader, domain) :\n+                         find_constrained_instance_or_array_klass(current, sym, loader);\n+}\n+\n","filename":"src\/hotspot\/share\/classfile\/systemDictionary.cpp","additions":23,"deletions":17,"binary":false,"changes":40,"status":"modified"},{"patch":"@@ -153,0 +153,1 @@\n+ private:\n@@ -178,0 +179,7 @@\n+ public:\n+  \/\/ Called by the compiler to find a loaded class directly or referenced in the\n+  \/\/ loader constraint table.\n+  static Klass* find_constrained_or_local_klass(Thread* current, Symbol* sym,\n+                                                Klass* accessing_klass,\n+                                                bool require_local);\n+\n","filename":"src\/hotspot\/share\/classfile\/systemDictionary.hpp","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -1667,17 +1667,2 @@\n-  Handle loader;\n-  Handle domain;\n-  if (accessing_klass != nullptr) {\n-    loader = Handle(THREAD, accessing_klass->class_loader());\n-    domain = Handle(THREAD, accessing_klass->protection_domain());\n-  }\n-\n-  Klass* found_klass;\n-  {\n-    ttyUnlocker ttyul;  \/\/ release tty lock to avoid ordering problems\n-    MutexLocker ml(THREAD, Compile_lock);\n-    if (!require_local) {\n-      found_klass = SystemDictionary::find_constrained_instance_or_array_klass(THREAD, sym, loader);\n-    } else {\n-      found_klass = SystemDictionary::find_instance_or_array_klass(THREAD, sym, loader, domain);\n-    }\n-  }\n+  Klass* found_klass = SystemDictionary::find_constrained_or_local_klass(THREAD, sym,\n+                                                      accessing_klass, require_local);\n","filename":"src\/hotspot\/share\/jvmci\/jvmciRuntime.cpp","additions":2,"deletions":17,"binary":false,"changes":19,"status":"modified"}]}