{"files":[{"patch":"@@ -314,2 +314,27 @@\n-  if (Thread::current_or_null() == NULL) {\n-    \/\/ Not yet attached? Don't try to use locking\n+  struct MaybeLocker {\n+    Mutex* const _mutex;\n+    bool         _proceed;\n+    bool         _locked;\n+\n+    MaybeLocker(Mutex* mutex) : _mutex(mutex), _proceed(false), _locked(false) {\n+      if (Thread::current_or_null() == NULL) {\n+        _proceed = true;\n+      } else if (VMError::is_error_reported()) {\n+        if (_mutex->try_lock_without_rank_check()) {\n+          _proceed = _locked = true;\n+        }\n+      } else {\n+        _mutex->lock_without_safepoint_check();\n+        _proceed = _locked = true;\n+      }\n+    }\n+    ~MaybeLocker() {\n+      if (_locked) {\n+        _mutex->unlock();\n+      }\n+    }\n+  };\n+\n+  MaybeLocker ml(&_mutex);\n+\n+  if (ml._proceed) {\n@@ -318,2 +343,3 @@\n-    MutexLocker ml(&_mutex, Mutex::_no_safepoint_check_flag);\n-    print_log_impl(out, max);\n+    out->print_cr(\"%s (%d events):\", _name, _count);\n+    out->print_cr(\"No events printed - crash while holding lock\");\n+    out->cr();\n","filename":"src\/hotspot\/share\/utilities\/events.hpp","additions":30,"deletions":4,"binary":false,"changes":34,"status":"modified"}]}