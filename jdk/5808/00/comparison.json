{"files":[{"patch":"@@ -69,1 +69,1 @@\n-        if (cls != NULL)\n+        if (cls != NULL) {\n@@ -71,0 +71,1 @@\n+        }\n@@ -76,5 +77,4 @@\n-    memset(pwd_buf, 0, sizeof(pwd_buf));\n-\n-    if (getpwuid_r(getuid(), &resbuf, pwd_buf, sizeof(pwd_buf), &pwd) == 0 &&\n-        pwd != NULL &&\n-        getgroups(numSuppGroups, groups) != -1) {\n+    supplementaryGroupID = (*env)->GetFieldID(env, cls, \"groups\", \"[J\");\n+    if (supplementaryGroupID == 0) {\n+        goto cleanUpAndReturn;\n+    }\n@@ -82,2 +82,3 @@\n-        userNameID = (*env)->GetFieldID(env, cls, \"username\", \"Ljava\/lang\/String;\");\n-        if (userNameID == 0)\n+    if (getgroups(numSuppGroups, groups) != -1) {\n+        jgroups = (*env)->NewLongArray(env, numSuppGroups);\n+        if (jgroups == NULL) {\n@@ -85,3 +86,3 @@\n-\n-        userID = (*env)->GetFieldID(env, cls, \"uid\", \"J\");\n-        if (userID == 0)\n+        }\n+        jgroupsAsArray = (*env)->GetLongArrayElements(env, jgroups, 0);\n+        if (jgroupsAsArray == NULL) {\n@@ -89,0 +90,7 @@\n+        }\n+        for (i = 0; i < numSuppGroups; i++) {\n+            jgroupsAsArray[i] = groups[i];\n+        }\n+        (*env)->ReleaseLongArrayElements(env, jgroups, jgroupsAsArray, 0);\n+        (*env)->SetObjectField(env, obj, supplementaryGroupID, jgroups);\n+    }\n@@ -90,3 +98,4 @@\n-        groupID = (*env)->GetFieldID(env, cls, \"gid\", \"J\");\n-        if (groupID == 0)\n-            goto cleanUpAndReturn;\n+    userNameID = (*env)->GetFieldID(env, cls, \"username\", \"Ljava\/lang\/String;\");\n+    if (userNameID == 0) {\n+        goto cleanUpAndReturn;\n+    }\n@@ -94,3 +103,4 @@\n-        supplementaryGroupID = (*env)->GetFieldID(env, cls, \"groups\", \"[J\");\n-        if (supplementaryGroupID == 0)\n-            goto cleanUpAndReturn;\n+    userID = (*env)->GetFieldID(env, cls, \"uid\", \"J\");\n+    if (userID == 0) {\n+        goto cleanUpAndReturn;\n+    }\n@@ -98,4 +108,4 @@\n-        jstr = (*env)->NewStringUTF(env, pwd->pw_name);\n-        if (jstr == NULL)\n-            goto cleanUpAndReturn;\n-        (*env)->SetObjectField(env, obj, userNameID, jstr);\n+    groupID = (*env)->GetFieldID(env, cls, \"gid\", \"J\");\n+    if (groupID == 0) {\n+        goto cleanUpAndReturn;\n+    }\n@@ -103,0 +113,3 @@\n+    memset(pwd_buf, 0, sizeof(pwd_buf));\n+    if (getpwuid_r(getuid(), &resbuf, pwd_buf, sizeof(pwd_buf), &pwd) == 0 &&\n+            pwd != NULL) {\n@@ -104,1 +117,0 @@\n-\n@@ -106,6 +118,2 @@\n-\n-        jgroups = (*env)->NewLongArray(env, numSuppGroups);\n-        if (jgroups == NULL)\n-            goto cleanUpAndReturn;\n-        jgroupsAsArray = (*env)->GetLongArrayElements(env, jgroups, 0);\n-        if (jgroupsAsArray == NULL)\n+        jstr = (*env)->NewStringUTF(env, pwd->pw_name);\n+        if (jstr == NULL) {\n@@ -113,4 +121,5 @@\n-        for (i = 0; i < numSuppGroups; i++)\n-            jgroupsAsArray[i] = groups[i];\n-        (*env)->ReleaseLongArrayElements(env, jgroups, jgroupsAsArray, 0);\n-        (*env)->SetObjectField(env, obj, supplementaryGroupID, jgroups);\n+        }\n+        (*env)->SetObjectField(env, obj, userNameID, jstr);\n+    } else {\n+        (*env)->SetLongField(env, obj, userID, getuid());\n+        (*env)->SetLongField(env, obj, groupID, getgid());\n","filename":"src\/jdk.security.auth\/unix\/native\/libjaas\/Unix.c","additions":41,"deletions":32,"binary":false,"changes":73,"status":"modified"}]}