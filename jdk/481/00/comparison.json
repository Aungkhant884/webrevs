{"files":[{"patch":"@@ -197,0 +197,2 @@\n+        boolean imageTemplate = Boolean.parseBoolean(System.getProperty(\"sun.awt.enableTemplateImages\", \"false\"));\n+\n@@ -214,1 +216,1 @@\n-                    setNativeImage(ptr, imagePtr, imageAutoSize);\n+                    setNativeImage(ptr, imagePtr, imageAutoSize, imageTemplate);\n@@ -220,1 +222,1 @@\n-    private native void setNativeImage(final long model, final long nsimage, final boolean autosize);\n+    private native void setNativeImage(final long model, final long nsimage, final boolean autosize, final boolean template);\n","filename":"src\/java.desktop\/macosx\/classes\/sun\/lwawt\/macosx\/CTrayIcon.java","additions":4,"deletions":2,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -40,1 +40,1 @@\n-@class AWTTrayIconView;\n+@class AWTTrayIconDelegate;\n@@ -45,1 +45,1 @@\n-@interface AWTTrayIcon : NSObject {\n+@interface AWTTrayIcon : NSResponder {\n@@ -47,1 +47,1 @@\n-    AWTTrayIconView *view;\n+    AWTTrayIconDelegate *menuDelegate;\n@@ -49,0 +49,1 @@\n+    NSTrackingArea *trackingArea;\n@@ -55,1 +56,1 @@\n-- (void) setImage:(NSImage *) imagePtr sizing:(BOOL)autosize;\n+- (void) setImage:(NSImage *) imagePtr sizing:(BOOL)autosize template:(BOOL)isTemplate;\n@@ -58,1 +59,11 @@\n-\n+- (void) setMenu:(NSMenu *)menu;\n+- (void) mouseDown:(id)sender;\n+- (void) mouseUp:(NSEvent *)event;\n+- (void) mouseDragged:(NSEvent *)event;\n+- (void) mouseMoved: (NSEvent *)event;\n+- (void) rightMouseDown:(NSEvent *)event;\n+- (void) rightMouseUp:(NSEvent *)event;\n+- (void) rightMouseDragged:(NSEvent *)event;\n+- (void) otherMouseDown:(NSEvent *)event;\n+- (void) otherMouseUp:(NSEvent *)event;\n+- (void) otherMouseDragged:(NSEvent *)event;\n@@ -63,2 +74,2 @@\n- * AWTTrayIconView *\/\n-@interface AWTTrayIconView : NSView <NSMenuDelegate> {\n+ * AWTTrayIconDelegate *\/\n+@interface AWTTrayIconDelegate : NSObject<NSMenuDelegate> {\n@@ -68,1 +79,0 @@\n-    NSTrackingArea *trackingArea;\n@@ -76,0 +86,2 @@\n+-(void)updateMenuRes;\n+-(NSMenu *)getMenu;\n@@ -77,1 +89,1 @@\n-@end \/\/AWTTrayIconView\n+@end \/\/AWTTrayIconDelegate\n","filename":"src\/java.desktop\/macosx\/native\/libawt_lwawt\/awt\/CTrayIcon.h","additions":21,"deletions":9,"binary":false,"changes":30,"status":"modified"},{"patch":"@@ -70,2 +70,14 @@\n-    view = [[AWTTrayIconView alloc] initWithTrayIcon:self];\n-    [theItem setView:view];\n+    menuDelegate = [[AWTTrayIconDelegate alloc] initWithTrayIcon:self];\n+\n+    [theItem.button sendActionOn: NSEventMaskLeftMouseDown | NSEventMaskRightMouseDown];\n+    theItem.button.action = @selector(mouseDown:);\n+    theItem.button.target = self;\n+\n+    trackingArea = [[NSTrackingArea alloc] initWithRect: CGRectZero\n+                                            options: NSTrackingMouseMoved |\n+                                                NSTrackingInVisibleRect |\n+                                                NSTrackingActiveAlways\n+                                            owner: self\n+                                            userInfo: nil];\n+\n+    [[theItem button] addTrackingArea:trackingArea];\n@@ -76,0 +88,4 @@\n+-(void) setMenu:(NSMenu *) menu{\n+    [theItem setMenu: menu];\n+}\n+\n@@ -86,3 +102,0 @@\n-    [view setImage: nil];\n-    [view setTrayIcon: nil];\n-    [view release];\n@@ -90,0 +103,5 @@\n+    [menuDelegate setImage: nil];\n+    [menuDelegate setTrayIcon: nil];\n+    [menuDelegate release];\n+\n+    [trackingArea release];\n@@ -96,1 +114,5 @@\n-    [view setToolTip:tooltip];\n+    [[theItem button] setToolTip:tooltip];\n+}\n+\n+- (void) updateMenuRes {\n+    [menuDelegate updateMenuRes];\n@@ -107,1 +129,1 @@\n-- (void) setImage:(NSImage *) imagePtr sizing:(BOOL)autosize {\n+- (void) setImage:(NSImage *) imagePtr sizing:(BOOL)autosize template:(BOOL)isTemplate {\n@@ -117,0 +139,1 @@\n+    theItem.button.image = imagePtr;\n@@ -118,5 +141,2 @@\n-    [view setImage:imagePtr];\n-}\n-\n-- (NSPoint) getLocationOnScreen {\n-    return [[view window] convertBaseToScreen: NSZeroPoint];\n+    [[[theItem button] image] setTemplate: isTemplate];\n+    [[theItem button] setNeedsDisplay: true];\n@@ -131,2 +151,3 @@\n-    NSPoint localPoint = [view convertPoint: eventLocation fromView: nil];\n-    localPoint.y = [view bounds].size.height - localPoint.y;\n+\n+    NSPoint localPoint = [[theItem button] convertPoint: eventLocation fromView: nil];\n+    localPoint.y = [[theItem button] bounds].size.height - localPoint.y;\n@@ -169,4 +190,0 @@\n-@end \/\/AWTTrayIcon\n-\/\/================================================\n-\n-@implementation AWTTrayIconView\n@@ -174,2 +191,2 @@\n--(id)initWithTrayIcon:(AWTTrayIcon *)theTrayIcon {\n-    self = [super initWithFrame:NSMakeRect(0, 0, 1, 1)];\n+- (void) mouseDown:(id)sender {\n+    [self deliverJavaMouseEvent: [NSApp currentEvent]];\n@@ -177,4 +194,13 @@\n-    [self setTrayIcon: theTrayIcon];\n-    isHighlighted = NO;\n-    image = nil;\n-    trackingArea = nil;\n+    \/\/find CTrayIcon.getPopupMenuModel method and call it to get popup menu ptr.\n+    JNIEnv *env = [ThreadUtilities getJNIEnv];\n+    static JNF_CLASS_CACHE(jc_CTrayIcon, \"sun\/lwawt\/macosx\/CTrayIcon\");\n+    static JNF_MEMBER_CACHE(jm_getPopupMenuModel, jc_CTrayIcon, \"getPopupMenuModel\", \"()J\");\n+    jlong res = JNFCallLongMethod(env, menuDelegate->trayIcon->peer, jm_getPopupMenuModel);\n+\n+    if (res != 0) {\n+        CPopupMenu *cmenu = jlong_to_ptr(res);\n+        NSMenu* menu = [cmenu menu];\n+        [menu setDelegate:menuDelegate];\n+        [theItem popUpStatusItemMenu: menu];\n+    }\n+}\n@@ -182,1 +208,0 @@\n-    [self addTrackingArea];\n@@ -184,1 +209,2 @@\n-    return self;\n+- (void) mouseUp:(NSEvent *)event {\n+    [self deliverJavaMouseEvent: event];\n@@ -187,9 +213,2 @@\n-- (void)addTrackingArea {\n-    NSTrackingAreaOptions options = NSTrackingMouseMoved |\n-                                    NSTrackingInVisibleRect |\n-                                    NSTrackingActiveAlways;\n-    trackingArea = [[NSTrackingArea alloc] initWithRect: CGRectZero\n-                                                options: options\n-                                                owner: self\n-                                                userInfo: nil];\n-    [self addTrackingArea:trackingArea];\n+- (void) mouseDragged:(NSEvent *)event {\n+    [self deliverJavaMouseEvent: event];\n@@ -198,4 +217,2 @@\n--(void) dealloc {\n-    [image release];\n-    [trackingArea release];\n-    [super dealloc];\n+- (void) mouseMoved: (NSEvent *)event {\n+    [self deliverJavaMouseEvent: event];\n@@ -204,6 +221,2 @@\n-- (void)setHighlighted:(BOOL)aFlag\n-{\n-    if (isHighlighted != aFlag) {\n-        isHighlighted = aFlag;\n-        [self setNeedsDisplay:YES];\n-    }\n+- (void) rightMouseDown:(NSEvent *)event {\n+    [self deliverJavaMouseEvent: event];\n@@ -212,8 +225,2 @@\n-- (void)setImage:(NSImage*)anImage {\n-    [anImage retain];\n-    [image release];\n-    image = anImage;\n-\n-    if (image != nil) {\n-        [self setNeedsDisplay:YES];\n-    }\n+- (void) rightMouseUp:(NSEvent *)event {\n+    [self deliverJavaMouseEvent: event];\n@@ -222,2 +229,2 @@\n--(void)setTrayIcon:(AWTTrayIcon*)theTrayIcon {\n-    trayIcon = theTrayIcon;\n+- (void) rightMouseDragged:(NSEvent *)event {\n+    [self deliverJavaMouseEvent: event];\n@@ -226,3 +233,2 @@\n-- (void)menuWillOpen:(NSMenu *)menu\n-{\n-    [self setHighlighted:YES];\n+- (void) otherMouseDown:(NSEvent *)event {\n+    [self deliverJavaMouseEvent: event];\n@@ -231,4 +237,2 @@\n-- (void)menuDidClose:(NSMenu *)menu\n-{\n-    [menu setDelegate:nil];\n-    [self setHighlighted:NO];\n+- (void) otherMouseUp:(NSEvent *)event {\n+    [self deliverJavaMouseEvent: event];\n@@ -237,25 +241,2 @@\n-- (void)drawRect:(NSRect)dirtyRect\n-{\n-    if (image == nil) {\n-        return;\n-    }\n-\n-    NSRect bounds = [self bounds];\n-    NSSize imageSize = [image size];\n-\n-    NSRect drawRect = {{ (bounds.size.width - imageSize.width) \/ 2.0,\n-        (bounds.size.height - imageSize.height) \/ 2.0 }, imageSize};\n-\n-    \/\/ don't cover bottom pixels of the status bar with the image\n-    if (drawRect.origin.y < 1.0) {\n-        drawRect.origin.y = 1.0;\n-    }\n-    drawRect = NSIntegralRect(drawRect);\n-\n-    [trayIcon.theItem drawStatusBarBackgroundInRect:bounds\n-                                withHighlight:isHighlighted];\n-    [image drawInRect:drawRect\n-             fromRect:NSZeroRect\n-            operation:NSCompositeSourceOver\n-             fraction:1.0\n-     ];\n+- (void) otherMouseDragged:(NSEvent *)event {\n+    [self deliverJavaMouseEvent: event];\n@@ -264,20 +245,2 @@\n-- (void)mouseDown:(NSEvent *)event {\n-    [trayIcon deliverJavaMouseEvent: event];\n-\n-    \/\/ don't show the menu on ctrl+click: it triggers ACTION event, like right click\n-    if (([event modifierFlags] & NSControlKeyMask) == 0) {\n-        \/\/find CTrayIcon.getPopupMenuModel method and call it to get popup menu ptr.\n-        JNIEnv *env = [ThreadUtilities getJNIEnv];\n-        static JNF_CLASS_CACHE(jc_CTrayIcon, \"sun\/lwawt\/macosx\/CTrayIcon\");\n-        static JNF_MEMBER_CACHE(jm_getPopupMenuModel, jc_CTrayIcon, \"getPopupMenuModel\", \"()J\");\n-        jlong res = JNFCallLongMethod(env, trayIcon.peer, jm_getPopupMenuModel);\n-\n-        if (res != 0) {\n-            CPopupMenu *cmenu = jlong_to_ptr(res);\n-            NSMenu* menu = [cmenu menu];\n-            [menu setDelegate:self];\n-            [trayIcon.theItem popUpStatusItemMenu:menu];\n-            [self setNeedsDisplay:YES];\n-        }\n-    }\n-}\n+@end \/\/AWTTrayIcon\n+\/\/================================================\n@@ -285,3 +248,1 @@\n-- (void) mouseUp:(NSEvent *)event {\n-    [trayIcon deliverJavaMouseEvent: event];\n-}\n+@implementation AWTTrayIconDelegate\n@@ -289,3 +250,2 @@\n-- (void) mouseDragged:(NSEvent *)event {\n-    [trayIcon deliverJavaMouseEvent: event];\n-}\n+-(id)initWithTrayIcon:(AWTTrayIcon *)theTrayIcon {\n+    self = [super init];\n@@ -293,3 +253,2 @@\n-- (void) mouseMoved: (NSEvent *)event {\n-    [trayIcon deliverJavaMouseEvent: event];\n-}\n+    [self setTrayIcon: theTrayIcon];\n+    image = nil;\n@@ -297,2 +256,1 @@\n-- (void) rightMouseDown:(NSEvent *)event {\n-    [trayIcon deliverJavaMouseEvent: event];\n+    return self;\n@@ -301,2 +259,3 @@\n-- (void) rightMouseUp:(NSEvent *)event {\n-    [trayIcon deliverJavaMouseEvent: event];\n+-(void) dealloc {\n+    [image release];\n+    [super dealloc];\n@@ -305,3 +264,4 @@\n-- (void) rightMouseDragged:(NSEvent *)event {\n-    [trayIcon deliverJavaMouseEvent: event];\n-}\n+-(void)setImage:(NSImage*)anImage {\n+    [anImage retain];\n+    [image release];\n+    image = anImage;\n@@ -309,2 +269,3 @@\n-- (void) otherMouseDown:(NSEvent *)event {\n-    [trayIcon deliverJavaMouseEvent: event];\n+    if (image != nil) {\n+        [self setNeedsDisplay:YES];\n+    }\n@@ -313,2 +274,2 @@\n-- (void) otherMouseUp:(NSEvent *)event {\n-    [trayIcon deliverJavaMouseEvent: event];\n+-(void)setTrayIcon:(AWTTrayIcon*)theTrayIcon {\n+    trayIcon = theTrayIcon;\n@@ -317,2 +278,16 @@\n-- (void) otherMouseDragged:(NSEvent *)event {\n-    [trayIcon deliverJavaMouseEvent: event];\n+- (NSMenu *) getMenu {\n+    JNIEnv *env = [ThreadUtilities getJNIEnv];\n+    static JNF_CLASS_CACHE(jc_CTrayIcon, \"sun\/lwawt\/macosx\/CTrayIcon\");\n+    static JNF_MEMBER_CACHE(jm_getPopupMenuModel, jc_CTrayIcon, \"getPopupMenuModel\", \"()J\");\n+    jlong res = JNFCallLongMethod(env, trayIcon.peer, jm_getPopupMenuModel);\n+    if (res != 0) {\n+        CPopupMenu *cmenu = jlong_to_ptr(res);\n+        NSMenu* menu = [cmenu menu];\n+        [menu setDelegate:self];\n+        return menu;\n+    } else {\n+        NSMenu* menu = [[NSMenu alloc] initWithTitle:@\"\"];\n+        [menu setDelegate:self];\n+        return menu;\n+    }\n+    return NULL;\n@@ -321,2 +296,1 @@\n-\n-@end \/\/AWTTrayIconView\n+@end \/\/AWTTrayIconDelegate\n@@ -378,1 +352,1 @@\n- * Signature: (JJZ)V\n+ * Signature: (JJZZ)V\n@@ -381,1 +355,1 @@\n-(JNIEnv *env, jobject self, jlong model, jlong imagePtr, jboolean autosize) {\n+(JNIEnv *env, jobject self, jlong model, jlong imagePtr, jboolean autosize, jboolean isTemplate) {\n@@ -386,1 +360,1 @@\n-        [icon setImage:jlong_to_ptr(imagePtr) sizing:autosize];\n+        [icon setImage:jlong_to_ptr(imagePtr) sizing:autosize template:isTemplate];\n","filename":"src\/java.desktop\/macosx\/native\/libawt_lwawt\/awt\/CTrayIcon.m","additions":108,"deletions":134,"binary":false,"changes":242,"status":"modified"}]}