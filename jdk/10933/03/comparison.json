{"files":[{"patch":"@@ -477,1 +477,4 @@\n-    nm = new (native_nmethod_size, CompLevel_none)\n+\n+    \/\/ MH intrinsics are dispatch stubs which are compatible with NonNMethod space.\n+    bool allow_NonNMethod_space = method->is_method_handle_intrinsic();\n+    nm = new (native_nmethod_size, allow_NonNMethod_space)\n@@ -484,0 +487,10 @@\n+#ifdef ASSERT\n+    \/\/ Allocating in NonNMethod space is only for special nmethods which don't\n+    \/\/ need to be findable by nmethod iterators.\n+    \/\/ GC may not look for Oops, there.\n+    if (allow_NonNMethod_space) {\n+      assert(oop_maps == nullptr, \"expectation\");\n+      assert(!nm->contains_oops(), \"no oops allowed\");\n+      assert(nm->metadata_size() == 0, \"metadata usage not expected\");\n+    }\n+#endif\n@@ -719,0 +732,8 @@\n+void* nmethod::operator new(size_t size, int nmethod_size, bool allow_NonNMethod_space) throw () {\n+  \/\/ Try MethodNonProfiled and MethodProfiled.\n+  void* return_value = CodeCache::allocate(nmethod_size, CodeBlobType::MethodNonProfiled);\n+  if (return_value != nullptr || !allow_NonNMethod_space) return return_value;\n+  \/\/ Try NonNMethod or give up.\n+  return CodeCache::allocate(nmethod_size, CodeBlobType::NonNMethod);\n+}\n+\n@@ -1716,0 +1737,13 @@\n+bool nmethod::contains_oops() {\n+  if (oops_size() > 0) return true;\n+\n+  if (relocInfo::mustIterateImmediateOopsInCode()) {\n+    RelocIterator iter(this, oops_reloc_begin());\n+    while (iter.next()) {\n+      if (iter.type() == relocInfo::oop_type) return true;\n+    }\n+  }\n+\n+  return false;\n+}\n+\n","filename":"src\/hotspot\/share\/code\/nmethod.cpp","additions":35,"deletions":1,"binary":false,"changes":36,"status":"modified"},{"patch":"@@ -301,0 +301,4 @@\n+  \/\/ For method handle intrinsics: Try MethodNonProfiled, MethodProfiled and NonNMethod.\n+  \/\/ Attention: Only allow NonNMethod space for special nmethods which don't need to be\n+  \/\/ findable by nmethod iterators! In particular, they must not contain oops!\n+  void* operator new(size_t size, int nmethod_size, bool allow_NonNMethod_space) throw();\n@@ -547,0 +551,2 @@\n+  bool contains_oops();\n+\n","filename":"src\/hotspot\/share\/code\/nmethod.hpp","additions":6,"deletions":0,"binary":false,"changes":6,"status":"modified"}]}