{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2004, 2018, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2004, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -70,0 +70,2 @@\n+\/* lock to access classCount *\/\n+static jrawMonitorID classLoadLock = NULL;\n@@ -99,1 +101,1 @@\n-    if (name != NULL && classCount < max_classes &&\n+    if (name != NULL &&\n@@ -103,3 +105,1 @@\n-        NSK_DISPLAY1(\"ClassFileLoadHook: %s\\n\", name);\n-        name_len = (jint) strlen(name) + 1;\n-        if (!NSK_JVMTI_VERIFY(jvmti_env->Allocate(name_len, (unsigned char**) &names[classCount]))) {\n+        if (!NSK_JVMTI_VERIFY(jvmti_env->RawMonitorEnter(classLoadLock))) {\n@@ -109,3 +109,20 @@\n-        memcpy(names[classCount], name, name_len);\n-        if (!NSK_JVMTI_VERIFY(jvmti_env->Allocate(class_data_len, (unsigned char**)\n-                &old_class_def[classCount].class_bytes))) {\n+        \/\/ use while instead of if to exit the block on error\n+        while (classCount < max_classes) {\n+            NSK_DISPLAY1(\"ClassFileLoadHook: %s\\n\", name);\n+            name_len = (jint)strlen(name) + 1;\n+            if (!NSK_JVMTI_VERIFY(jvmti_env->Allocate(name_len, (unsigned char**)& names[classCount]))) {\n+                nsk_jvmti_setFailStatus();\n+                break;\n+            }\n+            memcpy(names[classCount], name, name_len);\n+            if (!NSK_JVMTI_VERIFY(jvmti_env->Allocate(class_data_len, (unsigned char**)\n+                    & old_class_def[classCount].class_bytes))) {\n+                nsk_jvmti_setFailStatus();\n+                break;\n+            }\n+            memcpy((unsigned char*)old_class_def[classCount].class_bytes,\n+                class_data, class_data_len);\n+            old_class_def[classCount].class_byte_count = class_data_len;\n+            classCount++;\n+        }\n+        if (!NSK_JVMTI_VERIFY(jvmti_env->RawMonitorExit(classLoadLock))) {\n@@ -113,1 +130,0 @@\n-            return;\n@@ -115,4 +131,0 @@\n-        memcpy((unsigned char*) old_class_def[classCount].class_bytes,\n-            class_data, class_data_len);\n-        old_class_def[classCount].class_byte_count = class_data_len;\n-        classCount++;\n@@ -437,0 +449,3 @@\n+    if (!NSK_JVMTI_VERIFY(jvmti->CreateRawMonitor(\"classLoadLock\", &classLoadLock)))\n+        return JNI_ERR;\n+\n","filename":"test\/hotspot\/jtreg\/vmTestbase\/nsk\/share\/jvmti\/hotswap\/HotSwap.cpp","additions":28,"deletions":13,"binary":false,"changes":41,"status":"modified"}]}