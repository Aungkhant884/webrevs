{"files":[{"patch":"@@ -399,7 +399,2 @@\n-      Thread *current = Thread::current();\n-      if (thread->is_handshake_safe_for(current)) {\n-        op.do_thread(thread);\n-      } else {\n-        Handshake::execute(&op, thread);\n-        guarantee(op.completed(), \"Handshake failed. Target thread is not alive?\");\n-      }\n+      Handshake::execute(&op, thread);\n+      guarantee(op.completed(), \"Handshake failed. Target thread is not alive?\");\n","filename":"src\/hotspot\/share\/prims\/jvmtiEnvThreadState.cpp","additions":2,"deletions":7,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -370,7 +370,3 @@\n-  if (target->is_handshake_safe_for(current)) {\n-    hs.do_thread(target);\n-  } else {\n-    assert(state->get_thread() != NULL, \"sanity check\");\n-    Handshake::execute(&hs, target);\n-    guarantee(hs.completed(), \"Handshake failed: Target thread is not alive?\");\n-  }\n+  assert(state->get_thread() != NULL, \"sanity check\");\n+  Handshake::execute(&hs, target);\n+  guarantee(hs.completed(), \"Handshake failed: Target thread is not alive?\");\n","filename":"src\/hotspot\/share\/prims\/jvmtiEventController.cpp","additions":3,"deletions":7,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -354,2 +354,1 @@\n-  JavaThread* self = JavaThread::current();\n-  HandshakeOperation op(hs_cl, target, Thread::current());\n+  guarantee(target != nullptr, \"must be\");\n@@ -357,1 +356,5 @@\n-  jlong start_time_ns = os::javaTimeNanos();\n+  JavaThread* current = JavaThread::current();\n+  if (target->is_handshake_safe_for(current)) {\n+    hs_cl->do_thread(target);\n+    return;\n+  }\n@@ -359,1 +362,3 @@\n-  guarantee(target != nullptr, \"must be\");\n+  HandshakeOperation op(hs_cl, target, current);\n+\n+  jlong start_time_ns = os::javaTimeNanos();\n@@ -392,1 +397,1 @@\n-    if (SafepointMechanism::should_process(self)) {\n+    if (SafepointMechanism::should_process(current)) {\n@@ -394,1 +399,1 @@\n-      ThreadBlockInVM tbivm(self);\n+      ThreadBlockInVM tbivm(current);\n","filename":"src\/hotspot\/share\/runtime\/handshake.cpp","additions":11,"deletions":6,"binary":false,"changes":17,"status":"modified"}]}