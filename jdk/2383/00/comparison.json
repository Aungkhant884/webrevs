{"files":[{"patch":"@@ -78,1 +78,1 @@\n-  _process_strong_tasks.all_tasks_completed(n_workers(), G1RP_PS_CodeCache_oops_do);\n+  _process_strong_tasks.all_tasks_completed(G1RP_PS_CodeCache_oops_do);\n@@ -109,2 +109,1 @@\n-  _process_strong_tasks.all_tasks_completed(n_workers(),\n-                                            G1RP_PS_CodeCache_oops_do,\n+  _process_strong_tasks.all_tasks_completed(G1RP_PS_CodeCache_oops_do,\n@@ -147,1 +146,1 @@\n-  _process_strong_tasks.all_tasks_completed(n_workers(), G1RP_PS_refProcessor_oops_do);\n+  _process_strong_tasks.all_tasks_completed(G1RP_PS_refProcessor_oops_do);\n","filename":"src\/hotspot\/share\/gc\/g1\/g1RootProcessor.cpp","additions":3,"deletions":4,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -355,1 +355,1 @@\n-  _tasks(NULL), _n_tasks(n), _threads_completed(0) {\n+  _tasks(NULL), _n_tasks(n) {\n@@ -357,1 +357,3 @@\n-  clear();\n+  for (uint i = 0; i < _n_tasks; i++) {\n+    _tasks[i] = false;\n+  }\n@@ -364,44 +366,0 @@\n-void SubTasksDone::clear() {\n-  for (uint i = 0; i < _n_tasks; i++) {\n-    _tasks[i] = false;\n-  }\n-  _threads_completed = 0;\n-}\n-\n-void SubTasksDone::all_tasks_completed_impl(uint n_threads,\n-                                            uint skipped[],\n-                                            size_t skipped_size) {\n-#ifdef ASSERT\n-  \/\/ all non-skipped tasks are claimed\n-  for (uint i = 0; i < _n_tasks; ++i) {\n-    if (!_tasks[i]) {\n-      auto is_skipped = false;\n-      for (size_t j = 0; j < skipped_size; ++j) {\n-        if (i == skipped[j]) {\n-          is_skipped = true;\n-          break;\n-        }\n-      }\n-      assert(is_skipped, \"%d not claimed.\", i);\n-    }\n-  }\n-  \/\/ all skipped tasks are *not* claimed\n-  for (size_t i = 0; i < skipped_size; ++i) {\n-    auto task_index = skipped[i];\n-    assert(task_index < _n_tasks, \"Array in range.\");\n-    assert(!_tasks[task_index], \"%d is both claimed and skipped.\", task_index);\n-  }\n-#endif\n-  uint observed = _threads_completed;\n-  uint old;\n-  do {\n-    old = observed;\n-    observed = Atomic::cmpxchg(&_threads_completed, old, old+1);\n-  } while (observed != old);\n-  \/\/ If this was the last thread checking in, clear the tasks.\n-  uint adjusted_thread_count = (n_threads == 0 ? 1 : n_threads);\n-  if (observed + 1 == adjusted_thread_count) {\n-    clear();\n-  }\n-}\n-\n@@ -414,0 +372,1 @@\n+  assert(_verification_done, \"all_tasks_completed must have been called.\");\n","filename":"src\/hotspot\/share\/gc\/shared\/workgroup.cpp","additions":5,"deletions":46,"binary":false,"changes":51,"status":"modified"},{"patch":"@@ -307,1 +307,0 @@\n-  volatile uint _threads_completed;\n@@ -309,4 +308,32 @@\n-  \/\/ Set all tasks to unclaimed.\n-  void clear();\n-\n-  void all_tasks_completed_impl(uint n_threads, uint skipped[], size_t skipped_size);\n+  \/\/ make sure verification logic is run only once\n+#ifdef ASSERT\n+  volatile bool _verification_done = false;\n+#endif\n+\n+  void all_tasks_completed_impl(uint skipped[], size_t skipped_size) {\n+#ifdef ASSERT\n+    if (Atomic::cmpxchg(&_verification_done, false, true)) {\n+      \/\/ another thread has done the verification\n+      return;\n+    }\n+    \/\/ all non-skipped tasks are claimed\n+    for (uint i = 0; i < _n_tasks; ++i) {\n+      if (!_tasks[i]) {\n+        auto is_skipped = false;\n+        for (size_t j = 0; j < skipped_size; ++j) {\n+          if (i == skipped[j]) {\n+            is_skipped = true;\n+            break;\n+          }\n+        }\n+        assert(is_skipped, \"%d not claimed.\", i);\n+      }\n+    }\n+    \/\/ all skipped tasks are *not* claimed\n+    for (size_t i = 0; i < skipped_size; ++i) {\n+      auto task_index = skipped[i];\n+      assert(task_index < _n_tasks, \"Array in range.\");\n+      assert(!_tasks[task_index], \"%d is both claimed and skipped.\", task_index);\n+    }\n+#endif\n+  }\n@@ -333,6 +360,3 @@\n-  \/\/ must execute this.  (When the last thread does so, the task array is\n-  \/\/ cleared.)\n-  \/\/\n-  \/\/ n_threads - Number of threads executing the sub-tasks.\n-  void all_tasks_completed(uint n_threads) {\n-    all_tasks_completed_impl(n_threads, nullptr, 0);\n+  \/\/ must execute this.\n+  void all_tasks_completed() {\n+    all_tasks_completed_impl(nullptr, 0);\n@@ -344,1 +368,1 @@\n-  void all_tasks_completed(uint n_threads, T0 first_skipped, Ts... more_skipped) {\n+  void all_tasks_completed(T0 first_skipped, Ts... more_skipped) {\n@@ -347,1 +371,1 @@\n-    all_tasks_completed_impl(n_threads, skipped, ARRAY_SIZE(skipped));\n+    all_tasks_completed_impl(skipped, ARRAY_SIZE(skipped));\n","filename":"src\/hotspot\/share\/gc\/shared\/workgroup.hpp","additions":37,"deletions":13,"binary":false,"changes":50,"status":"modified"},{"patch":"@@ -594,1 +594,1 @@\n-    _subtasks.all_tasks_completed(_num_workers);\n+    _subtasks.all_tasks_completed();\n","filename":"src\/hotspot\/share\/runtime\/safepoint.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}