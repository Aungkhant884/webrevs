{"files":[{"patch":"@@ -275,4 +275,4 @@\n-    bool is_locked = false;\n-    PretouchTaskCoordinator *task_coordinator = PretouchTaskCoordinator::get_task_coordinator();\n-    while (true) {\n-      if (UseMultithreadedPretouchForOldGen) {\n+    if (UseMultithreadedPretouchForOldGen) {\n+      bool is_locked = false;\n+      PretouchTaskCoordinator *task_coordinator = PretouchTaskCoordinator::get_task_coordinator();\n+      while (true) {\n@@ -280,12 +280,14 @@\n-      } else {\n-        FreeList_lock->lock();\n-        is_locked = true;\n-      }\n-      if (is_locked) {\n-        task_coordinator->release_set_task_notready();\n-        result = old_gc_alloc_region()->attempt_allocation_locked(min_word_size,\n-                                                              desired_word_size,\n-                                                              actual_word_size);\n-        task_coordinator->release_set_task_done();\n-        if (result == NULL) {\n-          set_old_full();\n+        if (is_locked) {\n+          task_coordinator->release_set_task_notready();\n+          result = old_gc_alloc_region()->attempt_allocation_locked(min_word_size,\n+                                                                desired_word_size,\n+                                                                actual_word_size);\n+          task_coordinator->release_set_task_done();\n+          if (result == NULL) {\n+            set_old_full();\n+          }\n+          FreeList_lock->unlock();\n+          break;\n+        } else {\n+          \/\/ Lets help expanding thread to pretouch the memory.\n+          task_coordinator->worker_wait_for_task();\n@@ -293,5 +295,8 @@\n-        FreeList_lock->unlock();\n-        break;\n-      } else {\n-        \/\/ Lets help expanding thread to pretouch the memory.\n-        task_coordinator->worker_wait_for_task();\n+      }\n+    } else {\n+      MutexLocker x(FreeList_lock, Mutex::_no_safepoint_check_flag);\n+      result = old_gc_alloc_region()->attempt_allocation_locked(min_word_size,\n+                                                                desired_word_size,\n+                                                                actual_word_size);\n+      if (result == NULL) {\n+        set_old_full();\n","filename":"src\/hotspot\/share\/gc\/g1\/g1Allocator.cpp","additions":26,"deletions":21,"binary":false,"changes":47,"status":"modified"}]}