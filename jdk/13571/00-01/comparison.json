{"files":[{"patch":"@@ -764,1 +764,1 @@\n-\/\/ AdjustStackSizeForGuardPages needs to be true.\n+\/\/ adjustStackSizeForGuardPages() needs to be true.\n@@ -770,10 +770,1 @@\n-GetMinStack _get_minstack_func = nullptr;\n-\n-static void get_minstack_init() {\n-  if (_get_minstack_func == nullptr) {\n-    _get_minstack_func =\n-      (GetMinStack)dlsym(RTLD_DEFAULT, \"__pthread_get_minstack\");\n-    log_info(os, thread)(\"Lookup of __pthread_get_minstack %s\",\n-                         _get_minstack_func == nullptr ? \"failed\" : \"succeeded\");\n-  }\n-}\n+GetMinStack _get_minstack_func = nullptr;  \/\/ Initialized via os::init_2()\n@@ -792,1 +783,1 @@\n-    \/\/ If AdjustStackSizeForGuardPages is true, minstack size includes\n+    \/\/ If adjustStackSizeForGuardPages() is true, minstack size includes\n@@ -823,1 +814,1 @@\n-\/\/ was not implemented properly. The posix standard requires adding\n+\/\/ was not implemented properly. The POSIX standard requires adding\n@@ -829,1 +820,11 @@\n-bool os::Linux::AdjustStackSizeForGuardPages = true;\n+static bool _adjustStackSizeForGuardPages = true;\n+bool os::Linux::adjustStackSizeForGuardPages() {\n+  return _adjustStackSizeForGuardPages;\n+}\n+\n+#ifdef __GLIBC__\n+static void init_adjust_stacksize_for_guard_pages() {\n+  assert(_get_minstack_func == nullptr, \"initialization error\");\n+  _get_minstack_func =(GetMinStack)dlsym(RTLD_DEFAULT, \"__pthread_get_minstack\");\n+  log_info(os, thread)(\"Lookup of __pthread_get_minstack %s\",\n+                       _get_minstack_func == nullptr ? \"failed\" : \"succeeded\");\n@@ -831,2 +832,0 @@\n-static void init_adjust_stack_for_guard_pages() {\n-  get_minstack_init();\n@@ -837,1 +836,2 @@\n-    pthread_attr_setguardsize(&attr, 16*K );\n+    size_t guard = 16 * K; \/\/ Actual value doesn't matter as it is not examined\n+    pthread_attr_setguardsize(&attr, guard);\n@@ -840,1 +840,1 @@\n-    \/\/ If the minimum stack size changed when we added the guard pages\n+    \/\/ If the minimum stack size changed when we added the guard page space\n@@ -842,3 +842,3 @@\n-    os::Linux::AdjustStackSizeForGuardPages = (min_stack2 - min_stack > 0);\n-    log_info(os)(\"- glibc stack size guard page adjustment is %sneeded\",\n-                 os::Linux::AdjustStackSizeForGuardPages ? \"\" : \"not \");\n+    _adjustStackSizeForGuardPages = (min_stack2 != min_stack);\n+    log_info(os)(\"Glibc stack size guard page adjustment is %sneeded\",\n+                 _adjustStackSizeForGuardPages ? \"\" : \"not \");\n@@ -847,0 +847,1 @@\n+#endif \/\/ GLIBC\n@@ -884,1 +885,1 @@\n-  } else if (os::Linux::AdjustStackSizeForGuardPages) {\n+  } else if (os::Linux::adjustStackSizeForGuardPages()) {\n@@ -1353,1 +1354,1 @@\n-  \/\/ If the fast Posix clocks are supported then the clock_getres()\n+  \/\/ If the fast POSIX clocks are supported then the clock_getres()\n@@ -4548,0 +4549,1 @@\n+#ifdef __GLIBC__\n@@ -4549,1 +4551,2 @@\n-  init_adjust_stack_for_guard_pages();\n+  init_adjust_stacksize_for_guard_pages();\n+#endif\n@@ -5270,1 +5273,1 @@\n-\/\/ ** If AdjustStackSizeForGuardPages is true the guard pages have been taken\n+\/\/ ** If adjustStackSizeForGuardPages() is true the guard pages have been taken\n@@ -5299,1 +5302,1 @@\n-    if (os::Linux::AdjustStackSizeForGuardPages) {\n+    if (os::Linux::adjustStackSizeForGuardPages()) {\n","filename":"src\/hotspot\/os\/linux\/os_linux.cpp","additions":29,"deletions":26,"binary":false,"changes":55,"status":"modified"},{"patch":"@@ -152,1 +152,1 @@\n-  static bool AdjustStackSizeForGuardPages; \/\/ See comments in os_linux.cpp\n+  static bool adjustStackSizeForGuardPages(); \/\/ See comments in os_linux.cpp\n","filename":"src\/hotspot\/os\/linux\/os_linux.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -909,1 +909,1 @@\n-  LINUX_ONLY(if (os::Linux::AdjustStackSizeForGuardPages) stack_size -= guard_size;)\n+  LINUX_ONLY(if (os::Linux::adjustStackSizeForGuardPages()) stack_size -= guard_size;)\n","filename":"src\/hotspot\/os\/posix\/os_posix.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}