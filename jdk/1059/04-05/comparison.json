{"files":[{"patch":"@@ -42,0 +42,1 @@\n+import java.util.function.BiPredicate;\n@@ -93,2 +94,3 @@\n-     * <p> Instances of {@code HttpRequest.Builder} are created by calling {@link\n-     * HttpRequest#newBuilder(URI)} or {@link HttpRequest#newBuilder()}.\n+     * <p> Instances of {@code HttpRequest.Builder} are created by calling\n+     * {@link HttpRequest#newBuilder()}, {@link HttpRequest#newBuilder(URI)},\n+     * or {@link HttpRequest#newBuilder(HttpRequest, BiPredicate)}.\n@@ -309,2 +311,5 @@\n-     * <p> This method can be used to build a new request equivalent to the\n-     * given request, but with some parts of its state altered.\n+     * This method returns a {@code Builder} whose state is copied from the\n+     * given request, subject to the given filter. This builder can be used to\n+     * build an {@code HttpRequest}, equivalent to the original, while allowing\n+     * amendment of the request state prior to construction - for example,\n+     * adding additional headers.\n@@ -312,1 +317,22 @@\n-     * @param request the request\n+     * <p> The {@code filter} is applied to each header name value pair as they\n+     * are copied from the given request. When completed, only headers that\n+     * satisfy the condition as laid out by the {@code filter} will be present\n+     * in the {@code Builder} returned from this method.\n+     *\n+     * @apiNote\n+     * The following scenarios demonstrate typical use-cases of the filter.\n+     * Given an {@code HttpRequest} <em>request<\/em>:\n+     * <br><br>\n+     * <ul>\n+     *  <li> Retain all headers:\n+     *  <pre>{@code HttpRequest.newBuilder(request, (n, v) -> true)}<\/pre>\n+     *\n+     *  <li> Remove all headers:\n+     *  <pre>{@code HttpRequest.newBuilder(request, (n, v) -> false)}<\/pre>\n+     *\n+     *  <li> Remove a particular header (e.g. Foo-Bar):\n+     *  <pre>{@code HttpRequest.newBuilder(request, (name, value) -> name.equalsIgnoreCase(\"Foo-Bar\"))}<\/pre>\n+     * <\/ul>\n+     *\n+     * @param request the original request\n+     * @param filter a header filter\n@@ -319,1 +345,1 @@\n-    public static Builder newBuilder(HttpRequest request) {\n+    public static Builder newBuilder(HttpRequest request, BiPredicate<String, String> filter) {\n@@ -321,0 +347,1 @@\n+        Objects.requireNonNull(filter);\n@@ -325,1 +352,5 @@\n-        request.headers().map().forEach((name, values) -> values.forEach(value -> builder.header(name, value)));\n+\n+        \/\/ Filter unwanted headers\n+        HttpHeaders headers = HttpHeaders.of(request.headers().map(), filter);\n+        headers.map().forEach((name, values) ->\n+                values.forEach(value -> builder.header(name, value)));\n","filename":"src\/java.net.http\/share\/classes\/java\/net\/http\/HttpRequest.java","additions":38,"deletions":7,"binary":false,"changes":45,"status":"modified"},{"patch":"@@ -29,1 +29,0 @@\n-import java.net.http.HttpResponse;\n@@ -35,0 +34,1 @@\n+import java.util.Iterator;\n@@ -40,0 +40,2 @@\n+import java.util.function.BiPredicate;\n+\n@@ -42,0 +44,1 @@\n+import static java.nio.charset.StandardCharsets.UTF_8;\n@@ -46,1 +49,0 @@\n-import static java.nio.charset.StandardCharsets.UTF_8;\n@@ -60,48 +62,55 @@\n-   static final Class<NullPointerException> NPE = NullPointerException.class;\n-   static final Class<IllegalArgumentException> IAE = IllegalArgumentException.class;\n-\n-   record NamedAssertion (String name, BiConsumer<HttpRequest,HttpRequest> test) { }\n-   List<NamedAssertion> REQUEST_ASSERTIONS = List.of(\n-           new NamedAssertion(\"uri\",            (r1,r2) -> assertEquals(r1.uri(), r2.uri())),\n-           new NamedAssertion(\"timeout\",        (r1,r2) -> assertEquals(r1.timeout(), r2.timeout())),\n-           new NamedAssertion(\"version\",        (r1,r2) -> assertEquals(r1.version(), r2.version())),\n-           new NamedAssertion(\"headers\",        (r1,r2) -> assertEquals(r1.headers(), r2.headers())),\n-           new NamedAssertion(\"expectContinue\", (r1,r2) -> assertEquals(r1.expectContinue(), r2.expectContinue())),\n-           new NamedAssertion(\"method\",  (r1,r2) -> {\n-               assertEquals(r1.method(), r2.method());\n-               assertBodyPublisherEqual(r1, r2);\n-           })\n-   );\n-\n-   @DataProvider(name = \"testRequests\")\n-   public Object[][] variants() {\n-       return new Object[][]{\n-               { HttpRequest.newBuilder(URI.create(\"https:\/\/a\/\")).build() },\n-               { HttpRequest.newBuilder(URI.create(\"https:\/\/b\/\")).version(HTTP_1_1).build() },\n-               { HttpRequest.newBuilder(URI.create(\"https:\/\/c\/\")).version(HTTP_2).build() },\n-\n-               { HttpRequest.newBuilder(URI.create(\"https:\/\/d\/\")).timeout(Duration.ofSeconds(30)).build() },\n-               { HttpRequest.newBuilder(URI.create(\"https:\/\/e\/\")).header(\"testName\", \"testValue\").build() },\n-               \/\/ dedicated method\n-               { HttpRequest.newBuilder(URI.create(\"https:\/\/f\/\")).GET().build() },\n-               { HttpRequest.newBuilder(URI.create(\"https:\/\/g\/\")).DELETE().build() },\n-               { HttpRequest.newBuilder(URI.create(\"https:\/\/h\/\")).POST(HttpRequest.BodyPublishers.ofString(\"testData\")).build() },\n-               { HttpRequest.newBuilder(URI.create(\"https:\/\/i\/\")).PUT(HttpRequest.BodyPublishers.ofString(\"testData\")).build() },\n-               \/\/ method w\/body\n-               { HttpRequest.newBuilder(URI.create(\"https:\/\/j\/\")).method(\"GET\", HttpRequest.BodyPublishers.ofString(\"testData\")).build() },\n-               { HttpRequest.newBuilder(URI.create(\"https:\/\/k\/\")).method(\"DELETE\", HttpRequest.BodyPublishers.ofString(\"testData\")).build() },\n-               { HttpRequest.newBuilder(URI.create(\"https:\/\/l\/\")).method(\"POST\", HttpRequest.BodyPublishers.ofString(\"testData\")).build() },\n-               { HttpRequest.newBuilder(URI.create(\"https:\/\/m\/\")).method(\"PUT\", HttpRequest.BodyPublishers.ofString(\"testData\")).build() },\n-               \/\/ method w\/o body\n-               { HttpRequest.newBuilder(URI.create(\"https:\/\/n\/\")).method(\"GET\", HttpRequest.BodyPublishers.noBody()).build() },\n-               { HttpRequest.newBuilder(URI.create(\"https:\/\/o\/\")).method(\"DELETE\", HttpRequest.BodyPublishers.noBody()).build() },\n-               { HttpRequest.newBuilder(URI.create(\"https:\/\/p\/\")).method(\"POST\", HttpRequest.BodyPublishers.noBody()).build() },\n-               { HttpRequest.newBuilder(URI.create(\"https:\/\/q\/\")).method(\"PUT\", HttpRequest.BodyPublishers.noBody()).build() },\n-               \/\/ user defined methods w\/ & w\/o body\n-               { HttpRequest.newBuilder(URI.create(\"https:\/\/r\/\")).method(\"TEST\", HttpRequest.BodyPublishers.noBody()).build() },\n-               { HttpRequest.newBuilder(URI.create(\"https:\/\/s\/\")).method(\"TEST\", HttpRequest.BodyPublishers.ofString(\"testData\")).build() },\n-\n-               { HttpRequest.newBuilder(URI.create(\"https:\/\/z\/\")).GET().expectContinue(true).version(HTTP_2)\n-                       .timeout(Duration.ofSeconds(1)).header(\"testName\", \"testValue\").build() },\n-       };\n-   }\n+    static final Class<NullPointerException> NPE = NullPointerException.class;\n+    static final Class<IllegalArgumentException> IAE = IllegalArgumentException.class;\n+\n+    record NamedAssertion(String name, BiConsumer<HttpRequest, HttpRequest> test) { }\n+\n+    List<NamedAssertion> REQUEST_ASSERTIONS = List.of(\n+            new NamedAssertion(\"uri\", (r1, r2) -> assertEquals(r1.uri(), r2.uri())),\n+            new NamedAssertion(\"timeout\", (r1, r2) -> assertEquals(r1.timeout(), r2.timeout())),\n+            new NamedAssertion(\"version\", (r1, r2) -> assertEquals(r1.version(), r2.version())),\n+            new NamedAssertion(\"headers\", (r1, r2) -> assertEquals(r1.headers(), r2.headers())),\n+            new NamedAssertion(\"expectContinue\", (r1, r2) -> assertEquals(r1.expectContinue(), r2.expectContinue())),\n+            new NamedAssertion(\"method\", (r1, r2) -> {\n+                assertEquals(r1.method(), r2.method());\n+                assertBodyPublisherEqual(r1, r2);\n+            })\n+    );\n+\n+    @DataProvider(name = \"testRequests\")\n+    public Object[][] variants() {\n+        return new Object[][]{\n+                { HttpRequest.newBuilder(URI.create(\"https:\/\/uri-1\/\")).build() },\n+                { HttpRequest.newBuilder(URI.create(\"https:\/\/version-1\/\")).version(HTTP_1_1).build() },\n+                { HttpRequest.newBuilder(URI.create(\"https:\/\/version-2\/\")).version(HTTP_2).build() },\n+                { HttpRequest.newBuilder(URI.create(\"https:\/\/timeout-1\/\")).timeout(Duration.ofSeconds(30)).build() },\n+                { HttpRequest.newBuilder(URI.create(\"https:\/\/header-1\/\")).header(\"testName\", \"testValue\").build() },\n+                { HttpRequest.newBuilder(URI.create(\"https:\/\/header-2\/\"))\n+                        .headers(\"testName\", \"testValue\", \"a\", \"1\", \"b\", \"2\").build() },\n+                { HttpRequest.newBuilder(URI.create(\"https:\/\/header-3\/\"))\n+                        .setHeader(\"testName\", \"testValue\")\n+                        .setHeader(\"testName\", \"x\")\n+                        .setHeader(\"testName\", \"y\")\n+                        .setHeader(\"testName\", \"z\").build() },\n+                \/\/ dedicated method\n+                { HttpRequest.newBuilder(URI.create(\"https:\/\/method-1\/\")).GET().build() },\n+                { HttpRequest.newBuilder(URI.create(\"https:\/\/method-2\/\")).DELETE().build() },\n+                { HttpRequest.newBuilder(URI.create(\"https:\/\/method-3\/\")).POST(HttpRequest.BodyPublishers.ofString(\"testData\")).build() },\n+                { HttpRequest.newBuilder(URI.create(\"https:\/\/method-4\/\")).PUT(HttpRequest.BodyPublishers.ofString(\"testData\")).build() },\n+                \/\/ method w\/body\n+                { HttpRequest.newBuilder(URI.create(\"https:\/\/method-5\/\")).method(\"GET\", HttpRequest.BodyPublishers.ofString(\"testData\")).build() },\n+                { HttpRequest.newBuilder(URI.create(\"https:\/\/method-6\/\")).method(\"DELETE\", HttpRequest.BodyPublishers.ofString(\"testData\")).build() },\n+                { HttpRequest.newBuilder(URI.create(\"https:\/\/method-7\/\")).method(\"POST\", HttpRequest.BodyPublishers.ofString(\"testData\")).build() },\n+                { HttpRequest.newBuilder(URI.create(\"https:\/\/method-8\/\")).method(\"PUT\", HttpRequest.BodyPublishers.ofString(\"testData\")).build() },\n+                \/\/ method w\/o body\n+                { HttpRequest.newBuilder(URI.create(\"https:\/\/method-9\/\")).method(\"GET\", HttpRequest.BodyPublishers.noBody()).build() },\n+                { HttpRequest.newBuilder(URI.create(\"https:\/\/method-10\/\")).method(\"DELETE\", HttpRequest.BodyPublishers.noBody()).build() },\n+                { HttpRequest.newBuilder(URI.create(\"https:\/\/method-11\/\")).method(\"POST\", HttpRequest.BodyPublishers.noBody()).build() },\n+                { HttpRequest.newBuilder(URI.create(\"https:\/\/method-12\/\")).method(\"PUT\", HttpRequest.BodyPublishers.noBody()).build() },\n+                \/\/ user defined methods w\/ & w\/o body\n+                { HttpRequest.newBuilder(URI.create(\"https:\/\/method-13\/\")).method(\"TEST\", HttpRequest.BodyPublishers.noBody()).build() },\n+                { HttpRequest.newBuilder(URI.create(\"https:\/\/method-14\/\")).method(\"TEST\", HttpRequest.BodyPublishers.ofString(\"testData\")).build() },\n+\n+                { HttpRequest.newBuilder(URI.create(\"https:\/\/all-fields-1\/\")).GET().expectContinue(true).version(HTTP_2)\n+                        .timeout(Duration.ofSeconds(1)).header(\"testName\", \"testValue\").build() },\n+        };\n+    }\n@@ -109,0 +118,1 @@\n+    \/\/ test methods\n@@ -132,1 +142,1 @@\n-            var x1 = bs1.getBody().toCompletableFuture().join().getBytes();\n+            var b1 = bs1.getBody().toCompletableFuture().join().getBytes();\n@@ -136,1 +146,1 @@\n-            var x2 = bs2.getBody().toCompletableFuture().join().getBytes();\n+            var b2 = bs2.getBody().toCompletableFuture().join().getBytes();\n@@ -138,1 +148,1 @@\n-            assertEquals(x1, x2);\n+            assertEquals(b1, b2);\n@@ -144,174 +154,236 @@\n-   void assertAllOtherElementsEqual(HttpRequest r1, HttpRequest r2, String... except) {\n-       var ignoreList = Arrays.asList(except);\n-       REQUEST_ASSERTIONS.stream()\n-               .filter(a -> !ignoreList.contains(a.name()))\n-               .forEach(testCaseAssertion -> testCaseAssertion.test().accept(r1, r2));\n-   }\n-\n-   void testBodyPublisher(String methodName, HttpRequest request) {\n-       \/\/ method w\/body\n-       var r = HttpRequest.newBuilder(request)\n-               .method(methodName, HttpRequest.BodyPublishers.ofString(\"testData\"))\n-               .build();\n-       assertEquals(r.method(), methodName);\n-       assertTrue(r.bodyPublisher().isPresent());\n-       assertEquals(r.bodyPublisher().get().contentLength(), 8);\n-       assertAllOtherElementsEqual(r, request, \"method\");\n-\n-       \/\/ method w\/o body\n-       var noBodyPublisher = HttpRequest.BodyPublishers.noBody();\n-       var r1 = HttpRequest.newBuilder(request)\n-               .method(methodName, noBodyPublisher)\n-               .build();\n-       assertEquals(r1.method(), methodName);\n-       assertTrue(r1.bodyPublisher().isPresent());\n-       assertEquals(r1.bodyPublisher().get(), noBodyPublisher);\n-       assertAllOtherElementsEqual(r1, request, \"method\");\n-   }\n-\n-   @Test\n-   public void testNull() {\n-       HttpRequest request = null;\n-       assertThrows(NPE, () -> HttpRequest.newBuilder(request).build());\n-   }\n-\n-   @Test(dataProvider = \"testRequests\")\n-   void testBuilder(HttpRequest request) {\n-       var r = HttpRequest.newBuilder(request).build();\n-       assertEquals(r, request);\n-       assertAllOtherElementsEqual(r, request);\n-   }\n-\n-   @Test(dataProvider = \"testRequests\")\n-   public void testURI(HttpRequest request) {\n-       URI newURI = URI.create(\"http:\/\/www.newURI.com\/\");\n-       var r = HttpRequest.newBuilder(request).uri(newURI).build();\n-\n-       assertEquals(r.uri(), newURI);\n-       assertAllOtherElementsEqual(r, request, \"uri\");\n-   }\n-\n-   @Test(dataProvider = \"testRequests\")\n-   public void testHeaders(HttpRequest request) {\n-       var r = HttpRequest.newBuilder(request).headers(\"newName\", \"newValue\").build();\n-\n-       assertEquals(r.headers().firstValue(\"newName\").get(), \"newValue\");\n-       assertEquals(r.headers().allValues(\"newName\").size(), 1);\n-       assertAllOtherElementsEqual(r, request, \"headers\");\n-   }\n-\n-   @Test(dataProvider = \"testRequests\")\n-   public void testTimeout(HttpRequest request) {\n-       var r = HttpRequest.newBuilder(request).timeout(Duration.ofSeconds(2)).build();\n-\n-       assertEquals(r.timeout().get().getSeconds(), 2);\n-       assertAllOtherElementsEqual(r, request, \"timeout\");\n-   }\n-\n-   @Test(dataProvider = \"testRequests\")\n-   public void testVersion(HttpRequest request) {\n-       var r = HttpRequest.newBuilder(request).version(HTTP_1_1).build();\n-\n-       assertEquals(r.version().get(), HTTP_1_1);\n-       assertAllOtherElementsEqual(r, request, \"version\");\n-   }\n-\n-   @Test(dataProvider = \"testRequests\")\n-   public void testGET(HttpRequest request) {\n-       var r = HttpRequest.newBuilder(request)\n-               .GET()\n-               .build();\n-       assertEquals(r.method(), \"GET\");\n-       assertTrue(r.bodyPublisher().isEmpty());\n-       assertAllOtherElementsEqual(r, request, \"method\");\n-\n-       testBodyPublisher(\"GET\", request);\n-   }\n-\n-   @Test(dataProvider = \"testRequests\")\n-   public void testDELETE(HttpRequest request) {\n-       var r = HttpRequest.newBuilder(request)\n-               .DELETE()\n-               .build();\n-       assertEquals(r.method(), \"DELETE\");\n-       assertTrue(r.bodyPublisher().isEmpty());\n-       assertAllOtherElementsEqual(r, request, \"method\");\n-\n-       testBodyPublisher(\"DELETE\", request);\n-   }\n-\n-   @Test(dataProvider = \"testRequests\")\n-   public void testPOST(HttpRequest request) {\n-       var r = HttpRequest.newBuilder(request)\n-               .POST(HttpRequest.BodyPublishers.ofString(\"testData\"))\n-               .build();\n-       assertEquals(r.method(), \"POST\");\n-       assertTrue(r.bodyPublisher().isPresent());\n-       assertEquals(r.bodyPublisher().get().contentLength(), 8);\n-       assertAllOtherElementsEqual(r, request, \"method\");\n-\n-       testBodyPublisher(\"POST\", request);\n-   }\n-\n-   @Test(dataProvider = \"testRequests\")\n-   public void testPUT(HttpRequest request) {\n-       var r = HttpRequest.newBuilder(request)\n-               .PUT(HttpRequest.BodyPublishers.ofString(\"testData\"))\n-               .build();\n-       assertEquals(r.method(), \"PUT\");\n-       assertTrue(r.bodyPublisher().isPresent());\n-       assertEquals(r.bodyPublisher().get().contentLength(), 8);\n-       assertAllOtherElementsEqual(r, request, \"method\");\n-\n-       testBodyPublisher(\"PUT\", request);\n-   }\n-\n-   @Test(dataProvider = \"testRequests\")\n-   public void testUserDefinedMethod(HttpRequest request) {\n-       testBodyPublisher(\"TEST\", request);\n-   }\n-\n-   @Test\n-   public void testInvalidMethod() throws URISyntaxException {\n-       URI testURI = new URI(\"http:\/\/www.foo.com\/\");\n-       var r = new HttpRequest() {\n-           @Override\n-           public Optional<BodyPublisher> bodyPublisher() { return Optional.empty(); }\n-           @Override\n-           public String method() { return \"CONNECT\"; }\n-           @Override\n-           public Optional<Duration> timeout() { return Optional.empty(); }\n-           @Override\n-           public boolean expectContinue() { return false; }\n-           @Override\n-           public URI uri() { return testURI; }\n-           @Override\n-           public Optional<Version> version() { return Optional.empty(); }\n-           @Override\n-           public HttpHeaders headers() { return HttpHeaders.of(Map.of(), (x,y) -> true); }\n-       };\n-       assertThrows(IAE, () -> HttpRequest.newBuilder(r).build());\n-   }\n-\n-   @Test\n-   public void testInvalidURI() throws URISyntaxException {\n-       \/\/ invalid URI scheme\n-       URI badURI = new URI(\"ftp:\/\/foo.com\/somefile\");\n-       var r = new HttpRequest() {\n-           @Override\n-           public Optional<BodyPublisher> bodyPublisher() { return Optional.empty(); }\n-           @Override\n-           public String method() { return \"GET\"; }\n-           @Override\n-           public Optional<Duration> timeout() { return Optional.empty(); }\n-           @Override\n-           public boolean expectContinue() { return false; }\n-           @Override\n-           public URI uri() { return badURI; }\n-           @Override\n-           public Optional<Version> version() { return Optional.empty(); }\n-           @Override\n-           public HttpHeaders headers() { return HttpHeaders.of(Map.of(), (x,y) -> true); }\n-       };\n-       assertThrows(IAE, () -> HttpRequest.newBuilder(r).build());\n-   }\n+    void assertHeadersEquals(HttpRequest r1, HttpRequest r2, BiPredicate<String, String> filter) {\n+        var s1 = r1.headers().map().entrySet().stream();\n+        var s2 = r2.headers()\n+                .map()\n+                .entrySet()\n+                .stream()\n+                .filter(e -> {\n+                    var n = e.getKey();\n+                    for (var v : e.getValue()) {\n+                        if (filter.test(n, v))\n+                            return true;\n+                    }\n+                    return false;\n+                });\n+        Iterator<?> iter1 = s1.iterator(), iter2 = s2.iterator();\n+        while (iter1.hasNext() && iter2.hasNext())\n+            assertEquals(iter1.next(), iter2.next());\n+    }\n+\n+    void assertAllOtherElementsEqual(HttpRequest r1, HttpRequest r2, String... except) {\n+        var ignoreList = Arrays.asList(except);\n+        REQUEST_ASSERTIONS.stream()\n+                .filter(a -> !ignoreList.contains(a.name()))\n+                .forEach(testCaseAssertion -> testCaseAssertion.test().accept(r1, r2));\n+    }\n+\n+    void testBodyPublisher(String methodName, HttpRequest request) {\n+        \/\/ method w\/body\n+        var r = HttpRequest.newBuilder(request, (n, v) -> true)\n+                .method(methodName, HttpRequest.BodyPublishers.ofString(\"testData\"))\n+                .build();\n+        assertEquals(r.method(), methodName);\n+        assertTrue(r.bodyPublisher().isPresent());\n+        assertEquals(r.bodyPublisher().get().contentLength(), 8);\n+        assertAllOtherElementsEqual(r, request, \"method\");\n+\n+        \/\/ method w\/o body\n+        var noBodyPublisher = HttpRequest.BodyPublishers.noBody();\n+        var r1 = HttpRequest.newBuilder(request, (n, v) -> true)\n+                .method(methodName, noBodyPublisher)\n+                .build();\n+        assertEquals(r1.method(), methodName);\n+        assertTrue(r1.bodyPublisher().isPresent());\n+        assertEquals(r1.bodyPublisher().get(), noBodyPublisher);\n+        assertAllOtherElementsEqual(r1, request, \"method\");\n+    }\n+\n+    @Test\n+    public void testNull() {\n+        var r = HttpRequest.newBuilder(URI.create(\"https:\/\/foobar\/\")).build();\n+        assertThrows(NPE, () -> HttpRequest.newBuilder(r, null));\n+        assertThrows(NPE, () -> HttpRequest.newBuilder(null, (n, v) -> true));\n+        assertThrows(NPE, () -> HttpRequest.newBuilder(null, null));\n+    }\n+\n+    @Test(dataProvider = \"testRequests\")\n+    void testBuilder(HttpRequest request) {\n+        var r = HttpRequest.newBuilder(request, (n, v) -> true).build();\n+        assertEquals(r, request);\n+        assertAllOtherElementsEqual(r, request);\n+    }\n+\n+    @Test(dataProvider = \"testRequests\")\n+    public void testURI(HttpRequest request) {\n+        URI newURI = URI.create(\"http:\/\/www.newURI.com\/\");\n+        var r = HttpRequest.newBuilder(request, (n, v) -> true).uri(newURI).build();\n+\n+        assertEquals(r.uri(), newURI);\n+        assertAllOtherElementsEqual(r, request, \"uri\");\n+    }\n+\n+    @Test(dataProvider = \"testRequests\")\n+    public void testTimeout(HttpRequest request) {\n+        var r = HttpRequest.newBuilder(request, (n, v) -> true).timeout(Duration.ofSeconds(2)).build();\n+\n+        assertEquals(r.timeout().get().getSeconds(), 2);\n+        assertAllOtherElementsEqual(r, request, \"timeout\");\n+    }\n+\n+    @Test(dataProvider = \"testRequests\")\n+    public void testVersion(HttpRequest request) {\n+        var r = HttpRequest.newBuilder(request, (n, v) -> true).version(HTTP_1_1).build();\n+\n+        assertEquals(r.version().get(), HTTP_1_1);\n+        assertAllOtherElementsEqual(r, request, \"version\");\n+    }\n+\n+    @Test(dataProvider = \"testRequests\")\n+    public void testGET(HttpRequest request) {\n+        var r = HttpRequest.newBuilder(request, (n, v) -> true)\n+                .GET()\n+                .build();\n+        assertEquals(r.method(), \"GET\");\n+        assertTrue(r.bodyPublisher().isEmpty());\n+        assertAllOtherElementsEqual(r, request, \"method\");\n+\n+        testBodyPublisher(\"GET\", request);\n+    }\n+\n+    @Test(dataProvider = \"testRequests\")\n+    public void testDELETE(HttpRequest request) {\n+        var r = HttpRequest.newBuilder(request, (n, v) -> true)\n+                .DELETE()\n+                .build();\n+        assertEquals(r.method(), \"DELETE\");\n+        assertTrue(r.bodyPublisher().isEmpty());\n+        assertAllOtherElementsEqual(r, request, \"method\");\n+\n+        testBodyPublisher(\"DELETE\", request);\n+    }\n+\n+    @Test(dataProvider = \"testRequests\")\n+    public void testPOST(HttpRequest request) {\n+        var r = HttpRequest.newBuilder(request, (n, v) -> true)\n+                .POST(HttpRequest.BodyPublishers.ofString(\"testData\"))\n+                .build();\n+        assertEquals(r.method(), \"POST\");\n+        assertTrue(r.bodyPublisher().isPresent());\n+        assertEquals(r.bodyPublisher().get().contentLength(), 8);\n+        assertAllOtherElementsEqual(r, request, \"method\");\n+\n+        testBodyPublisher(\"POST\", request);\n+    }\n+\n+    @Test(dataProvider = \"testRequests\")\n+    public void testPUT(HttpRequest request) {\n+        var r = HttpRequest.newBuilder(request, (n, v) -> true)\n+                .PUT(HttpRequest.BodyPublishers.ofString(\"testData\"))\n+                .build();\n+        assertEquals(r.method(), \"PUT\");\n+        assertTrue(r.bodyPublisher().isPresent());\n+        assertEquals(r.bodyPublisher().get().contentLength(), 8);\n+        assertAllOtherElementsEqual(r, request, \"method\");\n+\n+        testBodyPublisher(\"PUT\", request);\n+    }\n+\n+    @Test(dataProvider = \"testRequests\")\n+    public void testUserDefinedMethod(HttpRequest request) {\n+        testBodyPublisher(\"TEST\", request);\n+    }\n+\n+    @Test(dataProvider = \"testRequests\")\n+    public void testHeaders(HttpRequest request) {\n+        BiPredicate<String, String> filter = (n, v) -> true;\n+        var r = HttpRequest.newBuilder(request, filter).headers(\"newName\", \"newValue\").build();\n+\n+        assertEquals(r.headers().firstValue(\"newName\").get(), \"newValue\");\n+        assertEquals(r.headers().allValues(\"newName\").size(), 1);\n+        assertAllOtherElementsEqual(r, request, \"headers\");\n+    }\n+\n+    @Test(dataProvider = \"testRequests\")\n+    public void testRemoveHeader(HttpRequest request) {\n+        BiPredicate<String, String> filter = (n, v) -> !n.equalsIgnoreCase(\"testName\");\n+\n+        var r = HttpRequest.newBuilder(request, filter).build();\n+        assertFalse(r.headers().map().containsKey(\"testName\"));\n+        assertHeadersEquals(r, request, filter);\n+    }\n+\n+    @Test(dataProvider = \"testRequests\")\n+    public void testRemoveSingleHeaderValue(HttpRequest request) {\n+        BiPredicate<String, String> filter = (n, v) ->\n+                n.equalsIgnoreCase(\"testName\") && !v.equalsIgnoreCase(\"testValue\");\n+\n+        var r = HttpRequest.newBuilder(request, filter).build();\n+        assertFalse(r.headers().map().containsValue(\"testValue\"));\n+        assertHeadersEquals(r, request, filter);\n+    }\n+\n+    @Test(dataProvider = \"testRequests\")\n+    public void testRemoveAllHeaders(HttpRequest request) {\n+        if (!request.headers().map().isEmpty()) {\n+            BiPredicate<String, String> filter = (n, v) -> false;\n+            var r = HttpRequest.newBuilder(request, filter).build();\n+\n+            assertTrue(r.headers().map().isEmpty());\n+            assertHeadersEquals(r, request, filter);\n+        }\n+    }\n+\n+    @Test(dataProvider = \"testRequests\")\n+    public void testRetainAllHeaders(HttpRequest request) {\n+        if (!request.headers().map().isEmpty()) {\n+            BiPredicate<String, String> filter = (n, v) -> true;\n+            var r = HttpRequest.newBuilder(request, filter).build();\n+\n+            assertFalse(r.headers().map().isEmpty());\n+            assertHeadersEquals(r, request, filter);\n+        }\n+    }\n+\n+    @Test\n+    public void testInvalidMethod() throws URISyntaxException {\n+        URI testURI = new URI(\"http:\/\/www.foo.com\/\");\n+        var r = new HttpRequest() {\n+            @Override\n+            public Optional<BodyPublisher> bodyPublisher() { return Optional.empty(); }\n+            @Override\n+            public String method() { return \"CONNECT\"; }\n+            @Override\n+            public Optional<Duration> timeout() { return Optional.empty(); }\n+            @Override\n+            public boolean expectContinue() { return false; }\n+            @Override\n+            public URI uri() { return testURI; }\n+            @Override\n+            public Optional<Version> version() { return Optional.empty(); }\n+            @Override\n+            public HttpHeaders headers() { return HttpHeaders.of(Map.of(), (n, v) -> true); }\n+        };\n+        assertThrows(IAE, () -> HttpRequest.newBuilder(r, (n, v) -> true).build());\n+    }\n+\n+    @Test\n+    public void testInvalidURIScheme() throws URISyntaxException {\n+        URI badURI = new URI(\"ftp:\/\/foo.com\/somefile\");\n+        var r = new HttpRequest() {\n+            @Override\n+            public Optional<BodyPublisher> bodyPublisher() { return Optional.empty(); }\n+            @Override\n+            public String method() { return \"GET\"; }\n+            @Override\n+            public Optional<Duration> timeout() { return Optional.empty(); }\n+            @Override\n+            public boolean expectContinue() { return false; }\n+            @Override\n+            public URI uri() { return badURI; }\n+            @Override\n+            public Optional<Version> version() { return Optional.empty(); }\n+            @Override\n+            public HttpHeaders headers() { return HttpHeaders.of(Map.of(), (n, v) -> true); }\n+        };\n+        assertThrows(IAE, () -> HttpRequest.newBuilder(r, (n, v) -> true).build());\n+    }\n","filename":"test\/jdk\/java\/net\/httpclient\/HttpRequestNewBuilderTest.java","additions":299,"deletions":227,"binary":false,"changes":526,"status":"modified"},{"patch":"@@ -122,0 +122,12 @@\n+\n+        \/\/ HttpRequest.Builder\n+        \/\/ API note - newBuilder(HttpRequest, BiPredicate<String, String>)\n+        \/\/ Retain all headers:\n+        HttpRequest.newBuilder(request, (n, v) -> true);\n+\n+        \/\/Remove all headers:\n+        HttpRequest.newBuilder(request, (n, v) -> false);\n+\n+        \/\/ Remove a particular header (e.g. Foo-Bar):\n+        HttpRequest.newBuilder(request, (name, value) ->\n+                name.equalsIgnoreCase(\"Foo-Bar\"));\n","filename":"test\/jdk\/java\/net\/httpclient\/examples\/JavadocExamples.java","additions":12,"deletions":0,"binary":false,"changes":12,"status":"modified"}]}