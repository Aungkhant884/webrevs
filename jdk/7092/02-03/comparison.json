{"files":[{"patch":"@@ -42,0 +42,1 @@\n+        private T strongReferent;\n@@ -46,0 +47,1 @@\n+            this.strongReferent = referent;\n@@ -51,0 +53,11 @@\n+\n+        T getStrong() {\n+            return strongReferent;\n+        }\n+\n+        void clearStrong() {\n+            \/\/ Do a conditional store, in case this is a MT write.\n+            if (strongReferent != null) {\n+                strongReferent = null;\n+            }\n+        }\n@@ -54,1 +67,1 @@\n-    private final ClassValue<SoftReference<T>> map;\n+    private final ClassValue<CacheRef<T>> map;\n@@ -62,1 +75,1 @@\n-            protected SoftReference<T> computeValue(Class<?> type) {\n+            protected CacheRef<T> computeValue(Class<?> type) {\n@@ -71,2 +84,1 @@\n-        T val;\n-        do {\n+        while (true) {\n@@ -74,4 +86,18 @@\n-            SoftReference<T> ref = map.get(cl);\n-            val = ref.get();\n-            if (val == null) {\n-                map.remove(cl);\n+\n+            CacheRef<T> ref = map.get(cl);\n+\n+            \/\/ Case 1: A recently created CacheRef.\n+            \/\/ We might still have strong referent, and can return it.\n+            \/\/ This guarantees progress for at least one thread on every CacheRef.\n+            \/\/ Clear the strong referent before returning to make the cache soft.\n+            T strongVal = ref.getStrong();\n+            if (strongVal != null) {\n+                ref.clearStrong();\n+                return strongVal;\n+            }\n+\n+            \/\/ Case 2: Older or recently cleared CacheRef.\n+            \/\/ Check if its soft referent is still available, and return it.\n+            T val = ref.get();\n+            if (val != null) {\n+                return val;\n@@ -79,2 +105,5 @@\n-        } while (val == null);\n-        return val;\n+\n+            \/\/ Case 3: The reference was cleared.\n+            \/\/ Clear the mapping and retry.\n+            map.remove(cl);\n+        }\n","filename":"src\/java.base\/share\/classes\/java\/io\/ClassCache.java","additions":39,"deletions":10,"binary":false,"changes":49,"status":"modified"}]}