{"files":[{"patch":"@@ -38,0 +38,3 @@\n+size_t PSCardTable::stripe_size_in_words;\n+size_t PSCardTable::large_obj_arr_min_words;\n+\n@@ -192,1 +195,1 @@\n-    assert(!obj->is_objArray() || obj->size() < large_obj_arr_min_words(), \"inv\");\n+    assert(!obj->is_objArray() || obj->size() < large_obj_arr_min_words, \"inv\");\n@@ -200,0 +203,10 @@\n+void PSCardTable::prepare_scavenge(int active_workers, size_t old_gen_used_words) {\n+  const int stripe_count_per_worker = 100;\n+  int stripe_count = active_workers * stripe_count_per_worker;\n+  size_t sz = MAX2(old_gen_used_words \/ stripe_count, 128 * (size_t)_card_size_in_words);\n+  stripe_size_in_words = align_up(sz, _card_size_in_words);\n+  large_obj_arr_min_words = 2 * stripe_size_in_words + 1;\n+  log_trace(gc, scavenge)(\"stripe count:%d stripe size:\" SIZE_FORMAT \"K\",\n+                          stripe_count, (stripe_size_in_words * HeapWordSize) \/ K);\n+}\n+\n@@ -247,1 +260,0 @@\n-  const size_t stripe_size_in_words = num_cards_in_stripe * _card_size_in_words;\n@@ -298,1 +310,1 @@\n-      if (obj_sz >= large_obj_arr_min_words() && cast_to_oop(obj_addr)->is_objArray()) {\n+      if (obj_sz >= large_obj_arr_min_words && cast_to_oop(obj_addr)->is_objArray()) {\n@@ -386,2 +398,0 @@\n-  const size_t stripe_size_in_words = num_cards_in_stripe * _card_size_in_words;\n-\n@@ -393,1 +403,1 @@\n-      (arr_sz = cast_to_oop(large_arr_addr)->size()) < large_obj_arr_min_words())\n+      (arr_sz = cast_to_oop(large_arr_addr)->size()) < large_obj_arr_min_words)\n@@ -401,1 +411,1 @@\n-    assert(large_obj_arr_min_words() > 2 * stripe_size_in_words, \"2nd last chunk must cover stripe\");\n+    assert(large_obj_arr_min_words > 2 * stripe_size_in_words, \"2nd last chunk must cover stripe\");\n","filename":"src\/hotspot\/share\/gc\/parallel\/psCardTable.cpp","additions":17,"deletions":7,"binary":false,"changes":24,"status":"modified"},{"patch":"@@ -45,2 +45,2 @@\n-  static const size_t num_cards_in_stripe = 128;\n-  static size_t large_obj_arr_min_words() { return 2 * num_cards_in_stripe * _card_size_in_words + 1; }\n+  static size_t stripe_size_in_words;\n+  static size_t large_obj_arr_min_words;\n@@ -69,0 +69,1 @@\n+  void prepare_scavenge(int active_workers, size_t old_gen_used_words);\n","filename":"src\/hotspot\/share\/gc\/parallel\/psCardTable.hpp","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -304,0 +304,2 @@\n+    PSCardTable* card_table = ParallelScavengeHeap::heap()->card_table();\n+    card_table->prepare_scavenge(active_workers, old_gen->object_space()->used_in_words());\n","filename":"src\/hotspot\/share\/gc\/parallel\/psScavenge.cpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"}]}