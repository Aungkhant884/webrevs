{"files":[{"patch":"@@ -31,0 +31,1 @@\n+import jdk.internal.misc.Unsafe;\n@@ -36,0 +37,4 @@\n+    private static final Unsafe U = Unsafe.getUnsafe();\n+    private static final long accessorGeneratedOffset\n+        = U.objectFieldOffset(NativeConstructorAccessorImpl.class, \"accessorGenerated\");\n+\n@@ -39,0 +44,1 @@\n+    private int accessorGenerated;\n@@ -54,8 +60,17 @@\n-                && !ReflectUtil.isVMAnonymousClass(c.getDeclaringClass())) {\n-            ConstructorAccessorImpl acc = (ConstructorAccessorImpl)\n-                new MethodAccessorGenerator().\n-                    generateConstructor(c.getDeclaringClass(),\n-                                        c.getParameterTypes(),\n-                                        c.getExceptionTypes(),\n-                                        c.getModifiers());\n-            parent.setDelegate(acc);\n+                && !ReflectUtil.isVMAnonymousClass(c.getDeclaringClass())\n+                && accessorGenerated == 0\n+                && U.compareAndSetInt(this, accessorGeneratedOffset, 0, 1)) {\n+            try {\n+                ConstructorAccessorImpl acc = (ConstructorAccessorImpl)\n+                    new MethodAccessorGenerator().\n+                        generateConstructor(c.getDeclaringClass(),\n+                                            c.getParameterTypes(),\n+                                            c.getExceptionTypes(),\n+                                            c.getModifiers());\n+                parent.setDelegate(acc);\n+            } catch (Throwable t) {\n+                \/\/ in case Throwable happens in generateConstructor\n+                \/\/ restore accessorGenerated value to 0\n+                accessorGenerated = 0;\n+                throw t;\n+            }\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/reflect\/NativeConstructorAccessorImpl.java","additions":23,"deletions":8,"binary":false,"changes":31,"status":"modified"},{"patch":"@@ -31,0 +31,1 @@\n+import jdk.internal.misc.Unsafe;\n@@ -36,0 +37,4 @@\n+     private static final Unsafe U = Unsafe.getUnsafe();\n+     private static final long accessorGeneratedOffset\n+        = U.objectFieldOffset(NativeMethodAccessorImpl.class, \"accessorGenerated\");\n+\n@@ -39,0 +44,1 @@\n+    private int accessorGenerated;\n@@ -52,10 +58,19 @@\n-                && !ReflectUtil.isVMAnonymousClass(method.getDeclaringClass())) {\n-            MethodAccessorImpl acc = (MethodAccessorImpl)\n-                new MethodAccessorGenerator().\n-                    generateMethod(method.getDeclaringClass(),\n-                                   method.getName(),\n-                                   method.getParameterTypes(),\n-                                   method.getReturnType(),\n-                                   method.getExceptionTypes(),\n-                                   method.getModifiers());\n-            parent.setDelegate(acc);\n+                && !ReflectUtil.isVMAnonymousClass(method.getDeclaringClass())\n+                && accessorGenerated == 0\n+                && U.compareAndSetInt(this, accessorGeneratedOffset, 0, 1)) {\n+            try {\n+                MethodAccessorImpl acc = (MethodAccessorImpl)\n+                    new MethodAccessorGenerator().\n+                        generateMethod(method.getDeclaringClass(),\n+                                       method.getName(),\n+                                       method.getParameterTypes(),\n+                                       method.getReturnType(),\n+                                       method.getExceptionTypes(),\n+                                       method.getModifiers());\n+                parent.setDelegate(acc);\n+            } catch (Throwable t) {\n+                \/\/ in case Throwable happens in generateMethod\n+                \/\/ restore accessorGenerated value to 0\n+                accessorGenerated = 1;\n+                throw t;\n+            }\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/reflect\/NativeMethodAccessorImpl.java","additions":25,"deletions":10,"binary":false,"changes":35,"status":"modified"}]}