{"files":[{"patch":"@@ -31,0 +31,1 @@\n+import jdk.internal.misc.Unsafe;\n@@ -36,0 +37,4 @@\n+    private static final Unsafe U = Unsafe.getUnsafe();\n+    private static final long GENERATED_OFFSET\n+        = U.objectFieldOffset(NativeConstructorAccessorImpl.class, \"generated\");\n+\n@@ -39,0 +44,1 @@\n+    private int generated;\n@@ -54,8 +60,16 @@\n-                && !ReflectUtil.isVMAnonymousClass(c.getDeclaringClass())) {\n-            ConstructorAccessorImpl acc = (ConstructorAccessorImpl)\n-                new MethodAccessorGenerator().\n-                    generateConstructor(c.getDeclaringClass(),\n-                                        c.getParameterTypes(),\n-                                        c.getExceptionTypes(),\n-                                        c.getModifiers());\n-            parent.setDelegate(acc);\n+                && !ReflectUtil.isVMAnonymousClass(c.getDeclaringClass())\n+                && generated == 0\n+                && U.compareAndSetInt(this, GENERATED_OFFSET, 0, 1)) {\n+            try {\n+                ConstructorAccessorImpl acc = (ConstructorAccessorImpl)\n+                    new MethodAccessorGenerator().\n+                        generateConstructor(c.getDeclaringClass(),\n+                                            c.getParameterTypes(),\n+                                            c.getExceptionTypes(),\n+                                            c.getModifiers());\n+                parent.setDelegate(acc);\n+            } catch (Throwable t) {\n+                \/\/ Throwable happens in generateConstructor, restore generated to 0\n+                generated = 0;\n+                throw t;\n+            }\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/reflect\/NativeConstructorAccessorImpl.java","additions":22,"deletions":8,"binary":false,"changes":30,"status":"modified"},{"patch":"@@ -31,0 +31,1 @@\n+import jdk.internal.misc.Unsafe;\n@@ -36,0 +37,4 @@\n+     private static final Unsafe U = Unsafe.getUnsafe();\n+     private static final long GENERATED_OFFSET\n+        = U.objectFieldOffset(NativeMethodAccessorImpl.class, \"generated\");\n+\n@@ -39,0 +44,1 @@\n+    private int generated;\n@@ -52,10 +58,18 @@\n-                && !ReflectUtil.isVMAnonymousClass(method.getDeclaringClass())) {\n-            MethodAccessorImpl acc = (MethodAccessorImpl)\n-                new MethodAccessorGenerator().\n-                    generateMethod(method.getDeclaringClass(),\n-                                   method.getName(),\n-                                   method.getParameterTypes(),\n-                                   method.getReturnType(),\n-                                   method.getExceptionTypes(),\n-                                   method.getModifiers());\n-            parent.setDelegate(acc);\n+                && !ReflectUtil.isVMAnonymousClass(method.getDeclaringClass())\n+                && generated == 0\n+                && U.compareAndSetInt(this, GENERATED_OFFSET, 0, 1)) {\n+            try {\n+                MethodAccessorImpl acc = (MethodAccessorImpl)\n+                    new MethodAccessorGenerator().\n+                        generateMethod(method.getDeclaringClass(),\n+                                       method.getName(),\n+                                       method.getParameterTypes(),\n+                                       method.getReturnType(),\n+                                       method.getExceptionTypes(),\n+                                       method.getModifiers());\n+                parent.setDelegate(acc);\n+            } catch (Throwable t) {\n+                \/\/ Throwable happens in generateMethod, restore generated to 0\n+                generated = 0;\n+                throw t;\n+            }\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/reflect\/NativeMethodAccessorImpl.java","additions":24,"deletions":10,"binary":false,"changes":34,"status":"modified"}]}