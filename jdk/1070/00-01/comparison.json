{"files":[{"patch":"@@ -31,0 +31,1 @@\n+import jdk.internal.misc.Unsafe;\n@@ -36,0 +37,4 @@\n+    private static final Unsafe unsafe = Unsafe.getUnsafe();\n+    private static final long accessorGeneratedaOffset\n+        = unsafe.objectFieldOffset(NativeConstructorAccessorImpl.class, \"accessorGenerated\");\n+\n@@ -39,0 +44,1 @@\n+    boolean accessorGenerated;\n@@ -54,8 +60,17 @@\n-                && !ReflectUtil.isVMAnonymousClass(c.getDeclaringClass())) {\n-            ConstructorAccessorImpl acc = (ConstructorAccessorImpl)\n-                new MethodAccessorGenerator().\n-                    generateConstructor(c.getDeclaringClass(),\n-                                        c.getParameterTypes(),\n-                                        c.getExceptionTypes(),\n-                                        c.getModifiers());\n-            parent.setDelegate(acc);\n+                && !ReflectUtil.isVMAnonymousClass(c.getDeclaringClass())\n+                && accessorGenerated == false\n+                && unsafe.compareAndSetBoolean(this, accessorGeneratedaOffset, false, true)) {\n+            try {\n+                ConstructorAccessorImpl acc = (ConstructorAccessorImpl)\n+                    new MethodAccessorGenerator().\n+                        generateConstructor(c.getDeclaringClass(),\n+                                            c.getParameterTypes(),\n+                                            c.getExceptionTypes(),\n+                                            c.getModifiers());\n+                parent.setDelegate(acc);\n+            } catch (Throwable t) {\n+                \/\/ in case Thowable happens in generateMethod\n+                \/\/ restore accessorGenerated flag to false\n+                accessorGenerated = false;\n+                throw t;\n+            }\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/reflect\/NativeConstructorAccessorImpl.java","additions":23,"deletions":8,"binary":false,"changes":31,"status":"modified"},{"patch":"@@ -31,2 +31,1 @@\n-import java.lang.invoke.MethodHandles;\n-import java.lang.invoke.VarHandle;\n+import jdk.internal.misc.Unsafe;\n@@ -38,9 +37,3 @@\n-    private static final VarHandle ACCESSOR_GENERATED;\n-    static {\n-        try {\n-            ACCESSOR_GENERATED = MethodHandles.lookup().findVarHandle(\n-                NativeMethodAccessorImpl.class, \"accessorGenerated\", boolean.class);\n-        } catch (Exception e) {\n-            throw new ExceptionInInitializerError(e);\n-        }\n-    }\n+     private static final Unsafe unsafe = Unsafe.getUnsafe();\n+     private static final long accessorGeneratedaOffset\n+        = unsafe.objectFieldOffset(NativeMethodAccessorImpl.class, \"accessorGenerated\");\n@@ -66,2 +59,2 @@\n-                && ACCESSOR_GENERATED.compareAndSet(this, false, true)) {\n-            boolean succ = false;\n+                && accessorGenerated == false\n+                && unsafe.compareAndSetBoolean(this, accessorGeneratedaOffset, false, true)) {\n@@ -78,7 +71,5 @@\n-                succ = true;\n-            } finally {\n-                if (succ == false) {\n-                    \/\/ in case exception happens in generateMethod\n-                    \/\/ restore accessorGenerated flag to false\n-                    ACCESSOR_GENERATED.set(this, false);\n-                }\n+            } catch (Throwable t) {\n+                \/\/ in case Thowable happens in generateMethod\n+                \/\/ restore accessorGenerated flag to false\n+                accessorGenerated = false;\n+                throw t;\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/reflect\/NativeMethodAccessorImpl.java","additions":11,"deletions":20,"binary":false,"changes":31,"status":"modified"}]}