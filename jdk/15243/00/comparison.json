{"files":[{"patch":"@@ -134,1 +134,0 @@\n-\n@@ -140,2 +139,0 @@\n-    bool should_add(HeapRegion* hr) { return G1CollectionSetChooser::should_add(hr); }\n-\n@@ -150,5 +147,17 @@\n-      \/\/ We will skip any region that's currently used as an old GC\n-      \/\/ alloc region (we should not consider those for collection\n-      \/\/ before we fill them up).\n-      if (should_add(r) && !G1CollectedHeap::heap()->is_old_gc_alloc_region(r)) {\n-        assert(r->rem_set()->is_complete(), \"must be %u\", r->hrm_index());\n+      \/\/ Candidates from marking are always old; also keep regions that are already\n+      \/\/ collection set candidates (some retained regions) in that list.\n+      if (!r->is_old() || r->is_collection_set_candidate()) {\n+        \/\/ Keep remembered sets and everything for these regions.\n+        return false;\n+      }\n+\n+      bool should_add =\n+        \/\/ We will skip any region that's currently used as an old GC\n+        \/\/ alloc region (we should not consider those for collection\n+        \/\/ before we fill them up). Otherwise the Old region must satisfy the liveness\n+        \/\/ condition and have a complete remembered set.\n+        !G1CollectedHeap::heap()->is_old_gc_alloc_region(r) &&\n+        G1CollectionSetChooser::region_occupancy_low_enough_for_evac(r->live_bytes()) &&\n+        r->rem_set()->is_complete();\n+\n+      if (should_add) {\n@@ -156,4 +165,0 @@\n-      } else if (r->is_old() && !r->is_collection_set_candidate()) {\n-        \/\/ Keep remembered sets for humongous regions and collection set candidates,\n-        \/\/ otherwise clean them out.\n-        r->rem_set()->clear(true \/* only_cardset *\/);\n@@ -161,3 +166,2 @@\n-        assert(r->is_collection_set_candidate() || !r->is_old() || !r->rem_set()->is_tracked(),\n-               \"Missed to clear unused remembered set of region %u (%s) that is %s\",\n-               r->hrm_index(), r->get_type_str(), r->rem_set()->get_state_str());\n+        \/\/ Clear remembered sets of not-used regions (if there is any).\n+        r->rem_set()->clear(true \/* only_cardset *\/);\n@@ -255,11 +259,0 @@\n-bool G1CollectionSetChooser::should_add(HeapRegion* hr) {\n-  return !hr->is_young() &&\n-         !hr->is_humongous() &&\n-         \/\/ A region might have been retained (after evacuation failure) and already put\n-         \/\/ into the candidates list during concurrent marking. These should keep being\n-         \/\/ considered as retained regions.\n-         !hr->is_collection_set_candidate() &&\n-         region_occupancy_low_enough_for_evac(hr->live_bytes()) &&\n-         hr->rem_set()->is_complete();\n-}\n-\n","filename":"src\/hotspot\/share\/gc\/g1\/g1CollectionSetChooser.cpp","additions":19,"deletions":26,"binary":false,"changes":45,"status":"modified"},{"patch":"@@ -50,5 +50,0 @@\n-  \/\/ Determine whether to add the given region to the collection set candidates from\n-  \/\/ marking or not. Currently, we skip regions whose live bytes are over the threshold.\n-  \/\/ Regions also need a complete remembered set to be a candidate.\n-  static bool should_add(HeapRegion* hr);\n-\n","filename":"src\/hotspot\/share\/gc\/g1\/g1CollectionSetChooser.hpp","additions":0,"deletions":5,"binary":false,"changes":5,"status":"modified"}]}