{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2000, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -33,0 +33,5 @@\n+import java.awt.image.ColorModel;\n+import java.awt.image.IndexColorModel;\n+import java.awt.image.MultiPixelPackedSampleModel;\n+import java.awt.image.PixelInterleavedSampleModel;\n+import java.awt.image.SampleModel;\n@@ -39,0 +44,1 @@\n+\n@@ -46,0 +52,1 @@\n+\n@@ -47,5 +54,0 @@\n-import java.awt.image.ColorModel;\n-import java.awt.image.IndexColorModel;\n-import java.awt.image.MultiPixelPackedSampleModel;\n-import java.awt.image.PixelInterleavedSampleModel;\n-import java.awt.image.SampleModel;\n@@ -657,0 +659,6 @@\n+            if (ignoreMetadata) {\n+                stream.skipBytes(length);\n+                continue;\n+            }\n+            byte[] subBlockData =\n+                ReaderUtil.staggeredReadByteStream(stream, length);\n@@ -659,1 +667,2 @@\n-            stream.readFully(newData, data.length, length);\n+            System.arraycopy(subBlockData, 0, newData,\n+                             data.length, length);\n@@ -662,1 +671,0 @@\n-\n@@ -697,2 +705,3 @@\n-                            new byte[3*numLCTEntries];\n-                        stream.readFully(imageMetadata.localColorTable);\n+                            ReaderUtil.\n+                                staggeredReadByteStream(stream,\n+                                                       (3 * numLCTEntries));\n@@ -729,17 +738,21 @@\n-                        imageMetadata.hasPlainTextExtension = true;\n-                        imageMetadata.textGridLeft =\n-                            stream.readUnsignedShort();\n-                        imageMetadata.textGridTop =\n-                            stream.readUnsignedShort();\n-                        imageMetadata.textGridWidth =\n-                            stream.readUnsignedShort();\n-                        imageMetadata.textGridHeight =\n-                            stream.readUnsignedShort();\n-                        imageMetadata.characterCellWidth =\n-                            stream.readUnsignedByte();\n-                        imageMetadata.characterCellHeight =\n-                            stream.readUnsignedByte();\n-                        imageMetadata.textForegroundColor =\n-                            stream.readUnsignedByte();\n-                        imageMetadata.textBackgroundColor =\n-                            stream.readUnsignedByte();\n+                        if (!ignoreMetadata) {\n+                            imageMetadata.hasPlainTextExtension = true;\n+                            imageMetadata.textGridLeft =\n+                                    stream.readUnsignedShort();\n+                            imageMetadata.textGridTop =\n+                                    stream.readUnsignedShort();\n+                            imageMetadata.textGridWidth =\n+                                    stream.readUnsignedShort();\n+                            imageMetadata.textGridHeight =\n+                                    stream.readUnsignedShort();\n+                            imageMetadata.characterCellWidth =\n+                                    stream.readUnsignedByte();\n+                            imageMetadata.characterCellHeight =\n+                                    stream.readUnsignedByte();\n+                            imageMetadata.textForegroundColor =\n+                                    stream.readUnsignedByte();\n+                            imageMetadata.textBackgroundColor =\n+                                    stream.readUnsignedByte();\n+                        } else {\n+                            stream.skipBytes(length);\n+                        }\n@@ -749,2 +762,5 @@\n-                        if (imageMetadata.comments == null) {\n-                            imageMetadata.comments = new ArrayList<>();\n+                        if (!ignoreMetadata) {\n+                            if (imageMetadata.comments == null) {\n+                                imageMetadata.comments = new ArrayList<>();\n+                            }\n+                            imageMetadata.comments.add(comment);\n@@ -752,1 +768,0 @@\n-                        imageMetadata.comments.add(comment);\n@@ -755,0 +770,2 @@\n+                        int offset = 0;\n+                        byte[] blockData = new byte[0];\n@@ -757,7 +774,12 @@\n-\n-                        \/\/ read available data\n-                        byte[] blockData = new byte[blockSize];\n-                        stream.readFully(blockData);\n-\n-                        int offset = copyData(blockData, 0, applicationID);\n-                        offset = copyData(blockData, offset, authCode);\n+                        if (!ignoreMetadata) {\n+                            \/\/ read available data\n+                            blockData =\n+                                ReaderUtil.staggeredReadByteStream(stream,\n+                                                                   blockSize);\n+\n+                            offset =\n+                                copyData(blockData, 0, applicationID);\n+                            offset = copyData(blockData, offset, authCode);\n+                        } else {\n+                            stream.skipBytes(blockSize);\n+                        }\n@@ -767,1 +789,2 @@\n-                        if (offset < blockSize) {\n+                        if (!ignoreMetadata &&\n+                            offset < blockSize) {\n@@ -772,2 +795,4 @@\n-                            System.arraycopy(blockData, offset, data, 0, len);\n-                            System.arraycopy(applicationData, 0, data, len,\n+                            System.arraycopy(blockData, offset,\n+                                             data, 0, len);\n+                            System.arraycopy(applicationData, 0,\n+                                             data, len,\n@@ -779,6 +804,13 @@\n-                        \/\/ Init lists if necessary\n-                        if (imageMetadata.applicationIDs == null) {\n-                            imageMetadata.applicationIDs = new ArrayList<>();\n-                            imageMetadata.authenticationCodes =\n-                                new ArrayList<>();\n-                            imageMetadata.applicationData = new ArrayList<>();\n+                        if (!ignoreMetadata) {\n+                            \/\/ Init lists if necessary\n+                            if (imageMetadata.applicationIDs == null) {\n+                                imageMetadata.applicationIDs =\n+                                    new ArrayList<>();\n+                                imageMetadata.authenticationCodes =\n+                                    new ArrayList<>();\n+                                imageMetadata.applicationData =\n+                                    new ArrayList<>();\n+                            }\n+                            imageMetadata.applicationIDs.add(applicationID);\n+                            imageMetadata.authenticationCodes.add(authCode);\n+                            imageMetadata.applicationData.add(applicationData);\n@@ -786,3 +818,0 @@\n-                        imageMetadata.applicationIDs.add(applicationID);\n-                        imageMetadata.authenticationCodes.add(authCode);\n-                        imageMetadata.applicationData.add(applicationData);\n","filename":"src\/java.desktop\/share\/classes\/com\/sun\/imageio\/plugins\/gif\/GIFImageReader.java","additions":78,"deletions":49,"binary":false,"changes":127,"status":"modified"}]}