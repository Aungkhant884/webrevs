{"files":[{"patch":"@@ -86,1 +86,0 @@\n-gc\/metaspace\/TestMetaspacePerfCounters.java#Epsilon-64 8293503 generic-all\n","filename":"test\/hotspot\/jtreg\/ProblemList.txt","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -26,1 +26,1 @@\n-import java.lang.management.GarbageCollectorMXBean;\n+import java.lang.invoke.VarHandle;\n@@ -186,0 +186,36 @@\n+class PerfCounterSnapshot {\n+    private static long getMinCapacity(String ns) throws Exception {\n+        return PerfCounters.findByName(ns + \".minCapacity\").longValue();\n+    }\n+\n+    private static long getCapacity(String ns) throws Exception {\n+        return PerfCounters.findByName(ns + \".capacity\").longValue();\n+    }\n+\n+    private static long getMaxCapacity(String ns) throws Exception {\n+        return PerfCounters.findByName(ns + \".maxCapacity\").longValue();\n+    }\n+\n+    private static long getUsed(String ns) throws Exception {\n+        return PerfCounters.findByName(ns + \".used\").longValue();\n+    }\n+\n+    public long minCapacity;\n+    public long maxCapacity;\n+    public long capacity;\n+    public long used;\n+\n+    public void get(String ns) throws Exception {\n+        minCapacity = getMinCapacity(ns);\n+        maxCapacity = getMaxCapacity(ns);\n+        used = getUsed(ns);\n+        capacity = getCapacity(ns);\n+    }\n+\n+    public boolean equals(Object object) {\n+        PerfCounterSnapshot other = (PerfCounterSnapshot)object;\n+        return (minCapacity == other.minCapacity) && (maxCapacity == other.maxCapacity) &&\n+            (used == other.used) && (capacity == other.capacity);\n+    }\n+}\n+\n@@ -189,1 +225,0 @@\n-    private static final List<GarbageCollectorMXBean> gcBeans = ManagementFactoryHelper.getGarbageCollectorMXBeans();\n@@ -207,12 +242,2 @@\n-        long gcCountBefore;\n-        long gcCountAfter;\n-        long minCapacity;\n-        long maxCapacity;\n-        long capacity;\n-        long used;\n-\n-        \/\/ The perf counter values are updated during GC and to be able to\n-        \/\/ do the assertions below we need to ensure that the values are from\n-        \/\/ the same GC cycle.\n-        do {\n-            gcCountBefore = currentGCCount();\n+        PerfCounterSnapshot snap1 = new PerfCounterSnapshot();\n+        PerfCounterSnapshot snap2 = new PerfCounterSnapshot();\n@@ -220,4 +245,1 @@\n-            minCapacity = getMinCapacity(ns);\n-            maxCapacity = getMaxCapacity(ns);\n-            capacity = getCapacity(ns);\n-            used = getUsed(ns);\n+        final int MaxAttempts = 10;\n@@ -225,3 +247,10 @@\n-            gcCountAfter = currentGCCount();\n-            assertGTE(gcCountAfter, gcCountBefore);\n-        } while(gcCountAfter > gcCountBefore);\n+        int attempts = 0;\n+        do {\n+            snap1.get(ns);\n+            VarHandle.fullFence();\n+            snap2.get(ns);\n+        } while ((!snap1.equals(snap2)) && (++attempts < MaxAttempts));\n+\n+        if (attempts == MaxAttempts) {\n+            throw new Exception(\"Failed to get stable reading of metaspace performance counters after \" + MaxAttempts + \" tries\");\n+        }\n@@ -229,4 +258,4 @@\n-        assertGTE(minCapacity, 0L);\n-        assertGTE(used, minCapacity);\n-        assertGTE(capacity, used);\n-        assertGTE(maxCapacity, capacity);\n+        assertGTE(snap1.minCapacity, 0L);\n+        assertGTE(snap1.used, snap1.minCapacity);\n+        assertGTE(snap1.capacity, snap1.used);\n+        assertGTE(snap1.maxCapacity, snap1.capacity);\n@@ -246,1 +275,2 @@\n-        long before = getUsed(ns);\n+        PerfCounterSnapshot before = new PerfCounterSnapshot();\n+        before.get(ns);\n@@ -249,1 +279,2 @@\n-        long after = getUsed(ns);\n+        PerfCounterSnapshot after = new PerfCounterSnapshot();\n+        after.get(ns);\n@@ -251,1 +282,1 @@\n-        assertGT(after, before);\n+        assertGT(after.used, before.used);\n@@ -270,24 +301,0 @@\n-\n-    private static long getMinCapacity(String ns) throws Exception {\n-        return PerfCounters.findByName(ns + \".minCapacity\").longValue();\n-    }\n-\n-    private static long getCapacity(String ns) throws Exception {\n-        return PerfCounters.findByName(ns + \".capacity\").longValue();\n-    }\n-\n-    private static long getMaxCapacity(String ns) throws Exception {\n-        return PerfCounters.findByName(ns + \".maxCapacity\").longValue();\n-    }\n-\n-    private static long getUsed(String ns) throws Exception {\n-        return PerfCounters.findByName(ns + \".used\").longValue();\n-    }\n-\n-    private static long currentGCCount() {\n-        long gcCount = 0;\n-        for (GarbageCollectorMXBean bean : gcBeans) {\n-            gcCount += bean.getCollectionCount();\n-        }\n-        return gcCount;\n-    }\n","filename":"test\/hotspot\/jtreg\/gc\/metaspace\/TestMetaspacePerfCounters.java","additions":59,"deletions":52,"binary":false,"changes":111,"status":"modified"}]}