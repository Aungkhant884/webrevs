{"files":[{"patch":"@@ -38,1 +38,1 @@\n-    return;\t\t\t\/\/ Elided.\n+    return;\n@@ -63,0 +63,21 @@\n+static void z_cmpxchg_common(MacroAssembler& _masm, const MachNode* node, Register mem_reg, Register newval, Register tmp) {\n+  \/\/ Compare value (oldval) is in rax\n+   const Address mem = Address(mem_reg, 0);\n+\n+  if (node->barrier_data() != ZLoadBarrierElided) {\n+    __ movptr(tmp, rax);\n+  }\n+\n+  __ lock();\n+  __ cmpxchgptr(newval, mem);\n+\n+  if (node->barrier_data() != ZLoadBarrierElided) {\n+    Label good;\n+    z_load_barrier_cmpxchg(_masm, node, mem, rax, tmp, good);\n+    __ movptr(rax, tmp);\n+    __ lock();\n+    __ cmpxchgptr(newval, mem);\n+    __ bind(good);\n+  }\n+}\n+\n@@ -84,1 +105,1 @@\n-instruct zCompareAndExchangeP(memory mem, rax_RegP oldval, rRegP newval, rRegP tmp, rFlagsReg cr) %{\n+instruct zCompareAndExchangeP(indirect mem, rax_RegP oldval, rRegP newval, rRegP tmp, rFlagsReg cr) %{\n@@ -93,14 +114,2 @@\n-    if (barrier_data() != ZLoadBarrierElided) { \/\/ barrier could be elided by ZBarrierSetC2::analyze_dominating_barriers()\n-      __ movptr($tmp$$Register, $oldval$$Register);\n-    }\n-    __ lock();\n-    __ cmpxchgptr($newval$$Register, $mem$$Address);\n-\n-    if (barrier_data() != ZLoadBarrierElided) {\n-      Label good;\n-      z_load_barrier_cmpxchg(_masm, this, $mem$$Address, $oldval$$Register, $tmp$$Register, good);\n-      __ movptr($oldval$$Register, $tmp$$Register);\n-      __ lock();\n-      __ cmpxchgptr($newval$$Register, $mem$$Address);\n-      __ bind(good);\n-    }\n+    precond($oldval$$Register == rax);\n+    z_cmpxchg_common(_masm, this, $mem$$Register, $newval$$Register, $tmp$$Register);\n@@ -112,1 +121,1 @@\n-instruct zCompareAndSwapP(rRegI res, memory mem, rRegP newval, rRegP tmp, rFlagsReg cr, rax_RegP oldval) %{\n+instruct zCompareAndSwapP(rRegI res, indirect mem, rRegP newval, rRegP tmp, rFlagsReg cr, rax_RegP oldval) %{\n@@ -124,6 +133,2 @@\n-    if (barrier_data() != ZLoadBarrierElided) { \/\/ barrier could be elided by ZBarrierSetC2::analyze_dominating_barriers()\n-      __ movptr($tmp$$Register, $oldval$$Register);\n-    }\n-    __ lock();\n-    __ cmpxchgptr($newval$$Register, $mem$$Address);\n-\n+    precond($oldval$$Register == rax);\n+    z_cmpxchg_common(_masm, this, $mem$$Register, $newval$$Register, $tmp$$Register);\n@@ -131,7 +136,1 @@\n-      Label good;\n-      z_load_barrier_cmpxchg(_masm, this, $mem$$Address, $oldval$$Register, $tmp$$Register, good);\n-      __ movptr($oldval$$Register, $tmp$$Register);\n-      __ lock();\n-      __ cmpxchgptr($newval$$Register, $mem$$Address);\n-      __ bind(good);\n-      __ cmpptr($tmp$$Register, $oldval$$Register);\n+      __ cmpptr($tmp$$Register, rax);\n@@ -146,1 +145,1 @@\n-instruct zXChgP(memory mem, rRegP newval, rFlagsReg cr) %{\n+instruct zXChgP(indirect mem, rRegP newval, rFlagsReg cr) %{\n@@ -154,1 +153,1 @@\n-    __ xchgptr($newval$$Register, $mem$$Address);\n+    __ xchgptr($newval$$Register, Address($mem$$Register, 0));\n","filename":"src\/hotspot\/cpu\/x86\/gc\/z\/z_x86_64.ad","additions":31,"deletions":32,"binary":false,"changes":63,"status":"modified"}]}