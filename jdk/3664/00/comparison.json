{"files":[{"patch":"@@ -372,1 +372,0 @@\n-                SSLSessionImpl s = null;\n@@ -375,0 +374,1 @@\n+                    SSLSessionImpl s = null;\n@@ -377,6 +377,13 @@\n-                        s = sessionCache.get(requestedId.identity);\n-                    }\n-                    \/\/ See if the identity is a stateless ticket\n-                    if (s == null &&\n-                            requestedId.identity.length > SessionId.MAX_LENGTH &&\n-                            sessionCache.statelessEnabled()) {\n+                        synchronized (sessionCache) {\n+                            s = sessionCache.get(requestedId.identity);\n+\n+                            if (s != null && canRejoin(clientHello, shc, s)) {\n+                                \/\/ The session can't be resumed again---remove it from cache\n+                                sessionCache.remove(s.getSessionId());\n+                            } else {\n+                                s = null;\n+                            }\n+                        }\n+                    } else if (requestedId.identity.length > SessionId.MAX_LENGTH &&\n+                                sessionCache.statelessEnabled()) {\n+                        \/\/ Identity is a stateless ticket\n@@ -384,1 +391,1 @@\n-                            new SessionTicketSpec(shc, requestedId.identity).\n+                                new SessionTicketSpec(shc, requestedId.identity).\n@@ -389,0 +396,3 @@\n+                                if (!canRejoin(clientHello, shc, s)) {\n+                                    s = null;\n+                                }\n@@ -401,2 +411,1 @@\n-\n-                    if (s != null && canRejoin(clientHello, shc, s)) {\n+                    if (s != null) {\n","filename":"src\/java.base\/share\/classes\/sun\/security\/ssl\/PreSharedKeyExtension.java","additions":19,"deletions":10,"binary":false,"changes":29,"status":"modified"},{"patch":"@@ -563,3 +563,0 @@\n-\n-                \/\/ The session can't be resumed again---remove it from cache\n-                sessionCache.remove(shc.resumingSession.getSessionId());\n","filename":"src\/java.base\/share\/classes\/sun\/security\/ssl\/ServerHello.java","additions":0,"deletions":3,"binary":false,"changes":3,"status":"modified"}]}