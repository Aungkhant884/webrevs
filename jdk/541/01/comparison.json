{"files":[{"patch":"@@ -452,0 +452,4 @@\n+    \/\/ Concurrent update thread roots\n+    heap->entry_update_thread_roots();\n+    if (check_cancellation_or_degen(ShenandoahHeap::_degenerated_updaterefs)) return;\n+\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahControlThread.cpp","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -1809,0 +1809,25 @@\n+class ShenandoahUpdateThreadClosure : public HandshakeClosure {\n+private:\n+  ShenandoahUpdateRefsClosure _cl;\n+public:\n+  ShenandoahUpdateThreadClosure();\n+  void do_thread(Thread* thread);\n+};\n+\n+ShenandoahUpdateThreadClosure::ShenandoahUpdateThreadClosure() :\n+  HandshakeClosure(\"Shenandoah Update Thread Roots\") {\n+}\n+\n+void ShenandoahUpdateThreadClosure::do_thread(Thread* thread) {\n+  if (thread->is_Java_thread()) {\n+    JavaThread* jt = thread->as_Java_thread();\n+    ResourceMark rm;\n+    jt->oops_do(&_cl, NULL);\n+  }\n+}\n+\n+void ShenandoahHeap::op_update_thread_roots() {\n+  ShenandoahUpdateThreadClosure cl;\n+  Handshake::execute(&cl);\n+}\n+\n@@ -2738,2 +2763,0 @@\n-  } else {\n-    concurrent_mark()->update_thread_roots(ShenandoahPhaseTimings::final_update_refs_roots);\n@@ -3021,0 +3044,13 @@\n+void ShenandoahHeap::entry_update_thread_roots() {\n+  TraceCollectorStats tcs(monitoring_support()->concurrent_collection_counters());\n+\n+  static const char* msg = \"Concurrent update thread roots\";\n+  ShenandoahConcurrentPhase gc_phase(msg, ShenandoahPhaseTimings::conc_update_thread_roots);\n+  EventMark em(\"%s\", msg);\n+\n+  \/\/ No workers used in this phase, no setup required\n+  try_inject_alloc_failure();\n+  op_update_thread_roots();\n+}\n+\n+\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahHeap.cpp","additions":38,"deletions":2,"binary":false,"changes":40,"status":"modified"},{"patch":"@@ -399,0 +399,1 @@\n+  void entry_update_thread_roots();\n@@ -424,0 +425,1 @@\n+  void op_update_thread_roots();\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahHeap.hpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -109,0 +109,1 @@\n+  f(conc_update_thread_roots,                       \"Concurrent Update Thread Roots\")  \\\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahPhaseTimings.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"}]}