{"files":[{"patch":"@@ -52,0 +52,10 @@\n+  product(bool, StressIGVN, false, DIAGNOSTIC,                              \\\n+          \"Randomize worklist traversal in IGVN\")                           \\\n+                                                                            \\\n+  product(bool, GenerateStressSeed, false, DIAGNOSTIC,                      \\\n+          \"Generate random seed for IGVN stress testing\")                   \\\n+                                                                            \\\n+  product(uintx, StressSeed, 0, DIAGNOSTIC,                                 \\\n+          \"Random seed for IGVN stress testing\")                            \\\n+          range(0, max_uintx)                                               \\\n+                                                                            \\\n","filename":"src\/hotspot\/share\/opto\/c2_globals.hpp","additions":10,"deletions":0,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -526,0 +526,1 @@\n+                  _stress_seed(0),\n@@ -730,0 +731,12 @@\n+  \/\/ If IGVN is randomized for stress testing, seed random number\n+  \/\/ generation and log the seed for repeatability.\n+  if (StressIGVN) {\n+    _stress_seed = GenerateStressSeed ?\n+      static_cast<uint>(Ticks::now().nanoseconds()) : StressSeed;\n+    if (_log != NULL) {\n+      _log->elem(\"stress_test seed='%u'\", _stress_seed);\n+    } else if (GenerateStressSeed) {\n+      tty->print_cr(\"Warning:  set +LogCompilation to log the seed.\");\n+    }\n+  }\n+\n@@ -812,0 +825,1 @@\n+    _stress_seed(0),\n@@ -4439,2 +4453,15 @@\n-\/\/ Auxiliary method to support randomized stressing\/fuzzing.\n-\/\/\n+\/\/ Auxiliary methods to support randomized stressing\/fuzzing.\n+\n+int Compile::random() {\n+  _stress_seed = os::next_random(_stress_seed);\n+  return static_cast<int>(_stress_seed);\n+}\n+\n+void Compile::shuffle(Unique_Node_List* l) {\n+  if (l->size() < 2) return;\n+  for (uint i = l->size() - 1; i >= 1; i--) {\n+    uint j = random() % (i + 1);\n+    l->swap(i, j);\n+  }\n+}\n+\n","filename":"src\/hotspot\/share\/opto\/compile.cpp","additions":29,"deletions":2,"binary":false,"changes":31,"status":"modified"},{"patch":"@@ -304,0 +304,1 @@\n+  uint                  _stress_seed;           \/\/ Seed for stress testing\n@@ -1140,1 +1141,3 @@\n-  \/\/ Auxiliary method for randomized fuzzing\/stressing\n+  \/\/ Auxiliary methods for randomized fuzzing\/stressing\n+  int random();\n+  void shuffle(Unique_Node_List* l);\n","filename":"src\/hotspot\/share\/opto\/compile.hpp","additions":4,"deletions":1,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -2332,0 +2332,7 @@\n+\/\/-----------------------------------------------------------------------------\n+void Node_Array::swap(uint i, uint j) {\n+  Node* tmp = _nodes[i];\n+  _nodes[i] = _nodes[j];\n+  _nodes[j] = tmp;\n+}\n+\n","filename":"src\/hotspot\/share\/opto\/node.cpp","additions":7,"deletions":0,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -1491,0 +1491,1 @@\n+  void swap(uint i, uint j);\n","filename":"src\/hotspot\/share\/opto\/node.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -1153,0 +1153,1 @@\n+  if (StressIGVN) C->shuffle(&_worklist);\n","filename":"src\/hotspot\/share\/opto\/phaseX.cpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -818,1 +818,1 @@\n-static int random_helper(unsigned int rand_seed) {\n+int os::next_random(unsigned int rand_seed) {\n@@ -856,1 +856,1 @@\n-    unsigned int rand = random_helper(seed);\n+    unsigned int rand = next_random(seed);\n","filename":"src\/hotspot\/share\/runtime\/os.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -759,0 +759,1 @@\n+  static int next_random(unsigned int rand_seed); \/\/ pure version of random()\n","filename":"src\/hotspot\/share\/runtime\/os.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -0,0 +1,65 @@\n+\/*\n+ * Copyright (c) 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package compiler.debug;\n+\n+import java.nio.file.Paths;\n+import jdk.test.lib.process.OutputAnalyzer;\n+import jdk.test.lib.process.ProcessTools;\n+import jdk.test.lib.Asserts;\n+\n+\/*\n+ * @test\n+ * @bug 8252219\n+ * @requires vm.compiler2.enabled\n+ * @summary Tests that -XX:+GenerateStressSeed is accepted, and that, in\n+ *          combination with -XX:+StressIGVN, C2 generates and logs a seed.\n+ * @library \/test\/lib \/\n+ * @run driver compiler.debug.TestGenerateStressSeed\n+ *\/\n+\n+public class TestGenerateStressSeed {\n+\n+    static void sum(int n) {\n+        int acc = 0;\n+        for (int i = 0; i < n; i++) acc += i;\n+        System.out.println(acc);\n+    }\n+\n+    public static void main(String[] args) throws Exception {\n+        if (args.length == 0) {\n+            String className = TestGenerateStressSeed.class.getName();\n+            String log = \"test.log\";\n+            String[] procArgs = {\n+                \"-Xcomp\", \"-XX:-TieredCompilation\",\n+                \"-XX:CompileOnly=\" + className + \"::sum\", \"-XX:+StressIGVN\",\n+                \"-XX:+GenerateStressSeed\", \"-XX:+LogCompilation\",\n+                \"-XX:LogFile=\" + log, className, \"10\"};\n+            ProcessTools.createJavaProcessBuilder(procArgs).start().waitFor();\n+            new OutputAnalyzer(Paths.get(log))\n+                .shouldContain(\"stress_test seed\");\n+        } else if (args.length > 0) {\n+            sum(Integer.parseInt(args[0]));\n+        }\n+    }\n+}\n","filename":"test\/hotspot\/jtreg\/compiler\/debug\/TestGenerateStressSeed.java","additions":65,"deletions":0,"binary":false,"changes":65,"status":"added"},{"patch":"@@ -0,0 +1,72 @@\n+\/*\n+ * Copyright (c) 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package compiler.debug;\n+\n+import jdk.test.lib.process.OutputAnalyzer;\n+import jdk.test.lib.process.ProcessTools;\n+import jdk.test.lib.Asserts;\n+\n+\/*\n+ * @test\n+ * @bug 8252219\n+ * @requires vm.compiler2.enabled\n+ * @summary Tests that:\n+ *          1) the options -XX:+StressIGVN and -XX:+StressSeed=N are accepted,\n+ *          2) compilations with the same seed yield the same IGVN trace, and\n+ *          3) compilations with different seeds yield different IGVN traces.\n+ * @library \/test\/lib \/\n+ * @run driver compiler.debug.TestStressIGVN\n+ *\/\n+\n+public class TestStressIGVN {\n+\n+    static String igvnTrace(int stressSeed) throws Exception {\n+        String className = TestStressIGVN.class.getName();\n+        String[] procArgs = {\n+            \"-Xcomp\", \"-XX:-TieredCompilation\",\n+            \"-XX:CompileOnly=\" + className + \"::sum\", \"-XX:+TraceIterativeGVN\",\n+            \"-XX:+StressIGVN\", \"-XX:StressSeed=\" + stressSeed,\n+            className, \"10\"};\n+        ProcessBuilder pb  = ProcessTools.createJavaProcessBuilder(procArgs);\n+        OutputAnalyzer out = new OutputAnalyzer(pb.start());\n+        return out.getStdout();\n+    }\n+\n+    static void sum(int n) {\n+        int acc = 0;\n+        for (int i = 0; i < n; i++) acc += i;\n+        System.out.println(acc);\n+    }\n+\n+    public static void main(String[] args) throws Exception {\n+        if (args.length == 0) {\n+            Asserts.assertEQ(igvnTrace(10), igvnTrace(10),\n+                \"got different IGVN traces for the same seed\");\n+            Asserts.assertNE(igvnTrace(10), igvnTrace(20),\n+                \"got the same IGVN trace for different seeds\");\n+        } else if (args.length > 0) {\n+            sum(Integer.parseInt(args[0]));\n+        }\n+    }\n+}\n","filename":"test\/hotspot\/jtreg\/compiler\/debug\/TestStressIGVN.java","additions":72,"deletions":0,"binary":false,"changes":72,"status":"added"}]}