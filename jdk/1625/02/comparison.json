{"files":[{"patch":"@@ -451,0 +451,10 @@\n+    \/**\n+     * Set a breakpoint in the given method and resume all threads. The\n+     * breakpoint is configured to suspend just the thread that reaches it\n+     * instead of all threads. This is important when running with graal.\n+     *\/\n+    public BreakpointEvent resumeTo(String clsName, String methodName, String signature) {\n+        boolean suspendThreadOnly = true;\n+        return env.resumeTo(clsName, methodName, signature, suspendThreadOnly);\n+    }\n+\n@@ -453,1 +463,1 @@\n-        env.resumeTo(TARGET_TESTCASE_BASE_NAME, \"warmupDone\", \"()V\");\n+        resumeTo(TARGET_TESTCASE_BASE_NAME, \"warmupDone\", \"()V\");\n@@ -459,1 +469,1 @@\n-        env.resumeTo(TARGET_TESTCASE_BASE_NAME, \"testCaseDone\", \"()V\");\n+        resumeTo(TARGET_TESTCASE_BASE_NAME, \"testCaseDone\", \"()V\");\n@@ -801,5 +811,0 @@\n-    \/\/ With UseJVMCICompiler it is possible that a compilation is made a\n-    \/\/ background compilation even though -Xbatch is given (e.g. if JVMCI is not\n-    \/\/ yet fully initialized). Therefore it is possible that the test method has\n-    \/\/ not reached the highest compilation level after warm-up.\n-    public boolean testMethodReachedHighestCompLevel;\n@@ -918,1 +923,1 @@\n-                if (testFrameShouldBeDeoptimized() && testMethodReachedHighestCompLevel) {\n+                if (testFrameShouldBeDeoptimized()) {\n@@ -972,4 +977,0 @@\n-        \/\/ Background compilation (-Xbatch) cannot always be disabled with JVMCI\n-        \/\/ compiler (e.g. if JVMCI is not yet fully initialized), therefore it\n-        \/\/ is possible that due to background compilation we reach here before\n-        \/\/ the test method is compiled on the highest level.\n@@ -978,1 +979,0 @@\n-        testMethodReachedHighestCompLevel = highestLevel == compLevel;\n@@ -982,0 +982,13 @@\n+        } else {\n+            \/\/ Background compilation (-Xbatch) will block a thread with timeout\n+            \/\/ (see CompileBroker::wait_for_jvmci_completion()). Therefore it is\n+            \/\/ possible to reach here before the main test method is compiled.\n+            \/\/ In that case we wait for it to be compiled.\n+            while (compLevel != highestLevel) {\n+                msg(TESTMETHOD_DEFAULT_NAME + \" is compiled on level \" + compLevel +\n+                    \". Wait until highes level (\" + highestLevel + \") is reached.\");\n+                try {\n+                    Thread.sleep(200);\n+                } catch (InterruptedException e) { \/* ignored *\/ }\n+                compLevel = WB.getMethodCompilationLevel(m);\n+            }\n@@ -1143,1 +1156,1 @@\n-        BreakpointEvent bpe = env.resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n+        BreakpointEvent bpe = resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n@@ -1167,1 +1180,1 @@\n-        BreakpointEvent bpe = env.resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n+        BreakpointEvent bpe = resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n@@ -1206,1 +1219,1 @@\n-        BreakpointEvent bpe = env.resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n+        BreakpointEvent bpe = resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n@@ -1251,1 +1264,1 @@\n-        env.targetMainThread.resume();\n+        env.vm().resume();\n@@ -1254,0 +1267,1 @@\n+        int retryCount = 0;\n@@ -1260,1 +1274,2 @@\n-                msg(\"The local variable xy is out of scope because we suspended at the wrong bci. Resume and try again!\");\n+                ++retryCount;\n+                msg(\"The local variable xy is out of scope because we suspended at the wrong bci. Resume and try again! (\" + retryCount + \")\");\n@@ -1262,0 +1277,3 @@\n+                if ((retryCount % 10) == 0) {\n+                    Thread.sleep(200);\n+                }\n@@ -1330,1 +1348,1 @@\n-        BreakpointEvent bpe = env.resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n+        BreakpointEvent bpe = resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n@@ -1355,1 +1373,1 @@\n-        BreakpointEvent bpe = env.resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n+        BreakpointEvent bpe = resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n@@ -1380,1 +1398,1 @@\n-        BreakpointEvent bpe = env.resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n+        BreakpointEvent bpe = resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n@@ -1405,1 +1423,1 @@\n-        BreakpointEvent bpe = env.resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n+        BreakpointEvent bpe = resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n@@ -1430,1 +1448,1 @@\n-        BreakpointEvent bpe = env.resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n+        BreakpointEvent bpe = resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n@@ -1468,1 +1486,1 @@\n-        BreakpointEvent bpe = env.resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n+        BreakpointEvent bpe = resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n@@ -1511,1 +1529,1 @@\n-        BreakpointEvent bpe = env.resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n+        BreakpointEvent bpe = resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n@@ -1542,1 +1560,1 @@\n-        BreakpointEvent bpe = env.resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n+        BreakpointEvent bpe = resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n@@ -1583,1 +1601,1 @@\n-        BreakpointEvent bpe = env.resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n+        BreakpointEvent bpe = resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n@@ -1626,1 +1644,1 @@\n-        BreakpointEvent bpe = env.resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n+        BreakpointEvent bpe = resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n@@ -1672,1 +1690,1 @@\n-        BreakpointEvent bpe = env.resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n+        BreakpointEvent bpe = resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n@@ -1692,1 +1710,1 @@\n-        BreakpointEvent bpe = env.resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n+        BreakpointEvent bpe = resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n@@ -1730,1 +1748,1 @@\n-        BreakpointEvent bpe = env.resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n+        BreakpointEvent bpe = resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n@@ -1757,1 +1775,1 @@\n-        BreakpointEvent bpe = env.resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n+        BreakpointEvent bpe = resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n@@ -1807,1 +1825,1 @@\n-        BreakpointEvent bpe = env.resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n+        BreakpointEvent bpe = resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n@@ -1849,1 +1867,1 @@\n-        BreakpointEvent bpe = env.resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n+        BreakpointEvent bpe = resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n@@ -1866,1 +1884,1 @@\n-        BreakpointEvent bpe = env.resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n+        BreakpointEvent bpe = resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n@@ -1906,1 +1924,1 @@\n-        BreakpointEvent bpe = env.resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n+        BreakpointEvent bpe = resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n@@ -1945,1 +1963,1 @@\n-        BreakpointEvent bpe = env.resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n+        BreakpointEvent bpe = resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n@@ -1991,1 +2009,1 @@\n-        BreakpointEvent bpe = env.resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n+        BreakpointEvent bpe = resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n@@ -2040,1 +2058,1 @@\n-        BreakpointEvent bpe = env.resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n+        BreakpointEvent bpe = resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n@@ -2085,1 +2103,1 @@\n-        env.targetMainThread.resume();\n+        env.vm().resume();\n@@ -2187,1 +2205,1 @@\n-        BreakpointEvent bpe = env.resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n+        BreakpointEvent bpe = resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n@@ -2242,1 +2260,1 @@\n-        BreakpointEvent bpe = env.resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n+        BreakpointEvent bpe = resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n@@ -2259,1 +2277,1 @@\n-        BreakpointEvent bpe = env.resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n+        BreakpointEvent bpe = resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n@@ -2305,1 +2323,1 @@\n-        BreakpointEvent bpe = env.resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n+        BreakpointEvent bpe = resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n@@ -2354,1 +2372,1 @@\n-        BreakpointEvent bpe = env.resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n+        BreakpointEvent bpe = resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n@@ -2408,1 +2426,1 @@\n-        BreakpointEvent bpe = env.resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n+        BreakpointEvent bpe = resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n@@ -2465,1 +2483,1 @@\n-        env.targetMainThread.resume();\n+        env.vm().resume();\n@@ -2514,1 +2532,1 @@\n-        env.targetMainThread.resume();\n+        env.vm().resume();\n@@ -2541,1 +2559,1 @@\n-        BreakpointEvent bpe = env.resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n+        BreakpointEvent bpe = resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n@@ -2593,1 +2611,1 @@\n-        BreakpointEvent bpe = env.resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n+        BreakpointEvent bpe = resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n@@ -2686,1 +2704,1 @@\n-        thread.resume();\n+        env.vm().resume();\n@@ -2803,1 +2821,1 @@\n-        BreakpointEvent bpe = env.resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n+        BreakpointEvent bpe = resumeTo(TARGET_TESTCASE_BASE_NAME, \"dontinline_brkpt\", \"()V\");\n@@ -2870,1 +2888,1 @@\n-        thread.resume();\n+        env.vm().resume();\n@@ -2954,1 +2972,1 @@\n-        thread.resume();\n+        env.vm().resume();\n@@ -3076,1 +3094,1 @@\n-        env.targetMainThread.resume();\n+        env.vm().resume();\n","filename":"test\/jdk\/com\/sun\/jdi\/EATests.java","additions":73,"deletions":55,"binary":false,"changes":128,"status":"modified"},{"patch":"@@ -842,0 +842,6 @@\n+        return resumeTo(clsName, methodName, methodSignature, false \/* suspendThread *\/);\n+    }\n+\n+    public BreakpointEvent resumeTo(String clsName, String methodName,\n+                                    String methodSignature,\n+                                    boolean suspendThread) {\n@@ -853,1 +859,1 @@\n-        return resumeTo(method.location());\n+        return resumeTo(method.location(), suspendThread);\n","filename":"test\/jdk\/com\/sun\/jdi\/TestScaffold.java","additions":7,"deletions":1,"binary":false,"changes":8,"status":"modified"}]}