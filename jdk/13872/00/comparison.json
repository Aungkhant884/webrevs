{"files":[{"patch":"@@ -797,1 +797,1 @@\n-                                        int index) {\n+                                        int index, Bytecodes::Code bc) {\n@@ -800,1 +800,1 @@\n-    ciField* field = new (arena()) ciField(accessor, index);\n+    ciField* field = new (arena()) ciField(accessor, index, bc);\n@@ -805,1 +805,1 @@\n-      field = new (arena()) ciField(accessor, index);\n+      field = new (arena()) ciField(accessor, index, bc);\n@@ -817,2 +817,2 @@\n-                                   int index) {\n-  GUARDED_VM_ENTRY(return get_field_by_index_impl(accessor, index);)\n+                                   int index, Bytecodes::Code bc) {\n+  GUARDED_VM_ENTRY(return get_field_by_index_impl(accessor, index, bc);)\n@@ -885,1 +885,1 @@\n-    ciSymbol*        signature = get_symbol(cpool->signature_ref_at(index));\n+    ciSymbol*        signature = get_symbol(cpool->signature_ref_at(index, bc));\n@@ -888,1 +888,1 @@\n-    const int holder_index = cpool->klass_ref_index_at(index);\n+    const int holder_index = cpool->klass_ref_index_at(index, bc);\n@@ -893,2 +893,2 @@\n-    Symbol* name_sym = cpool->name_ref_at(index);\n-    Symbol* sig_sym  = cpool->signature_ref_at(index);\n+    Symbol* name_sym = cpool->name_ref_at(index, bc);\n+    Symbol* sig_sym  = cpool->signature_ref_at(index, bc);\n@@ -920,1 +920,1 @@\n-      constantTag tag = cpool->tag_ref_at(index);\n+      constantTag tag = cpool->tag_ref_at(index, bc);\n@@ -1536,1 +1536,1 @@\n-  const int holder_index = cp->klass_ref_index_at(index);\n+  const int holder_index = cp->klass_ref_index_at(index, Bytecodes::_invokehandle);\n@@ -1541,1 +1541,1 @@\n-  Symbol* name = cp->name_ref_at(index);\n+  Symbol* name = cp->name_ref_at(index, Bytecodes::_invokehandle);\n","filename":"src\/hotspot\/share\/ci\/ciEnv.cpp","additions":12,"deletions":12,"binary":false,"changes":24,"status":"modified"},{"patch":"@@ -134,1 +134,1 @@\n-                                int field_index);\n+                                int field_index, Bytecodes::Code bc);\n@@ -152,1 +152,1 @@\n-                                     int field_index);\n+                                     int field_index, Bytecodes::Code bc);\n","filename":"src\/hotspot\/share\/ci\/ciEnv.hpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -73,1 +73,1 @@\n-ciField::ciField(ciInstanceKlass* klass, int index) :\n+ciField::ciField(ciInstanceKlass* klass, int index, Bytecodes::Code bc) :\n@@ -85,1 +85,1 @@\n-  Symbol* name  = cpool->name_ref_at(index);\n+  Symbol* name  = cpool->name_ref_at(index, bc);\n@@ -88,1 +88,1 @@\n-  int nt_index = cpool->name_and_type_ref_index_at(index);\n+  int nt_index = cpool->name_and_type_ref_index_at(index, bc);\n@@ -112,1 +112,1 @@\n-  int holder_index = cpool->klass_ref_index_at(index);\n+  int holder_index = cpool->klass_ref_index_at(index, bc);\n","filename":"src\/hotspot\/share\/ci\/ciField.cpp","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -59,1 +59,1 @@\n-  ciField(ciInstanceKlass* klass, int index);\n+  ciField(ciInstanceKlass* klass, int index, Bytecodes::Code bc);\n","filename":"src\/hotspot\/share\/ci\/ciField.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -1181,1 +1181,1 @@\n-bool ciMethod::is_klass_loaded(int refinfo_index, bool must_be_resolved) const {\n+bool ciMethod::is_klass_loaded(int refinfo_index, Bytecodes::Code bc, bool must_be_resolved) const {\n@@ -1183,1 +1183,1 @@\n-  return get_Method()->is_klass_loaded(refinfo_index, must_be_resolved);\n+  return get_Method()->is_klass_loaded(refinfo_index, bc, must_be_resolved);\n","filename":"src\/hotspot\/share\/ci\/ciMethod.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -314,1 +314,1 @@\n-  bool is_klass_loaded(int refinfo_index, bool must_be_resolved) const;\n+  bool is_klass_loaded(int refinfo_index, Bytecodes::Code bc, bool must_be_resolved) const;\n","filename":"src\/hotspot\/share\/ci\/ciMethod.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -431,2 +431,2 @@\n-        Klass* holder = cp->klass_ref_at(index, CHECK_NULL);\n-        Symbol* name = cp->name_ref_at(index);\n+        Klass* holder = cp->klass_ref_at(index, bytecode.code(), CHECK_NULL);\n+        Symbol* name = cp->name_ref_at(index, bytecode.code());\n","filename":"src\/hotspot\/share\/ci\/ciReplay.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -311,1 +311,1 @@\n-  ciField* f = CURRENT_ENV->get_field_by_index(_holder, get_field_index());\n+  ciField* f = CURRENT_ENV->get_field_by_index(_holder, get_field_index(), _bc);\n@@ -346,1 +346,1 @@\n-    return cpool->klass_ref_index_at(get_field_index());\n+    return cpool->klass_ref_index_at(get_field_index(), _bc);\n@@ -530,1 +530,1 @@\n-  return cpool->klass_ref_index_at(get_method_index());\n+  return cpool->klass_ref_index_at(get_method_index(), _bc);\n@@ -542,1 +542,1 @@\n-    const int name_and_type_index = cpool->name_and_type_ref_index_at(method_index);\n+    const int name_and_type_index = cpool->name_and_type_ref_index_at(method_index, _bc);\n","filename":"src\/hotspot\/share\/ci\/ciStreams.cpp","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -134,1 +134,1 @@\n-  return constants()->klass_ref_at_noresolve(index());\n+  return constants()->klass_ref_at_noresolve(index(), _code);\n@@ -139,1 +139,1 @@\n-  return constants()->name_ref_at(index());\n+  return constants()->name_ref_at(index(), _code);\n@@ -144,1 +144,1 @@\n-  return constants()->signature_ref_at(index());\n+  return constants()->signature_ref_at(index(), _code);\n","filename":"src\/hotspot\/share\/interpreter\/bytecode.cpp","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -274,1 +274,1 @@\n-static void print_method_name(outputStream *os, Method* method, int cp_index) {\n+static void print_method_name(outputStream *os, Method* method, int cp_index, Bytecodes::Code bc) {\n@@ -277,3 +277,3 @@\n-  Symbol* klass     = cp->klass_ref_at_noresolve(cp_index);\n-  Symbol* name      = cp->name_ref_at(cp_index);\n-  Symbol* signature = cp->signature_ref_at(cp_index);\n+  Symbol* klass     = cp->klass_ref_at_noresolve(cp_index, bc);\n+  Symbol* name      = cp->name_ref_at(cp_index, bc);\n+  Symbol* signature = cp->signature_ref_at(cp_index, bc);\n@@ -290,1 +290,1 @@\n-static void print_field_and_class(outputStream *os, Method* method, int cp_index) {\n+static void print_field_and_class(outputStream *os, Method* method, int cp_index, Bytecodes::Code bc) {\n@@ -293,2 +293,2 @@\n-  Symbol* klass    = cp->klass_ref_at_noresolve(cp_index);\n-  Symbol *name     = cp->name_ref_at(cp_index);\n+  Symbol* klass    = cp->klass_ref_at_noresolve(cp_index, bc);\n+  Symbol *name     = cp->name_ref_at(cp_index, bc);\n@@ -301,2 +301,2 @@\n-static char const* get_field_name(Method* method, int cp_index) {\n-  Symbol* name = method->constants()->name_ref_at(cp_index);\n+static char const* get_field_name(Method* method, int cp_index, Bytecodes::Code bc) {\n+  Symbol* name = method->constants()->name_ref_at(cp_index, bc);\n@@ -973,1 +973,1 @@\n-      int name_and_type_index = cp->name_and_type_ref_index_at(cp_index);\n+      int name_and_type_index = cp->name_and_type_ref_index_at(cp_index, code);\n@@ -987,1 +987,1 @@\n-      int name_and_type_index = cp->name_and_type_ref_index_at(cp_index);\n+      int name_and_type_index = cp->name_and_type_ref_index_at(cp_index, code);\n@@ -1009,1 +1009,1 @@\n-      int name_and_type_index = cp->name_and_type_ref_index_at(cp_index);\n+      int name_and_type_index = cp->name_and_type_ref_index_at(cp_index, code);\n@@ -1137,1 +1137,1 @@\n-        int name_and_type_index = cp->name_and_type_ref_index_at(cp_index);\n+        int name_and_type_index = cp->name_and_type_ref_index_at(cp_index, code);\n@@ -1148,1 +1148,1 @@\n-        int name_and_type_index = cp->name_and_type_ref_index_at(cp_index);\n+        int name_and_type_index = cp->name_and_type_ref_index_at(cp_index, code);\n@@ -1330,1 +1330,1 @@\n-      print_field_and_class(os, _method, cp_index);\n+      print_field_and_class(os, _method, cp_index, code);\n@@ -1341,1 +1341,1 @@\n-      os->print(\"%s\", get_field_name(_method, cp_index));\n+      os->print(\"%s\", get_field_name(_method, cp_index, code));\n@@ -1353,1 +1353,1 @@\n-      print_method_name(os, _method, cp_index);\n+      print_method_name(os, _method, cp_index, code);\n@@ -1419,1 +1419,1 @@\n-        int name_and_type_index = cp->name_and_type_ref_index_at(cp_index);\n+        int name_and_type_index = cp->name_and_type_ref_index_at(cp_index, code);\n@@ -1426,1 +1426,1 @@\n-        os->print(\"Cannot assign field \\\"%s\\\"\", get_field_name(_method, cp_index));\n+        os->print(\"Cannot assign field \\\"%s\\\"\", get_field_name(_method, cp_index, code));\n@@ -1433,1 +1433,1 @@\n-        print_method_name(os, _method, cp_index);\n+        print_method_name(os, _method, cp_index, code);\n","filename":"src\/hotspot\/share\/interpreter\/bytecodeUtils.cpp","additions":20,"deletions":20,"binary":false,"changes":40,"status":"modified"},{"patch":"@@ -1508,2 +1508,2 @@\n-  Symbol* cname = cpool->klass_name_at(cpool->klass_ref_index_at(cp_index));\n-  Symbol* mname = cpool->name_ref_at(cp_index);\n+  Symbol* cname = cpool->klass_name_at(cpool->klass_ref_index_at(cp_index, code));\n+  Symbol* mname = cpool->name_ref_at(cp_index, code);\n","filename":"src\/hotspot\/share\/interpreter\/interpreterRuntime.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -231,1 +231,1 @@\n-LinkInfo::LinkInfo(const constantPoolHandle& pool, int index, const methodHandle& current_method, TRAPS) {\n+LinkInfo::LinkInfo(const constantPoolHandle& pool, int index, const methodHandle& current_method, Bytecodes::Code code, TRAPS) {\n@@ -233,1 +233,1 @@\n-  _resolved_klass = pool->klass_ref_at(index, CHECK);\n+  _resolved_klass = pool->klass_ref_at(index, code, CHECK);\n@@ -236,3 +236,3 @@\n-  _name          = pool->name_ref_at(index);\n-  _signature     = pool->signature_ref_at(index);\n-  _tag           = pool->tag_ref_at(index);\n+  _name          = pool->name_ref_at(index, code);\n+  _signature     = pool->signature_ref_at(index, code);\n+  _tag           = pool->tag_ref_at(index, code);\n@@ -247,1 +247,1 @@\n-LinkInfo::LinkInfo(const constantPoolHandle& pool, int index, TRAPS) {\n+LinkInfo::LinkInfo(const constantPoolHandle& pool, int index, Bytecodes::Code code, TRAPS) {\n@@ -249,1 +249,1 @@\n-  _resolved_klass = pool->klass_ref_at(index, CHECK);\n+  _resolved_klass = pool->klass_ref_at(index, code, CHECK);\n@@ -252,3 +252,3 @@\n-  _name          = pool->name_ref_at(index);\n-  _signature     = pool->signature_ref_at(index);\n-  _tag           = pool->tag_ref_at(index);\n+  _name          = pool->name_ref_at(index, code);\n+  _signature     = pool->signature_ref_at(index, code);\n+  _tag           = pool->tag_ref_at(index, code);\n@@ -621,1 +621,1 @@\n-    Symbol* method_signature = pool->signature_ref_at(index);\n+    Symbol* method_signature = pool->signature_ref_at(index, code);\n@@ -627,1 +627,1 @@\n-  LinkInfo link_info(pool, index, methodHandle(), CHECK_NULL);\n+  LinkInfo link_info(pool, index, methodHandle(), code, CHECK_NULL);\n@@ -953,1 +953,1 @@\n-  LinkInfo link_info(pool, index, method, CHECK);\n+  LinkInfo link_info(pool, index, method, byte, CHECK);\n@@ -1671,1 +1671,1 @@\n-  LinkInfo link_info(pool, index, CHECK);\n+  LinkInfo link_info(pool, index, Bytecodes::_invokestatic, CHECK);\n@@ -1678,1 +1678,1 @@\n-  LinkInfo link_info(pool, index, CHECK);\n+  LinkInfo link_info(pool, index, Bytecodes::_invokespecial, CHECK);\n@@ -1687,1 +1687,1 @@\n-  LinkInfo link_info(pool, index, CHECK);\n+  LinkInfo link_info(pool, index, Bytecodes::_invokevirtual, CHECK);\n@@ -1694,1 +1694,1 @@\n-  LinkInfo link_info(pool, index, CHECK);\n+  LinkInfo link_info(pool, index, Bytecodes::_invokeinterface, CHECK);\n@@ -1715,1 +1715,1 @@\n-  LinkInfo link_info(pool, index, CHECK);\n+  LinkInfo link_info(pool, index, Bytecodes::_invokehandle, CHECK);\n","filename":"src\/hotspot\/share\/interpreter\/linkResolver.cpp","additions":18,"deletions":18,"binary":false,"changes":36,"status":"modified"},{"patch":"@@ -149,2 +149,2 @@\n-  LinkInfo(const constantPoolHandle& pool, int index, const methodHandle& current_method, TRAPS);\n-  LinkInfo(const constantPoolHandle& pool, int index, TRAPS);\n+  LinkInfo(const constantPoolHandle& pool, int index, const methodHandle& current_method, Bytecodes::Code code, TRAPS);\n+  LinkInfo(const constantPoolHandle& pool, int index, Bytecodes::Code code, TRAPS);\n","filename":"src\/hotspot\/share\/interpreter\/linkResolver.hpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -819,1 +819,1 @@\n-  return cp->name_and_type_ref_index_at(index);\n+  return cp->uncached_name_and_type_ref_index_at(index);\n@@ -824,1 +824,1 @@\n-  JVMCIObject sym = JVMCIENV->create_string(cp->name_ref_at(which), JVMCI_CHECK_NULL);\n+  JVMCIObject sym = JVMCIENV->create_string(cp->uncached_name_ref_at(which), JVMCI_CHECK_NULL);\n@@ -830,1 +830,1 @@\n-  JVMCIObject sym = JVMCIENV->create_string(cp->signature_ref_at(which), JVMCI_CHECK_NULL);\n+  JVMCIObject sym = JVMCIENV->create_string(cp->uncached_signature_ref_at(which), JVMCI_CHECK_NULL);\n@@ -836,1 +836,1 @@\n-  return cp->klass_ref_index_at(index);\n+  return cp->uncached_klass_ref_index_at(index);\n@@ -909,1 +909,1 @@\n-  LinkInfo link_info(cp, index, mh, CHECK_NULL);\n+  LinkInfo link_info(cp, index, mh, code, CHECK_NULL);\n@@ -1595,2 +1595,2 @@\n-  Klass* holder = cp->klass_ref_at(index, CHECK);\n-  Symbol* name = cp->name_ref_at(index);\n+  Klass* holder = cp->klass_ref_at(index, Bytecodes::_invokehandle, CHECK);\n+  Symbol* name = cp->name_ref_at(index, Bytecodes::_invokehandle);\n@@ -1612,1 +1612,1 @@\n-    LinkInfo link_info(cp, index, CATCH);\n+    LinkInfo link_info(cp, index, Bytecodes::_invokehandle, CATCH);\n@@ -1616,1 +1616,1 @@\n-    Symbol* name_sym = cp->name_ref_at(index);\n+    Symbol* name_sym = cp->name_ref_at(index, Bytecodes::_invokehandle);\n","filename":"src\/hotspot\/share\/jvmci\/jvmciCompilerToVM.cpp","additions":9,"deletions":9,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -1809,1 +1809,1 @@\n-  Symbol* name  = cpool->name_ref_at(index);\n+  Symbol* name  = cpool->name_ref_at(index, Bytecodes::_getfield \/*We know it's a field*\/);\n@@ -1811,1 +1811,1 @@\n-  int nt_index = cpool->name_and_type_ref_index_at(index);\n+  int nt_index = cpool->name_and_type_ref_index_at(index, Bytecodes::_getfield);\n@@ -1816,1 +1816,1 @@\n-  int holder_index = cpool->klass_ref_index_at(index);\n+  int holder_index = cpool->klass_ref_index_at(index, Bytecodes::_getfield);\n@@ -1891,1 +1891,1 @@\n-  int holder_index = cpool->klass_ref_index_at(index);\n+  int holder_index = cpool->klass_ref_index_at(index, bc);\n@@ -1896,2 +1896,2 @@\n-  Symbol* name_sym = cpool->name_ref_at(index);\n-  Symbol* sig_sym  = cpool->signature_ref_at(index);\n+  Symbol* name_sym = cpool->name_ref_at(index, bc);\n+  Symbol* sig_sym  = cpool->signature_ref_at(index, bc);\n@@ -1923,1 +1923,1 @@\n-    constantTag tag = cpool->tag_ref_at(index);\n+    constantTag tag = cpool->tag_ref_at(index, bc);\n","filename":"src\/hotspot\/share\/jvmci\/jvmciRuntime.cpp","additions":7,"deletions":7,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -678,9 +678,21 @@\n-Symbol* ConstantPool::impl_name_ref_at(int which, bool uncached) {\n-  int name_index = name_ref_index_at(impl_name_and_type_ref_index_at(which, uncached));\n-  return symbol_at(name_index);\n-}\n-\n-\n-Symbol* ConstantPool::impl_signature_ref_at(int which, bool uncached) {\n-  int signature_index = signature_ref_index_at(impl_name_and_type_ref_index_at(which, uncached));\n-  return symbol_at(signature_index);\n+int ConstantPool::cp_index_helper(int index, Bytecodes::Code code) {\n+  assert(cache() != nullptr, \"'index' is a rewritten index so this class must have been rewritten\");\n+  switch(code) {\n+    case Bytecodes::_invokedynamic:\n+      return invokedynamic_bootstrap_ref_index_at(index);\n+    case Bytecodes::_getfield:\n+    case Bytecodes::_getstatic:\n+    case Bytecodes::_putfield:\n+    case Bytecodes::_putstatic:\n+      \/\/ TODO: handle resolved field entries with new structure\n+      \/\/ i = ....\n+    case Bytecodes::_invokeinterface:\n+    case Bytecodes::_invokehandle:\n+    case Bytecodes::_invokespecial:\n+    case Bytecodes::_invokestatic:\n+    case Bytecodes::_invokevirtual:\n+      \/\/ TODO: handle resolved method entries with new structure\n+    default:\n+      \/\/ change byte-ordering and go via cache\n+      return remap_instruction_operand_from_cache(index);\n+  }\n@@ -689,19 +701,5 @@\n-int ConstantPool::impl_name_and_type_ref_index_at(int which, bool uncached) {\n-  int i = which;\n-  if (!uncached) {\n-    assert(cache() != nullptr, \"'which' is a rewritten index so this class must have been rewritten\");\n-    if (ConstantPool::is_invokedynamic_index(which)) {\n-      \/\/ Invokedynamic index is index into the resolved indy array in the constant pool cache\n-      int pool_index = invokedynamic_bootstrap_ref_index_at(which);\n-      pool_index = bootstrap_name_and_type_ref_index_at(pool_index);\n-      assert(tag_at(pool_index).is_name_and_type(), \"\");\n-      return pool_index;\n-    }\n-    \/\/ change byte-ordering and go via cache\n-    i = remap_instruction_operand_from_cache(which);\n-  } else {\n-    if (tag_at(which).has_bootstrap()) {\n-      int pool_index = bootstrap_name_and_type_ref_index_at(which);\n-      assert(tag_at(pool_index).is_name_and_type(), \"\");\n-      return pool_index;\n-    }\n+int ConstantPool::uncached_name_and_type_ref_index_at(int cp_index)  {\n+  if (tag_at(cp_index).has_bootstrap()) {\n+    int pool_index = bootstrap_name_and_type_ref_index_at(cp_index);\n+    assert(tag_at(pool_index).is_name_and_type(), \"\");\n+    return pool_index;\n@@ -709,3 +707,3 @@\n-  assert(tag_at(i).is_field_or_method(), \"Corrupted constant pool\");\n-  assert(!tag_at(i).has_bootstrap(), \"Must be handled above\");\n-  jint ref_index = *int_at_addr(i);\n+  assert(tag_at(cp_index).is_field_or_method(), \"Corrupted constant pool\");\n+  assert(!tag_at(cp_index).has_bootstrap(), \"Must be handled above\");\n+  jint ref_index = *int_at_addr(cp_index);\n@@ -715,1 +713,6 @@\n-constantTag ConstantPool::impl_tag_ref_at(int which, bool uncached) {\n+int ConstantPool::name_and_type_ref_index_at(int index, Bytecodes::Code code) {\n+  return uncached_name_and_type_ref_index_at(cp_index_helper(index, code));\n+}\n+\n+constantTag ConstantPool::tag_ref_at(int which, Bytecodes::Code code) {\n+  \/\/ which may be either a Constant Pool index or a rewritten index\n@@ -717,9 +720,2 @@\n-  if (!uncached) {\n-    assert(cache() != nullptr, \"'which' is a rewritten index so this class must have been rewritten\");\n-    if (ConstantPool::is_invokedynamic_index(which)) {\n-      \/\/ Invokedynamic index is index into resolved_references\n-      pool_index = invokedynamic_bootstrap_ref_index_at(which);\n-    } else {\n-      \/\/ change byte-ordering and go via cache\n-      pool_index = remap_instruction_operand_from_cache(which);\n-    }\n+  if (cache() != nullptr) {\n+    pool_index = cp_index_helper(which, code);\n@@ -730,11 +726,3 @@\n-int ConstantPool::impl_klass_ref_index_at(int which, bool uncached) {\n-  guarantee(!ConstantPool::is_invokedynamic_index(which),\n-            \"an invokedynamic instruction does not have a klass\");\n-  int i = which;\n-  if (!uncached) {\n-    assert(cache() != nullptr, \"'which' is a rewritten index so this class must have been rewritten\");\n-    \/\/ change byte-ordering and go via cache\n-    i = remap_instruction_operand_from_cache(which);\n-  }\n-  assert(tag_at(i).is_field_or_method(), \"Corrupted constant pool\");\n-  jint ref_index = *int_at_addr(i);\n+int ConstantPool::uncached_klass_ref_index_at(int cp_index) {\n+  assert(tag_at(cp_index).is_field_or_method(), \"Corrupted constant pool\");\n+  jint ref_index = *int_at_addr(cp_index);\n@@ -744,0 +732,7 @@\n+int ConstantPool::klass_ref_index_at(int index, Bytecodes::Code code) {\n+  guarantee(!ConstantPool::is_invokedynamic_index(index),\n+            \"an invokedynamic instruction does not have a klass\");\n+  assert(code != Bytecodes::_invokedynamic,\n+            \"an invokedynamic instruction does not have a klass\");\n+  return uncached_klass_ref_index_at(cp_index_helper(index, code));\n+}\n@@ -776,2 +771,2 @@\n-Klass* ConstantPool::klass_ref_at(int which, TRAPS) {\n-  return klass_at(klass_ref_index_at(which), THREAD);\n+Klass* ConstantPool::klass_ref_at(int which, Bytecodes::Code code, TRAPS) {\n+  return klass_at(klass_ref_index_at(which, code), THREAD);\n@@ -784,2 +779,2 @@\n-Symbol* ConstantPool::klass_ref_at_noresolve(int which) {\n-  jint ref_index = klass_ref_index_at(which);\n+Symbol* ConstantPool::klass_ref_at_noresolve(int which, Bytecodes::Code code) {\n+  jint ref_index = klass_ref_index_at(which, code);\n","filename":"src\/hotspot\/share\/oops\/constantPool.cpp","additions":51,"deletions":56,"binary":false,"changes":107,"status":"modified"},{"patch":"@@ -504,1 +504,1 @@\n-    return impl_name_ref_at(member, true);\n+    return uncached_name_ref_at(member);\n@@ -508,1 +508,1 @@\n-    return impl_signature_ref_at(member, true);\n+    return uncached_signature_ref_at(member);\n@@ -512,1 +512,1 @@\n-    return impl_klass_ref_index_at(member, true);\n+    return uncached_klass_ref_index_at(member);\n@@ -660,4 +660,10 @@\n-  Klass* klass_ref_at(int which, TRAPS);\n-  Symbol* klass_ref_at_noresolve(int which);\n-  Symbol* name_ref_at(int which)                { return impl_name_ref_at(which, false); }\n-  Symbol* signature_ref_at(int which)           { return impl_signature_ref_at(which, false); }\n+  Klass* klass_ref_at(int which, Bytecodes::Code code, TRAPS);\n+  Symbol* klass_ref_at_noresolve(int which, Bytecodes::Code code);\n+  Symbol* name_ref_at(int which, Bytecodes::Code code) {\n+    int name_index = name_ref_index_at(name_and_type_ref_index_at(which, code));\n+    return symbol_at(name_index);\n+  }\n+  Symbol* signature_ref_at(int which, Bytecodes::Code code) {\n+    int signature_index = signature_ref_index_at(name_and_type_ref_index_at(which, code));\n+    return symbol_at(signature_index);\n+  }\n@@ -665,2 +671,2 @@\n-  int klass_ref_index_at(int which)               { return impl_klass_ref_index_at(which, false); }\n-  int name_and_type_ref_index_at(int which)       { return impl_name_and_type_ref_index_at(which, false); }\n+  int klass_ref_index_at(int which, Bytecodes::Code code);\n+  int name_and_type_ref_index_at(int which, Bytecodes::Code code);\n@@ -670,1 +676,3 @@\n-  constantTag tag_ref_at(int cp_cache_index)      { return impl_tag_ref_at(cp_cache_index, false); }\n+  constantTag tag_ref_at(int cp_cache_index, Bytecodes::Code code);\n+\n+  int cp_index_helper(int which, Bytecodes::Code code);\n@@ -772,5 +780,11 @@\n-  Symbol* uncached_klass_ref_at_noresolve(int which);\n-  Symbol* uncached_name_ref_at(int which)                 { return impl_name_ref_at(which, true); }\n-  Symbol* uncached_signature_ref_at(int which)            { return impl_signature_ref_at(which, true); }\n-  int       uncached_klass_ref_index_at(int which)          { return impl_klass_ref_index_at(which, true); }\n-  int       uncached_name_and_type_ref_index_at(int which)  { return impl_name_and_type_ref_index_at(which, true); }\n+  Symbol* uncached_klass_ref_at_noresolve(int cp_index);\n+  Symbol* uncached_name_ref_at(int cp_index) {\n+    int name_index = name_ref_index_at(uncached_name_and_type_ref_index_at(cp_index));\n+    return symbol_at(name_index);\n+  }\n+  Symbol* uncached_signature_ref_at(int cp_index) {\n+    int signature_index = signature_ref_index_at(uncached_name_and_type_ref_index_at(cp_index));\n+    return symbol_at(signature_index);\n+  }\n+  int       uncached_klass_ref_index_at(int cp_index);\n+  int       uncached_name_and_type_ref_index_at(int cp_index);\n@@ -803,7 +817,0 @@\n-  Symbol* impl_name_ref_at(int which, bool uncached);\n-  Symbol* impl_signature_ref_at(int which, bool uncached);\n-\n-  int       impl_klass_ref_index_at(int which, bool uncached);\n-  int       impl_name_and_type_ref_index_at(int which, bool uncached);\n-  constantTag impl_tag_ref_at(int which, bool uncached);\n-\n","filename":"src\/hotspot\/share\/oops\/constantPool.hpp","additions":29,"deletions":22,"binary":false,"changes":51,"status":"modified"},{"patch":"@@ -1323,1 +1323,1 @@\n-      int nameAndTypeIdx    = cp->name_and_type_ref_index_at(idx);\n+      int nameAndTypeIdx    = cp->name_and_type_ref_index_at(idx, currentBC->code());\n@@ -1600,4 +1600,4 @@\n-    case Bytecodes::_getstatic:         do_field(true,  true,  itr->get_index_u2_cpcache(), itr->bci()); break;\n-    case Bytecodes::_putstatic:         do_field(false, true,  itr->get_index_u2_cpcache(), itr->bci()); break;\n-    case Bytecodes::_getfield:          do_field(true,  false, itr->get_index_u2_cpcache(), itr->bci()); break;\n-    case Bytecodes::_putfield:          do_field(false, false, itr->get_index_u2_cpcache(), itr->bci()); break;\n+    case Bytecodes::_getstatic:         do_field(true,  true,  itr->get_index_u2_cpcache(), itr->bci(), itr->code()); break;\n+    case Bytecodes::_putstatic:         do_field(false, true,  itr->get_index_u2_cpcache(), itr->bci(), itr->code()); break;\n+    case Bytecodes::_getfield:          do_field(true,  false, itr->get_index_u2_cpcache(), itr->bci(), itr->code()); break;\n+    case Bytecodes::_putfield:          do_field(false, false, itr->get_index_u2_cpcache(), itr->bci(), itr->code()); break;\n@@ -1606,4 +1606,4 @@\n-    case Bytecodes::_invokespecial:     do_method(false, false, itr->get_index_u2_cpcache(), itr->bci()); break;\n-    case Bytecodes::_invokestatic:      do_method(true,  false, itr->get_index_u2_cpcache(), itr->bci()); break;\n-    case Bytecodes::_invokedynamic:     do_method(true,  false, itr->get_index_u4(),         itr->bci()); break;\n-    case Bytecodes::_invokeinterface:   do_method(false, true,  itr->get_index_u2_cpcache(), itr->bci()); break;\n+    case Bytecodes::_invokespecial:     do_method(false, false, itr->get_index_u2_cpcache(), itr->bci(), itr->code()); break;\n+    case Bytecodes::_invokestatic:      do_method(true,  false, itr->get_index_u2_cpcache(), itr->bci(), itr->code()); break;\n+    case Bytecodes::_invokedynamic:     do_method(true,  false, itr->get_index_u4(),         itr->bci(), itr->code()); break;\n+    case Bytecodes::_invokeinterface:   do_method(false, true,  itr->get_index_u2_cpcache(), itr->bci(), itr->code()); break;\n@@ -1934,1 +1934,1 @@\n-void GenerateOopMap::do_field(int is_get, int is_static, int idx, int bci) {\n+void GenerateOopMap::do_field(int is_get, int is_static, int idx, int bci, Bytecodes::Code bc) {\n@@ -1937,1 +1937,1 @@\n-  int nameAndTypeIdx     = cp->name_and_type_ref_index_at(idx);\n+  int nameAndTypeIdx     = cp->name_and_type_ref_index_at(idx, bc);\n@@ -1960,1 +1960,1 @@\n-void GenerateOopMap::do_method(int is_static, int is_interface, int idx, int bci) {\n+void GenerateOopMap::do_method(int is_static, int is_interface, int idx, int bci, Bytecodes::Code bc) {\n@@ -1963,1 +1963,1 @@\n-  Symbol* signature   = cp->signature_ref_at(idx);\n+  Symbol* signature   = cp->signature_ref_at(idx, bc);\n","filename":"src\/hotspot\/share\/oops\/generateOopMap.cpp","additions":13,"deletions":13,"binary":false,"changes":26,"status":"modified"},{"patch":"@@ -399,2 +399,2 @@\n-  void  do_field                            (int is_get, int is_static, int idx, int bci);\n-  void  do_method                           (int is_static, int is_interface, int idx, int bci);\n+  void  do_field                            (int is_get, int is_static, int idx, int bci, Bytecodes::Code bc);\n+  void  do_method                           (int is_static, int is_interface, int idx, int bci, Bytecodes::Code bc);\n","filename":"src\/hotspot\/share\/oops\/generateOopMap.hpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -980,2 +980,2 @@\n-bool Method::is_klass_loaded(int refinfo_index, bool must_be_resolved) const {\n-  int klass_index = constants()->klass_ref_index_at(refinfo_index);\n+bool Method::is_klass_loaded(int refinfo_index, Bytecodes::Code bc, bool must_be_resolved) const {\n+  int klass_index = constants()->klass_ref_index_at(refinfo_index, bc);\n","filename":"src\/hotspot\/share\/oops\/method.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -845,1 +845,1 @@\n-  bool is_klass_loaded(int refinfo_index, bool must_be_resolved = false) const;\n+  bool is_klass_loaded(int refinfo_index, Bytecodes::Code bc, bool must_be_resolved = false) const;\n","filename":"src\/hotspot\/share\/oops\/method.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -512,1 +512,1 @@\n-      if (!caller_method->is_klass_loaded(index, true)) {\n+      if (!caller_method->is_klass_loaded(index, call_bc, true)) {\n","filename":"src\/hotspot\/share\/opto\/bytecodeInfo.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -99,3 +99,3 @@\n-    if ((old_cp->klass_ref_at_noresolve(cpci_old) != new_cp->klass_ref_at_noresolve(cpci_new)) ||\n-        (old_cp->name_ref_at(cpci_old) != new_cp->name_ref_at(cpci_new)) ||\n-        (old_cp->signature_ref_at(cpci_old) != new_cp->signature_ref_at(cpci_new)))\n+    if ((old_cp->klass_ref_at_noresolve(cpci_old, c_old) != new_cp->klass_ref_at_noresolve(cpci_new, c_old)) ||\n+        (old_cp->name_ref_at(cpci_old, c_old) != new_cp->name_ref_at(cpci_new, c_old)) ||\n+        (old_cp->signature_ref_at(cpci_old, c_old) != new_cp->signature_ref_at(cpci_new, c_old)))\n@@ -117,2 +117,2 @@\n-    if ((old_cp->name_ref_at(index_old) != new_cp->name_ref_at(index_new)) ||\n-        (old_cp->signature_ref_at(index_old) != new_cp->signature_ref_at(index_new)))\n+    if ((old_cp->name_ref_at(index_old, c_old) != new_cp->name_ref_at(index_new, c_old)) ||\n+        (old_cp->signature_ref_at(index_old, c_old) != new_cp->signature_ref_at(index_new, c_old)))\n","filename":"src\/hotspot\/share\/prims\/methodComparator.cpp","additions":5,"deletions":5,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -1285,1 +1285,1 @@\n-            Symbol* name = caller->constants()->name_ref_at(bss_index_in_pool);\n+            Symbol* name = caller->constants()->name_ref_at(bss_index_in_pool, Bytecodes::_invokedynamic);\n@@ -1292,1 +1292,1 @@\n-            Symbol* type = caller->constants()->signature_ref_at(bss_index_in_pool);\n+            Symbol* type = caller->constants()->signature_ref_at(bss_index_in_pool, Bytecodes::_invokedynamic);\n","filename":"src\/hotspot\/share\/prims\/methodHandles.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -1225,1 +1225,1 @@\n-      rk = constants->klass_ref_at(bytecode_index, CHECK_NH);\n+      rk = constants->klass_ref_at(bytecode_index, bc, CHECK_NH);\n","filename":"src\/hotspot\/share\/runtime\/sharedRuntime.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -438,0 +438,1 @@\n+     * @param opcode bytecode\n@@ -723,2 +724,2 @@\n-            String name = getNameOf(index);\n-            HotSpotSignature signature = new HotSpotSignature(runtime(), getSignatureOf(index));\n+            String name = getNameOf(cpi);\n+            HotSpotSignature signature = new HotSpotSignature(runtime(), getSignatureOf(cpi));\n@@ -773,1 +774,1 @@\n-                index = getKlassRefIndexAt(index);\n+                index = getKlassRefIndexAt(cpi);\n@@ -786,1 +787,1 @@\n-        final int nameAndTypeIndex = getNameAndTypeRefIndexAt(index);\n+        final int nameAndTypeIndex = getNameAndTypeRefIndexAt(cpi);\n@@ -791,1 +792,1 @@\n-        final int holderIndex = getKlassRefIndexAt(index);\n+        final int holderIndex = getKlassRefIndexAt(cpi);\n","filename":"src\/jdk.internal.vm.ci\/share\/classes\/jdk\/vm\/ci\/hotspot\/HotSpotConstantPool.java","additions":6,"deletions":5,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -96,8 +96,1 @@\n-        int index = cpi;\n-        String cached = \"\";\n-        int cpci = dummyClass.getCPCacheIndex(cpi);\n-        if (cpci != ConstantPoolTestsHelper.NO_CP_CACHE_PRESENT) {\n-            index = cpci;\n-            cached = \"cached \";\n-        }\n-        int indexToVerify = CompilerToVMHelper.lookupKlassRefIndexInPool(constantPoolCTVM, index);\n+        int indexToVerify = CompilerToVMHelper.lookupKlassRefIndexInPool(constantPoolCTVM, cpi);\n@@ -106,3 +99,1 @@\n-                                           + \"applied to %sconstant pool index %d\",\n-                                   cached,\n-                                   index);\n+                                           + \"applied to constant pool index %d\", cpi);\n","filename":"test\/hotspot\/jtreg\/compiler\/jvmci\/compilerToVM\/LookupKlassRefIndexInPoolTest.java","additions":2,"deletions":11,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -98,8 +98,1 @@\n-        int index = cpi;\n-        String cached = \"\";\n-        int cpci = dummyClass.getCPCacheIndex(cpi);\n-        if (cpci != ConstantPoolTestsHelper.NO_CP_CACHE_PRESENT) {\n-            index = cpci;\n-            cached = \"cached \";\n-        }\n-        int indexToVerify = CompilerToVMHelper.lookupNameAndTypeRefIndexInPool(constantPoolCTVM, index);\n+        int indexToVerify = CompilerToVMHelper.lookupNameAndTypeRefIndexInPool(constantPoolCTVM, cpi);\n@@ -108,3 +101,2 @@\n-                                           + \" method applied to %sconstant pool index %d\",\n-                                   cached,\n-                                   index);\n+                                           + \" method applied to constant pool index %d\",\n+                                   cpi);\n","filename":"test\/hotspot\/jtreg\/compiler\/jvmci\/compilerToVM\/LookupNameAndTypeRefIndexInPoolTest.java","additions":3,"deletions":11,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -99,8 +99,1 @@\n-        int index = cpi;\n-        String cached = \"\";\n-        int cpci = dummyClass.getCPCacheIndex(cpi);\n-        if (cpci != ConstantPoolTestsHelper.NO_CP_CACHE_PRESENT) {\n-            index = cpci;\n-            cached = \"cached \";\n-        }\n-        String nameToVerify = CompilerToVMHelper.lookupNameInPool(constantPoolCTVM, index);\n+        String nameToVerify = CompilerToVMHelper.lookupNameInPool(constantPoolCTVM, cpi);\n@@ -108,1 +101,1 @@\n-        String msg = String.format(\"Wrong name accessed by %sconstant pool index %d\", cached, index);\n+        String msg = String.format(\"Wrong name accessed by constant pool index %d\", cpi);\n","filename":"test\/hotspot\/jtreg\/compiler\/jvmci\/compilerToVM\/LookupNameInPoolTest.java","additions":2,"deletions":9,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -99,8 +99,1 @@\n-        int index = cpi;\n-        String cached = \"\";\n-        int cpci = dummyClass.getCPCacheIndex(cpi);\n-        if (cpci != ConstantPoolTestsHelper.NO_CP_CACHE_PRESENT) {\n-            index = cpci;\n-            cached = \"cached \";\n-        }\n-        String sigToVerify = CompilerToVMHelper.lookupSignatureInPool(constantPoolCTVM, index);\n+        String sigToVerify = CompilerToVMHelper.lookupSignatureInPool(constantPoolCTVM, cpi);\n@@ -108,3 +101,2 @@\n-        String msg = String.format(\"Wrong signature accessed by %sconstant pool index %d\",\n-                                   cached,\n-                                   index);\n+        String msg = String.format(\"Wrong signature accessed by constant pool index %d\",\n+                                   cpi);\n","filename":"test\/hotspot\/jtreg\/compiler\/jvmci\/compilerToVM\/LookupSignatureInPoolTest.java","additions":3,"deletions":11,"binary":false,"changes":14,"status":"modified"}]}