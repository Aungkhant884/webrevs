{"files":[{"patch":"@@ -2601,1 +2601,1 @@\n-    Label L_doLast;\n+    Label L_doLast, L_error;\n@@ -2746,0 +2746,5 @@\n+#ifdef ASSERT\n+    __ cmpwi           (CCR0, keylen, 60);\n+    __ bne             (CCR0, L_error);\n+#endif\n+\n@@ -2766,1 +2771,0 @@\n-    \/\/ store result (unaligned)\n@@ -2768,13 +2772,6 @@\n-    __ lvsl            (toPerm, to);\n-#else\n-    __ lvsr            (toPerm, to);\n-#endif\n-    __ vspltisb        (vTmp3, -1);\n-    __ vspltisb        (vTmp4, 0);\n-    __ lvx             (vTmp1, to);\n-    __ lvx             (vTmp2, fifteen, to);\n-#ifdef VM_LITTLE_ENDIAN\n-    __ vperm           (vTmp3, vTmp3, vTmp4, toPerm); \/\/ generate select mask\n-    __ vxor            (toPerm, toPerm, fSplt);       \/\/ swap bytes\n-#else\n-    __ vperm           (vTmp3, vTmp4, vTmp3, toPerm); \/\/ generate select mask\n+    \/\/ toPerm = 0x0F0E0D0C0B0A09080706050403020100\n+    __ lvsl            (toPerm, keypos); \/\/ keypos is a multiple of 16\n+    __ vxor            (toPerm, toPerm, fSplt);\n+\n+    \/\/ Swap Bytes\n+    __ vperm           (vRet, vRet, vRet, toPerm);\n@@ -2782,5 +2779,9 @@\n-    __ vperm           (vTmp4, vRet, vRet, toPerm);   \/\/ rotate data\n-    __ vsel            (vTmp2, vTmp4, vTmp2, vTmp3);\n-    __ vsel            (vTmp1, vTmp1, vTmp4, vTmp3);\n-    __ stvx            (vTmp2, fifteen, to);          \/\/ store this one first (may alias)\n-    __ stvx            (vTmp1, to);\n+\n+    \/\/ store result (unaligned)\n+    \/\/ Note: We can't use a read-modify-write sequence which touches additional Bytes.\n+    Register lo = temp, hi = fifteen; \/\/ Reuse\n+    __ vsldoi          (vTmp1, vRet, vRet, 8);\n+    __ mfvrd           (hi, vRet);\n+    __ mfvrd           (lo, vTmp1);\n+    __ std             (hi, 0 LITTLE_ENDIAN_ONLY(+ 8), to);\n+    __ std             (lo, 0 BIG_ENDIAN_ONLY(+ 8), to);\n@@ -2789,0 +2790,5 @@\n+\n+#ifdef ASSERT\n+    __ bind(L_error);\n+    __ stop(\"aescrypt_encryptBlock: invalid key length\");\n+#endif\n@@ -2802,3 +2808,1 @@\n-    Label L_doLast;\n-    Label L_do44;\n-    Label L_do52;\n+    Label L_doLast, L_do44, L_do52, L_error;\n@@ -2864,0 +2868,5 @@\n+#ifdef ASSERT\n+    __ cmpwi           (CCR0, keylen, 60);\n+    __ bne             (CCR0, L_error);\n+#endif\n+\n@@ -2900,0 +2909,1 @@\n+    __ align(32);\n@@ -2926,0 +2936,1 @@\n+    __ align(32);\n@@ -3003,10 +3014,0 @@\n-    \/\/ store result (unaligned)\n-#ifdef VM_LITTLE_ENDIAN\n-    __ lvsl            (toPerm, to);\n-#else\n-    __ lvsr            (toPerm, to);\n-#endif\n-    __ vspltisb        (vTmp3, -1);\n-    __ vspltisb        (vTmp4, 0);\n-    __ lvx             (vTmp1, to);\n-    __ lvx             (vTmp2, fifteen, to);\n@@ -3014,4 +3015,6 @@\n-    __ vperm           (vTmp3, vTmp3, vTmp4, toPerm); \/\/ generate select mask\n-    __ vxor            (toPerm, toPerm, fSplt);       \/\/ swap bytes\n-#else\n-    __ vperm           (vTmp3, vTmp4, vTmp3, toPerm); \/\/ generate select mask\n+    \/\/ toPerm = 0x0F0E0D0C0B0A09080706050403020100\n+    __ lvsl            (toPerm, keypos); \/\/ keypos is a multiple of 16\n+    __ vxor            (toPerm, toPerm, fSplt);\n+\n+    \/\/ Swap Bytes\n+    __ vperm           (vRet, vRet, vRet, toPerm);\n@@ -3019,5 +3022,9 @@\n-    __ vperm           (vTmp4, vRet, vRet, toPerm);   \/\/ rotate data\n-    __ vsel            (vTmp2, vTmp4, vTmp2, vTmp3);\n-    __ vsel            (vTmp1, vTmp1, vTmp4, vTmp3);\n-    __ stvx            (vTmp2, fifteen, to);          \/\/ store this one first (may alias)\n-    __ stvx            (vTmp1, to);\n+\n+    \/\/ store result (unaligned)\n+    \/\/ Note: We can't use a read-modify-write sequence which touches additional Bytes.\n+    Register lo = temp, hi = fifteen; \/\/ Reuse\n+    __ vsldoi          (vTmp1, vRet, vRet, 8);\n+    __ mfvrd           (hi, vRet);\n+    __ mfvrd           (lo, vTmp1);\n+    __ std             (hi, 0 LITTLE_ENDIAN_ONLY(+ 8), to);\n+    __ std             (lo, 0 BIG_ENDIAN_ONLY(+ 8), to);\n@@ -3026,0 +3033,5 @@\n+\n+#ifdef ASSERT\n+    __ bind(L_error);\n+    __ stop(\"aescrypt_decryptBlock: invalid key length\");\n+#endif\n","filename":"src\/hotspot\/cpu\/ppc\/stubGenerator_ppc.cpp","additions":54,"deletions":42,"binary":false,"changes":96,"status":"modified"}]}