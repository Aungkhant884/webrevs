{"files":[{"patch":"@@ -26,0 +26,1 @@\n+#include \"runtime\/atomic.hpp\"\n@@ -28,0 +29,1 @@\n+#include \"runtime\/os.hpp\"\n@@ -29,1 +31,0 @@\n-stringStream* GCLogPrecious::_lines = NULL;\n@@ -33,0 +34,33 @@\n+class GCLogPreciousLine : public CHeapObj<mtGC> {\n+  const char* const _line;\n+  GCLogPreciousLine* volatile _next;\n+\n+public:\n+  GCLogPreciousLine(const char* line) :\n+      _line(line),\n+      _next(NULL) {}\n+\n+  const char* line() const { return _line; }\n+\n+  GCLogPreciousLine* next() const { return Atomic::load_acquire(&_next); }\n+  void set_next(GCLogPreciousLine* next) { Atomic::release_store(&_next, next); }\n+};\n+\n+GCLogPreciousLine* volatile GCLogPrecious::_head = NULL;\n+GCLogPreciousLine* GCLogPrecious::_tail = NULL;\n+\n+void GCLogPrecious::append_line(const char* const str) {\n+  GCLogPreciousLine* line = new GCLogPreciousLine(str);\n+\n+  GCLogPreciousLine* head = _head;\n+  GCLogPreciousLine* tail = _tail;\n+\n+  if (head == NULL) {\n+    Atomic::release_store(&_head, line);\n+  }\n+  if (_tail != NULL) {\n+    tail->set_next(line);\n+  }\n+  _tail = line;\n+}\n+\n@@ -34,1 +68,0 @@\n-  _lines = new (ResourceObj::C_HEAP, mtGC) stringStream();\n@@ -48,1 +81,1 @@\n-  _lines->print_cr(\" %s\", _temp->base());\n+  append_line(os::strdup_check_oom(_temp->base(), mtGC));\n@@ -80,5 +113,6 @@\n-  if (_lines != NULL) {\n-    MutexLocker locker(_lock, Mutex::_no_safepoint_check_flag);\n-    if (_lines->size() > 0) {\n-      st->print_cr(\"GC Precious Log:\");\n-      st->print_cr(\"%s\", _lines->base());\n+  GCLogPreciousLine* line = Atomic::load_acquire(&_head);\n+  if (line != NULL) {\n+    st->print_cr(\"GC Precious Log:\");\n+    while (line != NULL) {\n+      st->print_cr(\" %s\", line->line());\n+      line = line->next();\n@@ -86,0 +120,1 @@\n+    st->print_cr(\"\");\n","filename":"src\/hotspot\/share\/gc\/shared\/gcLogPrecious.cpp","additions":43,"deletions":8,"binary":false,"changes":51,"status":"modified"},{"patch":"@@ -32,0 +32,1 @@\n+class GCLogPreciousLine;\n@@ -57,1 +58,2 @@\n-  static stringStream* _lines;\n+  static GCLogPreciousLine* volatile _head;\n+  static GCLogPreciousLine* _tail;\n@@ -63,0 +65,2 @@\n+  static void append_line(const char* const line);\n+\n","filename":"src\/hotspot\/share\/gc\/shared\/gcLogPrecious.hpp","additions":5,"deletions":1,"binary":false,"changes":6,"status":"modified"}]}