{"files":[{"patch":"@@ -417,1 +417,2 @@\n-                                           bool caller_must_gc_arguments)\n+                                           bool caller_must_gc_arguments,\n+                                           bool alloc_fail_is_fatal)\n@@ -425,0 +426,6 @@\n+    if (stub == nullptr) {\n+      if (!alloc_fail_is_fatal) {\n+        return nullptr;\n+      }\n+      fatal(\"Initial size of CodeCache is too small\");\n+    }\n@@ -434,3 +441,1 @@\n-  void* p = CodeCache::allocate(size, CodeBlobType::NonNMethod);\n-  if (!p) fatal(\"Initial size of CodeCache is too small\");\n-  return p;\n+  return CodeCache::allocate(size, CodeBlobType::NonNMethod);\n","filename":"src\/hotspot\/share\/code\/codeBlob.cpp","additions":9,"deletions":4,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -503,1 +503,2 @@\n-    bool        caller_must_gc_arguments\n+    bool        caller_must_gc_arguments,\n+    bool        alloc_fail_is_fatal=true\n","filename":"src\/hotspot\/share\/code\/codeBlob.hpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -39,0 +39,1 @@\n+#include \"runtime\/arguments.hpp\"\n@@ -653,0 +654,47 @@\n+JVMCI::CodeInstallResult CodeInstaller::install_runtime_stub(CodeBlob*& cb,\n+                                                             const char* name,\n+                                                             CodeBuffer* buffer,\n+                                                             int stack_slots,\n+                                                             JVMCI_TRAPS) {\n+  if (name == nullptr) {\n+    JVMCI_ERROR_OK(\"stub should have a name\");\n+  }\n+\n+  name = os::strdup(name);\n+  GrowableArray<RuntimeStub*> *stubs_to_free = nullptr;\n+#ifdef ASSERT\n+  const char* val = Arguments::PropertyList_get_value(Arguments::system_properties(), \"test.jvmci.forceRuntimeStubAllocFail\");\n+  if (val != nullptr && strstr(name , val) != 0) {\n+    stubs_to_free = new GrowableArray<RuntimeStub*>();\n+    JVMCI_event_1(\"forcing allocation of %s in code cache to fail\", name);\n+  }\n+#endif\n+\n+  do {\n+    RuntimeStub* stub = RuntimeStub::new_runtime_stub(name,\n+                                       buffer,\n+                                       _offsets.value(CodeOffsets::Frame_Complete),\n+                                       stack_slots,\n+                                       _debug_recorder->_oopmaps,\n+                                       \/* caller_must_gc_arguments *\/ false,\n+                                       \/* alloc_fail_is_fatal *\/ false);\n+    cb = stub;\n+    if (stub == nullptr) {\n+      \/\/ Allocation failed\n+#ifdef ASSERT\n+      if (stubs_to_free != nullptr) {\n+        JVMCI_event_1(\"allocation of %s in code cache failed, freeing %d stubs\", name, stubs_to_free->length());\n+        for (GrowableArrayIterator<RuntimeStub*> iter = stubs_to_free->begin(); iter != stubs_to_free->end(); ++iter) {\n+          RuntimeStub::free(*iter);\n+        }\n+      }\n+#endif\n+      return JVMCI::cache_full;\n+    }\n+    if (stubs_to_free == nullptr) {\n+      return JVMCI::ok;\n+    }\n+    stubs_to_free->append(stub);\n+  } while (true);\n+}\n+\n@@ -710,11 +758,1 @@\n-    if (name == nullptr) {\n-      JVMCI_ERROR_OK(\"stub should have a name\");\n-    }\n-    name = os::strdup(name); \/\/ Note: this leaks. See JDK-8289632\n-    cb = RuntimeStub::new_runtime_stub(name,\n-                                       &buffer,\n-                                       _offsets.value(CodeOffsets::Frame_Complete),\n-                                       stack_slots,\n-                                       _debug_recorder->_oopmaps,\n-                                       false);\n-    result = JVMCI::ok;\n+    return install_runtime_stub(cb, name, &buffer, stack_slots, JVMCI_CHECK_OK);\n","filename":"src\/hotspot\/share\/jvmci\/jvmciCodeInstaller.cpp","additions":49,"deletions":11,"binary":false,"changes":60,"status":"modified"},{"patch":"@@ -402,0 +402,6 @@\n+\n+  JVMCI::CodeInstallResult install_runtime_stub(CodeBlob*& cb,\n+                                                const char* name,\n+                                                CodeBuffer* buffer,\n+                                                int stack_slots,\n+                                                JVMCI_TRAPS);\n","filename":"src\/hotspot\/share\/jvmci\/jvmciCodeInstaller.hpp","additions":6,"deletions":0,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -51,1 +51,3 @@\n- *     -XX:+UseJVMCICompiler -XX:-BootstrapJVMCI -XX:-UseJVMCINativeLibrary\n+ *     -XX:+UseJVMCICompiler -XX:-BootstrapJVMCI\n+ *     -XX:-UseJVMCINativeLibrary -XX:JVMCITraceLevel=1\n+ *     -Dtest.jvmci.forceRuntimeStubAllocFail=test_stub_that_fails_to_be_allocated\n@@ -65,0 +67,1 @@\n+import jdk.test.lib.Platform;\n@@ -67,0 +70,1 @@\n+import jdk.vm.ci.code.BailoutException;\n@@ -145,0 +149,23 @@\n+\n+        String stubToFail = System.getProperty(\"test.jvmci.forceRuntimeStubAllocFail\");\n+        if (Platform.isDebugBuild() && stubToFail != null) {\n+            HotSpotCompiledCode stub = new HotSpotCompiledCode(stubToFail,\n+                    \/* targetCode *\/ new byte[0],\n+                    \/* targetCodeSize *\/ 0,\n+                    \/* sites *\/ new Site[0],\n+                    \/* assumptions *\/ new Assumption[0],\n+                    \/* methods *\/ new ResolvedJavaMethod[0],\n+                    \/* comments *\/ new Comment[0],\n+                    \/* dataSection *\/ new byte[0],\n+                    dataSectionAlignment,\n+                    \/* dataSectionPatches *\/ new DataPatch[0],\n+                    \/* isImmutablePIC *\/ false,\n+                    \/* totalFrameSize *\/ 0,\n+                    \/* deoptRescueSlot *\/ null);\n+            try {\n+                codeCache.installCode(null, stub, null, null, true);\n+                throw new AssertionError(\"Didn't get expected \" + BailoutException.class.getName());\n+            } catch (BailoutException e) {\n+                Asserts.assertEQ(e.getMessage(), \"Error installing \" + stubToFail + \": code cache is full\");\n+            }\n+        }\n","filename":"test\/hotspot\/jtreg\/compiler\/jvmci\/events\/JvmciNotifyInstallEventTest.java","additions":28,"deletions":1,"binary":false,"changes":29,"status":"modified"}]}