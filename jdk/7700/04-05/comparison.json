{"files":[{"patch":"@@ -2988,1 +2988,17 @@\n-  Label SCALAR_LOOP_BEGIN, SCALAR_LOOP_END, VECTOR_LOOP_SKIP, VECTOR_LOOP_BEGIN, VECTOR_LOOP_END;\n+  Label LENMIN, LENMIN_UNROLLED_LOOP_BEGIN, LENMIN_UNROLLED_LOOP_END, LENMIN_SCALAR_LOOP_BEGIN, LENMIN_SCALAR_LOOP_END,\n+        LEN32, LEN32_SCALAR_LOOP_BEGIN, LEN32_SCALAR_LOOP_END, LEN32_VECTOR_LOOP_BEGIN, LEN32_VECTOR_LOOP_END,\n+        END;\n+\n+  \/\/ For \"renaming\" for readibility of the code\n+  Register bound;\n+\n+  XMMRegister vcoef[] = { vcoef0, vcoef1, vcoef2, vcoef3 },\n+              vresult[] = { vresult0, vresult1, vresult2, vresult3 },\n+              vtmp[] = { vtmp0, vtmp1, vtmp2, vtmp3 };\n+\n+  static jint power_of_31_backwards[] = {\n+     2111290369,\n+    -2010103841,   350799937,    11316127,   693101697,  -254736545,   961614017,    31019807, -2077209343,\n+      -67006753,  1244764481, -2038056289,   211350913,  -408824225,  -844471871,  -997072353,  1353309697,\n+     -510534177,  1507551809,  -505558625,  -293403007,   129082719, -1796951359,  -196513505, -1807454463,\n+     1742810335,   887503681,    28629151,      923521,       29791,         961,          31,           1};\n@@ -2993,0 +3009,67 @@\n+  \/\/ if (cnt1 == 0) {\n+  cmpl(cnt1, 0);\n+  jcc(Assembler::equal, END);\n+\n+  \/\/ } else if (cnt1 <= 31) {\n+  bind(LENMIN);\n+  cmpl(cnt1, 31);\n+  jcc(Assembler::greater, LEN32);\n+\n+  \/\/ register \"rename\"\n+  bound = coef;\n+\n+  \/\/ int i = 0;\n+  movl(i, 0);\n+\n+  \/\/ int bound = cnt1 & ~(8 - 1);\n+  movl(bound, cnt1);\n+  andl(bound, ~(8-1));\n+\n+  \/\/ for (; i < bound; i += 8) {\n+  bind(LENMIN_UNROLLED_LOOP_BEGIN);\n+  \/\/ i < bound;\n+  cmpl(i, bound);\n+  jcc(Assembler::greaterEqual, LENMIN_UNROLLED_LOOP_END);\n+\n+  for (int idx = 0; idx < 8; idx++) {\n+    \/\/ h = h << 5 - 31;\n+    movl(tmp, result);\n+    shll(result, 5);\n+    subl(result, tmp);\n+    \/\/ h += (str1[i] & 0xff);\n+    movzbl(tmp, Address(str1, i, Address::times(sizeof(jbyte)), idx));\n+    addl(result, tmp);\n+  }\n+\n+  addl(i, 8);\n+  jmp(LENMIN_UNROLLED_LOOP_BEGIN);\n+\n+  bind(LENMIN_UNROLLED_LOOP_END);\n+  \/\/ }\n+\n+  \/\/ for (; i < cnt1; i += 1) {\n+  bind(LENMIN_SCALAR_LOOP_BEGIN);\n+  \/\/ i < cnt1;\n+  cmpl(i, cnt1);\n+  jcc(Assembler::greaterEqual, LENMIN_SCALAR_LOOP_END);\n+\n+  \/\/ h = h << 5 - 31;\n+  movl(tmp, result);\n+  shll(result, 5);\n+  subl(result, tmp);\n+  \/\/ h += (str1[i] & 0xff);\n+  movzbl(tmp, Address(str1, i, Address::times(sizeof(jbyte))));\n+  addl(result, tmp);\n+\n+  \/\/ i += 1;\n+  addl(i, 1);\n+  jmp(LENMIN_SCALAR_LOOP_BEGIN);\n+\n+  bind(LENMIN_SCALAR_LOOP_END);\n+  \/\/ }\n+\n+  jmp(END);\n+\n+  \/\/ } else { \/\/ cnt1 >= 32\n+  bind(LEN32);\n+\n@@ -3000,1 +3083,1 @@\n-  Register bound = cnt1;\n+  bound = cnt1;\n@@ -3008,1 +3091,1 @@\n-  bind(SCALAR_LOOP_BEGIN);\n+  bind(LEN32_SCALAR_LOOP_BEGIN);\n@@ -3011,1 +3094,1 @@\n-  jcc(Assembler::less, SCALAR_LOOP_END);\n+  jcc(Assembler::less, LEN32_SCALAR_LOOP_END);\n@@ -3025,1 +3108,1 @@\n-  jmp(SCALAR_LOOP_BEGIN);\n+  jmp(LEN32_SCALAR_LOOP_BEGIN);\n@@ -3027,1 +3110,1 @@\n-  bind(SCALAR_LOOP_END);\n+  bind(LEN32_SCALAR_LOOP_END);\n@@ -3030,4 +3113,0 @@\n-  \/\/ if (i >= 32-1) {\n-  cmpl(i, 32-1);\n-  jcc(Assembler::less, VECTOR_LOOP_SKIP);\n-\n@@ -3048,7 +3127,0 @@\n-  static jint power_of_31_backwards[] = {\n-     2111290369,\n-    -2010103841,   350799937,    11316127,   693101697,  -254736545,   961614017,    31019807, -2077209343,\n-      -67006753,  1244764481, -2038056289,   211350913,  -408824225,  -844471871,  -997072353,  1353309697,\n-     -510534177,  1507551809,  -505558625,  -293403007,   129082719, -1796951359,  -196513505, -1807454463,\n-     1742810335,   887503681,    28629151,      923521,       29791,         961,          31,           1};\n-\n@@ -3084,1 +3156,1 @@\n-  bind(VECTOR_LOOP_BEGIN);\n+  bind(LEN32_VECTOR_LOOP_BEGIN);\n@@ -3087,1 +3159,1 @@\n-  jcc(Assembler::less, VECTOR_LOOP_END);\n+  jcc(Assembler::less, LEN32_VECTOR_LOOP_END);\n@@ -3121,1 +3193,1 @@\n-  jmp(VECTOR_LOOP_BEGIN);\n+  jmp(LEN32_VECTOR_LOOP_BEGIN);\n@@ -3123,1 +3195,1 @@\n-  bind(VECTOR_LOOP_END);\n+  bind(LEN32_VECTOR_LOOP_END);\n@@ -3135,1 +3207,0 @@\n-  bind(VECTOR_LOOP_SKIP);\n@@ -3138,0 +3209,2 @@\n+  bind(END);\n+\n","filename":"src\/hotspot\/cpu\/x86\/c2_MacroAssembler_x86.cpp","additions":95,"deletions":22,"binary":false,"changes":117,"status":"modified"},{"patch":"@@ -27,1 +27,1 @@\n- * @run main\/othervm -XX:+SpecialStringHashCode HashCode\n+ * @run main\/othervm HashCode\n","filename":"test\/jdk\/java\/lang\/String\/HashCode.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -169,29 +169,0 @@\n-        @Benchmark\n-        public int scalarLatin1Unrolled16() {\n-            int h = 0;\n-            int i = 0, len = latin1.length;\n-            for (; i < (len & ~(16 - 1)); i += 16) {\n-                h =  1353309697 * h                    +\n-                     -510534177 * (latin1[i+ 0] & 0xff) +\n-                     1507551809 * (latin1[i+ 1] & 0xff) +\n-                     -505558625 * (latin1[i+ 2] & 0xff) +\n-                     -293403007 * (latin1[i+ 3] & 0xff) +\n-                      129082719 * (latin1[i+ 4] & 0xff) +\n-                    -1796951359 * (latin1[i+ 5] & 0xff) +\n-                     -196513505 * (latin1[i+ 6] & 0xff) +\n-                    -1807454463 * (latin1[i+ 7] & 0xff) +\n-                     1742810335 * (latin1[i+ 8] & 0xff) +\n-                      887503681 * (latin1[i+ 9] & 0xff) +\n-                       28629151 * (latin1[i+10] & 0xff) +\n-                         923521 * (latin1[i+11] & 0xff) +\n-                          29791 * (latin1[i+12] & 0xff) +\n-                            961 * (latin1[i+13] & 0xff) +\n-                             31 * (latin1[i+14] & 0xff) +\n-                              1 * (latin1[i+15] & 0xff);\n-            }\n-            for (; i < len; i++) {\n-                h = 31 * h + (latin1[i] & 0xff);\n-            }\n-            return h;\n-        }\n-\n","filename":"test\/micro\/org\/openjdk\/bench\/java\/lang\/StringHashCode.java","additions":0,"deletions":29,"binary":false,"changes":29,"status":"modified"}]}