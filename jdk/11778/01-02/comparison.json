{"files":[{"patch":"@@ -33,1 +33,1 @@\n-#include \"runtime\/disableStackTracingMark.hpp\"\n+#include \"runtime\/clearFrameAnchorMark.hpp\"\n@@ -75,1 +75,1 @@\n-    DisableStackTracingMark dstm(_jt);\n+    ClearFrameAnchorMark dstm(_jt);\n@@ -106,1 +106,1 @@\n-  DisableStackTracingMark dstm(_jt);\n+  ClearFrameAnchorMark dstm(_jt);\n","filename":"src\/hotspot\/share\/gc\/z\/zStackWatermark.cpp","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -0,0 +1,62 @@\n+\/*\n+ * Copyright (c) 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\n+ *\/\n+\n+#include \"precompiled.hpp\"\n+#include \"runtime\/clearFrameAnchorMark.hpp\"\n+#include \"runtime\/javaThread.hpp\"\n+\n+DEBUG_ONLY(THREAD_LOCAL bool ClearFrameAnchorMark::_is_active = false;)\n+\n+ClearFrameAnchorMark::ClearFrameAnchorMark(JavaThread* jt)\n+  : _jt(nullptr),\n+    _sp(nullptr) {\n+  if (jt == Thread::current()) {\n+    \/\/ This class only clears the frame anchor for the current thread.\n+    \/\/ We can't safely clear the frame anchor of another thread. Besides,\n+    \/\/ the point of this class is to protect against stack walks from\n+    \/\/ the current thread in a given scope.\n+    _jt = jt;\n+    _sp = begin(jt);\n+  }\n+}\n+\n+ClearFrameAnchorMark::~ClearFrameAnchorMark() {\n+  if (_jt != nullptr) {\n+    end(_jt, _sp);\n+  }\n+}\n+\n+intptr_t* ClearFrameAnchorMark::begin(JavaThread* jt) {\n+  assert(!_is_active, \"nesting not supported\");\n+  DEBUG_ONLY(_is_active = true;)\n+  intptr_t* sp = jt->frame_anchor()->last_Java_sp();\n+  jt->frame_anchor()->set_last_Java_sp(NULL);\n+  return sp;\n+}\n+\n+void ClearFrameAnchorMark::end(JavaThread* jt, intptr_t* sp) {\n+  assert(_is_active, \"mismatched begin and end\");\n+  jt->frame_anchor()->set_last_Java_sp(sp);\n+  DEBUG_ONLY(_is_active = false;)\n+}\n","filename":"src\/hotspot\/share\/runtime\/clearFrameAnchorMark.cpp","additions":62,"deletions":0,"binary":false,"changes":62,"status":"added"},{"patch":"@@ -34,3 +34,3 @@\n-\/\/ Use this class to mark a section of code where stack tracing is not safe\n-\/\/ and should be avoided.\n-class DisableStackTracingMark : public StackObj {\n+\/\/ Use this class to mark a section of code where stack tracing from the\n+\/\/ current thread is not safe and should be avoided.\n+class ClearFrameAnchorMark : public StackObj {\n@@ -45,2 +45,2 @@\n-  DisableStackTracingMark(JavaThread* jt);\n-  ~DisableStackTracingMark();\n+  ClearFrameAnchorMark(JavaThread* jt);\n+  ~ClearFrameAnchorMark();\n","filename":"src\/hotspot\/share\/runtime\/clearFrameAnchorMark.hpp","additions":5,"deletions":5,"binary":false,"changes":10,"previous_filename":"src\/hotspot\/share\/runtime\/disableStackTracingMark.hpp","status":"renamed"},{"patch":"@@ -64,0 +64,1 @@\n+#include \"runtime\/clearFrameAnchorMark.hpp\"\n@@ -67,1 +68,0 @@\n-#include \"runtime\/disableStackTracingMark.hpp\"\n@@ -759,1 +759,1 @@\n-    DisableStackTracingMark dstm(thread);\n+    ClearFrameAnchorMark dstm(thread);\n","filename":"src\/hotspot\/share\/runtime\/deoptimization.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -1,58 +0,0 @@\n-\/*\n- * Copyright (c) 2022, Oracle and\/or its affiliates. All rights reserved.\n- * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n- *\n- * This code is free software; you can redistribute it and\/or modify it\n- * under the terms of the GNU General Public License version 2 only, as\n- * published by the Free Software Foundation.\n- *\n- * This code is distributed in the hope that it will be useful, but WITHOUT\n- * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n- * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n- * version 2 for more details (a copy is included in the LICENSE file that\n- * accompanied this code).\n- *\n- * You should have received a copy of the GNU General Public License version\n- * 2 along with this work; if not, write to the Free Software Foundation,\n- * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n- *\n- * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n- * or visit www.oracle.com if you need additional information or have any\n- * questions.\n- *\n- *\/\n-\n-#include \"precompiled.hpp\"\n-#include \"runtime\/disableStackTracingMark.hpp\"\n-#include \"runtime\/javaThread.hpp\"\n-\n-DEBUG_ONLY(THREAD_LOCAL bool DisableStackTracingMark::_is_active = false;)\n-\n-DisableStackTracingMark::DisableStackTracingMark(JavaThread* jt)\n-  : _jt(nullptr),\n-    _sp(nullptr) {\n-  if (jt == Thread::current()) {\n-    _jt = jt;\n-    _sp = begin(jt);\n-  }\n-}\n-\n-DisableStackTracingMark::~DisableStackTracingMark() {\n-  if (_jt != nullptr) {\n-    end(_jt, _sp);\n-  }\n-}\n-\n-intptr_t* DisableStackTracingMark::begin(JavaThread* jt) {\n-  assert(!_is_active, \"nesting not supported\");\n-  DEBUG_ONLY(_is_active = true;)\n-  intptr_t* sp = jt->frame_anchor()->last_Java_sp();\n-  jt->frame_anchor()->set_last_Java_sp(NULL);\n-  return sp;\n-}\n-\n-void DisableStackTracingMark::end(JavaThread* jt, intptr_t* sp) {\n-  assert(_is_active, \"mismatched begin and end\");\n-  jt->frame_anchor()->set_last_Java_sp(sp);\n-  DEBUG_ONLY(_is_active = false;)\n-}\n","filename":"src\/hotspot\/share\/runtime\/disableStackTracingMark.cpp","additions":0,"deletions":58,"binary":false,"changes":58,"status":"deleted"}]}