{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2007, 2018, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2007, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -28,0 +28,2 @@\n+\n+import java.io.PrintStream;\n@@ -206,0 +208,8 @@\n+        public static void printStackTrace(PrintStream out, Thread t) {\n+            StackTraceElement[] stacktrace = t.getStackTrace();\n+            for (int i = 0; i < stacktrace.length; i++) {\n+                StackTraceElement ste = stacktrace[i];\n+                out.println(INDENT + \"at \" + ste.toString());\n+            }\n+        }\n+\n@@ -221,0 +231,2 @@\n+        \/\/ Most uses of waitThreadState usually succeed without retries.\n+        \/\/ Sleep time increased to help avoid spurious failures.\n@@ -222,1 +234,1 @@\n-        public final static long waitThreadStateSleepTime = 100;\n+        public final static long waitThreadStateSleepTime = 1000;\n@@ -227,0 +239,1 @@\n+                long ctime2 = 0;\n@@ -228,2 +241,9 @@\n-                        if (retries++ > waitThreadStateRetries)\n-                                throw new TestFailure(\"Thread \" + thread + \" with current state \" + thread.getState() + \" did not reach state \" + state + \" with number of  retries: \" + retries + \", time: \" + (System.currentTimeMillis() - ctime));\n+                        if (retries++ > waitThreadStateRetries) {\n+                            \/\/ Failed to see desired state, give info to help diagnose the isuse.\n+                            \/\/ Show the thread, and fail with Exception showing retries and time taken.\n+                            ctime2 = System.currentTimeMillis() - ctime;\n+                            System.err.println(\"waitThreadState: problem thread: \" + thread);\n+                            printStackTrace(System.err, thread);\n+                            throw new TestFailure(\"Thread \" + thread + \" with current state \" + thread.getState() + \" did not reach state \"\n+                                                  + state + \" with number of retries: \" + retries + \", time: \" + ctime2);\n+                        }\n@@ -231,1 +251,1 @@\n-                                Thread.sleep(waitThreadStateSleepTime);\n+                            Thread.sleep(waitThreadStateSleepTime);\n@@ -235,0 +255,3 @@\n+                \/\/ Show retries and time, so we know what \"normal\" looks like:\n+                ctime2 = System.currentTimeMillis() - ctime;\n+                System.out.println(\"waitThreadState: OK. retries: \" + retries + \" time: \" + ctime2);\n","filename":"test\/hotspot\/jtreg\/vmTestbase\/nsk\/monitoring\/share\/thread\/ThreadUtils.java","additions":28,"deletions":5,"binary":false,"changes":33,"status":"modified"}]}