{"files":[{"patch":"@@ -3824,2 +3824,1 @@\n-                BigDecimal tenToTheNegFour = BigDecimal.valueOf(1, 4);\n-                BigDecimal tenToThePrec = BigDecimal.valueOf(1, -prec);\n+                value = value.round(new MathContext(prec));\n@@ -3827,2 +3826,2 @@\n-                    || ((value.compareTo(tenToTheNegFour) != -1)\n-                        && (value.compareTo(tenToThePrec) == -1))) {\n+                    || ((value.compareTo(BigDecimal.valueOf(1, 4)) != -1)\n+                        && (value.compareTo(BigDecimal.valueOf(1, -prec)) == -1))) {\n","filename":"src\/java.base\/share\/classes\/java\/util\/Formatter.java","additions":3,"deletions":4,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -0,0 +1,62 @@\n+\/*\n+ * Copyright (c) 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/**\n+ * @test\n+ * @bug 8262744\n+ * @summary BigDecimal does not always display formatting correctly because\n+ * rounding is done after formatting check. Fix moves rounding to before the\n+ * range-based formatting check for %g formatting flag.\n+ * @run testng BigDecimalRounding\n+ *\/\n+\n+import org.testng.annotations.Test;\n+\n+import java.math.BigDecimal;\n+\n+import static org.testng.Assert.*;\n+\n+@Test\n+public class BigDecimalRounding {\n+\n+    public static void testBigDecimalRounding() {\n+        var res1 = String.format(\"%g\", 0.00009999999999999995);\n+        var res2 = String.format(\"%g\", 0.00009999999f);\n+        var res3 = String.format(\"%g\", new BigDecimal(0.0001));\n+        var res4 = String.format(\"%g\", new BigDecimal(\"0.00009999999999999999995\"));\n+\n+        assertEquals(res1, res2);\n+        assertEquals(res2, res3);\n+        assertEquals(res3, res4);\n+\n+        var res5 = String.format(\"%.9g\", 999999.999999432168754e+3);\n+        var res6 = String.format(\"%.9g\", 999999999.999432168754f);\n+        var res7 = String.format(\"%.9g\", new BigDecimal(\"999999.999999432168754e+3\")); \/\/ !!\n+        var res8 = String.format(\"%.9g\", new BigDecimal(\"1000000000\")); \/\/ !!\n+\n+        assertEquals(res5, res6);\n+        assertEquals(res6, res7);\n+        assertEquals(res7, res8);\n+\n+    }\n+}\n","filename":"test\/jdk\/java\/util\/Formatter\/BigDecimalRounding.java","additions":62,"deletions":0,"binary":false,"changes":62,"status":"added"}]}