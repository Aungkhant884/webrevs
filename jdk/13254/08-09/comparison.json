{"files":[{"patch":"@@ -2233,2 +2233,2 @@\n-  JvmtiTagMap* tag_map;\n-  JNILocalRootsClosure* blk;\n+  JvmtiTagMap* _tag_map;\n+  JNILocalRootsClosure* _blk;\n@@ -2237,1 +2237,5 @@\n-  JavaThread* java_thread;\n+  JavaThread* _java_thread;\n+\n+  oop _threadObj;\n+  jlong _thread_tag;\n+  jlong _tid;\n@@ -2239,3 +2243,3 @@\n-  oop threadObj;\n-  jlong thread_tag;\n-  jlong tid;\n+  bool _is_top_frame;\n+  int _depth;\n+  frame* _last_entry_frame;\n@@ -2243,3 +2247,1 @@\n-  bool is_top_frame;\n-  int depth;\n-  frame* last_entry_frame;\n+  bool report_stack_refs(StackValueCollection* values, jmethodID method, jlocation bci, jint slot_offset);\n@@ -2249,3 +2251,3 @@\n-    : tag_map(tag_map), blk(blk), java_thread(java_thread),\n-      threadObj(nullptr), thread_tag(0), tid(0),\n-      is_top_frame(true), depth(0), last_entry_frame(nullptr)\n+    : _tag_map(tag_map), _blk(blk), _java_thread(java_thread),\n+      _threadObj(nullptr), _thread_tag(0), _tid(0),\n+      _is_top_frame(true), _depth(0), _last_entry_frame(nullptr)\n@@ -2263,3 +2265,3 @@\n-  threadObj = o;\n-  thread_tag = tag_for(tag_map, threadObj);\n-  tid = java_lang_Thread::thread_id(threadObj);\n+  _threadObj = o;\n+  _thread_tag = tag_for(_tag_map, _threadObj);\n+  _tid = java_lang_Thread::thread_id(_threadObj);\n@@ -2267,3 +2269,3 @@\n-  is_top_frame = true;\n-  depth = 0;\n-  last_entry_frame = nullptr;\n+  _is_top_frame = true;\n+  _depth = 0;\n+  _last_entry_frame = nullptr;\n@@ -2276,1 +2278,19 @@\n-         && CallbackInvoker::report_simple_root(kind, threadObj);\n+         && CallbackInvoker::report_simple_root(kind, _threadObj);\n+}\n+\n+bool StackRootCollector::report_stack_refs(StackValueCollection* values, jmethodID method, jlocation bci, jint slot_offset) {\n+  for (int index = 0; index < values->size(); index++) {\n+    if (values->at(index)->type() == T_OBJECT) {\n+      oop o = values->obj_at(index)();\n+      if (o == nullptr) {\n+        continue;\n+      }\n+\n+      \/\/ stack reference\n+      if (!CallbackInvoker::report_stack_ref_root(_thread_tag, _tid, _depth, method,\n+                                                  bci, slot_offset + index, o)) {\n+        return false;\n+      }\n+    }\n+  }\n+  return true;\n@@ -2290,13 +2310,2 @@\n-      for (int slot = 0; slot < locals->size(); slot++) {\n-        if (locals->at(slot)->type() == T_OBJECT) {\n-          oop o = locals->obj_at(slot)();\n-          if (o == nullptr) {\n-            continue;\n-          }\n-\n-          \/\/ stack reference\n-          if (!CallbackInvoker::report_stack_ref_root(thread_tag, tid, depth, method,\n-                                                      bci, slot, o)) {\n-            return false;\n-          }\n-        }\n+      if (!report_stack_refs(locals, method, bci, 0)) {\n+        return false;\n@@ -2304,15 +2313,2 @@\n-\n-      StackValueCollection* exprs = jvf->expressions();\n-      for (int index = 0; index < exprs->size(); index++) {\n-        if (exprs->at(index)->type() == T_OBJECT) {\n-          oop o = exprs->obj_at(index)();\n-          if (o == nullptr) {\n-            continue;\n-          }\n-\n-          \/\/ stack reference\n-          if (!CallbackInvoker::report_stack_ref_root(thread_tag, tid, depth, method,\n-                                                      bci, locals->size() + index, o)) {\n-            return false;\n-          }\n-        }\n+      if (!report_stack_refs(jvf->expressions(), method, bci, locals->size())) {\n+        return false;\n@@ -2323,3 +2319,3 @@\n-        blk->set_context(thread_tag, tid, depth, method);\n-        jvf->cb()->as_nmethod()->oops_do(blk);\n-        if (blk->stopped()) {\n+        _blk->set_context(_thread_tag, _tid, _depth, method);\n+        jvf->cb()->as_nmethod()->oops_do(_blk);\n+        if (_blk->stopped()) {\n@@ -2331,2 +2327,2 @@\n-      blk->set_context(thread_tag, tid, depth, method);\n-      if (is_top_frame) {\n+      _blk->set_context(_thread_tag, _tid, _depth, method);\n+      if (_is_top_frame) {\n@@ -2334,3 +2330,3 @@\n-        assert(java_thread != nullptr, \"sanity\");\n-        java_thread->active_handles()->oops_do(blk);\n-        if (blk->stopped()) {\n+        assert(_java_thread != nullptr, \"sanity\");\n+        _java_thread->active_handles()->oops_do(_blk);\n+        if (_blk->stopped()) {\n@@ -2340,1 +2336,1 @@\n-        if (last_entry_frame != nullptr) {\n+        if (_last_entry_frame != nullptr) {\n@@ -2342,3 +2338,3 @@\n-          assert(last_entry_frame->is_entry_frame(), \"checking\");\n-          last_entry_frame->entry_frame_call_wrapper()->handles()->oops_do(blk);\n-          if (blk->stopped()) {\n+          assert(_last_entry_frame->is_entry_frame(), \"checking\");\n+          _last_entry_frame->entry_frame_call_wrapper()->handles()->oops_do(_blk);\n+          if (_blk->stopped()) {\n@@ -2350,2 +2346,2 @@\n-    last_entry_frame = nullptr;\n-    depth++;\n+    _last_entry_frame = nullptr;\n+    _depth++;\n@@ -2358,1 +2354,1 @@\n-      last_entry_frame = fr;\n+      _last_entry_frame = fr;\n@@ -2362,1 +2358,1 @@\n-  is_top_frame = false;\n+  _is_top_frame = false;\n@@ -2795,2 +2791,0 @@\n-    \/\/ this may be only platform thread\n-    assert(mounted_vt == nullptr, \"must be\");\n","filename":"src\/hotspot\/share\/prims\/jvmtiTagMap.cpp","additions":59,"deletions":65,"binary":false,"changes":124,"status":"modified"}]}