{"files":[{"patch":"@@ -223,4 +223,2 @@\n-  \/\/ 3: apply keep-alive barrier if ShenandoahSATBBarrier is set\n-  if (ShenandoahSATBBarrier) {\n-    bool is_weak = (decorators & ON_WEAK_OOP_REF) != 0;\n-    bool is_phantom = (decorators & ON_PHANTOM_OOP_REF) != 0;\n+  \/\/ 3: apply keep-alive barrier for java.lang.ref.Reference if needed\n+  if (ShenandoahBarrierSet::need_keep_alive_barrier(decorators, type)) {\n@@ -228,14 +226,11 @@\n-    bool keep_alive = (decorators & AS_NO_KEEPALIVE) == 0;\n-\n-    if ((is_weak || is_phantom || is_anonymous) && keep_alive) {\n-      \/\/ Register the value in the referent field with the pre-barrier\n-      LabelObj *Lcont_anonymous;\n-      if (is_anonymous) {\n-        Lcont_anonymous = new LabelObj();\n-        generate_referent_check(access, Lcont_anonymous);\n-      }\n-      pre_barrier(gen, access.access_emit_info(), decorators, LIR_OprFact::illegalOpr \/* addr_opr *\/,\n-                  result \/* pre_val *\/);\n-      if (is_anonymous) {\n-        __ branch_destination(Lcont_anonymous->label());\n-      }\n+\n+    \/\/ Register the value in the referent field with the pre-barrier\n+    LabelObj *Lcont_anonymous;\n+    if (is_anonymous) {\n+      Lcont_anonymous = new LabelObj();\n+      generate_referent_check(access, Lcont_anonymous);\n+    }\n+    pre_barrier(gen, access.access_emit_info(), decorators, LIR_OprFact::illegalOpr \/* addr_opr *\/,\n+                result \/* pre_val *\/);\n+    if (is_anonymous) {\n+      __ branch_destination(Lcont_anonymous->label());\n@@ -243,1 +238,1 @@\n- }\n+  }\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/c1\/shenandoahBarrierSetC1.cpp","additions":14,"deletions":19,"binary":false,"changes":33,"status":"modified"},{"patch":"@@ -554,1 +554,1 @@\n-  \/\/ 3: apply keep-alive barrier if needed\n+  \/\/ 3: apply keep-alive barrier for java.lang.ref.Reference if needed\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/c2\/shenandoahBarrierSetC2.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -540,1 +540,1 @@\n-    MonitorLocker ml(Heap_lock, Mutex::_no_safepoint_check_flag);\n+    MonitorLocker ml(Heap_lock);\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahReferenceProcessor.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}