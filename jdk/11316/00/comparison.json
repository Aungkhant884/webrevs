{"files":[{"patch":"@@ -593,11 +593,7 @@\n-  \/\/ Grab a lock here to prevent multiple\n-  \/\/ MethodData*s from being created.\n-  MutexLocker ml(THREAD, MethodData_lock);\n-  if (method->method_data() == NULL) {\n-    ClassLoaderData* loader_data = method->method_holder()->class_loader_data();\n-    MethodData* method_data = MethodData::allocate(loader_data, method, THREAD);\n-    if (HAS_PENDING_EXCEPTION) {\n-      CompileBroker::log_metaspace_failure();\n-      ClassLoaderDataGraph::set_metaspace_oom(true);\n-      return;   \/\/ return the exception (which is cleared)\n-    }\n+  ClassLoaderData* loader_data = method->method_holder()->class_loader_data();\n+  MethodData* method_data = MethodData::allocate(loader_data, method, THREAD);\n+  if (HAS_PENDING_EXCEPTION) {\n+    CompileBroker::log_metaspace_failure();\n+    ClassLoaderDataGraph::set_metaspace_oom(true);\n+    return;   \/\/ return the exception (which is cleared)\n+  }\n@@ -605,8 +601,15 @@\n-    method->set_method_data(method_data);\n-    if (PrintMethodData && (Verbose || WizardMode)) {\n-      ResourceMark rm(THREAD);\n-      tty->print(\"build_profiling_method_data for \");\n-      method->print_name(tty);\n-      tty->cr();\n-      \/\/ At the end of the run, the MDO, full of data, will be dumped.\n-    }\n+  \/\/ The store into method must be released. On platforms without\n+  \/\/ total store order (TSO) the reference may become visible before\n+  \/\/ the initialization of data otherwise.\n+  OrderAccess::release();\n+  if (!Atomic::replace_if_null(&method->_method_data, method_data)) {\n+    MetadataFactory::free_metadata(loader_data, method_data);\n+    return;\n+  }\n+\n+  if (PrintMethodData && (Verbose || WizardMode)) {\n+    ResourceMark rm(THREAD);\n+    tty->print(\"build_profiling_method_data for \");\n+    method->print_name(tty);\n+    tty->cr();\n+    \/\/ At the end of the run, the MDO, full of data, will be dumped.\n","filename":"src\/hotspot\/share\/oops\/method.cpp","additions":22,"deletions":19,"binary":false,"changes":41,"status":"modified"}]}