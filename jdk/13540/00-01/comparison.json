{"files":[{"patch":"@@ -2142,1 +2142,1 @@\n-            throw new InvalidClassException(desc.getName(), \"Array length < 0 (\" + len + \")\");\n+            throw new InvalidClassException(desc.getName(), \"Array length is negative\");\n","filename":"src\/java.base\/share\/classes\/java\/io\/ObjectInputStream.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -43,4 +43,2 @@\n-    private static byte[] _buildPayload() throws IOException {\n-        String[] simpleArray = new String[1];\n-\n-        \/\/ Serialize to bytes\n+    private static byte[] buildPayload() throws IOException {\n+         \/\/ Serialize to bytes\n@@ -49,1 +47,1 @@\n-        oos.writeObject(simpleArray);\n+        oos.writeObject(new String[1]);\n@@ -55,1 +53,1 @@\n-        for (int i=0; i<serializedData.length-1; i++) {\n+        for (int i = 0; i < serializedData.length - 1; i++) {\n@@ -58,2 +56,7 @@\n-                firstPos = i;\n-                break;\n+                \/\/ Replace array length with -2\n+                serializedData[i + 2] = (byte) 0xff;\n+                serializedData[i + 3] = (byte) 0xff;\n+                serializedData[i + 4] = (byte) 0xff;\n+                serializedData[i + 5] = (byte) 0xfe;\n+\n+                return serializedData;\n@@ -62,8 +65,1 @@\n-\n-        \/\/ Replace array length with -2\n-        serializedData[firstPos+2] = (byte) 0xff;\n-        serializedData[firstPos+3] = (byte) 0xff;\n-        serializedData[firstPos+4] = (byte) 0xff;\n-        serializedData[firstPos+5] = (byte) 0xfe;\n-\n-        return  serializedData;\n+        throw new RuntimeException(\"Can't find TC_ENDBLOCKDATA in object output stream\");\n@@ -72,14 +68,6 @@\n-    public static void test_simpleArray_negative() throws IOException, ClassNotFoundException {\n-        ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(_buildPayload()));\n-        ois.readObject();\n-    }\n-\n-    public static void test_simpleArray_negative_with_filter() throws IOException, ClassNotFoundException {\n-        class CustomFilter implements ObjectInputFilter {\n-            @Override\n-            public Status checkInput(FilterInfo filterInfo) {\n-                Class<?> cl = filterInfo.serialClass();\n-                if (cl != null && cl.isArray() && filterInfo.arrayLength() < -1) {\n-                    throw new RuntimeException(\"FilterInfo.arrayLength() must be >= -1 for arrays (was \" + filterInfo.arrayLength() + \")\");\n-                }\n-                return Status.ALLOWED;\n+    private static class CustomFilter implements ObjectInputFilter {\n+        @Override\n+        public Status checkInput(FilterInfo filterInfo) {\n+            Class<?> cl = filterInfo.serialClass();\n+            if (cl != null && cl.isArray() && filterInfo.arrayLength() < -1) {\n+                throw new RuntimeException(\"FilterInfo.arrayLength() must be >= -1 for arrays (was \" + filterInfo.arrayLength() + \")\");\n@@ -87,0 +75,1 @@\n+            return Status.ALLOWED;\n@@ -88,3 +77,0 @@\n-        ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(_buildPayload()));\n-        ois.setObjectInputFilter(new CustomFilter());\n-        ois.readObject();\n@@ -95,1 +81,3 @@\n-            test_simpleArray_negative();\n+            \/\/ Test object input stream with negative sized array\n+            ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(buildPayload()));\n+            ois.readObject();\n@@ -100,0 +88,3 @@\n+            if (\"Array length is negative\".equals(ose.getMessage())) {\n+                throw new Exception(\"Expected \\\"Array length is negative\\\" as exception message\", ose);\n+            }\n@@ -102,1 +93,4 @@\n-            test_simpleArray_negative_with_filter();\n+            \/\/ Test object input stream with negative sized array and custom object input filter\n+            ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(buildPayload()));\n+            ois.setObjectInputFilter(new CustomFilter());\n+            ois.readObject();\n@@ -110,0 +104,3 @@\n+            if (\"Array length is negative\".equals(ose.getMessage())) {\n+                throw new Exception(\"Expected \\\"Array length is negative\\\" as exception message\", ose);\n+            }\n","filename":"test\/jdk\/java\/io\/ObjectInputStream\/NegativeArraySizeTest.java","additions":32,"deletions":35,"binary":false,"changes":67,"status":"modified"}]}