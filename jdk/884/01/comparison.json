{"files":[{"patch":"@@ -31,1 +31,5 @@\n-PretouchTask::PretouchTask(const char* task_name, char* start_address, char* end_address, size_t page_size) :\n+PretouchTask::PretouchTask(const char* task_name,\n+                           char* start_address,\n+                           char* end_address,\n+                           size_t page_size,\n+                           size_t chunk_size) :\n@@ -36,6 +40,6 @@\n-    _page_size(0) {\n-#ifdef LINUX\n-  _page_size = UseTransparentHugePages ? (size_t)os::vm_page_size(): page_size;\n-#else\n-  _page_size = page_size;\n-#endif\n+    _page_size(page_size),\n+    _chunk_size(chunk_size) {\n+\n+  assert(chunk_size >= page_size,\n+         \"Chunk size \" SIZE_FORMAT \" is smaller than page size \" SIZE_FORMAT,\n+         chunk_size, page_size);\n@@ -49,2 +53,0 @@\n-  size_t const actual_chunk_size = MAX2(chunk_size(), _page_size);\n-\n@@ -52,1 +54,1 @@\n-    char* touch_addr = Atomic::fetch_and_add(&_cur_addr, actual_chunk_size);\n+    char* touch_addr = Atomic::fetch_and_add(&_cur_addr, _chunk_size);\n@@ -57,1 +59,1 @@\n-    char* end_addr = touch_addr + MIN2(actual_chunk_size, pointer_delta(_end_addr, touch_addr, sizeof(char)));\n+    char* end_addr = touch_addr + MIN2(_chunk_size, pointer_delta(_end_addr, touch_addr, sizeof(char)));\n@@ -65,1 +67,9 @@\n-  PretouchTask task(task_name, start_address, end_address, page_size);\n+\n+#ifdef LINUX\n+  \/\/ When using THP we need to always pre-touch using small pages as the OS will\n+  \/\/ initially always use small pages.\n+  page_size = UseTransparentHugePages ? (size_t)os::vm_page_size() : page_size;\n+#endif\n+  size_t chunk_size = MAX2(PretouchTask::chunk_size(), page_size);\n+\n+  PretouchTask task(task_name, start_address, end_address, page_size, chunk_size);\n@@ -68,0 +78,4 @@\n+  if (total_bytes == 0) {\n+    return;\n+  }\n+\n@@ -69,1 +83,1 @@\n-    size_t num_chunks = MAX2((size_t)1, total_bytes \/ MAX2(PretouchTask::chunk_size(), page_size));\n+    size_t num_chunks = (total_bytes + chunk_size - 1) \/ chunk_size;\n@@ -71,1 +85,1 @@\n-    uint num_workers = MIN2((uint)num_chunks, pretouch_gang->total_workers());\n+    uint num_workers = (uint)MIN2(num_chunks, (size_t)pretouch_gang->total_workers());\n","filename":"src\/hotspot\/share\/gc\/shared\/pretouchTask.cpp","additions":28,"deletions":14,"binary":false,"changes":42,"status":"modified"},{"patch":"@@ -35,0 +35,1 @@\n+  size_t _chunk_size;\n@@ -37,1 +38,1 @@\n-  PretouchTask(const char* task_name, char* start_address, char* end_address, size_t page_size);\n+  PretouchTask(const char* task_name, char* start_address, char* end_address, size_t page_size, size_t chunk_size);\n","filename":"src\/hotspot\/share\/gc\/shared\/pretouchTask.hpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"}]}