{"files":[{"patch":"@@ -71,7 +71,15 @@\n-    if (b->count() > 0 && !nm->is_marked_for_deoptimization() && nm->check_dependency_on(changes)) {\n-      if (TraceDependencies) {\n-        ResourceMark rm;\n-        tty->print_cr(\"Marked for deoptimization\");\n-        changes.print();\n-        nm->print();\n-        nm->print_dependencies();\n+    if (b->count() > 0) {\n+      if (nm->is_marked_for_deoptimization()) {\n+        \/\/ Also count already (concurrently) marked nmethods to make sure\n+        \/\/ deoptimization is triggered before execution in this thread continues.\n+        found++;\n+      } else if (nm->check_dependency_on(changes)) {\n+        if (TraceDependencies) {\n+          ResourceMark rm;\n+          tty->print_cr(\"Marked for deoptimization\");\n+          changes.print();\n+          nm->print();\n+          nm->print_dependencies();\n+        }\n+        changes.mark_for_deoptimization(nm);\n+        found++;\n@@ -79,2 +87,0 @@\n-      changes.mark_for_deoptimization(nm);\n-      found++;\n@@ -192,1 +198,3 @@\n-    if (b->count() > 0 && !nm->is_marked_for_deoptimization()) {\n+    if (b->count() > 0) {\n+      \/\/ Also count already (concurrently) marked nmethods to make sure\n+      \/\/ deoptimization is triggered before execution in this thread continues.\n","filename":"src\/hotspot\/share\/code\/dependencyContext.cpp","additions":18,"deletions":10,"binary":false,"changes":28,"status":"modified"}]}