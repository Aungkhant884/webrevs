{"files":[{"patch":"@@ -84,29 +84,17 @@\n-    struct bag* new_bag = NULL;\n-    struct bag* deleted = NULL;\n-    jboolean retry = JNI_FALSE;\n-    do {\n-      \/\/ Avoid unnecessary allocations when class track has yet been activated.\n-      if (deletedSignatures != NULL) {\n-        \/* Allocate new bag outside classTrackLock lock to avoid deadlock.\n-         *\n-         * Note: jvmtiAllocate\/jvmtiDeallocate() may be blocked by ongoing safepoints.\n-         * It is dangerous to call them (via bagCreateBag\/bagDestroyBag())while holding monitor(s),\n-         * because jvmti may post events, e.g. JVMTI_EVENT_OBJECT_FREE at safepoints and event processing\n-         * code may acquire the same monitor(s), e.g. classTrackLock in cbTrackingObjectFree(),\n-         * which can lead to deadlock.\n-         *\/\n-        new_bag = bagCreateBag(sizeof(char*), 10);\n-      }\n-      debugMonitorEnter(classTrackLock);\n-      deleted = deletedSignatures;\n-      if (deletedSignatures != NULL) {\n-        if (new_bag != NULL) {\n-          deletedSignatures = new_bag;\n-          new_bag = NULL;\n-        } else {\n-          retry = JNI_TRUE;\n-        }\n-      }\n-      debugMonitorExit(classTrackLock);\n-    } while (retry == JNI_TRUE);\n-    bagDestroyBag(new_bag);\n+    if (deletedSignatures == NULL || bagSize(deletedSignatures) == 0) {\n+      return NULL;\n+    }\n+\n+    \/* Allocate new bag outside classTrackLock lock to avoid deadlock.\n+     *\n+     * Note: jvmtiAllocate\/jvmtiDeallocate() may be blocked by ongoing safepoints.\n+     * It is dangerous to call them (via bagCreateBag\/bagDestroyBag())while holding monitor(s),\n+     * because jvmti may post events, e.g. JVMTI_EVENT_OBJECT_FREE at safepoints and event processing\n+     * code may acquire the same monitor(s), e.g. classTrackLock in cbTrackingObjectFree(),\n+     * which can lead to deadlock.\n+     *\/\n+    struct bag* new_bag = bagCreateBag(sizeof(char*), 10);\n+    debugMonitorEnter(classTrackLock);\n+    struct bag* deleted = deletedSignatures;\n+    deletedSignatures = new_bag;\n+    debugMonitorExit(classTrackLock);\n","filename":"src\/jdk.jdwp.agent\/share\/native\/libjdwp\/classTrack.c","additions":17,"deletions":29,"binary":false,"changes":46,"status":"modified"}]}