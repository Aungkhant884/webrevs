{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2008, 2009, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2008, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -33,0 +33,4 @@\n+#if defined(__linux__)\n+#include <sys\/sendfile.h>\n+#endif\n+\n@@ -50,1 +54,2 @@\n- * Transfer all bytes from src to dst via user-space buffers\n+ * Transfer all bytes from src to dst within the kernel if possible (Linux),\n+ * otherwise via user-space buffers\n@@ -56,1 +61,0 @@\n-    char buf[8192];\n@@ -59,0 +63,21 @@\n+#if defined(__linux__)\n+    \/\/ Attempt to transfer within the kernel\n+    ssize_t bytes_sent;\n+    do {\n+        \/\/ sendfile() will transfer at most 0x7ffff000 bytes\n+        RESTARTABLE(sendfile64(dst, src, NULL, 0x7ffff000), bytes_sent);\n+        if (cancel != NULL && *cancel != 0) {\n+            throwUnixException(env, ECANCELED);\n+            return;\n+        }\n+    } while (bytes_sent > 0);\n+\n+    \/\/ sendfile() returns zero at src EOF\n+    if (bytes_sent == 0) {\n+        return;\n+    }\n+#endif\n+\n+    \/\/ Transfer via user-space buffers\n+    char buf[8192];\n+\n","filename":"src\/java.base\/unix\/native\/libnio\/fs\/UnixCopyFile.c","additions":28,"deletions":3,"binary":false,"changes":31,"status":"modified"}]}