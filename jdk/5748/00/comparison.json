{"files":[{"patch":"@@ -43,0 +43,4 @@\n+import java.util.Set;\n+import java.util.WeakHashMap;\n+import java.util.stream.*;\n+import java.util.ServiceLoader.Provider;\n@@ -225,0 +229,1 @@\n+    private static final WeakHashMap<ClassLoader, Set<Provider<LoginModule>>> cacheServiceProviders = new WeakHashMap<>();\n@@ -291,0 +296,18 @@\n+\n+        synchronized(cacheServiceProviders){\n+            if (cacheServiceProviders.get(contextClassLoader) == null){\n+                if (debug != null)\n+                    debug.println(\"Build ServiceProviders cache for ClassLoader: \" + contextClassLoader.getName());\n+                @SuppressWarnings(\"removal\")\n+                ServiceLoader<LoginModule> sc = AccessController.doPrivileged(\n+                        (PrivilegedAction<ServiceLoader<LoginModule>>)\n+                                () -> java.util.ServiceLoader.load(\n+                                    LoginModule.class, contextClassLoader));\n+                Set<Provider<LoginModule>> lmProviders = sc.stream().collect(Collectors.toSet());\n+                    if (debug != null){\n+                        debug.println(\"Discovered ServiceProviders for ClassLoader: \" + contextClassLoader.getName());\n+                        lmProviders.forEach(System.err::println);\n+                    }\n+                cacheServiceProviders.put(contextClassLoader,lmProviders);\n+            }\n+        }\n@@ -694,10 +717,9 @@\n-                    @SuppressWarnings(\"removal\")\n-                    ServiceLoader<LoginModule> sc = AccessController.doPrivileged(\n-                            (PrivilegedAction<ServiceLoader<LoginModule>>)\n-                                    () -> ServiceLoader.load(\n-                                        LoginModule.class, contextClassLoader));\n-                    for (LoginModule m: sc) {\n-                        if (m.getClass().getName().equals(name)) {\n-                            moduleStack[i].module = m;\n-                            if (debug != null) {\n-                                debug.println(name + \" loaded as a service\");\n+                    synchronized(cacheServiceProviders){\n+                        Set<Provider<LoginModule>> lmp = cacheServiceProviders.get(contextClassLoader);\n+                        for ( Provider<LoginModule> lm: lmp){\n+                            if (lm.type().getName().equals(name)){\n+                                moduleStack[i].module = lm.get();\n+                                if (debug != null) {\n+                                    debug.println(name + \" loaded as a service\");\n+                                }\n+                                break;\n@@ -705,1 +727,0 @@\n-                            break;\n@@ -708,1 +729,0 @@\n-\n","filename":"src\/java.base\/share\/classes\/javax\/security\/auth\/login\/LoginContext.java","additions":32,"deletions":12,"binary":false,"changes":44,"status":"modified"}]}