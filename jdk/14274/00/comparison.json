{"files":[{"patch":"@@ -51,0 +51,1 @@\n+#include \"gc\/shared\/preservedMarks.inline.hpp\"\n@@ -136,1 +137,1 @@\n-      scratch->num_words * HeapWordSize \/ sizeof(PreservedMark);\n+      scratch->num_words * HeapWordSize \/ sizeof(OopAndMarkWord);\n@@ -141,1 +142,1 @@\n-  _preserved_marks = (PreservedMark*)scratch;\n+  _preserved_marks = (OopAndMarkWord*)scratch;\n@@ -143,0 +144,2 @@\n+\n+  _preserved_overflow_stack_set.init(1);\n@@ -150,1 +153,1 @@\n-  _preserved_overflow_stack.clear(true);\n+  _preserved_overflow_stack_set.reclaim();\n","filename":"src\/hotspot\/share\/gc\/serial\/genMarkSweep.cpp","additions":6,"deletions":3,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -47,1 +47,1 @@\n-Stack<PreservedMark, mtGC>    MarkSweep::_preserved_overflow_stack;\n+PreservedMarksSet       MarkSweep::_preserved_overflow_stack_set(false \/* in_c_heap *\/);\n@@ -50,1 +50,1 @@\n-PreservedMark*          MarkSweep::_preserved_marks = nullptr;\n+OopAndMarkWord*         MarkSweep::_preserved_marks = nullptr;\n@@ -145,8 +145,0 @@\n-void PreservedMark::adjust_pointer() {\n-  MarkSweep::adjust_pointer(&_obj);\n-}\n-\n-void PreservedMark::restore() {\n-  _obj->set_mark(_mark);\n-}\n-\n@@ -162,1 +154,1 @@\n-    _preserved_marks[_preserved_count++] = PreservedMark(obj, mark);\n+    _preserved_marks[_preserved_count++] = OopAndMarkWord(obj, mark);\n@@ -164,1 +156,1 @@\n-    _preserved_overflow_stack.push(PreservedMark(obj, mark));\n+    _preserved_overflow_stack_set.get()->push_if_necessary(obj, mark);\n@@ -208,1 +200,1 @@\n-    _preserved_marks[i].adjust_pointer();\n+    MarkSweep::adjust_pointer(_preserved_marks[i].get_oop_pointer());\n@@ -212,1 +204,1 @@\n-  StackIterator<PreservedMark, mtGC> iter(_preserved_overflow_stack);\n+  StackIterator<OopAndMarkWord, mtGC> iter(_preserved_overflow_stack_set.get()->get_stack());\n@@ -214,2 +206,2 @@\n-    PreservedMark* p = iter.next_addr();\n-    p->adjust_pointer();\n+    OopAndMarkWord* p = iter.next_addr();\n+    MarkSweep::adjust_pointer(p->get_oop_pointer());\n@@ -220,1 +212,1 @@\n-  log_trace(gc)(\"Restoring \" SIZE_FORMAT \" marks\", _preserved_count + _preserved_overflow_stack.size());\n+  log_trace(gc)(\"Restoring \" SIZE_FORMAT \" marks\", _preserved_count + _preserved_overflow_stack_set.get()->size());\n@@ -224,1 +216,1 @@\n-    _preserved_marks[i].restore();\n+    _preserved_marks[i].set_mark();\n@@ -228,4 +220,1 @@\n-  while (!_preserved_overflow_stack.is_empty()) {\n-    PreservedMark p = _preserved_overflow_stack.pop();\n-    p.restore();\n-  }\n+  _preserved_overflow_stack_set.restore(nullptr);\n","filename":"src\/hotspot\/share\/gc\/serial\/markSweep.cpp","additions":11,"deletions":22,"binary":false,"changes":33,"status":"modified"},{"patch":"@@ -29,0 +29,1 @@\n+#include \"gc\/shared\/preservedMarks.inline.hpp\"\n@@ -102,1 +103,1 @@\n-  static Stack<PreservedMark, mtGC>      _preserved_overflow_stack;\n+  static PreservedMarksSet               _preserved_overflow_stack_set;\n@@ -105,1 +106,1 @@\n-  static PreservedMark*                  _preserved_marks;\n+  static OopAndMarkWord*                 _preserved_marks;\n@@ -189,11 +190,0 @@\n-class PreservedMark {\n-private:\n-  oop _obj;\n-  markWord _mark;\n-\n-public:\n-  PreservedMark(oop obj, markWord mark) : _obj(obj), _mark(mark) {}\n-  void adjust_pointer();\n-  void restore();\n-};\n-\n","filename":"src\/hotspot\/share\/gc\/serial\/markSweep.hpp","additions":3,"deletions":13,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -37,0 +37,14 @@\n+class OopAndMarkWord {\n+ private:\n+  oop _o;\n+  markWord _m;\n+\n+ public:\n+  OopAndMarkWord(oop obj, markWord m) : _o(obj), _m(m) { }\n+\n+  oop get_oop() { return _o; }\n+  oop* get_oop_pointer() {return &_o; }\n+  inline void set_mark() const;\n+  void set_oop(oop obj) { _o = obj; }\n+};\n+\n@@ -39,12 +53,0 @@\n-  class OopAndMarkWord {\n-  private:\n-    oop _o;\n-    markWord _m;\n-\n-  public:\n-    OopAndMarkWord(oop obj, markWord m) : _o(obj), _m(m) { }\n-\n-    oop get_oop() { return _o; }\n-    inline void set_mark() const;\n-    void set_oop(oop obj) { _o = obj; }\n-  };\n@@ -58,0 +60,1 @@\n+  OopAndMarkWordStack& get_stack() { return _stack; }\n","filename":"src\/hotspot\/share\/gc\/shared\/preservedMarks.hpp","additions":15,"deletions":12,"binary":false,"changes":27,"status":"modified"},{"patch":"@@ -59,1 +59,1 @@\n-void PreservedMarks::OopAndMarkWord::set_mark() const {\n+void OopAndMarkWord::set_mark() const {\n","filename":"src\/hotspot\/share\/gc\/shared\/preservedMarks.inline.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}