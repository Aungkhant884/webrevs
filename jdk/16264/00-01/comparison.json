{"files":[{"patch":"@@ -1909,3 +1909,6 @@\n-            if (!isCurrentPlatform(p) && !Files.exists(resolveJavaRuntimeFileSystemJar(p)) &&\n-                    !Files.exists(p.resolve(\"modules\")))\n-                throw new IllegalArgumentException(p.toString());\n+            if (isOtherPlatformDirectory(p)) {\n+                var noJavaRuntimeFS = Files.notExists(resolveInJavaHomeLib(p, \"jrt-fs.jar\"));\n+                var noModulesFile = Files.notExists(resolveInJavaHomeLib(p, \"modules\"));\n+                if (noJavaRuntimeFS || noModulesFile)\n+                    throw new IllegalArgumentException(p.toString());\n+            }\n@@ -1916,5 +1919,1 @@\n-        private static Path resolveJavaRuntimeFileSystemJar(Path javaHomePath) {\n-            return javaHomePath.resolve(\"lib\").resolve(\"jrt-fs.jar\");\n-        }\n-\n-        private boolean isCurrentPlatform(Path p) {\n+        private boolean isOtherPlatformDirectory(Path p) {\n@@ -1922,1 +1921,1 @@\n-                return Files.isSameFile(p, Locations.javaHome);\n+                return !Files.isSameFile(p, Locations.javaHome);\n@@ -1928,0 +1927,4 @@\n+        private static Path resolveInJavaHomeLib(Path javaHomePath, String name) {\n+            return javaHomePath.resolve(\"lib\").resolve(name);\n+        }\n+\n@@ -1966,1 +1969,1 @@\n-                    if (isCurrentPlatform(systemJavaHome)) {\n+                    if (isOtherPlatformDirectory(systemJavaHome)) {\n@@ -1974,1 +1977,1 @@\n-                            URL jfsJar = resolveJavaRuntimeFileSystemJar(systemJavaHome).toUri().toURL();\n+                            URL jfsJar = resolveInJavaHomeLib(systemJavaHome, \"jrt-fs.jar\").toUri().toURL();\n@@ -1989,1 +1992,1 @@\n-                    modules = systemJavaHome.resolve(\"modules\");\n+                    modules = resolveInJavaHomeLib(systemJavaHome, \"modules\");\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/file\/Locations.java","additions":15,"deletions":12,"binary":false,"changes":27,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2018, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2018, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -43,0 +43,1 @@\n+import java.nio.file.Files;\n@@ -258,0 +259,44 @@\n+    @Test\n+    public void consistentSystemOptionHandlingWithAnEmptyDirectory(Path base) throws Exception {\n+        tb.createDirectories(base);\n+\n+        Assert.check(Files.notExists(base.resolve(\"lib\").resolve(\"jrt-fs.jar\")), \"expected: empty\\nfound: lib\/jrt-fs.jar\");\n+        Assert.check(Files.notExists(base.resolve(\"lib\").resolve(\"modules\")), \"expected: empty\\nfound: lib\/modules\");\n+\n+        doTestNoSource(base, \"error: illegal argument for --system: %s\".formatted(base), String.format(\"--system %s\", base));\n+    }\n+\n+    @Test\n+    public void consistentSystemOptionHandlingWithLibJrtFsJar(Path base) throws Exception {\n+        tb.createDirectories(base);\n+        tb.writeFile(base.resolve(\"lib\").resolve(\"jrt-fs.jar\"), \"this is not a JAR file\");\n+\n+        Assert.check(Files.exists(base.resolve(\"lib\").resolve(\"jrt-fs.jar\")), \"expected to find lib\/jrt-fs.jar\");\n+        Assert.check(Files.notExists(base.resolve(\"lib\").resolve(\"modules\")), \"expected: empty\\nfound: lib\/modules\");\n+\n+        doTestNoSource(base, \"error: illegal argument for --system: %s\".formatted(base), String.format(\"--system %s\", base));\n+    }\n+\n+    @Test\n+    public void consistentSystemOptionHandlingWithLibModules(Path base) throws Exception {\n+        tb.createDirectories(base);\n+        tb.writeFile(base.resolve(\"lib\").resolve(\"modules\"), \"this is not a modules file\");\n+\n+        Assert.check(Files.notExists(base.resolve(\"lib\").resolve(\"jrt-fs.jar\")), \"expected: empty\\nfound: lib\/jrt-fs.jar\");\n+        Assert.check(Files.exists(base.resolve(\"lib\").resolve(\"modules\")), \"expected to find lib\/modules\");\n+\n+        doTestNoSource(base, \"error: illegal argument for --system: %s\".formatted(base), String.format(\"--system %s\", base));\n+    }\n+\n+    @Test\n+    public void consistentSystemOptionHandlingWithAlmostValidLibEntries(Path base) throws Exception {\n+        tb.createDirectories(base);\n+        tb.writeFile(base.resolve(\"lib\").resolve(\"jrt-fs.jar\"), \"this is not a JAR file\");\n+        tb.writeFile(base.resolve(\"lib\").resolve(\"modules\"), \"this is not a modules file\");\n+\n+        Assert.check(Files.exists(base.resolve(\"lib\").resolve(\"jrt-fs.jar\")), \"expected to find lib\/jrt-fs.jar\");\n+        Assert.check(Files.exists(base.resolve(\"lib\").resolve(\"modules\")), \"expected to find lib\/modules\");\n+\n+        doTestNoSource(base, \"error: no source files\", String.format(\"--system %s\", base));\n+    }\n+\n","filename":"test\/langtools\/tools\/javac\/options\/smokeTests\/OptionSmokeTest.java","additions":46,"deletions":1,"binary":false,"changes":47,"status":"modified"}]}