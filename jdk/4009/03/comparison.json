{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright(c) 2015, 2021, Oracle and\/or its affiliates. All rig reserved.\n@@ -59,0 +59,1 @@\n+import java.util.concurrent.atomic.AtomicInteger;\n@@ -69,0 +70,1 @@\n+import org.testng.annotations.BeforeMethod;\n@@ -84,4 +86,1 @@\n-    private final Path mods;\n-    private final Path srcDir;\n-    private final Path lib;\n-    private final ModuleInfoMaker builder;\n+    static final AtomicInteger counter = new AtomicInteger(0);\n@@ -89,1 +88,7 @@\n-    HashesTest(Path dest) throws IOException {\n+    private Path mods;\n+    private Path lib;\n+    private ModuleInfoMaker builder;\n+\n+    @BeforeMethod\n+    public void setTestPath() throws IOException {\n+        Path dest = Path.of(\"test\" + counter.addAndGet(1));\n@@ -94,1 +99,0 @@\n-        this.srcDir = dest.resolve(\"src\");\n@@ -96,1 +100,1 @@\n-        this.builder = new ModuleInfoMaker(srcDir);\n+        this.builder = new ModuleInfoMaker(dest.resolve(\"src\"));\n@@ -103,4 +107,1 @@\n-    public static void test() throws IOException {\n-        Path dest = Paths.get(\"test\");\n-        HashesTest ht = new HashesTest(dest);\n-\n+    public void test() throws IOException {\n@@ -108,3 +109,3 @@\n-        ht.makeModule(\"m2\");\n-        ht.makeModule(\"m3\");\n-        ht.makeModule(\"m1\", \"m2\", \"m3\");\n+        makeModule(\"m2\");\n+        makeModule(\"m3\");\n+        makeModule(\"m1\", \"m2\", \"m3\");\n@@ -112,2 +113,2 @@\n-        ht.makeModule(\"org.bar\", TRANSITIVE, \"m1\");\n-        ht.makeModule(\"org.foo\", TRANSITIVE, \"org.bar\");\n+        makeModule(\"org.bar\", TRANSITIVE, \"m1\");\n+        makeModule(\"org.foo\", TRANSITIVE, \"org.bar\");\n@@ -116,2 +117,2 @@\n-        ht.makeJmod(\"m2\");\n-        ht.makeJmod(\"m3\");\n+        makeJmod(\"m2\");\n+        makeJmod(\"m3\");\n@@ -120,1 +121,1 @@\n-        ht.jmodHashModules(\"m1\", \".*\");\n+        jmodHashModules(\"m1\", \".*\");\n@@ -123,3 +124,3 @@\n-        assertTrue(ht.hashes(\"m1\") == null);\n-        assertTrue(ht.hashes(\"m2\") == null);\n-        assertTrue(ht.hashes(\"m3\") == null);\n+        assertNull(hashes(\"m1\"));\n+        assertNull(hashes(\"m2\"));\n+        assertNull(hashes(\"m3\"));\n@@ -128,2 +129,2 @@\n-        ht.jmodHashModules(\"m2\",  \"m1\");\n-        ht.checkHashes(\"m2\", Set.of(\"m1\"));\n+        jmodHashModules(\"m2\",  \"m1\");\n+        checkHashes(\"m2\", Set.of(\"m1\"));\n@@ -132,2 +133,2 @@\n-        ht.jmodHashModules(\"m2\",  \".*\");\n-        ht.checkHashes(\"m2\", Set.of(\"m1\"));\n+        jmodHashModules(\"m2\",  \".*\");\n+        checkHashes(\"m2\", Set.of(\"m1\"));\n@@ -136,1 +137,1 @@\n-        ht.makeJmod(\"m2\");\n+        makeJmod(\"m2\");\n@@ -138,1 +139,1 @@\n-        runJmod(List.of(\"hash\", \"--module-path\", ht.lib.toString(),\n+        runJmod(List.of(\"hash\", \"--module-path\", lib.toString(),\n@@ -140,2 +141,2 @@\n-        ht.checkHashes(\"m2\", Set.of(\"m1\"));\n-        ht.checkHashes(\"m3\", Set.of(\"m1\"));\n+        checkHashes(\"m2\", Set.of(\"m1\"));\n+        checkHashes(\"m3\", Set.of(\"m1\"));\n@@ -144,2 +145,2 @@\n-        ht.makeJmod(\"org.bar\");\n-        ht.makeJmod(\"org.foo\");\n+        makeJmod(\"org.bar\");\n+        makeJmod(\"org.foo\");\n@@ -147,2 +148,2 @@\n-        ht.jmodHashModules(\"org.bar\", \"org.*\");\n-        ht.checkHashes(\"org.bar\", Set.of(\"org.foo\"));\n+        jmodHashModules(\"org.bar\", \"org.*\");\n+        checkHashes(\"org.bar\", Set.of(\"org.foo\"));\n@@ -150,2 +151,2 @@\n-        ht.jmodHashModules( \"m3\", \".*\");\n-        ht.checkHashes(\"m3\", Set.of(\"org.foo\", \"org.bar\", \"m1\"));\n+        jmodHashModules( \"m3\", \".*\");\n+        checkHashes(\"m3\", Set.of(\"org.foo\", \"org.bar\", \"m1\"));\n@@ -155,4 +156,1 @@\n-    public static void multiBaseModules() throws IOException {\n-        Path dest = Paths.get(\"test2\");\n-        HashesTest ht = new HashesTest(dest);\n-\n+    public void multiBaseModules() throws IOException {\n@@ -170,3 +168,3 @@\n-        ht.makeModule(\"z1\");\n-        ht.makeModule(\"z2\", \"z1\");\n-        ht.makeModule(\"z3\", \"z1\", \"z2\");\n+        makeModule(\"z1\");\n+        makeModule(\"z2\", \"z1\");\n+        makeModule(\"z3\", \"z1\", \"z2\");\n@@ -174,2 +172,2 @@\n-        ht.makeModule(\"y1\");\n-        ht.makeModule(\"y2\", \"y1\", \"z2\", \"z3\");\n+        makeModule(\"y1\");\n+        makeModule(\"y2\", \"y1\", \"z2\", \"z3\");\n@@ -181,1 +179,1 @@\n-        Stream.concat(ys.stream(), zs.stream()).forEach(ht::makeJmod);\n+        Stream.concat(ys.stream(), zs.stream()).forEach(this::makeJmod);\n@@ -184,1 +182,1 @@\n-        runJmod(List.of(\"hash\", \"--module-path\", ht.lib.toString(),\n+        runJmod(List.of(\"hash\", \"--module-path\", lib.toString(),\n@@ -190,2 +188,2 @@\n-        ht.checkHashes(\"y1\", Set.of(\"y2\"));\n-        ht.checkHashes(\"z1\", Set.of(\"z2\", \"z3\", \"y2\"));\n+        checkHashes(\"y1\", Set.of(\"y2\"));\n+        checkHashes(\"z1\", Set.of(\"z2\", \"z3\", \"y2\"));\n@@ -194,1 +192,1 @@\n-              .forEach(mn -> assertTrue(ht.hashes(mn) == null));\n+              .forEach(mn -> assertNull(hashes(mn)));\n@@ -198,4 +196,1 @@\n-    public static void mixJmodAndJarFile() throws IOException {\n-        Path dest = Paths.get(\"test3\");\n-        HashesTest ht = new HashesTest(dest);\n-\n+    public void mixJmodAndJarFile() throws IOException {\n@@ -213,5 +208,5 @@\n-        ht.makeModule(\"j1\");\n-        ht.makeModule(\"j2\");\n-        ht.makeModule(\"m1\", \"j1\");\n-        ht.makeModule(\"m2\", \"m1\");\n-        ht.makeModule(\"m3\", \"m1\", \"m2\");\n+        makeModule(\"j1\");\n+        makeModule(\"j2\");\n+        makeModule(\"m1\", \"j1\");\n+        makeModule(\"m2\", \"m1\");\n+        makeModule(\"m3\", \"m1\", \"m2\");\n@@ -219,1 +214,1 @@\n-        ht.makeModule(\"j3\", \"j2\", \"m2\", \"m3\");\n+        makeModule(\"j3\", \"j2\", \"m2\", \"m3\");\n@@ -225,2 +220,2 @@\n-        jars.forEach(ht::makeJar);\n-        jmods.forEach(ht::makeJmod);\n+        jars.forEach(this::makeJar);\n+        jmods.forEach(this::makeJmod);\n@@ -229,1 +224,1 @@\n-        runJmod(List.of(\"hash\", \"--module-path\", ht.lib.toString(),\n+        runJmod(List.of(\"hash\", \"--module-path\", lib.toString(),\n@@ -235,2 +230,2 @@\n-        ht.checkHashes(\"j2\", Set.of(\"j3\"));\n-        ht.checkHashes(\"j1\", Set.of(\"m1\", \"m2\", \"m3\", \"j3\"));\n+        checkHashes(\"j2\", Set.of(\"j3\"));\n+        checkHashes(\"j1\", Set.of(\"m1\", \"m2\", \"m3\", \"j3\"));\n@@ -239,1 +234,1 @@\n-              .forEach(mn -> assertTrue(ht.hashes(mn) == null));\n+              .forEach(mn -> assertNull(hashes(mn)));\n@@ -243,1 +238,1 @@\n-    public static void upgradeableModule() throws IOException {\n+    public void upgradeableModule() throws IOException {\n@@ -249,5 +244,3 @@\n-        Path dest = Paths.get(\"test4\");\n-        HashesTest ht = new HashesTest(dest);\n-        ht.makeModule(\"m1\");\n-        ht.makeModule(\"java.compiler\", \"m1\");\n-        ht.makeModule(\"m2\", \"java.compiler\");\n+        makeModule(\"m1\");\n+        makeModule(\"java.compiler\", \"m1\");\n+        makeModule(\"m2\", \"java.compiler\");\n@@ -255,3 +248,3 @@\n-        ht.makeJmod(\"m1\");\n-        ht.makeJmod(\"m2\");\n-        ht.makeJmod(\"java.compiler\",\n+        makeJmod(\"m1\");\n+        makeJmod(\"m2\");\n+        makeJmod(\"java.compiler\",\n@@ -259,1 +252,1 @@\n-                    ht.lib.toString() + File.pathSeparator + mpath,\n+                    lib.toString() + File.pathSeparator + mpath,\n@@ -262,1 +255,1 @@\n-        ht.checkHashes(\"java.compiler\",  Set.of(\"m2\"));\n+        checkHashes(\"java.compiler\",  Set.of(\"m2\"));\n@@ -266,1 +259,1 @@\n-    public static void testImageJmods() throws IOException {\n+    public void testImageJmods() throws IOException {\n@@ -272,5 +265,3 @@\n-        Path dest = Paths.get(\"test5\");\n-        HashesTest ht = new HashesTest(dest);\n-        ht.makeModule(\"m1\", \"jdk.compiler\", \"jdk.attach\");\n-        ht.makeModule(\"m2\", \"m1\");\n-        ht.makeModule(\"m3\", \"java.compiler\");\n+        makeModule(\"m1\", \"jdk.compiler\", \"jdk.attach\");\n+        makeModule(\"m2\", \"m1\");\n+        makeModule(\"m3\", \"java.compiler\");\n@@ -278,2 +269,2 @@\n-        ht.makeJmod(\"m1\");\n-        ht.makeJmod(\"m2\");\n+        makeJmod(\"m1\");\n+        makeJmod(\"m2\");\n@@ -283,1 +274,1 @@\n-                        mpath.toString() + File.pathSeparator + ht.lib.toString(),\n+                        mpath.toString() + File.pathSeparator + lib.toString(),\n@@ -286,1 +277,1 @@\n-        validateImageJmodsTest(ht, mpath);\n+        validateImageJmodsTest(mpath);\n@@ -290,1 +281,1 @@\n-    public static void testImageJmods1() throws IOException {\n+    public void testImageJmods1() throws IOException {\n@@ -296,5 +287,3 @@\n-        Path dest = Paths.get(\"test6\");\n-        HashesTest ht = new HashesTest(dest);\n-        ht.makeModule(\"m1\", \"jdk.compiler\", \"jdk.attach\");\n-        ht.makeModule(\"m2\", \"m1\");\n-        ht.makeModule(\"m3\", \"java.compiler\");\n+        makeModule(\"m1\", \"jdk.compiler\", \"jdk.attach\");\n+        makeModule(\"m2\", \"m1\");\n+        makeModule(\"m3\", \"java.compiler\");\n@@ -302,2 +291,2 @@\n-        ht.makeJar(\"m2\");\n-        ht.makeJar(\"m1\",\n+        makeJar(\"m2\");\n+        makeJar(\"m1\",\n@@ -305,1 +294,1 @@\n-                    mpath.toString() + File.pathSeparator + ht.lib.toString(),\n+                    mpath.toString() + File.pathSeparator + lib.toString(),\n@@ -307,1 +296,1 @@\n-        validateImageJmodsTest(ht, mpath);\n+        validateImageJmodsTest(mpath);\n@@ -311,6 +300,5 @@\n-    public static void testReproducibibleHash() throws Exception {\n-        HashesTest ht = new HashesTest(Path.of(\"repro\"));\n-        ht.makeModule(\"m4\");\n-        ht.makeModule(\"m3\", \"m4\");\n-        ht.makeModule(\"m2\");\n-        ht.makeModule(\"m1\", \"m2\", \"m3\");\n+    public void testReproducibibleHash() throws Exception {\n+        makeModule(\"m4\");\n+        makeModule(\"m3\", \"m4\");\n+        makeModule(\"m2\");\n+        makeModule(\"m1\", \"m2\", \"m3\");\n@@ -319,2 +307,2 @@\n-        List.of(\"m1\", \"m2\", \"m3\", \"m4\").forEach(ht::makeJmod);\n-        Map<String, ModuleHashes> hashes1 = ht.runJmodHash();\n+        List.of(\"m1\", \"m2\", \"m3\", \"m4\").forEach(this::makeJmod);\n+        Map<String, ModuleHashes> hashes1 = runJmodHash();\n@@ -326,2 +314,2 @@\n-        List.of(\"m1\", \"m2\", \"m3\", \"m4\").forEach(ht::makeJmod);\n-        Map<String, ModuleHashes> hashes2 = ht.runJmodHash();\n+        List.of(\"m1\", \"m2\", \"m3\", \"m4\").forEach(this::makeJmod);\n+        Map<String, ModuleHashes> hashes2 = runJmodHash();\n@@ -334,4 +322,1 @@\n-    public static void testHashModulesPattern() throws IOException {\n-        Path dest = Paths.get(\"regex\");\n-        HashesTest ht = new HashesTest(dest);\n-\n+    public void testHashModulesPattern() throws IOException {\n@@ -339,5 +324,5 @@\n-        ht.makeModule(\"m1\");\n-        ht.makeModule(\"m2\", \"m1\");\n-        ht.makeModule(\"m3\");\n-        ht.makeModule(\"m4\", \"m1\", \"m3\");\n-        List.of(\"m1\", \"m2\", \"m3\", \"m4\").forEach(ht::makeJmod);\n+        makeModule(\"m1\");\n+        makeModule(\"m2\", \"m1\");\n+        makeModule(\"m3\");\n+        makeModule(\"m4\", \"m1\", \"m3\");\n+        List.of(\"m1\", \"m2\", \"m3\", \"m4\").forEach(this::makeJmod);\n@@ -347,1 +332,1 @@\n-        Path jmod = ht.lib.resolve(\"m1.jmod\");\n+        Path jmod = lib.resolve(\"m1.jmod\");\n@@ -349,1 +334,1 @@\n-                \"--module-path\", ht.lib.toString(),\n+                \"--module-path\", lib.toString(),\n@@ -351,2 +336,2 @@\n-        assertEquals(ht.moduleHashes().keySet(), Set.of(\"m1\"));\n-        ht.checkHashes(\"m1\", Set.of(\"m2\"));\n+        assertEquals(moduleHashes().keySet(), Set.of(\"m1\"));\n+        checkHashes(\"m1\", Set.of(\"m2\"));\n@@ -356,1 +341,1 @@\n-                \"--module-path\", ht.lib.toString(),\n+                \"--module-path\", lib.toString(),\n@@ -358,2 +343,2 @@\n-        assertEquals(ht.moduleHashes().keySet(), Set.of(\"m1\"));\n-        ht.checkHashes(\"m1\", Set.of(\"m2\", \"m4\"));\n+        assertEquals(moduleHashes().keySet(), Set.of(\"m1\"));\n+        checkHashes(\"m1\", Set.of(\"m2\", \"m4\"));\n@@ -363,1 +348,1 @@\n-                \"--module-path\", ht.lib.toString(),\n+                \"--module-path\", lib.toString(),\n@@ -365,2 +350,2 @@\n-        assertEquals(ht.moduleHashes().keySet(), Set.of(\"m1\"));\n-        ht.checkHashes(\"m1\", Set.of(\"m2\", \"m4\"));\n+        assertEquals(moduleHashes().keySet(), Set.of(\"m1\"));\n+        checkHashes(\"m1\", Set.of(\"m2\", \"m4\"));\n@@ -371,1 +356,1 @@\n-                \"--module-path\", ht.lib.toString(),\n+                \"--module-path\", lib.toString(),\n@@ -373,3 +358,3 @@\n-        assertEquals(ht.moduleHashes().keySet(), Set.of(\"m1\", \"m3\"));\n-        ht.checkHashes(\"m1\", Set.of(\"m2\", \"m4\"));\n-        ht.checkHashes(\"m3\", Set.of(\"m4\"));\n+        assertEquals(moduleHashes().keySet(), Set.of(\"m1\", \"m3\"));\n+        checkHashes(\"m1\", Set.of(\"m2\", \"m4\"));\n+        checkHashes(\"m3\", Set.of(\"m4\"));\n@@ -378,1 +363,1 @@\n-    private static void validateImageJmodsTest(HashesTest ht, Path mpath)\n+    private void validateImageJmodsTest(Path mpath)\n@@ -382,2 +367,2 @@\n-        ht.checkHashes(\"m1\", Set.of(\"m2\"));\n-        assertTrue(ht.hashes(\"m2\") == null);\n+        checkHashes(\"m1\", Set.of(\"m2\"));\n+        assertNull(hashes(\"m2\"));\n@@ -387,2 +372,2 @@\n-        assertTrue(ht.hashes(finder,\"jdk.compiler\") == null);\n-        assertTrue(ht.hashes(finder,\"jdk.attach\") == null);\n+        assertNull(hashes(finder, \"jdk.compiler\"));\n+        assertNull(hashes(finder, \"jdk.attach\"));\n@@ -391,1 +376,1 @@\n-    private void checkHashes(String mn, Set<String> hashModules) throws IOException {\n+    private void checkHashes(String mn, Set<String> hashModules) {\n@@ -393,1 +378,1 @@\n-        assertTrue(hashes.names().equals(hashModules));\n+        assertEquals(hashModules, hashes.names());\n@@ -404,2 +389,1 @@\n-            ModuleReader reader = mref.open();\n-            try (InputStream in = reader.open(\"module-info.class\").get()) {\n+            try (ModuleReader reader = mref.open(); InputStream in = reader.open(\"module-info.class\").get()) {\n@@ -415,2 +399,0 @@\n-            } finally {\n-                reader.close();\n@@ -432,1 +414,1 @@\n-        Files.walkFileTree(dir, new SimpleFileVisitor<Path>() {\n+        Files.walkFileTree(dir, new SimpleFileVisitor<>() {\n@@ -435,2 +417,1 @@\n-                throws IOException\n-            {\n+                    throws IOException {\n@@ -443,2 +424,1 @@\n-                throws IOException\n-            {\n+                    throws IOException {\n","filename":"test\/jdk\/tools\/jmod\/hashes\/HashesTest.java","additions":127,"deletions":147,"binary":false,"changes":274,"status":"modified"}]}