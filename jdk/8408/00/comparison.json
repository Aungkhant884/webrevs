{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2013, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2013, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -42,2 +42,2 @@\n- * @run main\/othervm -XX:+IgnoreUnrecognizedVMOptions -XX:-UseCompressedOops -XX:-UseCompressedClassPointers -XX:+UseSerialGC -XX:+UsePerfData -Xint gc.metaspace.TestPerfCountersAndMemoryPools\n- * @run main\/othervm -XX:+IgnoreUnrecognizedVMOptions -XX:+UseCompressedOops -XX:+UseCompressedClassPointers -XX:+UseSerialGC -XX:+UsePerfData -Xint gc.metaspace.TestPerfCountersAndMemoryPools\n+ * @run main\/othervm -XX:+IgnoreUnrecognizedVMOptions -Xlog:class+load,class+unload=trace -XX:-UseCompressedOops -XX:-UseCompressedClassPointers -XX:+UseSerialGC -XX:+UsePerfData -Xint gc.metaspace.TestPerfCountersAndMemoryPools\n+ * @run main\/othervm -XX:+IgnoreUnrecognizedVMOptions -Xlog:class+load,class+unload=trace -XX:+UseCompressedOops -XX:+UseCompressedClassPointers -XX:+UseSerialGC -XX:+UsePerfData -Xint gc.metaspace.TestPerfCountersAndMemoryPools\n@@ -83,4 +83,13 @@\n-        \/\/ Adding a second GC due to metadata allocations caused by getting the\n-        \/\/ initial size from the pool. This is needed when running with -Xcomp.\n-        System.gc();\n-        assertEQ(getUsed(perfNS), pool.getUsage().getUsed(), \"Used out of sync\");\n+        long usedPerfCounters;\n+        long usedMXBean;\n+\n+        \/\/ the pool.getUsage().getUsed() might load additional classes intermittently\n+        \/\/ so first verify that perfCounters are not changed, call System.gc() to reset them\n+        do {\n+            System.gc();\n+            usedPerfCounters = getUsed(perfNS);\n+            usedMXBean = pool.getUsage().getUsed();\n+            System.gc();\n+        } while (usedPerfCounters != getUsed(perfNS));\n+        assertEQ(usedPerfCounters, usedMXBean, \"Used out of sync\");\n+\n","filename":"test\/hotspot\/jtreg\/gc\/metaspace\/TestPerfCountersAndMemoryPools.java","additions":16,"deletions":7,"binary":false,"changes":23,"status":"modified"}]}