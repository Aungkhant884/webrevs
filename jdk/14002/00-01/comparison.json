{"files":[{"patch":"@@ -1886,0 +1886,3 @@\n+  if (err != JVMTI_ERROR_NONE) {\n+    return err;\n+  }\n@@ -1888,6 +1891,8 @@\n-  if (is_virtual && !is_JavaThread_current(java_thread, thread_obj)) {\n-    if (!is_vthread_suspended(thread_obj, java_thread)) {\n-      return JVMTI_ERROR_THREAD_NOT_SUSPENDED;\n-    }\n-    if (java_thread == nullptr) { \/\/ unmounted virtual thread\n-      return JVMTI_ERROR_OPAQUE_FRAME;\n+  if (is_virtual) {\n+    if (!is_JavaThread_current(java_thread, thread_obj)) {\n+      if (!is_vthread_suspended(thread_obj, java_thread)) {\n+        return JVMTI_ERROR_THREAD_NOT_SUSPENDED;\n+      }\n+      if (java_thread == nullptr) { \/\/ unmounted virtual thread\n+        return JVMTI_ERROR_OPAQUE_FRAME;\n+      }\n@@ -1895,1 +1900,1 @@\n-  } else {\n+  } else { \/\/ platform thread\n@@ -1901,3 +1906,0 @@\n-  if (err != JVMTI_ERROR_NONE) {\n-    return err;\n-  }\n","filename":"src\/hotspot\/share\/prims\/jvmtiEnv.cpp","additions":12,"deletions":10,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -118,4 +118,0 @@\n-  LOG(\"Testing PopFrame\\n\");\n-  err = jvmti->PopFrame(vthread);\n-  check_jvmti_error_opaque_frame(jni, \"PopFrame\", err);\n-\n","filename":"test\/hotspot\/jtreg\/serviceability\/jvmti\/vthread\/BoundVThreadTest\/libBoundVThreadTest.cpp","additions":0,"deletions":4,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -222,1 +222,1 @@\n-        \/\/ Method is blocked on entering a synchronized statement.\n+        \/\/ Method is busy in a while loop.\n@@ -241,1 +241,1 @@\n-        \/\/ This method uses PoopFrame on its own thread. It is expected to succeed.\n+        \/\/ This method uses PopFrame on its own thread. It is expected to return OPAQUE_FRAME.\n","filename":"test\/hotspot\/jtreg\/serviceability\/jvmti\/vthread\/PopFrameTest\/PopFrameTest.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -48,13 +48,5 @@\n-\n-  err = jvmti->RawMonitorEnter(monitor);\n-  check_jvmti_status(jni, err, \"Breakpoint: Failed in RawMonitorEnter\");\n-\n-  bp_sync_reached = true;\n-\n-  \/\/ wait for notify from notifyAtBreakpoint\n-  err = jvmti->RawMonitorWait(monitor, 0);\n-  check_jvmti_status(jni, err, \"Breakpoint: Failed in RawMonitorWait\");\n-\n-  err = jvmti->RawMonitorExit(monitor);\n-  check_jvmti_status(jni, err, \"Breakpoint: Failed in RawMonitorExit\");\n-\n+  {\n+    RawMonitorLocker rml(jvmti, jni, monitor);\n+    bp_sync_reached = true;\n+    rml.wait(0);\n+  }\n@@ -161,1 +153,0 @@\n-\n@@ -163,3 +154,1 @@\n-    err = jvmti->RawMonitorEnter(monitor);\n-    check_jvmti_status(jni, err, \"ensureAtBreakpoint: Failed in RawMonitorEnter\");\n-\n+    RawMonitorLocker rml(jvmti, jni, monitor);\n@@ -167,4 +156,0 @@\n-\n-    err = jvmti->RawMonitorExit(monitor);\n-    check_jvmti_status(jni, err, \"ensureAtBreakpoint: Failed in RawMonitorExit\");\n-\n@@ -180,9 +165,2 @@\n-\n-  err = jvmti->RawMonitorEnter(monitor);\n-  check_jvmti_status(jni, err, \"notifyAtBreakpoint: Fatal Error in RawMonitorEnter\");\n-\n-  err = jvmti->RawMonitorNotify(monitor);\n-  check_jvmti_status(jni, err, \"notifyAtBreakpoint: Fatal Error in RawMonitorNotify\");\n-\n-  err = jvmti->RawMonitorExit(monitor);\n-  check_jvmti_status(jni, err, \"notifyAtBreakpoint: Fatal Error in RawMonitorExit\");\n+  RawMonitorLocker rml(jvmti, jni, monitor);\n+  rml.notify_all();\n","filename":"test\/hotspot\/jtreg\/serviceability\/jvmti\/vthread\/PopFrameTest\/libPopFrameTest.cpp","additions":8,"deletions":30,"binary":false,"changes":38,"status":"modified"},{"patch":"@@ -90,4 +90,0 @@\n-  LOG(\"Testing PopFrame\\n\");\n-  err = jvmti->PopFrame(vthread);\n-  check_jvmti_error_opaque_frame(jni, \"PopFrame\", err);\n-\n","filename":"test\/hotspot\/jtreg\/serviceability\/jvmti\/vthread\/VThreadUnsupportedTest\/libVThreadUnsupportedTest.cpp","additions":0,"deletions":4,"binary":false,"changes":4,"status":"modified"}]}