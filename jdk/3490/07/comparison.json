{"files":[{"patch":"@@ -0,0 +1,149 @@\n+\/*\n+ * Copyright (c) 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+import javax.crypto.SecretKey;\n+import javax.crypto.spec.SecretKeySpec;\n+import java.security.Key;\n+import java.security.KeyFactory;\n+import java.security.KeyPair;\n+import java.security.KeyPairGenerator;\n+import java.security.Provider;\n+import java.security.Security;\n+import java.security.spec.PKCS8EncodedKeySpec;\n+import java.security.spec.X509EncodedKeySpec;\n+import java.util.Arrays;\n+import java.util.LinkedList;\n+import java.util.List;\n+import javax.crypto.KeyGenerator;\n+\n+\/*\n+ * @test\n+ * @bug 8185127\n+ * @summary Test key comparison for the Keys generated through KeyGenerator\n+ * @run main CompareKeys\n+ *\/\n+public class CompareKeys {\n+\n+    public static void main(String[] args) throws Exception {\n+\n+        for (KeygenAlgo alg : getSupportedAlgo(\"KeyGenerator\")) {\n+            System.out.printf(\"Verifying provider %s and algorithm %s%n\",\n+                    alg.provider().getName(), alg.algoName());\n+            SecretKey k = genSecretKey(alg.algoName(), alg.provider());\n+            checkKeyEquality(k, copy(alg.algoName(), k));\n+        }\n+\n+        for (KeygenAlgo alg : getSupportedAlgo(\"KeyPairGenerator\")) {\n+            System.out.printf(\"Verifying provider %s and algorithm %s%n\",\n+                    alg.provider().getName(), alg.algoName());\n+            KeyPair kp = genKeyPair(alg.algoName(), alg.provider());\n+            checkKeyPairEquality(kp, copy(alg.algoName(), kp));\n+        }\n+        System.out.println(\"Done!\");\n+    }\n+\n+    @SuppressWarnings(\"preview\")\n+    private record KeygenAlgo(String algoName, Provider provider) {\n+\n+    }\n+\n+    private static void checkKeyPairEquality(KeyPair origkp, KeyPair copykp)\n+            throws Exception {\n+\n+        checkKeyEquality(origkp.getPrivate(), copykp.getPrivate());\n+        checkKeyEquality(origkp.getPublic(), copykp.getPublic());\n+    }\n+\n+    \/**\n+     * Compare original Key with another copy.\n+     *\/\n+    private static void checkKeyEquality(Key origKey, Key copyKey) {\n+\n+        if ((origKey.equals(copyKey)\n+                && origKey.hashCode() == copyKey.hashCode()\n+                && Arrays.equals(origKey.getEncoded(), copyKey.getEncoded())\n+                && origKey.getFormat().equals(copyKey.getFormat()))) {\n+            System.out.printf(\"%s equality check Passed%n\",\n+                    origKey.getClass().getName());\n+        } else {\n+            System.out.println(\"Result- equals: \"\n+                    + origKey.equals(copyKey));\n+            System.out.println(\"Result- hashCode: \"\n+                    + (origKey.hashCode() == copyKey.hashCode()));\n+            System.out.println(\"Result- encoded check: \" + Arrays.equals(\n+                    origKey.getEncoded(), copyKey.getEncoded()));\n+            System.out.println(\"Result- format check: \"\n+                    + origKey.getFormat().equals(copyKey.getFormat()));\n+            throw new RuntimeException(\"Key inequality found\");\n+        }\n+    }\n+\n+    private static Key copy(String algo, Key key) throws Exception {\n+\n+        return new SecretKeySpec(key.getEncoded(), algo);\n+    }\n+\n+    private static KeyPair copy(String algo, KeyPair kp) throws Exception {\n+\n+        KeyFactory kf = KeyFactory.getInstance(algo);\n+        return new KeyPair(\n+                kf.generatePublic(\n+                        new X509EncodedKeySpec(kp.getPublic().getEncoded())),\n+                kf.generatePrivate(\n+                        new PKCS8EncodedKeySpec(kp.getPrivate().getEncoded())));\n+    }\n+\n+    private static List<KeygenAlgo> getSupportedAlgo(String type)\n+            throws Exception {\n+\n+        List<KeygenAlgo> kgs = new LinkedList<>();\n+        for (Provider p : Security.getProviders()) {\n+            for (Provider.Service s : p.getServices()) {\n+                \/\/ Ignore the algorithms from the list which require\n+                \/\/ pre-initialisation to make the Test generic across algorithms.\n+                \/\/ SunMSCAPI provider is ignored too because of incompatibilty\n+                \/\/ for serialization and with PKCS8EncodedKeySpec for certain\n+                \/\/ algorithms like RSA.\n+                if (s.getType().contains(type)\n+                        && !((s.getAlgorithm().startsWith(\"SunTls\"))\n+                        || s.getProvider().getName().equals(\"SunMSCAPI\"))) {\n+                    kgs.add(new KeygenAlgo(s.getAlgorithm(), s.getProvider()));\n+                }\n+            }\n+        }\n+        return kgs;\n+    }\n+\n+    public static SecretKey genSecretKey(String algoName, Provider provider)\n+            throws Exception {\n+\n+        return KeyGenerator.getInstance(algoName, provider).generateKey();\n+    }\n+\n+    public static KeyPair genKeyPair(String algoName, Provider provider)\n+            throws Exception {\n+\n+        return KeyPairGenerator.getInstance(algoName, provider)\n+                .generateKeyPair();\n+    }\n+}\n","filename":"test\/jdk\/javax\/crypto\/KeyGenerator\/CompareKeys.java","additions":149,"deletions":0,"binary":false,"changes":149,"status":"added"}]}