{"files":[{"patch":"@@ -36,0 +36,2 @@\n+bool ClassLoaderDataShared::_full_module_graph_loaded = false;\n+\n@@ -217,0 +219,1 @@\n+  _full_module_graph_loaded = true;\n","filename":"src\/hotspot\/share\/classfile\/classLoaderDataShared.cpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -36,0 +36,1 @@\n+  static bool _full_module_graph_loaded;\n@@ -46,0 +47,1 @@\n+  static bool is_full_module_graph_loaded() { return _full_module_graph_loaded; }\n","filename":"src\/hotspot\/share\/classfile\/classLoaderDataShared.hpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -1056,3 +1056,7 @@\n-PackageEntry* SystemDictionaryShared::get_package_entry_from_class_name(Handle class_loader, Symbol* class_name) {\n-  PackageEntry* pkg_entry = NULL;\n-  TempNewSymbol pkg_name = ClassLoader::package_from_class_name(class_name);\n+PackageEntry* SystemDictionaryShared::get_package_entry_from_class_name(InstanceKlass* ik, Handle class_loader) {\n+  PackageEntry* pkg_entry = ik->package();\n+  if (MetaspaceShared::use_full_module_graph() && ik->is_shared() &&\n+       ((pkg_entry == NULL) || MetaspaceShared::is_in_shared_metaspace(pkg_entry))) {\n+    return pkg_entry;\n+  }\n+  TempNewSymbol pkg_name = ClassLoader::package_from_class_name(ik->name());\n@@ -1061,0 +1065,2 @@\n+  } else {\n+    pkg_entry = NULL;\n@@ -1075,1 +1081,1 @@\n-      PackageEntry* pkg_entry = get_package_entry_from_class_name(class_loader, class_name);\n+      PackageEntry* pkg_entry = get_package_entry_from_class_name(ik, class_loader);\n@@ -1175,1 +1181,1 @@\n-  PackageEntry* pkg_entry = get_package_entry_from_class_name(class_loader, ik->name());\n+  PackageEntry* pkg_entry = get_package_entry_from_class_name(ik, class_loader);\n@@ -1687,1 +1693,1 @@\n-  PackageEntry* pkg_entry = get_package_entry_from_class_name(class_loader, caller_ik->name());\n+  PackageEntry* pkg_entry = get_package_entry_from_class_name(caller_ik, class_loader);\n","filename":"src\/hotspot\/share\/classfile\/systemDictionaryShared.cpp","additions":12,"deletions":6,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -138,1 +138,1 @@\n-  static PackageEntry* get_package_entry_from_class_name(Handle class_loader, Symbol* class_name);\n+  static PackageEntry* get_package_entry_from_class_name(InstanceKlass* ik, Handle class_loader);\n","filename":"src\/hotspot\/share\/classfile\/systemDictionaryShared.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -27,0 +27,1 @@\n+#include \"classfile\/packageEntry.hpp\"\n@@ -909,0 +910,17 @@\n+\n+#if INCLUDE_CDS_JAVA_HEAP\n+void ArchiveBuilder::update_package_entry() {\n+  for (int i = 0; i < klasses()->length(); i++) {\n+    Klass* k = klasses()->at(i);\n+    if (k->is_instance_klass()) {\n+      InstanceKlass* ik = InstanceKlass::cast(k);\n+      PackageEntry* entry = ik->package();\n+      PackageEntry* archived_entry = NULL;\n+      if (entry != NULL && !entry->in_unnamed_module()) {\n+        archived_entry = PackageEntry::get_archived_entry(entry);\n+      }\n+      ik->init_shared_package_entry(archived_entry);\n+    }\n+  }\n+}\n+#endif \/\/ INCLUDE_CDS_JAVA_HEAP\n","filename":"src\/hotspot\/share\/memory\/archiveBuilder.cpp","additions":18,"deletions":0,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -289,0 +289,2 @@\n+  void update_package_entry();\n+\n","filename":"src\/hotspot\/share\/memory\/archiveBuilder.hpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -787,0 +787,7 @@\n+#if INCLUDE_CDS_JAVA_HEAP\n+  if (MetaspaceShared::use_full_module_graph()) {\n+    log_info(cds)(\"Update package entries\");\n+    builder.update_package_entry();\n+  }\n+#endif\n+\n@@ -1847,0 +1854,5 @@\n+#if INCLUDE_CDS_JAVA_HEAP\n+  if (ClassLoaderDataShared::is_full_module_graph_loaded()) {\n+    return true;\n+  }\n+#endif\n","filename":"src\/hotspot\/share\/memory\/metaspaceShared.cpp","additions":12,"deletions":0,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -2552,0 +2552,1 @@\n+#if !INCLUDE_CDS_JAVA_HEAP\n@@ -2553,0 +2554,5 @@\n+#else\n+  if (!MetaspaceShared::use_full_module_graph()) {\n+    _package_entry = NULL;\n+  }\n+#endif\n@@ -2848,0 +2854,9 @@\n+  if (is_shared() && _package_entry == pkg_entry) {\n+    if (MetaspaceShared::use_full_module_graph()) {\n+      \/\/ we can use the saved package\n+      return;\n+    } else {\n+      _package_entry = NULL;\n+    }\n+  }\n+\n","filename":"src\/hotspot\/share\/oops\/instanceKlass.cpp","additions":15,"deletions":0,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -1269,1 +1269,1 @@\n-  void init_shared_package_entry();\n+  void init_shared_package_entry(PackageEntry* entry) { _package_entry = entry; }\n","filename":"src\/hotspot\/share\/oops\/instanceKlass.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}