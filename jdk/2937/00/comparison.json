{"files":[{"patch":"@@ -35,5 +35,0 @@\n-BytecodeStream *MethodComparator::_s_old;\n-BytecodeStream *MethodComparator::_s_new;\n-ConstantPool* MethodComparator::_old_cp;\n-ConstantPool* MethodComparator::_new_cp;\n-\n@@ -53,2 +48,2 @@\n-  _old_cp = old_method->constants();\n-  _new_cp = new_method->constants();\n+  ConstantPool* old_cp = old_method->constants();\n+  ConstantPool* new_cp = new_method->constants();\n@@ -58,2 +53,0 @@\n-  _s_old = &s_old;\n-  _s_new = &s_new;\n@@ -66,1 +59,1 @@\n-    if (! args_same(c_old, c_new))\n+    if (!args_same(c_old, c_new, &s_old, &s_new, old_cp, new_cp))\n@@ -72,1 +65,3 @@\n-bool MethodComparator::args_same(Bytecodes::Code c_old, Bytecodes::Code c_new) {\n+bool MethodComparator::args_same(Bytecodes::Code c_old, Bytecodes::Code c_new,\n+                                 BytecodeStream* s_old, BytecodeStream* s_new,\n+                                 ConstantPool* old_cp,  ConstantPool* new_cp) {\n@@ -81,3 +76,3 @@\n-    u2 cpi_old = _s_old->get_index_u2();\n-    u2 cpi_new = _s_new->get_index_u2();\n-    if ((_old_cp->klass_at_noresolve(cpi_old) != _new_cp->klass_at_noresolve(cpi_new)))\n+    u2 cpi_old = s_old->get_index_u2();\n+    u2 cpi_new = s_new->get_index_u2();\n+    if ((old_cp->klass_at_noresolve(cpi_old) != new_cp->klass_at_noresolve(cpi_new)))\n@@ -86,1 +81,1 @@\n-        *(jbyte*)(_s_old->bcp() + 3) != *(jbyte*)(_s_new->bcp() + 3))\n+        *(jbyte*)(s_old->bcp() + 3) != *(jbyte*)(s_new->bcp() + 3))\n@@ -99,2 +94,2 @@\n-    int cpci_old = _s_old->get_index_u2_cpcache();\n-    int cpci_new = _s_new->get_index_u2_cpcache();\n+    int cpci_old = s_old->get_index_u2_cpcache();\n+    int cpci_new = s_new->get_index_u2_cpcache();\n@@ -104,3 +99,3 @@\n-    if ((_old_cp->klass_ref_at_noresolve(cpci_old) != _new_cp->klass_ref_at_noresolve(cpci_new)) ||\n-        (_old_cp->name_ref_at(cpci_old) != _new_cp->name_ref_at(cpci_new)) ||\n-        (_old_cp->signature_ref_at(cpci_old) != _new_cp->signature_ref_at(cpci_new)))\n+    if ((old_cp->klass_ref_at_noresolve(cpci_old) != new_cp->klass_ref_at_noresolve(cpci_new)) ||\n+        (old_cp->name_ref_at(cpci_old) != new_cp->name_ref_at(cpci_new)) ||\n+        (old_cp->signature_ref_at(cpci_old) != new_cp->signature_ref_at(cpci_new)))\n@@ -111,2 +106,2 @@\n-    int cpci_old = _s_old->get_index_u4();\n-    int cpci_new = _s_new->get_index_u4();\n+    int cpci_old = s_old->get_index_u4();\n+    int cpci_new = s_new->get_index_u4();\n@@ -117,2 +112,2 @@\n-    if ((_old_cp->name_ref_at(cpci_old) != _new_cp->name_ref_at(cpci_new)) ||\n-        (_old_cp->signature_ref_at(cpci_old) != _new_cp->signature_ref_at(cpci_new)))\n+    if ((old_cp->name_ref_at(cpci_old) != new_cp->name_ref_at(cpci_new)) ||\n+        (old_cp->signature_ref_at(cpci_old) != new_cp->signature_ref_at(cpci_new)))\n@@ -122,2 +117,2 @@\n-    cpci_old = _old_cp->invokedynamic_cp_cache_index(cpci_old);\n-    cpci_new = _new_cp->invokedynamic_cp_cache_index(cpci_new);\n+    cpci_old = old_cp->invokedynamic_cp_cache_index(cpci_old);\n+    cpci_new = new_cp->invokedynamic_cp_cache_index(cpci_new);\n@@ -125,5 +120,5 @@\n-    int cpi_old = _old_cp->cache()->entry_at(cpci_old)->constant_pool_index();\n-    int cpi_new = _new_cp->cache()->entry_at(cpci_new)->constant_pool_index();\n-    int bsm_old = _old_cp->bootstrap_method_ref_index_at(cpi_old);\n-    int bsm_new = _new_cp->bootstrap_method_ref_index_at(cpi_new);\n-    if (!pool_constants_same(bsm_old, bsm_new))\n+    int cpi_old = old_cp->cache()->entry_at(cpci_old)->constant_pool_index();\n+    int cpi_new = new_cp->cache()->entry_at(cpci_new)->constant_pool_index();\n+    int bsm_old = old_cp->bootstrap_method_ref_index_at(cpi_old);\n+    int bsm_new = new_cp->bootstrap_method_ref_index_at(cpi_new);\n+    if (!pool_constants_same(bsm_old, bsm_new, old_cp, new_cp))\n@@ -131,2 +126,2 @@\n-    int cnt_old = _old_cp->bootstrap_argument_count_at(cpi_old);\n-    int cnt_new = _new_cp->bootstrap_argument_count_at(cpi_new);\n+    int cnt_old = old_cp->bootstrap_argument_count_at(cpi_old);\n+    int cnt_new = new_cp->bootstrap_argument_count_at(cpi_new);\n@@ -136,3 +131,3 @@\n-      int idx_old = _old_cp->bootstrap_argument_index_at(cpi_old, arg_i);\n-      int idx_new = _new_cp->bootstrap_argument_index_at(cpi_new, arg_i);\n-      if (!pool_constants_same(idx_old, idx_new))\n+      int idx_old = old_cp->bootstrap_argument_index_at(cpi_old, arg_i);\n+      int idx_new = new_cp->bootstrap_argument_index_at(cpi_new, arg_i);\n+      if (!pool_constants_same(idx_old, idx_new, old_cp, new_cp))\n@@ -146,2 +141,2 @@\n-    Bytecode_loadconstant ldc_old(_s_old->method(), _s_old->bci());\n-    Bytecode_loadconstant ldc_new(_s_new->method(), _s_new->bci());\n+    Bytecode_loadconstant ldc_old(s_old->method(), s_old->bci());\n+    Bytecode_loadconstant ldc_new(s_new->method(), s_new->bci());\n@@ -150,1 +145,1 @@\n-    if (!pool_constants_same(cpi_old, cpi_new))\n+    if (!pool_constants_same(cpi_old, cpi_new, old_cp, new_cp))\n@@ -156,4 +151,4 @@\n-    u2 cpi_old = _s_old->get_index_u2();\n-    u2 cpi_new = _s_new->get_index_u2();\n-    constantTag tag_old = _old_cp->tag_at(cpi_old);\n-    constantTag tag_new = _new_cp->tag_at(cpi_new);\n+    u2 cpi_old = s_old->get_index_u2();\n+    u2 cpi_new = s_new->get_index_u2();\n+    constantTag tag_old = old_cp->tag_at(cpi_old);\n+    constantTag tag_new = new_cp->tag_at(cpi_new);\n@@ -163,1 +158,1 @@\n-      if (_old_cp->long_at(cpi_old) != _new_cp->long_at(cpi_new))\n+      if (old_cp->long_at(cpi_old) != new_cp->long_at(cpi_new))\n@@ -168,1 +163,1 @@\n-      if (jlong_cast(_old_cp->double_at(cpi_old)) != jlong_cast(_new_cp->double_at(cpi_new)))\n+      if (jlong_cast(old_cp->double_at(cpi_old)) != jlong_cast(new_cp->double_at(cpi_new)))\n@@ -175,1 +170,1 @@\n-    if (_s_old->bcp()[1] != _s_new->bcp()[1])\n+    if (s_old->bcp()[1] != s_new->bcp()[1])\n@@ -180,1 +175,1 @@\n-    if (_s_old->get_index_u2() != _s_new->get_index_u2())\n+    if (s_old->get_index_u2() != s_new->get_index_u2())\n@@ -195,1 +190,1 @@\n-    if (_s_old->is_wide() != _s_new->is_wide())\n+    if (s_old->is_wide() != s_new->is_wide())\n@@ -197,1 +192,1 @@\n-    if (_s_old->get_index() != _s_new->get_index())\n+    if (s_old->get_index() != s_new->get_index())\n@@ -219,2 +214,2 @@\n-    int old_ofs = _s_old->bytecode().get_offset_s2(c_old);\n-    int new_ofs = _s_new->bytecode().get_offset_s2(c_new);\n+    int old_ofs = s_old->bytecode().get_offset_s2(c_old);\n+    int new_ofs = s_new->bytecode().get_offset_s2(c_new);\n@@ -227,1 +222,1 @@\n-    if (_s_old->is_wide() != _s_new->is_wide())\n+    if (s_old->is_wide() != s_new->is_wide())\n@@ -229,1 +224,1 @@\n-    if (! _s_old->is_wide()) {\n+    if (!s_old->is_wide()) {\n@@ -231,1 +226,1 @@\n-      if (Bytes::get_Java_u2(_s_old->bcp() + 1) != Bytes::get_Java_u2(_s_new->bcp() + 1))\n+      if (Bytes::get_Java_u2(s_old->bcp() + 1) != Bytes::get_Java_u2(s_new->bcp() + 1))\n@@ -235,1 +230,1 @@\n-      if (Bytes::get_Java_u4(_s_old->bcp() + 1) != Bytes::get_Java_u4(_s_new->bcp() + 1))\n+      if (Bytes::get_Java_u4(s_old->bcp() + 1) != Bytes::get_Java_u4(s_new->bcp() + 1))\n@@ -242,2 +237,2 @@\n-    int old_ofs = _s_old->bytecode().get_offset_s4(c_old);\n-    int new_ofs = _s_new->bytecode().get_offset_s4(c_new);\n+    int old_ofs = s_old->bytecode().get_offset_s4(c_old);\n+    int new_ofs = s_new->bytecode().get_offset_s4(c_new);\n@@ -251,2 +246,2 @@\n-    int len_old = _s_old->instruction_size();\n-    int len_new = _s_new->instruction_size();\n+    int len_old = s_old->instruction_size();\n+    int len_new = s_new->instruction_size();\n@@ -255,1 +250,1 @@\n-    if (memcmp(_s_old->bcp(), _s_new->bcp(), len_old) != 0)\n+    if (memcmp(s_old->bcp(), s_new->bcp(), len_old) != 0)\n@@ -267,3 +262,3 @@\n-bool MethodComparator::pool_constants_same(int cpi_old, int cpi_new) {\n-  constantTag tag_old = _old_cp->tag_at(cpi_old);\n-  constantTag tag_new = _new_cp->tag_at(cpi_new);\n+bool MethodComparator::pool_constants_same(int cpi_old, int cpi_new, ConstantPool* old_cp, ConstantPool* new_cp) {\n+  constantTag tag_old = old_cp->tag_at(cpi_old);\n+  constantTag tag_new = new_cp->tag_at(cpi_new);\n@@ -274,1 +269,1 @@\n-      if (_old_cp->int_at(cpi_old) != _new_cp->int_at(cpi_new))\n+      if (old_cp->int_at(cpi_old) != new_cp->int_at(cpi_new))\n@@ -279,1 +274,1 @@\n-      if (jint_cast(_old_cp->float_at(cpi_old)) != jint_cast(_new_cp->float_at(cpi_new)))\n+      if (jint_cast(old_cp->float_at(cpi_old)) != jint_cast(new_cp->float_at(cpi_new)))\n@@ -283,2 +278,2 @@\n-    if (strcmp(_old_cp->string_at_noresolve(cpi_old),\n-               _new_cp->string_at_noresolve(cpi_new)) != 0)\n+    if (strcmp(old_cp->string_at_noresolve(cpi_old),\n+               new_cp->string_at_noresolve(cpi_new)) != 0)\n@@ -286,2 +281,2 @@\n-    if (_old_cp->is_pseudo_string_at(cpi_old) || _new_cp->is_pseudo_string_at(cpi_new))\n-      return (_old_cp->is_pseudo_string_at(cpi_old) == _new_cp->is_pseudo_string_at(cpi_new));\n+    if (old_cp->is_pseudo_string_at(cpi_old) || new_cp->is_pseudo_string_at(cpi_new))\n+      return (old_cp->is_pseudo_string_at(cpi_old) == new_cp->is_pseudo_string_at(cpi_new));\n@@ -292,2 +287,2 @@\n-    if (_old_cp->klass_at_noresolve(cpi_old) !=\n-        _new_cp->klass_at_noresolve(cpi_new))\n+    if (old_cp->klass_at_noresolve(cpi_old) !=\n+        new_cp->klass_at_noresolve(cpi_new))\n@@ -296,3 +291,3 @@\n-    int mti_old = _old_cp->method_type_index_at(cpi_old);\n-    int mti_new = _new_cp->method_type_index_at(cpi_new);\n-    if ((_old_cp->symbol_at(mti_old) != _new_cp->symbol_at(mti_new)))\n+    int mti_old = old_cp->method_type_index_at(cpi_old);\n+    int mti_new = new_cp->method_type_index_at(cpi_new);\n+    if ((old_cp->symbol_at(mti_old) != new_cp->symbol_at(mti_new)))\n@@ -301,2 +296,2 @@\n-    if (_old_cp->method_handle_ref_kind_at(cpi_old) !=\n-        _new_cp->method_handle_ref_kind_at(cpi_new))\n+    if (old_cp->method_handle_ref_kind_at(cpi_old) !=\n+        new_cp->method_handle_ref_kind_at(cpi_new))\n@@ -304,5 +299,5 @@\n-    int mhi_old = _old_cp->method_handle_index_at(cpi_old);\n-    int mhi_new = _new_cp->method_handle_index_at(cpi_new);\n-    if ((_old_cp->uncached_klass_ref_at_noresolve(mhi_old) != _new_cp->uncached_klass_ref_at_noresolve(mhi_new)) ||\n-        (_old_cp->uncached_name_ref_at(mhi_old) != _new_cp->uncached_name_ref_at(mhi_new)) ||\n-        (_old_cp->uncached_signature_ref_at(mhi_old) != _new_cp->uncached_signature_ref_at(mhi_new)))\n+    int mhi_old = old_cp->method_handle_index_at(cpi_old);\n+    int mhi_new = new_cp->method_handle_index_at(cpi_new);\n+    if ((old_cp->uncached_klass_ref_at_noresolve(mhi_old) != new_cp->uncached_klass_ref_at_noresolve(mhi_new)) ||\n+        (old_cp->uncached_name_ref_at(mhi_old) != new_cp->uncached_name_ref_at(mhi_new)) ||\n+        (old_cp->uncached_signature_ref_at(mhi_old) != new_cp->uncached_signature_ref_at(mhi_new)))\n","filename":"src\/hotspot\/share\/prims\/methodComparator.cpp","additions":76,"deletions":81,"binary":false,"changes":157,"status":"modified"},{"patch":"@@ -37,6 +37,5 @@\n-  static BytecodeStream *_s_old, *_s_new;\n-  static ConstantPool* _old_cp;\n-  static ConstantPool* _new_cp;\n-\n-  static bool args_same(Bytecodes::Code c_old, Bytecodes::Code c_new);\n-  static bool pool_constants_same(int cpi_old, int cpi_new);\n+  static bool args_same(Bytecodes::Code c_old, Bytecodes::Code c_new,\n+                        BytecodeStream* s_old, BytecodeStream* s_new,\n+                        ConstantPool* old_cp,  ConstantPool* new_cp);\n+  static bool pool_constants_same(int cpi_old, int cpi_new,\n+                                  ConstantPool* old_cp,  ConstantPool* new_cp);\n","filename":"src\/hotspot\/share\/prims\/methodComparator.hpp","additions":5,"deletions":6,"binary":false,"changes":11,"status":"modified"}]}