{"files":[{"patch":"@@ -1981,4 +1981,1 @@\n-  Register rscratch3 = r0;\n-  __ push(rscratch1);\n-  __ push(rscratch2);\n-  __ push(rscratch3);\n+  Register rscratch3 = r10;\n@@ -1986,4 +1983,1 @@\n-  __ atomic_add(noreg, 1, rscratch3);\n-  __ pop(rscratch3);\n-  __ pop(rscratch2);\n-  __ pop(rscratch1);\n+  __ atomic_addw(noreg, 1, rscratch3);\n@@ -1992,3 +1986,5 @@\n-void TemplateInterpreterGenerator::histogram_bytecode(Template* t) { ; }\n-\n-void TemplateInterpreterGenerator::histogram_bytecode_pair(Template* t) { ; }\n+void TemplateInterpreterGenerator::histogram_bytecode(Template* t) {\n+  Register rscratch3 = r10;\n+  __ mov(rscratch3, (address) &BytecodeHistogram::_counters[t->bytecode()]);\n+  __ atomic_addw(noreg, 1, rscratch3);\n+}\n@@ -1996,0 +1992,25 @@\n+void TemplateInterpreterGenerator::histogram_bytecode_pair(Template* t) {\n+  \/\/ Calculate new index for counter:\n+  \/\/   _index = (_index >> log2_number_of_codes) |\n+  \/\/            (bytecode << log2_number_of_codes);\n+  Register index_addr = r10;\n+  Register index = r11;\n+  Label L;\n+  __ mov(index_addr, (address) &BytecodePairHistogram::_index);\n+  __ mov(rscratch1,\n+         ((int)t->bytecode()) << BytecodePairHistogram::log2_number_of_codes);\n+  __ prfm(Address(index_addr), PSTL1STRM);\n+  __ bind(L);\n+  __ ldxrw(rscratch2, index_addr);\n+  __ orrw(index, rscratch1, rscratch2, Assembler::LSR,\n+          BytecodePairHistogram::log2_number_of_codes);\n+  __ stxrw(rscratch2, index, index_addr);\n+  __ cbnzw(rscratch2, L);  \/\/ retry to load _index\n+\n+  \/\/ Bump bucket contents:\n+  \/\/   _counters[_index] ++;\n+  Register counter_addr = r10;\n+  __ mov(rscratch1, (address) &BytecodePairHistogram::_counters);\n+  __ lea(counter_addr, Address(rscratch1, index, Address::lsl(LogBytesPerInt)));\n+  __ atomic_addw(noreg, 1, counter_addr);\n+}\n","filename":"src\/hotspot\/cpu\/aarch64\/templateInterpreterGenerator_aarch64.cpp","additions":32,"deletions":11,"binary":false,"changes":43,"status":"modified"},{"patch":"@@ -359,1 +359,0 @@\n-  if (PrintBytecodeHistogram)                                    histogram_bytecode(t);\n@@ -363,0 +362,1 @@\n+  if (PrintBytecodeHistogram)                                    histogram_bytecode(t);\n","filename":"src\/hotspot\/share\/interpreter\/templateInterpreterGenerator.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}