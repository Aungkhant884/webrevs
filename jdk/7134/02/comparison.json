{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1998, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1998, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -85,0 +85,8 @@\n+\/* Returns true if this is a strong reference, meaning that either or both of\n+   isPinAll and isCommonPin are true. *\/\n+static jboolean\n+isStrong(RefNode* node)\n+{\n+    return node->isPinAll || node->isCommonPin;\n+}\n+\n@@ -92,1 +100,1 @@\n-    jboolean   pin = gdata->pinAllCount != 0;\n+    jboolean   pinAll = gdata->pinAllCount != 0;\n@@ -100,1 +108,1 @@\n-    if (pin) {\n+    if (pinAll) {\n@@ -119,1 +127,1 @@\n-        if (pin) {\n+        if (pinAll) {\n@@ -131,1 +139,2 @@\n-    node->strongCount = pin ? 1 : 0;\n+    node->isPinAll    = pinAll;\n+    node->isCommonPin = JNI_FALSE;\n@@ -149,1 +158,1 @@\n-        if (node->strongCount != 0) {\n+        if (isStrong(node)) {\n@@ -161,1 +170,1 @@\n-strengthenNode(JNIEnv *env, RefNode *node)\n+strengthenNode(JNIEnv *env, RefNode *node, jboolean isPinAll)\n@@ -163,1 +172,1 @@\n-    if (node->strongCount == 0) {\n+    if (!isStrong(node)) {\n@@ -179,1 +188,2 @@\n-            node->strongCount = 1;\n+        } else {\n+          return NULL;\n@@ -181,1 +191,3 @@\n-        return strongRef;\n+    }\n+    if (isPinAll) {\n+        node->isPinAll = JNI_TRUE;\n@@ -183,2 +195,1 @@\n-        node->strongCount++;\n-        return node->ref;\n+        node->isCommonPin = JNI_TRUE;\n@@ -186,0 +197,1 @@\n+    return node->ref;\n@@ -190,1 +202,1 @@\n-weakenNode(JNIEnv *env, RefNode *node)\n+weakenNode(JNIEnv *env, RefNode *node, jboolean isUnpinAll)\n@@ -192,1 +204,5 @@\n-    if (node->strongCount == 1) {\n+    jboolean willStillBeStrong = (node->isPinAll && !isUnpinAll) || (node->isCommonPin && isUnpinAll);\n+\n+    \/\/ If the node is strong, but the reason(s) for it being strong\n+    \/\/ will no longer exist, then weaken it.\n+    if (isStrong(node) && !willStillBeStrong) {\n@@ -203,2 +219,3 @@\n-            node->ref         = weakRef;\n-            node->strongCount = 0;\n+            node->ref      = weakRef;\n+        } else {\n+          return NULL;\n@@ -206,1 +223,4 @@\n-        return weakRef;\n+    }\n+\n+    if (isUnpinAll) {\n+        node->isPinAll = JNI_FALSE;\n@@ -208,4 +228,1 @@\n-        if (node->strongCount > 0) {\n-            node->strongCount--;\n-        }\n-        return node->ref;\n+        node->isCommonPin = JNI_FALSE;\n@@ -213,0 +230,1 @@\n+    return node->ref;\n@@ -473,1 +491,1 @@\n-            if (node->strongCount != 0) {\n+          if (isStrong(node)) {\n@@ -525,1 +543,1 @@\n-            strongRef = strengthenNode(env, node);\n+            strongRef = strengthenNode(env, node, JNI_FALSE \/* isPinAll *\/);\n@@ -554,1 +572,1 @@\n-            weakRef = weakenNode(env, node);\n+            weakRef = weakenNode(env, node, JNI_FALSE \/* isUnpinAll *\/);\n@@ -588,1 +606,1 @@\n-                    strongRef = strengthenNode(env, node);\n+                    strongRef = strengthenNode(env, node, JNI_TRUE \/* isPinAll *\/);\n@@ -631,1 +649,1 @@\n-                    weakRef = weakenNode(env, node);\n+                    weakRef = weakenNode(env, node, JNI_TRUE \/* isUnpinAll *\/);\n@@ -679,2 +697,1 @@\n-                    if ( (node->strongCount == 0) &&\n-                          isSameObject(env, node->ref, NULL)) {\n+                  if (!isStrong(node) && isSameObject(env, node->ref, NULL)) {\n","filename":"src\/jdk.jdwp.agent\/share\/native\/libjdwp\/commonRef.c","additions":45,"deletions":28,"binary":false,"changes":73,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1998, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1998, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -68,1 +68,2 @@\n-    unsigned     strongCount;   \/* count of strong reference *\/\n+    jboolean     isPinAll;      \/* true if this is a strong reference due to a commonRef_pinAll() *\/\n+    jboolean     isCommonPin;   \/* true if this is a strong reference due to a commonRef_pin() *\/\n","filename":"src\/jdk.jdwp.agent\/share\/native\/libjdwp\/util.h","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"}]}