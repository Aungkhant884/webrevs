{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1998, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1998, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -92,1 +92,1 @@\n-    jboolean   pin = gdata->pinAllCount != 0;\n+    jboolean   pinAll = gdata->pinAllCount != 0;\n@@ -100,1 +100,1 @@\n-    if (pin) {\n+    if (pinAll) {\n@@ -119,1 +119,1 @@\n-        if (pin) {\n+        if (pinAll) {\n@@ -131,1 +131,3 @@\n-    node->strongCount = pin ? 1 : 0;\n+    node->isStrong    = pinAll;\n+    node->isPinAll    = pinAll;\n+    node->isCommonPin = JNI_FALSE;\n@@ -149,1 +151,1 @@\n-        if (node->strongCount != 0) {\n+        if (node->isStrong) {\n@@ -161,1 +163,1 @@\n-strengthenNode(JNIEnv *env, RefNode *node)\n+strengthenNode(JNIEnv *env, RefNode *node, jboolean isPinAll)\n@@ -163,1 +165,1 @@\n-    if (node->strongCount == 0) {\n+    if (!node->isStrong) {\n@@ -179,1 +181,1 @@\n-            node->strongCount = 1;\n+            node->isStrong = JNI_TRUE;\n@@ -181,1 +183,3 @@\n-        return strongRef;\n+    }\n+    if (isPinAll) {\n+        node->isPinAll = JNI_TRUE;\n@@ -183,2 +187,1 @@\n-        node->strongCount++;\n-        return node->ref;\n+        node->isCommonPin = JNI_TRUE;\n@@ -186,0 +189,1 @@\n+    return node->ref;\n@@ -190,1 +194,1 @@\n-weakenNode(JNIEnv *env, RefNode *node)\n+weakenNode(JNIEnv *env, RefNode *node, jboolean isUnpinAll)\n@@ -192,1 +196,9 @@\n-    if (node->strongCount == 1) {\n+    if (isUnpinAll) {\n+        node->isPinAll = JNI_FALSE;\n+    } else {\n+        node->isCommonPin = JNI_FALSE;\n+    }\n+\n+    \/\/ If the node is strong, but the reason(s) for it being strong\n+    \/\/ no longer exist, then weaken it.\n+    if (node->isStrong && !node->isPinAll && !node->isCommonPin) {\n@@ -203,7 +215,2 @@\n-            node->ref         = weakRef;\n-            node->strongCount = 0;\n-        }\n-        return weakRef;\n-    } else {\n-        if (node->strongCount > 0) {\n-            node->strongCount--;\n+            node->ref      = weakRef;\n+            node->isStrong = JNI_FALSE;\n@@ -211,1 +218,0 @@\n-        return node->ref;\n@@ -213,0 +219,1 @@\n+    return node->ref;\n@@ -473,1 +480,1 @@\n-            if (node->strongCount != 0) {\n+            if (node->isStrong) {\n@@ -525,1 +532,1 @@\n-            strongRef = strengthenNode(env, node);\n+            strongRef = strengthenNode(env, node, JNI_FALSE);\n@@ -554,1 +561,1 @@\n-            weakRef = weakenNode(env, node);\n+            weakRef = weakenNode(env, node, JNI_FALSE);\n@@ -588,1 +595,1 @@\n-                    strongRef = strengthenNode(env, node);\n+                    strongRef = strengthenNode(env, node, JNI_TRUE);\n@@ -631,1 +638,1 @@\n-                    weakRef = weakenNode(env, node);\n+                    weakRef = weakenNode(env, node, JNI_TRUE);\n@@ -679,2 +686,1 @@\n-                    if ( (node->strongCount == 0) &&\n-                          isSameObject(env, node->ref, NULL)) {\n+                    if (!node->isStrong && isSameObject(env, node->ref, NULL)) {\n","filename":"src\/jdk.jdwp.agent\/share\/native\/libjdwp\/commonRef.c","additions":35,"deletions":29,"binary":false,"changes":64,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1998, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1998, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -68,1 +68,4 @@\n-    unsigned     strongCount;   \/* count of strong reference *\/\n+    jboolean     isStrong;      \/* true if this is a strong reference. Either or both of isPinAll\n+                                   and isCommonPin will also be true *\/\n+    jboolean     isPinAll;      \/* true this is a strong reference due to a commonRef_pinAll() *\/\n+    jboolean     isCommonPin;   \/* true if this is a strong reference due to a commonRef_pin() *\/\n","filename":"src\/jdk.jdwp.agent\/share\/native\/libjdwp\/util.h","additions":5,"deletions":2,"binary":false,"changes":7,"status":"modified"}]}