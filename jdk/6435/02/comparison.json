{"files":[{"patch":"@@ -177,0 +177,8 @@\n+        return getPathForWin32Calls(false);\n+    }\n+\n+    String getPathWithPrefixForWin32Calls() throws WindowsException {\n+        return getPathForWin32Calls(true);\n+    }\n+\n+    private String getPathForWin32Calls(boolean forceLongPrefix) throws WindowsException {\n@@ -179,8 +187,10 @@\n-            return path;\n-\n-        \/\/ return cached values if available\n-        WeakReference<String> ref = pathForWin32Calls;\n-        String resolved = (ref != null) ? ref.get() : null;\n-        if (resolved != null) {\n-            \/\/ Win32 path already available\n-            return resolved;\n+            return forceLongPrefix ? addPrefix(path) : path;\n+\n+        \/\/ return cached value if available\n+        if (!forceLongPrefix) {\n+            WeakReference<String> ref = pathForWin32Calls;\n+            String cached = (ref != null) ? ref.get() : null;\n+            if (cached != null) {\n+                \/\/ Win32 path already available\n+                return cached;\n+            }\n@@ -190,1 +200,1 @@\n-        resolved = getAbsolutePath();\n+        String resolved = getAbsolutePath();\n@@ -197,1 +207,1 @@\n-        if (resolved.length() > MAX_PATH) {\n+        if (resolved.length() > MAX_PATH || forceLongPrefix) {\n@@ -202,1 +212,1 @@\n-            resolved = addPrefixIfNeeded(GetFullPathName(resolved));\n+            resolved = addPrefix(GetFullPathName(resolved));\n@@ -208,1 +218,1 @@\n-        if (type != WindowsPathType.DRIVE_RELATIVE) {\n+        if (!forceLongPrefix && type != WindowsPathType.DRIVE_RELATIVE) {\n@@ -282,0 +292,10 @@\n+    \/\/ Add long path prefix to path\n+    static String addPrefix(String path) {\n+        if (path.startsWith(\"\\\\\\\\\")) {\n+            path = \"\\\\\\\\?\\\\UNC\" + path.substring(1, path.length());\n+        } else {\n+            path = \"\\\\\\\\?\\\\\" + path;\n+        }\n+        return path;\n+    }\n+\n","filename":"src\/java.base\/windows\/classes\/sun\/nio\/fs\/WindowsPath.java","additions":32,"deletions":12,"binary":false,"changes":44,"status":"modified"},{"patch":"@@ -64,3 +64,1 @@\n-        String path = join(file.getPathForWin32Calls(), name);\n-        WindowsPath wp = WindowsPath.createFromNormalizedPath(wfs, path);\n-        return wp.getPathForWin32Calls();\n+        return join(file.getPathWithPrefixForWin32Calls(), name);\n","filename":"src\/java.base\/windows\/classes\/sun\/nio\/fs\/WindowsUserDefinedFileAttributeView.java","additions":1,"deletions":3,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -245,1 +245,1 @@\n-            int MAX_PATH = 247;\n+            int MAX_PATH = 250;\n@@ -254,0 +254,9 @@\n+            String[] elts = longPath.toString().split(\":\");\n+            \/\/String uncName = \"\\\\\\\\localhost\\\\\" + elts[0] + \"$\" + elts[1];\n+            String host = java.net.InetAddress.getLocalHost().getHostName();\n+            String uncName = \"\\\\\\\\\" + host + \"\\\\\" + elts[0] + \"$\" + elts[1];\n+            Path uncPath = Path.of(uncName);\n+\n+            System.out.printf(\"host: %s; dir: %s%n\", host,\n+                System.getProperty(\"user.dir\"));\n+\n@@ -255,9 +264,15 @@\n-                \/\/ Try to set absolute path as extended attribute; expect IAE\n-                tryCatch(IllegalArgumentException.class, new Task() {\n-                    public void run() throws IOException {\n-                        setEA(longPath, \"user:C:\\\\\");\n-                    }});\n-\n-                \/\/ Try to set an extended attribute on it.\n-                setEA(longPath, \"user:short\");\n-                setEA(longPath, \"user:reallyquitelonglongattrname\");\n+                for (Path p : new Path[] {longPath, uncPath}) {\n+                    System.out.println(\"Testing \" + p);\n+\n+                    \/\/ Try to set absolute path as extended attribute;\n+                    \/\/ expect IAE\n+                    tryCatch(IllegalArgumentException.class, new Task() {\n+                        public void run() throws IOException {\n+                            setEA(p, \"user:C:\\\\\");\n+                        }\n+                    });\n+\n+                    \/\/ Try to set an extended attribute on it.\n+                    setEA(p, \"user:short\");\n+                    setEA(p, \"user:reallyquitelonglongattrname\");\n+                }\n","filename":"test\/jdk\/java\/nio\/file\/attribute\/UserDefinedFileAttributeView\/Basic.java","additions":25,"deletions":10,"binary":false,"changes":35,"status":"modified"}]}