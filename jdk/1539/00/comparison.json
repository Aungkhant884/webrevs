{"files":[{"patch":"@@ -259,5 +259,5 @@\n-  JvmtiTagMap* tag_map_to_deallocate = _tag_map;\n-  set_tag_map(NULL);\n-  \/\/ A tag map can be big, deallocate it now\n-  if (tag_map_to_deallocate != NULL) {\n-    delete tag_map_to_deallocate;\n+  JvmtiTagMap* tag_map_to_clear = tag_map_acquire();\n+  \/\/ A tag map can be big, clear it now to save memory until\n+  \/\/ the destructor runs.\n+  if (tag_map_to_clear != NULL) {\n+    tag_map_to_clear->clear();\n","filename":"src\/hotspot\/share\/prims\/jvmtiEnvBase.cpp","additions":5,"deletions":5,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -100,0 +100,8 @@\n+\/\/ Called by env_dispose() to reclaim memory before deallocation.\n+\/\/ Remove all the entries but keep the empty table intact.\n+\/\/ This needs the table lock.\n+void JvmtiTagMap::clear() {\n+  MutexLocker ml(lock(), Mutex::_no_safepoint_check_flag);\n+  _hashmap->clear();\n+}\n+\n","filename":"src\/hotspot\/share\/prims\/jvmtiTagMap.cpp","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -122,0 +122,1 @@\n+  void clear();  \/\/ Clear tagmap table after the env is disposed.\n","filename":"src\/hotspot\/share\/prims\/jvmtiTagMap.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -52,3 +52,3 @@\n-JvmtiTagMapTable::~JvmtiTagMapTable() {\n-  \/\/ Delete this table\n-  log_debug(jvmti, table)(\"JvmtiTagMapTable deleted\");\n+void JvmtiTagMapTable::clear() {\n+  \/\/ Clear this table\n+  log_debug(jvmti, table)(\"JvmtiTagMapTable cleared\");\n@@ -62,0 +62,2 @@\n+    JvmtiTagMapEntry** p = bucket_addr(i);\n+    *p = NULL; \/\/ clear out buckets.\n@@ -67,0 +69,5 @@\n+JvmtiTagMapTable::~JvmtiTagMapTable() {\n+  clear();\n+  \/\/ base class ~BasicHashtable deallocates the buckets.\n+}\n+\n","filename":"src\/hotspot\/share\/prims\/jvmtiTagMapTable.cpp","additions":10,"deletions":3,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -93,0 +93,1 @@\n+  void clear();\n","filename":"src\/hotspot\/share\/prims\/jvmtiTagMapTable.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"}]}