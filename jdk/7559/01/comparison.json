{"files":[{"patch":"@@ -565,0 +565,1 @@\n+\n@@ -568,3 +569,1 @@\n-    (thread = JavaThread::thread_from_jni_environment(trace->env_id)) == NULL ||\n-    thread->is_exiting()) {\n-\n+      (thread = JavaThread::thread_from_jni_environment(trace->env_id))->is_exiting()) {\n@@ -576,0 +575,3 @@\n+  JavaThread* thread = JavaThread::thread_from_jni_environment(trace->env_id);\n+\n+\n","filename":"src\/hotspot\/share\/prims\/forte.cpp","additions":5,"deletions":3,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -1324,0 +1324,2 @@\n+  \/\/ Does not return null, check is_thread_from_jni_environment_termminated()\n+  \/\/ if you are not sure that it is not.\n@@ -1326,2 +1328,4 @@\n-    \/\/ We can't get here in a thread that has completed its execution and so\n-    \/\/ \"is_terminated\", but a thread is also considered terminated if the VM\n+    \/\/ We can't normally get here in a thread that has completed its\n+    \/\/ execution and so \"is_terminated\", except when the call is from\n+    \/\/ AsyncGetCallTrace, which can be triggered by a signal at any point in\n+    \/\/ a thread's lifecycle. A thread is also considered terminated if the VM\n@@ -1333,1 +1337,0 @@\n-      ShouldNotReachHere();\n@@ -1338,0 +1341,14 @@\n+  \/\/ Returns whether current thread as indicated by the given JNIEnv\n+  \/\/ is terminated.\n+  \/\/ We don't assert it is Thread::current here as that is done at the\n+  \/\/ external JNI entry points where the JNIEnv is passed into the VM.\n+  static bool is_thread_from_jni_environment_terminated(JNIEnv* env) {\n+    JavaThread* current = (JavaThread*)((intptr_t)env - in_bytes(jni_environment_offset()));\n+    \/\/ We can't get here in a thread that has completed its execution and so\n+    \/\/ \"is_terminated\", but a thread is also considered terminated if the VM\n+    \/\/ has exited, so we have to check this and block in case this is a daemon\n+    \/\/ thread returning to the VM (the JNI DirectBuffer entry points rely on\n+    \/\/ this).\n+    return current->is_terminated();\n+  }\n+\n","filename":"src\/hotspot\/share\/runtime\/thread.hpp","additions":20,"deletions":3,"binary":false,"changes":23,"status":"modified"}]}