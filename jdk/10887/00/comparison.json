{"files":[{"patch":"@@ -235,0 +235,1 @@\n+        CASE_RETURN_TEXT(EI_CLASS_UNLOAD)\n@@ -243,1 +244,0 @@\n-        CASE_RETURN_TEXT(EI_GC_FINISH)\n","filename":"src\/jdk.jdwp.agent\/share\/native\/libjdwp\/error_messages.c","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -400,1 +400,1 @@\n-        (evinfo->ei != EI_GC_FINISH) &&\n+        (evinfo->ei != EI_CLASS_UNLOAD) &&\n@@ -752,1 +752,1 @@\n-    if (NODE_EI(node) == EI_GC_FINISH) {\n+    if (NODE_EI(node) == EI_CLASS_UNLOAD) {\n@@ -824,1 +824,1 @@\n-        (NODE_EI(node) == EI_GC_FINISH) ||\n+        (NODE_EI(node) == EI_CLASS_UNLOAD) ||\n@@ -1268,1 +1268,1 @@\n-        case EI_GC_FINISH:\n+        case EI_CLASS_UNLOAD:\n@@ -1328,1 +1328,1 @@\n-        case EI_GC_FINISH:\n+        case EI_CLASS_UNLOAD:\n","filename":"src\/jdk.jdwp.agent\/share\/native\/libjdwp\/eventFilter.c","additions":5,"deletions":5,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -486,1 +486,1 @@\n-    node = getHandlerChain(EI_GC_FINISH)->first;\n+    node = getHandlerChain(EI_CLASS_UNLOAD)->first;\n@@ -1507,2 +1507,7 @@\n-    error = threadControl_setEventMode(JVMTI_ENABLE,\n-                                       EI_GC_FINISH, NULL);\n+\n+    \/*\n+     * GARBAGE_COLLECTION_FINISH is special since it is not tied to any handlers or an EI,\n+     * so it cannot be setup using threadControl_setEventMode(). Use JVMTI API directly.\n+     *\/\n+    error = JVMTI_FUNC_PTR(gdata->jvmti,SetEventNotificationMode)\n+            (gdata->jvmti, JVMTI_ENABLE, JVMTI_EVENT_GARBAGE_COLLECTION_FINISH, NULL);\n@@ -1512,0 +1517,1 @@\n+\n","filename":"src\/jdk.jdwp.agent\/share\/native\/libjdwp\/eventHandler.c","additions":9,"deletions":3,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -81,1 +81,1 @@\n-handleGarbageCollectionFinish(JNIEnv *env, EventInfo *evinfo,\n+handleClassUnload(JNIEnv *env, EventInfo *evinfo,\n@@ -85,1 +85,5 @@\n-    JDI_ASSERT_MSG(JNI_FALSE, \"Should never call handleGarbageCollectionFinish\");\n+  \/*\n+   * CLASS_UNLOAD events are synthesized by the class tracking code, so\n+   * we should never have this handler called.\n+   *\/\n+    JDI_ASSERT_MSG(JNI_FALSE, \"Should never call handleClassUnload\");\n@@ -165,2 +169,2 @@\n-        case EI_GC_FINISH:\n-            return &handleGarbageCollectionFinish;\n+        case EI_CLASS_UNLOAD:\n+            return &handleClassUnload;\n","filename":"src\/jdk.jdwp.agent\/share\/native\/libjdwp\/standardHandlers.c","additions":8,"deletions":4,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -1938,1 +1938,1 @@\n-    index2jvmti[EI_GC_FINISH          -EI_min] = JVMTI_EVENT_GARBAGE_COLLECTION_FINISH;\n+    index2jvmti[EI_CLASS_UNLOAD       -EI_min] = 0; \/\/ No mapping to JVMTI event\n@@ -1961,1 +1961,1 @@\n-    index2jdwp[EI_GC_FINISH           -EI_min] = JDWP_EVENT(CLASS_UNLOAD);\n+    index2jdwp[EI_CLASS_UNLOAD        -EI_min] = JDWP_EVENT(CLASS_UNLOAD);\n@@ -1980,1 +1980,1 @@\n-eventIndex2jdwp(EventIndex i)\n+eventIndex2jdwp(EventIndex ei)\n@@ -1982,2 +1982,3 @@\n-    if ( i < EI_min || i > EI_max ) {\n-        EXIT_ERROR(AGENT_ERROR_INVALID_INDEX,\"bad EventIndex\");\n+    jdwpEvent event = 0;\n+    if (ei >= EI_min || ei >= EI_max) {\n+        event = index2jdwp[ei - EI_min];\n@@ -1985,1 +1986,4 @@\n-    return index2jdwp[i-EI_min];\n+    if (event == 0) {\n+        EXIT_ERROR(AGENT_ERROR_INVALID_INDEX, \"bad EventIndex\");\n+    }\n+    return event;\n@@ -1989,1 +1993,1 @@\n-eventIndex2jvmti(EventIndex i)\n+eventIndex2jvmti(EventIndex ei)\n@@ -1991,2 +1995,6 @@\n-    if ( i < EI_min || i > EI_max ) {\n-        EXIT_ERROR(AGENT_ERROR_INVALID_INDEX,\"bad EventIndex\");\n+    jvmtiEvent event = 0;\n+    if (ei >= EI_min || ei >= EI_max) {\n+        event = index2jvmti[ei - EI_min];\n+    }\n+    if (event == 0) {\n+        EXIT_ERROR(AGENT_ERROR_INVALID_INDEX, \"bad EventIndex\");\n@@ -1994,1 +2002,1 @@\n-    return index2jvmti[i-EI_min];\n+    return event;\n@@ -2017,2 +2025,2 @@\n-        case EI_GC_FINISH:\n-            return \"EI_GC_FINISH\";\n+        case EI_CLASS_UNLOAD:\n+            return \"EI_CLASS_UNLOAD\";\n@@ -2074,1 +2082,1 @@\n-            return EI_GC_FINISH;\n+            return EI_CLASS_UNLOAD;\n@@ -2130,2 +2138,0 @@\n-        case JVMTI_EVENT_GARBAGE_COLLECTION_FINISH:\n-            return EI_GC_FINISH;\n","filename":"src\/jdk.jdwp.agent\/share\/native\/libjdwp\/util.c","additions":21,"deletions":15,"binary":false,"changes":36,"status":"modified"},{"patch":"@@ -163,1 +163,1 @@\n-        EI_GC_FINISH            =  8,\n+        EI_CLASS_UNLOAD         =  8,\n","filename":"src\/jdk.jdwp.agent\/share\/native\/libjdwp\/util.h","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}