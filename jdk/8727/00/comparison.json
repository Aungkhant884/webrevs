{"files":[{"patch":"@@ -33,0 +33,1 @@\n+#include \"jfr\/support\/jfrThreadLocal.hpp\"\n@@ -250,3 +251,3 @@\n-static void prepare_dcmd_string_arena() {\n-  if (dcmd_arena == NULL) {\n-    dcmd_arena = new (mtTracing) Arena(mtTracing);\n+static void prepare_dcmd_string_arena(JavaThread* jt) {\n+  if (dcmd_arena == nullptr) {\n+    dcmd_arena = JfrThreadLocal::dcmd_arena(jt);\n@@ -263,1 +264,1 @@\n-static const char* get_as_dcmd_arena_string(oop string, JavaThread* t) {\n+static const char* get_as_dcmd_arena_string(oop string) {\n@@ -284,1 +285,1 @@\n-  return string_oop != NULL ? get_as_dcmd_arena_string(string_oop, (JavaThread*)THREAD) : NULL;\n+  return string_oop != NULL ? get_as_dcmd_arena_string(string_oop) : NULL;\n@@ -333,1 +334,1 @@\n-  prepare_dcmd_string_arena();\n+  prepare_dcmd_string_arena(thread);\n","filename":"src\/hotspot\/share\/jfr\/dcmd\/jfrDcmds.cpp","additions":7,"deletions":6,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -42,0 +42,1 @@\n+#include \"memory\/arena.hpp\"\n@@ -58,0 +59,1 @@\n+  _dcmd_arena(nullptr),\n@@ -177,0 +179,4 @@\n+  if (_dcmd_arena != nullptr) {\n+    delete _dcmd_arena;\n+    _dcmd_arena = nullptr;\n+  }\n@@ -465,0 +471,12 @@\n+\n+Arena* JfrThreadLocal::dcmd_arena(JavaThread* jt) {\n+  assert(jt != nullptr, \"invariant\");\n+  JfrThreadLocal* tl = jt->jfr_thread_local();\n+  Arena* arena = tl->_dcmd_arena;\n+  if (arena != nullptr) {\n+    return arena;\n+  }\n+  arena = new (mtTracing) Arena(mtTracing);\n+  tl->_dcmd_arena = arena;\n+  return arena;\n+}\n","filename":"src\/hotspot\/share\/jfr\/support\/jfrThreadLocal.cpp","additions":18,"deletions":0,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -31,0 +31,1 @@\n+class Arena;\n@@ -51,0 +52,1 @@\n+  Arena* _dcmd_arena;\n@@ -246,0 +248,2 @@\n+  static Arena* dcmd_arena(JavaThread* jt);\n+\n","filename":"src\/hotspot\/share\/jfr\/support\/jfrThreadLocal.hpp","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"}]}