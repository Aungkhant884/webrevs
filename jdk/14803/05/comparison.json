{"files":[{"patch":"@@ -45,3 +45,0 @@\n-\/\/--------------------------------------------------------------------------------------\n-\/\/ ChunkPool implementation\n-\n@@ -51,3 +48,0 @@\n-  Chunk*       _first;        \/\/ first cached Chunk; its first word points to next chunk\n-  const size_t _size;         \/\/ (inner payload) size of the chunks this pool serves\n-\n@@ -58,2 +52,2 @@\n- public:\n-  ChunkPool(size_t size) : _first(nullptr), _size(size) {}\n+  Chunk*       _first;\n+  const size_t _size;         \/\/ (inner payload) size of the chunks this pool serves\n@@ -61,2 +55,2 @@\n-  \/\/ Allocate a chunk from the pool; returns null if pool is empty.\n-  Chunk* allocate() {\n+  \/\/ Returns null if pool is empty.\n+  Chunk* take_from_pool() {\n@@ -70,3 +64,1 @@\n-\n-  \/\/ Return a chunk to the pool\n-  void free(Chunk* chunk) {\n+  void return_to_pool(Chunk* chunk) {\n@@ -79,1 +71,0 @@\n-  \/\/ Prune the pool\n@@ -94,6 +85,0 @@\n-  static void clean() {\n-    for (int i = 0; i < _num_pools; i++) {\n-      _pools[i].prune();\n-    }\n-  }\n-\n@@ -110,7 +95,2 @@\n-};\n-\n-ChunkPool ChunkPool::_pools[] = { Chunk::size, Chunk::medium_size, Chunk::init_size, Chunk::tiny_size };\n-\n-\/\/--------------------------------------------------------------------------------------\n-\/\/ ChunkPoolCleaner implementation\n-\/\/\n+public:\n+  ChunkPool(size_t size) : _first(nullptr), _size(size) {}\n@@ -118,2 +98,5 @@\n-class ChunkPoolCleaner : public PeriodicTask {\n-  static const int cleaning_interval = 5000; \/\/ cleaning interval in ms\n+  static void clean()  {\n+    for (int i = 0; i < _num_pools; i++) {\n+      _pools[i].prune();\n+    }\n+  }\n@@ -121,5 +104,2 @@\n- public:\n-   ChunkPoolCleaner() : PeriodicTask(cleaning_interval) {}\n-   void task() {\n-     ChunkPool::clean();\n-   }\n+  static Chunk* allocate_chunk(size_t length, AllocFailType alloc_failmode);\n+  static void deallocate_chunk(Chunk* p);\n@@ -128,4 +108,1 @@\n-\/\/--------------------------------------------------------------------------------------\n-\/\/ Chunk implementation\n-\n-void* Chunk::operator new (size_t sizeofChunk, AllocFailType alloc_failmode, size_t length) throw() {\n+Chunk* ChunkPool::allocate_chunk(size_t length, AllocFailType alloc_failmode) {\n@@ -150,1 +127,0 @@\n-  assert(sizeofChunk == sizeof(Chunk), \"weird request size\");\n@@ -156,1 +132,1 @@\n-    Chunk* c = pool->allocate();\n+    Chunk* c = pool->take_from_pool();\n@@ -163,1 +139,1 @@\n-  size_t bytes = ARENA_ALIGN(sizeofChunk) + length;\n+  size_t bytes = ARENA_ALIGN(sizeof(Chunk)) + length;\n@@ -168,0 +144,1 @@\n+  Chunk* chunk = ::new(p) Chunk(length);\n@@ -170,1 +147,1 @@\n-  return p;\n+  return chunk;\n@@ -173,1 +150,1 @@\n-void Chunk::operator delete(void* p) {\n+void ChunkPool::deallocate_chunk(Chunk* p) {\n@@ -178,1 +155,1 @@\n-    pool->free(c);\n+    pool->return_to_pool(c);\n@@ -185,3 +162,1 @@\n-Chunk::Chunk(size_t length) : _len(length) {\n-  _next = nullptr;         \/\/ Chain on the linked list\n-}\n+ChunkPool ChunkPool::_pools[] = { Chunk::size, Chunk::medium_size, Chunk::init_size, Chunk::tiny_size };\n@@ -189,10 +164,2 @@\n-void Chunk::chop() {\n-  Chunk *k = this;\n-  while( k ) {\n-    Chunk *tmp = k->next();\n-    \/\/ clear out this chunk (to detect allocation bugs)\n-    if (ZapResourceArea) memset(k->bottom(), badResourceValue, k->length());\n-    delete k;                   \/\/ Free chunk (was malloc'd)\n-    k = tmp;\n-  }\n-}\n+class ChunkPoolCleaner : public PeriodicTask {\n+  static const int cleaning_interval = 5000; \/\/ cleaning interval in ms\n@@ -200,4 +167,6 @@\n-void Chunk::next_chop() {\n-  _next->chop();\n-  _next = nullptr;\n-}\n+ public:\n+   ChunkPoolCleaner() : PeriodicTask(cleaning_interval) {}\n+   void task() {\n+     ChunkPool::clean();\n+   }\n+};\n@@ -205,1 +174,1 @@\n-void Chunk::start_chunk_pool_cleaner_task() {\n+void Arena::start_chunk_pool_cleaner_task() {\n@@ -215,1 +184,19 @@\n-\/\/------------------------------Arena------------------------------------------\n+Chunk::Chunk(size_t length) : _len(length) {\n+  _next = nullptr;         \/\/ Chain on the linked list\n+}\n+\n+void Chunk::chop(Chunk* k) {\n+  while (k != nullptr) {\n+    Chunk *tmp = k->next();\n+    \/\/ clear out this chunk (to detect allocation bugs)\n+    if (ZapResourceArea) memset(k->bottom(), badResourceValue, k->length());\n+    ChunkPool::deallocate_chunk(k);\n+    k = tmp;\n+  }\n+}\n+\n+void Chunk::next_chop(Chunk* k) {\n+  assert(k != nullptr && k->_next != nullptr, \"must be non-null\");\n+  Chunk::chop(k->_next);\n+  k->_next = nullptr;\n+}\n@@ -219,1 +206,1 @@\n-  _first = _chunk = new (AllocFailStrategy::EXIT_OOM, init_size) Chunk(init_size);\n+  _first = _chunk = ChunkPool::allocate_chunk(init_size, AllocFailStrategy::EXIT_OOM);\n@@ -227,1 +214,1 @@\n-  _first = _chunk = new (AllocFailStrategy::EXIT_OOM, Chunk::init_size) Chunk(Chunk::init_size);\n+  _first = _chunk = ChunkPool::allocate_chunk(Chunk::init_size, AllocFailStrategy::EXIT_OOM);\n@@ -245,1 +232,1 @@\n-    _first->chop();\n+    Chunk::chop(_first);\n@@ -282,1 +269,1 @@\n-  _chunk = new (alloc_failmode, len) Chunk(len);\n+  _chunk = ChunkPool::allocate_chunk(len, alloc_failmode);\n","filename":"src\/hotspot\/share\/memory\/arena.cpp","additions":54,"deletions":67,"binary":false,"changes":121,"status":"modified"},{"patch":"@@ -40,1 +40,1 @@\n-\/\/------------------------------Chunk------------------------------------------\n+\n@@ -42,1 +42,1 @@\n-class Chunk: CHeapObj<mtChunk> {\n+class Chunk {\n@@ -48,2 +48,0 @@\n-  void* operator new(size_t size, AllocFailType alloc_failmode, size_t length) throw();\n-  void  operator delete(void* p);\n@@ -70,2 +68,2 @@\n-  void chop();                  \/\/ Chop this chunk\n-  void next_chop();             \/\/ Chop next chunk\n+  static void chop(Chunk* chunk);                  \/\/ Chop this chunk\n+  static void next_chop(Chunk* chunk);             \/\/ Chop next chunk\n@@ -82,3 +80,0 @@\n-\n-  \/\/ Start the chunk_pool cleaner task\n-  static void start_chunk_pool_cleaner_task();\n@@ -87,1 +82,0 @@\n-\/\/------------------------------Arena------------------------------------------\n@@ -97,3 +91,4 @@\n-  Chunk *_first;                \/\/ First chunk\n-  Chunk *_chunk;                \/\/ current chunk\n-  char *_hwm, *_max;            \/\/ High water mark and max in current chunk\n+  Chunk* _first;                \/\/ First chunk\n+  Chunk* _chunk;                \/\/ current chunk\n+  char* _hwm;                   \/\/ High water mark\n+  char* _max;                   \/\/ and max in current chunk\n@@ -116,0 +111,3 @@\n+  \/\/ Start the chunk_pool cleaner task\n+  static void start_chunk_pool_cleaner_task();\n+\n","filename":"src\/hotspot\/share\/memory\/arena.hpp","additions":11,"deletions":13,"binary":false,"changes":24,"status":"modified"},{"patch":"@@ -115,1 +115,1 @@\n-      state._chunk->next_chop();\n+      Chunk::next_chop(state._chunk);\n","filename":"src\/hotspot\/share\/memory\/resourceArea.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -165,1 +165,1 @@\n-  _chunk->next_chop();\n+  Chunk::next_chop(_chunk);\n","filename":"src\/hotspot\/share\/runtime\/handles.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -682,1 +682,1 @@\n-  Chunk::start_chunk_pool_cleaner_task();\n+  Arena::start_chunk_pool_cleaner_task();\n","filename":"src\/hotspot\/share\/runtime\/threads.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}