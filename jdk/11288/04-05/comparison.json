{"files":[{"patch":"@@ -188,2 +188,2 @@\n-\/\/      checking to see if the object has been tagged, untagged, or the\n-\/\/      tag value has changed.\n+\/\/ checking to see if the object has been tagged, untagged, or the\n+\/\/ tag value has changed.\n@@ -232,1 +232,1 @@\n-    post_callback_tag_update(_o, _hashmap,  _obj_tag);\n+    post_callback_tag_update(_o, _hashmap, _obj_tag);\n@@ -241,2 +241,0 @@\n-\n-\n@@ -244,1 +242,0 @@\n-\n@@ -249,1 +246,1 @@\n-  if (current_tag == 0 ) {\n+  if (current_tag == 0) {\n@@ -261,1 +258,1 @@\n-      if (obj_tag != current_tag ) {\n+      if (obj_tag != current_tag) {\n@@ -288,1 +285,0 @@\n-\n@@ -353,1 +349,1 @@\n-  \/\/see if the object is already tagged\n+  \/\/ see if the object is already tagged\n@@ -371,1 +367,1 @@\n-        hashmap->update(o, tag);\n+      hashmap->update(o, tag);\n@@ -1266,1 +1262,1 @@\n-  bool do_entry(JvmtiTagMapKey& key , jlong& value ) {\n+  bool do_entry(JvmtiTagMapKey& key, jlong& value) {\n","filename":"src\/hotspot\/share\/prims\/jvmtiTagMap.cpp","additions":8,"deletions":12,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -35,1 +35,0 @@\n-#include \"prims\/jvmtiExport.hpp\"\n@@ -37,0 +36,1 @@\n+#include \"prims\/jvmtiExport.hpp\"\n@@ -61,0 +61,20 @@\n+JvmtiTagMapKey::JvmtiTagMapKey(oop obj) : _obj(obj) {}\n+\n+JvmtiTagMapKey::JvmtiTagMapKey(const JvmtiTagMapKey& src) {\n+  \/\/ move object into WeakHandle when copying into the table\n+  assert(src._obj != nullptr, \"must be set\");\n+  _wh = WeakHandle(JvmtiExport::weak_tag_storage(), src._obj);\n+  _obj = nullptr;\n+}\n+\n+JvmtiTagMapKey::~JvmtiTagMapKey() {\n+  \/\/ If obj is set null it out, this is called for stack object on lookup,\n+  \/\/ and it should not have a WeakHandle created for it yet.\n+  if (_obj != nullptr) {\n+    _obj = nullptr;\n+    assert(_wh.is_null(), \"WeakHandle should be null\");\n+  } else {\n+    _wh.release(JvmtiExport::weak_tag_storage());\n+  }\n+}\n+\n@@ -71,3 +91,1 @@\n-JvmtiTagMapTable::JvmtiTagMapTable()\n-  :_table(Constants::_table_size) {\n-}\n+JvmtiTagMapTable::JvmtiTagMapTable() : _table(Constants::_table_size) {}\n@@ -77,2 +95,1 @@\n-    bool do_entry(JvmtiTagMapKey& entry, jlong const& tag)\n-    {\n+    bool do_entry(const JvmtiTagMapKey& entry, const jlong& tag) {\n@@ -81,2 +98,2 @@\n-  } RemoveAll;\n-  _table.unlink(&RemoveAll);\n+  } remove_all;\n+  _table.unlink(&remove_all);\n@@ -92,1 +109,1 @@\n-   if (is_empty()) {\n+  if (is_empty()) {\n@@ -94,2 +111,3 @@\n-   }\n-   if (obj->fast_no_hash_check()) {\n+  }\n+\n+  if (obj->fast_no_hash_check()) {\n@@ -97,5 +115,5 @@\n-   } else {\n-     JvmtiTagMapKey jtme(obj);\n-     jlong* found = _table.get(jtme);\n-     return found == NULL ? 0 : *found;\n-   }\n+  }\n+\n+  JvmtiTagMapKey jtme(obj);\n+  jlong* found = _table.get(jtme);\n+  return found == NULL ? 0 : *found;\n@@ -136,1 +154,1 @@\n-    bool do_entry(JvmtiTagMapKey const& entry, jlong tag) {\n+    bool do_entry(const JvmtiTagMapKey& entry, jlong tag) {\n@@ -138,1 +156,1 @@\n-        if (_objects!=NULL) {\n+        if (_objects != NULL) {\n@@ -145,2 +163,2 @@\n-  } IsDead(objects);\n-  _table.unlink(&IsDead);\n+  } is_dead(objects);\n+  _table.unlink(&is_dead);\n","filename":"src\/hotspot\/share\/prims\/jvmtiTagMapTable.cpp","additions":38,"deletions":20,"binary":false,"changes":58,"status":"modified"},{"patch":"@@ -50,1 +50,1 @@\n-  JvmtiTagMapKey& operator=(JvmtiTagMapKey const&) = delete;\n+  JvmtiTagMapKey& operator=(const JvmtiTagMapKey&) = delete;\n@@ -58,1 +58,1 @@\n-  static unsigned get_hash(JvmtiTagMapKey const &entry)  {\n+  static unsigned get_hash(const JvmtiTagMapKey& entry) {\n@@ -63,1 +63,1 @@\n-  static bool equals(JvmtiTagMapKey const & lhs, JvmtiTagMapKey const & rhs) {\n+  static bool equals(const JvmtiTagMapKey& lhs, const JvmtiTagMapKey& rhs) {\n@@ -108,1 +108,1 @@\n-  virtual bool do_entry(JvmtiTagMapKey& key , jlong& value) = 0;\n+  virtual bool do_entry(JvmtiTagMapKey& key, jlong& value) = 0;\n","filename":"src\/hotspot\/share\/prims\/jvmtiTagMapTable.hpp","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"}]}