{"files":[{"patch":"@@ -50,5 +50,0 @@\n-\/\/ Reserve space for a flush token, so 'push_flush_token' always succeeds.\n-AsyncLogWriter::Buffer::Buffer(size_t capacity) : _pos(0), _capacity(capacity) {\n-  _buf = NEW_C_HEAP_ARRAY(char, capacity, mtLogging);\n-}\n-\n@@ -238,1 +233,11 @@\n-size_t AsyncLogWriter::throttle_buffers(size_t newsize) {\n+AsyncLogWriter::BufferUpdater::BufferUpdater(size_t newsize) {\n+  AsyncLogLocker locker;\n+  auto p = AsyncLogWriter::_instance;\n+\n+  _buf1 = p->_buffer;\n+  _buf2 = p->_buffer_staging;\n+  p->_buffer = new Buffer(newsize);\n+  p->_buffer_staging = new Buffer(newsize);\n+}\n+\n+AsyncLogWriter::BufferUpdater::~BufferUpdater() {\n@@ -240,0 +245,1 @@\n+  auto p = AsyncLogWriter::_instance;\n@@ -241,3 +247,4 @@\n-  size_t oldsize = _buffer->set_capacity(newsize);\n-  _buffer_staging->set_capacity(newsize);\n-  return oldsize;\n+  delete p->_buffer;\n+  delete p->_buffer_staging;\n+  p->_buffer = _buf1;\n+  p->_buffer_staging = _buf2;\n","filename":"src\/hotspot\/share\/logging\/logAsyncWriter.cpp","additions":16,"deletions":9,"binary":false,"changes":25,"status":"modified"},{"patch":"@@ -110,1 +110,1 @@\n-    size_t _capacity;\n+    const size_t _capacity;\n@@ -113,1 +113,8 @@\n-    Buffer(size_t capacity);\n+    Buffer(size_t capacity) :  _pos(0), _capacity(capacity) {\n+      _buf = NEW_C_HEAP_ARRAY(char, capacity, mtLogging);\n+      assert(capacity >= Message::calc_size(0), \"capcity must be great a token size\");\n+    }\n+\n+    ~Buffer() {\n+      FREE_C_HEAP_ARRAY(char, _buf);\n+    }\n@@ -118,7 +125,0 @@\n-    \/\/ for testing-only!\n-    size_t set_capacity(size_t value) {\n-      size_t old = _capacity;\n-      _capacity = value;\n-      return old;\n-    }\n-\n@@ -182,1 +182,8 @@\n-  size_t throttle_buffers(size_t newsize);\n+  class BufferUpdater {\n+    Buffer* _buf1;\n+    Buffer* _buf2;\n+\n+   public:\n+    BufferUpdater(size_t newsize);\n+    ~BufferUpdater();\n+  };\n","filename":"src\/hotspot\/share\/logging\/logAsyncWriter.hpp","additions":17,"deletions":10,"binary":false,"changes":27,"status":"modified"},{"patch":"@@ -78,1 +78,1 @@\n-      size_t saved = writer->throttle_buffers(1024\/*bytes*\/);\n+      AsyncLogWriter::BufferUpdater saver(1024);\n@@ -86,1 +86,0 @@\n-      writer->throttle_buffers(saved);\n","filename":"test\/hotspot\/gtest\/logging\/test_asynclog.cpp","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"}]}