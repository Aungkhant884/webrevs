{"files":[{"patch":"@@ -2386,5 +2386,0 @@\n-  intx tty_token = -1;\n-  if (log) {\n-    tty_token = ttyLocker::hold_tty();\n-    tty->print_cr(\"[WhiteBox::VerifyFrames] Walking Frames\");\n-  }\n@@ -2392,0 +2387,1 @@\n+  stringStream st;\n@@ -2395,1 +2391,1 @@\n-      current_frame->print_value();\n+      current_frame->print_value_on(&st, NULL);\n@@ -2400,0 +2396,2 @@\n+    tty->print_cr(\"[WhiteBox::VerifyFrames] Walking Frames\");\n+    tty->print_raw(st.as_string());\n@@ -2401,1 +2399,0 @@\n-    ttyLocker::release_tty(tty_token);\n","filename":"src\/hotspot\/share\/prims\/whitebox.cpp","additions":4,"deletions":7,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -146,4 +146,5 @@\n-  ttyLocker ttyl;\n-  tty->print_cr(\"UnrollBlock\");\n-  tty->print_cr(\"  size_of_deoptimized_frame = %d\", _size_of_deoptimized_frame);\n-  tty->print(   \"  frame_sizes: \");\n+  ResourceMark rm;\n+  stringStream st;\n+  st.print_cr(\"UnrollBlock\");\n+  st.print_cr(\"  size_of_deoptimized_frame = %d\", _size_of_deoptimized_frame);\n+  st.print(   \"  frame_sizes: \");\n@@ -151,1 +152,1 @@\n-    tty->print(INTX_FORMAT \" \", frame_sizes()[index]);\n+    st.print(INTX_FORMAT \" \", frame_sizes()[index]);\n@@ -153,1 +154,2 @@\n-  tty->cr();\n+  st.cr();\n+  tty->print_raw(st.as_string());\n@@ -182,0 +184,32 @@\n+#ifndef PRODUCT\n+\/\/ print information about reallocated objects\n+static void print_objects(JavaThread* deoptee_thread,\n+                          GrowableArray<ScopeValue*>* objects, bool realloc_failures) {\n+  ResourceMark rm;\n+  stringStream st;  \/\/ change to logStream with logging\n+  st.print_cr(\"REALLOC OBJECTS in thread \" INTPTR_FORMAT, p2i(deoptee_thread));\n+  fieldDescriptor fd;\n+\n+  for (int i = 0; i < objects->length(); i++) {\n+    ObjectValue* sv = (ObjectValue*) objects->at(i);\n+    Klass* k = java_lang_Class::as_Klass(sv->klass()->as_ConstantOopReadValue()->value()());\n+    Handle obj = sv->value();\n+\n+    st.print(\"     object <\" INTPTR_FORMAT \"> of type \", p2i(sv->value()()));\n+    k->print_value_on(&st);\n+    assert(obj.not_null() || realloc_failures, \"reallocation was missed\");\n+    if (obj.is_null()) {\n+      st.print(\" allocation failed\");\n+    } else {\n+      st.print(\" allocated (%d bytes)\", obj->size() * HeapWordSize);\n+    }\n+    st.cr();\n+\n+    if (Verbose && !obj.is_null()) {\n+      k->oop_print_on(obj(), &st);\n+    }\n+  }\n+  tty->print_raw(st.as_string());\n+}\n+#endif\n+\n@@ -213,1 +247,0 @@\n-      ttyLocker ttyl;\n@@ -234,3 +267,1 @@\n-      ttyLocker ttyl;\n-      tty->print_cr(\"REALLOC OBJECTS in thread \" INTPTR_FORMAT, p2i(deoptee_thread));\n-      Deoptimization::print_objects(objects, realloc_failures);\n+      print_objects(deoptee_thread, objects, realloc_failures);\n@@ -266,1 +297,2 @@\n-        ttyLocker ttyl;\n+        ResourceMark rm;\n+        stringStream st;\n@@ -272,1 +304,1 @@\n-              tty->print_cr(\"RELOCK OBJECTS in thread \" INTPTR_FORMAT, p2i(thread));\n+              st.print_cr(\"RELOCK OBJECTS in thread \" INTPTR_FORMAT, p2i(thread));\n@@ -277,1 +309,1 @@\n-                tty->print_cr(\"     object <\" INTPTR_FORMAT \"> DEFERRED relocking after wait\", p2i(mi->owner()));\n+                st.print_cr(\"     object <\" INTPTR_FORMAT \"> DEFERRED relocking after wait\", p2i(mi->owner()));\n@@ -283,1 +315,1 @@\n-              tty->print_cr(\"     failed reallocation for klass %s\", k->external_name());\n+              st.print_cr(\"     failed reallocation for klass %s\", k->external_name());\n@@ -285,1 +317,1 @@\n-              tty->print_cr(\"     object <\" INTPTR_FORMAT \"> locked\", p2i(mi->owner()));\n+              st.print_cr(\"     object <\" INTPTR_FORMAT \"> locked\", p2i(mi->owner()));\n@@ -289,0 +321,1 @@\n+        tty->print_raw(st.as_string());\n@@ -607,1 +640,0 @@\n-      ttyLocker ttyl;\n@@ -701,1 +733,0 @@\n-    ttyLocker ttyl;\n@@ -823,2 +854,0 @@\n-          ttyLocker ttyl;\n-\n@@ -845,1 +874,1 @@\n-        } \/\/ release tty lock before calling guarantee\n+        }\n@@ -1464,28 +1493,0 @@\n-\n-\n-#ifndef PRODUCT\n-\/\/ print information about reallocated objects\n-void Deoptimization::print_objects(GrowableArray<ScopeValue*>* objects, bool realloc_failures) {\n-  fieldDescriptor fd;\n-\n-  for (int i = 0; i < objects->length(); i++) {\n-    ObjectValue* sv = (ObjectValue*) objects->at(i);\n-    Klass* k = java_lang_Class::as_Klass(sv->klass()->as_ConstantOopReadValue()->value()());\n-    Handle obj = sv->value();\n-\n-    tty->print(\"     object <\" INTPTR_FORMAT \"> of type \", p2i(sv->value()()));\n-    k->print_value();\n-    assert(obj.not_null() || realloc_failures, \"reallocation was missed\");\n-    if (obj.is_null()) {\n-      tty->print(\" allocation failed\");\n-    } else {\n-      tty->print(\" allocated (%d bytes)\", obj->size() * HeapWordSize);\n-    }\n-    tty->cr();\n-\n-    if (Verbose && !obj.is_null()) {\n-      k->oop_print_on(obj(), tty);\n-    }\n-  }\n-}\n-#endif\n@@ -1499,4 +1500,5 @@\n-    ttyLocker ttyl;\n-    tty->print(\"DEOPT PACKING thread \" INTPTR_FORMAT \" \", p2i(thread));\n-    fr.print_on(tty);\n-    tty->print_cr(\"     Virtual frames (innermost first):\");\n+    ResourceMark rm;\n+    stringStream st;\n+    st.print(\"DEOPT PACKING thread \" INTPTR_FORMAT \" \", p2i(thread));\n+    fr.print_on(&st);\n+    st.print_cr(\"     Virtual frames (innermost first):\");\n@@ -1505,2 +1507,2 @@\n-      tty->print(\"       %2d - \", index);\n-      vf->print_value();\n+      st.print(\"       %2d - \", index);\n+      vf->print_value_on(&st);\n@@ -1515,2 +1517,2 @@\n-      tty->print(\" - %s\", code_name);\n-      tty->print_cr(\" @ bci %d \", bci);\n+      st.print(\" - %s\", code_name);\n+      st.print_cr(\" @ bci %d \", bci);\n@@ -1518,2 +1520,2 @@\n-        vf->print();\n-        tty->cr();\n+        vf->print_on(&st);\n+        st.cr();\n@@ -1522,0 +1524,1 @@\n+    tty->print_raw(st.as_string());\n@@ -1544,1 +1547,0 @@\n-    ttyLocker ttyl;\n@@ -1852,1 +1854,0 @@\n-      ttyLocker ttyl;\n","filename":"src\/hotspot\/share\/runtime\/deoptimization.cpp","additions":61,"deletions":60,"binary":false,"changes":121,"status":"modified"},{"patch":"@@ -185,1 +185,0 @@\n-  NOT_PRODUCT(static void print_objects(GrowableArray<ScopeValue*>* objects, bool realloc_failures);)\n","filename":"src\/hotspot\/share\/runtime\/deoptimization.hpp","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -48,1 +48,2 @@\n-       service        = event          +   3,\n+       tty            = event          +   3,\n+       service        = tty            +   3,\n@@ -50,2 +51,1 @@\n-       tty            = stackwatermark +   3,\n-       special        = tty            +   3,\n+       special        = stackwatermark +   3,\n","filename":"src\/hotspot\/share\/runtime\/mutex.hpp","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2014, 2018, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2014, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -36,0 +36,12 @@\n+\/*\n+ * @test\n+ * @bug 8273456\n+ * @summary Test that ttyLock isn't held when taking StackWatermark_lock\n+ * @requires !vm.graal.enabled & vm.gc.Z\n+ * @run main\/othervm -XX:-BackgroundCompilation -Xmx128M -XX:+IgnoreUnrecognizedVMOptions -XX:+VerifyStack\n+ *      -XX:CompileCommand=exclude,compiler.uncommontrap.TestDeoptOOM::main\n+ *      -XX:CompileCommand=exclude,compiler.uncommontrap.TestDeoptOOM::m9_1\n+ *      -XX:+UseZGC -XX:+LogCompilation -XX:+PrintDeoptimizationDetails -XX:+TraceDeoptimization -XX:+Verbose\n+ *      compiler.uncommontrap.TestDeoptOOM\n+ *\/\n+\n","filename":"test\/hotspot\/jtreg\/compiler\/uncommontrap\/TestDeoptOOM.java","additions":13,"deletions":1,"binary":false,"changes":14,"status":"modified"}]}