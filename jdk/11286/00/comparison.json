{"files":[{"patch":"@@ -319,4 +319,4 @@\n-      jlong buffer = (jlong) NEW_RESOURCE_ARRAY_IN_THREAD(THREAD, jbyte, buffer_size);\n-      int res = encode(THREAD, runtimeKlass, buffer, buffer_size);\n-      if ((_from_env != nullptr && _from_env->has_pending_exception()) || HAS_PENDING_EXCEPTION) {\n-        JVMCIRuntime::fatal_exception(_from_env, \"HotSpotJVMCIRuntime.encodeThrowable should not throw an exception\");\n+      jlong buffer = (jlong) NEW_RESOURCE_ARRAY_IN_THREAD_RETURN_NULL(THREAD, jbyte, buffer_size);\n+      if (buffer == 0L) {\n+        decode(THREAD, runtimeKlass, 0L);\n+        return;\n@@ -324,1 +324,10 @@\n-      if (res < 0) {\n+      int res = encode(THREAD, runtimeKlass, buffer, buffer_size);\n+      if (_from_env != nullptr && _from_env->has_pending_exception()) {\n+        _from_env->clear_pending_exception();\n+        decode(THREAD, runtimeKlass, 0L);\n+        return;\n+      } else if (HAS_PENDING_EXCEPTION) {\n+        CLEAR_PENDING_EXCEPTION;\n+        decode(THREAD, runtimeKlass, 0L);\n+        return;\n+      } else if (res < 0) {\n@@ -332,1 +341,1 @@\n-          JVMCIRuntime::fatal_exception(_to_env, \"HotSpotJVMCIRuntime.decodeAndThrowThrowable should throw an exception\");\n+          _to_env->throw_InternalError(\"HotSpotJVMCIRuntime.decodeAndThrowThrowable should have thrown an exception\");\n","filename":"src\/hotspot\/share\/jvmci\/jvmciEnv.cpp","additions":15,"deletions":6,"binary":false,"changes":21,"status":"modified"},{"patch":"@@ -210,1 +210,3 @@\n-     * Decodes the exception encoded in {@code buffer} and throws it.\n+     * Decodes the exception encoded in {@code buffer} and throws it. If {@code buffer == 0} then\n+     * something went wrong (e.g. OutOfMemoryError) while encoding the exception. In this case, an\n+     * {@link InternalError} is thrown.\n@@ -217,0 +219,5 @@\n+        if (buffer == 0L) {\n+            throw new InternalError(String.format(\"unexpected problem occurred while encoding an exception to translate it from %s to %s\",\n+                            IS_IN_NATIVE_IMAGE ? \"HotSpot\" : \"libjvmci\",\n+                            IS_IN_NATIVE_IMAGE ? \"libjvmci\" : \"HotSpot\"));\n+        }\n","filename":"src\/jdk.internal.vm.ci\/share\/classes\/jdk.vm.ci.hotspot\/src\/jdk\/vm\/ci\/hotspot\/HotSpotJVMCIRuntime.java","additions":8,"deletions":1,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -152,1 +152,0 @@\n-    @VMEntryPoint\n@@ -226,1 +225,0 @@\n-    @VMEntryPoint\n","filename":"src\/jdk.internal.vm.ci\/share\/classes\/jdk.vm.ci.hotspot\/src\/jdk\/vm\/ci\/hotspot\/TranslatedException.java","additions":0,"deletions":2,"binary":false,"changes":2,"status":"modified"}]}