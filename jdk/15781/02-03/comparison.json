{"files":[{"patch":"@@ -2900,8 +2900,0 @@\n-static void warn_fail_pretouch_memory(void* first, void* last, size_t page_size,\n-                                      int err) {\n-  warning(\"INFO: os::pd_pretouch_memory(\" PTR_FORMAT \", \" PTR_FORMAT \", \"\n-          SIZE_FORMAT \") failed; error='%s' (errno=%d)\",\n-          p2i(first), p2i(last), page_size,\n-          os::strerror(err), err);\n-}\n-\n@@ -2910,12 +2902,16 @@\n-  \/\/ Use madvise to pretouch on Linux first, and fallback to the common method\n-  \/\/ if unsupported. THP can form right after madvise rather than being\n-  \/\/ assembled later.\n-  if (::madvise(first, len, MADV_POPULATE_WRITE) == -1) {\n-    int err = errno;\n-    if (err == EINVAL) { \/\/ Not supported\n-      \/\/ When using THP we need to always pre-touch using small pages as the OS\n-      \/\/ will initially always use small pages.\n-      page_size = UseTransparentHugePages ? (size_t)os::vm_page_size() : page_size;\n-      pretouch_memory_common(first, last, page_size);\n-    } else {\n-      warn_fail_pretouch_memory(first, last, page_size, err);\n+  \/\/ Use madvise to pretouch on Linux when THP is used, and fallback to the\n+  \/\/ common method if unsupported. THP can form right after madvise rather than\n+  \/\/ being assembled later.\n+  if (HugePages::thp_mode() == THPMode::always || UseTransparentHugePages) {\n+    if (::madvise(first, len, MADV_POPULATE_WRITE) == -1) {\n+      int err = errno;\n+      if (err == EINVAL) { \/\/ Not supported\n+\t\/\/ When using THP we need to always pre-touch using small pages as the\n+\t\/\/ OS will initially always use small pages.\n+\tpretouch_memory_common(first, last, os::vm_page_size());\n+      } else {\n+\tlog_warning(gc, os)(\"::madvise(\" PTR_FORMAT \", \" SIZE_FORMAT\n+\t\t\t    \", %d) failed; error='%s' (errno=%d)\",\n+\t\t\t    p2i(first), len, MADV_POPULATE_WRITE,\n+\t\t\t    os::strerror(err), err);\n+      }\n@@ -2923,0 +2919,2 @@\n+  } else {\n+    pretouch_memory_common(first, last, page_size);\n","filename":"src\/hotspot\/os\/linux\/os_linux.cpp","additions":18,"deletions":20,"binary":false,"changes":38,"status":"modified"}]}