{"files":[{"patch":"@@ -2193,1 +2193,1 @@\n-static void print_glibc_malloc_tunables(outputStream* st) {\n+void os::Linux::print_glibc_malloc_tunables(outputStream* st) {\n@@ -2258,1 +2258,1 @@\n-  print_glibc_malloc_tunables(st);\n+  os::Linux::print_glibc_malloc_tunables(st);\n@@ -4648,0 +4648,13 @@\n+  \/\/ Log also:\n+  \/\/ - LD_PRELOAD, since this is the most popular mechanism to divert libc functions\n+  \/\/ - Malloc Tunables, since those have a large effect on how the libc allocator works\n+  LogTarget(Info, os) lt;\n+  if (lt.is_enabled()) {\n+    LogStream ls(lt);\n+    const char* const v = ::getenv(\"LD_PRELOAD\");\n+    log_info(os)(\"LD_PRELOAD=%.1024s\", v ? v : \"(unset)\");\n+#ifdef __GLIBC__\n+    os::Linux::print_glibc_malloc_tunables(&ls);\n+#endif\n+  }\n+\n","filename":"src\/hotspot\/os\/linux\/os_linux.cpp","additions":15,"deletions":2,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -192,0 +192,2 @@\n+  static void print_glibc_malloc_tunables(outputStream* st);\n+\n","filename":"src\/hotspot\/os\/linux\/os_linux.hpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -27,0 +27,1 @@\n+#include \"logging\/log.hpp\"\n@@ -45,0 +46,3 @@\n+        \/\/ Also log if native trim log is active\n+        log_info(trimnative)(\"Manual Trim: \" PROPERFMT \"->\" PROPERFMT \" (%c\" PROPERFMT \")\",\n+                             PROPERFMTARGS(sc.before), PROPERFMTARGS(sc.after), sign, PROPERFMTARGS(delta));\n","filename":"src\/hotspot\/os\/linux\/trimCHeapDCmd.cpp","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -101,2 +101,0 @@\n-runtime\/os\/TestTrimNative.java#trimNative 8312525 linux-all\n-runtime\/os\/TestTrimNative.java#trimNativeLowInterval 8312525 linux-all\n","filename":"test\/hotspot\/jtreg\/ProblemList.txt","additions":0,"deletions":2,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -37,0 +37,10 @@\n+\/*\n+ * @test id=trimNativeStrict\n+ * @requires (os.family==\"linux\") & !vm.musl\n+ * @modules java.base\/jdk.internal.misc\n+ * @library \/test\/lib\n+ * @build jdk.test.whitebox.WhiteBox\n+ * @run driver jdk.test.lib.helpers.ClassFileInstaller jdk.test.whitebox.WhiteBox\n+ * @run main\/manual TestTrimNative trimNativeStrict\n+ *\/\n+\n@@ -59,0 +69,11 @@\n+\/*\n+ * @test id=trimNativeLowIntervalStrict\n+ * @summary Very low (sub-second) interval, nothing should explode (stricter test, manual mode)\n+ * @requires (os.family==\"linux\") & !vm.musl\n+ * @modules java.base\/jdk.internal.misc\n+ * @library \/test\/lib\n+ * @build jdk.test.whitebox.WhiteBox\n+ * @run driver jdk.test.lib.helpers.ClassFileInstaller jdk.test.whitebox.WhiteBox\n+ * @run main\/manual TestTrimNative trimNativeLowIntervalStrict\n+ *\/\n+\n@@ -133,0 +154,1 @@\n+        allOptions.add(\"-Xlog:os\"); \/\/ for LD_PRELOAD, glibc version, and malloc tunables\n@@ -164,0 +186,1 @@\n+     * @param strict: if true, expect RSS to go down; if false, just look for trims without looking at RSS.\n@@ -166,1 +189,1 @@\n-                                                          int maxTrimsExpected) {\n+                                                          int maxTrimsExpected, boolean strict) {\n@@ -191,1 +214,2 @@\n-        if (maxTrimsExpected > 0) {\n+        System.out.println(\"Found \" + numTrimsFound + \" trims. Ok.\");\n+        if (strict && maxTrimsExpected > 0) {\n@@ -206,0 +230,2 @@\n+            } else {\n+                System.out.println(\"Found high enough RSS reduction from trims: \" + rssReductionTotal);\n@@ -241,0 +267,2 @@\n+        boolean strictTesting = args[0].endsWith(\"Strict\");\n+\n@@ -242,1 +270,2 @@\n-            case \"trimNative\": {\n+            case \"trimNative\":\n+            case \"trimNativeStrict\": {\n@@ -256,1 +285,1 @@\n-                parseOutputAndLookForNegativeTrim(output, (int) minTrimsExpected, (int) maxTrimsExpected);\n+                parseOutputAndLookForNegativeTrim(output, (int) minTrimsExpected, (int) maxTrimsExpected, strictTesting);\n@@ -266,1 +295,1 @@\n-                parseOutputAndLookForNegativeTrim(output, 0, 0);\n+                parseOutputAndLookForNegativeTrim(output, 0, 0, strictTesting);\n@@ -269,1 +298,2 @@\n-            case \"trimNativeLowInterval\": {\n+            case \"trimNativeLowInterval\":\n+            case \"trimNativeLowIntervalStrict\": {\n@@ -275,1 +305,1 @@\n-                parseOutputAndLookForNegativeTrim(output, 1, 3000);\n+                parseOutputAndLookForNegativeTrim(output, 1, 3000, strictTesting);\n@@ -284,1 +314,1 @@\n-                parseOutputAndLookForNegativeTrim(output, 0, 0);\n+                parseOutputAndLookForNegativeTrim(output, 0, 0, strictTesting);\n@@ -295,1 +325,1 @@\n-                parseOutputAndLookForNegativeTrim(output, 0, 0);\n+                parseOutputAndLookForNegativeTrim(output, 0, 0, strictTesting);\n@@ -301,1 +331,1 @@\n-                parseOutputAndLookForNegativeTrim(output, 0, 0);\n+                parseOutputAndLookForNegativeTrim(output, 0, 0, strictTesting);\n","filename":"test\/hotspot\/jtreg\/runtime\/os\/TestTrimNative.java","additions":40,"deletions":10,"binary":false,"changes":50,"status":"modified"}]}