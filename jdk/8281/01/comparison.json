{"files":[{"patch":"@@ -498,4 +498,1 @@\n-        private static Class<?> defineProxyClass(Module m, List<Class<?>> interfaces) {\n-            String proxyPkg = null;     \/\/ package to define proxy class in\n-            int accessFlags = Modifier.PUBLIC | Modifier.FINAL;\n-            boolean nonExported = false;\n+        private record ProxyContext(Module module, String pkg, boolean packagePrivate) {}\n@@ -503,23 +500,3 @@\n-            \/*\n-             * Record the package of a non-public proxy interface so that the\n-             * proxy class will be defined in the same package.  Verify that\n-             * all non-public proxy interfaces are in the same package.\n-             *\/\n-            for (Class<?> intf : interfaces) {\n-                int flags = intf.getModifiers();\n-                if (!Modifier.isPublic(flags)) {\n-                    accessFlags = Modifier.FINAL;  \/\/ non-public, final\n-                    String pkg = intf.getPackageName();\n-                    if (proxyPkg == null) {\n-                        proxyPkg = pkg;\n-                    } else if (!pkg.equals(proxyPkg)) {\n-                        throw new IllegalArgumentException(\n-                                \"non-public interfaces from different packages\");\n-                    }\n-                } else {\n-                    if (!intf.getModule().isExported(intf.getPackageName())) {\n-                        \/\/ module-private types\n-                        nonExported = true;\n-                    }\n-                }\n-            }\n+        private static Class<?> defineProxyClass(ProxyContext context, List<Class<?>> interfaces) {\n+            String proxyPkg = context.pkg;\n+            Module m = context.module;\n@@ -527,2 +504,2 @@\n-            if (proxyPkg == null) {\n-                \/\/ all proxy interfaces are public and exported\n+            if (!context.packagePrivate) {\n+                \/\/ all proxy interfaces are public\n@@ -531,2 +508,0 @@\n-                proxyPkg = nonExported ? PROXY_PACKAGE_PREFIX + \".\" + m.getName()\n-                                       : m.getName();\n@@ -558,0 +533,1 @@\n+            int accessFlags = (context.packagePrivate ? 0 : Modifier.PUBLIC) | Modifier.FINAL;\n@@ -578,1 +554,1 @@\n-         * {@link #defineProxyClass(Module, List)}\n+         * {@link #defineProxyClass(ProxyContext, List)}\n@@ -634,1 +610,1 @@\n-        private final Module module;\n+        private final ProxyContext context;\n@@ -651,2 +627,2 @@\n-            this.module = mapToModule(loader, interfaces, refTypes);\n-            assert getLoader(module) == loader;\n+            this.context = setupContext(loader, interfaces, refTypes);\n+            assert getLoader(context.module) == loader;\n@@ -670,1 +646,2 @@\n-            Class<?> proxyClass = defineProxyClass(module, interfaces);\n+            Class<?> proxyClass = defineProxyClass(context, interfaces);\n+            Module module = context.module;\n@@ -771,1 +748,2 @@\n-         * Returns the module that the generated proxy class belongs to.\n+         * Returns the context for the generated proxy class, including the\n+         * module and the package it belongs to and whether it is package-private.\n@@ -774,1 +752,1 @@\n-         * is in the same module of the package-private interface.\n+         * is in the same package and module as the package-private interface.\n@@ -788,3 +766,3 @@\n-        private static Module mapToModule(ClassLoader loader,\n-                                          List<Class<?>> interfaces,\n-                                          Set<Class<?>> refTypes) {\n+        private static ProxyContext setupContext(ClassLoader loader,\n+                                                 List<Class<?>> interfaces,\n+                                                 Set<Class<?>> refTypes) {\n@@ -792,0 +770,2 @@\n+            boolean nonExported = false;\n+\n@@ -796,0 +776,5 @@\n+                } else {\n+                    if (!intf.getModule().isExported(intf.getPackageName())) {\n+                        \/\/ module-private types\n+                        nonExported = true;\n+                    }\n@@ -841,1 +826,1 @@\n-                return targetModule;\n+                return new ProxyContext(targetModule, targetPackageName, true);\n@@ -846,1 +831,2 @@\n-            Module targetModule = getDynamicModule(loader);\n+            var context = getDynamicModuleContext(loader, nonExported);\n+            Module targetModule = context.module;\n@@ -855,1 +841,1 @@\n-            return targetModule;\n+            return context;\n@@ -907,2 +893,2 @@\n-        private static Module getDynamicModule(ClassLoader loader) {\n-            return dynProxyModules.computeIfAbsent(loader, (ld, clv) -> {\n+        private static ProxyContext getDynamicModuleContext(ClassLoader loader, boolean nonExported) {\n+            var module = dynProxyModules.computeIfAbsent(loader, (ld, clv) -> {\n@@ -925,0 +911,3 @@\n+            return new ProxyContext(module, nonExported\n+                    ? PROXY_PACKAGE_PREFIX + '.' + module.getName()\n+                    : module.getName(), false);\n","filename":"src\/java.base\/share\/classes\/java\/lang\/reflect\/Proxy.java","additions":35,"deletions":46,"binary":false,"changes":81,"status":"modified"}]}