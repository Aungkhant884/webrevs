{"files":[{"patch":"@@ -48,1 +48,6 @@\n-public:\n+\n+ private:\n+  \/\/ Must use AsyncHandshakeOperation when using AsyncHandshakeClosure.\n+  HandshakeOperation(AsyncHandshakeClosure* cl, JavaThread* target, jlong start_ns) {};\n+\n+ public:\n@@ -188,1 +193,1 @@\n-    if (thr->handshake_state()->has_operation_for_self()) {\n+    if (thr->handshake_state()->has_operation()) {\n@@ -388,1 +393,1 @@\n-bool HandshakeState::has_operation() {\n+bool HandshakeState::have_non_self_executable_operation() {\n@@ -465,1 +470,1 @@\n-  if (has_operation()) {\n+  if (have_non_self_executable_operation()) {\n@@ -475,1 +480,1 @@\n-  if (!has_operation_for_self()) {\n+  if (!has_operation()) {\n@@ -522,1 +527,1 @@\n-  } while (has_operation());\n+  } while (have_non_self_executable_operation());\n","filename":"src\/hotspot\/share\/runtime\/handshake.cpp","additions":11,"deletions":6,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -87,0 +87,4 @@\n+  bool have_non_self_executable_operation();\n+  HandshakeOperation* pop_for_self();\n+  HandshakeOperation* pop();\n+\n@@ -91,2 +95,0 @@\n-  HandshakeOperation* pop_for_self();\n-  HandshakeOperation* pop();\n@@ -94,2 +96,1 @@\n-  bool has_operation();\n-  bool has_operation_for_self() {\n+  bool has_operation() {\n@@ -98,0 +99,9 @@\n+\n+  \/\/ Both _queue and _lock must be check. If a thread have seen this _handshakee\n+  \/\/ as safe it will execute all possible handshake operations in a loop while\n+  \/\/ holding _lock. We use lock free addition to the queue, which means it is\n+  \/\/ possible to the queue to be seen as empty by _handshakee but as non-empty\n+  \/\/ by the thread executing in the loop. To avoid the _handshakee eliding\n+  \/\/ stopping while handshake operations are being executed, the _handshakee\n+  \/\/ must take slow if _lock is held and make sure the queue is empty otherwise\n+  \/\/ try process it.\n","filename":"src\/hotspot\/share\/runtime\/handshake.hpp","additions":14,"deletions":4,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -99,1 +99,1 @@\n-    if (global_poll() || thread->handshake_state()->has_operation_for_self()) {\n+    if (global_poll() || thread->handshake_state()->has_operation()) {\n","filename":"src\/hotspot\/share\/runtime\/safepointMechanism.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}