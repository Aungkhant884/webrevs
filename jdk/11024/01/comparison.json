{"files":[{"patch":"@@ -245,0 +245,1 @@\n+  \/\/ current is Thread::current().\n@@ -258,1 +259,1 @@\n-      u1* buffer = NEW_RESOURCE_ARRAY(u1, st.st_size);\n+      u1* buffer = NEW_RESOURCE_ARRAY_IN_THREAD(current, u1, st.st_size);\n@@ -267,1 +268,7 @@\n-        FREE_RESOURCE_ARRAY(char, path, path_len);\n+#ifdef ASSERT\n+        \/\/ now resource_area is like |path|buffer| ... |\n+        \/\/                                        \\hwm  \\max\n+        \/\/ resource_area->Afree(path, path_len) is not expected to reclaim space, but ZapResouceArea\n+        \/\/ in debug builds may help us to detect memory corruption.\n+        FREE_RESOURCE_ARRAY_IN_THREAD(current, char, path, path_len);\n+#endif\n@@ -276,1 +283,1 @@\n-  FREE_RESOURCE_ARRAY(char, path, path_len);\n+  FREE_RESOURCE_ARRAY_IN_THREAD(current, char, path, path_len);\n","filename":"src\/hotspot\/share\/classfile\/classLoader.cpp","additions":10,"deletions":3,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -426,1 +426,1 @@\n-extern void resource_free_bytes( char *old, size_t size );\n+extern void resource_free_bytes( Thread* thread, char *old, size_t size );\n@@ -519,1 +519,4 @@\n-  resource_free_bytes((char*)(old), (size) * sizeof(type))\n+  resource_free_bytes(Thread::current(), (char*)(old), (size) * sizeof(type))\n+\n+#define FREE_RESOURCE_ARRAY_IN_THREAD(thread, type, old, size)\\\n+  resource_free_bytes(thread, (char*)(old), (size) * sizeof(type))\n","filename":"src\/hotspot\/share\/memory\/allocation.hpp","additions":5,"deletions":2,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1997, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1997, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -77,2 +77,2 @@\n-extern void resource_free_bytes( char *old, size_t size ) {\n-  Thread::current()->resource_area()->Afree(old, size);\n+extern void resource_free_bytes( Thread* thread, char *old, size_t size ) {\n+  thread->resource_area()->Afree(old, size);\n","filename":"src\/hotspot\/share\/memory\/resourceArea.cpp","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2009, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2009, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -255,1 +255,1 @@\n-  resource_free_bytes((char*) addr, bytes);\n+  resource_free_bytes(Thread::current(), (char*) addr, bytes);\n","filename":"src\/hotspot\/share\/utilities\/stack.inline.hpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"}]}