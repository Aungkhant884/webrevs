{"files":[{"patch":"@@ -31,1 +31,0 @@\n-import jdk.internal.foreign.SystemLookup;\n@@ -145,0 +144,4 @@\n+     * <p>\n+     * In cases where this method is called from a context where there is no caller frame on the stack\n+     * (e.g. when called directly from a JNI attached thread), the caller's class loader defaults to the\n+     * {@linkplain ClassLoader#getSystemClassLoader system class loader}.\n@@ -153,2 +156,7 @@\n-        ClassLoader loader = Objects.requireNonNull(caller.getClassLoader());\n-        MemorySessionImpl loaderSession = MemorySessionImpl.heapSession(loader);\n+        \/\/ If there's no caller class, fallback to system loader\n+        ClassLoader loader = caller != null ?\n+                caller.getClassLoader() :\n+                ClassLoader.getSystemClassLoader();\n+        MemorySession loaderSession = (loader == null) ?\n+                MemorySession.global() : \/\/ boot loader never goes away\n+                MemorySessionImpl.heapSession(loader);\n@@ -158,0 +166,1 @@\n+            \/\/ note: ClassLoader::findNative supports a null loader\n@@ -159,2 +168,2 @@\n-            return addr == MemoryAddress.NULL\n-                    ? Optional.empty() :\n+            return addr == MemoryAddress.NULL ?\n+                    Optional.empty() :\n","filename":"src\/java.base\/share\/classes\/java\/lang\/foreign\/SymbolLookup.java","additions":14,"deletions":5,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -114,1 +114,7 @@\n-        Module module = currentClass.getModule();\n+        class Holder {\n+            private final static Module FALLBACK_MODULE =\n+                    SharedSecrets.getJavaLangAccess().defineUnnamedModule(null); \/\/ lazy init\n+        }\n+        \/\/ if there is no caller class, act as if the call came from an unnamed module\n+        Module module = currentClass != null ?\n+                currentClass.getModule() : Holder.FALLBACK_MODULE;\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/reflect\/Reflection.java","additions":7,"deletions":1,"binary":false,"changes":8,"status":"modified"}]}