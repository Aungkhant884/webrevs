{"files":[{"patch":"@@ -35,0 +35,1 @@\n+import java.lang.invoke.MethodHandles.Lookup.ClassOption;\n@@ -47,0 +48,4 @@\n+        boolean keepAlive = false;\n+        if (args.length == 1 && args[0].equals(\"keep-alive\")) {\n+            keepAlive = true;\n+        }\n@@ -51,2 +56,2 @@\n-            Class<?> cl = lookup.defineHiddenClass(klassbuf, false, NESTMATE).lookupClass();\n-            Class.forName(cl.getName()).newInstance();\n+            Class<?> c0 = lookup.defineHiddenClass(klassbuf, false, NESTMATE).lookupClass();\n+            Class.forName(c0.getName()).newInstance();\n@@ -63,2 +68,3 @@\n-        Class<?> c1 = lookup.defineHiddenClass(klassbuf, false, NESTMATE).lookupClass();\n-        Class<?> c2 = lookup.defineHiddenClass(klassbuf, false, NESTMATE).lookupClass();\n+        ClassOption classOption = keepAlive ? STRONG : NESTMATE;\n+        Class<?> c1 = lookup.defineHiddenClass(klassbuf, false, classOption).lookupClass();\n+        Class<?> c2 = lookup.defineHiddenClass(klassbuf, false, classOption).lookupClass();\n","filename":"test\/hotspot\/jtreg\/runtime\/HiddenClasses\/InstantiateHiddenClass.java","additions":10,"deletions":4,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -33,0 +33,2 @@\n+    \/\/ Prevent the following class from being GC'ed too soon.\n+    private static Class keptC = null;\n@@ -35,2 +37,2 @@\n-        if (args.length != 3) {\n-            throw new RuntimeException(\"Unexpected number of arguments: expected 3, actual \" + args.length);\n+        if (args.length < 3) {\n+            throw new RuntimeException(\"Unexpected number of arguments: expected at least 3, actual \" + args.length);\n@@ -65,0 +67,5 @@\n+        boolean keepAlive = false;\n+        if (args[args.length - 1].equals(\"keep-alive\")) {\n+            keepAlive = true;\n+        }\n+\n@@ -68,0 +75,3 @@\n+        if (keepAlive) {\n+            keptC = c;\n+        }\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/customLoader\/test-classes\/HelloUnload.java","additions":12,"deletions":2,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -28,0 +28,1 @@\n+import java.util.HashMap;\n@@ -31,0 +32,2 @@\n+    \/\/ Prevent the classes from being GC'ed too soon.\n+    static HashMap<String, Class> clsMap = new HashMap<>();\n@@ -47,0 +50,7 @@\n+        int startIdx = 2;\n+        boolean keepAlive = false;\n+        if (args[2].equals(\"keep-alive\")) {\n+            keepAlive = true;\n+            startIdx = 3;\n+        }\n+\n@@ -50,1 +60,1 @@\n-        for (int i = 2; i < args.length; i++) {\n+        for (int i = startIdx; i < args.length; i++) {\n@@ -54,0 +64,3 @@\n+            if (keepAlive) {\n+                clsMap.put(args[i], c);\n+            }\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/customLoader\/test-classes\/OldClassApp.java","additions":14,"deletions":1,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -67,1 +67,1 @@\n-            mainAppClass, customJarPath, \"false\", \"false\")\n+            mainAppClass, customJarPath, \"false\", \"false\", \"keep-alive\")\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/dynamicArchive\/HelloDynamicCustom.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -52,1 +52,1 @@\n-            \"-cp\", appJar, mainClass, appJar, \"init\")\n+            \"-cp\", appJar, mainClass, appJar, \"init\", \"keep-alive\")\n@@ -70,1 +70,1 @@\n-            \"-cp\", appJar, mainClass, appJar)\n+            \"-cp\", appJar, mainClass, appJar, \"keep-alive\")\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/dynamicArchive\/LambdaCustomLoader.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -83,1 +83,1 @@\n-                     mainAppClass, loadeesJar, inArchive),\n+                     mainAppClass, loadeesJar, inArchive, \"keep-alive\"),\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/dynamicArchive\/OldClassAndInf.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -67,1 +67,1 @@\n-            mainAppClass, customJarPath, \"false\", \"false\")\n+            mainAppClass, customJarPath, \"false\", \"false\", \"keep-alive\")\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/dynamicArchive\/PrintSharedArchiveAndExit.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -57,1 +57,1 @@\n-            \"-cp\", appJar, mainClass)\n+            \"-cp\", appJar, mainClass, \"keep-alive\")\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/dynamicArchive\/RegularHiddenClass.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -31,0 +31,2 @@\n+    \/\/ Prevent the class from being GC'ed too soon.\n+    private static Class keptC = null;\n@@ -40,1 +42,1 @@\n-        if (args.length ==2 && args[1].equals(\"init\")) {\n+        if (args.length >= 2 && args[1].equals(\"init\")) {\n@@ -44,0 +46,5 @@\n+        boolean keepAlive = false;\n+        if (args[args.length - 1].equals(\"keep-alive\")) {\n+            keepAlive = true;\n+        }\n+\n@@ -47,0 +54,4 @@\n+        if (keepAlive) {\n+            keptC = c;\n+        }\n+\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/dynamicArchive\/test-classes\/CustomLoaderApp.java","additions":12,"deletions":1,"binary":false,"changes":13,"status":"modified"}]}