{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2000, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -557,0 +557,47 @@\n+static void delay_box_in_uncommon_trap(CallNode* call, Node* resproj) {\n+  if (resproj != nullptr && call->is_CallStaticJava() &&\n+      call->as_CallStaticJava()->is_boxing_method()) {\n+    Unique_Node_List uncommon_trap_list;\n+    bool no_use = true;\n+    for (DUIterator_Fast imax, i = resproj->fast_outs(imax); i < imax; i++) {\n+      Node* m = resproj->fast_out(i);\n+      if (m->is_CallStaticJava() &&\n+          m->as_CallStaticJava()->uncommon_trap_request() != 0) {\n+        uncommon_trap_list.push(m);\n+      } else {\n+        no_use = false;\n+        break;\n+      }\n+    }\n+\n+    if (no_use) {\n+      GraphKit kit(call->jvms());\n+      PhaseGVN& gvn = kit.gvn();\n+      \/\/ delay box node in uncommon_trap runtime, treat box as a scalarized object\n+      while (uncommon_trap_list.size() > 0) {\n+        ProjNode* res = resproj->as_Proj();\n+        Node* uncommon_trap_node = uncommon_trap_list.pop();\n+\n+        ciInstanceKlass* klass = call->as_CallStaticJava()->method()->holder();\n+        int n_fields = klass->nof_nonstatic_fields();\n+        assert(n_fields == 1, \"the klass must be an auto-boxing klass\");\n+\n+        uint first_ind = (uncommon_trap_node->req() - uncommon_trap_node->jvms()->scloff());\n+        Node* sobj = new SafePointScalarObjectNode(gvn.type(res)->isa_oopptr(),\n+#ifdef ASSERT\n+                                                  (AllocateNode*)call,\n+#endif \/\/ ASSERT\n+                                                  first_ind, n_fields);\n+        sobj->init_req(0, kit.root());\n+        uncommon_trap_node->add_req(call->in(res->_con));\n+        sobj = gvn.transform(sobj);\n+        JVMState* jvms = uncommon_trap_node->jvms();\n+        jvms->set_endoff(uncommon_trap_node->req());\n+        int start = jvms->debug_start();\n+        int end   = jvms->debug_end();\n+        uncommon_trap_node->replace_edges_in_range(res, sobj, start, end);\n+      }\n+    }\n+  }\n+}\n+\n@@ -606,0 +653,2 @@\n+  delay_box_in_uncommon_trap(call, callprojs.resproj);\n+\n","filename":"src\/hotspot\/share\/opto\/callGenerator.cpp","additions":50,"deletions":1,"binary":false,"changes":51,"status":"modified"}]}