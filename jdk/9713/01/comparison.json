{"files":[{"patch":"@@ -208,0 +208,6 @@\n+nmethodBucket* DependencyContext::release_and_get_next_not_unloading(nmethodBucket* b) {\n+     nmethodBucket* next = b->next_not_unloading();\n+     release(b);\n+     return next;\n+ }\n+\n@@ -210,1 +216,1 @@\n-int DependencyContext::remove_all_dependents() {\n+void DependencyContext::remove_all_dependents() {\n@@ -213,17 +219,1 @@\n-  int marked = 0;\n-  int removed = 0;\n-  while (b != NULL) {\n-    nmethod* nm = b->get_nmethod();\n-    if (b->count() > 0 && nm->is_alive() && !nm->is_marked_for_deoptimization()) {\n-      nm->mark_for_deoptimization();\n-      marked++;\n-    }\n-    nmethodBucket* next = b->next_not_unloading();\n-    removed++;\n-    release(b);\n-    b = next;\n-  }\n-  if (UsePerfData && removed > 0) {\n-    _perf_total_buckets_deallocated_count->inc(removed);\n-  }\n-  return marked;\n+  assert(b == nullptr, \"All dependents should be unloading\");\n@@ -232,0 +222,20 @@\n+int DependencyContext::remove_and_mark_for_deoptimization_all_dependents() {\n+  nmethodBucket* b = dependencies_not_unloading();\n+   set_dependencies(NULL);\n+   int marked = 0;\n+   int removed = 0;\n+   while (b != NULL) {\n+     nmethod* nm = b->get_nmethod();\n+     if (b->count() > 0 && nm->is_alive() && !nm->is_marked_for_deoptimization()) {\n+       nm->mark_for_deoptimization();\n+       marked++;\n+     }\n+     b = release_and_get_next_not_unloading(b);\n+     removed++;\n+   }\n+   if (UsePerfData && removed > 0) {\n+     _perf_total_buckets_deallocated_count->inc(removed);\n+   }\n+   return marked;\n+ }\n+\n","filename":"src\/hotspot\/share\/code\/dependencyContext.cpp","additions":28,"deletions":18,"binary":false,"changes":46,"status":"modified"},{"patch":"@@ -123,1 +123,2 @@\n-  int  remove_all_dependents();\n+  void remove_all_dependents();\n+  int  remove_and_mark_for_deoptimization_all_dependents();\n@@ -125,0 +126,1 @@\n+  static nmethodBucket* release_and_get_next_not_unloading(nmethodBucket* b);\n","filename":"src\/hotspot\/share\/code\/dependencyContext.hpp","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -1498,1 +1498,1 @@\n-      marked = deps.remove_all_dependents();\n+      marked = deps.remove_and_mark_for_deoptimization_all_dependents();\n","filename":"src\/hotspot\/share\/prims\/methodHandles.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}