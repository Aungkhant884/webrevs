{"files":[{"patch":"@@ -2670,0 +2670,35 @@\n+objArrayOop java_lang_Throwable::get_stack_trace(Handle throwable, TRAPS) {\n+  \/\/ Call to JVM to fill in the stack trace and clear declaringObject to not keep classes alive\n+  \/\/ in the stack trace.\n+  \/\/ call this:  public StackTraceElement[] getStackTrace()\n+  assert(throwable.not_null(), \"shouldn't be\");\n+\n+  TempNewSymbol sym = SymbolTable::new_symbol(\"getStackTrace\");\n+  TempNewSymbol sig = SymbolTable::new_symbol(\"()[Ljava\/lang\/StackTraceElement;\");\n+\n+  JavaValue result(T_ARRAY);\n+  JavaCalls::call_virtual(&result, throwable,\n+                          vmClasses::Throwable_klass(),\n+                          sym, sig,\n+                          CHECK_NULL);\n+  oop stack_trace = result.get_oop();\n+  assert(stack_trace->is_objArray(), \"Should be an array\");\n+  return (objArrayOop)stack_trace;\n+}\n+\n+oop java_lang_Throwable::recreate_cause(Symbol* exception, Symbol* message, const char* thread_name,\n+                                        Handle stack_trace, TRAPS) {\n+  ResourceMark rm(THREAD);\n+  stringStream st;\n+  if (message == NULL) {\n+    st.print(\"in thread %s\", thread_name);\n+  } else {\n+    st.print(\"%s in thread %s\", message->as_C_string(), thread_name);\n+  }\n+  Handle h_cause = Exceptions::new_exception(THREAD, exception, st.as_string());\n+  java_lang_Throwable::set_stacktrace(h_cause(), stack_trace());\n+  \/\/ Clear backtrace because the stacktrace should be used instead.\n+  set_backtrace(h_cause(), NULL);\n+  return h_cause();\n+}\n+\n","filename":"src\/hotspot\/share\/classfile\/javaClasses.cpp","additions":35,"deletions":0,"binary":false,"changes":35,"status":"modified"},{"patch":"@@ -569,0 +569,6 @@\n+\n+  \/\/ For recreating class initialization error exceptions.\n+  static objArrayOop get_stack_trace(Handle throwable, TRAPS);\n+  static oop  recreate_cause(Symbol* exception, Symbol* message, const char* thread_name,\n+                             Handle stack_trace, TRAPS);\n+\n","filename":"src\/hotspot\/share\/classfile\/javaClasses.hpp","additions":6,"deletions":0,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -1626,0 +1626,2 @@\n+\n+    InstanceKlass::clean_initialization_error_table();\n","filename":"src\/hotspot\/share\/classfile\/systemDictionary.cpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -1020,0 +1020,97 @@\n+class InitErrorElement {\n+  Symbol* _exception;\n+  Symbol* _message;\n+  OopHandle _stack_trace;\n+  const char* _thread_name;\n+ public:\n+  InitErrorElement(JavaThread* current, Handle exception, Handle stack_trace) {\n+    _exception = exception->klass()->name();\n+    _exception->increment_refcount();\n+    _message = java_lang_Throwable::detail_message(exception());\n+    if (_message != nullptr) {\n+      _message->increment_refcount();\n+    }\n+    _stack_trace = OopHandle(Universe::vm_global(), stack_trace());\n+    ResourceMark rm(current);\n+    stringStream st;\n+    st.print(\"%s\", current->name());\n+    _thread_name = st.as_string(\/* c_heap *\/ true);\n+  }\n+  void clean() {\n+    _exception->decrement_refcount();\n+    if (_message != nullptr) {\n+      _message->decrement_refcount();\n+    }\n+    _stack_trace.release(Universe::vm_global());\n+    FREE_C_HEAP_ARRAY(char*, _thread_name);\n+  }\n+  Symbol* exception() const { return _exception; }\n+  Symbol* message() const   { return _message; }\n+  oop stack_trace() const   { return _stack_trace.resolve(); }\n+  const char* thread_name() const { return _thread_name; }\n+};\n+\n+ResizeableResourceHashtable<const InstanceKlass*, InitErrorElement, ResourceObj::C_HEAP, mtClass>\n+      _initialization_error_table(20);\n+\n+void InstanceKlass::add_initialization_error(Handle exception, TRAPS) {\n+  bool created = false;\n+  \/\/ Save the StackTraceElements, and the exception name.\n+  \/\/ If the initialization error is OOM, this might not work, but a NULL\n+  \/\/ stack trace with the original OOM exception might be helpful anyway.\n+  objArrayOop st = java_lang_Throwable::get_stack_trace(exception, THREAD);\n+  CLEAR_PENDING_EXCEPTION;\n+  Handle stack_trace(THREAD, st);\n+\n+  MutexLocker ml(THREAD, ClassInitError_lock);\n+  InitErrorElement elem(THREAD, exception, stack_trace);\n+  _initialization_error_table.put_if_absent(this, elem, &created);\n+  if (!created) {\n+    elem.clean();\n+  }\n+}\n+\n+oop InstanceKlass::get_initialization_error(TRAPS) {\n+  InitErrorElement* h;\n+  {\n+    MutexLocker ml(ClassInitError_lock);\n+    h = _initialization_error_table.get(this);\n+  }\n+  if (h != nullptr) {\n+    return java_lang_Throwable::recreate_cause(h->exception(), h->message(), h->thread_name(),\n+                                               Handle(THREAD, h->stack_trace()), CHECK_NULL);\n+  } else {\n+    return nullptr;\n+  }\n+}\n+\n+\/\/ Need to remove entries for unloaded classes.\n+void InstanceKlass::clean_initialization_error_table() {\n+  struct InitErrorTableCleaner {\n+    bool do_entry(const InstanceKlass* ik, InitErrorElement h) {\n+      if (!ik->is_loader_alive()) {\n+        h.clean();\n+        return true;\n+      } else {\n+        return false;\n+      }\n+    }\n+  };\n+\n+  MutexLocker ml(ClassInitError_lock);\n+  InitErrorTableCleaner cleaner;\n+  _initialization_error_table.unlink(&cleaner);\n+}\n+\n+void print_initialization_error_table() {\n+  struct Printer {\n+    bool do_entry(const InstanceKlass* ik, InitErrorElement) {\n+      tty->print_cr(\"klass\");\n+      ik->print();\n+      return true;\n+    }\n+  };\n+  Printer p;\n+  _initialization_error_table.iterate(&p);\n+}\n+\n@@ -1066,7 +1163,7 @@\n-      const char* desc = \"Could not initialize class \";\n-      const char* className = external_name();\n-      size_t msglen = strlen(desc) + strlen(className) + 1;\n-      char* message = NEW_RESOURCE_ARRAY(char, msglen);\n-      if (NULL == message) {\n-        \/\/ Out of memory: can't create detailed error message\n-          THROW_MSG(vmSymbols::java_lang_NoClassDefFoundError(), className);\n+      Handle cause(THREAD, get_initialization_error(THREAD));\n+      CLEAR_PENDING_EXCEPTION; \/\/ ignore any OOM here.\n+\n+      stringStream ss;\n+      ss.print(\"Cound not initialize class %s\", external_name());\n+      if (cause.is_null()) {\n+        THROW_MSG(vmSymbols::java_lang_NoClassDefFoundError(), ss.as_string());\n@@ -1074,2 +1171,2 @@\n-        jio_snprintf(message, msglen, \"%s%s\", desc, className);\n-          THROW_MSG(vmSymbols::java_lang_NoClassDefFoundError(), message);\n+        THROW_MSG_CAUSE(vmSymbols::java_lang_NoClassDefFoundError(),\n+                        ss.as_string(), cause);\n@@ -1106,0 +1203,1 @@\n+        add_initialization_error(e, THREAD);\n@@ -1141,3 +1239,1 @@\n-    {\n-      debug_only(vtable().verify(tty, true);)\n-    }\n+    debug_only(vtable().verify(tty, true);)\n@@ -1154,0 +1250,1 @@\n+      add_initialization_error(e, THREAD);\n","filename":"src\/hotspot\/share\/oops\/instanceKlass.cpp","additions":109,"deletions":12,"binary":false,"changes":121,"status":"modified"},{"patch":"@@ -1199,0 +1199,1 @@\n+  static void clean_initialization_error_table();\n@@ -1210,0 +1211,3 @@\n+  void add_initialization_error(Handle exception, TRAPS);\n+  oop get_initialization_error(JavaThread* current);\n+\n","filename":"src\/hotspot\/share\/oops\/instanceKlass.hpp","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -46,0 +46,1 @@\n+Monitor* ClassInitError_lock          = NULL;\n@@ -259,0 +260,1 @@\n+  def(ClassInitError_lock          , PaddedMonitor, leaf+1,      true,  _safepoint_check_always);\n","filename":"src\/hotspot\/share\/runtime\/mutexLocker.cpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -38,0 +38,1 @@\n+extern Monitor* ClassInitError_lock;             \/\/ a lock on the class initialization error table\n","filename":"src\/hotspot\/share\/runtime\/mutexLocker.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -0,0 +1,78 @@\n+\/*\n+ * Copyright (c) 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/**\n+ * @test\n+ * @bug 8048190\n+ * @summary Test that the CNFE saves original exception during class initialization.\n+ * @compile InitNPE.jasm InitOOM.jasm\n+ * @run main InitExceptionTest\n+ *\/\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.PrintStream;\n+\n+public class InitExceptionTest {\n+\n+  private static void verify_stack(Throwable e, String expected, String cause) throws Exception {\n+    ByteArrayOutputStream byteOS = new ByteArrayOutputStream();\n+    PrintStream printStream = new PrintStream(byteOS);\n+    e.printStackTrace(printStream);\n+    printStream.close();\n+    String stackTrace = byteOS.toString(\"ASCII\");\n+    if (!stackTrace.contains(expected) || (cause != null && !stackTrace.contains(cause))) {\n+      throw new RuntimeException(expected + \" and \" + cause + \" missing from stacktrace: \" + stackTrace);\n+    }\n+  }\n+\n+  public static void main(java.lang.String[] unused) throws Exception {\n+    try {\n+      InitNPE c = new InitNPE();\n+    } catch (Error err) {\n+      System.out.println(\"Error thrown: \" + err);\n+      verify_stack(err, \"java.lang.ExceptionInInitializerError\", \"Caused by: java.lang.NullPointerException\");\n+      err.printStackTrace();\n+    }\n+    try {\n+      InitNPE c = new InitNPE();\n+    } catch (Error err) {\n+      System.out.println(\"Error thrown: \" + err);\n+      verify_stack(err, \"java.lang.NoClassDefFoundError\", \"Caused by: java.lang.NullPointerException\");\n+      err.printStackTrace();\n+    }\n+    try {\n+      InitOOM e = new InitOOM();\n+    } catch (Error err) {\n+      System.out.println(\"Error thrown: \" + err);\n+      verify_stack(err, \"java.lang.OutOfMemoryError\", \"Java heap space\");\n+      err.printStackTrace();\n+    }\n+    try {\n+      InitOOM e = new InitOOM();\n+    } catch (Error err) {\n+      System.out.println(\"Error thrown: \" + err);\n+      verify_stack(err, \"java.lang.NoClassDefFoundError\", \"Caused by: java.lang.OutOfMemoryError\");\n+      err.printStackTrace();\n+    }\n+  }\n+}\n","filename":"test\/hotspot\/jtreg\/runtime\/ClassInitErrors\/InitExceptionTest.java","additions":78,"deletions":0,"binary":false,"changes":78,"status":"added"},{"patch":"@@ -0,0 +1,99 @@\n+\/*\n+ * Copyright (c) 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/**\n+ * @test\n+ * @bug 8048190\n+ * @summary Test that the CNFE saves original exception during class initialization.\n+ *          And is unloaded\n+ * @requires vm.opt.final.ClassUnloading\n+ * @modules java.base\/jdk.internal.misc\n+ * @library \/test\/lib\n+ * @build sun.hotspot.WhiteBox\n+ * @run driver jdk.test.lib.helpers.ClassFileInstaller sun.hotspot.WhiteBox\n+ * @run main\/othervm -Xbootclasspath\/a:. -Xmn8m -XX:+UnlockDiagnosticVMOptions -Xlog:class+unload -XX:+WhiteBoxAPI InitExceptionUnloadTest\n+ *\/\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.PrintStream;\n+\n+import sun.hotspot.WhiteBox;\n+import jdk.test.lib.classloader.ClassUnloadCommon;\n+\n+public class InitExceptionUnloadTest {\n+    static public class ThrowsRuntimeException { static int x = 1\/0; }\n+    static public class ThrowsError { static { if (true) throw new Error(); } }\n+\n+    private static void verify_stack(Throwable e, String expected, String cause) throws Exception {\n+        ByteArrayOutputStream byteOS = new ByteArrayOutputStream();\n+        PrintStream printStream = new PrintStream(byteOS);\n+        e.printStackTrace(printStream);\n+        printStream.close();\n+        String stackTrace = byteOS.toString(\"ASCII\");\n+        if (!stackTrace.contains(expected) || (cause != null && !stackTrace.contains(cause))) {\n+            throw new RuntimeException(expected + \" and \" + cause + \" missing from stacktrace: \" + stackTrace);\n+        }\n+    }\n+\n+    static String[] expected = new String[] {\n+        \"java.lang.ExceptionInInitializerError\",\n+        \"Caused by: java.lang.ArithmeticException: \/ by zero\",\n+        \"java.lang.NoClassDefFoundError: Cound not initialize class InitExceptionUnloadTest$ThrowsRuntimeException\",\n+        \"Caused by: java.lang.ArithmeticException: \/ by zero\",\n+        \"java.lang.Error\",\n+        null,\n+        \"java.lang.NoClassDefFoundError: Cound not initialize class InitExceptionUnloadTest$ThrowsError\",\n+        \"Caused by: java.lang.Error\" };\n+\n+    static String[] classNames = new String[] {\n+         \"InitExceptionUnloadTest$ThrowsRuntimeException\",\n+         \"InitExceptionUnloadTest$ThrowsError\" };\n+\n+    public static WhiteBox wb = WhiteBox.getWhiteBox();\n+\n+    static void test() throws Throwable {\n+        ClassLoader cl = ClassUnloadCommon.newClassLoader();\n+        int i = 0;\n+        for (String className : classNames) {\n+            System.err.println(\"--- try to load \" + className);\n+            for (int tries = 2; tries--> 0; ) {\n+                try {\n+                    Class<?> c = cl.loadClass(className);\n+                    Object inst = c.newInstance();\n+                } catch (Throwable t) {\n+                    t.printStackTrace();\n+                    verify_stack(t, expected[i], expected[i+1]);\n+                    i += 2;\n+                }\n+            }\n+        }\n+        cl = null;\n+        ClassUnloadCommon.triggerUnloading();  \/\/ should unload these classes\n+        ClassUnloadCommon.failIf(wb.isClassAlive(classNames[0]), \"should be unloaded\");\n+        ClassUnloadCommon.failIf(wb.isClassAlive(classNames[1]), \"should be unloaded\");\n+    }\n+    public static void main(java.lang.String[] unused) throws Throwable {\n+        test();\n+        test();\n+    }\n+}\n","filename":"test\/hotspot\/jtreg\/runtime\/ClassInitErrors\/InitExceptionUnloadTest.java","additions":99,"deletions":0,"binary":false,"changes":99,"status":"added"},{"patch":"@@ -0,0 +1,50 @@\n+\/*\n+ * Copyright (c) 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+super class InitNPE\n+\tversion 62:0\n+{\n+\n+\n+Method \"<init>\":\"()V\"\n+\tstack 1 locals 1\n+{\n+\t\taload_0;\n+\t\tinvokespecial\tMethod java\/lang\/Object.\"<init>\":\"()V\";\n+\t\treturn;\n+}\n+\n+\/\/ Initialization calls NPE.\n+static Method \"<clinit>\":\"()V\"\n+\tstack 2 locals 1\n+{\n+\t\tgetstatic\tField java\/lang\/System.out:\"Ljava\/io\/PrintStream;\";\n+\t\tldc\tString \"Init\";\n+\t\tinvokevirtual\tMethod java\/io\/PrintStream.println:\"(Ljava\/lang\/String;)V\";\n+\t\tnew\tclass java\/lang\/NullPointerException;\n+\t\tdup;\n+\t\tinvokespecial\tMethod java\/lang\/NullPointerException.\"<init>\":\"()V\";\n+\t\tathrow;\n+}\n+\n+} \/\/ end Class InitNPE\n","filename":"test\/hotspot\/jtreg\/runtime\/ClassInitErrors\/InitNPE.jasm","additions":50,"deletions":0,"binary":false,"changes":50,"status":"added"},{"patch":"@@ -0,0 +1,71 @@\n+\/*\n+ * Copyright (c) 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+super class InitOOM\n+\tversion 62:0\n+{\n+\n+Method \"<init>\":\"()V\"\n+\tstack 1 locals 1\n+{\n+\t\taload_0;\n+\t\tinvokespecial\tMethod java\/lang\/Object.\"<init>\":\"()V\";\n+\t\treturn;\n+}\n+\n+\/\/ Throw OOM from class initializer.\n+static Method \"<clinit>\":\"()V\"\n+\tstack 1 locals 0\n+{\n+                invokestatic    Method \"foo\":\"()V\";\n+\t\treturn;\n+}\n+\n+static Method foo:\"()V\"\n+\tthrows java\/lang\/Exception\n+\tstack 2 locals 2\n+{\n+\t\tnew\tclass java\/util\/ArrayList;\n+\t\tdup;\n+\t\tinvokespecial\tMethod java\/util\/ArrayList.\"<init>\":\"()V\";\n+\t\tastore_0;\n+\tL8:\tstack_frame_type append;\n+\t\tlocals_map class java\/util\/ArrayList;\n+\t\tsipush\t16384;\n+\t\tistore_1;\n+\tL12:\tstack_frame_type append;\n+\t\tlocals_map int;\n+\t\tiload_1;\n+\t\tifle\tL32;\n+\t\taload_0;\n+\t\tsipush\t1024;\n+\t\tnewarray byte;\n+\t\tinvokevirtual\tMethod java\/util\/ArrayList.add:\"(Ljava\/lang\/Object;)Z\";\n+\t\tpop;\n+\t\tiinc\t1, -1;\n+\t\tgoto\tL12;\n+\tL32:\tstack_frame_type chop1;\n+\t\tgoto\tL8;\n+}\n+\n+} \/\/ end Class InitOOM\n","filename":"test\/hotspot\/jtreg\/runtime\/ClassInitErrors\/InitOOM.jasm","additions":71,"deletions":0,"binary":false,"changes":71,"status":"added"}]}