{"files":[{"patch":"@@ -65,1 +65,0 @@\n-        \/\/ Opt: Only need to do if we're not using the default GC\n@@ -67,3 +66,2 @@\n-        XToolkit.awtLock(); \/\/ the number of screens may otherwise change during\n-        try {\n-            int screenNum = ((X11GraphicsDevice) gc.getDevice()).getScreen();\n+        final X11GraphicsDevice newDev = getSameScreenDevice(gc);\n+        final int visualToLookFor = graphicsConfig.getVisual();\n@@ -71,3 +69,10 @@\n-            X11GraphicsConfig parentgc;\n-            \/\/ save vis id of current gc\n-            int visual = graphicsConfig.getVisual();\n+        final GraphicsConfiguration[] configurations = newDev.getConfigurations();\n+        for (final GraphicsConfiguration config : configurations) {\n+            final X11GraphicsConfig x11gc = (X11GraphicsConfig) config;\n+            if (visualToLookFor == x11gc.getVisual()) {\n+                graphicsConfig = x11gc;\n+            }\n+        }\n+\n+        return graphicsConfig;\n+    }\n@@ -75,1 +80,5 @@\n-            X11GraphicsDevice newDev = (X11GraphicsDevice) GraphicsEnvironment.\n+    private X11GraphicsDevice getSameScreenDevice(GraphicsConfiguration gc) {\n+        XToolkit.awtLock(); \/\/ so that the number of screens doesn't change during\n+        try {\n+            final int screenNum = ((X11GraphicsDevice) gc.getDevice()).getScreen();\n+            return (X11GraphicsDevice) GraphicsEnvironment.\n@@ -78,17 +87,0 @@\n-\n-            for (int i = 0; i < newDev.getNumConfigs(screenNum); i++) {\n-                if (visual == newDev.getConfigVisualId(i, screenNum)) {\n-                    \/\/ use that\n-                    graphicsConfig = (X11GraphicsConfig) newDev.getConfigurations()[i];\n-                    break;\n-                }\n-            }\n-            \/\/ just in case...\n-            if (graphicsConfig == null) {\n-                graphicsConfig = (X11GraphicsConfig) GraphicsEnvironment.\n-                        getLocalGraphicsEnvironment().\n-                        getScreenDevices()[screenNum].\n-                        getDefaultConfiguration();\n-            }\n-\n-            return graphicsConfig;\n","filename":"src\/java.desktop\/unix\/classes\/sun\/awt\/X11\/XCanvasPeer.java","additions":17,"deletions":25,"binary":false,"changes":42,"status":"modified"},{"patch":"@@ -67,1 +67,0 @@\n-    private final Object configLock = new Object();\n@@ -154,3 +153,1 @@\n-            synchronized (configLock) {\n-                makeConfigurations();\n-            }\n+            makeConfigurations();\n@@ -162,3 +159,3 @@\n-        if (configs == null) {\n-            XToolkit.awtLock();\n-            try {\n+        XToolkit.awtLock();\n+        try {\n+            if (configs == null) {\n@@ -204,2 +201,0 @@\n-            } finally {\n-                XToolkit.awtUnlock();\n@@ -207,0 +202,2 @@\n+        } finally {\n+            XToolkit.awtUnlock();\n@@ -246,3 +243,1 @@\n-            synchronized (configLock) {\n-                makeDefaultConfiguration();\n-            }\n+            makeDefaultConfiguration();\n@@ -254,3 +249,3 @@\n-        if (defaultConfig == null) {\n-            XToolkit.awtLock();\n-            try {\n+        XToolkit.awtLock();\n+        try {\n+            if (defaultConfig == null) {\n@@ -293,2 +288,0 @@\n-            } finally {\n-                XToolkit.awtUnlock();\n@@ -296,0 +289,2 @@\n+        } finally {\n+            XToolkit.awtUnlock();\n","filename":"src\/java.desktop\/unix\/classes\/sun\/awt\/X11GraphicsDevice.java","additions":12,"deletions":17,"binary":false,"changes":29,"status":"modified"}]}