{"files":[{"patch":"@@ -42,0 +42,1 @@\n+import java.nio.file.FileVisitResult;\n@@ -44,0 +45,2 @@\n+import java.nio.file.SimpleFileVisitor;\n+import java.nio.file.attribute.BasicFileAttributes;\n@@ -228,0 +231,1 @@\n+        Path outputPath = null;\n@@ -268,0 +272,1 @@\n+            outputPath = config.getOutput();\n@@ -288,0 +293,1 @@\n+            cleanupOutput(outputPath);\n@@ -301,0 +307,1 @@\n+            cleanupOutput(outputPath);\n@@ -307,0 +314,11 @@\n+    private void cleanupOutput(Path dir) {\n+        try {\n+            deleteDirectory(dir);\n+        } catch (IOException io) {\n+            log.println(taskHelper.getMessage(\"error.prefix\") + \" \" + io.getMessage());\n+            if (DEBUG) {\n+                io.printStackTrace(log);\n+            }\n+        }\n+    }\n+\n@@ -471,0 +489,24 @@\n+    private static void deleteDirectory(Path dir) throws IOException {\n+        if (dir != null && Files.isDirectory(dir)) {\n+            Files.walkFileTree(dir, new SimpleFileVisitor<Path>() {\n+                @Override\n+                public FileVisitResult visitFile(Path file, BasicFileAttributes attrs)\n+                        throws IOException {\n+                    Files.delete(file);\n+                    return FileVisitResult.CONTINUE;\n+                }\n+                @Override\n+                public FileVisitResult postVisitDirectory(Path dir, IOException e)\n+                        throws IOException {\n+                    if (e == null) {\n+                        Files.delete(dir);\n+                        return FileVisitResult.CONTINUE;\n+                    } else {\n+                        \/\/ directory iteration failed.\n+                        throw e;\n+                    }\n+                }\n+            });\n+        }\n+    }\n+\n","filename":"src\/jdk.jlink\/share\/classes\/jdk\/tools\/jlink\/internal\/JlinkTask.java","additions":42,"deletions":0,"binary":false,"changes":42,"status":"modified"},{"patch":"@@ -50,0 +50,1 @@\n+ * @bug 8240349\n@@ -369,0 +370,13 @@\n+        {\n+            String imageDir = \"bug8240349\";\n+            Path imagePath = helper.createNewImageDir(imageDir);\n+            JImageGenerator.getJLinkTask()\n+                    .modulePath(helper.defaultModulePath())\n+                    .output(imagePath)\n+                    .addMods(\"java.base\")\n+                    .option(\"--vm=client\")\n+                    .call().assertFailure(\"Error: Selected VM client doesn't exist\");\n+            if (Files.isDirectory(imagePath)) {\n+                throw new RuntimeException(\"bug8240349 directory not deleted\");\n+            }\n+        }\n","filename":"test\/jdk\/tools\/jlink\/JLinkTest.java","additions":14,"deletions":0,"binary":false,"changes":14,"status":"modified"}]}