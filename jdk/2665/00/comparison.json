{"files":[{"patch":"@@ -0,0 +1,194 @@\n+\/*\n+ * Copyright (c) 2017, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package jdk.javadoc.internal.doclets.formats.html;\n+\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.RejectedExecutionException;\n+import java.util.concurrent.Semaphore;\n+import java.util.concurrent.TimeUnit;\n+\n+import jdk.javadoc.internal.doclets.formats.html.markup.HtmlDocument;\n+import jdk.javadoc.internal.doclets.toolkit.Messages;\n+import jdk.javadoc.internal.doclets.toolkit.util.DocFile;\n+import jdk.javadoc.internal.doclets.toolkit.util.DocFileIOException;\n+\n+\/**\n+ * A class to write {@link HtmlDocument} objects on a background thread,\n+ * using an {@link ExecutorService}.\n+ *\n+ *  <p><b>This is NOT part of any supported API.\n+ *  If you write code that depends on this, you do so at your own risk.\n+ *  This code and its internal interfaces are subject to change or\n+ *  deletion without notice.<\/b>\n+ *\/\n+public class BackgroundWriter {\n+\n+    \/**\n+     * The number of background threads to create, to write out files.\n+     * Just one thread is created, primarily because one is enough.\n+     * Experiments show that the utilization of this thread is currently\n+     * about 8%, meaning we cannot generate pages fast enough to\n+     * warrant more threads. This may change if we ever start to\n+     * generate pages on multiple threads.\n+     *\/\n+    private static final int BACKGROUND_THREADS = 1;\n+\n+    \/**\n+     * The number of tasks awaiting execution.\n+     * Since we currently consume (execute) tasks faster than we can\n+     * produce them, there is no point in queuing any additional tasks.\n+     * That just uses up memory, and so has a regressive impact on\n+     * performance, by causing more GC cycles.\n+     *\/\n+    private static final int QUEUED_TASKS = 0;\n+\n+    \/**\n+     * A messages object, used to write messages should any errors occur.\n+     * Note that because the errors are handled here, and not passed up\n+     * to the AbstractDoclet, we cannot dump the stack in the case of\n+     * an error, although we could set a flag to do so, if necessary.\n+     *\/\n+    private final Messages messages;\n+\n+    \/**\n+     * The main executor for the background tasks.\n+     * It uses a fixed thread pool of {@value #BACKGROUND_THREADS} threads.\n+     *\/\n+    private final ExecutorService executor;\n+\n+    \/**\n+     * A semaphore to help restrict the number of queued and active tasks.\n+     * See \"Java Concurrency In Practice\", by Brian Goetz et al,\n+     * 8.3.3: Saturation Policies (last paragraph) and\n+     * Listing 8.4: Using a Semaphore to throttle task submission.\n+     *\/\n+    private final Semaphore semaphore;\n+\n+    \/**\n+     * The time at which the writer is initialized.\n+     *\/\n+    private long start;\n+\n+    \/**\n+     * The cumulative time spent writing documents\n+     *\/\n+    private double taskBusy = 0;\n+\n+    \/**\n+     * Whether to report additional information, such as the overall utilization of the\n+     * background thread.\n+     *\/\n+    private boolean verbose;\n+\n+    \/**\n+     * Creates a {@code BackgroundWriter}.\n+     *\n+     * @implNote\n+     * The writer uses a {@link Executors#newFixedThreadPool fixed thread pool} of\n+     * {@value #BACKGROUND_THREADS} background threads, and a blocking queue of up to\n+     * {@value #QUEUED_TASKS} queued tasks.\n+     *\n+     * @param messages used to write out any error messages and other output\n+     * @param verbose  if true, writes out debugging info about the utilization of the background thread\n+     *\/\n+    public BackgroundWriter(Messages messages, boolean verbose) {\n+        this.messages = messages;\n+        this.verbose = verbose;\n+        executor = Executors.newFixedThreadPool(BACKGROUND_THREADS);\n+        semaphore = new Semaphore(QUEUED_TASKS + BACKGROUND_THREADS);\n+        start = System.currentTimeMillis();\n+    }\n+\n+    \/**\n+     * Writes the given document at some point in the future, using the internal executor.\n+     * A semaphore is used to throttle the number of requests, although in practice this\n+     * rarely takes effect, because it is quicker to write documents than to generate them.\n+     *\n+     * @param doc  the document to be written\n+     * @param file the file to which to write the document\n+     *\/\n+    public void writeLater(HtmlDocument doc, DocFile file) {\n+        try {\n+            semaphore.acquire();\n+            try {\n+                executor.execute(() -> {\n+                    try {\n+                        long taskStart  = System.currentTimeMillis();\n+                        doc.write(file);\n+                        long taskEnd  = System.currentTimeMillis();\n+                        taskBusy += (taskEnd - taskStart);\n+                    } catch (DocFileIOException e) {\n+                        error(e);\n+                    } finally {\n+                        semaphore.release();\n+                    }\n+                });\n+            } catch (RejectedExecutionException e) {\n+                semaphore.release();\n+            }\n+        } catch (InterruptedException e) {\n+            messages.error(\"doclet.exception.interrupted\");\n+        }\n+\n+    }\n+\n+    \/**\n+     * Shuts down the internal executor service, releasing all resources.\n+     *\/\n+    public void finish() {\n+        try {\n+            executor.shutdown();\n+            executor.awaitTermination(5, TimeUnit.MINUTES);\n+\n+            if (verbose) {\n+                double elapsed = System.currentTimeMillis() - start;\n+                messages.notice(\"doclet.bgWriter.utilization\", ((int) (taskBusy \/ elapsed * 100)) + \"%\");\n+            }\n+\n+        } catch (InterruptedException e) {\n+            messages.error(\"doclet.exception.interrupted\");\n+        }\n+    }\n+\n+    \/**\n+     * Reports an exception that occurred on the background thread.\n+     *\n+     * @param e the exception\n+     *\/\n+    private void error(DocFileIOException e) {\n+        switch (e.mode) {\n+            case READ:\n+                messages.error(\"doclet.exception.read.file\",\n+                        e.fileName.getPath(), e.getCause());\n+                break;\n+\n+            case WRITE:\n+                messages.error(\"doclet.exception.write.file\",\n+                        e.fileName.getPath(), e.getCause());\n+        }\n+    }\n+}\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/BackgroundWriter.java","additions":194,"deletions":0,"binary":false,"changes":194,"status":"added"},{"patch":"@@ -208,0 +208,4 @@\n+\n+        if (options.isBackgroundWriterEnabled()) {\n+            backgroundWriter = new BackgroundWriter(messages, options.isBackgroundWriterVerbose());\n+        }\n@@ -209,0 +213,1 @@\n+\n@@ -229,0 +234,2 @@\n+    protected BackgroundWriter backgroundWriter;\n+\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/HtmlConfiguration.java","additions":7,"deletions":0,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -380,0 +380,7 @@\n+\n+    @Override\n+    protected void finish() {\n+        if (configuration.backgroundWriter != null) {\n+            configuration.backgroundWriter.finish();\n+        }\n+    }\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/HtmlDoclet.java","additions":7,"deletions":0,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -479,1 +479,6 @@\n-        htmlDocument.write(DocFile.createFileForOutput(configuration, path));\n+        DocFile file = DocFile.createFileForOutput(configuration, path);\n+        if (configuration.backgroundWriter == null) {\n+            htmlDocument.write(file);\n+        } else {\n+            configuration.backgroundWriter.writeLater(htmlDocument, file);\n+        }\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/HtmlDocletWriter.java","additions":6,"deletions":1,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -32,0 +32,1 @@\n+import java.util.Locale;\n@@ -182,0 +183,4 @@\n+\n+    private boolean backgroundWriterEnabled = true;\n+\n+    private boolean backgroundWriterVerbose = false;\n@@ -450,0 +455,18 @@\n+                },\n+\n+                new Hidden(resources, \"--background-writer\", 1) {\n+                    @Override\n+                    public boolean process(String option, List<String> args) {\n+                        \/\/ if we add more options, we should introduce BackgroundWriter.Options\n+                        String flags = args.get(0);\n+                        for (String f : flags.split(\",\")) {\n+                            switch (f.toLowerCase(Locale.US)) {\n+                                case \"off\" -> backgroundWriterEnabled = false;\n+                                case \"verbose\" -> backgroundWriterVerbose = true;\n+                                default -> {\n+                                    messages.warning(\"doclet.bgWriter.unknown_option\", f);\n+                                }\n+                            }\n+                        }\n+                        return true;\n+                    }\n@@ -681,0 +704,17 @@\n+\n+\n+    \/**\n+     * Whether or not to use the background writer.\n+     * Set by command-lione option {@code --background-writer}.\n+     *\/\n+    public boolean isBackgroundWriterEnabled() {\n+        return backgroundWriterEnabled;\n+    }\n+\n+    \/**\n+     * Whether or not the background writer should be verbose.\n+     * Set by command-lione option {@code --background-writer}.\n+     *\/\n+    public boolean isBackgroundWriterVerbose() {\n+        return backgroundWriterVerbose;\n+    }\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/HtmlOptions.java","additions":40,"deletions":0,"binary":false,"changes":40,"status":"modified"},{"patch":"@@ -535,0 +535,6 @@\n+\n+doclet.bgWriter.unknown_option=\\\n+    Unknown option for ''--background-writer'': {0}\n+\n+doclet.bgWriter.utilization=\\\n+    Background writer utilization: {0}\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/resources\/standard.properties","additions":6,"deletions":0,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -149,0 +149,3 @@\n+\n+        } finally {\n+            finish();\n@@ -283,0 +286,2 @@\n+\n+    protected void finish() { }\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/toolkit\/AbstractDoclet.java","additions":5,"deletions":0,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -50,0 +50,1 @@\n+doclet.exception.interrupted=Interrupted!\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/toolkit\/resources\/doclets.properties","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -251,1 +251,1 @@\n-    private void printError(String prefix, String msg) {\n+    private synchronized void printError(String prefix, String msg) {\n@@ -298,1 +298,1 @@\n-    private void printWarning(String prefix, String msg) {\n+    private synchronized void printWarning(String prefix, String msg) {\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/tool\/Messager.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"}]}