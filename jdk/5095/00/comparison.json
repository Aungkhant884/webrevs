{"files":[{"patch":"@@ -1939,0 +1939,8 @@\n+WB_ENTRY(jboolean, WB_IsSharedInternedString(JNIEnv* env, jobject wb, jobject str))\n+  ResourceMark rm(THREAD);\n+  oop str_oop = JNIHandles::resolve(str);\n+  int length;\n+  jchar* chars = java_lang_String::as_unicode_string(str_oop, length, CHECK_(false));\n+  return StringTable::lookup_shared(chars, length) == str_oop;\n+WB_END\n+\n@@ -1943,2 +1951,2 @@\n-WB_ENTRY(jboolean, WB_AreSharedStringsIgnored(JNIEnv* env))\n-  return !HeapShared::closed_regions_mapped();\n+WB_ENTRY(jboolean, WB_AreSharedStringsMapped(JNIEnv* env))\n+  return HeapShared::closed_regions_mapped();\n@@ -2628,0 +2636,1 @@\n+  {CC\"isSharedInternedString\", CC\"(Ljava\/lang\/String;)Z\", (void*)&WB_IsSharedInternedString },\n@@ -2629,1 +2638,1 @@\n-  {CC\"areSharedStringsIgnored\",           CC\"()Z\",    (void*)&WB_AreSharedStringsIgnored },\n+  {CC\"areSharedStringsMapped\",            CC\"()Z\",    (void*)&WB_AreSharedStringsMapped },\n","filename":"src\/hotspot\/share\/prims\/whitebox.cpp","additions":12,"deletions":3,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -52,1 +52,1 @@\n-        \/\/ Force -Xlog:cds=warning to supress the CDS logs.\n+        \/\/ Force the log level to warning for all tags to supressed the CDS logs. Also disable the timestamp.\n@@ -54,1 +54,1 @@\n-        opts.addSuffix(\"-showversion\", \"-Xlog:cds=warning\", \"ServiceLoaderApp\");\n+        opts.addSuffix(\"-showversion\", \"-Xlog:all=warning::level,tags\", \"ServiceLoaderApp\");\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/ServiceLoaderTest.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2013, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2013, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -32,2 +32,2 @@\n-        if (wb.areSharedStringsIgnored()) {\n-            System.out.println(\"Shared strings are ignored, assuming PASS\");\n+        if (!wb.areSharedStringsMapped()) {\n+            System.out.println(\"Shared strings are not mapped, assuming PASS\");\n@@ -46,1 +46,1 @@\n-        if (wb.isShared(internedS)) {\n+        if (wb.isSharedInternedString(internedS)) {\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/SharedStringsWb.java","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -100,3 +100,3 @@\n-            .shouldMatch(\".info..class,load *. boot.append.Foo\")      \/\/ from -Xlog:class+load\n-            .shouldMatch(\"cds,class.*boot  boot.append.Foo\")          \/\/ from -Xlog:cds+class\n-            .shouldNotMatch(\".info..class,load *. jdk.jfr.NewClass\"); \/\/ from -Xlog:class+load\n+            .shouldMatch(\"class,load *. boot.append.Foo\")      \/\/ from -Xlog:class+load\n+            .shouldMatch(\"cds,class.*boot  boot.append.Foo\")   \/\/ from -Xlog:cds+class\n+            .shouldNotMatch(\"class,load *. jdk.jfr.NewClass\"); \/\/ from -Xlog:class+load\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/DumpClassList.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2017, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2017, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -65,2 +65,2 @@\n-        if (wb.areSharedStringsIgnored()) {\n-          System.out.println(\"Shared strings are ignored.\");\n+        if (!wb.areSharedStringsMapped()) {\n+          System.out.println(\"Shared strings are not mapped.\");\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/cacheObject\/GCStressApp.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2017, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2017, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -58,1 +58,1 @@\n-        if (wb.areSharedStringsIgnored()) {\n+        if (!wb.areSharedStringsMapped()) {\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/cacheObject\/RedefineClassApp.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2017, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2017, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -41,1 +41,1 @@\n-        if (!wb.areSharedStringsIgnored() && !wb.isShared(s)) {\n+        if (wb.areSharedStringsMapped() && !wb.isSharedInternedString(s)) {\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/javaldr\/GCSharedStringsDuringDumpWb.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -29,0 +29,1 @@\n+ * @requires vm.gc == null\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/sharedStrings\/ExerciseGC.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -29,0 +29,1 @@\n+ * @requires vm.gc == null\n@@ -39,0 +40,1 @@\n+ * @requires vm.gc == null\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/sharedStrings\/FlagCombo.java","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -36,1 +36,1 @@\n-        if (!wb.isShared(testString1) && !wb.areSharedStringsIgnored()) {\n+        if (wb.areSharedStringsMapped() && !wb.isSharedInternedString(testString1)) {\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/sharedStrings\/HelloStringGC.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -37,1 +37,1 @@\n-        if (!wb.isShared(testString1) && !wb.areSharedStringsIgnored()) {\n+        if (wb.areSharedStringsMapped() && !wb.isSharedInternedString(testString1)) {\n@@ -69,1 +69,1 @@\n-        if (!wb.isShared(empty)) {\n+        if (wb.areSharedStringsMapped() && !wb.isSharedInternedString(empty)) {\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/sharedStrings\/HelloStringPlus.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -29,0 +29,1 @@\n+ * @requires vm.gc == null\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/sharedStrings\/InternSharedString.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -41,4 +41,6 @@\n-        if (wb.areSharedStringsIgnored() || wb.isShared(interned1)) {\n-            System.out.println(passed_output1);\n-        } else {\n-            throw new RuntimeException(\"Failed: String is not shared.\");\n+        if (wb.areSharedStringsMapped()) {\n+            if (wb.isSharedInternedString(interned1)) {\n+                System.out.println(passed_output1);\n+            } else {\n+                throw new RuntimeException(\"Failed: String is not shared.\");\n+            }\n@@ -61,4 +63,6 @@\n-            if (wb.areSharedStringsIgnored() || wb.isShared(b)) {\n-                System.out.println(passed_output3);\n-            } else {\n-                throw new RuntimeException(\"Failed: expected shared string with latin1-supplement chars.\");\n+            if (wb.areSharedStringsMapped()) {\n+                if (wb.isSharedInternedString(b)) {\n+                    System.out.println(passed_output3);\n+                } else {\n+                    throw new RuntimeException(\"Failed: expected shared string with latin1-supplement chars.\");\n+                }\n@@ -72,4 +76,6 @@\n-            if (wb.areSharedStringsIgnored() || wb.isShared(b)) {\n-                System.out.println(passed_output4);\n-            } else {\n-                throw new RuntimeException(\"Failed: expected shared string with non-western chars.\");\n+            if (wb.areSharedStringsMapped()) {\n+                if (wb.isSharedInternedString(b)) {\n+                    System.out.println(passed_output4);\n+                } else {\n+                    throw new RuntimeException(\"Failed: expected shared string with non-western chars.\");\n+                }\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/sharedStrings\/InternStringTest.java","additions":19,"deletions":13,"binary":false,"changes":32,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -29,0 +29,1 @@\n+ * @requires vm.gc == null\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/sharedStrings\/LargePages.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -29,0 +29,1 @@\n+ * @requires vm.gc == null\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/sharedStrings\/LockSharedStrings.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -34,2 +34,2 @@\n-        if (wb.areSharedStringsIgnored()) {\n-            System.out.println(\"The shared strings are ignored\");\n+        if (!wb.areSharedStringsMapped()) {\n+            System.out.println(\"The shared strings are not mapped\");\n@@ -40,1 +40,1 @@\n-        if (!wb.isShared(LockStringTest.class)) {\n+        if (!wb.isSharedClass(LockStringTest.class)) {\n@@ -60,1 +60,1 @@\n-        if (!wb.isShared(lock)) {\n+        if (!wb.isSharedInternedString(lock)) {\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/sharedStrings\/LockStringTest.java","additions":5,"deletions":5,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -36,2 +36,2 @@\n-        if (wb.areSharedStringsIgnored()) {\n-            System.out.println(\"The shared strings are ignored\");\n+        if (!wb.areSharedStringsMapped()) {\n+            System.out.println(\"The shared strings are not mapped\");\n@@ -42,1 +42,1 @@\n-        if (!wb.isShared(s)) {\n+        if (!wb.isSharedInternedString(s)) {\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/sharedStrings\/LockStringValueTest.java","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -29,0 +29,1 @@\n+ * @requires vm.gc == null\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/sharedStrings\/SharedStringsBasicPlus.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -32,4 +32,6 @@\n-        if (wb.areSharedStringsIgnored() || wb.isShared(s)) {\n-            System.out.println(\"Found shared string.\");\n-        } else {\n-            throw new RuntimeException(\"String is not shared.\");\n+        if (wb.areSharedStringsMapped()) {\n+            if (wb.isSharedInternedString(s)) {\n+                System.out.println(\"Found shared string.\");\n+            } else {\n+                throw new RuntimeException(\"String is not shared.\");\n+            }\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/sharedStrings\/SharedStringsWb.java","additions":7,"deletions":5,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -29,0 +29,1 @@\n+ * @requires vm.gc == null\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/sharedStrings\/SharedStringsWbTest.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -30,0 +30,1 @@\n+ * @requires vm.gc == null\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/sharedStrings\/SysDictCrash.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -595,1 +595,2 @@\n-  public native boolean areSharedStringsIgnored();\n+  public native boolean areSharedStringsMapped();\n+  public native boolean isSharedInternedString(String s);\n","filename":"test\/lib\/sun\/hotspot\/WhiteBox.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"}]}