{"files":[{"patch":"@@ -557,1 +557,7 @@\n-       \"BOOLEAN\", false, \"false\") {\n+       \"BOOLEAN\", false, \"false\"),\n+  _parallel_thread_num(\"-parallel\",\n+       \"Number of parallel threads for heap iteration. \"\n+       \"0 means let the VM determine the number of threads. \"\n+       \"1 means use one thread, i.e. disable parallelism. \"\n+       \"n means use n threads. n must be positive.\",\n+       \"INT\", false, \"0\") {\n@@ -559,0 +565,1 @@\n+  _dcmdparser.add_dcmd_option(&_parallel_thread_num);\n@@ -562,0 +569,8 @@\n+  jlong num = _parallel_thread_num.value();\n+  if (num < 0) {\n+    output()->print_cr(\"Parallel thread number out of range (>=0): \" JLONG_FORMAT, num);\n+    return;\n+  }\n+  uint parallel_thread_num = num == 0\n+      ? MAX2<uint>(1, (uint)os::initial_active_processor_count() * 3 \/ 8)\n+      : num;\n@@ -563,1 +578,2 @@\n-                              !_all.value() \/* request full gc if false *\/);\n+                              !_all.value(), \/* request full gc if false *\/\n+                              parallel_thread_num);\n","filename":"src\/hotspot\/share\/services\/diagnosticCommand.cpp","additions":18,"deletions":2,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2011, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2011, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -360,0 +360,1 @@\n+  DCmdArgument<jlong> _parallel_thread_num;\n","filename":"src\/hotspot\/share\/services\/diagnosticCommand.hpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -1,41 +0,0 @@\n-\/*\n- * Copyright (c) 2015, 2017, Oracle and\/or its affiliates. All rights reserved.\n- * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n- *\n- * This code is free software; you can redistribute it and\/or modify it\n- * under the terms of the GNU General Public License version 2 only, as\n- * published by the Free Software Foundation.\n- *\n- * This code is distributed in the hope that it will be useful, but WITHOUT\n- * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n- * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n- * version 2 for more details (a copy is included in the LICENSE file that\n- * accompanied this code).\n- *\n- * You should have received a copy of the GNU General Public License version\n- * 2 along with this work; if not, write to the Free Software Foundation,\n- * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n- *\n- * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n- * or visit www.oracle.com if you need additional information or have any\n- * questions.\n- *\/\n-\n-\/*\n- * @test\n- * @summary Test of diagnostic command GC.class_histogram -all=true\n- * @library \/test\/lib\n- * @modules java.base\/jdk.internal.misc\n- *          java.compiler\n- *          java.management\n- *          jdk.internal.jvmstat\/sun.jvmstat.monitor\n- * @run testng ClassHistogramAllTest\n- *\/\n-public class ClassHistogramAllTest extends ClassHistogramTest {\n-    public ClassHistogramAllTest() {\n-        super();\n-        classHistogramArgs = \"-all=true\";\n-    }\n-\n-    \/* See ClassHistogramTest for test cases *\/\n-}\n","filename":"test\/hotspot\/jtreg\/serviceability\/dcmd\/gc\/ClassHistogramAllTest.java","additions":0,"deletions":41,"binary":false,"changes":41,"status":"deleted"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, 2017, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -24,0 +24,1 @@\n+import org.testng.annotations.DataProvider;\n@@ -45,1 +46,0 @@\n-    protected String classHistogramArgs = \"\";\n@@ -53,1 +53,1 @@\n-    public void run(CommandExecutor executor) {\n+    public void run(CommandExecutor executor, String classHistogramArgs, String expactedErrMsg) {\n@@ -55,0 +55,4 @@\n+        if (!expactedErrMsg.isEmpty()) {\n+            output.shouldMatch(expactedErrMsg);\n+            return;\n+        }\n@@ -90,3 +94,29 @@\n-    @Test\n-    public void jmx() {\n-        run(new JMXExecutor());\n+    @DataProvider(name=\"ArgsProvider\")\n+    private Object[][] getArgs() {\n+        String parallelErr = \"Parallel thread number out of range\";\n+        return new Object[][] {\n+                \/\/ valid args\n+                {\"\", \"\"},\n+                {\"-parallel=0\", \"\"},\n+                {\"-parallel=1\", \"\"},\n+                {\"-parallel=2\", \"\"},\n+                {\"-parallel=\"+Long.MAX_VALUE, \"\"},\n+                {\"-all=false -parallel=0\", \"\"},\n+                {\"-all=false -parallel=1\", \"\"},\n+                {\"-all=false -parallel=2\", \"\"},\n+                {\"-all=true\", \"\"},\n+                {\"-all=true -parallel=0\", \"\"},\n+                {\"-all=true -parallel=1\", \"\"},\n+                {\"-all=true -parallel=2\", \"\"},\n+                {\"-parallel=2 -all=true\", \"\"},\n+                \/\/ invalid args\n+                {\"-parallel=-1\", parallelErr},\n+                {\"-parallel=\"+Long.MIN_VALUE, parallelErr},\n+                {\"-all=false -parallel=-10\", parallelErr},\n+                {\"-all=true -parallel=-100\", parallelErr},\n+        };\n+    }\n+\n+    @Test(dataProvider=\"ArgsProvider\")\n+    public void jmx(String args, String expactedErrMsg) {\n+        run(new JMXExecutor(), args, expactedErrMsg);\n","filename":"test\/hotspot\/jtreg\/serviceability\/dcmd\/gc\/ClassHistogramTest.java","additions":36,"deletions":6,"binary":false,"changes":42,"status":"modified"}]}