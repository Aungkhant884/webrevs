{"files":[{"patch":"@@ -137,1 +137,1 @@\n-                                 name, mount_path, cg_infos[controller]._mount_path);\n+                               name, mount_path, cg_infos[controller]._mount_path);\n@@ -144,1 +144,1 @@\n-                                 name, cg_infos[controller]._mount_path, mount_path);\n+                               name, cg_infos[controller]._mount_path, mount_path);\n@@ -330,0 +330,17 @@\n+      \/\/ On some systems duplicate controllers get mounted in addition to\n+      \/\/ the main cgroup controllers most likely under \/sys\/fs\/cgroup. In that\n+      \/\/ case pick the first one under \/sys\/fs\/cgroup and discard others.\n+      if (cgroupv2_mount_point_found && strcmp(\"cgroup2\", tmp_fs_type) == 0) {\n+        if (strstr(cg_infos[0]._mount_path, \"\/sys\/fs\/cgroup\") != cg_infos[0]._mount_path &&\n+            strstr(tmp_mount_point, \"\/sys\/fs\/cgroup\") == tmp_mount_point) {\n+          log_debug(os, container)(\"Duplicate cgroupv2 controllers detected. Picking %s, skipping %s.\",\n+                                   tmp_mount_point, cg_infos[0]._mount_path);\n+          for (int i = 0; i < CG_INFO_LENGTH; i++) {\n+            os::free(cg_infos[i]._mount_path);\n+            cg_infos[i]._mount_path = os::strdup(tmp_mount_point);\n+          }\n+        } else {\n+          log_debug(os, container)(\"Duplicate cgroupv2 controllers detected. Picking %s, skipping %s.\",\n+                                   cg_infos[0]._mount_path, tmp_mount_point);\n+        }\n+      }\n","filename":"src\/hotspot\/os\/linux\/cgroupSubsystem_linux.cpp","additions":19,"deletions":2,"binary":false,"changes":21,"status":"modified"},{"patch":"@@ -65,0 +65,2 @@\n+    private Path cgroupv2MntInfoDouble;\n+    private Path cgroupv2MntInfoDouble2;\n@@ -193,1 +195,5 @@\n-            \"28 21 0:25 \/ \/sys\/fs\/cgroup rw,nosuid,nodev,noexec,relatime shared:4 - cgroup2 none rw,seclabel,nsdelegate\";\n+            \"28 21 0:25 \/ \/sys\/fs\/cgroup rw,nosuid,nodev,noexec,relatime shared:4 - cgroup2 none rw,seclabel,nsdelegate\\n\";\n+    private String mntInfoCgroupsV2MoreLine =\n+            \"240 232 0:24 \/..\/.. \/cgroup-in ro,relatime - cgroup2 cgroup2 rw,nsdelegate\\n\";\n+    private String mntInfoCgroupsV2Double = mntInfoCgroupsV2MoreLine + mntInfoCgroupsV2Only;\n+    private String mntInfoCgroupsV2Double2 = mntInfoCgroupsV2Only + mntInfoCgroupsV2MoreLine;\n@@ -235,0 +241,6 @@\n+            cgroupv2MntInfoDouble = Paths.get(existingDirectory.toString(), \"mountinfo_cgroupv2_double\");\n+            Files.writeString(cgroupv2MntInfoDouble, mntInfoCgroupsV2Double);\n+\n+            cgroupv2MntInfoDouble2 = Paths.get(existingDirectory.toString(), \"mountinfo_cgroupv2_double2\");\n+            Files.writeString(cgroupv2MntInfoDouble2, mntInfoCgroupsV2Double2);\n+\n@@ -377,1 +389,1 @@\n-    public void testCgroupv2(WhiteBox wb) {\n+    public void testCgroupv2(WhiteBox wb, Path mountInfo) {\n@@ -380,1 +392,1 @@\n-        String procSelfMountinfo = cgroupv2MntInfoZeroHierarchy.toString();\n+        String procSelfMountinfo = mountInfo.toString();\n@@ -424,1 +436,3 @@\n-            test.testCgroupv2(wb);\n+            test.testCgroupv2(wb, test.cgroupv2MntInfoZeroHierarchy);\n+            test.testCgroupv2(wb, test.cgroupv2MntInfoDouble);\n+            test.testCgroupv2(wb, test.cgroupv2MntInfoDouble2);\n","filename":"test\/hotspot\/jtreg\/containers\/cgroup\/CgroupSubsystemFactory.java","additions":18,"deletions":4,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -90,1 +90,0 @@\n-            .addJavaOpts(\"-Xlog:os+container=trace\")\n@@ -95,8 +94,1 @@\n-            .shouldContain(\"[debug][os,container] Duplicate memory controllers detected. Picking \/sys\/fs\/cgroup\/memory, skipping \/cgroups-in\/memory\")\n-            .shouldContain(\"[debug][os,container] Duplicate cpu controllers detected. Picking \/sys\/fs\/cgroup\/cpu,cpuacct, skipping \/cgroups-in\/cpu,cpuacct\")\n-            .shouldContain(\"[debug][os,container] Duplicate cpuacct controllers detected. Picking \/sys\/fs\/cgroup\/cpu,cpuacct, skipping \/cgroups-in\/cpu,cpuacct\")\n-            .shouldContain(\"[debug][os,container] Duplicate cpuset controllers detected. Picking \/sys\/fs\/cgroup\/cpuset, skipping \/cgroups-in\/cpuset\")\n-            .shouldContain(\"[debug][os,container] Duplicate pids controllers detected. Picking \/sys\/fs\/cgroup\/pids, skipping \/cgroups-in\/pids\")\n-            .shouldContain(\"Path to \/cpu.cfs_quota_us is \/sys\/fs\/cgroup\/cpu,cpuacct\/cpu.cfs_quota_us\")\n-            .shouldContain(\"Path to \/cpu.cfs_period_us is \/sys\/fs\/cgroup\/cpu,cpuacct\/cpu.cfs_period_us\")\n-            .shouldContain(\"Path to \/memory.limit_in_bytes is \/sys\/fs\/cgroup\/memory\/memory.limit_in_bytes\");\n+            .shouldNotContain(\"[os,container]\");\n","filename":"test\/hotspot\/jtreg\/containers\/docker\/DockerBasicTest.java","additions":1,"deletions":9,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -73,4 +73,8 @@\n-            testCpuQuotaAndPeriod(50*1000, 100*1000);\n-            testCpuQuotaAndPeriod(100*1000, 100*1000);\n-            testCpuQuotaAndPeriod(150*1000, 100*1000);\n-            testCpuQuotaAndPeriod(400*1000, 100*1000);\n+            testCpuQuotaAndPeriod(50*1000, 100*1000, false);\n+            testCpuQuotaAndPeriod(100*1000, 100*1000, false);\n+            testCpuQuotaAndPeriod(150*1000, 100*1000, false);\n+            testCpuQuotaAndPeriod(400*1000, 100*1000, false);\n+            testCpuQuotaAndPeriod(50*1000, 100*1000, true);\n+            testCpuQuotaAndPeriod(100*1000, 100*1000, true);\n+            testCpuQuotaAndPeriod(150*1000, 100*1000, true);\n+            testCpuQuotaAndPeriod(400*1000, 100*1000, true);\n@@ -156,1 +160,1 @@\n-    private static void testCpuQuotaAndPeriod(int quota, int period)\n+    private static void testCpuQuotaAndPeriod(int quota, int period, boolean addCgmounts)\n@@ -170,0 +174,4 @@\n+        if (addCgmounts) {\n+            opts = opts.addDockerOpts(\"--volume\", \"\/sys\/fs\/cgroup:\/cgroups-in:ro\");\n+        }\n+\n@@ -176,1 +184,0 @@\n-\n","filename":"test\/hotspot\/jtreg\/containers\/docker\/TestCPUAwareness.java","additions":13,"deletions":6,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -66,4 +66,9 @@\n-            testMemoryLimit(\"100m\", \"104857600\");\n-            testMemoryLimit(\"500m\", \"524288000\");\n-            testMemoryLimit(\"1g\", \"1073741824\");\n-            testMemoryLimit(\"4g\", \"4294967296\");\n+            testMemoryLimit(\"100m\", \"104857600\", false);\n+            testMemoryLimit(\"500m\", \"524288000\", false);\n+            testMemoryLimit(\"1g\", \"1073741824\", false);\n+            testMemoryLimit(\"4g\", \"4294967296\", false);\n+            testMemoryLimit(\"100m\", \"104857600\", true);\n+            testMemoryLimit(\"500m\", \"524288000\", true);\n+            testMemoryLimit(\"1g\", \"1073741824\", true);\n+            testMemoryLimit(\"4g\", \"4294967296\", true);\n+\n@@ -101,1 +106,1 @@\n-    private static void testMemoryLimit(String valueToSet, String expectedTraceValue)\n+    private static void testMemoryLimit(String valueToSet, String expectedTraceValue, boolean addCgmounts)\n@@ -109,0 +114,4 @@\n+        if (addCgmounts) {\n+            opts = opts.addDockerOpts(\"--volume\", \"\/sys\/fs\/cgroup:\/cgroups-in:ro\");\n+        }\n+\n","filename":"test\/hotspot\/jtreg\/containers\/docker\/TestMemoryAwareness.java","additions":14,"deletions":5,"binary":false,"changes":19,"status":"modified"}]}