{"files":[{"patch":"@@ -126,0 +126,22 @@\n+void CgroupSubsystemFactory::set_controller_mount_path(CgroupInfo* cg_infos,\n+                                                       int controller,\n+                                                       char* name,\n+                                                       char* mount_path) {\n+  if (cg_infos[controller]._mount_path != NULL) {\n+    \/\/ On some systems duplicate controllers get mounted in addition to\n+    \/\/ the main cgroup controllers most likely under \/sys\/fs\/cgroup. In that\n+    \/\/ case pick the one under \/sys\/fs\/cgroup and discard others.\n+    if (strstr(cg_infos[controller]._mount_path, \"\/sys\/fs\/cgroup\") != cg_infos[controller]._mount_path) {\n+      log_warning(os, container)(\"Duplicate %s controllers detected. Picking %s, skipping %s.\",\n+                                 name, mount_path, cg_infos[controller]._mount_path);\n+      os::free(cg_infos[controller]._mount_path);\n+      cg_infos[controller]._mount_path = os::strdup(mount_path);\n+    } else {\n+      log_warning(os, container)(\"Duplicate %s controllers detected. Picking %s, skipping %s.\",\n+                                 name, cg_infos[controller]._mount_path, mount_path);\n+    }\n+  } else {\n+    cg_infos[controller]._mount_path = os::strdup(mount_path);\n+  }\n+}\n+\n@@ -335,2 +357,1 @@\n-          assert(cg_infos[MEMORY_IDX]._mount_path == NULL, \"stomping of _mount_path\");\n-          cg_infos[MEMORY_IDX]._mount_path = os::strdup(tmpmount);\n+          set_controller_mount_path(cg_infos, MEMORY_IDX, token, tmpmount);\n@@ -341,16 +362,1 @@\n-          if (cg_infos[CPUSET_IDX]._mount_path != NULL) {\n-            \/\/ On some systems duplicate cpuset controllers get mounted in addition to\n-            \/\/ the main cgroup controllers most likely under \/sys\/fs\/cgroup. In that\n-            \/\/ case pick the one under \/sys\/fs\/cgroup and discard others.\n-            if (strstr(cg_infos[CPUSET_IDX]._mount_path, \"\/sys\/fs\/cgroup\") != cg_infos[CPUSET_IDX]._mount_path) {\n-              log_warning(os, container)(\"Duplicate cpuset controllers detected. Picking %s, skipping %s.\",\n-                                         tmpmount, cg_infos[CPUSET_IDX]._mount_path);\n-              os::free(cg_infos[CPUSET_IDX]._mount_path);\n-              cg_infos[CPUSET_IDX]._mount_path = os::strdup(tmpmount);\n-            } else {\n-              log_warning(os, container)(\"Duplicate cpuset controllers detected. Picking %s, skipping %s.\",\n-                                         cg_infos[CPUSET_IDX]._mount_path, tmpmount);\n-            }\n-          } else {\n-            cg_infos[CPUSET_IDX]._mount_path = os::strdup(tmpmount);\n-          }\n+          set_controller_mount_path(cg_infos, CPUSET_IDX, token, tmpmount);\n@@ -361,1 +367,1 @@\n-          assert(cg_infos[CPU_IDX]._mount_path == NULL, \"stomping of _mount_path\");\n+          set_controller_mount_path(cg_infos, CPU_IDX, token, tmpmount);\n@@ -367,2 +373,1 @@\n-          assert(cg_infos[CPUACCT_IDX]._mount_path == NULL, \"stomping of _mount_path\");\n-          cg_infos[CPUACCT_IDX]._mount_path = os::strdup(tmpmount);\n+          set_controller_mount_path(cg_infos, CPUACCT_IDX, token, tmpmount);\n@@ -373,2 +378,1 @@\n-          assert(cg_infos[PIDS_IDX]._mount_path == NULL, \"stomping of _mount_path\");\n-          cg_infos[PIDS_IDX]._mount_path = os::strdup(tmpmount);\n+          set_controller_mount_path(cg_infos, PIDS_IDX, token, tmpmount);\n","filename":"src\/hotspot\/os\/linux\/cgroupSubsystem_linux.cpp","additions":27,"deletions":23,"binary":false,"changes":50,"status":"modified"},{"patch":"@@ -314,0 +314,4 @@\n+    static void set_controller_mount_path(CgroupInfo* cg_infos,\n+                                          int controller,\n+                                          char* name,\n+                                          char* mount_path);\n","filename":"src\/hotspot\/os\/linux\/cgroupSubsystem_linux.hpp","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -70,0 +70,6 @@\n+    private Path cgroupv1MntInfoDoubleMemory;\n+    private Path cgroupv1MntInfoDoubleMemory2;\n+    private Path cgroupv1MntInfoDoubleCpu;\n+    private Path cgroupv1MntInfoDoubleCpu2;\n+    private Path cgroupv1MntInfoDoublePids;\n+    private Path cgroupv1MntInfoDoublePids2;\n@@ -163,0 +169,9 @@\n+    private String mntInfoCgroupv1MoreMemoryLine = \"1100 1098 0:28 \/ \/memory rw,nosuid,nodev,noexec,relatime master:6 - cgroup cgroup rw,memory\\n\";\n+    private String mntInfoCgroupv1DoubleMemory = mntInfoCgroupv1MoreMemoryLine + mntInfoHybrid;\n+    private String mntInfoCgroupv1DoubleMemory2 = mntInfoHybrid + mntInfoCgroupv1MoreMemoryLine;\n+    private String mntInfoCgroupv1DoubleCpuLine = \"1101 1098 0:29 \/ \/cpu,cpuacct rw,nosuid,nodev,noexec,relatime master:7 - cgroup cgroup rw,cpu,cpuacct\\n\";\n+    private String mntInfoCgroupv1DoubleCpu = mntInfoCgroupv1DoubleCpuLine + mntInfoHybrid;\n+    private String mntInfoCgroupv1DoubleCpu2 = mntInfoHybrid + mntInfoCgroupv1DoubleCpuLine;\n+    private String mntInfoCgroupv1DoublePidsLine = \"1107 1098 0:35 \/ \/pids rw,nosuid,nodev,noexec,relatime master:13 - cgroup cgroup rw,pids\\n\";\n+    private String mntInfoCgroupv1DoublePids = mntInfoCgroupv1DoublePidsLine + mntInfoHybrid;\n+    private String mntInfoCgroupv1DoublePids2 = mntInfoHybrid + mntInfoCgroupv1DoublePidsLine;\n@@ -247,0 +262,18 @@\n+            cgroupv1MntInfoDoubleMemory = Paths.get(existingDirectory.toString(), \"mnt_info_cgroupv1_double_memory\");\n+            Files.writeString(cgroupv1MntInfoDoubleMemory, mntInfoCgroupv1DoubleMemory);\n+\n+            cgroupv1MntInfoDoubleMemory2 = Paths.get(existingDirectory.toString(), \"mnt_info_cgroupv1_double_memory2\");\n+            Files.writeString(cgroupv1MntInfoDoubleMemory2, mntInfoCgroupv1DoubleMemory2);\n+\n+            cgroupv1MntInfoDoubleCpu = Paths.get(existingDirectory.toString(), \"mnt_info_cgroupv1_double_cpu\");\n+            Files.writeString(cgroupv1MntInfoDoubleCpu, mntInfoCgroupv1DoubleCpu);\n+\n+            cgroupv1MntInfoDoubleCpu2 = Paths.get(existingDirectory.toString(), \"mnt_info_cgroupv1_double_cpu2\");\n+            Files.writeString(cgroupv1MntInfoDoubleCpu2, mntInfoCgroupv1DoubleCpu2);\n+\n+            cgroupv1MntInfoDoublePids = Paths.get(existingDirectory.toString(), \"mnt_info_cgroupv1_double_pids\");\n+            Files.writeString(cgroupv1MntInfoDoublePids, mntInfoCgroupv1DoublePids);\n+\n+            cgroupv1MntInfoDoublePids2 = Paths.get(existingDirectory.toString(), \"mnt_info_cgroupv1_double_pids2\");\n+            Files.writeString(cgroupv1MntInfoDoublePids2, mntInfoCgroupv1DoublePids2);\n+\n@@ -294,1 +327,1 @@\n-    public void testCgroupv1MultipleCpusetMounts(WhiteBox wb, Path mountInfo) {\n+    public void testCgroupv1MultipleControllerMounts(WhiteBox wb, Path mountInfo) {\n@@ -299,1 +332,1 @@\n-        Asserts.assertEQ(CGROUPS_V1, retval, \"Multiple cpuset controllers, but only one in \/sys\/fs\/cgroup\");\n+        Asserts.assertEQ(CGROUPS_V1, retval, \"Multiple controllers, but only one in \/sys\/fs\/cgroup\");\n@@ -301,1 +334,1 @@\n-        System.out.println(\"testCgroupv1MultipleCpusetMounts PASSED!\");\n+        System.out.println(\"testCgroupv1MultipleControllerMounts PASSED!\");\n@@ -396,2 +429,8 @@\n-            test.testCgroupv1MultipleCpusetMounts(wb, test.cgroupv1MntInfoDoubleCpuset);\n-            test.testCgroupv1MultipleCpusetMounts(wb, test.cgroupv1MntInfoDoubleCpuset2);\n+            test.testCgroupv1MultipleControllerMounts(wb, test.cgroupv1MntInfoDoubleCpuset);\n+            test.testCgroupv1MultipleControllerMounts(wb, test.cgroupv1MntInfoDoubleCpuset2);\n+            test.testCgroupv1MultipleControllerMounts(wb, test.cgroupv1MntInfoDoubleMemory);\n+            test.testCgroupv1MultipleControllerMounts(wb, test.cgroupv1MntInfoDoubleMemory2);\n+            test.testCgroupv1MultipleControllerMounts(wb, test.cgroupv1MntInfoDoubleCpu);\n+            test.testCgroupv1MultipleControllerMounts(wb, test.cgroupv1MntInfoDoubleCpu2);\n+            test.testCgroupv1MultipleControllerMounts(wb, test.cgroupv1MntInfoDoublePids);\n+            test.testCgroupv1MultipleControllerMounts(wb, test.cgroupv1MntInfoDoublePids2);\n","filename":"test\/hotspot\/jtreg\/containers\/cgroup\/CgroupSubsystemFactory.java","additions":44,"deletions":5,"binary":false,"changes":49,"status":"modified"}]}