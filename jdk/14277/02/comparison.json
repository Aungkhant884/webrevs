{"files":[{"patch":"@@ -29,0 +29,3 @@\n+import java.net.URL;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n@@ -31,0 +34,1 @@\n+import java.util.stream.Stream;\n@@ -32,1 +36,0 @@\n-import java.net.URL;\n@@ -99,0 +102,1 @@\n+        String extraPropDir, extraPropFile = null;\n@@ -107,0 +111,1 @@\n+        extraPropDir = props.getProperty(\"security.propertiesDir\");\n@@ -111,2 +116,9 @@\n-            String extraPropFile = System.getProperty\n-                    (\"java.security.properties\");\n+            String propDir = System.getProperty(\"java.security.propertiesDir\");\n+            \/\/ Command-line property directories take precedence over\n+            \/\/ those in java.security. This can also be used to disable\n+            \/\/ the property directory if set to the empty string.\n+            if (propDir != null) {\n+                extraPropDir = propDir;\n+            }\n+\n+            extraPropFile = System.getProperty(\"java.security.properties\");\n@@ -117,0 +129,27 @@\n+        }\n+\n+        if (extraPropDir != null && !extraPropDir.isBlank()) {\n+            if (sdebug != null ) {\n+                sdebug.println(\"searching for property files in \" + extraPropDir);\n+            }\n+            Stream<Path> stream = null;\n+            try {\n+                extraPropDir = PropertyExpander.expand(extraPropDir);\n+                stream = Files.find(Path.of(extraPropDir), Integer.MAX_VALUE,\n+                                    ((path, attrs) -> attrs.isRegularFile() &&\n+                                                      !path.toFile().isHidden()));\n+                stream.sorted().forEach((file) -> loadProps(null, file.toString(), false));\n+            } catch (IOException | PropertyExpander.ExpandException e) {\n+                if (sdebug != null) {\n+                    sdebug.println(\"unable to load security properties from \" +\n+                                   extraPropDir);\n+                    e.printStackTrace();\n+                }\n+            } finally {\n+                if (stream != null) {\n+                    stream.close();\n+                }\n+            }\n+        }\n+\n+        if (extraPropFile != null) {\n","filename":"src\/java.base\/share\/classes\/java\/security\/Security.java","additions":42,"deletions":3,"binary":false,"changes":45,"status":"modified"},{"patch":"@@ -14,0 +14,25 @@\n+# A directory tree of such property files may also be specified from\n+# the command line via the system property\n+#\n+#    -Djava.security.propertiesDir=<PATH>\n+#\n+# Each file found within this tree is appended, as with the single file\n+# above, in lexicographic order of the file paths. Only regular non-hidden\n+# files are considered. If the same property occurs in a file later in the\n+# ordering, it will override the previous value of that property. For example,\n+# a property 'x' defined in both '01-props' and '02-props' will assume\n+# the value used in '02-props'.\n+#\n+# If both system properties are specified, all properties found in the\n+# directory, followed by those in the single file, will be appended.\n+# The overall effect is thus as if the single file occurred last\n+# lexicographically in the directory and so any properties specified\n+# in that single file will override definitions from the files in\n+# the directory.\n+#\n+# A directory may also be specified permanently in this file using\n+# the security.propertiesDir property. Any directory specified on\n+# the command line takes precedence over the directory listed in this\n+# file. Using an empty value on the command line allows a directory\n+# specified in this file to be disabled.\n+#\n@@ -19,1 +44,1 @@\n-# properties file.\n+# properties file and any properties in a specified directory.\n@@ -21,1 +46,1 @@\n-# To disable the ability to specify an additional properties file from\n+# To disable the ability to specify additional properties from\n@@ -335,0 +360,6 @@\n+#\n+# Determines whether this properties file will be supplemented\n+# by additional property files found in the given directory\n+#\n+security.propertiesDir=\n+\n","filename":"src\/java.base\/share\/conf\/security\/java.security","additions":33,"deletions":2,"binary":false,"changes":35,"status":"modified"},{"patch":"@@ -38,2 +38,2 @@\n- * @summary Throw error if default java.security file is missing\n- * @bug 8155246 8292297 8292177 8281658\n+ * @summary Exercise use, absence and extension of java.security\n+ * @bug 8155246 8281658 8292177 8292297 8309330\n@@ -55,0 +55,1 @@\n+        Path secPropDir = Path.of(\".\/jdk-8309330-tmpdir\");\n@@ -59,0 +60,2 @@\n+        Path javaSecurity = Path.of(copyJdkDir.toString(), \"conf\",\n+                                    \"security\",\"java.security\");\n@@ -65,0 +68,15 @@\n+            if (\"propDir\".equals(args[0])) {\n+                System.out.println(\"testProp3=\" + Security.getProperty(\"testProp3\"));\n+            }\n+            if (\"propDirDisabled\".equals(args[0])) {\n+                \/\/ In this configuration, the directory properties should not be present\n+                if (Security.getProperty(\"testProp3\") != null) {\n+                    System.exit(1);\n+                }\n+            }\n+            if (\"propDirNoHidden\".equals(args[0])) {\n+                \/\/ Properties listed in hidden files should not be registered\n+                if (Security.getProperty(\"testProp4\") != null) {\n+                    System.exit(1);\n+                }\n+            }\n@@ -67,0 +85,1 @@\n+            Files.createDirectory(secPropDir);\n@@ -72,0 +91,1 @@\n+            populateSecPropDir(secPropDir);\n@@ -99,0 +119,56 @@\n+            \/\/ test JDK launch with customized properties dir on the command line\n+            exerciseSecurity(0, \"testProp3=cherry\",\n+                    copiedJava.toString(), \"-cp\", System.getProperty(\"test.classes\"),\n+                    \"-Djava.security.debug=all\", \"-Djavax.net.debug=all\",\n+                    \"-Djava.security.propertiesDir=\" + secPropDir.toString(),\n+                    \"ConfigFileTest\", \"propDir\");\n+\n+            \/\/ enable properties directory in java.security\n+            Files.writeString(javaSecurity,\n+                              \"security.propertiesDir=\" + secPropDir.toAbsolutePath().toString(),\n+                              StandardOpenOption.APPEND);\n+\n+            \/\/ test JDK launch with customized properties dir in java.security\n+            exerciseSecurity(0, \"testProp3=cherry\",\n+                    copiedJava.toString(), \"-cp\", System.getProperty(\"test.classes\"),\n+                    \"-Djava.security.debug=all\", \"-Djavax.net.debug=all\",\n+                    \"ConfigFileTest\", \"propDir\");\n+\n+            \/\/ test JDK launch with customized properties dir in java.security disabled\n+            exerciseSecurity(0, \"SUN version\",\n+                    copiedJava.toString(), \"-cp\", System.getProperty(\"test.classes\"),\n+                    \"-Djava.security.debug=all\", \"-Djavax.net.debug=all\",\n+                    \"-Djava.security.propertiesDir=\",\n+                    \"ConfigFileTest\", \"propDirDisabled\");\n+\n+            \/\/ test JDK launch with customized properties file overriding properties dir\n+            exerciseSecurity(0, \"NumProviders: 6\",\n+                    copiedJava.toString(), \"-cp\", System.getProperty(\"test.classes\"),\n+                    \"-Djava.security.debug=all\", \"-Djavax.net.debug=all\",\n+                    \"-Djava.security.properties==file:\/\/\/\" + extraPropsFile,\n+                    \"ConfigFileTest\", \"propDirDisabled\");\n+\n+            \/\/ test JDK launch with customized properties file appended to properties dir\n+            exerciseSecurity(0, \"testProp3=cherry\",\n+                    copiedJava.toString(), \"-cp\", System.getProperty(\"test.classes\"),\n+                    \"-Djava.security.debug=all\", \"-Djavax.net.debug=all\",\n+                    \"-Djava.security.properties=file:\/\/\/\" + extraPropsFile,\n+                    \"ConfigFileTest\", \"propDir\");\n+\n+            \/\/ test that hidden property files are ignored\n+            addHiddenFile(secPropDir);\n+            exerciseSecurity(0, \"testProp3=cherry\",\n+                    copiedJava.toString(), \"-cp\", System.getProperty(\"test.classes\"),\n+                    \"-Djava.security.debug=all\", \"-Djavax.net.debug=all\",\n+                    \"-Djava.security.properties=file:\/\/\/\" + extraPropsFile,\n+                    \"ConfigFileTest\", \"propDirNoHidden\");\n+\n+            \/\/ test that property files that occur lexicographically later\n+            \/\/ override properties in earlier files\n+            addOverrideFile(secPropDir);\n+            exerciseSecurity(0, \"testProp3=cabbage\",\n+                    copiedJava.toString(), \"-cp\", System.getProperty(\"test.classes\"),\n+                    \"-Djava.security.debug=all\", \"-Djavax.net.debug=all\",\n+                    \"-Djava.security.properties=file:\/\/\/\" + extraPropsFile,\n+                    \"ConfigFileTest\", \"propDir\");\n+\n@@ -100,2 +176,1 @@\n-            Files.delete(Path.of(copyJdkDir.toString(), \"conf\",\n-                    \"security\",\"java.security\"));\n+            Files.delete(javaSecurity);\n@@ -164,0 +239,16 @@\n+\n+    private static void populateSecPropDir(Path dir) throws Exception {\n+        Files.writeString(dir.resolve(\"01-testFile\"), \"testProp1=apple\");\n+        Files.writeString(dir.resolve(\"02-testFile\"), \"testProp2=banana\");\n+        Path extraDir = dir.resolve(\"03-testDir\");\n+        Files.createDirectory(extraDir);\n+        Files.writeString(extraDir.resolve(\"extra\"), \"testProp3=cherry\");\n+    }\n+\n+    private static void addHiddenFile(Path dir) throws Exception {\n+        Files.writeString(dir.resolve(\".04-testFile\"), \"testProp4=diamond\");\n+    }\n+\n+    private static void addOverrideFile(Path dir) throws Exception {\n+        Files.writeString(dir.resolve(\"05-testFile\"), \"testProp3=cabbage\");\n+    }\n","filename":"test\/jdk\/java\/security\/Security\/ConfigFileTest.java","additions":95,"deletions":4,"binary":false,"changes":99,"status":"modified"}]}