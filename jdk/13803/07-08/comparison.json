{"files":[{"patch":"@@ -130,1 +130,0 @@\n-\n","filename":"src\/java.desktop\/share\/classes\/java\/awt\/peer\/RobotPeer.java","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -47,0 +47,1 @@\n+    private static final int ERROR = -1;\n@@ -48,0 +49,1 @@\n+    private static final int OUT_OF_BOUNDS = -12;\n@@ -113,2 +115,2 @@\n-            System.out.println(\"\/\/ getRGBPixels affectedScreenBounds \"\n-                    + affectedScreenBounds);\n+            System.out.printf(\"\/\/ getRGBPixels in %s, affectedScreenBounds %s\\n\",\n+                    captureArea, affectedScreenBounds);\n@@ -148,1 +150,3 @@\n-            }\n+            } else if (!checkReturnValue(retVal)) {\n+                return;\n+            } \/\/ else, try other tokens\n@@ -160,0 +164,4 @@\n+        checkReturnValue(retVal);\n+    }\n+\n+    private static boolean checkReturnValue(int retVal) {\n@@ -161,0 +169,1 @@\n+            \/\/ user explicitly denied the capture, no more tries.\n@@ -164,0 +173,9 @@\n+        } else if (retVal == ERROR) {\n+            if (SCREENCAST_DEBUG) {\n+                System.err.println(\"Screen capture failed.\");\n+            }\n+        } else if (retVal == OUT_OF_BOUNDS) {\n+            if (SCREENCAST_DEBUG) {\n+                System.err.println(\n+                        \"Token does not provide access to requested area.\");\n+            }\n@@ -165,0 +183,1 @@\n+        return retVal != ERROR;\n","filename":"src\/java.desktop\/unix\/classes\/sun\/awt\/screencast\/ScreencastHelper.java","additions":22,"deletions":3,"binary":false,"changes":25,"status":"modified"},{"patch":"@@ -88,1 +88,1 @@\n-        \/\/This check is very formal, in order to filter out abnormal values\n+        \/\/This check is very rough, in order to filter out abnormal values\n","filename":"src\/java.desktop\/unix\/classes\/sun\/awt\/screencast\/TokenItem.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -30,0 +30,2 @@\n+import java.io.BufferedReader;\n+import java.io.BufferedWriter;\n@@ -31,2 +33,0 @@\n-import java.io.InputStream;\n-import java.io.OutputStream;\n@@ -61,1 +61,1 @@\n-            \".java\/.robot\/screencast-tokens.properties\";\n+            \".java\/robot\/screencast-tokens.properties\";\n@@ -66,1 +66,0 @@\n-    private static final Object PROPS_LOCK = new Object();\n@@ -192,1 +191,1 @@\n-                        synchronized (PROPS_LOCK) {\n+                        synchronized (PROPS) {\n@@ -243,1 +242,1 @@\n-        synchronized (PROPS_LOCK) {\n+        synchronized (PROPS) {\n@@ -280,2 +279,2 @@\n-        try (InputStream input = Files.newInputStream(path)) {\n-            synchronized (PROPS_LOCK) {\n+        try (BufferedReader reader = Files.newBufferedReader(path)) {\n+            synchronized (PROPS) {\n@@ -283,1 +282,1 @@\n-                PROPS.load(input);\n+                PROPS.load(reader);\n@@ -304,1 +303,1 @@\n-        synchronized (PROPS_LOCK) {\n+        synchronized (PROPS) {\n@@ -370,1 +369,1 @@\n-        synchronized (PROPS_LOCK) {\n+        synchronized (PROPS) {\n@@ -387,8 +386,8 @@\n-        try (OutputStream output = Files.newOutputStream(PROPS_PATH)) {\n-            synchronized (PROPS_LOCK) {\n-                PROPS.store(output, null);\n-            }\n-        } catch (IOException e) {\n-            if (SCREENCAST_DEBUG) {\n-                System.err.printf(\n-                        \"Token storage: unable to %s\\n%s\\n\", failMsg, e);\n+        synchronized (PROPS) {\n+            try (BufferedWriter writer = Files.newBufferedWriter(PROPS_PATH)) {\n+                PROPS.store(writer, null);\n+            } catch (IOException e) {\n+                if (SCREENCAST_DEBUG) {\n+                    System.err.printf(\n+                            \"Token storage: unable to %s\\n%s\\n\", failMsg, e);\n+                }\n","filename":"src\/java.desktop\/unix\/classes\/sun\/awt\/screencast\/TokenStorage.java","additions":18,"deletions":19,"binary":false,"changes":37,"status":"modified"},{"patch":"@@ -42,1 +42,1 @@\n-#define EXCEPTION_CHECK_DESCRIBE_CLEAR() if ((*env)->ExceptionCheck(env)) { \\\n+#define EXCEPTION_CHECK_DESCRIBE() if ((*env)->ExceptionCheck(env)) { \\\n@@ -44,1 +44,0 @@\n-                                            (*env)->ExceptionClear(env);    \\\n@@ -131,1 +130,1 @@\n-    pw.pwFd = -1;\n+    pw.pwFd = RESULT_ERROR;\n@@ -256,1 +255,1 @@\n-        DEBUG_SCREEN_PREFIX(screen, \"⚠ out of buffers\\n\", NULL);\n+        DEBUG_SCREEN_PREFIX(screen, \"!!! out of buffers\\n\", NULL);\n@@ -264,1 +263,1 @@\n-        DEBUG_SCREEN_PREFIX(screen, \"⚠ no data, n_datas %d\\n\",\n+        DEBUG_SCREEN_PREFIX(screen, \"!!! no data, n_datas %d\\n\",\n@@ -375,1 +374,1 @@\n-        DEBUG_SCREENCAST(\"⚠ Wrong index for screen\\n\", NULL);\n+        DEBUG_SCREENCAST(\"!!! Wrong index for screen\\n\", NULL);\n@@ -399,1 +398,1 @@\n-                            \"⚠ Could not create a pipewire stream\\n\", NULL);\n+                            \"!!! Could not create a pipewire stream\\n\", NULL);\n@@ -415,1 +414,1 @@\n-                            \"⚠ Could not start a pipewire stream\\n\", NULL);\n+                            \"!!! Could not start a pipewire stream\\n\", NULL);\n@@ -439,1 +438,1 @@\n-        DEBUG_SCREENCAST(\"⚠ Wrong index for screen %i >= %i\\n\",\n+        DEBUG_SCREENCAST(\"!!! Wrong index for screen %i >= %i\\n\",\n@@ -485,1 +484,1 @@\n-            \"⚠ pipewire error: id %u, seq: %d, res: %d (%s): %s\\n\",\n+            \"!!! pipewire error: id %u, seq: %d, res: %d (%s): %s\\n\",\n@@ -505,1 +504,1 @@\n-        DEBUG_SCREENCAST(\"⚠ Could not create a loop\\n\", NULL);\n+        DEBUG_SCREENCAST(\"!!! Could not create a loop\\n\", NULL);\n@@ -517,1 +516,1 @@\n-        DEBUG_SCREENCAST(\"⚠ Could not create a pipewire context\\n\", NULL);\n+        DEBUG_SCREENCAST(\"!!! Could not create a pipewire context\\n\", NULL);\n@@ -523,1 +522,1 @@\n-        DEBUG_SCREENCAST(\"⚠ Could not start pipewire thread loop\\n\", NULL);\n+        DEBUG_SCREENCAST(\"!!! Could not start pipewire thread loop\\n\", NULL);\n@@ -538,1 +537,1 @@\n-        DEBUG_SCREENCAST(\"⚠ Could not create pipewire core\\n\", NULL);\n+        DEBUG_SCREENCAST(\"!!! Could not create pipewire core\\n\", NULL);\n@@ -597,1 +596,1 @@\n-       debug_screencast(\"⚠ %s:%i error loading dl_symbol %s\\n\",     \\\n+       debug_screencast(\"!!! %s:%i error loading dl_symbol %s\\n\",   \\\n@@ -658,1 +657,1 @@\n-            EXCEPTION_CHECK_DESCRIBE_CLEAR();\n+            EXCEPTION_CHECK_DESCRIBE();\n@@ -664,1 +663,1 @@\n-        EXCEPTION_CHECK_DESCRIBE_CLEAR();\n+        EXCEPTION_CHECK_DESCRIBE();\n@@ -673,1 +672,1 @@\n-            EXCEPTION_CHECK_DESCRIBE_CLEAR();\n+            EXCEPTION_CHECK_DESCRIBE();\n@@ -679,1 +678,1 @@\n-            EXCEPTION_CHECK_DESCRIBE_CLEAR();\n+            EXCEPTION_CHECK_DESCRIBE();\n@@ -702,1 +701,1 @@\n-            EXCEPTION_CHECK_DESCRIBE_CLEAR();\n+            EXCEPTION_CHECK_DESCRIBE();\n@@ -709,1 +708,1 @@\n-                EXCEPTION_CHECK_DESCRIBE_CLEAR();\n+                EXCEPTION_CHECK_DESCRIBE();\n@@ -715,1 +714,1 @@\n-        DEBUG_SCREENCAST(\"⚠ Could not get env\\n\", NULL);\n+        DEBUG_SCREENCAST(\"!!! Could not get env\\n\", NULL);\n@@ -751,1 +750,1 @@\n-        DEBUG_SCREENCAST(\"⚠ @@@ tokenStorageClass %p\\n\",\n+        DEBUG_SCREENCAST(\"!!! @@@ tokenStorageClass %p\\n\",\n@@ -777,1 +776,1 @@\n-    EXCEPTION_CHECK_DESCRIBE_CLEAR();\n+    EXCEPTION_CHECK_DESCRIBE();\n@@ -813,1 +812,1 @@\n-        EXCEPTION_CHECK_DESCRIBE_CLEAR();\n+        EXCEPTION_CHECK_DESCRIBE();\n@@ -816,1 +815,1 @@\n-            return -1;\n+            return RESULT_ERROR;\n@@ -840,5 +839,1 @@\n-        if (pw.pwFd == START_DENIED) {\n-            return START_DENIED;\n-        } else {\n-            return -1;\n-        }\n+        return pw.pwFd;\n@@ -849,1 +844,1 @@\n-        return -1;\n+        return RESULT_ERROR;\n","filename":"src\/java.desktop\/unix\/native\/libawt_xawt\/awt\/screencast_pipewire.c","additions":27,"deletions":32,"binary":false,"changes":59,"status":"modified"},{"patch":"@@ -46,1 +46,1 @@\n-        fprintf(stderr, \"⚠ %s:%i Error: domain %i code %i message: \\\"%s\\\"\\n\",\n+        fprintf(stderr, \"!!! %s:%i Error: domain %i code %i message: \\\"%s\\\"\\n\",\n@@ -63,1 +63,1 @@\n-        DEBUG_SCREENCAST(\"⚠ restore token \"\n+        DEBUG_SCREENCAST(\"!!! restore token \"\n@@ -166,1 +166,1 @@\n-            DEBUG_SCREENCAST(\"⚠ could not detect the screencast version\\n\",\n+            DEBUG_SCREENCAST(\"!!! could not detect the screencast version\\n\",\n@@ -178,1 +178,1 @@\n-            DEBUG_SCREENCAST(\"⚠ could not get the screencast version\\n\",\n+            DEBUG_SCREENCAST(\"!!! could not get the screencast version\\n\",\n@@ -192,1 +192,1 @@\n-        DEBUG_SCREENCAST(\"⚠ ScreenCast protocol version %d < 4,\"\n+        DEBUG_SCREENCAST(\"!!! ScreenCast protocol version %d < 4,\"\n@@ -592,1 +592,1 @@\n-        startHelper->result = START_DENIED;\n+        startHelper->result = RESULT_DENIED;\n@@ -614,2 +614,2 @@\n-                   ? START_OK\n-                   : -1;\n+                   ? RESULT_OK\n+                   : RESULT_ERROR;\n@@ -619,1 +619,1 @@\n-    if (startHelper->result == START_OK) {\n+    if (startHelper->result == RESULT_OK) {\n@@ -645,1 +645,1 @@\n-ScreenCastStartResult portalScreenCastStart(const gchar *token) {\n+ScreenCastResult portalScreenCastStart(const gchar *token) {\n@@ -709,1 +709,1 @@\n-    DEBUG_SCREENCAST(\"ScreenCastStartResult |%i|\\n\", startHelper.result);\n+    DEBUG_SCREENCAST(\"ScreenCastResult |%i|\\n\", startHelper.result);\n@@ -740,1 +740,1 @@\n-        return -1;\n+        return RESULT_ERROR;\n@@ -757,1 +757,1 @@\n-        return -1;\n+        return RESULT_ERROR;\n@@ -773,1 +773,1 @@\n-        return -1;\n+        return RESULT_ERROR;\n@@ -868,4 +868,0 @@\n-\/**\n- * @return negative values on error,\n- * -1 for generic error, or enum value of ScreenCastStartResult for specific failure\n- *\/\n@@ -877,1 +873,1 @@\n-        return -1;\n+        return RESULT_ERROR;\n@@ -882,1 +878,1 @@\n-        return -1;\n+        return RESULT_ERROR;\n@@ -885,1 +881,1 @@\n-    ScreenCastStartResult startResult = portalScreenCastStart(token);\n+    ScreenCastResult startResult = portalScreenCastStart(token);\n@@ -887,1 +883,1 @@\n-    if (startResult != START_OK) {\n+    if (startResult != RESULT_OK) {\n@@ -896,1 +892,1 @@\n-            return START_DENIED;\n+            return RESULT_OUT_OF_BOUNDS;\n@@ -904,1 +900,1 @@\n-        DEBUG_SCREENCAST(\"⚠ Failed to get pipewire fd\\n\", NULL);\n+        DEBUG_SCREENCAST(\"!!! Failed to get pipewire fd\\n\", NULL);\n","filename":"src\/java.desktop\/unix\/native\/libawt_xawt\/awt\/screencast_portal.c","additions":20,"deletions":24,"binary":false,"changes":44,"status":"modified"},{"patch":"@@ -65,3 +65,5 @@\n-    START_OK = 0,\n-    START_DENIED = -11,\n-} ScreenCastStartResult;\n+    RESULT_OK = 0,\n+    RESULT_ERROR = -1,\n+    RESULT_DENIED = -11,\n+    RESULT_OUT_OF_BOUNDS = -12,\n+} ScreenCastResult;\n@@ -71,1 +73,1 @@\n-    ScreenCastStartResult result;\n+    ScreenCastResult result;\n","filename":"src\/java.desktop\/unix\/native\/libawt_xawt\/awt\/screencast_portal.h","additions":6,"deletions":4,"binary":false,"changes":10,"status":"modified"}]}