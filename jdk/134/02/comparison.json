{"files":[{"patch":"@@ -658,0 +658,16 @@\n+\n+Handle SystemDictionaryShared::create_jar_manifest(const char* manifest_chars, size_t size, TRAPS) {\n+  typeArrayOop buf = oopFactory::new_byteArray((int)size, CHECK_NH);\n+  typeArrayHandle bufhandle(THREAD, buf);\n+  ArrayAccess<>::arraycopy_from_native(reinterpret_cast<const jbyte*>(manifest_chars),\n+                                         buf, typeArrayOopDesc::element_offset<jbyte>(0), size);\n+  Handle bais = JavaCalls::construct_new_instance(SystemDictionary::ByteArrayInputStream_klass(),\n+                      vmSymbols::byte_array_void_signature(),\n+                      bufhandle, CHECK_NH);\n+  \/\/ manifest = new Manifest(ByteArrayInputStream)\n+  Handle manifest = JavaCalls::construct_new_instance(SystemDictionary::Jar_Manifest_klass(),\n+                      vmSymbols::input_stream_void_signature(),\n+                      bais, CHECK_NH);\n+  return manifest;\n+}\n+\n@@ -674,2 +690,2 @@\n-    long size = ent->manifest_size();\n-    if (size <= 0) {\n+    size_t size = (size_t)ent->manifest_size();\n+    if (size == 0) {\n@@ -682,13 +698,1 @@\n-    typeArrayOop buf = oopFactory::new_byteArray(size, CHECK_NH);\n-    typeArrayHandle bufhandle(THREAD, buf);\n-    ArrayAccess<>::arraycopy_from_native(reinterpret_cast<const jbyte*>(src),\n-                                         buf, typeArrayOopDesc::element_offset<jbyte>(0), size);\n-\n-    Handle bais = JavaCalls::construct_new_instance(SystemDictionary::ByteArrayInputStream_klass(),\n-                      vmSymbols::byte_array_void_signature(),\n-                      bufhandle, CHECK_NH);\n-\n-    \/\/ manifest = new Manifest(bais)\n-    manifest = JavaCalls::construct_new_instance(SystemDictionary::Jar_Manifest_klass(),\n-                      vmSymbols::input_stream_void_signature(),\n-                      bais, CHECK_NH);\n+    manifest = create_jar_manifest(src, size, THREAD);\n@@ -697,1 +701,0 @@\n-\n","filename":"src\/hotspot\/share\/classfile\/systemDictionaryShared.cpp","additions":19,"deletions":16,"binary":false,"changes":35,"status":"modified"},{"patch":"@@ -323,0 +323,1 @@\n+  static Handle create_jar_manifest(const char* man, size_t size, TRAPS) NOT_CDS_RETURN_(NULL);\n","filename":"src\/hotspot\/share\/classfile\/systemDictionaryShared.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -1359,0 +1359,2 @@\n+    \/\/ exercise the manifest processing code to ensure classes used by CDS are always archived\n+    SystemDictionaryShared::create_jar_manifest(\"Manifest-Version: 1.0\\n\", strlen(\"Manifest-Version: 1.0\\n\"), THREAD);\n","filename":"src\/hotspot\/share\/memory\/metaspaceShared.cpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"}]}