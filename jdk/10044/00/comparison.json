{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2016, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2016, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -65,2 +65,12 @@\n-    \/\/ cached hash of this module to avoid needing to compute it many times\n-    private byte[] cachedHash;\n+    \/\/ cached hash of this module to avoid needing to compute it many times.\n+    \/\/ For safety reasons under concurrent updates, we need to wrap the\n+    \/\/ hash\/algo pair into the final wrapper.\n+    private CachedHash cachedHash;\n+    private final class CachedHash {\n+        public CachedHash(byte[] hash, String algorithm) {\n+            this.hash = hash;\n+            this.algorithm = algorithm;\n+        }\n+        final byte[] hash;\n+        final String algorithm;\n+    }\n@@ -142,4 +152,8 @@\n-        byte[] result = cachedHash;\n-        if (result != null)\n-            return result;\n-        if (hasher == null)\n+        CachedHash ch = cachedHash;\n+        if (ch != null) {\n+            if (ch.algorithm.equals(algorithm)) {\n+                return ch.hash;\n+            }\n+        }\n+\n+        if (hasher == null) {\n@@ -147,2 +161,4 @@\n-        cachedHash = result = hasher.generate(algorithm);\n-        return result;\n+        }\n+        byte[] hash = hasher.generate(algorithm);\n+        cachedHash = new CachedHash(hash, algorithm);\n+        return hash;\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/module\/ModuleReferenceImpl.java","additions":25,"deletions":9,"binary":false,"changes":34,"status":"modified"}]}