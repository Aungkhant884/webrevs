{"files":[{"filename":"src\/jdk.crypto.cryptoki\/share\/classes\/sun\/security\/pkcs11\/wrapper\/.PKCS11.java.swp","binary":true,"status":"added"},{"patch":"@@ -167,1 +167,2 @@\n-        Cleaner.create().register(this, this::disconnect);\n+        Cleaner.create().register(this,\n+            () -> PKCS11.disconnect(pNativeData));\n@@ -223,1 +224,2 @@\n-     * internal use only.\n+     * internal use only.  Please don't use this method other than finalization.\n+     *\n@@ -230,1 +232,1 @@\n-    private native void disconnect();\n+    private static native void disconnect(long pNativeData);\n","filename":"src\/jdk.crypto.cryptoki\/share\/classes\/sun\/security\/pkcs11\/wrapper\/PKCS11.java","additions":5,"deletions":3,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -168,15 +168,0 @@\n-\n-\/*\n- * Removes the entry for the given pkcs11Implementation from the list. Returns\n- * the module's data, after the node was removed. If this function returns NULL\n- * the pkcs11Implementation was not in the list.\n- *\/\n-ModuleData * removeModuleEntry(JNIEnv *env, jobject pkcs11Implementation) {\n-    ModuleData *moduleData = getModuleEntry(env, pkcs11Implementation);\n-    if (moduleData == NULL) {\n-        return NULL;\n-    }\n-    (*env)->SetLongField(env, pkcs11Implementation, pNativeDataID, 0);\n-    return moduleData;\n-}\n-\n","filename":"src\/jdk.crypto.cryptoki\/share\/native\/libj2pkcs11\/p11_util.c","additions":0,"deletions":15,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -419,1 +419,0 @@\n-ModuleData * removeModuleEntry(JNIEnv *env, jobject pkcs11Implementation);\n","filename":"src\/jdk.crypto.cryptoki\/share\/native\/libj2pkcs11\/pkcs11wrapper.h","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -267,4 +267,3 @@\n-JNIEXPORT void JNICALL Java_sun_security_pkcs11_wrapper_PKCS11_disconnect\n-    (JNIEnv *env, jobject obj)\n-{\n-    ModuleData *moduleData;\n+JNIEXPORT void JNICALL Java_sun_security_pkcs11_wrapper_PKCS11_disconnect(\n+        JNIEnv *env, jclass thisClass, jlong ckpNativeData) {\n+\n@@ -272,1 +271,2 @@\n-    moduleData = removeModuleEntry(env, obj);\n+    if (ckpNativeData != 0L) {\n+        ModuleData *moduleData = jlong_to_ptr(ckpNativeData);\n@@ -274,2 +274,5 @@\n-    if (moduleData != NULL) {\n-        dlclose(moduleData->hModule);\n+        if (moduleData != NULL) {\n+            dlclose(moduleData->hModule);\n+        }\n+\n+        free(moduleData);\n@@ -278,1 +281,0 @@\n-    free(moduleData);\n@@ -280,1 +282,0 @@\n-\n","filename":"src\/jdk.crypto.cryptoki\/unix\/native\/libj2pkcs11\/p11_md.c","additions":10,"deletions":9,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -280,4 +280,3 @@\n-JNIEXPORT void JNICALL Java_sun_security_pkcs11_wrapper_PKCS11_disconnect\n-    (JNIEnv *env, jobject obj)\n-{\n-    ModuleData *moduleData;\n+JNIEXPORT void JNICALL Java_sun_security_pkcs11_wrapper_PKCS11_disconnect(\n+        JNIEnv *env, jclass thisClass, jlong ckpNativeData) {\n+\n@@ -285,1 +284,2 @@\n-    moduleData = removeModuleEntry(env, obj);\n+    if (ckpNativeData != 0L) {\n+        ModuleData *moduleData = jlong_to_ptr(ckpNativeData);\n@@ -287,2 +287,5 @@\n-    if (moduleData != NULL) {\n-        FreeLibrary(moduleData->hModule);\n+        if (moduleData != NULL) {\n+            FreeLibrary(moduleData->hModule);\n+        }\n+\n+        free(moduleData);\n@@ -291,1 +294,0 @@\n-    free(moduleData);\n","filename":"src\/jdk.crypto.cryptoki\/windows\/native\/libj2pkcs11\/p11_md.c","additions":10,"deletions":8,"binary":false,"changes":18,"status":"modified"}]}