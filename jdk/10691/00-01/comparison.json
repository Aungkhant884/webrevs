{"files":[{"patch":"@@ -1681,0 +1681,27 @@\n+\n+void C2_MacroAssembler::reduce_operation(Register dst, VectorRegister temp, \n+                                         Register src1, VectorRegister src2, \n+                                         BasicType bt, REDUCTION_OP op) {\n+  Assembler::SEW sew = Assembler::elemtype_to_sew(bt);\n+  vsetvli(t0, x0, sew);\n+\n+  vmv_s_x(temp, src1);\n+\n+  switch (op) {\n+    case REDUCTION_OP::ADD:\n+      vredsum_vs(temp, src2, temp);\n+      break;\n+    case REDUCTION_OP::AND:\n+      vredand_vs(temp, src2, temp);\n+      break;\n+    case REDUCTION_OP::OR:\n+      vredor_vs(temp, src2, temp);\n+      break;\n+    case REDUCTION_OP::XOR:\n+      vredxor_vs(temp, src2, temp);\n+      break;\n+    default:\n+      ShouldNotReachHere();\n+  }\n+  vmv_x_s(dst, temp);\n+}\n\\ No newline at end of file\n","filename":"src\/hotspot\/cpu\/riscv\/c2_MacroAssembler_riscv.cpp","additions":27,"deletions":0,"binary":false,"changes":27,"status":"modified"},{"patch":"@@ -194,0 +194,4 @@\n+ \n+ void reduce_operation(Register dst, VectorRegister temp, \n+                       Register src1, VectorRegister src2, \n+                       BasicType bt, REDUCTION_OP op);\n","filename":"src\/hotspot\/cpu\/riscv\/c2_MacroAssembler_riscv.hpp","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -973,0 +973,3 @@\n+\/\/ reduction related operations\n+enum REDUCTION_OP {ADD, AND, OR, XOR};\n+\n","filename":"src\/hotspot\/cpu\/riscv\/macroAssembler_riscv.hpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -788,1 +788,1 @@\n-  predicate(n->in(2)->bottom_type()->is_vect()->element_basic_type() == T_INT);\n+  predicate(Matcher::vector_element_basic_type(n->in(2)) != T_LONG);\n@@ -796,5 +796,3 @@\n-    __ vsetvli(t0, x0, Assembler::e32);\n-    __ vmv_s_x(as_VectorRegister($tmp$$reg), $src1$$Register);\n-    __ vredand_vs(as_VectorRegister($tmp$$reg), as_VectorRegister($src2$$reg),\n-                  as_VectorRegister($tmp$$reg));\n-    __ vmv_x_s($dst$$Register, as_VectorRegister($tmp$$reg));\n+    BasicType bt = Matcher::vector_element_basic_type(this, $src2);\n+    __ reduce_operation($dst$$Register, as_VectorRegister($tmp$$reg),\n+                        $src1$$Register, as_VectorRegister($src2$$reg), bt, REDUCTION_OP::AND);\n@@ -806,1 +804,1 @@\n-  predicate(n->in(2)->bottom_type()->is_vect()->element_basic_type() == T_LONG);\n+  predicate(Matcher::vector_element_basic_type(n->in(2)) == T_LONG);\n@@ -814,5 +812,3 @@\n-    __ vsetvli(t0, x0, Assembler::e64);\n-    __ vmv_s_x(as_VectorRegister($tmp$$reg), $src1$$Register);\n-    __ vredand_vs(as_VectorRegister($tmp$$reg), as_VectorRegister($src2$$reg),\n-                  as_VectorRegister($tmp$$reg));\n-    __ vmv_x_s($dst$$Register, as_VectorRegister($tmp$$reg));\n+    BasicType bt = Matcher::vector_element_basic_type(this, $src2);\n+    __ reduce_operation($dst$$Register, as_VectorRegister($tmp$$reg),\n+                        $src1$$Register, as_VectorRegister($src2$$reg), bt, REDUCTION_OP::AND);\n@@ -826,1 +822,1 @@\n-  predicate(n->in(2)->bottom_type()->is_vect()->element_basic_type() == T_INT);\n+  predicate(Matcher::vector_element_basic_type(n->in(2)) != T_LONG);\n@@ -834,5 +830,3 @@\n-    __ vsetvli(t0, x0, Assembler::e32);\n-    __ vmv_s_x(as_VectorRegister($tmp$$reg), $src1$$Register);\n-    __ vredor_vs(as_VectorRegister($tmp$$reg), as_VectorRegister($src2$$reg),\n-                  as_VectorRegister($tmp$$reg));\n-    __ vmv_x_s($dst$$Register, as_VectorRegister($tmp$$reg));\n+    BasicType bt = Matcher::vector_element_basic_type(this, $src2);\n+    __ reduce_operation($dst$$Register, as_VectorRegister($tmp$$reg),\n+                        $src1$$Register, as_VectorRegister($src2$$reg), bt, REDUCTION_OP::OR);\n@@ -844,1 +838,1 @@\n-  predicate(n->in(2)->bottom_type()->is_vect()->element_basic_type() == T_LONG);\n+  predicate(Matcher::vector_element_basic_type(n->in(2)) == T_LONG);\n@@ -852,5 +846,3 @@\n-    __ vsetvli(t0, x0, Assembler::e64);\n-    __ vmv_s_x(as_VectorRegister($tmp$$reg), $src1$$Register);\n-    __ vredor_vs(as_VectorRegister($tmp$$reg), as_VectorRegister($src2$$reg),\n-                  as_VectorRegister($tmp$$reg));\n-    __ vmv_x_s($dst$$Register, as_VectorRegister($tmp$$reg));\n+    BasicType bt = Matcher::vector_element_basic_type(this, $src2);\n+    __ reduce_operation($dst$$Register, as_VectorRegister($tmp$$reg),\n+                        $src1$$Register, as_VectorRegister($src2$$reg), bt, REDUCTION_OP::OR);\n@@ -864,1 +856,1 @@\n-  predicate(n->in(2)->bottom_type()->is_vect()->element_basic_type() == T_INT);\n+  predicate(Matcher::vector_element_basic_type(n->in(2)) != T_LONG);\n@@ -872,5 +864,3 @@\n-    __ vsetvli(t0, x0, Assembler::e32);\n-    __ vmv_s_x(as_VectorRegister($tmp$$reg), $src1$$Register);\n-    __ vredxor_vs(as_VectorRegister($tmp$$reg), as_VectorRegister($src2$$reg),\n-                  as_VectorRegister($tmp$$reg));\n-    __ vmv_x_s($dst$$Register, as_VectorRegister($tmp$$reg));\n+    BasicType bt = Matcher::vector_element_basic_type(this, $src2);\n+    __ reduce_operation($dst$$Register, as_VectorRegister($tmp$$reg),\n+                        $src1$$Register, as_VectorRegister($src2$$reg), bt, REDUCTION_OP::XOR);\n@@ -882,1 +872,1 @@\n-  predicate(n->in(2)->bottom_type()->is_vect()->element_basic_type() == T_LONG);\n+  predicate(Matcher::vector_element_basic_type(n->in(2)) == T_LONG);\n@@ -890,5 +880,3 @@\n-    __ vsetvli(t0, x0, Assembler::e64);\n-    __ vmv_s_x(as_VectorRegister($tmp$$reg), $src1$$Register);\n-    __ vredxor_vs(as_VectorRegister($tmp$$reg), as_VectorRegister($src2$$reg),\n-                  as_VectorRegister($tmp$$reg));\n-    __ vmv_x_s($dst$$Register, as_VectorRegister($tmp$$reg));\n+    BasicType bt = Matcher::vector_element_basic_type(this, $src2);\n+    __ reduce_operation($dst$$Register, as_VectorRegister($tmp$$reg),\n+                        $src1$$Register, as_VectorRegister($src2$$reg), bt, REDUCTION_OP::XOR);\n","filename":"src\/hotspot\/cpu\/riscv\/riscv_v.ad","additions":24,"deletions":36,"binary":false,"changes":60,"status":"modified"}]}