{"files":[{"patch":"@@ -399,2 +399,7 @@\n-      Handshake::execute(&op, thread);\n-      guarantee(op.completed(), \"Handshake failed. Target thread is not alive?\");\n+      Thread *current = Thread::current();\n+      if (thread->is_handshake_safe_for(current)) {\n+        op.do_thread(thread);\n+      } else {\n+        Handshake::execute(&op, thread);\n+        guarantee(op.completed(), \"Handshake failed. Target thread is not alive?\");\n+      }\n","filename":"src\/hotspot\/share\/prims\/jvmtiEnvThreadState.cpp","additions":7,"deletions":2,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -356,1 +356,0 @@\n-  assert(state != NULL, \"sanity check\");\n@@ -360,0 +359,1 @@\n+  Thread *current = Thread::current();\n@@ -361,0 +361,1 @@\n+  assert(state != NULL, \"sanity check\");\n@@ -370,2 +371,7 @@\n-  Handshake::execute(&hs, target);\n-  guarantee(hs.completed(), \"Handshake failed: Target thread is not alive?\");\n+  if (target->is_handshake_safe_for(current)) {\n+    hs.do_thread(target);\n+  } else {\n+    assert(state->get_thread() != NULL, \"sanity check\");\n+    Handshake::execute(&hs, target);\n+    guarantee(hs.completed(), \"Handshake failed: Target thread is not alive?\");\n+  }\n","filename":"src\/hotspot\/share\/prims\/jvmtiEventController.cpp","additions":9,"deletions":3,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -354,9 +354,2 @@\n-  guarantee(target != nullptr, \"must be\");\n-\n-  JavaThread* current = JavaThread::current();\n-  if (target == current) {\n-    hs_cl->do_thread(target);\n-    return;\n-  }\n-\n-  HandshakeOperation op(hs_cl, target, current);\n+  JavaThread* self = JavaThread::current();\n+  HandshakeOperation op(hs_cl, target, Thread::current());\n@@ -365,0 +358,2 @@\n+\n+  guarantee(target != nullptr, \"must be\");\n@@ -397,1 +392,1 @@\n-    if (SafepointMechanism::should_process(current)) {\n+    if (SafepointMechanism::should_process(self)) {\n@@ -399,1 +394,1 @@\n-      ThreadBlockInVM tbivm(current);\n+      ThreadBlockInVM tbivm(self);\n","filename":"src\/hotspot\/share\/runtime\/handshake.cpp","additions":6,"deletions":11,"binary":false,"changes":17,"status":"modified"}]}