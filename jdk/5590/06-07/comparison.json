{"files":[{"patch":"@@ -215,30 +215,0 @@\n-class JavaThreadInVMAndNative : public StackObj {\n- private:\n-  JavaThread* const _jt;\n-  JavaThreadState _original_state;\n- public:\n-\n-  JavaThreadInVMAndNative(Thread* t) : _jt(t != NULL && t->is_Java_thread() ? JavaThread::cast(t) : NULL),\n-                                       _original_state(_thread_max_state) {\n-    if (_jt != NULL) {\n-      _original_state = _jt->thread_state();\n-      if (_original_state != _thread_in_vm) {\n-        _jt->set_thread_state(_thread_in_vm);\n-      }\n-    }\n-  }\n-\n-  ~JavaThreadInVMAndNative() {\n-    if (_original_state != _thread_max_state) {\n-      _jt->set_thread_state(_original_state);\n-    }\n-  }\n-\n-  void transition_to_native() {\n-    if (_jt != NULL && _jt->thread_state() != _thread_in_native) {\n-      assert(_jt->thread_state() == _thread_in_vm, \"invariant\");\n-      _jt->set_thread_state(_thread_in_native);\n-    }\n-  }\n-};\n-\n","filename":"src\/hotspot\/share\/runtime\/interfaceSupport.inline.hpp","additions":0,"deletions":30,"binary":false,"changes":30,"status":"modified"},{"patch":"@@ -45,1 +45,0 @@\n-#include \"runtime\/interfaceSupport.inline.hpp\"\n@@ -1345,0 +1344,1 @@\n+  JavaThreadState _orig_state;\n@@ -1347,2 +1347,4 @@\n-  VMErrorForceInNative(Thread* t): _jt(t != NULL && t->is_Java_thread() ? JavaThread::cast(t) : NULL) {\n-    if (_jt != NULL && _jt->thread_state() == _thread_in_vm) {\n+  VMErrorForceInNative(Thread* t): _jt(t != NULL && t->is_Java_thread() ? JavaThread::cast(t) : NULL),\n+                                   _orig_state(_thread_max_state) {\n+    if (_jt != NULL) {\n+      _orig_state = _jt->thread_state();\n@@ -1350,2 +1352,0 @@\n-    } else if (_jt != NULL) {\n-      _jt = NULL;\n@@ -1357,1 +1357,1 @@\n-      _jt->set_thread_state(_thread_in_vm);\n+      _jt->set_thread_state(_orig_state);\n@@ -1641,0 +1641,5 @@\n+    \/\/ 8273608: Attempt to set the current thread to Native state.\n+    \/\/ It allows os::fork_and_exec to execute cmd such as jcmd %p. Otherwise,\n+    \/\/ it may end up with a deadlock when dcmds try to synchronize all Java threads\n+    \/\/ at safepoints.\n+    VMErrorForceInNative fn(Thread::current_or_null());\n@@ -1653,5 +1658,0 @@\n-      \/\/ 8273608: Attempt to set the current thread to Native state.\n-      \/\/ It allows os::fork_and_exec to execute cmd such as jcmd %p.\n-      \/\/ Otherwise, it may end up with a deadlock when dcmds try to synchronize all Java threads\n-      \/\/ at safepoints.\n-      VMErrorForceInNative fn(Thread::current_or_null());\n","filename":"src\/hotspot\/share\/utilities\/vmError.cpp","additions":11,"deletions":11,"binary":false,"changes":22,"status":"modified"}]}