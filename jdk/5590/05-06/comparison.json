{"files":[{"patch":"@@ -38,1 +38,0 @@\n-#include \"runtime\/interfaceSupport.inline.hpp\"\n@@ -499,0 +498,30 @@\n+class JavaThreadInVMAndNative : public StackObj {\n+ private:\n+  JavaThread* const _jt;\n+  JavaThreadState _original_state;\n+ public:\n+\n+  JavaThreadInVMAndNative(Thread* t) : _jt(t->is_Java_thread() ? JavaThread::cast(t) : NULL),\n+                                       _original_state(_thread_max_state) {\n+    if (_jt != NULL) {\n+      _original_state = _jt->thread_state();\n+      if (_original_state != _thread_in_vm) {\n+        _jt->set_thread_state(_thread_in_vm);\n+      }\n+    }\n+  }\n+\n+  ~JavaThreadInVMAndNative() {\n+    if (_original_state != _thread_max_state) {\n+      _jt->set_thread_state(_original_state);\n+    }\n+  }\n+\n+  void transition_to_native() {\n+    if (_jt != NULL) {\n+      assert(_jt->thread_state() == _thread_in_vm, \"invariant\");\n+      _jt->set_thread_state(_thread_in_native);\n+    }\n+  }\n+};\n+\n","filename":"src\/hotspot\/share\/jfr\/recorder\/repository\/jfrEmergencyDump.cpp","additions":30,"deletions":1,"binary":false,"changes":31,"status":"modified"},{"patch":"@@ -1341,0 +1341,21 @@\n+\n+class VMErrorForceInNative : public StackObj {\n+ private:\n+  JavaThread* _jt;\n+\n+ public:\n+  VMErrorForceInNative(Thread* t): _jt(t != NULL && t->is_Java_thread() ? JavaThread::cast(t) : NULL) {\n+    if (_jt != NULL && _jt->thread_state() == _thread_in_vm) {\n+      _jt->set_thread_state(_thread_in_native);\n+    } else if (_jt != NULL) {\n+      _jt = NULL;\n+    }\n+  }\n+\n+  ~VMErrorForceInNative() {\n+    if (_jt != NULL) {\n+      _jt->set_thread_state(_thread_in_vm);\n+    }\n+  }\n+};\n+\n@@ -1620,1 +1641,0 @@\n-    JavaThreadInVMAndNative jtivm(Thread::current_or_null());\n@@ -1634,1 +1654,1 @@\n-      \/\/ it allows os::fork_and_exec to execute cmd such as jcmd %p.\n+      \/\/ It allows os::fork_and_exec to execute cmd such as jcmd %p.\n@@ -1637,1 +1657,1 @@\n-      jtivm.transition_to_native();\n+      VMErrorForceInNative fn(Thread::current_or_null());\n","filename":"src\/hotspot\/share\/utilities\/vmError.cpp","additions":23,"deletions":3,"binary":false,"changes":26,"status":"modified"}]}