{"files":[{"patch":"@@ -576,0 +576,2 @@\n+            out.write(\"enum PeriodicType {BEGIN_CHUNK, INTERVAL, END_CHUNK};\");\n+            out.write(\"\");\n@@ -578,1 +580,3 @@\n-            out.write(\"  static void requestEvent(JfrEventId id) {\");\n+            out.write(\"  static void requestEvent(JfrEventId id, jlong timestamp, PeriodicType periodicType) {\");\n+            out.write(\"    _timestamp = Ticks(timestamp);\");\n+            out.write(\"    _type = periodicType;\");\n@@ -598,0 +602,4 @@\n+            out.write(\" static Ticks timestamp(void);\");\n+            out.write(\" static Ticks _timestamp;\");\n+            out.write(\" static PeriodicType type(void);\");\n+            out.write(\" static PeriodicType _type;\");\n","filename":"make\/src\/classes\/build\/tools\/jfr\/GenerateJfrFiles.java","additions":9,"deletions":1,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -241,2 +241,2 @@\n-JVM_ENTRY_NO_ENV(jboolean, jfr_emit_event(JNIEnv* env, jobject jvm, jlong eventTypeId, jlong timeStamp, jlong when))\n-  JfrPeriodicEventSet::requestEvent((JfrEventId)eventTypeId);\n+JVM_ENTRY_NO_ENV(jboolean, jfr_emit_event(JNIEnv* env, jobject jvm, jlong event_type_id, jlong timestamp, jlong periodic_type))\n+  JfrPeriodicEventSet::requestEvent((JfrEventId)event_type_id, timestamp, static_cast<PeriodicType>(periodic_type));\n","filename":"src\/hotspot\/share\/jfr\/jni\/jfrJniMethod.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -83,0 +83,12 @@\n+\/\/ Timestamp to correlate events in the same batch\/generation\n+Ticks JfrPeriodicEventSet::_timestamp;\n+PeriodicType JfrPeriodicEventSet::_type;\n+\n+Ticks JfrPeriodicEventSet::timestamp(void) {\n+  return _timestamp;\n+}\n+\n+PeriodicType JfrPeriodicEventSet::type(void) {\n+  return _type;\n+}\n+\n","filename":"src\/hotspot\/share\/jfr\/periodic\/jfrPeriodic.cpp","additions":12,"deletions":0,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -234,0 +234,1 @@\n+  friend class JfrPeriodicEventSet;\n","filename":"src\/hotspot\/share\/utilities\/ticks.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -121,1 +121,1 @@\n-     * @param when when it is being done {@link Periodic.When}\n+     * @param periodicType when it is being done {@link PeriodicType.When}\n@@ -125,1 +125,1 @@\n-    public native boolean emitEvent(long eventTypeId, long timestamp, long when);\n+    public native boolean emitEvent(long eventTypeId, long timestamp, long periodicType);\n","filename":"src\/jdk.jfr\/share\/classes\/jdk\/jfr\/internal\/JVM.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2016, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2016, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -42,0 +42,3 @@\n+    enum PeriodicType {\n+        BEGIN_CHUNK, INTERVAL, END_CHUNK\n+    }\n@@ -65,1 +68,1 @@\n-        private void execute() {\n+        private void execute(long timestamp, PeriodicType periodicType) {\n@@ -71,1 +74,1 @@\n-                        emitJVMEvent(type);\n+                        emitJVMEvent(type, timestamp, periodicType);\n@@ -85,1 +88,1 @@\n-        private void emitJVMEvent(PlatformEventType type) {\n+        private void emitJVMEvent(PlatformEventType type, long timestamp, PeriodicType periodicType) {\n@@ -91,1 +94,1 @@\n-                jvm.emitEvent(type.getId(), JVM.counterTime(), 0);\n+                jvm.emitEvent(type.getId(), timestamp, periodicType.ordinal());\n@@ -186,1 +189,1 @@\n-        doChunk(x -> x.isEndChunk());\n+        doChunk(x -> x.isEndChunk(), PeriodicType.END_CHUNK);\n@@ -190,1 +193,1 @@\n-        doChunk(x -> x.isBeginChunk());\n+        doChunk(x -> x.isBeginChunk(), PeriodicType.BEGIN_CHUNK);\n@@ -193,1 +196,2 @@\n-    private static void doChunk(Predicate<PlatformEventType> predicate) {\n+    private static void doChunk(Predicate<PlatformEventType> predicate, PeriodicType type) {\n+        long timestamp = JVM.counterTime();\n@@ -197,1 +201,1 @@\n-                requestHook.execute();\n+                requestHook.execute(timestamp, type);\n@@ -203,1 +207,1 @@\n-        return run_requests(entries);\n+        return run_requests(entries, JVM.counterTime());\n@@ -207,1 +211,1 @@\n-    private static long run_requests(Collection<RequestHook> entries) {\n+    private static long run_requests(Collection<RequestHook> entries, long eventTimestamp) {\n@@ -209,6 +213,3 @@\n-        \/\/ Bug 9000556 - current time millis has rather lame resolution\n-        \/\/ The use of os::elapsed_counter() is deliberate here, we don't\n-        \/\/ want it exchanged for os::ft_elapsed_counter().\n-        \/\/ Keeping direct call os::elapsed_counter() here for reliable\n-        \/\/ real time values in order to decide when registered requestable\n-        \/\/ events are due.\n+        \/\/ The interval for periodic events is typically at least 1 s, so\n+        \/\/ System.currentTimeMillis() is sufficient. JVM.counterTime() lacks\n+        \/\/ unit and has in the past been more unreliable.\n@@ -252,1 +253,1 @@\n-                he.execute();\n+                he.execute(eventTimestamp, PeriodicType.INTERVAL);\n","filename":"src\/jdk.jfr\/share\/classes\/jdk\/jfr\/internal\/RequestEngine.java","additions":19,"deletions":18,"binary":false,"changes":37,"status":"modified"}]}