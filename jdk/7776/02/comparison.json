{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -147,2 +147,13 @@\n-            this.connection = connection;\n-            if (closeRequested) closeConnection();\n+            boolean closeRequested;\n+            synchronized (this) {\n+                \/\/ check whether this new connection should be\n+                \/\/ closed\n+                closeRequested = this.closeRequested;\n+                if (!closeRequested) {\n+                    this.connection = connection;\n+                } else {\n+                    \/\/ assert this.connection == null\n+                    this.closeRequested = false;\n+                }\n+            }\n+            if (closeRequested) closeConnection(connection);\n@@ -152,3 +163,23 @@\n-            closeRequested = true;\n-            HttpConnection connection = this.connection;\n-            this.connection = null;\n+            HttpConnection connection;\n+            synchronized (this) {\n+                connection = this.connection;\n+                if (connection == null) {\n+                    closeRequested = true;\n+                } else {\n+                    this.connection = null;\n+                }\n+            }\n+            closeConnection(connection);\n+        }\n+\n+        HttpConnection disable() {\n+            HttpConnection connection;\n+            synchronized (this) {\n+                connection = this.connection;\n+                this.connection = null;\n+                this.closeRequested = false;\n+            }\n+            return connection;\n+        }\n+\n+        private static void closeConnection(HttpConnection connection) {\n@@ -163,5 +194,0 @@\n-\n-        void disable() {\n-            connection = null;\n-            closeRequested = false;\n-        }\n@@ -527,0 +553,1 @@\n+                            HttpConnection connection = connectionAborter.disable();\n@@ -528,1 +555,3 @@\n-                            if (cached) connectionAborter.disable();\n+                            if (!cached && connection != null) {\n+                                connectionAborter.connection(connection);\n+                            }\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/Exchange.java","additions":41,"deletions":12,"binary":false,"changes":53,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, 2018, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -31,1 +31,0 @@\n-import java.net.ConnectException;\n@@ -104,1 +103,1 @@\n-                    if (connection.closed || !connection.reserveStream(true)) {\n+                    if (!connection.isOpen() || !connection.reserveStream(true)) {\n@@ -156,1 +155,1 @@\n-        if (c.closed || c.finalStream()) {\n+        if (!c.isOpen() || c.finalStream()) {\n@@ -164,0 +163,5 @@\n+            if (!c.isOpen()) {\n+                if (debug.on())\n+                    debug.log(\"skipping offered closed or closing connection: %s\", c);\n+                return false;\n+            }\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/Http2ClientImpl.java","additions":8,"deletions":4,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -883,0 +883,4 @@\n+    boolean isOpen() {\n+        return !closed && connection.channel().isOpen();\n+    }\n+\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/Http2Connection.java","additions":5,"deletions":1,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -26,1 +26,1 @@\n- * @bug 8245462 8229822\n+ * @bug 8245462 8229822 8254786\n","filename":"test\/jdk\/java\/net\/httpclient\/CancelRequestTest.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"}]}