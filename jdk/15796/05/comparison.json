{"files":[{"patch":"@@ -730,5 +730,7 @@\n-    \/\/ Try to find bind address of preferred address family first.\n-    for (ai = addrInfo; ai != NULL; ai = ai->ai_next) {\n-        if (ai->ai_family == preferredAddressFamily) {\n-            listenAddr = ai;\n-            break;\n+    \/\/ Try to find bind address of preferred address family first (if java.net.preferIPv6Addresses != \"system\").\n+    if (preferredAddressFamily != AF_UNSPEC) {\n+        for (ai = addrInfo; ai != NULL; ai = ai->ai_next) {\n+            if (ai->ai_family == preferredAddressFamily) {\n+                listenAddr = ai;\n+                break;\n+            }\n@@ -746,1 +748,1 @@\n-    \/\/ mapped INADDR_ANY if preferredAddressFamily is AF_INET6 or not set.\n+    \/\/ mapped INADDR_ANY if preferIPv4Stack is false.\n@@ -748,1 +750,1 @@\n-    if (preferredAddressFamily != AF_INET) {\n+    if (!allowOnlyIPv4) {\n@@ -970,2 +972,4 @@\n-    \/* 1st pass - preferredAddressFamily (by default IPv4), 2nd pass - the rest *\/\n-    for (pass = 0; pass < 2 && socketFD < 0; pass++) {\n+    \/\/ 1st pass - preferredAddressFamily (by default IPv4), 2nd pass - the rest;\n+    \/\/ if java.net.preferIPv6Addresses == \"system\", only 2nd pass is needed\n+    pass = preferredAddressFamily != AF_UNSPEC ? 0 : 1;\n+    for (; pass < 2 && socketFD < 0; pass++) {\n@@ -1308,0 +1312,37 @@\n+\/*\n+ * Reads java.net.preferIPv6Addresses system value, sets preferredAddressFamily to\n+ *  - AF_INET6 if the property is \"true\";\n+ *  - AF_INET if the property is \"false\".\n+ *  - AF_UNSPEC if the property is \"system\".\n+ * Doesn't change preferredAddressFamily if the property is not set or failed to read.\n+ *\/\n+static int readPreferIPv6Addresses(JNIEnv* jniEnv,\n+    jclass sysClass, jmethodID getPropMethod, const char *propName)\n+{\n+    jstring value;\n+    jstring name = (*jniEnv)->NewStringUTF(jniEnv, propName);\n+\n+    if (name == NULL) {\n+        return JNI_ERR;\n+    }\n+    value = (jstring)(*jniEnv)->CallStaticObjectMethod(jniEnv, sysClass, getPropMethod, name);\n+    if ((*jniEnv)->ExceptionCheck(jniEnv)) {\n+        return JNI_ERR;\n+    }\n+    if (value != NULL) {\n+        const char *theValue = (*jniEnv)->GetStringUTFChars(jniEnv, value, NULL);\n+        if (theValue == NULL) {\n+            return JNI_ERR;\n+        }\n+        if (strcmp(theValue, \"true\") == 0) {\n+            preferredAddressFamily = AF_INET6;\n+        } else if (strcmp(theValue, \"false\") == 0) {\n+            preferredAddressFamily = AF_INET;\n+        } else if (strcmp(theValue, \"system\") == 0) {\n+            preferredAddressFamily = AF_UNSPEC;\n+        }\n+        (*jniEnv)->ReleaseStringUTFChars(jniEnv, value, theValue);\n+    }\n+    return JNI_OK;\n+}\n+\n@@ -1365,1 +1406,1 @@\n-        readBooleanSysProp(&preferredAddressFamily, AF_INET6, AF_INET,\n+        readPreferIPv6Addresses(\n","filename":"src\/jdk.jdwp.agent\/share\/native\/libdt_socket\/socketTransport.c","additions":51,"deletions":10,"binary":false,"changes":61,"status":"modified"},{"patch":"@@ -42,1 +42,1 @@\n- * @bug 8184770\n+ * @bug 8184770 8313804\n@@ -70,0 +70,4 @@\n+            new ListenTest(\"localhost\", ipv4Address)\n+                    .preferIPv4Stack(true)\n+                    .preferIPv6Addresses(\"system\")\n+                    .run(TestResult.Success);\n@@ -71,1 +75,1 @@\n-                \/\/ - only IPv4, so connection prom IPv6 should fail\n+                \/\/ - only IPv4, so connection from IPv6 should fail\n@@ -74,1 +78,1 @@\n-                        .preferIPv6Addresses(true)\n+                        .preferIPv6Addresses(\"true\")\n@@ -78,1 +82,1 @@\n-                        .preferIPv6Addresses(false)\n+                        .preferIPv6Addresses(\"false\")\n@@ -82,1 +86,4 @@\n-                        .preferIPv6Addresses(true)\n+                        .preferIPv6Addresses(\"true\")\n+                        .run(TestResult.Success);\n+                new ListenTest(\"localhost\", ipv6Address)\n+                        .preferIPv6Addresses(\"system\")\n@@ -103,1 +110,1 @@\n-        private Boolean preferIPv6Addresses;\n+        private String preferIPv6Addresses;\n@@ -112,1 +119,1 @@\n-        public ListenTest preferIPv6Addresses(Boolean value) {\n+        public ListenTest preferIPv6Addresses(String value) {\n@@ -123,1 +130,1 @@\n-                options.add(\"-Djava.net.preferIPv6Addresses=\" + preferIPv6Addresses.toString());\n+                options.add(\"-Djava.net.preferIPv6Addresses=\" + preferIPv6Addresses);\n","filename":"test\/jdk\/com\/sun\/jdi\/JdwpNetProps.java","additions":15,"deletions":8,"binary":false,"changes":23,"status":"modified"}]}