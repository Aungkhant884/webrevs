{"files":[{"patch":"@@ -1724,1 +1724,1 @@\n-    int regNumber = (Rm == zr ? 31 : (uintptr_t)Rm);                    \\\n+    int regNumber = (Rm == zr ? 31 : Rm->encoding());                   \\\n","filename":"src\/hotspot\/cpu\/aarch64\/assembler_aarch64.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -70,0 +70,2 @@\n+#define USE_POINTERS_TO_REGISTER_IMPL_ARRAY\n+\n","filename":"src\/hotspot\/cpu\/aarch64\/globalDefinitions_aarch64.hpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -189,1 +189,1 @@\n-    jint floatRegisterNumber = jvmci_reg - RegisterImpl::number_of_registers_for_jvmci;\n+    jint floatRegisterNumber = jvmci_reg - RegisterImpl::number_of_declared_registers;\n","filename":"src\/hotspot\/cpu\/aarch64\/jvmciCodeInstaller_aarch64.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -29,0 +29,4 @@\n+REGISTER_IMPL_DEFINITION(Register, RegisterImpl, RegisterImpl::number_of_declared_registers);\n+REGISTER_IMPL_DEFINITION(FloatRegister, FloatRegisterImpl, FloatRegisterImpl::number_of_registers);\n+REGISTER_IMPL_DEFINITION(PRegister, PRegisterImpl, PRegisterImpl::number_of_registers);\n+\n@@ -40,1 +44,1 @@\n-  const char* names[number_of_registers] = {\n+  static const char *const names[number_of_registers] = {\n@@ -52,1 +56,1 @@\n-  const char* names[number_of_registers] = {\n+  static const char *const names[number_of_registers] = {\n@@ -62,1 +66,1 @@\n-  const char* names[number_of_registers] = {\n+  static const char *const names[number_of_registers] = {\n","filename":"src\/hotspot\/cpu\/aarch64\/register_aarch64.cpp","additions":7,"deletions":3,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -37,1 +37,1 @@\n-typedef RegisterImpl* Register;\n+typedef const RegisterImpl* Register;\n@@ -39,3 +39,1 @@\n-inline const Register as_Register(int encoding) {\n-  return (Register)(intptr_t) encoding;\n-}\n+inline const Register as_Register(int encoding);\n@@ -44,1 +42,7 @@\n- public:\n+  inline friend const Register as_Register(int encoding);\n+\n+private:\n+  static constexpr Register first();\n+  static constexpr Register invalid() { return first() + number_of_registers; }\n+\n+public:\n@@ -48,1 +52,1 @@\n-    number_of_registers_for_jvmci = 34,  \/\/ Including SP and ZR.\n+    number_of_declared_registers  = 34,  \/\/ Including SP and ZR.\n@@ -53,4 +57,1 @@\n-  Register successor() const                          { return as_Register(encoding() + 1); }\n-\n-  \/\/ construction\n-  inline friend const Register as_Register(int encoding);\n+  const Register successor() const { return this + 1; }\n@@ -58,1 +59,1 @@\n-  VMReg as_VMReg();\n+  VMReg as_VMReg() const;\n@@ -61,3 +62,3 @@\n-  int   encoding() const                         { assert(is_valid(), \"invalid register\"); return (intptr_t)this; }\n-  bool  is_valid() const                         { return 0 <= (intptr_t)this && (intptr_t)this < number_of_registers; }\n-  bool  has_byte_register() const                { return 0 <= (intptr_t)this && (intptr_t)this < number_of_byte_registers; }\n+  int encoding() const             { assert(is_valid(), \"invalid register\"); return encoding_nocheck(); }\n+  bool is_valid() const            { return this >= first() && this < invalid(); }\n+  bool has_byte_register() const   { return is_valid(); }\n@@ -65,1 +66,1 @@\n-  int   encoding_nocheck() const                 { return (intptr_t)this; }\n+  int encoding_nocheck() const     { return this - first(); }\n@@ -68,1 +69,0 @@\n-\/\/ The integer registers of the aarch64 architecture\n@@ -70,1 +70,3 @@\n-CONSTANT_REGISTER_DECLARATION(Register, noreg, (-1));\n+REGISTER_IMPL_DECLARATION(Register, RegisterImpl, RegisterImpl::number_of_declared_registers);\n+\n+\/\/ The integer registers of the aarch64 architecture\n@@ -72,0 +74,1 @@\n+CONSTANT_REGISTER_DECLARATION(Register, noreg, (RegisterImpl::number_of_declared_registers));\n@@ -129,1 +132,1 @@\n-typedef FloatRegisterImpl* FloatRegister;\n+typedef const FloatRegisterImpl* FloatRegister;\n@@ -131,3 +134,1 @@\n-inline FloatRegister as_FloatRegister(int encoding) {\n-  return (FloatRegister)(intptr_t) encoding;\n-}\n+inline const FloatRegister as_FloatRegister(int encoding);\n@@ -137,1 +138,7 @@\n- public:\n+  inline friend const FloatRegister as_FloatRegister(int encoding);\n+\n+private:\n+  static constexpr FloatRegister first();\n+  static constexpr FloatRegister invalid() { return first() + number_of_registers; }\n+\n+public:\n@@ -146,4 +153,1 @@\n-  \/\/ construction\n-  inline friend FloatRegister as_FloatRegister(int encoding);\n-\n-  VMReg as_VMReg();\n+  VMReg as_VMReg() const;\n@@ -152,1 +156,1 @@\n-  FloatRegister successor() const                          { return as_FloatRegister((encoding() + 1) % 32); }\n+  FloatRegister successor() const { return as_FloatRegister((encoding() + 1) % 32); }\n@@ -155,3 +159,1 @@\n-  int   encoding() const                          { assert(is_valid(), \"invalid register\"); return (intptr_t)this; }\n-  int   encoding_nocheck() const                         { return (intptr_t)this; }\n-  bool  is_valid() const                          { return 0 <= (intptr_t)this && (intptr_t)this < number_of_registers; }\n+  bool is_valid() const           { return this >= first() && this < invalid(); }\n@@ -159,1 +161,2 @@\n-\n+  int encoding() const            { assert(is_valid(), \"invalid register\"); return encoding_nocheck(); }\n+  int encoding_nocheck() const    { return this - first(); }\n@@ -162,1 +165,2 @@\n-\/\/ The float registers of the AARCH64 architecture\n+REGISTER_IMPL_DECLARATION(FloatRegister, FloatRegisterImpl, FloatRegisterImpl::number_of_registers);\n+\n@@ -164,1 +168,1 @@\n-CONSTANT_REGISTER_DECLARATION(FloatRegister, fnoreg , (-1));\n+\/\/ The float registers of the AARCH64 architecture\n@@ -166,0 +170,1 @@\n+CONSTANT_REGISTER_DECLARATION(FloatRegister, fnoreg , (FloatRegisterImpl::number_of_registers));\n@@ -235,4 +240,2 @@\n-typedef PRegisterImpl* PRegister;\n-inline PRegister as_PRegister(int encoding) {\n-  return (PRegister)(intptr_t)encoding;\n-}\n+typedef const PRegisterImpl* PRegister;\n+const PRegister as_PRegister(int encoding);\n@@ -242,0 +245,6 @@\n+  friend const PRegister as_PRegister(int encoding);\n+\n+private:\n+  static constexpr PRegister first();\n+  static constexpr PRegister invalid() { return first() + number_of_registers; }\n+\n@@ -249,4 +258,1 @@\n-  \/\/ construction\n-  inline friend PRegister as_PRegister(int encoding);\n-\n-  VMReg as_VMReg();\n+  VMReg as_VMReg() const;\n@@ -255,1 +261,1 @@\n-  PRegister successor() const     { return as_PRegister(encoding() + 1); }\n+  PRegister successor() const     { return this + 1; }\n@@ -258,4 +264,4 @@\n-  int   encoding() const          { assert(is_valid(), \"invalid register\"); return (intptr_t)this; }\n-  int   encoding_nocheck() const  { return (intptr_t)this; }\n-  bool  is_valid() const          { return 0 <= (intptr_t)this && (intptr_t)this < number_of_registers; }\n-  bool  is_governing() const      { return 0 <= (intptr_t)this && (intptr_t)this < number_of_governing_registers; }\n+  int encoding() const            { assert(is_valid(), \"invalid register\"); return encoding_nocheck(); }\n+  int encoding_nocheck() const    { return this - first(); }\n+  bool is_valid() const           { return this >= first() && this < invalid(); }\n+  bool is_governing() const       { return this < first() + number_of_governing_registers; }\n@@ -265,0 +271,3 @@\n+\n+REGISTER_IMPL_DECLARATION(PRegister, PRegisterImpl, PRegisterImpl::number_of_registers);\n+\n","filename":"src\/hotspot\/cpu\/aarch64\/register_aarch64.hpp","additions":55,"deletions":46,"binary":false,"changes":101,"status":"modified"},{"patch":"@@ -29,1 +29,1 @@\n-inline VMReg RegisterImpl::as_VMReg() {\n+inline VMReg RegisterImpl::as_VMReg() const {\n@@ -34,1 +34,1 @@\n-inline VMReg FloatRegisterImpl::as_VMReg() {\n+inline VMReg FloatRegisterImpl::as_VMReg() const {\n@@ -39,1 +39,1 @@\n-inline VMReg PRegisterImpl::as_VMReg() {\n+inline VMReg PRegisterImpl::as_VMReg() const {\n","filename":"src\/hotspot\/cpu\/aarch64\/vmreg_aarch64.inline.hpp","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -48,0 +48,5 @@\n+\n+\/\/ Macros to help define all kinds of registers\n+\n+#ifndef USE_POINTERS_TO_REGISTER_IMPL_ARRAY\n+\n@@ -50,2 +55,2 @@\n-#define CONSTANT_REGISTER_DECLARATION(type, name, value)        \\\n-const type name = ((type)value);                                \\\n+#define CONSTANT_REGISTER_DECLARATION(type, name, value)                \\\n+const type name = ((type)value);                                        \\\n@@ -54,1 +59,20 @@\n-#define REGISTER_DECLARATION(type, name, value)                 \\\n+\n+#else \/\/ USE_POINTERS_TO_REGISTER_IMPL_ARRAY\n+\n+#define REGISTER_IMPL_DECLARATION(type, impl_type, reg_count)           \\\n+inline const type as_ ## type(int encoding) {                           \\\n+  return encoding == -1 ? impl_type::invalid() : impl_type::first() + encoding; \\\n+}                                                                       \\\n+extern impl_type all_ ## type ## s[reg_count + 1] INTERNAL_VISIBILITY;  \\\n+inline constexpr type impl_type::first() { return all_ ## type ## s; }\n+\n+#define REGISTER_IMPL_DEFINITION(type, impl_type, reg_count)            \\\n+impl_type all_ ## type ## s[reg_count + 1];\n+\n+#define CONSTANT_REGISTER_DECLARATION(type, name, value)                \\\n+constexpr type name = all_ ## type ## s + value;\n+\n+#endif \/\/ USE_POINTERS_TO_REGISTER_IMPL_ARRAY\n+\n+\n+#define REGISTER_DECLARATION(type, name, value) \\\n@@ -57,0 +81,10 @@\n+\n+\/\/ For definitions of RegisterImpl* instances. To be redefined in an\n+\/\/ OS-specific way.\n+#ifdef __GNUC__\n+#define INTERNAL_VISIBILITY  __attribute__ ((visibility (\"internal\")))\n+#else\n+#define INTERNAL_VISIBILITY\n+#endif\n+\n+\n","filename":"src\/hotspot\/share\/asm\/register.hpp","additions":37,"deletions":3,"binary":false,"changes":40,"status":"modified"}]}