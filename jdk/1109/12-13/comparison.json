{"files":[{"patch":"@@ -621,0 +621,6 @@\n+  DecoratorSet decorators = stub->decorators();\n+  bool is_strong  = ShenandoahBarrierSet::is_strong_access(decorators);\n+  bool is_weak    = ShenandoahBarrierSet::is_weak_access(decorators);\n+  bool is_phantom = ShenandoahBarrierSet::is_phantom_access(decorators);\n+  bool is_native  = ShenandoahBarrierSet::is_native_access(decorators);\n+\n@@ -633,20 +639,7 @@\n-  \/\/ Check for null.\n-  __ cbz(res, *stub->continuation());\n-\n-  \/\/ Check for object in cset.\n-  __ mov(tmp2, ShenandoahHeap::in_cset_fast_test_addr());\n-  __ lsr(tmp1, res, ShenandoahHeapRegion::region_size_bytes_shift_jint());\n-  __ ldrb(tmp2, Address(tmp2, tmp1));\n-  __ cbz(tmp2, *stub->continuation());\n-\n-  \/\/ Check if object is already forwarded.\n-  Label slow_path;\n-  __ ldr(tmp1, Address(res, oopDesc::mark_offset_in_bytes()));\n-  __ eon(tmp1, tmp1, zr);\n-  __ ands(zr, tmp1, markWord::lock_mask_in_place);\n-  __ br(Assembler::NE, slow_path);\n-\n-  \/\/ Decode forwarded object.\n-  __ orr(tmp1, tmp1, markWord::marked_value);\n-  __ eon(res, tmp1, zr);\n-  __ b(*stub->continuation());\n+  if (is_strong) {\n+    \/\/ Check for object in cset.\n+    __ mov(tmp2, ShenandoahHeap::in_cset_fast_test_addr());\n+    __ lsr(tmp1, res, ShenandoahHeapRegion::region_size_bytes_shift_jint());\n+    __ ldrb(tmp2, Address(tmp2, tmp1));\n+    __ cbz(tmp2, *stub->continuation());\n+  }\n@@ -654,1 +647,0 @@\n-  __ bind(slow_path);\n@@ -657,4 +649,0 @@\n-  DecoratorSet decorators = stub->decorators();\n-  bool is_strong  = ShenandoahBarrierSet::is_strong_access(decorators);\n-  bool is_weak    = ShenandoahBarrierSet::is_weak_access(decorators);\n-  bool is_phantom = ShenandoahBarrierSet::is_phantom_access(decorators);\n@@ -662,1 +650,5 @@\n-    __ far_call(RuntimeAddress(bs->load_reference_barrier_strong_rt_code_blob()->code_begin()));\n+    if (is_native) {\n+      __ far_call(RuntimeAddress(bs->load_reference_barrier_strong_native_rt_code_blob()->code_begin()));\n+    } else {\n+      __ far_call(RuntimeAddress(bs->load_reference_barrier_strong_rt_code_blob()->code_begin()));\n+    }\n@@ -730,0 +722,1 @@\n+\n@@ -733,0 +726,1 @@\n+  bool is_native  = ShenandoahBarrierSet::is_native_access(decorators);\n@@ -734,3 +728,1 @@\n-    if (UseCompressedOops) {\n-      __ mov(lr, CAST_FROM_FN_PTR(address, ShenandoahRuntime::load_reference_barrier_strong_narrow));\n-    } else {\n+    if (is_native) {\n@@ -738,0 +730,6 @@\n+    } else {\n+      if (UseCompressedOops) {\n+\t__ mov(lr, CAST_FROM_FN_PTR(address, ShenandoahRuntime::load_reference_barrier_strong_narrow));\n+      } else {\n+\t__ mov(lr, CAST_FROM_FN_PTR(address, ShenandoahRuntime::load_reference_barrier_strong));\n+      }\n","filename":"src\/hotspot\/cpu\/aarch64\/gc\/shenandoah\/shenandoahBarrierSetAssembler_aarch64.cpp","additions":27,"deletions":29,"binary":false,"changes":56,"status":"modified"},{"patch":"@@ -944,1 +944,1 @@\n-  #ifdef _LP64\n+#ifdef _LP64\n","filename":"src\/hotspot\/cpu\/x86\/gc\/shenandoah\/shenandoahBarrierSetAssembler_x86.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}