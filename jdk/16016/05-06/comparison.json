{"files":[{"patch":"@@ -115,0 +115,1 @@\n+  {\"jdk\/internal\/module\/ArchivedModuleGraph\",     \"mainModule\"},\n@@ -967,1 +968,8 @@\n-  if (record != nullptr) {\n+  if (record == nullptr) {\n+    if (log_is_enabled(Info, cds, heap)) {\n+      ResourceMark rm(THREAD);\n+      log_info(cds, heap)(\"subgraph %s is not recorded\",\n+                          k->external_name());\n+    }\n+    return nullptr;\n+  } else {\n","filename":"src\/hotspot\/share\/cds\/heapShared.cpp","additions":9,"deletions":1,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -770,2 +770,0 @@\n-  HeapShared::init_for_dumping(CHECK);\n-\n@@ -783,8 +781,11 @@\n-  StringTable::allocate_shared_strings_array(CHECK);\n-  if (!HeapShared::is_archived_boot_layer_available(THREAD)) {\n-    log_info(cds)(\"archivedBootLayer not available, disabling full module graph\");\n-    disable_full_module_graph();\n-  }\n-  ArchiveHeapWriter::init();\n-  if (use_full_module_graph()) {\n-    HeapShared::reset_archived_object_states(CHECK);\n+  if (CDSConfig::is_dumping_heap()) {\n+    StringTable::allocate_shared_strings_array(CHECK);\n+    if (!HeapShared::is_archived_boot_layer_available(THREAD)) {\n+      log_info(cds)(\"archivedBootLayer not available, disabling full module graph\");\n+      disable_full_module_graph();\n+    }\n+    HeapShared::init_for_dumping(CHECK);\n+    ArchiveHeapWriter::init();\n+    if (use_full_module_graph()) {\n+      HeapShared::reset_archived_object_states(CHECK);\n+    }\n","filename":"src\/hotspot\/share\/cds\/metaspaceShared.cpp","additions":11,"deletions":10,"binary":false,"changes":21,"status":"modified"},{"patch":"@@ -27,0 +27,1 @@\n+import java.util.Objects;\n@@ -44,0 +45,1 @@\n+    private static String mainModule;\n@@ -49,1 +51,2 @@\n-                                Function<String, ClassLoader> classLoaderFunction) {\n+                                Function<String, ClassLoader> classLoaderFunction,\n+                                String mainModuleName) {\n@@ -55,0 +58,1 @@\n+        mainModule = mainModuleName;\n@@ -80,1 +84,1 @@\n-    static ArchivedModuleGraph get(String mainModule) {\n+    static ArchivedModuleGraph get(String mainModuleName) {\n@@ -82,2 +86,1 @@\n-        \/\/ We only allow the unnamed module (default) case for now\n-        if (mainModule == null) {\n+        if (Objects.equals(mainModule, mainModuleName)) {\n@@ -97,1 +100,2 @@\n-                        Function<String, ClassLoader> classLoaderFunction) {\n+                        Function<String, ClassLoader> classLoaderFunction,\n+                        String mainModule) {\n@@ -102,1 +106,2 @@\n-                                                      classLoaderFunction);\n+                                                      classLoaderFunction,\n+                                                      mainModule);\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/module\/ArchivedModuleGraph.java","additions":11,"deletions":6,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -493,1 +493,2 @@\n-                                        clf);\n+                                        clf,\n+                                        mainModule);\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/module\/ModuleBootstrap.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -40,1 +40,1 @@\n-        final String loggingOption = \"-Xlog:cds=debug,cds+module=debug,module=trace\";\n+        final String loggingOption = \"-Xlog:cds=debug,cds+module=debug,cds+heap=info,module=trace\";\n@@ -42,0 +42,1 @@\n+        final String subgraphCannotBeUsed = \"subgraph jdk.internal.module.ArchivedBootLayer cannot be used because full module graph is disabled\";\n@@ -69,1 +70,2 @@\n-          .shouldContain(\"Mismatched modules: runtime jdk.compiler dump time jdk.httpserver\");\n+          .shouldContain(\"Mismatched modules: runtime jdk.compiler dump time jdk.httpserver\")\n+          .shouldContain(subgraphCannotBeUsed);\n@@ -76,1 +78,2 @@\n-          .shouldContain(\"Module jdk.httpserver specified during dump time but not during runtime\");\n+          .shouldContain(\"Module jdk.httpserver specified during dump time but not during runtime\")\n+          .shouldContain(subgraphCannotBeUsed);\n@@ -95,1 +98,2 @@\n-          .shouldMatch(versionPattern);\n+          .shouldMatch(versionPattern)\n+          .shouldContain(subgraphCannotBeUsed);\n@@ -118,0 +122,1 @@\n+          .shouldContain(\"subgraph jdk.internal.module.ArchivedBootLayer is not recorde\")\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/jigsaw\/module\/ModuleOption.java","additions":9,"deletions":4,"binary":false,"changes":13,"status":"modified"}]}