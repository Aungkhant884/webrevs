[{"commit":{"message":"8311548: AArch64: [ZGC] Many tests fail with \"assert(allocates2(pc)) failed: not in CodeBuffer memory\" on some CPUs\n\nProblem:\n\nWe got many ZGC related JTreg test failures on ThunderX2 CPU. The\nfailure can be easily reproduced by the following command as well.\n\n  `java -XX:+UseZGC -XX:+ZGenerational --version`\n\nHere shows the snippet of error message:\n\n```\n A fatal error has been detected by the Java Runtime Environment:\n\n Internal Error (~\/jdk_build\/jdk_src\/src\/hotspot\/share\/asm\/codeBuffer.hpp:200), pid=108369, tid=108373\n assert(allocates2(pc)) failed: not in CodeBuffer memory: 0x0000ffff9c921100 <= 0x0000ffff9c934c04 <= 0x0000ffff9c934c00\n\n JRE version: (22.0) (fastdebug build )\n Java VM: OpenJDK 64-Bit Server VM (fastdebug 22-internal-git-0916e6a60, mixed mode, sharing, compressed class ptrs, z gc, linux-aarch64)\n Problematic frame:\n V [libjvm.so+0x45413c] Instruction_aarch64::~Instruction_aarch64()+0xbc\n```\n\nRoot cause:\n\nFrom the backtrace (See the Description session in the JBS [1]), we can\nsee that it's an assembler failure and the failure occurred when the VM\ngenerated \"final stubs\". The root cause is that the buffer size of\n\"final stubs\" is too small for ThunderX2 CPU with ZGC on.\n\nThe reason that this failure only occurred on ThunderX2 CPU but not on\nCPUs like Neoverse N1\/N2, is that 1) VM flag \"AvoidUnalignedAccesses\" is\nenabled by default on CPUs like ThunderX2 (See the code [2]), and 2)\nmore instructions would be generated especially with ZGC (E.g., see the\ncode [3]).\n\nHence, the failure would also occur on CPUs like Neoverse N1\/N2 if we\npass VM option \"-XX:+AvoidUnalignedAccesses\", e.g.,\n\n`java -XX:+UseZGC -XX:+ZGenerational -XX:+AvoidUnalignedAccesses --version`\n\nFix:\n\nIncreasing the buffer size for \"final blobs\", i.e. variable\n`_final_stubs_code_size`, would fix the failure.\n\nWe manually computed the code size for \"final stubs\" on ThunderX2 CPU\nand the size is roughly \"105568\" bytes. In this patch, we increase the\nbuffer size from \"60000\" to \"100000\" for ZGC_ONLY().\n\nTest:\n\nTier1~3 passed on Linux\/ThunderX2 and Linux\/Neoverse N1.\n\n[1] https:\/\/bugs.openjdk.org\/browse\/JDK-8311548\n[2] https:\/\/github.com\/openjdk\/jdk\/blob\/master\/src\/hotspot\/cpu\/aarch64\/vm_version_aarch64.cpp#L154-L177\n[3] https:\/\/github.com\/openjdk\/jdk\/blob\/master\/src\/hotspot\/cpu\/aarch64\/stubGenerator_aarch64.cpp#L919-L1109"},"files":[{"filename":"src\/hotspot\/cpu\/aarch64\/stubRoutines_aarch64.hpp"}],"sha":"bcbf450ba1ad698e0cc2c9254b81436ac9d9a1b4"}]