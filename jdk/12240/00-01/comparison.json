{"files":[{"patch":"@@ -40,1 +40,1 @@\n-} threadInfo;\n+} thread_info;\n@@ -61,1 +61,1 @@\n-static threadInfo thrInfo[] = {\n+static thread_info thr_info[] = {\n@@ -67,1 +67,1 @@\n-  {{2, main_fj},     {1, thr1_sys}}\n+  {{2, main_fj},      {1, thr1_sys}}\n@@ -115,10 +115,0 @@\n-void release_thread_info(JNIEnv *jni, jvmtiThreadInfo *info) {\n-  deallocate(jvmti_env, jni, (unsigned char *)info->name);\n-  if (info->thread_group != NULL) {\n-    jni->DeleteLocalRef(info->thread_group);\n-  }\n-  if (info->context_class_loader != NULL) {\n-    jni->DeleteLocalRef(info->context_class_loader);\n-  }\n-}\n-\n@@ -128,1 +118,0 @@\n-  int expected = 0;\n@@ -140,1 +129,2 @@\n-    LOG(\" >>> %s\", inf.name);\n+    char *name = get_thread_name(jvmti_env, jni, threads[i]);\n+    LOG(\" >>> %s\", name);\n@@ -143,2 +133,2 @@\n-    for (int j = 0; j < thrInfo[idx].unexpected.cnt && !found; j++) {\n-      found = (inf.name != NULL && strcmp(inf.name, thrInfo[idx].unexpected.thr_names[j]) == 0);\n+    for (int j = 0; j < thr_info[idx].unexpected.cnt && !found; j++) {\n+      found = strcmp(name, thr_info[idx].unexpected.thr_names[j]) == 0;\n@@ -148,1 +138,0 @@\n-      release_thread_info(jni, &inf);\n@@ -151,1 +140,0 @@\n-    release_thread_info(jni, &inf);\n@@ -157,1 +145,1 @@\n-  for (int i = 0; i < thrInfo[idx].expected.cnt; i++) {\n+  for (int i = 0; i < thr_info[idx].expected.cnt; i++) {\n@@ -160,4 +148,2 @@\n-      err = jvmti_env->GetThreadInfo(threads[j], &inf);\n-      check_jvmti_status(jni, err, \"Failed in GetThreadInfo\");\n-      found = (inf.name != NULL && strcmp(inf.name, thrInfo[idx].expected.thr_names[i]) == 0);\n-      release_thread_info(jni, &inf);\n+      char *name = get_thread_name(jvmti_env, jni, threads[j]);\n+      found = strcmp(name, thr_info[idx].expected.thr_names[i]) == 0;\n@@ -166,1 +152,1 @@\n-      LOG(\"Point %d: thread %s not detected\\n\", idx, thrInfo[idx].expected.thr_names[i]);\n+      LOG(\"Point %d: thread %s not detected\\n\", idx, thr_info[idx].expected.thr_names[i]);\n","filename":"test\/hotspot\/jtreg\/serviceability\/jvmti\/thread\/GetAllThreads\/allthr01\/liballthr01.cpp","additions":11,"deletions":25,"binary":false,"changes":36,"status":"modified"}]}