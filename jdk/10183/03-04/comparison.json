{"files":[{"patch":"@@ -48,0 +48,1 @@\n+import static jdk.internal.net.http.HttpClientImpl.KEEP_ALIVE_TIMEOUT;\n@@ -54,2 +55,1 @@\n-    static final long KEEP_ALIVE = Utils.getIntegerNetProperty(\n-            \"jdk.httpclient.keepalive.timeout\", 600); \/\/ seconds\n+    static final long KEEP_ALIVE = KEEP_ALIVE_TIMEOUT; \/\/ seconds\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/ConnectionPool.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -736,3 +736,1 @@\n-            if (idleConnectionTimeoutEvent != null && idleConnectionTimeoutEvent.isFired()) {\n-                Log.logError(\"idleConnectionTimeout timeout fired, shutting down connection: {0}\", t.getMessage());\n-            } else if (!(t instanceof EOFException) || isActive()) {\n+            if (!(t instanceof EOFException) || isActive()) {\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/Http2Connection.java","additions":1,"deletions":3,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -114,0 +114,4 @@\n+    static final int DEFAULT_KEEP_ALIVE_TIMEOUT = 600;\n+    static final long KEEP_ALIVE_TIMEOUT = getTimeoutProp(\"jdk.httpclient.keepalive.timeout\", DEFAULT_KEEP_ALIVE_TIMEOUT);\n+    \/\/ Defaults to value used for HTTP\/1 Keep-Alive Timeout. Can be overridden by jdk.httpclient.keepalive.timeout.h2 property.\n+    static final long IDLE_CONNECTION_TIMEOUT = getTimeoutProp(\"jdk.httpclient.keepalive.timeout.h2\", KEEP_ALIVE_TIMEOUT);\n@@ -1526,1 +1530,1 @@\n-        return Optional.ofNullable(getIdleConnectionTimeoutProp());\n+        return Optional.ofNullable(getIdleConnectionTimeout());\n@@ -1693,9 +1697,3 @@\n-    private Duration getIdleConnectionTimeoutProp() {\n-        String s = Utils.getNetProperty(\"jdk.httpclient.keepalive.timeout\");\n-        if (s != null) {\n-            try {\n-                long val = Long.parseLong(s);\n-                if (val >= 0)\n-                    return Duration.ofSeconds(Long.parseLong(s));\n-            } catch (NumberFormatException ignored) {}\n-        }\n+    private Duration getIdleConnectionTimeout() {\n+        if (IDLE_CONNECTION_TIMEOUT >= 0)\n+            return Duration.ofSeconds(IDLE_CONNECTION_TIMEOUT);\n@@ -1705,0 +1703,12 @@\n+    private static long getTimeoutProp(String prop, long def) {\n+        String s = Utils.getNetProperty(prop);\n+        try {\n+            if (s != null) {\n+                long timeoutVal = Long.parseLong(s);\n+                System.err.println(timeoutVal);\n+                if (timeoutVal >= 0) return timeoutVal;\n+            }\n+        } catch (NumberFormatException ignored) {}\n+        return def;\n+    }\n+\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/HttpClientImpl.java","additions":20,"deletions":10,"binary":false,"changes":30,"status":"modified"},{"patch":"@@ -35,3 +35,6 @@\n- * @run testng\/othervm -Djdk.httpclient.keepalive.timeout=8 IdleConnectionTimeoutTest\n- * @run testng\/othervm -Djdk.httpclient.keepalive.timeout=1 IdleConnectionTimeoutTest\n- * @run testng\/othervm  IdleConnectionTimeoutTest\n+ * @run testng\/othervm -Djdk.httpclient.HttpClient.log=errors -Djdk.httpclient.keepalive.timeout.h2=2 IdleConnectionTimeoutTest\n+ * @run testng\/othervm -Djdk.httpclient.HttpClient.log=errors -Djdk.httpclient.keepalive.timeout.h2=1 IdleConnectionTimeoutTest\n+ * @run testng\/othervm -Djdk.httpclient.HttpClient.log=errors IdleConnectionTimeoutTest\n+ * @run testng\/othervm -Djdk.httpclient.HttpClient.log=errors -Djdk.httpclient.keepalive.timeout.h2=abc IdleConnectionTimeoutTest\n+ * @run testng\/othervm -Djdk.httpclient.HttpClient.log=errors -Djdk.httpclient.keepalive.timeout.h2=-1 IdleConnectionTimeoutTest\n+ * @run testng\/othervm -Djdk.httpclient.HttpClient.log=errors -Djdk.httpclient.keepalive.timeout.h2=1 -Djdk.httpclient.keepalive.timeout=2 IdleConnectionTimeoutTest\n@@ -61,1 +64,2 @@\n-    final String IDLE_CONN_PROPERTY = \"jdk.httpclient.keepalive.timeout\";\n+    final String IDLE_CONN_PROPERTY = \"jdk.httpclient.keepalive.timeout.h2\";\n+    final String KEEP_ALIVE_PROPERTY = \"jdk.httpclient.keepalive.timeout\";\n@@ -86,1 +90,2 @@\n-        testLog.println(\"Test run for jdk.httpclient.keepalive.timeout=\" + timeoutVal);\n+        String keepAliveVal = System.getProperty(KEEP_ALIVE_PROPERTY);\n+        testLog.println(\"Test run for \" + IDLE_CONN_PROPERTY + \"=\" + timeoutVal);\n@@ -93,1 +98,3 @@\n-            if (timeoutVal.equals(\"1\")) {\n+            if (keepAliveVal != null) {\n+                \/\/ In this case, specified h2 timeout should override keep alive timeout.\n+                \/\/ Timeout should occur\n@@ -95,1 +102,1 @@\n-                sleepTime = 8000;\n+                sleepTime = 2000;\n@@ -98,1 +105,8 @@\n-            } else if (timeoutVal.equals(\"8\")) {\n+            } else if (timeoutVal.equals(\"1\")) {\n+                \/\/ Timeout should occur\n+                hreq = HttpRequest.newBuilder(timeoutUri).version(HTTP_2).GET().build();\n+                sleepTime = 2000;\n+                hresp = runRequest(hc, hreq, sleepTime);\n+                assertEquals(hresp.statusCode(), 200, \"idleConnectionTimeoutEvent was expected but did not occur\");\n+            } else if (timeoutVal.equals(\"2\")) {\n+                \/\/ Timeout should not occur\n@@ -103,0 +117,5 @@\n+            } else if (timeoutVal.equals(\"abc\") || timeoutVal.equals(\"-1\")) {\n+                \/\/ Timeout should not occur\n+                hreq = HttpRequest.newBuilder(noTimeoutUri).version(HTTP_2).GET().build();\n+                hresp = runRequest(hc, hreq, sleepTime);\n+                assertEquals(hresp.statusCode(), 200, \"idleConnectionTimeoutEvent was not expected but occurred\");\n@@ -105,2 +124,1 @@\n-            \/\/ When a poorly formatted property value is given or no value is specified\n-            \/\/ then no timeout should occur\n+            \/\/ When no value is specified then no timeout should occur (default keep alive value of 600 used)\n","filename":"test\/jdk\/java\/net\/httpclient\/http2\/IdleConnectionTimeoutTest.java","additions":28,"deletions":10,"binary":false,"changes":38,"status":"modified"}]}