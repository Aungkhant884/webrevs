{"files":[{"patch":"@@ -70,1 +70,1 @@\n-    static final int DEBUGGEE_STOPATLINE = 80;\n+    static final int DEBUGGEE_STOPATLINE = 81;\n@@ -86,0 +86,1 @@\n+    private ReferenceType mainClass;\n@@ -128,1 +129,1 @@\n-            ReferenceType rType = debuggee.classByName(DEBUGGEE_CLASS);\n+            mainClass = debuggee.classByName(DEBUGGEE_CLASS);\n@@ -130,1 +131,1 @@\n-            suspendAtBP(rType, DEBUGGEE_STOPATLINE);\n+            suspendAtBP(mainClass, DEBUGGEE_STOPATLINE);\n@@ -135,2 +136,2 @@\n-            stopLoop1 = rType.fieldByName(DEBUGGEE_STOP_LOOP1_FIELD);\n-            stopLoop2 = rType.fieldByName(DEBUGGEE_STOP_LOOP2_FIELD);\n+            stopLoop1 = mainClass.fieldByName(DEBUGGEE_STOP_LOOP1_FIELD);\n+            stopLoop2 = mainClass.fieldByName(DEBUGGEE_STOP_LOOP2_FIELD);\n@@ -148,1 +149,1 @@\n-            log.display(\"\\nTEST #1: Trying to stop debuggee thread using non-throwable object\");\n+            log.display(\"\\nTEST #1: Trying to stop debuggee thread using non-throwable object.\");\n@@ -165,1 +166,1 @@\n-            log.display(\"\\nTEST #2: Trying to stop debuggee thread while suspended at a breakpoint\");\n+            log.display(\"\\nTEST #2: Trying to stop debuggee thread while suspended at a breakpoint.\");\n@@ -182,2 +183,2 @@\n-            Thread.sleep(1000); \/\/ Allow debuggee to get into loop first\n-            log.display(\"\\nTEST #3: Trying to stop debuggee thread while not suspended in a loop\");\n+            log.display(\"\\nTEST #3: Trying to stop debuggee thread while not suspended in a loop.\");\n+            waitForTestReady(3);\n@@ -213,2 +214,2 @@\n-            Thread.sleep(1000); \/\/ Allow debuggee to get into loop first.\n-            log.display(\"\\nTEST #4: Trying to stop debuggee thread while suspended in a loop\");\n+            log.display(\"\\nTEST #4: Trying to stop debuggee thread while suspended in a loop.\");\n+            waitForTestReady(4);\n@@ -237,2 +238,13 @@\n-            Thread.sleep(1000); \/\/ Allow debuggee to reach Thread.sleep() first.\n-            log.display(\"\\nTEST #5: Trying to stop debuggee thread while suspended in Thread.sleep()\");\n+            log.display(\"\\nTEST #5: Trying to stop debuggee thread while suspended in Thread.sleep().\");\n+            waitForTestReady(5);\n+            \/\/ Allow debuggee to reach Thread.sleep() first.\n+            log.display(\"TEST #5: waiting for debuggee to sleep.\");\n+            while (true) {\n+                int status = thrRef.status();\n+                if (status == ThreadReference.THREAD_STATUS_SLEEPING ||\n+                    status == ThreadReference.THREAD_STATUS_WAIT)\n+                {\n+                    break;\n+                }\n+                Thread.sleep(50);\n+            }\n@@ -281,0 +293,8 @@\n+    private void waitForTestReady(int testNum) {\n+        log.display(\"TEST #\" + testNum + \": waiting for test ready.\");\n+        IntegerValue ival;\n+        do {\n+            ival = (IntegerValue)mainClass.getValue(mainClass.fieldByName(\"testNumReady\"));\n+        } while (ival.value() != testNum);\n+    }\n+\n","filename":"test\/hotspot\/jtreg\/vmTestbase\/nsk\/jdi\/ThreadReference\/stop\/stop002.java","additions":33,"deletions":13,"binary":false,"changes":46,"status":"modified"},{"patch":"@@ -40,0 +40,1 @@\n+    volatile static int testNumReady = 0;\n@@ -101,0 +102,1 @@\n+                testNumReady = 3; \/\/ signal debugger side of test that we are ready\n@@ -129,0 +131,1 @@\n+                testNumReady = 4; \/\/ signal debugger side of test that we are ready\n@@ -152,0 +155,3 @@\n+                \/\/ Signal debugger side of test that we are \"almost\" ready. The\n+                \/\/ debugger will still need to check that we are in the sleep state.\n+                testNumReady = 5;\n","filename":"test\/hotspot\/jtreg\/vmTestbase\/nsk\/jdi\/ThreadReference\/stop\/stop002t.java","additions":6,"deletions":0,"binary":false,"changes":6,"status":"modified"}]}