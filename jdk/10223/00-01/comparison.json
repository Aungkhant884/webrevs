{"files":[{"patch":"@@ -56,0 +56,2 @@\n+import jdk.test.lib.util.ForceGC;\n+\n@@ -113,1 +115,1 @@\n-        WeakReference<Object> wCanary[] = new WeakReference[LOADER_COUNT];\n+        final WeakReference<Object> wCanary[] = new WeakReference[LOADER_COUNT];\n@@ -163,9 +165,11 @@\n-        \/\/ Wait for the canary for each of the libraries to be GC'd\n-        \/\/ before exiting the test.\n-        int dequeueCount = 0;\n-        for (int i = 0; i < LOADER_COUNT; i++) {\n-            System.gc();\n-            if (refQueue.remove(Utils.adjustTimeout(10 * 1000L)) != null)\n-                dequeueCount++;\n-        }\n-        Asserts.assertEquals(dequeueCount, LOADER_COUNT, \"Too few cleared WeakReferences\");\n+\n+        \/\/ Wait for the canary for each of the libraries to be GC'd (cleared)\n+        boolean allClear = ForceGC.wait(() -> {\n+            for (int i = 0; i < wCanary.length; i++) {\n+                if (!wCanary[i].refersTo(null)) {\n+                    return false;\n+                }\n+            }\n+            return true;\n+        });\n+        Asserts.assertTrue(allClear, \"Not all WeakReferences cleared\");\n","filename":"test\/jdk\/java\/lang\/ClassLoader\/loadLibraryUnload\/LoadLibraryUnload.java","additions":14,"deletions":10,"binary":false,"changes":24,"status":"modified"},{"patch":"@@ -37,1 +37,1 @@\n- * @run main\/othervm\/native -Xcheck:jni LoadLibraryUnloadTest\n+ * @run main\/othervm\/native LoadLibraryUnloadTest\n@@ -42,1 +42,1 @@\n-import jdk.test.lib.process.*;\n+import jdk.test.lib.process.OutputAnalyzer;\n@@ -53,1 +53,0 @@\n-    private static String classPathSeparator = System.getProperty(\"path.separator\");\n","filename":"test\/jdk\/java\/lang\/ClassLoader\/loadLibraryUnload\/LoadLibraryUnloadTest.java","additions":2,"deletions":3,"binary":false,"changes":5,"status":"modified"}]}