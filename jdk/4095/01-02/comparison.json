{"files":[{"patch":"@@ -1226,1 +1226,3 @@\n-                            separateAnnotationsKinds(param.vartype, param.sym.type, param.sym, pos);\n+                            if (!param.declaredUsingVar()) {\n+                                separateAnnotationsKinds(param.vartype, param.sym.type, param.sym, pos);\n+                            }\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/code\/TypeAnnotations.java","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -3475,1 +3475,2 @@\n-        return toP(F.at(pos).VarDef(mods, name, type, null));\n+        return toP(F.at(pos).VarDef(mods, name, type, null,\n+                type != null && type.hasTag(IDENT) && ((JCIdent)type).name == names.var));\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/parser\/JavacParser.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -0,0 +1,138 @@\n+\/*\n+ * Copyright (c) 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/*\n+ * @test\n+ * @bug 8261205\n+ * @summary check that potentially applicable type annotations are skip if the variable or parameter was declared with var\n+ * @library \/tools\/lib\n+ * @modules\n+ *      jdk.jdeps\/com.sun.tools.classfile\n+ *      jdk.compiler\/com.sun.tools.javac.api\n+ *      jdk.compiler\/com.sun.tools.javac.main\n+ *      jdk.compiler\/com.sun.tools.javac.code\n+ *      jdk.compiler\/com.sun.tools.javac.util\n+ * @build toolbox.ToolBox toolbox.JavacTask\n+ * @run main VariablesDeclaredWithVarTest\n+ *\/\n+\n+import java.util.List;\n+import java.util.ArrayList;\n+\n+import java.io.File;\n+import java.nio.file.Paths;\n+\n+import java.lang.annotation.*;\n+import java.util.Arrays;\n+\n+import com.sun.tools.classfile.*;\n+import com.sun.tools.javac.util.Assert;\n+\n+import toolbox.JavacTask;\n+import toolbox.ToolBox;\n+\n+public class VariablesDeclaredWithVarTest {\n+    ToolBox tb = new ToolBox();\n+\n+    final String src =\n+            \"\"\"\n+            import java.util.function.*;\n+            import java.lang.annotation.ElementType;\n+            import java.lang.annotation.Target;\n+\n+            @Target({ElementType.TYPE_USE, ElementType.PARAMETER, ElementType.LOCAL_VARIABLE})\n+            @interface A {}\n+\n+            class Test {\n+                void kaa() {\n+                    @A var c = g(1, 1L);\n+                }\n+\n+                <X> X g(X a, X b) {\n+                    return a;\n+                }\n+\n+                void foo() {\n+                    bar((@A var s) -> s);\n+                }\n+\n+                void bar(Function<String, String> f) {}\n+            }\n+            \"\"\";\n+\n+    public static void main(String... args) throws Exception {\n+        new VariablesDeclaredWithVarTest().run();\n+    }\n+\n+    void run() throws Exception {\n+        compileTestClass();\n+        checkClassFile(new File(Paths.get(System.getProperty(\"user.dir\"),\n+                \"Test.class\").toUri()), 0);\n+    }\n+\n+    void compileTestClass() throws Exception {\n+        new JavacTask(tb)\n+                .sources(src)\n+                .run();\n+    }\n+\n+    void checkClassFile(final File cfile, int... taPositions) throws Exception {\n+        ClassFile classFile = ClassFile.read(cfile);\n+        List<TypeAnnotation> annos = new ArrayList<>();\n+        for (Method method : classFile.methods) {\n+            findAnnotations(classFile, method, annos);\n+            String methodName = method.getName(classFile.constant_pool);\n+            Assert.check(annos.size() == 0, \"there shouldn't be any type annotations in any method, found \" + annos.size() +\n+                    \" type annotations at method \" + methodName);\n+        }\n+    }\n+\n+    void findAnnotations(ClassFile cf, Method m, List<TypeAnnotation> annos) {\n+        findAnnotations(cf, m, Attribute.RuntimeVisibleTypeAnnotations, annos);\n+        findAnnotations(cf, m, Attribute.RuntimeInvisibleTypeAnnotations, annos);\n+    }\n+\n+    void findAnnotations(ClassFile cf, Method m, String name, List<TypeAnnotation> annos) {\n+        int index = m.attributes.getIndex(cf.constant_pool, name);\n+        if (index != -1) {\n+            Attribute attr = m.attributes.get(index);\n+            assert attr instanceof RuntimeTypeAnnotations_attribute;\n+            RuntimeTypeAnnotations_attribute tAttr = (RuntimeTypeAnnotations_attribute)attr;\n+            annos.addAll(Arrays.asList(tAttr.annotations));\n+        }\n+\n+        int cindex = m.attributes.getIndex(cf.constant_pool, Attribute.Code);\n+        if (cindex != -1) {\n+            Attribute cattr = m.attributes.get(cindex);\n+            assert cattr instanceof Code_attribute;\n+            Code_attribute cAttr = (Code_attribute)cattr;\n+            index = cAttr.attributes.getIndex(cf.constant_pool, name);\n+            if (index != -1) {\n+                Attribute attr = cAttr.attributes.get(index);\n+                assert attr instanceof RuntimeTypeAnnotations_attribute;\n+                RuntimeTypeAnnotations_attribute tAttr = (RuntimeTypeAnnotations_attribute)attr;\n+                annos.addAll(Arrays.asList(tAttr.annotations));\n+            }\n+        }\n+    }\n+}\n","filename":"test\/langtools\/tools\/javac\/annotations\/typeAnnotations\/VariablesDeclaredWithVarTest.java","additions":138,"deletions":0,"binary":false,"changes":138,"status":"added"},{"patch":"@@ -1,47 +0,0 @@\n-\/*\n- * Copyright (c) 2021, Oracle and\/or its affiliates. All rights reserved.\n- * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n- *\n- * This code is free software; you can redistribute it and\/or modify it\n- * under the terms of the GNU General Public License version 2 only, as\n- * published by the Free Software Foundation.\n- *\n- * This code is distributed in the hope that it will be useful, but WITHOUT\n- * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n- * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n- * version 2 for more details (a copy is included in the LICENSE file that\n- * accompanied this code).\n- *\n- * You should have received a copy of the GNU General Public License version\n- * 2 along with this work; if not, write to the Free Software Foundation,\n- * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n- *\n- * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n- * or visit www.oracle.com if you need additional information or have any\n- * questions.\n- *\/\n-\n-\/*\n- * @test\n- * @bug 8261205\n- * @summary assertion error: cannot add metadata to an intersection type\n- * @compile AnnotationOnInferredIntersectionType.java\n- *\/\n-\n-import java.lang.annotation.ElementType;\n-import java.lang.annotation.Target;\n-\n-class AnnotationOnInferredIntersectionType {\n-    @Target({ElementType.TYPE_USE, ElementType.LOCAL_VARIABLE})\n-    @interface A {}\n-\n-    class Test {\n-        void t() {\n-            @A var c = g(1, 1L);\n-        }\n-\n-        <X> X g(X a, X b) {\n-            return a;\n-        }\n-    }\n-}\n","filename":"test\/langtools\/tools\/javac\/lvti\/AnnotationOnInferredIntersectionType.java","additions":0,"deletions":47,"binary":false,"changes":47,"status":"deleted"}]}