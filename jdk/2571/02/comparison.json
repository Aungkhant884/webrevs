{"files":[{"patch":"@@ -51,0 +51,1 @@\n+  Thread*             _requester;\n@@ -53,1 +54,1 @@\n-  HandshakeOperation(AsyncHandshakeClosure* cl, JavaThread* target) :\n+  HandshakeOperation(AsyncHandshakeClosure* cl, JavaThread* target, Thread* requester) :\n@@ -56,1 +57,2 @@\n-    _target(target) {}\n+    _target(target),\n+    _requester(requester) {}\n@@ -59,1 +61,1 @@\n-  HandshakeOperation(HandshakeClosure* cl, JavaThread* target) :\n+  HandshakeOperation(HandshakeClosure* cl, JavaThread* target, Thread* requester) :\n@@ -62,1 +64,2 @@\n-    _target(target) {}\n+    _target(target),\n+    _requester(requester) {}\n@@ -64,0 +67,1 @@\n+  void prepare(JavaThread* current_target, Thread* executing_thread);\n@@ -80,1 +84,1 @@\n-    : HandshakeOperation(cl, target), _start_time_ns(start_ns) {}\n+    : HandshakeOperation(cl, target, NULL), _start_time_ns(start_ns) {}\n@@ -279,0 +283,16 @@\n+void HandshakeOperation::prepare(JavaThread* current_target, Thread* executing_thread) {\n+  if (current_target->is_terminated()) {\n+    \/\/ Will never execute any handshakes on this thread.\n+    return;\n+  }\n+  if (current_target != executing_thread) {\n+    \/\/ Only when the target is not executing the handshake itself.\n+    StackWatermarkSet::start_processing(current_target, StackWatermarkKind::gc);\n+  }\n+  if (_requester != NULL && _requester != executing_thread && _requester->is_Java_thread()) {\n+    \/\/ The handshake closure may contain oop Handles from the _requester.\n+    \/\/ We must make sure we can use them.\n+    StackWatermarkSet::start_processing(_requester->as_Java_thread(), StackWatermarkKind::gc);\n+  }\n+}\n+\n@@ -308,1 +328,1 @@\n-  HandshakeOperation cto(hs_cl, NULL);\n+  HandshakeOperation cto(hs_cl, NULL, Thread::current());\n@@ -315,1 +335,1 @@\n-  HandshakeOperation op(hs_cl, target);\n+  HandshakeOperation op(hs_cl, target, Thread::current());\n@@ -433,0 +453,1 @@\n+      op->prepare(_handshakee, _handshakee);\n@@ -525,3 +546,1 @@\n-      if (!_handshakee->is_terminated()) {\n-        StackWatermarkSet::start_processing(_handshakee, StackWatermarkKind::gc);\n-      }\n+      op->prepare(_handshakee, current_thread);\n","filename":"src\/hotspot\/share\/runtime\/handshake.cpp","additions":29,"deletions":10,"binary":false,"changes":39,"status":"modified"}]}