{"files":[{"patch":"@@ -50,0 +50,1 @@\n+  Thread*             _requester;\n@@ -52,1 +53,1 @@\n-  HandshakeOperation(AsyncHandshakeClosure* cl, JavaThread* target) :\n+  HandshakeOperation(AsyncHandshakeClosure* cl, JavaThread* target, Thread* requester) :\n@@ -55,1 +56,2 @@\n-    _target(target) {}\n+    _target(target),\n+    _requester(requester) {}\n@@ -58,1 +60,1 @@\n-  HandshakeOperation(HandshakeClosure* cl, JavaThread* target) :\n+  HandshakeOperation(HandshakeClosure* cl, JavaThread* target, Thread* requester) :\n@@ -61,1 +63,2 @@\n-    _target(target) {}\n+    _target(target),\n+    _requester(requester) {}\n@@ -63,0 +66,1 @@\n+  void prepare(JavaThread* current_target, Thread* executioner);\n@@ -79,1 +83,1 @@\n-    : HandshakeOperation(cl, target), _start_time_ns(start_ns) {}\n+    : HandshakeOperation(cl, target, NULL), _start_time_ns(start_ns) {}\n@@ -278,0 +282,13 @@\n+void HandshakeOperation::prepare(JavaThread* current_target, Thread* executioner) {\n+  if (current_target->is_terminated()) {\n+    \/\/ Will never execute any handshakes on this thread.\n+    return;\n+  }\n+  StackWatermarkSet::start_processing(current_target, StackWatermarkKind::gc);\n+  if (_requester != NULL && _requester != executioner && _requester->is_Java_thread()) {\n+    \/\/ The handshake closure may contains oop Handles from the _requester.\n+    \/\/ We must make sure we can use them.\n+    StackWatermarkSet::start_processing(_requester->as_Java_thread(), StackWatermarkKind::gc);\n+  }\n+}\n+\n@@ -307,1 +324,1 @@\n-  HandshakeOperation cto(hs_cl, NULL);\n+  HandshakeOperation cto(hs_cl, NULL, Thread::current());\n@@ -314,1 +331,1 @@\n-  HandshakeOperation op(hs_cl, target);\n+  HandshakeOperation op(hs_cl, target, Thread::current());\n@@ -524,3 +541,1 @@\n-      if (!_handshakee->is_terminated()) {\n-        StackWatermarkSet::start_processing(_handshakee, StackWatermarkKind::gc);\n-      }\n+      op->prepare(_handshakee, current_thread);\n","filename":"src\/hotspot\/share\/runtime\/handshake.cpp","additions":25,"deletions":10,"binary":false,"changes":35,"status":"modified"}]}