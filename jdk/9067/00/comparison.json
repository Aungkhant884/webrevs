{"files":[{"patch":"@@ -35,1 +35,6 @@\n-  DEBUG_ONLY(intptr_t* orig = *ContinuationHelper::Frame::callee_link_address(f));\n+  intptr_t* orig_fp = *ContinuationHelper::Frame::callee_link_address(f);\n+\n+  \/\/ Updating the FP requires resigning of the return address.\n+  intptr_t* ret_pc_addr = (f.sp() - frame::return_addr_offset);\n+  pauth_resign_return_address((address *)ret_pc_addr, (address)orig_fp, (address)fp);\n+\n@@ -41,2 +46,7 @@\n-  intptr_t new_value = fp - la;\n-  *la = new_value;\n+  intptr_t new_fp_value = fp - la;\n+\n+  \/\/ Updating the FP requires resigning of the return address.\n+  intptr_t* ret_pc_addr = (f.sp() - frame::return_addr_offset);\n+  pauth_resign_return_address((address *)ret_pc_addr, (address)*la, (address)new_fp_value);\n+\n+  *la = new_fp_value;\n@@ -65,1 +75,1 @@\n-  address sender_pc = (address) *(sender_sp-1);\n+  address sender_pc = ContinuationHelper::return_pc_at(sender_sp-1);\n","filename":"src\/hotspot\/cpu\/aarch64\/continuationFreezeThaw_aarch64.inline.hpp","additions":14,"deletions":4,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -68,0 +68,6 @@\n+  intptr_t* orig_fp = *ContinuationHelper::Frame::callee_link_address(f);\n+\n+  \/\/ Updating the FP requires resigning of the return address.\n+  intptr_t* ret_pc_addr = (f.sp() - frame::return_addr_offset);\n+  pauth_resign_return_address((address *)ret_pc_addr, (address)orig_fp, (address)f.fp());\n+\n@@ -71,0 +77,3 @@\n+inline address ContinuationHelper::return_pc_at(intptr_t *sp) {\n+  return pauth_strip_pointer(*(address*)sp);\n+}\n@@ -84,1 +93,1 @@\n-  address pc = *(address*)(sp - frame::sender_sp_ret_address_offset());\n+  address pc = ContinuationHelper::return_pc_at(sp - frame::sender_sp_ret_address_offset());\n@@ -112,1 +121,1 @@\n-  return *pc_addr;\n+  return pauth_strip_pointer(*pc_addr);\n@@ -117,1 +126,2 @@\n-  *pc_addr = pc;\n+  address signing_sp = ((address*) f.sp())[-2];\n+  *pc_addr = pauth_sign_return_address(pc, signing_sp);\n","filename":"src\/hotspot\/cpu\/aarch64\/continuationHelper_aarch64.inline.hpp","additions":13,"deletions":3,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -155,1 +155,4 @@\n-inline frame::frame(intptr_t* sp) : frame(sp, sp, *(intptr_t**)(sp - frame::sender_sp_offset), *(address*)(sp - 1)) {}\n+inline frame::frame(intptr_t* sp)\n+  : frame(sp, sp, *(intptr_t**)(sp - frame::sender_sp_offset),\n+          pauth_strip_verifiable(*(address*)(sp - frame::return_addr_offset),\n+                                 *(address*)(sp - frame::sender_sp_offset))) {}\n","filename":"src\/hotspot\/cpu\/aarch64\/frame_aarch64.inline.hpp","additions":4,"deletions":1,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -88,0 +88,7 @@\n+\/\/ Authenticate then sign a return value using different sp values.\n+\/\/\n+inline void pauth_resign_return_address(address *ret_addr, address old_sp, address new_sp) {\n+  address orig_ret_pc = pauth_authenticate_return_address(*ret_addr, old_sp);\n+  *ret_addr = pauth_sign_return_address(orig_ret_pc, new_sp);\n+}\n+\n","filename":"src\/hotspot\/cpu\/aarch64\/pauth_aarch64.hpp","additions":7,"deletions":0,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -29,0 +29,1 @@\n+#include \"pauth_aarch64.hpp\"\n@@ -55,1 +56,1 @@\n-  return *(address*)(_sp - 1);\n+  return pauth_strip_pointer(*(address*)(_sp - 1));\n","filename":"src\/hotspot\/cpu\/aarch64\/stackChunkFrameStream_aarch64.inline.hpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -6746,0 +6746,1 @@\n+      __ authenticate_return_address(c_rarg1, rscratch1);\n@@ -6757,1 +6758,1 @@\n-      __ mov(r0, r19); \/\/ restore return value contaning the exception oop\n+      __ mov(r0, r19); \/\/ restore return value containing the exception oop\n","filename":"src\/hotspot\/cpu\/aarch64\/stubGenerator_aarch64.cpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -61,0 +61,4 @@\n+inline address ContinuationHelper::return_pc_at(intptr_t *sp) {\n+  return *(address*)sp;\n+}\n+\n","filename":"src\/hotspot\/cpu\/arm\/continuationHelper_arm.inline.hpp","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -59,0 +59,3 @@\n+inline address ContinuationHelper::return_pc_at(intptr_t *sp) {\n+  return *(address*)sp;\n+}\n","filename":"src\/hotspot\/cpu\/ppc\/continuationHelper_ppc.inline.hpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -59,0 +59,3 @@\n+inline address ContinuationHelper::return_pc_at(intptr_t *sp) {\n+  return *(address*)sp;\n+}\n","filename":"src\/hotspot\/cpu\/riscv\/continuationHelper_riscv.inline.hpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -61,0 +61,4 @@\n+inline address ContinuationHelper::return_pc_at(intptr_t *sp) {\n+  return *(address*)sp;\n+}\n+\n","filename":"src\/hotspot\/cpu\/s390\/continuationHelper_s390.inline.hpp","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -71,0 +71,4 @@\n+inline address ContinuationHelper::return_pc_at(intptr_t *sp) {\n+  return *(address*)sp;\n+}\n+\n","filename":"src\/hotspot\/cpu\/x86\/continuationHelper_x86.inline.hpp","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -59,0 +59,4 @@\n+inline address ContinuationHelper::return_pc_at(intptr_t *sp) {\n+  return *(address*)sp;\n+}\n+\n","filename":"src\/hotspot\/cpu\/zero\/continuationHelper_zero.inline.hpp","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -29,0 +29,1 @@\n+#include \"runtime\/continuationHelper.inline.hpp\"\n@@ -101,1 +102,1 @@\n-  address pc = *(address*)(sp - frame::sender_sp_ret_address_offset());\n+  address pc = ContinuationHelper::return_pc_at(sp - frame::sender_sp_ret_address_offset());\n","filename":"src\/hotspot\/share\/runtime\/continuationEntry.cpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -292,1 +292,1 @@\n-  address pc = *(address*)(sp - frame::sender_sp_ret_address_offset());\n+  address pc = ContinuationHelper::return_pc_at(sp - frame::sender_sp_ret_address_offset());\n@@ -585,1 +585,1 @@\n-    assert(*(address*)(chunk->sp_address() - frame::sender_sp_ret_address_offset()) == chunk->pc(), \"\");\n+    assert(ContinuationHelper::return_pc_at(chunk->sp_address() - frame::sender_sp_ret_address_offset()) == chunk->pc(), \"\");\n@@ -598,1 +598,1 @@\n-    assert(*(address*)(bottom_sp-frame::sender_sp_ret_address_offset()) == StubRoutines::cont_returnBarrier(),\n+    assert(ContinuationHelper::return_pc_at(bottom_sp - frame::sender_sp_ret_address_offset()) == StubRoutines::cont_returnBarrier(),\n@@ -668,1 +668,1 @@\n-  assert(_empty || *(address*)(_orig_chunk_sp - frame::sender_sp_ret_address_offset()) == chunk->pc(), \"\");\n+  assert(_empty || ContinuationHelper::return_pc_at(_orig_chunk_sp - frame::sender_sp_ret_address_offset()) == chunk->pc(), \"\");\n@@ -679,1 +679,1 @@\n-  assert(_empty || *(address*)(chunk_bottom_sp-frame::sender_sp_ret_address_offset()) == StubRoutines::cont_returnBarrier(), \"\");\n+  assert(_empty || ContinuationHelper::return_pc_at(chunk_bottom_sp-frame::sender_sp_ret_address_offset()) == StubRoutines::cont_returnBarrier(), \"\");\n@@ -685,1 +685,1 @@\n-  chunk->set_pc(*(address*)(_cont_stack_top - frame::sender_sp_ret_address_offset()));\n+  chunk->set_pc(ContinuationHelper::return_pc_at(_cont_stack_top - frame::sender_sp_ret_address_offset()));\n","filename":"src\/hotspot\/share\/runtime\/continuationFreezeThaw.cpp","additions":6,"deletions":6,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -47,0 +47,2 @@\n+  static inline address return_pc_at(intptr_t *sp);\n+\n@@ -71,1 +73,1 @@\n-  static address return_pc(const frame& f) { return *return_pc_address(f); }\n+  static address return_pc(const frame& f);\n","filename":"src\/hotspot\/share\/runtime\/continuationHelper.hpp","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -51,0 +51,4 @@\n+inline address ContinuationHelper::Frame::return_pc(const frame& f) {\n+  return return_pc_at((intptr_t *)return_pc_address(f));\n+}\n+\n@@ -92,1 +96,1 @@\n-  return *return_pc_address(f);\n+  return return_pc_at((intptr_t *)return_pc_address(f));\n","filename":"src\/hotspot\/share\/runtime\/continuationHelper.inline.hpp","additions":5,"deletions":1,"binary":false,"changes":6,"status":"modified"}]}