{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2020, Oracle and\/or its affiliates. All rights reserved.\n@@ -295,1 +295,2 @@\n-  _current_size += written;\n+  if (written > 0) {\n+    _current_size += written;\n@@ -297,2 +298,3 @@\n-  if (should_rotate()) {\n-    rotate();\n+    if (should_rotate()) {\n+      rotate();\n+    }\n@@ -313,1 +315,2 @@\n-  _current_size += written;\n+  if (written > 0) {\n+    _current_size += written;\n@@ -315,2 +318,3 @@\n-  if (should_rotate()) {\n-    rotate();\n+    if (should_rotate()) {\n+      rotate();\n+    }\n","filename":"src\/hotspot\/share\/logging\/logFileOutput.cpp","additions":11,"deletions":7,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, 2017, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2020, Oracle and\/or its affiliates. All rights reserved.\n@@ -31,0 +31,1 @@\n+#include \"utilities\/defaultStream.hpp\"\n@@ -75,0 +76,25 @@\n+class FileLocker : public StackObj {\n+private:\n+  FILE *_file;\n+\n+public:\n+  FileLocker(FILE *file) : _file(file) {\n+    os::flockfile(_file);\n+  }\n+\n+  ~FileLocker() {\n+    os::funlockfile(_file);\n+  }\n+};\n+\n+#define WRITE_LOG_WITH_RESULT_CHECK(result, op, total)      \\\n+  result = op;                                              \\\n+  if (result <= 0) {                                        \\\n+    jio_fprintf(defaultStream::error_stream(),              \\\n+                \"Could not write log: %s\\n\", name());       \\\n+    return -1;                                              \\\n+  }                                                         \\\n+  total += result;\n+\n+static bool fflush_error_is_shown = false;\n+\n@@ -78,2 +104,3 @@\n-  int written = 0;\n-  os::flockfile(_stream);\n+  int written;\n+  int total_written = 0;\n+  FileLocker flocker(_stream);\n@@ -81,2 +108,11 @@\n-    written += write_decorations(decorations);\n-    written += jio_fprintf(_stream, \" \");\n+    WRITE_LOG_WITH_RESULT_CHECK(written, write_decorations(decorations), total_written);\n+    WRITE_LOG_WITH_RESULT_CHECK(written, jio_fprintf(_stream, \" \"), total_written);\n+  }\n+  WRITE_LOG_WITH_RESULT_CHECK(written, jio_fprintf(_stream, \"%s\\n\", msg), total_written);\n+  if (fflush(_stream) != 0) {\n+    if (!fflush_error_is_shown) {\n+      jio_fprintf(defaultStream::error_stream(),\n+                  \"Could not flush log: %s (%s (%d))\\n\", name(), os::strerror(errno), errno);\n+      fflush_error_is_shown = true;\n+    }\n+    return -1;\n@@ -84,3 +120,0 @@\n-  written += jio_fprintf(_stream, \"%s\\n\", msg);\n-  fflush(_stream);\n-  os::funlockfile(_stream);\n@@ -88,1 +121,1 @@\n-  return written;\n+  return total_written;\n@@ -94,2 +127,3 @@\n-  int written = 0;\n-  os::flockfile(_stream);\n+  int written;\n+  int total_written = 0;\n+  FileLocker flocker(_stream);\n@@ -98,2 +132,4 @@\n-      written += write_decorations(msg_iterator.decorations());\n-      written += jio_fprintf(_stream, \" \");\n+      WRITE_LOG_WITH_RESULT_CHECK(written,\n+                                  write_decorations(msg_iterator.decorations()),\n+                                  total_written);\n+      WRITE_LOG_WITH_RESULT_CHECK(written, jio_fprintf(_stream, \" \"), total_written);\n@@ -101,1 +137,11 @@\n-    written += jio_fprintf(_stream, \"%s\\n\", msg_iterator.message());\n+    WRITE_LOG_WITH_RESULT_CHECK(written,\n+                                jio_fprintf(_stream, \"%s\\n\", msg_iterator.message()),\n+                                total_written);\n+  }\n+  if (fflush(_stream) != 0) {\n+    if (!fflush_error_is_shown) {\n+      jio_fprintf(defaultStream::error_stream(),\n+                  \"Could not flush log: %s (%s (%d))\\n\", name(), os::strerror(errno), errno);\n+      fflush_error_is_shown = true;\n+    }\n+    return -1;\n@@ -103,2 +149,0 @@\n-  fflush(_stream);\n-  os::funlockfile(_stream);\n@@ -106,1 +150,1 @@\n-  return written;\n+  return total_written;\n","filename":"src\/hotspot\/share\/logging\/logFileStreamOutput.cpp","additions":61,"deletions":17,"binary":false,"changes":78,"status":"modified"}]}