{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2020, Oracle and\/or its affiliates. All rights reserved.\n@@ -295,1 +295,2 @@\n-  _current_size += written;\n+  if (written > 0) {\n+    _current_size += written;\n@@ -297,2 +298,3 @@\n-  if (should_rotate()) {\n-    rotate();\n+    if (should_rotate()) {\n+      rotate();\n+    }\n@@ -313,1 +315,2 @@\n-  _current_size += written;\n+  if (written > 0) {\n+    _current_size += written;\n@@ -315,2 +318,3 @@\n-  if (should_rotate()) {\n-    rotate();\n+    if (should_rotate()) {\n+      rotate();\n+    }\n","filename":"src\/hotspot\/share\/logging\/logFileOutput.cpp","additions":11,"deletions":7,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -31,0 +31,1 @@\n+#include \"utilities\/defaultStream.hpp\"\n@@ -89,0 +90,31 @@\n+static bool write_error_is_shown = false;\n+\n+bool LogFileStreamOutput::flush() {\n+  bool result = true;\n+  if (fflush(_stream) != 0) {\n+    if (!write_error_is_shown) {\n+      jio_fprintf(defaultStream::error_stream(),\n+                  \"Could not flush log: %s (%s (%d))\\n\", name(), os::strerror(errno), errno);\n+      jio_fprintf(_stream, \"\\nERROR: Could not flush log (%d)\\n\", errno);\n+      write_error_is_shown = true;\n+    }\n+    result = false;\n+  }\n+  return result;\n+}\n+\n+#define WRITE_LOG_WITH_RESULT_CHECK(op, total)                \\\n+{                                                             \\\n+  int result = op;                                            \\\n+  if (result <= 0) {                                          \\\n+    if (!write_error_is_shown) {                              \\\n+      jio_fprintf(defaultStream::error_stream(),              \\\n+                  \"Could not write log: %s\\n\", name());       \\\n+      jio_fprintf(_stream, \"\\nERROR: Could not write log\\n\"); \\\n+      write_error_is_shown = true;                            \\\n+      return -1;                                              \\\n+    }                                                         \\\n+  }                                                           \\\n+  total += result;                                            \\\n+}\n+\n@@ -95,2 +127,2 @@\n-    written += write_decorations(decorations);\n-    written += jio_fprintf(_stream, \" \");\n+    WRITE_LOG_WITH_RESULT_CHECK(write_decorations(decorations), written);\n+    WRITE_LOG_WITH_RESULT_CHECK(jio_fprintf(_stream, \" \"), written);\n@@ -98,2 +130,1 @@\n-  written += jio_fprintf(_stream, \"%s\\n\", msg);\n-  fflush(_stream);\n+  WRITE_LOG_WITH_RESULT_CHECK(jio_fprintf(_stream, \"%s\\n\", msg), written);\n@@ -101,1 +132,1 @@\n-  return written;\n+  return flush() ? written : -1;\n@@ -111,2 +142,2 @@\n-      written += write_decorations(msg_iterator.decorations());\n-      written += jio_fprintf(_stream, \" \");\n+      WRITE_LOG_WITH_RESULT_CHECK(write_decorations(msg_iterator.decorations()), written);\n+      WRITE_LOG_WITH_RESULT_CHECK(jio_fprintf(_stream, \" \"), written);\n@@ -114,1 +145,1 @@\n-    written += jio_fprintf(_stream, \"%s\\n\", msg_iterator.message());\n+    WRITE_LOG_WITH_RESULT_CHECK(jio_fprintf(_stream, \"%s\\n\", msg_iterator.message()), written);\n@@ -116,1 +147,0 @@\n-  fflush(_stream);\n@@ -118,1 +148,1 @@\n-  return written;\n+  return flush() ? written : -1;\n","filename":"src\/hotspot\/share\/logging\/logFileStreamOutput.cpp","additions":40,"deletions":10,"binary":false,"changes":50,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2020, Oracle and\/or its affiliates. All rights reserved.\n@@ -54,0 +54,1 @@\n+  bool flush();\n","filename":"src\/hotspot\/share\/logging\/logFileStreamOutput.hpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"}]}