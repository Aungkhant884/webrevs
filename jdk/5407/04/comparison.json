{"files":[{"patch":"@@ -407,1 +407,30 @@\n-  bool success = parse_log_arguments(output, what, decorators, output_options, &ss);\n+  bool success = true;\n+\n+  \/\/ output options for stdout\/err should be applied just once.\n+  static bool stdout_configured = false;\n+  static bool stderr_configured = false;\n+\n+  \/\/ Normally options can't be used to change an existing output\n+  \/\/ (parse_log_arguments() will report an error), and\n+  \/\/ both StdoutLog and StderrLog are created by static initializers,\n+  \/\/ so we have to process their options (e.g. foldmultilines) directly first.\n+  if (output == NULL || strlen(output) == 0 ||\n+      strcmp(\"stdout\", output) == 0 || strcmp(\"#0\", output) == 0) {\n+    if (!stdout_configured) {\n+      success = StdoutLog.parse_options(output_options, &ss);\n+      stdout_configured = true;\n+      \/\/ We no longer need to pass output options to parse_log_arguments().\n+      output_options = NULL;\n+    }\n+  } else if (strcmp(\"stderr\", output) == 0 || strcmp(\"#1\", output) == 0) {\n+    if (!stderr_configured) {\n+      success = StderrLog.parse_options(output_options, &ss);\n+      stderr_configured = true;\n+      \/\/ We no longer need to pass output options to parse_log_arguments().\n+      output_options = NULL;\n+    }\n+  }\n+\n+  if (success) {\n+    success = parse_log_arguments(output, what, decorators, output_options, &ss);\n+  }\n@@ -561,0 +590,1 @@\n+  out->cr();\n@@ -562,1 +592,1 @@\n-  out->print_cr(\"\\nAvailable log outputs:\");\n+  out->print_cr(\"Available log outputs:\");\n@@ -566,14 +596,1 @@\n-  out->print_cr(\"  Additional output-options for file outputs:\");\n-  out->print_cr(\"   filesize=..       - Target byte size for log rotation (supports K\/M\/G suffix).\"\n-                                         \" If set to 0, log rotation will not trigger automatically,\"\n-                                         \" but can be performed manually (see the VM.log DCMD).\");\n-  out->print_cr(\"   filecount=..      - Number of files to keep in rotation (not counting the active file).\"\n-                                         \" If set to 0, log rotation is disabled.\"\n-                                         \" This will cause existing log files to be overwritten.\");\n-  out->print_cr(\"   foldmultilines=.. - If set to true, a log event that consists of multiple lines\"\n-                                         \" will be folded into a single line by replacing newline characters\"\n-                                         \" with the sequence '\\\\' and 'n' in the output.\"\n-                                         \" Existing single backslash characters will also be replaced\"\n-                                         \" with a sequence of two backslashes so that the conversion can be reversed.\"\n-                                         \" This option is safe to use with UTF-8 character encodings,\"\n-                                         \" but other encodings may not work.\");\n+  out->cr();\n@@ -581,0 +598,8 @@\n+  out->print_cr(\"Available log output options:\");\n+  out->print_cr(\" foldmultilines=.. - If set to true, a log event that consists of multiple lines\"\n+                                       \" will be folded into a single line by replacing newline characters\"\n+                                       \" with the sequence '\\\\' and 'n' in the output.\"\n+                                       \" Existing single backslash characters will also be replaced\"\n+                                       \" with a sequence of two backslashes so that the conversion can be reversed.\"\n+                                       \" This option is safe to use with UTF-8 character encodings,\"\n+                                       \" but other encodings may not work.\");\n@@ -582,1 +607,11 @@\n-  out->print_cr(\"\\nAsynchronous logging (off by default):\");\n+\n+  out->print_cr(\"Additional file output options:\");\n+  out->print_cr(\" filesize=..       - Target byte size for log rotation (supports K\/M\/G suffix).\"\n+                                       \" If set to 0, log rotation will not trigger automatically,\"\n+                                       \" but can be performed manually (see the VM.log DCMD).\");\n+  out->print_cr(\" filecount=..      - Number of files to keep in rotation (not counting the active file).\"\n+                                       \" If set to 0, log rotation is disabled.\"\n+                                       \" This will cause existing log files to be overwritten.\");\n+  out->cr();\n+\n+  out->print_cr(\"Asynchronous logging (off by default):\");\n","filename":"src\/hotspot\/share\/logging\/logConfiguration.cpp","additions":52,"deletions":17,"binary":false,"changes":69,"status":"modified"},{"patch":"@@ -460,4 +460,2 @@\n-  LogOutput::describe(out);\n-  out->print(\" \");\n-\n-  out->print(\"filecount=%u,filesize=\" SIZE_FORMAT \"%s,async=%s\", _file_count,\n+  LogFileStreamOutput::describe(out);\n+  out->print(\",filecount=%u,filesize=\" SIZE_FORMAT \"%s,async=%s\", _file_count,\n","filename":"src\/hotspot\/share\/logging\/logFileOutput.cpp","additions":2,"deletions":4,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -191,0 +191,7 @@\n+\n+void LogFileStreamOutput::describe(outputStream *out) {\n+  LogOutput::describe(out);\n+  out->print(\" \");\n+\n+  out->print(\"foldmultilines=%s\", _fold_multilines ? \"true\" : \"false\");\n+}\n","filename":"src\/hotspot\/share\/logging\/logFileStreamOutput.cpp","additions":7,"deletions":0,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -67,0 +67,1 @@\n+  virtual void describe(outputStream* out);\n","filename":"src\/hotspot\/share\/logging\/logFileStreamOutput.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -4436,1 +4436,0 @@\n-This option is available only for file outputs.\n","filename":"src\/java.base\/share\/man\/java.1","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -27,1 +27,1 @@\n- * @bug 8271186\n+ * @bug 8271186 8273471\n@@ -34,0 +34,1 @@\n+import java.util.regex.Pattern;\n@@ -39,2 +40,5 @@\n-    private static Path EXCEPTION_LOG_FILE = Path.of(\"exceptions.log\");\n-    private static String XLOG_BASE = \"-Xlog:exceptions=info:file=\" + EXCEPTION_LOG_FILE.toString();\n+    private static String EXCEPTION_LOG_FILE = \"exceptions.log\";\n+    private static String XLOG_BASE = \"-Xlog:exceptions=info:\";\n+    private static String EXCEPTION_MESSAGE = \"line 1\\nline 2\\\\nstring\";\n+    private static String FOLDED_EXCEPTION_MESSAGE = \"line 1\\\\nline 2\\\\\\\\nstring\";\n+    private static Pattern NEWLINE_LOG_PATTERN = Pattern.compile(\"line 1\\\\Rline 2\\\\\\\\nstring\", Pattern.MULTILINE);\n@@ -42,1 +46,10 @@\n-    private static void analyzeFoldMultilinesOn(ProcessBuilder pb) throws Exception {\n+    private static String getLog(String out, OutputAnalyzer output) throws Exception {\n+        return switch (out) {\n+            case \"\" -> output.getStdout();\n+            case \"stdout\" -> output.getStdout();\n+            case \"stderr\" -> output.getStderr();\n+            default -> Files.readString(Path.of(EXCEPTION_LOG_FILE));\n+        };\n+    }\n+\n+    private static void analyzeFoldMultilinesOn(ProcessBuilder pb, String out) throws Exception {\n@@ -45,4 +58,2 @@\n-\n-        String logs = Files.readString(EXCEPTION_LOG_FILE);\n-        if (!logs.contains(\"line 1\\\\nline 2\\\\\\\\nstring\")) {\n-            throw new RuntimeException(\"foldmultilines=true did not work.\");\n+        if (!getLog(out, output).contains(FOLDED_EXCEPTION_MESSAGE)) {\n+            throw new RuntimeException(out + \": foldmultilines=true did not work.\");\n@@ -52,1 +63,1 @@\n-    private static void analyzeFoldMultilinesOff(ProcessBuilder pb) throws Exception {\n+    private static void analyzeFoldMultilinesOff(ProcessBuilder pb, String out) throws Exception {\n@@ -55,4 +66,2 @@\n-\n-        String logs = Files.readString(EXCEPTION_LOG_FILE);\n-        if (!logs.contains(\"line 1\" + System.lineSeparator() + \"line 2\\\\nstring\")) {\n-            throw new RuntimeException(\"foldmultilines=false did not work.\");\n+        if (!NEWLINE_LOG_PATTERN.matcher(getLog(out, output)).find()) {\n+            throw new RuntimeException(out + \": foldmultilines=false did not work.\");\n@@ -68,1 +77,1 @@\n-    public static void main(String[] args) throws Exception {\n+    private static void test(String out) throws Exception {\n@@ -72,1 +81,1 @@\n-        Xlog = XLOG_BASE + \"::foldmultilines=true\";\n+        Xlog = XLOG_BASE + out +  \"::foldmultilines=true\";\n@@ -74,1 +83,1 @@\n-        analyzeFoldMultilinesOn(pb);\n+        analyzeFoldMultilinesOn(pb, out);\n@@ -76,1 +85,1 @@\n-        Xlog = XLOG_BASE + \"::foldmultilines=false\";\n+        Xlog = XLOG_BASE + out + \"::foldmultilines=false\";\n@@ -78,1 +87,1 @@\n-        analyzeFoldMultilinesOff(pb);\n+        analyzeFoldMultilinesOff(pb, out);\n@@ -80,1 +89,1 @@\n-        Xlog = XLOG_BASE + \"::foldmultilines=invalid\";\n+        Xlog = XLOG_BASE + out + \"::foldmultilines=invalid\";\n@@ -85,0 +94,14 @@\n+    public static void main(String[] args) throws Exception {\n+        \/\/ -Xlog:exceptions=info:file=exceptions.log::foldmultilines=[true|false|invalid]\n+        test(\"file=\" + EXCEPTION_LOG_FILE);\n+\n+        \/\/ -Xlog:exceptions=info:stdout::foldmultilines=[true|false|invalid]\n+        test(\"stdout\");\n+\n+        \/\/ -Xlog:exceptions=info:stderr::foldmultilines=[true|false|invalid]\n+        test(\"stderr\");\n+\n+        \/\/ -Xlog:exceptions=info:::foldmultilines=[true|false|invalid]\n+        test(\"\");\n+    }\n+\n@@ -88,1 +111,1 @@\n-                throw new RuntimeException(\"line 1\\nline 2\\\\nstring\");\n+                throw new RuntimeException(EXCEPTION_MESSAGE);\n","filename":"test\/hotspot\/jtreg\/runtime\/logging\/FoldMultilinesTest.java","additions":43,"deletions":20,"binary":false,"changes":63,"status":"modified"}]}