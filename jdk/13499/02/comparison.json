{"files":[{"patch":"@@ -633,1 +633,1 @@\n-static jstring jnuEncoding = NULL;\n+static jobject jnuCharset = NULL;\n@@ -636,2 +636,2 @@\n-static jmethodID String_init_ID;        \/* String(byte[], enc) *\/\n-static jmethodID String_getBytes_ID;    \/* String.getBytes(enc) *\/\n+static jmethodID String_init_ID;        \/* String(byte[], Charset) *\/\n+static jmethodID String_getBytes_ID;    \/* String.getBytes(Charset) *\/\n@@ -661,1 +661,1 @@\n-                                   String_init_ID, bytes, jnuEncoding);\n+                                   String_init_ID, bytes, jnuCharset);\n@@ -720,0 +720,1 @@\n+        const char *charsetname = NULL;\n@@ -726,3 +727,1 @@\n-            jstring enc = (*env)->NewStringUTF(env, encname);\n-            if (enc == NULL)\n-                return;\n+            charsetname = encname;\n@@ -730,2 +729,0 @@\n-            jnuEncoding = (jstring)(*env)->NewGlobalRef(env, enc);\n-            (*env)->DeleteLocalRef(env, enc);\n@@ -741,3 +738,7 @@\n-            jboolean exe;\n-            jstring enc = (*env)->NewStringUTF(env, encname);\n-            if (enc == NULL)\n+            charsetname = encname;\n+            fastEncoding = NO_FAST_ENCODING;\n+        }\n+        while (charsetname != NULL) {\n+            jstring enc = (*env)->NewStringUTF(env, charsetname);\n+            if (enc == NULL) {\n+                fastEncoding = NO_ENCODING_YET;\n@@ -745,0 +746,12 @@\n+            }\n+            jboolean exc;\n+            jvalue charset = JNU_CallStaticMethodByName(\n+                    env, &exc,\n+                    \"java\/nio\/charset\/Charset\",\n+                    \"forName\",\n+                    \"(Ljava\/lang\/String;)Ljava\/nio\/charset\/Charset;\",\n+                    enc);\n+            if (exc) {\n+                (*env)->ExceptionClear(env);\n+            }\n+            (*env)->DeleteLocalRef(env, enc);\n@@ -746,15 +759,6 @@\n-            if ((jboolean) JNU_CallStaticMethodByName (\n-                                            env, &exe,\n-                                            \"java\/nio\/charset\/Charset\",\n-                                            \"isSupported\",\n-                                            \"(Ljava\/lang\/String;)Z\",\n-                                            enc).z == JNI_TRUE) {\n-                fastEncoding = NO_FAST_ENCODING;\n-                jnuEncoding = (jstring)(*env)->NewGlobalRef(env, enc);\n-            } else {\n-                \/\/ jnuEncoding falls back to UTF-8\n-                jstring utf8 = (*env)->NewStringUTF(env, \"UTF-8\");\n-                if (utf8 == NULL) {\n-                    (*env)->DeleteLocalRef(env, enc);\n-                    return;\n-                }\n+            if (!exc && charset.l != NULL) {\n+                jnuCharset = (*env)->NewGlobalRef(env, charset.l);\n+                (*env)->DeleteLocalRef(env, charset.l);\n+                break; \/\/ success, continue below\n+            } else if (strcmp(charsetname, \"UTF-8\") != 0) { \/\/ fall back\n+                charsetname = \"UTF-8\";\n@@ -762,2 +766,3 @@\n-                jnuEncoding = (jstring)(*env)->NewGlobalRef(env, utf8);\n-                (*env)->DeleteLocalRef(env, utf8);\n+            } else { \/\/ give up\n+                fastEncoding = NO_ENCODING_YET;\n+                return;\n@@ -765,1 +770,0 @@\n-            (*env)->DeleteLocalRef(env, enc);\n@@ -774,1 +778,1 @@\n-                                             \"getBytes\", \"(Ljava\/lang\/String;)[B\");\n+                                             \"getBytes\", \"(Ljava\/nio\/charset\/Charset;)[B\");\n@@ -777,1 +781,1 @@\n-                                         \"<init>\", \"([BLjava\/lang\/String;)V\");\n+                                         \"<init>\", \"([BLjava\/nio\/charset\/Charset;)V\");\n@@ -816,1 +820,1 @@\n-    hab = (*env)->CallObjectMethod(env, jstr, String_getBytes_ID, jnuEncoding);\n+    hab = (*env)->CallObjectMethod(env, jstr, String_getBytes_ID, jnuCharset);\n","filename":"src\/java.base\/share\/native\/libjava\/jni_util.c","additions":37,"deletions":33,"binary":false,"changes":70,"status":"modified"}]}