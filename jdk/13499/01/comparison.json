{"files":[{"patch":"@@ -628,1 +628,1 @@\n-static jstring jnuEncoding = NULL;\n+static jobject jnuEncoding = NULL;\n@@ -631,2 +631,2 @@\n-static jmethodID String_init_ID;        \/* String(byte[], enc) *\/\n-static jmethodID String_getBytes_ID;    \/* String.getBytes(enc) *\/\n+static jmethodID String_init_ID;        \/* String(byte[], Charset) *\/\n+static jmethodID String_getBytes_ID;    \/* String.getBytes(Charset) *\/\n@@ -715,0 +715,1 @@\n+        const char *charsetname = NULL;\n@@ -721,3 +722,1 @@\n-            jstring enc = (*env)->NewStringUTF(env, encname);\n-            if (enc == NULL)\n-                return;\n+            charsetname = encname;\n@@ -725,2 +724,0 @@\n-            jnuEncoding = (jstring)(*env)->NewGlobalRef(env, enc);\n-            (*env)->DeleteLocalRef(env, enc);\n@@ -736,3 +733,7 @@\n-            jboolean exe;\n-            jstring enc = (*env)->NewStringUTF(env, encname);\n-            if (enc == NULL)\n+            charsetname = encname;\n+            fastEncoding = NO_FAST_ENCODING;\n+        }\n+        while (charsetname != NULL) {\n+            jstring enc = (*env)->NewStringUTF(env, charsetname);\n+            if (enc == NULL) {\n+                fastEncoding = NO_ENCODING_YET;\n@@ -740,0 +741,12 @@\n+            }\n+            jboolean exc;\n+            jvalue charset = JNU_CallStaticMethodByName(\n+                    env, &exc,\n+                    \"java\/nio\/charset\/Charset\",\n+                    \"forName\",\n+                    \"(Ljava\/lang\/String;)Ljava\/nio\/charset\/Charset;\",\n+                    enc);\n+            if (exc) {\n+                (*env)->ExceptionClear(env);\n+            }\n+            (*env)->DeleteLocalRef(env, enc);\n@@ -741,15 +754,6 @@\n-            if ((jboolean) JNU_CallStaticMethodByName (\n-                                            env, &exe,\n-                                            \"java\/nio\/charset\/Charset\",\n-                                            \"isSupported\",\n-                                            \"(Ljava\/lang\/String;)Z\",\n-                                            enc).z == JNI_TRUE) {\n-                fastEncoding = NO_FAST_ENCODING;\n-                jnuEncoding = (jstring)(*env)->NewGlobalRef(env, enc);\n-            } else {\n-                \/\/ jnuEncoding falls back to UTF-8\n-                jstring utf8 = (*env)->NewStringUTF(env, \"UTF-8\");\n-                if (utf8 == NULL) {\n-                    (*env)->DeleteLocalRef(env, enc);\n-                    return;\n-                }\n+            if (!exc && charset.l != NULL) {\n+                jnuEncoding = (*env)->NewGlobalRef(env, charset.l);\n+                (*env)->DeleteLocalRef(env, charset.l);\n+                break;\n+            } else if (strcmp(charsetname, \"UTF-8\") != 0) { \/\/ fall back\n+                charsetname = \"UTF-8\";\n@@ -757,2 +761,3 @@\n-                jnuEncoding = (jstring)(*env)->NewGlobalRef(env, utf8);\n-                (*env)->DeleteLocalRef(env, utf8);\n+            } else { \/\/ give up\n+                fastEncoding = NO_ENCODING_YET;\n+                return;\n@@ -760,1 +765,0 @@\n-            (*env)->DeleteLocalRef(env, enc);\n@@ -769,1 +773,1 @@\n-                                             \"getBytes\", \"(Ljava\/lang\/String;)[B\");\n+                                             \"getBytes\", \"(Ljava\/nio\/charset\/Charset;)[B\");\n@@ -772,1 +776,1 @@\n-                                         \"<init>\", \"([BLjava\/lang\/String;)V\");\n+                                         \"<init>\", \"([BLjava\/nio\/charset\/Charset;)V\");\n","filename":"src\/java.base\/share\/native\/libjava\/jni_util.c","additions":35,"deletions":31,"binary":false,"changes":66,"status":"modified"}]}