{"files":[{"patch":"@@ -255,0 +255,8 @@\n+\n+    virtual jlong kernel_memory_usage_in_bytes() = 0;\n+    virtual jlong kernel_memory_limit_in_bytes() = 0;\n+    virtual jlong kernel_memory_max_usage_in_bytes() = 0;\n+\n+    virtual jlong memory_swap_current_in_bytes() = 0;\n+    virtual jlong memory_swap_max_limit_in_bytes() = 0;\n+\n","filename":"src\/hotspot\/os\/linux\/cgroupSubsystem_linux.hpp","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2019, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2019, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -212,0 +212,47 @@\n+\/* kernel_memory_usage_in_bytes\n+ *\n+ * Return the amount of used kernel memory for this process.\n+ *\n+ * return:\n+ *    kernel memory usage in bytes or\n+ *    -1 for unlimited\n+ *    OSCONTAINER_ERROR for not supported\n+ *\/\n+jlong CgroupV1Subsystem::kernel_memory_usage_in_bytes() {\n+  GET_CONTAINER_INFO(jlong, _memory->controller(), \"\/memory.kmem.usage_in_bytes\",\n+                     \"Kernel Memory Usage is: \" JLONG_FORMAT, JLONG_FORMAT, kmem_usage);\n+  return kmem_usage;\n+}\n+\n+jlong CgroupV1Subsystem::kernel_memory_limit_in_bytes() {\n+  GET_CONTAINER_INFO(julong, _memory->controller(), \"\/memory.kmem.limit_in_bytes\",\n+                     \"Kernel Memory Limit is: \" JULONG_FORMAT, JULONG_FORMAT, kmem_limit);\n+  if (kmem_limit >= _unlimited_memory) {\n+    return (jlong)-1;\n+  }\n+  return (jlong)kmem_limit;\n+}\n+\n+\/* kernel_memory_max_usage_in_bytes\n+ *\n+ * Return the maximum amount of used kernel memory for this process.\n+ *\n+ * return:\n+ *    max kernel memory usage in bytes or\n+ *    OSCONTAINER_ERROR for not supported\n+ *\/\n+jlong CgroupV1Subsystem::kernel_memory_max_usage_in_bytes() {\n+  GET_CONTAINER_INFO(jlong, _memory->controller(), \"\/memory.kmem.max_usage_in_bytes\",\n+                     \"Maximum Kernel Memory Usage is: \" JLONG_FORMAT, JLONG_FORMAT, kmem_max_usage);\n+  return kmem_max_usage;\n+}\n+\n+jlong CgroupV1Subsystem::memory_swap_current_in_bytes() {\n+  return OSCONTAINER_ERROR;\n+}\n+\n+jlong CgroupV1Subsystem::memory_swap_max_limit_in_bytes() {\n+  return OSCONTAINER_ERROR;\n+}\n+\n+\n","filename":"src\/hotspot\/os\/linux\/cgroupV1Subsystem_linux.cpp","additions":48,"deletions":1,"binary":false,"changes":49,"status":"modified"},{"patch":"@@ -82,0 +82,8 @@\n+\n+    jlong kernel_memory_usage_in_bytes();\n+    jlong kernel_memory_limit_in_bytes();\n+    jlong kernel_memory_max_usage_in_bytes();\n+\n+    jlong memory_swap_current_in_bytes();\n+    jlong memory_swap_max_limit_in_bytes();\n+\n","filename":"src\/hotspot\/os\/linux\/cgroupV1Subsystem_linux.hpp","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -185,0 +185,22 @@\n+\/\/ memory.swap.current : total amount of swap currently used by the cgroup and its descendants\n+char* CgroupV2Subsystem::mem_swp_current_val() {\n+  GET_CONTAINER_INFO_CPTR(cptr, _unified, \"\/memory.swap.current\",\n+                         \"Swap currently used is: %s\", \"%s\", mem_swp_current_str, 1024);\n+  if (mem_swp_current_str == NULL) {\n+    return NULL;\n+  }\n+  return os::strdup(mem_swp_current_str);\n+}\n+\n+jlong CgroupV2Subsystem::memory_swap_current_in_bytes() {\n+  char* mem_swp_current_str = mem_swp_current_val();\n+  jlong swap_current = limit_from_str(mem_swp_current_str);\n+  return swap_current;\n+}\n+\n+jlong CgroupV2Subsystem::memory_swap_max_limit_in_bytes() {\n+  char* mem_swp_limit_str = mem_swp_limit_val();\n+  jlong swap_limit = limit_from_str(mem_swp_limit_str);\n+  return swap_limit;\n+}\n+\n@@ -215,0 +237,14 @@\n+\/\/ the kmem (kernel memory limits) are not separately accounted in cgroups v2\n+jlong CgroupV2Subsystem::kernel_memory_usage_in_bytes() {\n+  return OSCONTAINER_ERROR;\n+}\n+\n+jlong CgroupV2Subsystem::kernel_memory_limit_in_bytes() {\n+  return OSCONTAINER_ERROR;\n+}\n+\n+jlong CgroupV2Subsystem::kernel_memory_max_usage_in_bytes() {\n+  return OSCONTAINER_ERROR;\n+}\n+\n+\n","filename":"src\/hotspot\/os\/linux\/cgroupV2Subsystem_linux.cpp","additions":36,"deletions":0,"binary":false,"changes":36,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, Red Hat Inc.\n+ * Copyright (c) 2020, 2022, Red Hat Inc.\n@@ -61,0 +61,1 @@\n+    char *mem_swp_current_val();\n@@ -80,0 +81,5 @@\n+\n+    jlong kernel_memory_usage_in_bytes();\n+    jlong kernel_memory_limit_in_bytes();\n+    jlong kernel_memory_max_usage_in_bytes();\n+\n@@ -85,0 +91,3 @@\n+    jlong memory_swap_current_in_bytes();\n+    jlong memory_swap_max_limit_in_bytes();\n+\n","filename":"src\/hotspot\/os\/linux\/cgroupV2Subsystem_linux.hpp","additions":10,"deletions":1,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2017, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2017, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -103,0 +103,25 @@\n+jlong OSContainer::kernel_memory_usage_in_bytes() {\n+  assert(cgroup_subsystem != NULL, \"cgroup subsystem not available\");\n+  return cgroup_subsystem->kernel_memory_usage_in_bytes();\n+}\n+\n+jlong OSContainer::kernel_memory_limit_in_bytes() {\n+  assert(cgroup_subsystem != NULL, \"cgroup subsystem not available\");\n+  return cgroup_subsystem->kernel_memory_limit_in_bytes();\n+}\n+\n+jlong OSContainer::kernel_memory_max_usage_in_bytes() {\n+  assert(cgroup_subsystem != NULL, \"cgroup subsystem not available\");\n+  return cgroup_subsystem->kernel_memory_max_usage_in_bytes();\n+}\n+\n+jlong OSContainer::memory_swap_current_in_bytes() {\n+  assert(cgroup_subsystem != NULL, \"cgroup subsystem not available\");\n+  return cgroup_subsystem->memory_swap_current_in_bytes();\n+}\n+\n+jlong OSContainer::memory_swap_max_limit_in_bytes() {\n+  assert(cgroup_subsystem != NULL, \"cgroup subsystem not available\");\n+  return cgroup_subsystem->memory_swap_max_limit_in_bytes();\n+}\n+\n","filename":"src\/hotspot\/os\/linux\/osContainer_linux.cpp","additions":26,"deletions":1,"binary":false,"changes":27,"status":"modified"},{"patch":"@@ -55,0 +55,7 @@\n+  static jlong kernel_memory_usage_in_bytes();\n+  static jlong kernel_memory_limit_in_bytes();\n+  static jlong kernel_memory_max_usage_in_bytes();\n+\n+  static jlong memory_swap_current_in_bytes();\n+  static jlong memory_swap_max_limit_in_bytes();\n+\n","filename":"src\/hotspot\/os\/linux\/osContainer_linux.hpp","additions":7,"deletions":0,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -2269,0 +2269,13 @@\n+  \/\/ the kmem (kernel memory) values are only available in cgroupv1\n+  if (p_ct != NULL && strcmp(p_ct, \"cgroupv1\") == 0) {\n+    print_container_helper(st, OSContainer::kernel_memory_usage_in_bytes(), \"kernel_memory_usage_in_bytes\");\n+    print_container_helper(st, OSContainer::kernel_memory_max_usage_in_bytes(), \"kernel_memory_max_usage_in_bytes\");\n+    print_container_helper(st, OSContainer::kernel_memory_limit_in_bytes(), \"kernel_memory_limit_in_bytes\");\n+  }\n+\n+  \/\/ cgroupv2 specific values\n+  if (p_ct != NULL && strcmp(p_ct, \"cgroupv2\") == 0) {\n+    print_container_helper(st, OSContainer::memory_swap_current_in_bytes(), \"memory_swap_current_in_bytes\");\n+    print_container_helper(st, OSContainer::memory_swap_max_limit_in_bytes(), \"memory_swap_max_limit_in_bytes\");\n+  }\n+\n","filename":"src\/hotspot\/os\/linux\/os_linux.cpp","additions":13,"deletions":0,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -126,0 +126,13 @@\n+        String str = out.getOutput();\n+        if (str.contains(\"cgroupv1\")) {\n+            out.shouldContain(\"kernel_memory_usage_in_bytes\");\n+            out.shouldContain(\"kernel_memory_max_usage_in_bytes\");\n+            out.shouldContain(\"kernel_memory_limit_in_bytes\");\n+        } else {\n+            if (str.contains(\"cgroupv2\")) {\n+                out.shouldContain(\"memory_swap_current_in_bytes\");\n+                out.shouldContain(\"memory_swap_max_limit_in_bytes\");\n+            } else {\n+                throw new RuntimeException(\"Output has to contain information about cgroupv1 or cgroupv2\");\n+            }\n+        }\n","filename":"test\/hotspot\/jtreg\/containers\/docker\/TestMisc.java","additions":13,"deletions":0,"binary":false,"changes":13,"status":"modified"}]}