{"files":[{"patch":"@@ -2189,22 +2189,0 @@\n-  int fd;\n-\n-  fd = ::open(path, oflag, mode);\n-  if (fd == -1) return -1;\n-\n-  \/\/ If the open succeeded, the file might still be a directory\n-  {\n-    struct stat buf;\n-    int ret = ::fstat(fd, &buf);\n-    int st_mode = buf.st_mode;\n-\n-    if (ret != -1) {\n-      if ((st_mode & S_IFMT) == S_IFDIR) {\n-        errno = EISDIR;\n-        ::close(fd);\n-        return -1;\n-      }\n-    } else {\n-      ::close(fd);\n-      return -1;\n-    }\n-  }\n@@ -2233,1 +2211,13 @@\n-#ifdef FD_CLOEXEC\n+  \/\/ Modern Linux kernels (after 2.6.23 2007) support O_CLOEXEC with open().\n+  \/\/ O_CLOEXEC is preferable to using FD_CLOEXEC on an open file descriptor\n+  \/\/ because it saves a system call and removes a small window where the flag\n+  \/\/ is unset.  On ancient Linux kernels the O_CLOEXEC flag will be ignored\n+  \/\/ and we fall back to using FD_CLOEXEC (see below).\n+#ifdef O_CLOEXEC\n+  oflag |= O_CLOEXEC;\n+#endif\n+\n+  int fd = ::open(path, oflag, mode);\n+  if (fd == -1) return -1;\n+\n+  \/\/ If the open succeeded, the file might still be a directory\n@@ -2235,0 +2225,21 @@\n+    struct stat buf;\n+    int ret = ::fstat(fd, &buf);\n+    int st_mode = buf.st_mode;\n+\n+    if (ret != -1) {\n+      if ((st_mode & S_IFMT) == S_IFDIR) {\n+        errno = EISDIR;\n+        ::close(fd);\n+        return -1;\n+      }\n+    } else {\n+      ::close(fd);\n+      return -1;\n+    }\n+  }\n+\n+#ifdef FD_CLOEXEC\n+  \/\/ Validate that the use of the O_CLOEXEC flag on open above worked.\n+  \/\/ With recent kernels, we will perform this check exactly once.\n+  static sig_atomic_t O_CLOEXEC_is_known_to_work = 0;\n+  if (!O_CLOEXEC_is_known_to_work) {\n@@ -2237,1 +2248,4 @@\n-      ::fcntl(fd, F_SETFD, flags | FD_CLOEXEC);\n+      if ((flags & FD_CLOEXEC) != 0)\n+        O_CLOEXEC_is_known_to_work = 1;\n+      else\n+        ::fcntl(fd, F_SETFD, flags | FD_CLOEXEC);\n","filename":"src\/hotspot\/os\/bsd\/os_bsd.cpp","additions":38,"deletions":24,"binary":false,"changes":62,"status":"modified"}]}