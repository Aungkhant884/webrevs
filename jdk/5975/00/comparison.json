{"files":[{"patch":"@@ -88,1 +88,3 @@\n-    JNU_ThrowByName(env, \"java\/awt\/color\/CMMException\", errMsg);\n+    if (!(*env)->ExceptionCheck(env)) { \/\/ errorHandler may throw it before\n+        JNU_ThrowByName(env, \"java\/awt\/color\/CMMException\", errMsg);\n+    }\n@@ -116,0 +118,20 @@\n+\/*\n+ * Throw an IllegalArgumentException and init the cause.\n+ *\/\n+static void ThrowIllegalArgumentException(JNIEnv *env, const char *msg) {\n+    jthrowable cause = (*env)->ExceptionOccurred(env);\n+    if (cause != NULL) {\n+        (*env)->ExceptionClear(env);\n+    }\n+    jstring str = JNU_NewStringPlatform(env, msg);\n+    if (str != NULL) {\n+        jobject iae = JNU_NewObjectByName(env,\n+                                \"java\/lang\/IllegalArgumentException\",\n+                                \"(Ljava\/lang\/String;Ljava\/lang\/Throwable;)V\",\n+                                str, cause);\n+        if (iae != NULL) {\n+            (*env)->Throw(env, iae);\n+        }\n+    }\n+}\n+\n@@ -188,1 +210,1 @@\n-        if ((*env)->ExceptionOccurred(env) == NULL) {\n+        if (!(*env)->ExceptionCheck(env)) { \/\/ errorHandler may throw it\n@@ -217,1 +239,1 @@\n-        JNU_ThrowIllegalArgumentException(env, \"Invalid profile data\");\n+        ThrowIllegalArgumentException(env, \"Invalid profile data\");\n@@ -235,1 +257,1 @@\n-        JNU_ThrowIllegalArgumentException(env, \"Invalid profile data\");\n+        ThrowIllegalArgumentException(env, \"Invalid profile data\");\n@@ -244,2 +266,1 @@\n-            JNU_ThrowIllegalArgumentException(env, \"Invalid profile data\");\n-\n+            ThrowIllegalArgumentException(env, \"Invalid profile data\");\n@@ -279,2 +300,4 @@\n-        JNU_ThrowByName(env, \"java\/awt\/color\/CMMException\",\n-                        \"Can not access specified profile.\");\n+        if (!(*env)->ExceptionCheck(env)) { \/\/ errorHandler may throw it\n+            JNU_ThrowByName(env, \"java\/awt\/color\/CMMException\",\n+                            \"Can not access specified profile.\");\n+        }\n@@ -301,2 +324,4 @@\n-        JNU_ThrowByName(env, \"java\/awt\/color\/CMMException\",\n-                        \"Can not access specified profile.\");\n+        if (!(*env)->ExceptionCheck(env)) { \/\/ errorHandler may throw it\n+            JNU_ThrowByName(env, \"java\/awt\/color\/CMMException\",\n+                            \"Can not access specified profile.\");\n+        }\n@@ -357,2 +382,4 @@\n-            JNU_ThrowByName(env, \"java\/awt\/color\/CMMException\",\n-                            \"ICC Profile header not found\");\n+            if (!(*env)->ExceptionCheck(env)) { \/\/ errorHandler may throw it\n+                JNU_ThrowByName(env, \"java\/awt\/color\/CMMException\",\n+                                \"ICC Profile header not found\");\n+            }\n@@ -368,2 +395,4 @@\n-        JNU_ThrowByName(env, \"java\/awt\/color\/CMMException\",\n-                        \"ICC profile tag not found\");\n+        if (!(*env)->ExceptionCheck(env)) { \/\/ errorHandler may throw it\n+            JNU_ThrowByName(env, \"java\/awt\/color\/CMMException\",\n+                            \"ICC profile tag not found\");\n+        }\n@@ -392,2 +421,4 @@\n-        JNU_ThrowByName(env, \"java\/awt\/color\/CMMException\",\n-                        \"Can not get tag data.\");\n+        if (!(*env)->ExceptionCheck(env)) { \/\/ errorHandler may throw it\n+            JNU_ThrowByName(env, \"java\/awt\/color\/CMMException\",\n+                            \"Can not get tag data.\");\n+        }\n@@ -418,1 +449,1 @@\n-        JNU_ThrowIllegalArgumentException(env, \"Can not write tag data.\");\n+        ThrowIllegalArgumentException(env, \"Can not write tag data.\");\n@@ -446,1 +477,1 @@\n-        JNU_ThrowIllegalArgumentException(env, \"Can not write tag data.\");\n+        ThrowIllegalArgumentException(env, \"Can not write tag data.\");\n@@ -557,1 +588,1 @@\n-    if ((*env)->ExceptionOccurred(env)) {\n+    if ((*env)->ExceptionCheck(env)) {\n","filename":"src\/java.desktop\/share\/native\/liblcms\/LCMS.c","additions":50,"deletions":19,"binary":false,"changes":69,"status":"modified"},{"patch":"@@ -35,0 +35,3 @@\n+import jdk.test.lib.process.OutputAnalyzer;\n+import jdk.test.lib.process.ProcessTools;\n+\n@@ -37,1 +40,1 @@\n- * @bug 8271718 8273135\n+ * @bug 8271718 8273135 8275344\n@@ -39,0 +42,3 @@\n+ * @library \/test\/lib\n+ * @run main\/othervm MTTransformReplacedProfile\n+ * @run main\/othervm MTTransformReplacedProfile checkJNI\n@@ -45,0 +51,9 @@\n+        if (args.length > 0 && args[0].equals(\"checkJNI\")) {\n+            ProcessBuilder pb = ProcessTools.createTestJvm(\n+                    \"-Xcheck:jni\", MTTransformReplacedProfile.class.getName());\n+            OutputAnalyzer oa = ProcessTools.executeProcess(pb);\n+            oa.stderrShouldBeEmpty();\n+            oa.stdoutShouldBeEmpty();\n+            oa.shouldHaveExitValue(0);\n+            return;\n+        }\n","filename":"test\/jdk\/java\/awt\/color\/ICC_ColorSpace\/MTTransformReplacedProfile.java","additions":16,"deletions":1,"binary":false,"changes":17,"status":"modified"}]}