{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2003, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2003, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -276,1 +276,0 @@\n-    CDS_JAVA_HEAP_ONLY(_heap_obj_roots = CompressedOops::encode(HeapShared::roots());)\n@@ -2100,1 +2099,0 @@\n-      HeapShared::set_roots(header()->heap_obj_roots());\n","filename":"src\/hotspot\/share\/cds\/filemap.cpp","additions":1,"deletions":3,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2003, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2003, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -235,1 +235,0 @@\n-  narrowOop _heap_obj_roots;            \/\/ An objArray that stores all the roots of archived heap objects\n@@ -282,1 +281,0 @@\n-  narrowOop heap_obj_roots()               const { return _heap_obj_roots; }\n@@ -289,1 +287,0 @@\n-  void set_heap_obj_roots(narrowOop r)           { _heap_obj_roots = r; }\n@@ -416,2 +413,0 @@\n-  narrowOop heap_obj_roots()               const    { return header()->heap_obj_roots(); }\n-\n","filename":"src\/hotspot\/share\/cds\/filemap.hpp","additions":1,"deletions":6,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2018, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2018, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -131,1 +131,0 @@\n-narrowOop HeapShared::_roots_narrow;\n@@ -155,1 +154,0 @@\n-    _roots = OopHandle(Universe::vm_global(), decode_from_archive(_roots_narrow));\n@@ -239,6 +237,0 @@\n-void HeapShared::set_roots(narrowOop roots) {\n-  assert(UseSharedSpaces, \"runtime only\");\n-  assert(is_fully_available(), \"must be\");\n-  _roots_narrow = roots;\n-}\n-\n@@ -673,1 +665,17 @@\n-void HeapShared::serialize_subgraph_info_table_header(SerializeClosure* soc) {\n+void HeapShared::serialize(SerializeClosure* soc) {\n+  oop roots_oop = NULL;\n+\n+  if (soc->reading()) {\n+    soc->do_oop(&roots_oop); \/\/ read from archive\n+    assert(oopDesc::is_oop_or_null(roots_oop), \"is oop\");\n+    \/\/ Create an OopHandle only if we have actually mapped or loaded the roots\n+    if (roots_oop != NULL) {\n+      assert(HeapShared::is_fully_available(), \"must be\");\n+      _roots = OopHandle(Universe::vm_global(), roots_oop);\n+    }\n+  } else {\n+    \/\/ writing\n+    roots_oop = roots();\n+    soc->do_oop(&roots_oop); \/\/ write to archive\n+  }\n+\n@@ -1698,1 +1706,0 @@\n-  set_roots(mapinfo->heap_obj_roots());\n","filename":"src\/hotspot\/share\/cds\/heapShared.cpp","additions":18,"deletions":11,"binary":false,"changes":29,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2018, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2018, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -313,1 +313,0 @@\n-  static narrowOop _roots_narrow;\n@@ -421,1 +420,0 @@\n-  static void set_roots(narrowOop roots);\n@@ -471,1 +469,1 @@\n-  static void serialize_subgraph_info_table_header(SerializeClosure* soc) NOT_CDS_JAVA_HEAP_RETURN;\n+  static void serialize(SerializeClosure* soc) NOT_CDS_JAVA_HEAP_RETURN;\n","filename":"src\/hotspot\/share\/cds\/heapShared.hpp","additions":2,"deletions":4,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2012, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2012, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -387,1 +387,1 @@\n-  HeapShared::serialize_subgraph_info_table_header(soc);\n+  HeapShared::serialize(soc);\n","filename":"src\/hotspot\/share\/cds\/metaspaceShared.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2018, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2018, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -42,1 +42,1 @@\n-#define CURRENT_CDS_ARCHIVE_VERSION 13\n+#define CURRENT_CDS_ARCHIVE_VERSION 14\n","filename":"src\/hotspot\/share\/include\/cds.h","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"}]}