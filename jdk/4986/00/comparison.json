{"files":[{"patch":"@@ -64,2 +64,1 @@\n-\n-static int init_jvm(int argc, char **argv, bool disable_error_handling) {\n+static int init_jvm(int argc, char **argv, bool disable_error_handling, JavaVM** jvm_ptr) {\n@@ -93,1 +92,0 @@\n-  JavaVM* jvm;\n@@ -96,1 +94,1 @@\n-  int ret = JNI_CreateJavaVM(&jvm, (void**)&env, &args);\n+  int ret = JNI_CreateJavaVM(jvm_ptr, (void**)&env, &args);\n@@ -115,0 +113,1 @@\n+  JavaVM* jvm;\n@@ -121,1 +120,1 @@\n-    _argc(argc), _argv(argv), _is_initialized(false) {\n+    _argc(argc), _argv(argv), _is_initialized(false), jvm(NULL) {\n@@ -128,1 +127,1 @@\n-      int ret_val = init_jvm(_argc, _argv, false);\n+      int ret_val = init_jvm(_argc, _argv, false, &jvm);\n@@ -136,0 +135,9 @@\n+\n+  void destroy_jvm() {\n+    if (_is_initialized && jvm != NULL) {\n+      int ret = jvm->DestroyJavaVM();\n+      if (ret != 0) {\n+        fprintf(stderr, \"Warning: DestroyJavaVM error %d\\n\", ret);\n+      }\n+    }\n+  }\n@@ -211,0 +219,8 @@\n+\/\/ This is generally run once for a set of tests, but if we have vm_assert, or other_vm\n+\/\/ tests, a new process is forked and this will be called, for each of those tests.\n+\/\/ When we execute a vm_assert or other_vm test we create and initialize the JVM below.\n+\/\/ A vm_assert test crashes the VM so no cleanup is needed, but for other_vm we call\n+\/\/ DestroyJavaVM via the TEST_OTHER_VM macro prior to the call to exit().\n+\/\/ For same_vm tests we use an event listener to create the JVM when the first same_vm\n+\/\/ test is executed. Once all tests are completed we can then call DestroyJavaVM on that\n+\/\/ JVM directly.\n@@ -256,0 +272,3 @@\n+\n+  JVMInitializerListener* jvm_listener = NULL;\n+\n@@ -257,0 +276,1 @@\n+    JavaVM* jvm = NULL;\n@@ -259,1 +279,1 @@\n-    if (init_jvm(argc, argv, is_vmassert_test) != 0) {\n+    if (init_jvm(argc, argv, is_vmassert_test, &jvm) != 0) {\n@@ -264,1 +284,2 @@\n-    listeners.Append(new JVMInitializerListener(argc, argv));\n+    jvm_listener = new JVMInitializerListener(argc, argv);\n+    listeners.Append(jvm_listener);\n@@ -268,0 +289,5 @@\n+\n+  \/\/ vm_assert and other_vm tests never reach this point as they either abort, or call\n+  \/\/ exit() - see TEST_OTHER_VM macro. We will reach here when all same_vm tests have\n+  \/\/ completed for this run, so we can terminate the VM used for that case.\n+\n@@ -272,0 +298,4 @@\n+\n+  if (jvm_listener != NULL) {\n+    jvm_listener->destroy_jvm();\n+  }\n","filename":"test\/hotspot\/gtest\/gtestMain.cpp","additions":38,"deletions":8,"binary":false,"changes":46,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2016, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2016, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -91,0 +91,9 @@\n+    JavaVM* jvm[1];                                                 \\\n+    jsize nVMs = 0;                                                 \\\n+    JNI_GetCreatedJavaVMs(&jvm[0], 1, &nVMs);                       \\\n+    if (nVMs == 1) {                                                \\\n+      int ret = jvm[0]->DestroyJavaVM();                            \\\n+      if (ret != 0) {                                               \\\n+        fprintf(stderr, \"Warning: DestroyJavaVM error %d\\n\", ret);  \\\n+      }                                                             \\\n+    }                                                               \\\n","filename":"test\/hotspot\/gtest\/unittest.hpp","additions":10,"deletions":1,"binary":false,"changes":11,"status":"modified"}]}