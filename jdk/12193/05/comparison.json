{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2014, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2014, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -60,0 +60,1 @@\n+import jdk.internal.misc.Unsafe;\n@@ -116,0 +117,4 @@\n+    \/\/ Accessing this variable is made through Unsafe in order to use the\n+    \/\/ memory semantics that preserves ordering and visibility across threads.\n+    \/\/\n+    \/\/ Used reflectively via Unsafe\n@@ -261,2 +266,2 @@\n-    synchronized Module implAddEnableNativeAccess() {\n-        enableNativeAccess = true;\n+    Module implAddEnableNativeAccess() {\n+        EnableNativeAccessHandler.trySetEnableNativeAccess(this);\n@@ -270,2 +275,0 @@\n-     * @since 20\n-     *\n@@ -273,0 +276,1 @@\n+     * @since 20\n@@ -274,1 +278,1 @@\n-    @PreviewFeature(feature=PreviewFeature.Feature.FOREIGN)\n+    @PreviewFeature(feature = PreviewFeature.Feature.FOREIGN)\n@@ -277,2 +281,22 @@\n-        synchronized(target) {\n-            return target.enableNativeAccess;\n+        return EnableNativeAccessHandler.isNativeAccessEnabled(target);\n+    }\n+\n+    \/**\n+     * This class is used to be able to bootstrap without using Unsafe\n+     * in the outer Module class as that would create a circular initializer dependency.\n+     *\/\n+    private static final class EnableNativeAccessHandler {\n+\n+        private EnableNativeAccessHandler() {}\n+\n+        private static final Unsafe UNSAFE = Unsafe.getUnsafe();\n+        private static final long FIELD_OFFSET = UNSAFE.objectFieldOffset(Module.class, \"enableNativeAccess\");\n+\n+        private static boolean isNativeAccessEnabled(Module target) {\n+            return UNSAFE.getBooleanVolatile(target, FIELD_OFFSET);\n+        }\n+\n+        \/\/ Atomically sets enableNativeAccess if not already set\n+        \/\/ returning if the value was updated\n+        private static boolean trySetEnableNativeAccess(Module target) {\n+            return UNSAFE.compareAndSetBoolean(target, FIELD_OFFSET, false, true);\n@@ -292,20 +316,11 @@\n-        \/\/ racy read of the enable native access flag\n-        boolean isNativeAccessEnabled = target.enableNativeAccess;\n-        if (!isNativeAccessEnabled) {\n-            synchronized (target) {\n-                \/\/ safe read of the enableNativeAccess of the target module\n-                isNativeAccessEnabled = target.enableNativeAccess;\n-\n-                \/\/ check again with the safely read flag\n-                if (isNativeAccessEnabled) {\n-                    \/\/ another thread beat us to it - nothing to do\n-                    return;\n-                } else if (ModuleBootstrap.hasEnableNativeAccessFlag()) {\n-                    throw new IllegalCallerException(\"Illegal native access from: \" + this);\n-                } else {\n-                    \/\/ warn and set flag, so that only one warning is reported per module\n-                    String cls = owner.getName();\n-                    String mtd = cls + \"::\" + methodName;\n-                    String mod = isNamed() ? \"module \" + getName() : \"the unnamed module\";\n-                    String modflag = isNamed() ? getName() : \"ALL-UNNAMED\";\n-                    System.err.printf(\"\"\"\n+        if (!EnableNativeAccessHandler.isNativeAccessEnabled(target)) {\n+            if (ModuleBootstrap.hasEnableNativeAccessFlag()) {\n+                throw new IllegalCallerException(\"Illegal native access from: \" + this);\n+            }\n+            if (EnableNativeAccessHandler.trySetEnableNativeAccess(target)) {\n+                \/\/ warn and set flag, so that only one warning is reported per module\n+                String cls = owner.getName();\n+                String mtd = cls + \"::\" + methodName;\n+                String mod = isNamed() ? \"module \" + getName() : \"the unnamed module\";\n+                String modflag = isNamed() ? getName() : \"ALL-UNNAMED\";\n+                System.err.printf(\"\"\"\n@@ -316,4 +331,0 @@\n-\n-                    \/\/ set the flag\n-                    target.enableNativeAccess = true;\n-                }\n@@ -324,1 +335,0 @@\n-\n@@ -329,3 +339,1 @@\n-        synchronized (ALL_UNNAMED_MODULE) {\n-            ALL_UNNAMED_MODULE.enableNativeAccess = true;\n-        }\n+        EnableNativeAccessHandler.trySetEnableNativeAccess(ALL_UNNAMED_MODULE);\n","filename":"src\/java.base\/share\/classes\/java\/lang\/Module.java","additions":44,"deletions":36,"binary":false,"changes":80,"status":"modified"}]}