{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2008, 2016, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2008, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -31,3 +31,11 @@\n-import java.nio.file.*;\n-import java.io.*;\n-import java.util.concurrent.*;\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.nio.file.Files;\n+import java.nio.file.FileStore;\n+import java.nio.file.Path;\n+import java.nio.file.StandardCopyOption;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.ScheduledExecutorService;\n@@ -38,3 +46,6 @@\n-    private static final long FILE_SIZE_TO_COPY = 512L * 1024L * 1024L;\n-    private static final int DELAY_IN_MS = 500;\n-    private static final int DURATION_MAX_IN_MS = 5000;\n+    private static final long FILE_SIZE_TO_COPY = 1024L * 1024L * 1024L;\n+    private static final int INTERRUPT_DELAY_IN_MS = 30;\n+    private static final int INTERRUPT_RATE_IN_MS = 10;\n+    private static final int CANCEL_DELAY_IN_MS = 30;\n+    private static final int CANCEL_RATE_IN_MS = 10;\n+    private static final int CANCEL_DURATION_IN_MS = 60000;\n@@ -78,1 +89,2 @@\n-            \/\/ copy source to target in main thread, interrupting it after a delay\n+            \/\/ copy source to target in main thread, interrupting it\n+            \/\/ at a fixed rate after a delay\n@@ -80,1 +92,1 @@\n-            Future<?> wakeup = pool.schedule(new Runnable() {\n+            Future<?> wakeup = pool.scheduleAtFixedRate(new Runnable() {\n@@ -82,0 +94,2 @@\n+                    System.out.printf(\"Interrupting at %dms%n\",\n+                        System.currentTimeMillis());\n@@ -83,1 +97,4 @@\n-                }}, DELAY_IN_MS, TimeUnit.MILLISECONDS);\n+                }},\n+                INTERRUPT_DELAY_IN_MS,\n+                INTERRUPT_RATE_IN_MS,\n+                java.util.concurrent.TimeUnit.MILLISECONDS);\n@@ -86,1 +103,2 @@\n-                long start = System.currentTimeMillis();\n+                System.out.printf(\"Copying at %dms%n\",\n+                    System.currentTimeMillis());\n@@ -88,3 +106,3 @@\n-                long duration = System.currentTimeMillis() - start;\n-                if (duration > DURATION_MAX_IN_MS)\n-                    throw new RuntimeException(\"Copy was not interrupted\");\n+                System.out.printf(\"Done copying at %dms%n\",\n+                    System.currentTimeMillis());\n+                throw new RuntimeException(\"Copy was not interrupted\");\n@@ -102,2 +120,3 @@\n-            \/\/ copy source to target via task in thread pool, interrupting it after\n-            \/\/ a delay using cancel(true)\n+            \/\/ copy source to target via task in thread pool, interrupting it\n+            \/\/ at a fixed rate after a delay using cancel(true)\n+            final CountDownLatch latch = new CountDownLatch(2);\n@@ -107,0 +126,7 @@\n+                    latch.countDown();\n+                    try {\n+                        latch.await();\n+                    } catch (InterruptedException ignored) {\n+                    }\n+                    System.out.printf(\"Copying at %dms%n\",\n+                        System.currentTimeMillis());\n@@ -109,0 +135,2 @@\n+                    System.out.printf(\"Done copying at %dms%n\",\n+                        System.currentTimeMillis());\n@@ -112,3 +140,25 @@\n-            Thread.sleep(DELAY_IN_MS);\n-            boolean cancelled = result.cancel(true);\n-            if (!cancelled)\n+            latch.countDown();\n+            try {\n+                latch.await();\n+                Thread.sleep(CANCEL_DELAY_IN_MS);\n+            } catch (InterruptedException ignored) {\n+            }\n+            System.out.printf(\"Cancelling at %dms%n\",\n+                System.currentTimeMillis());\n+            if (result.isDone())\n+                throw new RuntimeException(\"Copy finished before cancellation\");\n+            boolean cancelled;\n+            long start = System.currentTimeMillis();\n+            while (!(cancelled = result.cancel(true))) {\n+                System.out.printf(\"Cancel failed at %dms%n\",\n+                    System.currentTimeMillis());\n+                try {\n+                    Thread.sleep(CANCEL_RATE_IN_MS);\n+                } catch (InterruptedException ignored) {\n+                }\n+                if (start - System.currentTimeMillis() > CANCEL_DURATION_IN_MS)\n+                    break;\n+            }\n+            if (result.isCancelled())\n+                System.out.println(\"Copy cancelled.\");\n+            else {\n@@ -116,1 +166,2 @@\n-            System.out.println(\"Copy cancelled.\");\n+                throw new RuntimeException(\"Copy was not cancelled\");\n+            }\n","filename":"test\/jdk\/java\/nio\/file\/Files\/InterruptCopy.java","additions":71,"deletions":20,"binary":false,"changes":91,"status":"modified"}]}