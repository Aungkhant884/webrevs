{"files":[{"patch":"@@ -2303,0 +2303,14 @@\n+\n+            public boolean isLatin1(String str) {\n+                return str.isLatin1();\n+            }\n+\n+            public void getBytes(String source, byte[] dst, int dstBegin, boolean allLatin1) {\n+                var coder = allLatin1 ? String.LATIN1 : String.UTF16;\n+                source.getBytes(dst, 0, dstBegin, coder, source.length());\n+            }\n+\n+            public String newString(byte[] bytes, boolean isLatin1) {\n+                var coder = isLatin1 ? String.LATIN1 : String.UTF16;\n+                return new String(bytes, coder);\n+            }\n","filename":"src\/java.base\/share\/classes\/java\/lang\/System.java","additions":14,"deletions":0,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -27,0 +27,3 @@\n+import jdk.internal.access.JavaLangAccess;\n+import jdk.internal.access.SharedSecrets;\n+\n@@ -66,0 +69,2 @@\n+    private static final JavaLangAccess jla = SharedSecrets.getJavaLangAccess();\n+\n@@ -151,6 +156,0 @@\n-    private static int getChars(String s, char[] chars, int start) {\n-        int len = s.length();\n-        s.getChars(0, len, chars, start);\n-        return len;\n-    }\n-\n@@ -173,3 +172,5 @@\n-        if (addLen == 0) {\n-            compactElts();\n-            return size == 0 ? \"\" : elts[0];\n+        if (size == 0) {\n+            if (addLen == 0) {\n+                return \"\";\n+            }\n+            return prefix + suffix;\n@@ -177,0 +178,4 @@\n+        return toString(elts, size, addLen);\n+    }\n+\n+    private String toString(String[] elts, int size, int addLen) {\n@@ -178,2 +183,6 @@\n-        final char[] chars = new char[len + addLen];\n-        int k = getChars(prefix, chars, 0);\n+        var prefix = this.prefix;\n+        var suffix = this.suffix;\n+        var allLatin1 = isLatin1(delimiter) && isLatin1(prefix) && isLatin1(suffix) && isLatin1(elts);\n+        var totalLength = allLatin1 ? len + addLen : (len + addLen) * 2;\n+        var bytes = new byte[totalLength];\n+        int k = getBytes(prefix, bytes, 0, allLatin1);\n@@ -181,1 +190,1 @@\n-            k += getChars(elts[0], chars, k);\n+            k += getBytes(elts[0], bytes, k, allLatin1);\n@@ -183,2 +192,2 @@\n-                k += getChars(delimiter, chars, k);\n-                k += getChars(elts[i], chars, k);\n+                k += getBytes(delimiter, bytes, k, allLatin1);\n+                k += getBytes(elts[i], bytes, k, allLatin1);\n@@ -187,2 +196,2 @@\n-        k += getChars(suffix, chars, k);\n-        return new String(chars);\n+        getBytes(suffix, bytes, k, allLatin1);\n+        return jla.newString(bytes, allLatin1);\n@@ -252,2 +261,5 @@\n-            final char[] chars = new char[len];\n-            int i = 1, k = getChars(elts[0], chars, 0);\n+            var elts = this.elts;\n+            var allLatin1 = isLatin1(elts);\n+            var len = allLatin1 ? this.len : this.len * 2;\n+            var bytes = new byte[len];\n+            int i = 1, k = getBytes(elts[0], bytes, 0, allLatin1);\n@@ -255,2 +267,2 @@\n-                k += getChars(delimiter, chars, k);\n-                k += getChars(elts[i], chars, k);\n+                k += getBytes(delimiter, bytes, k, allLatin1);\n+                k += getBytes(elts[i], bytes, k, allLatin1);\n@@ -260,1 +272,1 @@\n-            elts[0] = new String(chars);\n+            elts[0] = jla.newString(bytes, allLatin1);\n@@ -278,0 +290,18 @@\n+\n+    private static int getBytes(String s, byte[] bytes, int start, boolean allLatin1) {\n+        jla.getBytes(s, bytes, start, allLatin1);\n+        return s.length();\n+    }\n+\n+    private static boolean isLatin1(String str) {\n+        return jla.isLatin1(str);\n+    }\n+\n+    private static boolean isLatin1(String[] elements) {\n+        for (String element : elements) {\n+            if (!isLatin1(String.valueOf(element))) {\n+                return false;\n+            }\n+        }\n+        return true;\n+    }\n","filename":"src\/java.base\/share\/classes\/java\/util\/StringJoiner.java","additions":51,"deletions":21,"binary":false,"changes":72,"status":"modified"},{"patch":"@@ -363,0 +363,6 @@\n+\n+    boolean isLatin1(String str);\n+\n+    String newString(byte[] bytes, boolean isLatin1);\n+\n+    void getBytes(String source, byte[] dst, int dstBegin, boolean allLatin1);\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/access\/JavaLangAccess.java","additions":6,"deletions":0,"binary":false,"changes":6,"status":"modified"}]}