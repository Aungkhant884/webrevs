{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2018, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2018, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -98,1 +98,2 @@\n-  if (MaxMetaspaceSize >= (max_uintx) - (2 * os::vm_page_size())) {\n+  \/\/ See Metaspace::ergo_initialize() for how MaxMetaspaceSize is rounded\n+  if (MaxMetaspaceSize >= align_down(max_uintx, Metaspace::commit_alignment())) {\n","filename":"src\/hotspot\/share\/memory\/metaspace\/metaspaceReporter.cpp","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2018, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2018, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -36,1 +36,1 @@\n- * @run main\/othervm -XX:MaxMetaspaceSize=201M -Xmx100M -XX:+UseCompressedOops -XX:+UseCompressedClassPointers PrintMetaspaceDcmd with-compressed-class-space\n+ * @run main\/othervm -Dwith-compressed-class-space -XX:MaxMetaspaceSize=201M -Xmx100M -XX:+UseCompressedOops -XX:+UseCompressedClassPointers PrintMetaspaceDcmd\n@@ -46,1 +46,1 @@\n- * @run main\/othervm -XX:MaxMetaspaceSize=201M -Xmx100M -XX:+UseCompressedOops -XX:+UseCompressedClassPointers -XX:MetaspaceReclaimPolicy=none PrintMetaspaceDcmd with-compressed-class-space\n+ * @run main\/othervm -Dwith-compressed-class-space -XX:MaxMetaspaceSize=201M -Xmx100M -XX:+UseCompressedOops -XX:+UseCompressedClassPointers -XX:MetaspaceReclaimPolicy=none PrintMetaspaceDcmd\n@@ -56,1 +56,1 @@\n- * @run main\/othervm -XX:MaxMetaspaceSize=201M -Xmx100M -XX:+UseCompressedOops -XX:+UseCompressedClassPointers -XX:MetaspaceReclaimPolicy=aggressive PrintMetaspaceDcmd with-compressed-class-space\n+ * @run main\/othervm -Dwith-compressed-class-space -XX:MaxMetaspaceSize=201M -Xmx100M -XX:+UseCompressedOops -XX:+UseCompressedClassPointers -XX:MetaspaceReclaimPolicy=aggressive PrintMetaspaceDcmd\n@@ -67,1 +67,1 @@\n- * @run main\/othervm -XX:MaxMetaspaceSize=201M -Xmx100M -XX:+UseCompressedOops -XX:+UseCompressedClassPointers -XX:+UnlockDiagnosticVMOptions -XX:+MetaspaceGuardAllocations PrintMetaspaceDcmd with-compressed-class-space\n+ * @run main\/othervm -Dwith-compressed-class-space -XX:MaxMetaspaceSize=201M -Xmx100M -XX:+UseCompressedOops -XX:+UseCompressedClassPointers -XX:+UnlockDiagnosticVMOptions -XX:+MetaspaceGuardAllocations PrintMetaspaceDcmd\n@@ -77,1 +77,11 @@\n- * @run main\/othervm -XX:MaxMetaspaceSize=201M -Xmx100M -XX:-UseCompressedOops -XX:-UseCompressedClassPointers PrintMetaspaceDcmd without-compressed-class-space\n+ * @run main\/othervm -Dwithout-compressed-class-space -XX:MaxMetaspaceSize=201M -Xmx100M -XX:-UseCompressedOops -XX:-UseCompressedClassPointers PrintMetaspaceDcmd\n+ *\/\n+\n+ \/*\n+ * @test id=test-nospecified\n+ * @summary Test the VM.metaspace command\n+ * @requires vm.bits == \"64\"\n+ * @library \/test\/lib\n+ * @modules java.base\/jdk.internal.misc\n+ *          java.management\n+ * @run main\/othervm -Dno-specified-flag -Xmx100M -XX:-UseCompressedOops -XX:-UseCompressedClassPointers PrintMetaspaceDcmd\n@@ -87,1 +97,1 @@\n- * @run main\/othervm -XX:MaxMetaspaceSize=201M -Xmx100M PrintMetaspaceDcmd without-compressed-class-space\n+ * @run main\/othervm -Dwithout-compressed-class-space -XX:MaxMetaspaceSize=201M -Xmx100M PrintMetaspaceDcmd\n@@ -92,1 +102,13 @@\n-    private static void doTheTest(boolean usesCompressedClassSpace) throws Exception {\n+    private static void doTheNoSpecifiedPropTest() throws Exception {\n+        ProcessBuilder pb = new ProcessBuilder();\n+        OutputAnalyzer output;\n+        \/\/ Grab my own PID\n+        String pid = Long.toString(ProcessTools.getProcessId());\n+\n+        pb.command(new String[] { JDKToolFinder.getJDKTool(\"jcmd\"), pid, \"VM.metaspace\", \"basic\"});\n+        output = new OutputAnalyzer(pb.start());\n+        output.shouldHaveExitValue(0);\n+        output.shouldMatch(\"MaxMetaspaceSize: unlimited\");\n+    }\n+\n+    private static void doTheCCSPropTest(boolean usesCompressedClassSpace) throws Exception {\n@@ -167,5 +189,6 @@\n-        boolean testForCompressedClassSpace = false;\n-        if (args[0].equals(\"with-compressed-class-space\")) {\n-            testForCompressedClassSpace = true;\n-        } else if (args[0].equals(\"without-compressed-class-space\")) {\n-            testForCompressedClassSpace = false;\n+        if (System.getProperty(\"no-specified-flag\") != null) {\n+            doTheNoSpecifiedPropTest();\n+        } else if (System.getProperty(\"with-compressed-class-space\") != null) {\n+            doTheCCSPropTest(true);\n+        } else if (System.getProperty(\"without-compressed-class-space\") != null) {\n+            doTheCCSPropTest(false);\n@@ -173,1 +196,1 @@\n-            throw new IllegalArgumentException(\"Invalid argument: \" + args[0]);\n+            throw new IllegalArgumentException(\"Unrecognized running mode\");\n@@ -175,1 +198,0 @@\n-        doTheTest(testForCompressedClassSpace);\n","filename":"test\/hotspot\/jtreg\/runtime\/Metaspace\/PrintMetaspaceDcmd.java","additions":37,"deletions":15,"binary":false,"changes":52,"status":"modified"}]}