{"files":[{"patch":"@@ -29,0 +29,1 @@\n+import java.nio.charset.Charset;\n@@ -232,0 +233,19 @@\n+    \/**\n+     * Set charset for System.out and System.err\n+     *\/\n+    private final static Charset nativeCharset;\n+    static {\n+        Charset cs;\n+        Console cons;\n+        if ((cons = System.console()) != null) {\n+            cs = cons.charset();\n+        } else {\n+            try {\n+                cs = Charset.forName(System.getProperty(\"native.encoding\"));\n+            } catch (Exception e) {\n+                cs = Charset.defaultCharset();\n+            }\n+        }\n+        nativeCharset = cs;\n+    }\n+\n@@ -268,2 +288,2 @@\n-            out = new PrintWriter(System.out, true);\n-            err = new PrintWriter(System.err, true);\n+            out = new PrintWriter(System.out, true, nativeCharset);\n+            err = new PrintWriter(System.err, true, nativeCharset);\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/util\/Log.java","additions":22,"deletions":2,"binary":false,"changes":24,"status":"modified"},{"patch":"@@ -51,0 +51,17 @@\n+\n+    private final static Charset nativeCharset;\n+    static {\n+        Charset cs;\n+        java.io.Console cons;\n+        if ((cons = System.console()) != null) {\n+            cs = cons.charset();\n+        } else {\n+            try {\n+                cs = Charset.forName(System.getProperty(\"native.encoding\"));\n+            } catch (Exception e) {\n+                cs = Charset.defaultCharset();\n+            }\n+        }\n+        nativeCharset = cs;\n+    }\n+\n@@ -58,1 +75,1 @@\n-        this.encoding = encoding != null ? encoding : Charset.defaultCharset();\n+        this.encoding = encoding != null ? encoding : nativeCharset;\n","filename":"src\/jdk.internal.le\/share\/classes\/jdk\/internal\/org\/jline\/terminal\/impl\/AbstractTerminal.java","additions":18,"deletions":1,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1996, 2018, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1996, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -43,0 +43,1 @@\n+import java.nio.charset.Charset;\n@@ -215,0 +216,16 @@\n+    private final static Charset nativeCharset;\n+    static {\n+        Charset cs;\n+        Console cons;\n+        if ((cons = System.console()) != null) {\n+            cs = cons.charset();\n+        } else {\n+            try {\n+                cs = Charset.forName(System.getProperty(\"native.encoding\"));\n+            } catch (Exception e) {\n+                cs = Charset.defaultCharset();\n+            }\n+        }\n+        nativeCharset = cs;\n+    }\n+\n@@ -216,2 +233,2 @@\n-        this.out = new PrintWriter(out, true);\n-        this.err = new PrintWriter(err, true);\n+        this.out = new PrintWriter(out, true, nativeCharset);\n+        this.err = new PrintWriter(err, true, nativeCharset);\n","filename":"src\/jdk.jartool\/share\/classes\/sun\/tools\/jar\/Main.java","additions":20,"deletions":3,"binary":false,"changes":23,"status":"modified"},{"patch":"@@ -28,0 +28,1 @@\n+import java.io.Console;\n@@ -32,0 +33,1 @@\n+import java.nio.charset.Charset;\n@@ -173,0 +175,16 @@\n+    private final static Charset nativeCharset;\n+    static {\n+        Charset cs;\n+        Console cons;\n+        if ((cons = System.console()) != null) {\n+            cs = cons.charset();\n+        } else {\n+            try {\n+                cs = Charset.forName(System.getProperty(\"native.encoding\"));\n+            } catch (Exception e) {\n+                cs = Charset.defaultCharset();\n+            }\n+        }\n+        nativeCharset = cs;\n+    }\n+\n@@ -174,1 +192,1 @@\n-        return new PrintWriter(ps, autoflush) {\n+        return new PrintWriter(ps, autoflush, nativeCharset) {\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/tool\/JavadocLog.java","additions":19,"deletions":1,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2007, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2007, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -28,0 +28,1 @@\n+import java.io.Console;\n@@ -42,0 +43,1 @@\n+import java.nio.charset.Charset;\n@@ -398,0 +400,16 @@\n+    private final static Charset nativeCharset;\n+    static {\n+        Charset cs;\n+        Console cons;\n+        if ((cons = System.console()) != null) {\n+            cs = cons.charset();\n+        } else {\n+            try {\n+                cs = Charset.forName(System.getProperty(\"native.encoding\"));\n+            } catch (Exception e) {\n+                cs = Charset.defaultCharset();\n+            }\n+        }\n+        nativeCharset = cs;\n+    }\n+\n@@ -399,1 +417,9 @@\n-        return new PrintWriter(s == null ? System.err : s, true);\n+        if (s == null) {\n+            return new PrintWriter(System.err, true, nativeCharset);\n+        } else {\n+            if (s == System.err || s == System.out) {\n+                return new PrintWriter(s, true, nativeCharset);\n+            } else {\n+                return new PrintWriter(s, true);\n+            }\n+        }\n","filename":"src\/jdk.jdeps\/share\/classes\/com\/sun\/tools\/javap\/JavapTask.java","additions":28,"deletions":2,"binary":false,"changes":30,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2012, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2012, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -33,0 +33,1 @@\n+import java.io.Console;\n@@ -36,0 +37,1 @@\n+import java.nio.charset.Charset;\n@@ -505,0 +507,16 @@\n+    private final static Charset nativeCharset;\n+    static {\n+        Charset cs;\n+        Console cons;\n+        if ((cons = System.console()) != null) {\n+            cs = cons.charset();\n+        } else {\n+            try {\n+                cs = Charset.forName(System.getProperty(\"native.encoding\"));\n+            } catch (Exception e) {\n+                cs = Charset.defaultCharset();\n+            }\n+        }\n+        nativeCharset = cs;\n+    }\n+\n@@ -507,1 +525,1 @@\n-            log = new PrintWriter(System.out);\n+            log = new PrintWriter(System.out, true, nativeCharset);\n","filename":"src\/jdk.jdeps\/share\/classes\/com\/sun\/tools\/jdeps\/JdepsTask.java","additions":20,"deletions":2,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -29,0 +29,1 @@\n+import java.nio.charset.Charset;\n@@ -32,0 +33,16 @@\n+    private final static Charset nativeCharset;\n+    static {\n+        Charset cs;\n+        Console cons;\n+        if ((cons = System.console()) != null) {\n+            cs = cons.charset();\n+        } else {\n+            try {\n+                cs = Charset.forName(System.getProperty(\"native.encoding\"));\n+            } catch (Exception e) {\n+                cs = Charset.defaultCharset();\n+            }\n+        }\n+        nativeCharset = cs;\n+    }\n+\n@@ -33,2 +50,2 @@\n-        System.exit(run(new PrintWriter(System.out, true),\n-                        new PrintWriter(System.err, true),\n+        System.exit(run(new PrintWriter(System.out, true, nativeCharset),\n+                        new PrintWriter(System.err, true, nativeCharset),\n","filename":"src\/jdk.jlink\/share\/classes\/jdk\/tools\/jlink\/internal\/Main.java","additions":19,"deletions":2,"binary":false,"changes":21,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -30,0 +30,1 @@\n+import java.io.Console;\n@@ -49,0 +50,1 @@\n+import java.nio.charset.Charset;\n@@ -121,1 +123,16 @@\n-    private PrintWriter out = new PrintWriter(System.out, true);\n+    private final static Charset nativeCharset;\n+    static {\n+        Charset cs;\n+        Console cons;\n+        if ((cons = System.console()) != null) {\n+            cs = cons.charset();\n+        } else {\n+            try {\n+                cs = Charset.forName(System.getProperty(\"native.encoding\"));\n+            } catch (Exception e) {\n+                cs = Charset.defaultCharset();\n+            }\n+        }\n+        nativeCharset = cs;\n+    }\n+    private PrintWriter out = new PrintWriter(System.out, true, nativeCharset);\n","filename":"src\/jdk.jlink\/share\/classes\/jdk\/tools\/jmod\/JmodTask.java","additions":19,"deletions":2,"binary":false,"changes":21,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2011, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2011, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -31,0 +31,1 @@\n+import java.io.Console;\n@@ -32,0 +33,1 @@\n+import java.nio.charset.Charset;\n@@ -42,0 +44,16 @@\n+    private final static Charset nativeCharset;\n+    static {\n+        Charset cs;\n+        Console cons;\n+        if ((cons = System.console()) != null) {\n+            cs = cons.charset();\n+        } else {\n+            try {\n+                cs = Charset.forName(System.getProperty(\"native.encoding\"));\n+            } catch (Exception e) {\n+                cs = Charset.defaultCharset();\n+            }\n+        }\n+        nativeCharset = cs;\n+    }\n+\n@@ -50,2 +68,2 @@\n-        PrintWriter out = new PrintWriter(System.out);\n-        PrintWriter err = new PrintWriter(System.err);\n+        PrintWriter out = new PrintWriter(System.out, true, nativeCharset);\n+        PrintWriter err = new PrintWriter(System.err, true, nativeCharset);\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/main\/Main.java","additions":21,"deletions":3,"binary":false,"changes":24,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2016, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2016, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -28,0 +28,1 @@\n+import java.io.Console;\n@@ -29,0 +30,1 @@\n+import java.io.OutputStreamWriter;\n@@ -30,0 +32,1 @@\n+import java.nio.charset.Charset;\n@@ -36,0 +39,1 @@\n+import jdk.internal.org.jline.utils.WriterOutputStream;\n@@ -46,5 +50,5 @@\n-    private PrintStream cmdOut = System.out;\n-    private PrintStream console = System.out;\n-    private PrintStream userOut = System.out;\n-    private PrintStream cmdErr = System.err;\n-    private PrintStream userErr = System.err;\n+    private PrintStream cmdOut = derivePrintStream(System.out);\n+    private PrintStream console = cmdOut;\n+    private PrintStream userOut = cmdOut;\n+    private PrintStream cmdErr = derivePrintStream(System.err);\n+    private PrintStream userErr = cmdErr;\n@@ -57,0 +61,24 @@\n+    static final Charset NATIVE_CHARSET;\n+\n+    static {\n+        Console console = System.console();\n+        if (console != null) {\n+            NATIVE_CHARSET = console.charset();\n+        } else {\n+            String nativeEncoding = System.getProperty(\"native.encoding\", \"UTF-8\");\n+            NATIVE_CHARSET = Charset.forName(nativeEncoding);\n+        }\n+    }\n+\n+    \/**\n+     *\n+     *\/\n+    static PrintStream derivePrintStream(PrintStream ps) {\n+        if (Charset.defaultCharset().equals(NATIVE_CHARSET)) {\n+            return ps;\n+        } else {\n+            return new PrintStream(new WriterOutputStream(\n+                new OutputStreamWriter(ps, NATIVE_CHARSET), Charset.defaultCharset()));\n+        }\n+    }\n+\n","filename":"src\/jdk.jshell\/share\/classes\/jdk\/internal\/jshell\/tool\/JShellToolBuilder.java","additions":34,"deletions":6,"binary":false,"changes":40,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2016, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2016, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -78,1 +78,1 @@\n-                        ? System.out\n+                        ? JShellToolBuilder.derivePrintStream(System.out)\n@@ -84,1 +84,1 @@\n-                        ? System.err\n+                        ? JShellToolBuilder.derivePrintStream(System.err)\n","filename":"src\/jdk.jshell\/share\/classes\/jdk\/internal\/jshell\/tool\/JShellToolProvider.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2010, 2018, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2010, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -291,0 +291,1 @@\n+            \"native.encoding\",\n","filename":"test\/langtools\/tools\/javac\/diags\/CheckResourceKeys.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"}]}