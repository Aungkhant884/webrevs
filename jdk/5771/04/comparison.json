{"files":[{"patch":"@@ -29,0 +29,1 @@\n+import java.nio.charset.Charset;\n@@ -232,0 +233,22 @@\n+    \/**\n+     * Set charset for System.out and System.err\n+     *\/\n+    private final static Charset nativeCharset;\n+    static {\n+        Charset cs;\n+        Console cons;\n+        if ((cons = System.console()) != null) {\n+            cs = cons.charset();\n+        } else {\n+            try {\n+                cs = Charset.forName(System.getProperty(\"native.encoding\"));\n+            } catch (Exception e) {\n+                cs = Charset.defaultCharset();\n+            }\n+        }\n+        nativeCharset = cs;\n+    }\n+    public static Charset getNativeCharset() {\n+        return nativeCharset;\n+    }\n+\n@@ -268,2 +291,2 @@\n-            out = new PrintWriter(System.out, true);\n-            err = new PrintWriter(System.err, true);\n+            out = new PrintWriter(System.out, true, nativeCharset);\n+            err = new PrintWriter(System.err, true, nativeCharset);\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/util\/Log.java","additions":25,"deletions":2,"binary":false,"changes":27,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2014, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2014, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -112,0 +112,2 @@\n+        jdk.internal.le,\n+        jdk.jartool,\n@@ -114,0 +116,2 @@\n+        jdk.jlink,\n+        jdk.jpackage,\n","filename":"src\/jdk.compiler\/share\/classes\/module-info.java","additions":5,"deletions":1,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -58,1 +58,1 @@\n-        this.encoding = encoding != null ? encoding : Charset.defaultCharset();\n+        this.encoding = encoding != null ? encoding : com.sun.tools.javac.util.Log.getNativeCharset();\n","filename":"src\/jdk.internal.le\/share\/classes\/jdk\/internal\/org\/jline\/terminal\/impl\/AbstractTerminal.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, 2018, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -32,0 +32,2 @@\n+    requires transitive jdk.compiler;\n+\n","filename":"src\/jdk.internal.le\/share\/classes\/module-info.java","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2014, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2014, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -46,0 +46,2 @@\n+    requires transitive jdk.compiler;\n+\n","filename":"src\/jdk.jartool\/share\/classes\/module-info.java","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1996, 2018, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1996, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -43,0 +43,1 @@\n+import java.nio.charset.Charset;\n@@ -70,0 +71,1 @@\n+import com.sun.tools.javac.util.Log;\n@@ -216,2 +218,3 @@\n-        this.out = new PrintWriter(out, true);\n-        this.err = new PrintWriter(err, true);\n+        Charset nativeCharset = Log.getNativeCharset();\n+        this.out = new PrintWriter(out, true, nativeCharset);\n+        this.err = new PrintWriter(err, true, nativeCharset);\n","filename":"src\/jdk.jartool\/share\/classes\/sun\/tools\/jar\/Main.java","additions":6,"deletions":3,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -174,1 +174,1 @@\n-        return new PrintWriter(ps, autoflush) {\n+        return new PrintWriter(ps, autoflush, Log.getNativeCharset()) {\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/tool\/JavadocLog.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -42,0 +42,1 @@\n+import java.nio.charset.Charset;\n@@ -71,0 +72,1 @@\n+import com.sun.tools.javac.util.Log;\n@@ -400,1 +402,10 @@\n-        return new PrintWriter(s == null ? System.err : s, true);\n+        Charset nativeCharset = Log.getNativeCharset();\n+        if (s == null) {\n+            return new PrintWriter(System.err, true, nativeCharset);\n+        } else {\n+            if (s == System.err || s == System.out) {\n+                return new PrintWriter(s, true, nativeCharset);\n+            } else {\n+                return new PrintWriter(s, true);\n+            }\n+        }\n","filename":"src\/jdk.jdeps\/share\/classes\/com\/sun\/tools\/javap\/JavapTask.java","additions":12,"deletions":1,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -43,0 +43,1 @@\n+import com.sun.tools.javac.util.Log;\n@@ -508,1 +509,1 @@\n-            log = new PrintWriter(System.out);\n+            log = new PrintWriter(System.out, true, Log.getNativeCharset());\n","filename":"src\/jdk.jdeps\/share\/classes\/com\/sun\/tools\/jdeps\/JdepsTask.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -29,0 +29,1 @@\n+import java.nio.charset.Charset;\n@@ -30,0 +31,1 @@\n+import com.sun.tools.javac.util.Log;\n@@ -33,2 +35,3 @@\n-        System.exit(run(new PrintWriter(System.out, true),\n-                        new PrintWriter(System.err, true),\n+        Charset nativeCharset = Log.getNativeCharset();\n+        System.exit(run(new PrintWriter(System.out, true, nativeCharset),\n+                        new PrintWriter(System.err, true, nativeCharset),\n","filename":"src\/jdk.jlink\/share\/classes\/jdk\/tools\/jlink\/internal\/Main.java","additions":5,"deletions":2,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -85,0 +85,1 @@\n+import com.sun.tools.javac.util.Log;\n@@ -121,1 +122,1 @@\n-    private PrintWriter out = new PrintWriter(System.out, true);\n+    private PrintWriter out = new PrintWriter(System.out, true, Log.getNativeCharset());\n","filename":"src\/jdk.jlink\/share\/classes\/jdk\/tools\/jmod\/JmodTask.java","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -54,0 +54,1 @@\n+    requires transitive jdk.compiler;\n","filename":"src\/jdk.jlink\/share\/classes\/module-info.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2011, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2011, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -32,0 +32,1 @@\n+import java.nio.charset.Charset;\n@@ -50,2 +51,3 @@\n-        PrintWriter out = new PrintWriter(System.out);\n-        PrintWriter err = new PrintWriter(System.err);\n+        Charset nativeCharset = com.sun.tools.javac.util.Log.getNativeCharset();\n+        PrintWriter out = new PrintWriter(System.out, true, nativeCharset);\n+        PrintWriter err = new PrintWriter(System.err, true, nativeCharset);\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/main\/Main.java","additions":5,"deletions":3,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2018, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2018, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -53,0 +53,1 @@\n+    requires transitive jdk.compiler;\n","filename":"src\/jdk.jpackage\/share\/classes\/module-info.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2016, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2016, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -29,0 +29,1 @@\n+import java.io.OutputStreamWriter;\n@@ -30,0 +31,1 @@\n+import java.nio.charset.Charset;\n@@ -36,0 +38,1 @@\n+import jdk.internal.org.jline.utils.WriterOutputStream;\n@@ -37,0 +40,1 @@\n+import com.sun.tools.javac.util.Log;\n@@ -46,5 +50,5 @@\n-    private PrintStream cmdOut = System.out;\n-    private PrintStream console = System.out;\n-    private PrintStream userOut = System.out;\n-    private PrintStream cmdErr = System.err;\n-    private PrintStream userErr = System.err;\n+    private PrintStream cmdOut = derivePrintStream(System.out);\n+    private PrintStream console = cmdOut;\n+    private PrintStream userOut = cmdOut;\n+    private PrintStream cmdErr = derivePrintStream(System.err);\n+    private PrintStream userErr = cmdErr;\n@@ -57,0 +61,15 @@\n+    \/**\n+     * Use JLine's WriterOutputStream class if defaul charset is not same as\n+     * native charset for terminal\n+     *\/\n+    static PrintStream derivePrintStream(PrintStream ps) {\n+        Charset nativeCharset = Log.getNativeCharset();\n+        if (Charset.defaultCharset().equals(nativeCharset)) {\n+            return ps;\n+        } else {\n+            return new PrintStream(new WriterOutputStream(\n+                new OutputStreamWriter(ps, nativeCharset),\n+                Charset.defaultCharset()));\n+        }\n+    }\n+\n","filename":"src\/jdk.jshell\/share\/classes\/jdk\/internal\/jshell\/tool\/JShellToolBuilder.java","additions":25,"deletions":6,"binary":false,"changes":31,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2016, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2016, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -78,1 +78,1 @@\n-                        ? System.out\n+                        ? JShellToolBuilder.derivePrintStream(System.out)\n@@ -84,1 +84,1 @@\n-                        ? System.err\n+                        ? JShellToolBuilder.derivePrintStream(System.err)\n","filename":"src\/jdk.jshell\/share\/classes\/jdk\/internal\/jshell\/tool\/JShellToolProvider.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2010, 2018, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2010, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -291,0 +291,1 @@\n+            \"native.encoding\",\n","filename":"test\/langtools\/tools\/javac\/diags\/CheckResourceKeys.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"}]}