{"files":[{"patch":"@@ -215,1 +215,0 @@\n-java\/awt\/Window\/MultiWindowApp\/ChildAlwaysOnTopTest.java 8222323 windows-all\n","filename":"test\/jdk\/ProblemList.txt","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -24,1 +24,1 @@\n-\/**\n+\/*\n@@ -27,2 +27,0 @@\n- * @summary setAlwaysOnTop doesn't behave correctly in Linux\/Solaris under\n- *          certain scenarios\n@@ -30,1 +28,1 @@\n- * @author Semyon Sadetsky\n+ * @summary To test setAlwaysOnTop functionality.\n@@ -34,2 +32,18 @@\n-import javax.swing.*;\n-import java.awt.*;\n+import java.awt.Color;\n+import java.awt.Dialog;\n+import java.awt.Frame;\n+import java.awt.Window;\n+import java.awt.Rectangle;\n+import java.awt.Robot;\n+import java.awt.Panel;\n+import java.awt.Point;\n+import java.awt.Toolkit;\n+import java.awt.image.BufferedImage;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import javax.imageio.ImageIO;\n+\n+import javax.swing.JDialog;\n+import javax.swing.JLabel;\n+import javax.swing.SwingUtilities;\n@@ -42,0 +56,2 @@\n+    private static Robot robot;\n+    private static int caseNo = 0;\n@@ -44,1 +60,0 @@\n-        if( Toolkit.getDefaultToolkit().isAlwaysOnTopSupported() ) {\n@@ -46,0 +61,5 @@\n+        if (!Toolkit.getDefaultToolkit().isAlwaysOnTopSupported()) {\n+            System.out.println(\"alwaysOnTop not supported by: \"+\n+                    Toolkit.getDefaultToolkit().getClass().getName());\n+            return;\n+        }\n@@ -47,1 +67,6 @@\n-            test(null);\n+        \/\/ CASE 1 - JDialog without parent\/owner\n+        System.out.println(\"Testing CASE 1: JDialog without parent\/owner\");\n+        caseNo = 1;\n+        test(null);\n+        System.out.println(\"CASE 1 Passed\");\n+        System.out.println();\n@@ -49,8 +74,13 @@\n-            Window f = new Frame();\n-            f.setBackground(Color.darkGray);\n-            f.setSize(500, 500);\n-            try {\n-                test(f);\n-            } finally {\n-                f.dispose();\n-            }\n+        \/\/ CASE 2 - JDialog with JFrame as owner\n+        System.out.println(\"Testing CASE 2: JDialog with JFrame as owner\");\n+        caseNo = 2;\n+        Window f = new Frame();\n+        f.setBackground(Color.darkGray);\n+        f.setSize(500, 500);\n+        try {\n+            test(f);\n+        } finally {\n+            f.dispose();\n+        }\n+        System.out.println(\"CASE 2 Passed\");\n+        System.out.println();\n@@ -58,10 +88,13 @@\n-            f = new Frame();\n-            f.setBackground(Color.darkGray);\n-            f.setSize(500, 500);\n-            f.setVisible(true);\n-            f = new Dialog((Frame)f);\n-            try {\n-                test(f);\n-            } finally {\n-                ((Frame)f.getParent()).dispose();\n-            }\n+        \/\/ CASE 3 - JDialog within another JDialog as owner\n+        System.out.println(\"Testing CASE 3:Dialog within another\" +\n+                \" JDialog as owner\");\n+        caseNo = 3;\n+        f = new Frame();\n+        f.setBackground(Color.darkGray);\n+        f.setSize(500, 500);\n+        f.setVisible(true);\n+        f = new Dialog((Frame)f);\n+        try {\n+            test(f);\n+        } finally {\n+            ((Frame)f.getParent()).dispose();\n@@ -69,1 +102,4 @@\n-        System.out.println(\"ok\");\n+        System.out.println(\"CASE 3 Passed\");\n+        System.out.println();\n+\n+        System.out.println(\"All three cases passed !!\");\n@@ -73,19 +109,26 @@\n-        SwingUtilities.invokeAndWait(new Runnable() {\n-            @Override\n-            public void run() {\n-                win1 = parent == null ? new JDialog() : new JDialog(parent);\n-                win1.setName(\"top\");\n-                win2 = parent == null ? new JDialog() : new JDialog(parent);\n-                win2.setName(\"behind\");\n-                win1.setSize(200, 200);\n-                Panel panel = new Panel();\n-                panel.setBackground(Color.GREEN);\n-                win1.add(panel);\n-                panel = new Panel();\n-                panel.setBackground(Color.RED);\n-                win2.add(panel);\n-                win1.setAlwaysOnTop(true);\n-                win2.setAlwaysOnTop(false);\n-                win1.setVisible(true);\n-            }\n-        });\n+        try {\n+            SwingUtilities.invokeAndWait(new Runnable() {\n+                @Override\n+                public void run() {\n+                    win1 = parent == null ? new JDialog() : new JDialog(parent);\n+                    win1.setName(\"Top\");\n+\n+                    win2 = parent == null ? new JDialog() : new JDialog(parent);\n+                    win2.setName(\"Behind\");\n+\n+                    JLabel label = new JLabel(\"TOP WINDOW\");\n+                    \/\/ top window - green and smaller\n+                    win1.setSize(200, 200);\n+                    Panel panel = new Panel();\n+                    panel.setBackground(Color.GREEN);\n+                    panel.add(label);\n+                    win1.add(panel);\n+                    win1.setAlwaysOnTop(true);\n+\n+                    \/\/ behind window - red and bigger\n+                    label = new JLabel(\"BEHIND WINDOW\");\n+                    win2.setSize(300, 300);\n+                    panel = new Panel();\n+                    panel.setBackground(Color.RED);\n+                    panel.add(label);\n+                    win2.add(panel);\n@@ -93,3 +136,8 @@\n-        Robot robot = new Robot();\n-        robot.delay(500);\n-        robot.waitForIdle();\n+                    win1.setVisible(true);\n+                    win2.setVisible(true);\n+                }\n+            });\n+\n+            robot = new Robot();\n+            robot.setAutoDelay(300);\n+            robot.waitForIdle();\n@@ -97,3 +145,4 @@\n-        SwingUtilities.invokeAndWait(new Runnable() {\n-            @Override\n-            public void run() {\n+            \/\/ Scenario 1: Trying to unset the alwaysOnTop (green window)\n+            \/\/ by setting the setVisible to true for behind (red) window\n+            System.out.println(\" >> Testing Scenario 1 ...\");\n+            SwingUtilities.invokeAndWait(()-> {\n@@ -101,1 +150,0 @@\n-                win2.setBounds(win1.getBounds());\n@@ -103,2 +151,1 @@\n-            }\n-        });\n+            });\n@@ -106,2 +153,3 @@\n-        robot.delay(500);\n-        robot.waitForIdle();\n+            robot.delay(300);\n+            robot.waitForIdle();\n+            Color color = robot.getPixelColor(point.x + 100, point.y + 100);\n@@ -109,7 +157,13 @@\n-        Color color = robot.getPixelColor(point.x + 100, point.y + 100);\n-        if(!color.equals(Color.GREEN)) {\n-            win1.dispose();\n-            win2.dispose();\n-            throw new RuntimeException(\"alawaysOnTop window is sent back by \" +\n-                    \"another child window setVisible(). \" + color);\n-        }\n+            if (!color.equals(Color.GREEN)) {\n+                SwingUtilities.invokeAndWait(()-> {\n+                    System.out.println(\"Green Window Active?: \"+ win1.isActive());\n+                    System.out.println(\"Red Window Active? \"+ win2.isActive());\n+                });\n+                saveScreenCapture(caseNo , 1);\n+                throw new RuntimeException(\"Scenario 1: alwaysOnTop window is \"+\n+                        \"sent back by another child window with setVisible(). \"\n+                        + color);\n+            }\n+            System.out.println(\" >> Scenario 1 Passed\");\n+\n+            \/*---------------------------------------------------------------*\/\n@@ -117,3 +171,4 @@\n-        SwingUtilities.invokeAndWait(new Runnable() {\n-            @Override\n-            public void run() {\n+            \/\/ Scenario 2: Trying to unset the alwaysOnTop (green window)\n+            \/\/ by setting toFront() to true for behind (red) window\n+            System.out.println(\" >> Testing Scenario 2 ...\");\n+            SwingUtilities.invokeAndWait(()-> {\n@@ -125,0 +180,15 @@\n+            });\n+\n+            robot.delay(300);\n+            robot.waitForIdle();\n+            color = robot.getPixelColor(point.x + 100, point.y + 100);\n+\n+            if (!color.equals(Color.GREEN)) {\n+                SwingUtilities.invokeAndWait(()-> {\n+                    System.out.println(\"Green Window Active?: \"+ win1.isActive());\n+                    System.out.println(\"Red Window Active? \"+ win2.isActive());\n+                });\n+                saveScreenCapture(caseNo , 2);\n+                throw new RuntimeException(\"Scenario 2: alwaysOnTop window is\" +\n+                        \" sent back by another child window with\" +\n+                        \" toFront(). \" + color);\n@@ -126,1 +196,1 @@\n-        });\n+            System.out.println(\" >> Scenario 2 Passed\");\n@@ -128,2 +198,1 @@\n-        robot.delay(500);\n-        robot.waitForIdle();\n+            \/*----------------------------------------------------------------*\/\n@@ -131,7 +200,14 @@\n-        color = robot.getPixelColor(point.x + 100, point.y + 100);\n-        if(!color.equals(Color.GREEN)) {\n-            win1.dispose();\n-            win2.dispose();\n-            throw new RuntimeException(\"alawaysOnTop window is sent back by \" +\n-                    \"another child window toFront(). \" + color);\n-        }\n+            \/\/ Scenario 3: Trying to unset the alwaysOnTop (green window)\n+            \/\/ by setting alwaysOnTop to false. The unsetting should work\n+            \/\/ in this case and bring the red window to the top.\n+            System.out.println(\" >> Testing Scenario 3\");\n+            SwingUtilities.invokeAndWait(new Runnable() {\n+                @Override\n+                public void run() {\n+                    win1.setAlwaysOnTop(false);\n+                    if (parent != null) {\n+                        parent.setVisible(false);\n+                        parent.setVisible(true);\n+                    }\n+                }\n+            });\n@@ -139,7 +215,7 @@\n-        SwingUtilities.invokeAndWait(new Runnable() {\n-            @Override\n-            public void run() {\n-                win1.setAlwaysOnTop(false);\n-                if (parent != null) {\n-                    parent.setVisible(false);\n-                    parent.setVisible(true);\n+            robot.delay(300);\n+            robot.waitForIdle();\n+\n+            SwingUtilities.invokeAndWait(new Runnable() {\n+                @Override\n+                public void run() {\n+                    win2.toFront();\n@@ -147,3 +223,1 @@\n-                win2.toFront();\n-            }\n-        });\n+            });\n@@ -151,2 +225,3 @@\n-        robot.delay(500);\n-        robot.waitForIdle();\n+            robot.delay(500);\n+            robot.waitForIdle();\n+            color = robot.getPixelColor(point.x + 100, point.y + 100);\n@@ -154,3 +229,16 @@\n-        color = robot.getPixelColor(point.x + 100, point.y + 100);\n-        if(!color.equals(Color.RED)) {\n-            throw new RuntimeException(\"Failed to unset alawaysOnTop \" + color);\n+            if (!color.equals(Color.RED)) {\n+                SwingUtilities.invokeAndWait(()-> {\n+                    System.out.println(\"Green Window Active?: \"+ win1.isActive());\n+                    System.out.println(\"Red Window Active? \"+ win2.isActive());\n+                });\n+                saveScreenCapture(caseNo , 3);\n+                throw new RuntimeException(\"Scenario 3: Failed to unset alwaysOnTop \" + color);\n+            }\n+            System.out.println(\" >> Scenario 3 Passed\");\n+        } finally {\n+            if (win1 != null) {\n+                SwingUtilities.invokeAndWait(()-> win1.dispose());\n+            }\n+            if (win2 != null) {\n+                SwingUtilities.invokeAndWait(()-> win2.dispose());\n+            }\n@@ -158,0 +246,1 @@\n+    }\n@@ -159,2 +248,11 @@\n-        win1.dispose();\n-        win2.dispose();\n+    \/\/ For Debugging purpose - method used to save the screen capture as\n+    \/\/ BufferedImage in the event the test fails\n+    private static void saveScreenCapture(int caseNo, int scenarioNo) {\n+        String filename = \"img_\"+ caseNo +\"_\"+ scenarioNo;\n+        BufferedImage image = robot.createScreenCapture(\n+                new Rectangle(0, 0, 500, 500));\n+        try {\n+            ImageIO.write(image, \"png\", new File(filename));\n+        } catch (IOException e) {\n+            e.printStackTrace();\n+        }\n@@ -162,1 +260,1 @@\n-}\n+}\n\\ No newline at end of file\n","filename":"test\/jdk\/java\/awt\/Window\/MultiWindowApp\/ChildAlwaysOnTopTest.java","additions":194,"deletions":96,"binary":false,"changes":290,"status":"modified"}]}