{"files":[{"patch":"@@ -58,0 +58,2 @@\n+    private static final boolean IS_PODMAN = Container.ENGINE_COMMAND.contains(\"podman\");\n+    private static final String ROOT_UID = \"0\";\n@@ -63,5 +65,0 @@\n-        \/\/ See JDK-8273216 for details\n-        if (Container.ENGINE_COMMAND.equals(\"podman\")) {\n-            throw new SkippedException(\"JCMD does not work across container boundaries when using Podman\");\n-        }\n-\n@@ -70,5 +67,1 @@\n-        String uid = getId(\"-u\");\n-        String gid = getId(\"-g\");\n-        String userName = getId(\"-un\");\n-        String groupName = getId(\"-gn\");\n-        String content = generateCustomDockerfile(uid, gid, userName, groupName);\n+        String content = generateCustomDockerfile();\n@@ -138,2 +131,2 @@\n-    private static String generateCustomDockerfile(String uid, String gid,\n-                                            String userName, String groupName) throws Exception {\n+    \/\/ For podman --userns=keep-id is sufficient.\n+    private static String generateCustomDockerfile() throws Exception {\n@@ -146,3 +139,12 @@\n-        sb.append(String.format(\"RUN groupadd --gid %s %s \\n\", gid, groupName));\n-        sb.append(String.format(\"RUN useradd  --uid %s --gid %s %s \\n\", uid, gid, userName));\n-        sb.append(String.format(\"USER %s \\n\", userName));\n+        if (!IS_PODMAN) { \/\/ only needed for docker\n+            String uid = getId(\"-u\");\n+            String gid = getId(\"-g\");\n+            String userName = getId(\"-un\");\n+            String groupName = getId(\"-gn\");\n+            \/\/ Only needed when run as regular user. UID == 0 should already exist\n+            if (!ROOT_UID.equals(uid)) {\n+                sb.append(String.format(\"RUN groupadd --gid %s %s \\n\", gid, groupName));\n+                sb.append(String.format(\"RUN useradd  --uid %s --gid %s %s \\n\", uid, gid, userName));\n+                sb.append(String.format(\"USER %s \\n\", userName));\n+            }\n+        }\n@@ -158,1 +160,1 @@\n-        opts.addDockerOpts(\"--volume\", Utils.TEST_CLASSES + \":\/test-classes\/\")\n+        opts.addDockerOpts(\"--volume\", Utils.TEST_CLASSES + \":\/test-classes\/:z\")\n@@ -164,0 +166,5 @@\n+        if (IS_PODMAN) {\n+            \/\/ map the current userid to the one in the target namespace\n+            opts.addDockerOpts(\"--userns=keep-id\");\n+        }\n+\n","filename":"test\/hotspot\/jtreg\/containers\/docker\/TestJcmd.java","additions":23,"deletions":16,"binary":false,"changes":39,"status":"modified"}]}