{"files":[{"patch":"@@ -48,2 +48,3 @@\n-        var nmm = adminTest(\"windows-my-localmachine\");\n-        var nrm = adminTest(\"windows-root-localmachine\");\n+        var hasAdminPrivileges = detectIfRunningWithAdminPrivileges();\n+        var nmm = adminTest(\"windows-my-localmachine\", hasAdminPrivileges);\n+        var nrm = adminTest(\"windows-root-localmachine\", hasAdminPrivileges);\n@@ -54,1 +55,1 @@\n-    private static boolean hasAccess(String type) throws Exception {\n+    private static boolean detectIfRunningWithAdminPrivileges() {\n@@ -56,8 +57,7 @@\n-            KeyStore ks = KeyStore.getInstance(type);\n-            ks.load(null, null);\n-            return true;\n-        } catch (IOException ioe) {\n-            if (ioe.getMessage().trim().endsWith(\"java.security.KeyStoreException: Access is denied.\")) {\n-                return false;\n-            }\n-            throw ioe;\n+            Process p = Runtime.getRuntime().exec(\"reg query \\\"HKU\\\\S-1-5-19\\\"\");\n+            p.waitFor();\n+            return (p.exitValue() == 0);\n+        }\n+        catch (Exception ex) {\n+            System.out.println(\"Warning: unable to detect admin privileges, assuming none\");\n+            return false;\n@@ -67,2 +67,2 @@\n-    private static List<String> adminTest(String type) throws Exception {\n-        if (hasAccess(type)) {\n+    private static List<String> adminTest(String type, boolean hasAdminPrivileges) throws Exception {\n+        if (hasAdminPrivileges) {\n@@ -71,1 +71,1 @@\n-        System.out.println(\"Ignoring: \" + type + \" as it requires admin access\");\n+        System.out.println(\"Ignoring: \" + type + \" as it requires admin privileges\");\n","filename":"test\/jdk\/sun\/security\/mscapi\/AllTypes.java","additions":14,"deletions":14,"binary":false,"changes":28,"status":"modified"}]}