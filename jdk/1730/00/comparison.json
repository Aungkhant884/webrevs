{"files":[{"patch":"@@ -333,1 +333,1 @@\n-  JVMCI::ensure_box_caches_initialized(CHECK);\n+  JVMCI::ensure_box_caches_initialized(NULL, CHECK);\n","filename":"src\/hotspot\/share\/aot\/aotLoader.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -40,1 +40,1 @@\n-volatile bool JVMCI::_box_caches_initialized = false;\n+bool JVMCI::_box_caches_initialized = false;\n@@ -129,5 +129,2 @@\n-void JVMCI::ensure_box_caches_initialized(TRAPS) {\n-  if (_box_caches_initialized) {\n-    return;\n-  }\n-  MutexLocker locker(JVMCI_lock);\n+void JVMCI::ensure_box_caches_initialized(Mutex* lock, TRAPS) {\n+  MutexLocker locker(lock);\n","filename":"src\/hotspot\/share\/jvmci\/jvmci.cpp","additions":3,"deletions":6,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -56,2 +56,2 @@\n-  \/\/ used to synchronize lazy initialization of boxing cache classes.\n-  static volatile bool _box_caches_initialized;\n+  \/\/ True once boxing cache classes are guaranteed to be initialized.\n+  static bool _box_caches_initialized;\n@@ -117,1 +117,2 @@\n-  static void ensure_box_caches_initialized(TRAPS);\n+  \/\/ If non-null, `lock` is acquired to synchronize this operation.\n+  static void ensure_box_caches_initialized(Mutex* lock, TRAPS);\n","filename":"src\/hotspot\/share\/jvmci\/jvmci.hpp","additions":4,"deletions":3,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -948,0 +948,4 @@\n+  if (_has_auto_box) {\n+    JavaThread* THREAD = JavaThread::current();\n+    JVMCI::ensure_box_caches_initialized(JVMCI_lock, CHECK_(JVMCI::ok));\n+  }\n@@ -1025,1 +1029,0 @@\n-  bool has_auto_box = false;\n@@ -1033,1 +1036,1 @@\n-      has_auto_box = true;\n+      _has_auto_box = true;\n@@ -1057,4 +1060,0 @@\n-  if (has_auto_box) {\n-    JavaThread* THREAD = JavaThread::current();\n-    JVMCI::ensure_box_caches_initialized(CHECK_NULL);\n-  }\n","filename":"src\/hotspot\/share\/jvmci\/jvmciCodeInstaller.cpp","additions":5,"deletions":6,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -203,0 +203,1 @@\n+  bool                      _has_auto_box;\n@@ -233,1 +234,5 @@\n-  CodeInstaller(JVMCIEnv* jvmci_env, bool immutable_pic_compilation) : _arena(mtJVMCI), _jvmci_env(jvmci_env), _immutable_pic_compilation(immutable_pic_compilation) {}\n+  CodeInstaller(JVMCIEnv* jvmci_env, bool immutable_pic_compilation) :\n+    _arena(mtJVMCI),\n+    _jvmci_env(jvmci_env),\n+    _has_auto_box(false),\n+    _immutable_pic_compilation(immutable_pic_compilation) {}\n","filename":"src\/hotspot\/share\/jvmci\/jvmciCodeInstaller.hpp","additions":6,"deletions":1,"binary":false,"changes":7,"status":"modified"}]}