{"files":[{"patch":"@@ -82,0 +82,3 @@\n+#if INCLUDE_JFR\n+#include \"jfr\/jfrEvents.hpp\"\n+#endif\n@@ -1117,0 +1120,3 @@\n+  EventNativeLibraryLoad event;\n+  event.set_name(filename);\n+\n@@ -1124,0 +1130,5 @@\n+\n+    event.set_success(true);\n+    event.set_errorDescription(\"\");\n+    event.commit();\n+\n@@ -1137,0 +1148,4 @@\n+\n+    event.set_success(false);\n+    event.set_errorDescription(error_report);\n+    event.commit();\n","filename":"src\/hotspot\/os\/aix\/os_aix.cpp","additions":15,"deletions":0,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -982,0 +982,3 @@\n+  EventNativeLibraryLoad event;\n+  event.set_name(filename);\n+\n@@ -987,0 +990,4 @@\n+    event.set_success(true);\n+    event.set_errorDescription(\"\");\n+    event.commit();\n+\n@@ -1002,0 +1009,4 @@\n+  event.set_success(false);\n+  event.set_errorDescription(error_report);\n+  event.commit();\n+\n@@ -1011,0 +1022,4 @@\n+\n+  EventNativeLibraryLoad event;\n+  event.set_name(filename);\n+\n@@ -1016,0 +1031,4 @@\n+    event.set_success(true);\n+    event.set_errorDescription(\"\");\n+    event.commit();\n+\n@@ -1033,0 +1052,4 @@\n+  event.set_success(false);\n+  event.set_errorDescription(error_report);\n+  event.commit();\n+\n","filename":"src\/hotspot\/os\/bsd\/os_bsd.cpp","additions":23,"deletions":0,"binary":false,"changes":23,"status":"modified"},{"patch":"@@ -1798,0 +1798,4 @@\n+\n+  EventNativeLibraryLoad event;\n+  event.set_name(filename);\n+\n@@ -1809,0 +1813,4 @@\n+\n+    event.set_success(false);\n+    event.set_errorDescription(error_report);\n+    event.commit();\n@@ -1812,0 +1820,4 @@\n+\n+    event.set_success(true);\n+    event.set_errorDescription(\"\");\n+    event.commit();\n","filename":"src\/hotspot\/os\/linux\/os_linux.cpp","additions":12,"deletions":0,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -1531,0 +1531,2 @@\n+  EventNativeLibraryLoad event;\n+  event.set_name(name);\n@@ -1538,0 +1540,3 @@\n+    event.set_success(true);\n+    event.set_errorDescription(\"\");\n+    event.commit();\n@@ -1551,0 +1556,3 @@\n+    event.set_success(false);\n+    event.set_errorDescription(ebuf);\n+    event.commit();\n@@ -1561,0 +1569,3 @@\n+    event.set_success(false);\n+    event.set_errorDescription(\"open on dll file did not work\");\n+    event.commit();\n@@ -1587,0 +1598,3 @@\n+    event.set_success(false);\n+    event.set_errorDescription(\"failed to get lib architecture\");\n+    event.commit();\n@@ -1631,0 +1645,3 @@\n+    event.set_success(false);\n+    event.set_errorDescription(\"lib architecture matches, but other error occured\");\n+    event.commit();\n@@ -1645,0 +1662,4 @@\n+  event.set_success(false);\n+  event.set_errorDescription(ebuf);\n+  event.commit();\n+\n","filename":"src\/hotspot\/os\/windows\/os_windows.cpp","additions":21,"deletions":0,"binary":false,"changes":21,"status":"modified"},{"patch":"@@ -942,0 +942,7 @@\n+  <Event name=\"NativeLibraryLoad\" category=\"Java Virtual Machine, Runtime\" label=\"Native Library Load Operation\" thread=\"false\" stackTrace=\"true\" startTime=\"true\"\n+    description=\"Information about a dynamic library or other native image load operation\">\n+    <Field type=\"string\" name=\"name\" label=\"Name of Loaded library\" \/>\n+    <Field type=\"boolean\" name=\"success\" label=\"Load success status\" description=\"Success or failure of the load operation\" \/>\n+    <Field type=\"string\" name=\"errorDescription\" label=\"Error Description\" description=\"In case of a load error, error description\" \/>\n+  <\/Event>\n+\n","filename":"src\/hotspot\/share\/jfr\/metadata\/metadata.xml","additions":7,"deletions":0,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -697,0 +697,6 @@\n+    <event name=\"jdk.NativeLibraryLoad\">\n+      <setting name=\"enabled\">true<\/setting>\n+      <setting name=\"stackTrace\">true<\/setting>\n+      <setting name=\"threshold\">0 ms<\/setting>\n+    <\/event>\n+\n","filename":"src\/jdk.jfr\/share\/conf\/jfr\/default.jfc","additions":6,"deletions":0,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -697,0 +697,6 @@\n+    <event name=\"jdk.NativeLibraryLoad\">\n+      <setting name=\"enabled\">true<\/setting>\n+      <setting name=\"stackTrace\">true<\/setting>\n+      <setting name=\"threshold\">0 ms<\/setting>\n+    <\/event>\n+\n","filename":"src\/jdk.jfr\/share\/conf\/jfr\/profile.jfc","additions":6,"deletions":0,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -0,0 +1,95 @@\n+\/*\n+ * Copyright (c) 2013, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package jdk.jfr.event.runtime;\n+\n+import static jdk.test.lib.Asserts.assertTrue;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import jdk.jfr.Recording;\n+import jdk.jfr.consumer.RecordedEvent;\n+import jdk.test.lib.Platform;\n+import jdk.test.lib.jfr.EventNames;\n+import jdk.test.lib.jfr.Events;\n+\n+\/**\n+ * @test\n+ * @bug 8313251\n+ * @key jfr\n+ * @requires vm.hasJFR\n+ * @library \/test\/lib\n+ * @run main\/othervm jdk.jfr.event.runtime.TestNativeLibraryLoadEvent\n+ *\/\n+public class TestNativeLibraryLoadEvent {\n+\n+    private final static String EVENT_NAME = EventNames.NativeLibraryLoad;\n+\n+    public static void main(String[] args) throws Throwable {\n+        Recording recording = new Recording();\n+        recording.enable(EVENT_NAME);\n+        recording.start();\n+        System.loadLibrary(\"awt\");\n+        recording.stop();\n+\n+        List<String> expectedLibs = getExpectedLibs();\n+        for (RecordedEvent event : Events.fromRecording(recording)) {\n+            System.out.println(\"Event:\" + event);\n+            String lib = Events.assertField(event, \"name\").notEmpty().getValue();\n+            Events.assertField(event, \"success\");\n+            for (String expectedLib : new ArrayList<>(expectedLibs)) {\n+                if (lib.contains(expectedLib)) {\n+                    expectedLibs.remove(expectedLib);\n+                }\n+            }\n+        }\n+        assertTrue(expectedLibs.isEmpty(), \"Missing libraries:\" + expectedLibs.stream().collect(Collectors.joining(\", \")));\n+    }\n+\n+    private static List<String> getExpectedLibs() throws Throwable {\n+        String libTemplate = null;\n+        if (Platform.isWindows()) {\n+            libTemplate = \"%s.dll\";\n+        } else if (Platform.isOSX()) {\n+            libTemplate = \"lib%s.dylib\";\n+        } else if (Platform.isLinux()) {\n+            libTemplate = \"lib%s.so\";\n+        } else if (Platform.isAix()) {\n+            libTemplate = \"lib%s.so\";\n+        }\n+\n+        if (libTemplate == null) {\n+            throw new Exception(\"Unsupported OS\");\n+        }\n+\n+        List<String> libs = new ArrayList<String>();\n+        String[] names = { \"awt\" };\n+        for (String name : names) {\n+            libs.add(String.format(libTemplate, name));\n+        }\n+        return libs;\n+    }\n+\n+}\n","filename":"test\/jdk\/jdk\/jfr\/event\/runtime\/TestNativeLibraryLoadEvent.java","additions":95,"deletions":0,"binary":false,"changes":95,"status":"added"},{"patch":"@@ -186,0 +186,1 @@\n+    public static final String NativeLibraryLoad = PREFIX + \"NativeLibraryLoad\";\n","filename":"test\/lib\/jdk\/test\/lib\/jfr\/EventNames.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"}]}