{"files":[{"patch":"@@ -92,3 +92,3 @@\n-template <DecoratorSet MO = MO_UNORDERED>\n-class ShenandoahEvacuateUpdateMetadataClosure: public ShenandoahOopClosureBase {\n-private:\n+template <bool atomic>\n+class ShenandoahEvacuateUpdateRootClosureBase : public ShenandoahOopClosureBase {\n+protected:\n@@ -96,1 +96,0 @@\n-  Thread* const         _thread;\n@@ -98,1 +97,1 @@\n-  inline ShenandoahEvacuateUpdateMetadataClosure();\n+  inline ShenandoahEvacuateUpdateRootClosureBase();\n@@ -101,0 +100,4 @@\n+protected:\n+  template <class T>\n+  inline void do_oop_work(T* p, Thread* t);\n+};\n@@ -102,0 +105,1 @@\n+class ShenandoahEvacuateUpdateMetadataClosure : public ShenandoahEvacuateUpdateRootClosureBase<false> {\n@@ -103,2 +107,5 @@\n-  template <class T>\n-  inline void do_oop_work(T* p);\n+  Thread* const _thread;\n+public:\n+  inline ShenandoahEvacuateUpdateMetadataClosure();\n+  inline void do_oop(oop* p);\n+  inline void do_oop(narrowOop* p);\n@@ -108,3 +115,1 @@\n-class ShenandoahEvacuateUpdateRootsClosure : public ShenandoahOopClosureBase {\n-private:\n-  ShenandoahHeap* const _heap;\n+class ShenandoahEvacuateUpdateRootsClosure : public ShenandoahEvacuateUpdateRootClosureBase<true> {\n@@ -115,3 +120,0 @@\n-protected:\n-  template <typename T>\n-  inline void do_oop_work(T* p, Thread* thr);\n@@ -120,1 +122,1 @@\n-class ShenandoahContextEvacuateUpdateRootsClosure : public ShenandoahEvacuateUpdateRootsClosure {\n+class ShenandoahContextEvacuateUpdateRootsClosure : public ShenandoahEvacuateUpdateRootClosureBase<true> {\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahClosures.hpp","additions":16,"deletions":14,"binary":false,"changes":30,"status":"modified"},{"patch":"@@ -112,3 +112,3 @@\n-template <DecoratorSet MO>\n-ShenandoahEvacuateUpdateMetadataClosure<MO>::ShenandoahEvacuateUpdateMetadataClosure() :\n-  _heap(ShenandoahHeap::heap()), _thread(Thread::current()) {\n+template <bool atomic>\n+ShenandoahEvacuateUpdateRootClosureBase<atomic>::ShenandoahEvacuateUpdateRootClosureBase() :\n+  _heap(ShenandoahHeap::heap()) {\n@@ -117,1 +117,1 @@\n-template <DecoratorSet MO>\n+template <bool atomic>\n@@ -119,1 +119,1 @@\n-void ShenandoahEvacuateUpdateMetadataClosure<MO>::do_oop_work(T* p) {\n+void ShenandoahEvacuateUpdateRootClosureBase<atomic>::do_oop_work(T* p, Thread* t) {\n@@ -123,1 +123,1 @@\n-  assert(_thread == Thread::current(), \"Wrong thread\");\n+  assert(t == Thread::current(), \"Wrong thread\");\n@@ -133,1 +133,6 @@\n-        resolved = _heap->evacuate_object(obj, _thread);\n+        resolved = _heap->evacuate_object(obj, t);\n+      }\n+      if (atomic) {\n+        ShenandoahHeap::atomic_update_oop(resolved, p, o);\n+      } else {\n+        RawAccess<IS_NOT_NULL | MO_UNORDERED>::oop_store(p, resolved);\n@@ -135,1 +140,0 @@\n-      RawAccess<IS_NOT_NULL | MO>::oop_store(p, resolved);\n@@ -139,3 +143,3 @@\n-template <DecoratorSet MO>\n-void ShenandoahEvacuateUpdateMetadataClosure<MO>::do_oop(oop* p) {\n-  do_oop_work(p);\n+template <bool atomic>\n+void ShenandoahEvacuateUpdateRootClosureBase<atomic>::do_oop(oop* p) {\n+  do_oop_work(p, Thread::current());\n@@ -144,3 +148,3 @@\n-template <DecoratorSet MO>\n-void ShenandoahEvacuateUpdateMetadataClosure<MO>::do_oop(narrowOop* p) {\n-  do_oop_work(p);\n+template <bool atomic>\n+void ShenandoahEvacuateUpdateRootClosureBase<atomic>::do_oop(narrowOop* p) {\n+  do_oop_work(p, Thread::current());\n@@ -149,2 +153,2 @@\n-ShenandoahEvacuateUpdateRootsClosure::ShenandoahEvacuateUpdateRootsClosure() :\n-  _heap(ShenandoahHeap::heap()) {\n+ShenandoahEvacuateUpdateMetadataClosure::ShenandoahEvacuateUpdateMetadataClosure() :\n+  ShenandoahEvacuateUpdateRootClosureBase<false>(), _thread(Thread::current()) {\n@@ -153,6 +157,3 @@\n-template <typename T>\n-void ShenandoahEvacuateUpdateRootsClosure::do_oop_work(T* p, Thread* t) {\n-  assert(_heap->is_concurrent_weak_root_in_progress() ||\n-         _heap->is_concurrent_strong_root_in_progress(),\n-         \"Only do this in root processing phase\");\n-  assert(t == Thread::current(), \"Wrong thread\");\n+void ShenandoahEvacuateUpdateMetadataClosure::do_oop(oop* p) {\n+  do_oop_work(p, _thread);\n+}\n@@ -160,13 +161,6 @@\n-  T o = RawAccess<>::oop_load(p);\n-  if (!CompressedOops::is_null(o)) {\n-    oop obj = CompressedOops::decode_not_null(o);\n-    if (_heap->in_collection_set(obj)) {\n-      assert(_heap->is_evacuation_in_progress(), \"Only do this when evacuation is in progress\");\n-      shenandoah_assert_marked(p, obj);\n-      oop resolved = ShenandoahBarrierSet::resolve_forwarded_not_null(obj);\n-      if (resolved == obj) {\n-        resolved = _heap->evacuate_object(obj, t);\n-      }\n-      ShenandoahHeap::atomic_update_oop(resolved, p, o);\n-    }\n-  }\n+void ShenandoahEvacuateUpdateMetadataClosure::do_oop(narrowOop* p) {\n+  do_oop_work(p, _thread);\n+}\n+\n+ShenandoahEvacuateUpdateRootsClosure::ShenandoahEvacuateUpdateRootsClosure() :\n+  ShenandoahEvacuateUpdateRootClosureBase<true>() {\n@@ -186,1 +180,1 @@\n-  ShenandoahEvacuateUpdateRootsClosure(),\n+  ShenandoahEvacuateUpdateRootClosureBase<true>(),\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahClosures.inline.hpp","additions":30,"deletions":36,"binary":false,"changes":66,"status":"modified"},{"patch":"@@ -837,1 +837,1 @@\n-  ShenandoahEvacuateUpdateMetadataClosure<> _cl;\n+  ShenandoahEvacuateUpdateMetadataClosure   _cl;\n@@ -896,1 +896,1 @@\n-        ShenandoahEvacuateUpdateMetadataClosure<> cl;\n+        ShenandoahEvacuateUpdateMetadataClosure cl;\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahConcurrentGC.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2019, 2021, Red Hat, Inc. All rights reserved.\n+ * Copyright (c) 2019, 2022, Red Hat, Inc. All rights reserved.\n@@ -77,1 +77,1 @@\n-  ShenandoahEvacuateUpdateMetadataClosure<> cl;\n+  ShenandoahEvacuateUpdateMetadataClosure cl;\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahNMethod.inline.hpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"}]}