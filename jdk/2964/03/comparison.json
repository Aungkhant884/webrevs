{"files":[{"patch":"@@ -173,0 +173,3 @@\n+void* os::Linux::_mallinfo_fun_ptr = NULL;\n+void* os::Linux::_mallinfo2_fun_ptr = NULL;\n+\n@@ -2232,10 +2235,24 @@\n-  struct mallinfo mi = ::mallinfo();\n-\n-  \/\/ mallinfo is an old API. Member names mean next to nothing and, beyond that, are int.\n-  \/\/ So values may have wrapped around. Still useful enough to see how much glibc thinks\n-  \/\/ we allocated.\n-  const size_t total_allocated = (size_t)(unsigned)mi.uordblks;\n-  st->print(\"C-Heap outstanding allocations: \" SIZE_FORMAT \"K\", total_allocated \/ K);\n-  \/\/ Since mallinfo members are int, glibc values may have wrapped. Warn about this.\n-  if ((vmrss * K) > UINT_MAX && (vmrss * K) > (total_allocated + UINT_MAX)) {\n-    st->print(\" (may have wrapped)\");\n+  size_t total_allocated = 0;\n+  bool called_mallinfo = false;\n+  bool might_have_wrapped = false;\n+#if __GLIBC__ > 2 || (__GLIBC__ == 2 && __GLIBC_MINOR__ >= 33)\n+  if (_mallinfo2_fun_ptr != NULL) {\n+    called_mallinfo = true;\n+    struct mallinfo2 mi = CAST_TO_FN_PTR(struct mallinfo2 (*)(void), _mallinfo2_fun_ptr)();\n+    total_allocated = mi.uordblks;\n+  }\n+#endif \/\/ __GLIBC__ > 2 || (__GLIBC__ == 2 && __GLIBC_MINOR__ >= 33)\n+  if (!called_mallinfo && _mallinfo_fun_ptr != NULL) {\n+    called_mallinfo = true;\n+    \/\/ mallinfo is an old API. Member names mean next to nothing and, beyond that, are int.\n+    \/\/ So values may have wrapped around. Still useful enough to see how much glibc thinks\n+    \/\/ we allocated.\n+    struct mallinfo mi = CAST_TO_FN_PTR(struct mallinfo (*)(void), _mallinfo_fun_ptr)();\n+    total_allocated = (size_t)(unsigned)mi.uordblks;\n+    \/\/ Since mallinfo members are int, glibc values may have wrapped. Warn about this.\n+    might_have_wrapped = (vmrss * K) > UINT_MAX && (vmrss * K) > (total_allocated + UINT_MAX);\n+  }\n+  if (called_mallinfo) {\n+    st->print_cr(\"C-Heap outstanding allocations: \" SIZE_FORMAT \"K%s\",\n+                 total_allocated \/ K,\n+                 might_have_wrapped ? \" (may have wrapped)\" : \"\");\n@@ -2243,2 +2260,0 @@\n-  st->cr();\n-\n@@ -4409,0 +4424,3 @@\n+  Linux::_mallinfo_fun_ptr = dlsym(RTLD_DEFAULT, \"mallinfo\");\n+  Linux::_mallinfo2_fun_ptr = dlsym(RTLD_DEFAULT, \"mallinfo2\");\n+\n","filename":"src\/hotspot\/os\/linux\/os_linux.cpp","additions":30,"deletions":12,"binary":false,"changes":42,"status":"modified"},{"patch":"@@ -256,0 +256,3 @@\n+  static void* _mallinfo_fun_ptr;\n+  static void* _mallinfo2_fun_ptr;\n+\n","filename":"src\/hotspot\/os\/linux\/os_linux.hpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"}]}