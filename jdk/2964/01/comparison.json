{"files":[{"patch":"@@ -2232,10 +2232,26 @@\n-  struct mallinfo mi = ::mallinfo();\n-\n-  \/\/ mallinfo is an old API. Member names mean next to nothing and, beyond that, are int.\n-  \/\/ So values may have wrapped around. Still useful enough to see how much glibc thinks\n-  \/\/ we allocated.\n-  const size_t total_allocated = (size_t)(unsigned)mi.uordblks;\n-  st->print(\"C-Heap outstanding allocations: \" SIZE_FORMAT \"K\", total_allocated \/ K);\n-  \/\/ Since mallinfo members are int, glibc values may have wrapped. Warn about this.\n-  if ((vmrss * K) > UINT_MAX && (vmrss * K) > (total_allocated + UINT_MAX)) {\n-    st->print(\" (may have wrapped)\");\n+  void* mallinfo_ptr = NULL;\n+  size_t total_allocated = 0;\n+  bool might_have_wrapped = false;\n+#if __GLIBC__ > 2 || (__GLIBC__ == 2 && __GLIBC_MINOR__ >= 33)\n+  mallinfo_ptr = dlsym(RTLD_DEFAULT, \"mallinfo2\");\n+  if (mallinfo_ptr != NULL) {\n+    struct mallinfo2 mi = reinterpret_cast<struct mallinfo2 (*)(void)>(mallinfo_ptr)();\n+    total_allocated = mi.uordblks;\n+  }\n+#endif \/\/ __GLIBC__ > 2 || (__GLIBC__ == 2 && __GLIBC_MINOR__ >= 33)\n+  if (mallinfo_ptr == NULL) {\n+    mallinfo_ptr = dlsym(RTLD_DEFAULT, \"mallinfo\");\n+    if (mallinfo_ptr != NULL) {\n+      \/\/ mallinfo is an old API. Member names mean next to nothing and, beyond that, are int.\n+      \/\/ So values may have wrapped around. Still useful enough to see how much glibc thinks\n+      \/\/ we allocated.\n+      struct mallinfo mi = reinterpret_cast<struct mallinfo (*)(void)>(mallinfo_ptr)();\n+      total_allocated = (size_t)(unsigned)mi.uordblks;\n+      \/\/ Since mallinfo members are int, glibc values may have wrapped. Warn about this.\n+      might_have_wrapped = (vmrss * K) > UINT_MAX && (vmrss * K) > (total_allocated + UINT_MAX);\n+    }\n+  }\n+  if (mallinfo_ptr != NULL) {\n+    st->print_cr(\"C-Heap outstanding allocations: \" SIZE_FORMAT \"K%s\",\n+                 total_allocated \/ K,\n+                 might_have_wrapped ? \" (may have wrapped)\" : \"\");\n@@ -2243,2 +2259,0 @@\n-  st->cr();\n-\n","filename":"src\/hotspot\/os\/linux\/os_linux.cpp","additions":26,"deletions":12,"binary":false,"changes":38,"status":"modified"}]}