{"files":[{"patch":"@@ -2232,0 +2232,3 @@\n+  void* mallinfo_ptr = NULL;\n+  size_t total_allocated = 0;\n+  bool might_have_wrapped = false;\n@@ -2233,11 +2236,5 @@\n-  struct mallinfo2 mi = ::mallinfo2();\n-  const size_t total_allocated = mi.uordblks;\n-  const bool might_have_wrapped = false;\n-#else \/\/ __GLIBC__ < 2 || (__GLIBC__ == 2 && __GLIBC_MINOR__ < 33)\n-  struct mallinfo mi = ::mallinfo();\n-  \/\/ mallinfo is an old API. Member names mean next to nothing and, beyond that, are int.\n-  \/\/ So values may have wrapped around. Still useful enough to see how much glibc thinks\n-  \/\/ we allocated.\n-  const size_t total_allocated = static_cast<size_t>(mi.uordblks);\n-  \/\/ Since mallinfo members are int, glibc values may have wrapped. Warn about this.\n-  const bool might_have_wrapped = (vmrss * K) > UINT_MAX && (vmrss * K) > (total_allocated + UINT_MAX);\n+  mallinfo_ptr = dlsym(RTLD_DEFAULT, \"mallinfo2\");\n+  if (mallinfo_ptr != NULL) {\n+    struct mallinfo2 mi = reinterpret_cast<struct mallinfo2 (*)(void)>(mallinfo_ptr)();\n+    total_allocated = mi.uordblks;\n+  }\n@@ -2245,3 +2242,16 @@\n-  st->print(\"C-Heap outstanding allocations: \" SIZE_FORMAT \"K\", total_allocated \/ K);\n-  if (might_have_wrapped) {\n-    st->print(\" (may have wrapped)\");\n+  if (mallinfo_ptr == NULL) {\n+    mallinfo_ptr = dlsym(RTLD_DEFAULT, \"mallinfo\");\n+    if (mallinfo_ptr != NULL) {\n+      \/\/ mallinfo is an old API. Member names mean next to nothing and, beyond that, are int.\n+      \/\/ So values may have wrapped around. Still useful enough to see how much glibc thinks\n+      \/\/ we allocated.\n+      struct mallinfo mi = reinterpret_cast<struct mallinfo (*)(void)>(mallinfo_ptr)();\n+      total_allocated = (size_t)(unsigned)mi.uordblks;\n+      \/\/ Since mallinfo members are int, glibc values may have wrapped. Warn about this.\n+      might_have_wrapped = (vmrss * K) > UINT_MAX && (vmrss * K) > (total_allocated + UINT_MAX);\n+    }\n+  }\n+  if (mallinfo_ptr != NULL) {\n+    st->print_cr(\"C-Heap outstanding allocations: \" SIZE_FORMAT \"K%s\",\n+                 total_allocated \/ K,\n+                 might_have_wrapped ? \" (may have wrapped)\" : \"\");\n@@ -2249,1 +2259,0 @@\n-  st->cr();\n","filename":"src\/hotspot\/os\/linux\/os_linux.cpp","additions":24,"deletions":15,"binary":false,"changes":39,"status":"modified"}]}