{"files":[{"patch":"@@ -182,2 +182,2 @@\n-    if ( error == JVMTI_ERROR_THREAD_NOT_ALIVE ) {\n-        \/* Just return, thread hasn't started yet *\/\n+    if ( error == JVMTI_ERROR_THREAD_NOT_ALIVE && node == NULL) {\n+        \/* Just return. This can happen when clearing the TLS. *\/\n@@ -247,3 +247,0 @@\n-    \/* In some rare cases we might get NULL, so we check the list manually for\n-     *   any threads that we could match.\n-     *\/\n@@ -251,14 +248,7 @@\n-        JNIEnv *env;\n-\n-        env = getEnv();\n-        if ( list != NULL ) {\n-            node = nonTlsSearch(env, list, thread);\n-        } else {\n-            node = nonTlsSearch(env, &runningThreads, thread);\n-            if ( node == NULL ) {\n-                node = nonTlsSearch(env, &otherThreads, thread);\n-            }\n-        }\n-        if ( node != NULL ) {\n-            \/* Here we make another attempt to set TLS, it's ok if this fails *\/\n-            setThreadLocalStorage(thread, (void*)node);\n+        \/*\n+         * If the thread was not yet started when the ThreadNode was created, then it\n+         * got added to the otherThreads list and its thread local storage was not set.\n+         * Search for it in the otherThreads list.\n+         *\/\n+        if ( list == NULL || list == &otherThreads ) {\n+            node = nonTlsSearch(getEnv(), &otherThreads, thread);\n@@ -266,0 +256,2 @@\n+        \/* A thread with no TLS should never be in the runningThreads list. *\/\n+        JDI_ASSERT(!nonTlsSearch(getEnv(), &runningThreads, thread));\n@@ -383,2 +375,4 @@\n-         *   Some threads may not be in a state that allows setting of TLS,\n-         *   which is ok, see findThread, it deals with threads without TLS set.\n+         *   Threads that are not yet started do not allow setting of TLS. These\n+         *   threads go on the otherThreads list and have their TLS set\n+         *   when moved to the runningThreads list. findThread() knows to look\n+         *   on otherThreads when the TLS lookup fails.\n@@ -386,1 +380,3 @@\n-        setThreadLocalStorage(node->thread, (void*)node);\n+        if (list != &otherThreads) {\n+            setThreadLocalStorage(node->thread, (void*)node);\n+        }\n@@ -2114,0 +2110,2 @@\n+        \/* Now that we know the thread has started, we can set its TLS.*\/\n+        setThreadLocalStorage(thread, (void*)node);\n","filename":"src\/jdk.jdwp.agent\/share\/native\/libjdwp\/threadControl.c","additions":20,"deletions":22,"binary":false,"changes":42,"status":"modified"}]}