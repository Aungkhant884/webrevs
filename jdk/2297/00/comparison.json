{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -33,0 +33,1 @@\n+import jdk.test.lib.cds.CDSOptions;\n@@ -35,1 +36,0 @@\n-import jdk.test.lib.process.ProcessTools;\n@@ -82,9 +82,5 @@\n-        args = (ArrayList<String>)args.clone();\n-        args.add(\"-XX:SharedArchiveFile=\" + archiveName);\n-        args.add(\"-Xshare:dump\");\n-        args.add(\"-Xlog:cds=debug\");\n-        for (String m : more) {\n-            args.add(m);\n-        }\n-        ProcessBuilder pb = ProcessTools.createJavaProcessBuilder(args);\n-        OutputAnalyzer out = CDSTestUtils.executeAndLog(pb, logName);\n+        CDSOptions opts = (new CDSOptions())\n+            .addPrefix(\"-Xlog:cds=debug\")\n+            .setArchiveName(archiveName)\n+            .addSuffix(more);\n+        OutputAnalyzer out = CDSTestUtils.createArchive(opts);\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/DeterministicDump.java","additions":7,"deletions":11,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2017, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2017, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -33,0 +33,1 @@\n+import jdk.test.lib.cds.CDSOptions;\n@@ -43,6 +44,3 @@\n-            ProcessBuilder pb = ProcessTools.createJavaProcessBuilder(\n-                \"-XX:SharedArchiveFile=.\/DumpSharedDictionary.jsa\",\n-                \"-Xshare:dump\");\n-\n-            OutputAnalyzer out = CDSTestUtils.executeAndLog(pb, \"dump\");\n-            out.shouldHaveExitValue(0);\n+            CDSOptions opts = (new CDSOptions())\n+                .setArchiveName(\".\/DumpSharedDictionary.jsa\");\n+            CDSTestUtils.createArchiveAndCheck(opts);\n@@ -52,9 +50,7 @@\n-            pb = ProcessTools.createJavaProcessBuilder(\n-                    \"-XX:SharedArchiveFile=.\/DumpSharedDictionary.jsa\",\n-                    \"-Dtest.jdk=\" + testjdkPath,\n-                    \"-Xshare:on\", \"DumpSharedDictionary\", \"test\");\n-\n-            out = CDSTestUtils.executeAndLog(pb, \"exec\");\n-            if (!CDSTestUtils.isUnableToMap(out)) {\n-                out.shouldHaveExitValue(0);\n-            }\n+            opts = (new CDSOptions())\n+                .setUseVersion(false)\n+                .addSuffix(\"-XX:SharedArchiveFile=.\/DumpSharedDictionary.jsa\",\n+                           \"-Dtest.jdk=\" + testjdkPath,\n+                           \"DumpSharedDictionary\", \"test\");\n+            CDSTestUtils.run(opts)\n+                        .assertNormalExit();\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/DumpSharedDictionary.java","additions":12,"deletions":16,"binary":false,"changes":28,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2013, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2013, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -34,0 +34,1 @@\n+import jdk.test.lib.cds.CDSOptions;\n@@ -35,2 +36,0 @@\n-import jdk.test.lib.process.ProcessTools;\n-import jdk.test.lib.process.OutputAnalyzer;\n@@ -44,5 +43,4 @@\n-        ProcessBuilder pb = ProcessTools.createTestJvm(\n-                                \"-XX:SharedArchiveFile=.\/SharedArchiveFile.jsa\",\n-                                \"-Xshare:dump\", \"-Xlog:cds\");\n-        OutputAnalyzer out = CDSTestUtils.executeAndLog(pb, \"SharedArchiveFile\");\n-        CDSTestUtils.checkDump(out);\n+        CDSOptions opts = (new CDSOptions())\n+            .addPrefix(\"-Xlog:cds\")\n+            .setArchiveName(\".\/SharedArchiveFile.jsa\");\n+        CDSTestUtils.createArchiveAndCheck(opts);\n@@ -51,5 +49,4 @@\n-        pb = ProcessTools.createTestJvm(\n-                                \"-XX:SharedArchiveFile=.\/SharedArchiveFile.jsa\",\n-                                \"-XX:+DumpSharedSpaces\", \"-Xlog:cds\");\n-        out = CDSTestUtils.executeAndLog(pb, \"SharedArchiveFile\");\n-        CDSTestUtils.checkDump(out);\n+        opts = (new CDSOptions())\n+            .addPrefix(\"-XX:+DumpSharedSpaces\", \"-Xlog:cds\")\n+            .setArchiveName(\".\/SharedArchiveFile.jsa\");\n+        CDSTestUtils.createArchiveAndCheck(opts);\n@@ -57,5 +54,4 @@\n-        pb = ProcessTools.createTestJvm(\n-                              \"-XX:SharedArchiveFile=.\/SharedArchiveFile.jsa\",\n-                              \"-Xshare:on\", \"-version\");\n-        out = CDSTestUtils.executeAndLog(pb, \"SharedArchiveFile\");\n-        CDSTestUtils.checkExec(out);\n+        opts = (new CDSOptions())\n+            .setArchiveName(\".\/SharedArchiveFile.jsa\");\n+        CDSTestUtils.run(opts)\n+                    .assertNormalExit();\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/SharedArchiveFile.java","additions":14,"deletions":18,"binary":false,"changes":32,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -35,0 +35,1 @@\n+import jdk.test.lib.cds.CDSOptions;\n@@ -36,1 +37,0 @@\n-import jdk.test.lib.process.ProcessTools;\n@@ -45,9 +45,7 @@\n-        ProcessBuilder pb = ProcessTools.createJavaProcessBuilder(\n-            \"-XX:+UnlockDiagnosticVMOptions\",\n-            \"-XX:SharedArchiveFile=.\/SharedStrings.jsa\",\n-            \"-Xlog:cds,cds+hashtables\",\n-            \/\/ Needed for bootclasspath match, for CDS to work with WhiteBox API\n-            \"-Xbootclasspath\/a:\" + ClassFileInstaller.getJarPath(\"whitebox.jar\"),\n-            \"-Xshare:dump\");\n-\n-        OutputAnalyzer out = CDSTestUtils.executeAndLog(pb, \"dump\");\n+        CDSOptions opts = (new CDSOptions())\n+            .addPrefix(\"-XX:+UnlockDiagnosticVMOptions\",\n+                       \"-Xlog:cds,cds+hashtables\",\n+                       \/\/ Needed for bootclasspath match, for CDS to work with WhiteBox API\n+                       \"-Xbootclasspath\/a:\" + ClassFileInstaller.getJarPath(\"whitebox.jar\"))\n+            .setArchiveName(\".\/SharedStrings.jsa\");\n+        OutputAnalyzer out = CDSTestUtils.createArchive(opts);\n@@ -56,11 +54,14 @@\n-\n-        pb = ProcessTools.createJavaProcessBuilder(\n-                \"-XX:+UnlockDiagnosticVMOptions\",\n-                \"-XX:SharedArchiveFile=.\/SharedStrings.jsa\",\n-                \/\/ needed for access to white box test API\n-                \"-Xbootclasspath\/a:\" + ClassFileInstaller.getJarPath(\"whitebox.jar\"),\n-                \"-XX:+UnlockDiagnosticVMOptions\", \"-XX:+WhiteBoxAPI\",\n-                \"-Xshare:on\", \"-showversion\", \"SharedStringsWb\");\n-\n-        out = CDSTestUtils.executeAndLog(pb, \"exec\");\n-        CDSTestUtils.checkExec(out);\n+        opts = (new CDSOptions())\n+            .setUseVersion(false)\n+            \/\/ This test is run with the -Xshare:off vmoption prepended in tier3.\n+            \/\/ Set CDSOptions.xShareMode to \"off\" so that the result checking\n+            \/\/ would not always expect the word \"sharing\" in the output.\n+            .setXShareMode(\"off\")\n+            .addPrefix(\"-XX:+UnlockDiagnosticVMOptions\",\n+                       \"-XX:SharedArchiveFile=.\/SharedStrings.jsa\",\n+                       \/\/ needed for access to white box test API\n+                       \"-Xbootclasspath\/a:\" + ClassFileInstaller.getJarPath(\"whitebox.jar\"),\n+                       \"-XX:+UnlockDiagnosticVMOptions\", \"-XX:+WhiteBoxAPI\",\n+                       \"-Xshare:on\", \"-showversion\", \"SharedStringsWb\");\n+        CDSTestUtils.run(opts)\n+                    .assertNormalExit();\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/SharedStrings.java","additions":23,"deletions":22,"binary":false,"changes":45,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2016, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2016, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -35,0 +35,2 @@\n+import jdk.test.lib.cds.CDSOptions;\n+import jdk.test.lib.cds.CDSTestUtils;\n@@ -37,1 +39,0 @@\n-import jdk.test.lib.process.ProcessTools;\n@@ -77,12 +78,17 @@\n-        ProcessBuilder pb = ProcessTools.createTestJvm(\n-            \"-XX:DumpLoadedClassList=\" + classList,\n-            \"--patch-module=java.base=\" + patchJar,\n-            \"-Xbootclasspath\/a:\" + appendJar,\n-            \"-cp\",\n-            appJar,\n-            appClass[0]);\n-        OutputAnalyzer output = TestCommon.executeAndLog(pb, \"dumpClassList\");\n-        TestCommon.checkExecReturn(output, 0, true,\n-                                   \"hello world\",\n-                                   \"skip writing class java\/lang\/NewClass\") \/\/ skip classes outside of jrt image\n-            .shouldNotContain(\"skip writing class boot\/append\/Foo\");        \/\/ but classes on -Xbootclasspath\/a should not be skipped\n+        CDSOptions opts = (new CDSOptions())\n+            .setUseVersion(false)\n+            .setXShareMode(\"auto\")\n+            .addPrefix(\"-XX:DumpLoadedClassList=\" + classList,\n+                       \"--patch-module=java.base=\" + patchJar,\n+                       \"-Xbootclasspath\/a:\" + appendJar,\n+                       \"-cp\",\n+                       appJar,\n+                       appClass[0]);\n+        CDSTestUtils.run(opts)\n+            .assertNormalExit(output -> {\n+                output.shouldContain(\"hello world\");\n+                \/\/ skip classes outside of jrt image\n+                output.shouldContain(\"skip writing class java\/lang\/NewClass\");\n+                \/\/ but classes on -Xbootclasspath\/a should not be skipped\n+                output.shouldNotContain(\"skip writing class boot\/append\/Foo\");\n+            });\n@@ -90,5 +96,8 @@\n-        output = TestCommon.createArchive(appJar, appClass,\n-                                          \"-Xbootclasspath\/a:\" + appendJar,\n-                                          \"-Xlog:class+load\",\n-                                          \"-XX:SharedClassListFile=\" + classList);\n-        TestCommon.checkDump(output)\n+        opts = (new CDSOptions())\n+            .setClassList(appClass)\n+            .addPrefix(\"-cp\", appJar,\n+                       \"-Xbootclasspath\/a:\" + appendJar,\n+                       \"-Xlog:class+load\",\n+                       \"-XX:SharedClassListFile=\" + classList);\n+        OutputAnalyzer out = CDSTestUtils.createArchive(opts);\n+        CDSTestUtils.checkDump(out, \"[info][class,load] boot.append.Foo\")\n@@ -96,2 +105,1 @@\n-            .shouldNotContain(\"Preload Warning: Cannot find boot\/append\/Foo\")\n-            .shouldContain(\"[info][class,load] boot.append.Foo\");\n+            .shouldNotContain(\"Preload Warning: Cannot find boot\/append\/Foo\");\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/DumpClassList.java","additions":29,"deletions":21,"binary":false,"changes":50,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2018, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2018, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -38,0 +38,1 @@\n+import jdk.test.lib.cds.CDSOptions;\n@@ -40,1 +41,0 @@\n-import jdk.test.lib.process.ProcessTools;\n@@ -86,15 +86,17 @@\n-        ProcessBuilder pb = ProcessTools.createTestJvm(\n-            \"-XX:DumpLoadedClassList=\" + CLASSLIST_FILE,\n-            \/\/ trigger JVMCI runtime init so that JVMCI classes will be\n-            \/\/ included in the classlist\n-            \"-XX:+UnlockExperimentalVMOptions\",\n-            \"-XX:+EnableJVMCI\",\n-            \"-XX:+EagerJVMCI\",\n-            \"-cp\",\n-            TESTJAR,\n-            TESTNAME,\n-            TEST_OUT);\n-\n-        OutputAnalyzer output = TestCommon.executeAndLog(pb, \"dump-loaded-classes\")\n-            .shouldHaveExitValue(0)\n-            .shouldContain(TEST_OUT);\n+        CDSOptions opts = (new CDSOptions())\n+            .setUseVersion(false)\n+            .setXShareMode(\"auto\")\n+            .addPrefix(\"-XX:DumpLoadedClassList=\" + CLASSLIST_FILE,\n+                       \/\/ trigger JVMCI runtime init so that JVMCI classes will be\n+                       \/\/ included in the classlist\n+                       \"-XX:+UnlockExperimentalVMOptions\",\n+                       \"-XX:+EnableJVMCI\",\n+                       \"-XX:+EagerJVMCI\",\n+                       \"-cp\",\n+                       TESTJAR,\n+                       TESTNAME,\n+                       TEST_OUT);\n+        CDSTestUtils.run(opts)\n+            .assertNormalExit(output -> {\n+                output.shouldContain(TEST_OUT);\n+            });\n@@ -113,11 +115,10 @@\n-        ProcessBuilder pb = ProcessTools.createTestJvm(\n-            \"-cp\",\n-            TESTJAR,\n-            \"-XX:SharedClassListFile=\" + CLASSLIST_FILE,\n-            \"-XX:SharedArchiveFile=\" + ARCHIVE_FILE,\n-            \"-Xlog:cds\",\n-            \"-Xshare:dump\",\n-            \"-XX:MetaspaceSize=12M\",\n-            \"-XX:MaxMetaspaceSize=12M\");\n-\n-        OutputAnalyzer output = TestCommon.executeAndLog(pb, \"dump-archive\");\n+        CDSOptions opts = (new CDSOptions())\n+            .addPrefix(\"-cp\",\n+                       TESTJAR,\n+                       \"-XX:SharedClassListFile=\" + CLASSLIST_FILE,\n+                       \"-Xlog:cds\",\n+                       \"-Xshare:dump\",\n+                       \"-XX:MetaspaceSize=12M\",\n+                       \"-XX:MaxMetaspaceSize=12M\")\n+            .setArchiveName(ARCHIVE_FILE);\n+        OutputAnalyzer output = CDSTestUtils.createArchive(opts);\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/GraalWithLimitedMetaspace.java","additions":29,"deletions":28,"binary":false,"changes":57,"status":"modified"},{"patch":"@@ -40,1 +40,0 @@\n-import jdk.test.lib.process.ProcessTools;\n@@ -54,6 +53,8 @@\n-        ProcessBuilder pb = ProcessTools.createTestJvm(\n-            \"-XX:DumpLoadedClassList=\" + classList,\n-            \"-cp\", appJar,\n-            mainClass);\n-        OutputAnalyzer output = TestCommon.executeAndLog(pb, namePrefix);\n-        output.shouldHaveExitValue(0);\n+        CDSOptions dumpOpts = (new CDSOptions())\n+            .setUseVersion(false)\n+            .setXShareMode(\"auto\")\n+            .addSuffix(\"-XX:DumpLoadedClassList=\" + classList,\n+                       \"-cp\", appJar,\n+                       mainClass);\n+        CDSTestUtils.run(dumpOpts)\n+                    .assertNormalExit();\n@@ -75,1 +76,1 @@\n-        output = CDSTestUtils.runWithArchive(runOpts);\n+        OutputAnalyzer output = CDSTestUtils.runWithArchive(runOpts);\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/LambdaWithOldClass.java","additions":9,"deletions":8,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -37,1 +37,0 @@\n-import jdk.test.lib.process.ProcessTools;\n@@ -48,5 +47,8 @@\n-        ProcessBuilder pb = ProcessTools.createTestJvm(\n-            \"-XX:DumpLoadedClassList=\" + classList,\n-            \"-cp\", appJar,\n-            appClass);\n-        OutputAnalyzer output = TestCommon.executeAndLog(pb, \"dumpClassList\");\n+        CDSOptions dumpOpts = (new CDSOptions())\n+            .setUseVersion(false)\n+            .setXShareMode(\"auto\")\n+            .addSuffix(\"-XX:DumpLoadedClassList=\" + classList,\n+                       \"-cp\", appJar,\n+                       appClass);\n+        CDSTestUtils.run(dumpOpts)\n+                    .assertNormalExit();\n@@ -68,1 +70,1 @@\n-       output = CDSTestUtils.runWithArchive(runOpts);\n+       OutputAnalyzer output = CDSTestUtils.runWithArchive(runOpts);\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/StaticArchiveWithLambda.java","additions":10,"deletions":8,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -40,0 +40,1 @@\n+import jdk.test.lib.cds.CDSOptions;\n@@ -42,1 +43,0 @@\n-import jdk.test.lib.process.ProcessTools;\n@@ -61,7 +61,9 @@\n-        ProcessBuilder pb = ProcessTools.createJavaProcessBuilder(\n-            \"-XX:DumpLoadedClassList=\" + classList,\n-            \"-cp\",\n-            appJar,\n-            appClass);\n-        OutputAnalyzer output = TestCommon.executeAndLog(pb, \"dumpClassList\");\n-        TestCommon.checkExecReturn(output, 0, true);\n+        CDSOptions opts = (new CDSOptions())\n+            .setUseVersion(false)\n+            .setXShareMode(\"auto\")\n+            .addPrefix(\"-XX:DumpLoadedClassList=\" + classList,\n+                       \"-cp\",\n+                       appJar,\n+                       appClass);\n+        CDSTestUtils.run(opts)\n+                    .assertNormalExit();\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/dynamicArchive\/LambdaForClassInBaseArchive.java","additions":11,"deletions":9,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -41,2 +41,0 @@\n-import jdk.test.lib.process.OutputAnalyzer;\n-import jdk.test.lib.process.ProcessTools;\n@@ -57,6 +55,8 @@\n-        ProcessBuilder pb = ProcessTools.createTestJvm(\n-            \"-XX:DumpLoadedClassList=\" + classList,\n-            \"-cp\", appJar,\n-            mainClass);\n-        OutputAnalyzer output = TestCommon.executeAndLog(pb, \"dumpClassList\");\n-        output.shouldHaveExitValue(0);\n+        CDSOptions opts = (new CDSOptions())\n+            .setUseVersion(false)\n+            .setXShareMode(\"auto\")\n+            .addSuffix(\"-XX:DumpLoadedClassList=\" + classList,\n+                       \"-cp\", appJar,\n+                       mainClass);\n+        CDSTestUtils.run(opts)\n+                    .assertNormalExit();\n@@ -65,1 +65,1 @@\n-        CDSOptions opts = (new CDSOptions())\n+        opts = (new CDSOptions())\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/dynamicArchive\/LambdaInBaseArchive.java","additions":10,"deletions":10,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2019, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2019, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -48,0 +48,1 @@\n+import jdk.test.lib.cds.CDSOptions;\n@@ -50,1 +51,0 @@\n-import jdk.test.lib.process.ProcessTools;\n@@ -110,7 +110,11 @@\n-        ProcessBuilder pb = ProcessTools.createTestJvm(\n-            \"-XX:DumpLoadedClassList=\" + classList,\n-            \"-cp\",\n-            appJar,\n-            appClass);\n-        OutputAnalyzer output = TestCommon.executeAndLog(pb, \"dumpClassList\");\n-        TestCommon.checkExecReturn(output, 0, true, \"length = 0\");\n+        CDSOptions opts = (new CDSOptions())\n+            .setUseVersion(false)\n+            .setXShareMode(\"auto\")\n+            .addSuffix(\"-XX:DumpLoadedClassList=\" + classList,\n+                       \"-cp\",\n+                       appJar,\n+                       appClass);\n+        CDSTestUtils.run(opts)\n+                    .assertNormalExit(output -> {\n+                        output.shouldContain(\"length = 0\");\n+                    });\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/dynamicArchive\/NoClassToArchive.java","additions":13,"deletions":9,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -40,0 +40,1 @@\n+import jdk.test.lib.cds.CDSOptions;\n@@ -41,2 +42,0 @@\n-import jdk.test.lib.process.ProcessTools;\n-import jdk.test.lib.process.OutputAnalyzer;\n@@ -70,8 +69,11 @@\n-        ProcessBuilder pb = ProcessTools.createJavaProcessBuilder(\n-            \"-Xlog:cds\",\n-            \"-Xlog:module=debug\",\n-            \"-Dtest.src=\" + TEST_SRC,\n-            \"NewModuleFinderTest$Helper\");\n-        OutputAnalyzer out = CDSTestUtils.executeAndLog(pb, \"exec\");\n-        out.shouldHaveExitValue(0);\n-        out.shouldContain(\"define_module(): creation of module: com.simple,\");\n+        CDSOptions opts = (new CDSOptions())\n+            .setUseVersion(false)\n+            .setXShareMode(\"auto\")\n+            .addSuffix(\"-Xlog:cds\",\n+                       \"-Xlog:module=debug\",\n+                       \"-Dtest.src=\" + TEST_SRC,\n+                       \"NewModuleFinderTest$Helper\");\n+        CDSTestUtils.run(opts)\n+            .assertNormalExit(output -> {\n+                output.shouldContain(\"define_module(): creation of module: com.simple,\");\n+            });\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/jigsaw\/NewModuleFinderTest.java","additions":13,"deletions":11,"binary":false,"changes":24,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2016, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2016, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -37,0 +37,1 @@\n+import jdk.test.lib.cds.CDSTestUtils;\n@@ -38,2 +39,0 @@\n-import jdk.test.lib.process.ProcessTools;\n-\n@@ -58,8 +57,11 @@\n-        ProcessBuilder pb = ProcessTools.createJavaProcessBuilder(\n-                \"-XX:+UnlockDiagnosticVMOptions\",\n-                \"-XX:+WhiteBoxAPI\",\n-                useWb,\n-                \"-agentlib:SimpleClassFileLoadHook=LoadMe,beforeHook,after_Hook\",\n-                \"ClassFileLoadHook\",\n-                \"\" + ClassFileLoadHook.TestCaseId.SHARING_OFF_CFLH_ON);\n-        TestCommon.executeAndLog(pb, \"no-sharing\").shouldHaveExitValue(0);\n+        CDSOptions opts = (new CDSOptions())\n+            .setUseVersion(false)\n+            .setXShareMode(\"off\")\n+            .addSuffix(\"-XX:+UnlockDiagnosticVMOptions\",\n+                       \"-XX:+WhiteBoxAPI\",\n+                       useWb,\n+                       \"-agentlib:SimpleClassFileLoadHook=LoadMe,beforeHook,after_Hook\",\n+                       \"ClassFileLoadHook\",\n+                       \"\" + ClassFileLoadHook.TestCaseId.SHARING_OFF_CFLH_ON);\n+        CDSTestUtils.run(opts)\n+                    .assertNormalExit();\n@@ -86,1 +88,1 @@\n-        CDSOptions opts = (new CDSOptions()).setXShareMode(\"auto\");\n+        opts = (new CDSOptions()).setXShareMode(\"auto\");\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/jvmti\/ClassFileLoadHookTest.java","additions":14,"deletions":12,"binary":false,"changes":26,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2014, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2014, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -48,0 +48,1 @@\n+import jdk.test.lib.cds.CDSTestUtils;\n@@ -49,1 +50,0 @@\n-import jdk.test.lib.process.ProcessTools;\n@@ -112,9 +112,12 @@\n-        ProcessBuilder pb = ProcessTools.createJavaProcessBuilder(\n-                bootCP,\n-                \"-cp\", appJar,\n-                \"-XX:+UnlockDiagnosticVMOptions\",\n-                \"-XX:+WhiteBoxAPI\",\n-                \"-Xshare:off\",\n-                agentCmdArg,\n-                \"InstrumentationApp\", flagFile, bootJar, appJar, custJar);\n-        TestCommon.executeAndLog(pb, \"no-sharing\").shouldHaveExitValue(0);\n+        CDSOptions opts = (new CDSOptions())\n+            .setUseVersion(false)\n+            .setXShareMode(\"off\")\n+            .addSuffix(bootCP,\n+                       \"-cp\", appJar,\n+                       \"-XX:+UnlockDiagnosticVMOptions\",\n+                       \"-XX:+WhiteBoxAPI\",\n+                       \"-Xshare:off\",\n+                       agentCmdArg,\n+                       \"InstrumentationApp\", flagFile, bootJar, appJar, custJar);\n+        CDSTestUtils.run(opts)\n+                    .assertNormalExit();\n@@ -156,1 +159,1 @@\n-        CDSOptions opts = (new CDSOptions()).setXShareMode(\"auto\");\n+        opts = (new CDSOptions()).setXShareMode(\"auto\");\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/jvmti\/InstrumentationTest.java","additions":15,"deletions":12,"binary":false,"changes":27,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n-# Copyright (c) 2020, Oracle and\/or its affiliates. All rights reserved.\n+# Copyright (c) 2020, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -34,1 +34,1 @@\n- * Copyright (c) 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -85,1 +85,0 @@\n-import jdk.test.lib.process.ProcessTools;\n@@ -117,5 +116,8 @@\n-        ProcessBuilder pb = ProcessTools.createTestJvm(\n-            \"-XX:DumpLoadedClassList=\" + classList,\n-            \"-cp\", jars,\n-            mainClass, testPackageName + \".\" + testClassName);\n-        OutputAnalyzer output = TestCommon.executeAndLog(pb, \"dumpClassList\");\n+        CDSOptions dumpOpts = (new CDSOptions())\n+            .setUseVersion(false)\n+            .setXShareMode(\"auto\")\n+            .addSuffix(\"-XX:DumpLoadedClassList=\" + classList,\n+                       \"-cp\", jars,\n+                       mainClass, testPackageName + \".\" + testClassName);\n+        CDSTestUtils.run(dumpOpts)\n+                    .assertNormalExit();\n@@ -137,1 +139,1 @@\n-        output = CDSTestUtils.runWithArchive(runOpts);\n+        OutputAnalyzer output = CDSTestUtils.runWithArchive(runOpts);\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/methodHandles\/CDSMHTest_generate.sh","additions":11,"deletions":9,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -53,1 +53,0 @@\n-import jdk.test.lib.process.ProcessTools;\n@@ -85,5 +84,8 @@\n-        ProcessBuilder pb = ProcessTools.createTestJvm(\n-            \"-XX:DumpLoadedClassList=\" + classList,\n-            \"-cp\", jars,\n-            mainClass, testPackageName + \".\" + testClassName);\n-        OutputAnalyzer output = TestCommon.executeAndLog(pb, \"dumpClassList\");\n+        CDSOptions dumpOpts = (new CDSOptions())\n+            .setUseVersion(false)\n+            .setXShareMode(\"auto\")\n+            .addSuffix(\"-XX:DumpLoadedClassList=\" + classList,\n+                       \"-cp\", jars,\n+                       mainClass, testPackageName + \".\" + testClassName);\n+        CDSTestUtils.run(dumpOpts)\n+                    .assertNormalExit();\n@@ -105,1 +107,1 @@\n-        output = CDSTestUtils.runWithArchive(runOpts);\n+        OutputAnalyzer output = CDSTestUtils.runWithArchive(runOpts);\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/methodHandles\/MethodHandlesAsCollectorTest.java","additions":10,"deletions":8,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -53,1 +53,0 @@\n-import jdk.test.lib.process.ProcessTools;\n@@ -85,5 +84,8 @@\n-        ProcessBuilder pb = ProcessTools.createTestJvm(\n-            \"-XX:DumpLoadedClassList=\" + classList,\n-            \"-cp\", jars,\n-            mainClass, testPackageName + \".\" + testClassName);\n-        OutputAnalyzer output = TestCommon.executeAndLog(pb, \"dumpClassList\");\n+        CDSOptions dumpOpts = (new CDSOptions())\n+            .setUseVersion(false)\n+            .setXShareMode(\"auto\")\n+            .addSuffix(\"-XX:DumpLoadedClassList=\" + classList,\n+                       \"-cp\", jars,\n+                       mainClass, testPackageName + \".\" + testClassName);\n+        CDSTestUtils.run(dumpOpts)\n+                    .assertNormalExit();\n@@ -105,1 +107,1 @@\n-        output = CDSTestUtils.runWithArchive(runOpts);\n+        OutputAnalyzer output = CDSTestUtils.runWithArchive(runOpts);\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/methodHandles\/MethodHandlesCastFailureTest.java","additions":10,"deletions":8,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -53,1 +53,0 @@\n-import jdk.test.lib.process.ProcessTools;\n@@ -85,5 +84,8 @@\n-        ProcessBuilder pb = ProcessTools.createTestJvm(\n-            \"-XX:DumpLoadedClassList=\" + classList,\n-            \"-cp\", jars,\n-            mainClass, testPackageName + \".\" + testClassName);\n-        OutputAnalyzer output = TestCommon.executeAndLog(pb, \"dumpClassList\");\n+        CDSOptions dumpOpts = (new CDSOptions())\n+            .setUseVersion(false)\n+            .setXShareMode(\"auto\")\n+            .addSuffix(\"-XX:DumpLoadedClassList=\" + classList,\n+                       \"-cp\", jars,\n+                       mainClass, testPackageName + \".\" + testClassName);\n+        CDSTestUtils.run(dumpOpts)\n+                    .assertNormalExit();\n@@ -105,1 +107,1 @@\n-        output = CDSTestUtils.runWithArchive(runOpts);\n+        OutputAnalyzer output = CDSTestUtils.runWithArchive(runOpts);\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/methodHandles\/MethodHandlesGeneralTest.java","additions":10,"deletions":8,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -53,1 +53,0 @@\n-import jdk.test.lib.process.ProcessTools;\n@@ -85,5 +84,8 @@\n-        ProcessBuilder pb = ProcessTools.createTestJvm(\n-            \"-XX:DumpLoadedClassList=\" + classList,\n-            \"-cp\", jars,\n-            mainClass, testPackageName + \".\" + testClassName);\n-        OutputAnalyzer output = TestCommon.executeAndLog(pb, \"dumpClassList\");\n+        CDSOptions dumpOpts = (new CDSOptions())\n+            .setUseVersion(false)\n+            .setXShareMode(\"auto\")\n+            .addSuffix(\"-XX:DumpLoadedClassList=\" + classList,\n+                       \"-cp\", jars,\n+                       mainClass, testPackageName + \".\" + testClassName);\n+        CDSTestUtils.run(dumpOpts)\n+                    .assertNormalExit();\n@@ -105,1 +107,1 @@\n-        output = CDSTestUtils.runWithArchive(runOpts);\n+        OutputAnalyzer output = CDSTestUtils.runWithArchive(runOpts);\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/methodHandles\/MethodHandlesInvokersTest.java","additions":10,"deletions":8,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -53,1 +53,0 @@\n-import jdk.test.lib.process.ProcessTools;\n@@ -85,5 +84,8 @@\n-        ProcessBuilder pb = ProcessTools.createTestJvm(\n-            \"-XX:DumpLoadedClassList=\" + classList,\n-            \"-cp\", jars,\n-            mainClass, testPackageName + \".\" + testClassName);\n-        OutputAnalyzer output = TestCommon.executeAndLog(pb, \"dumpClassList\");\n+        CDSOptions dumpOpts = (new CDSOptions())\n+            .setUseVersion(false)\n+            .setXShareMode(\"auto\")\n+            .addSuffix(\"-XX:DumpLoadedClassList=\" + classList,\n+                       \"-cp\", jars,\n+                       mainClass, testPackageName + \".\" + testClassName);\n+        CDSTestUtils.run(dumpOpts)\n+                    .assertNormalExit();\n@@ -105,1 +107,1 @@\n-        output = CDSTestUtils.runWithArchive(runOpts);\n+        OutputAnalyzer output = CDSTestUtils.runWithArchive(runOpts);\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/methodHandles\/MethodHandlesPermuteArgumentsTest.java","additions":10,"deletions":8,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -53,1 +53,0 @@\n-import jdk.test.lib.process.ProcessTools;\n@@ -85,5 +84,8 @@\n-        ProcessBuilder pb = ProcessTools.createTestJvm(\n-            \"-XX:DumpLoadedClassList=\" + classList,\n-            \"-cp\", jars,\n-            mainClass, testPackageName + \".\" + testClassName);\n-        OutputAnalyzer output = TestCommon.executeAndLog(pb, \"dumpClassList\");\n+        CDSOptions dumpOpts = (new CDSOptions())\n+            .setUseVersion(false)\n+            .setXShareMode(\"auto\")\n+            .addSuffix(\"-XX:DumpLoadedClassList=\" + classList,\n+                       \"-cp\", jars,\n+                       mainClass, testPackageName + \".\" + testClassName);\n+        CDSTestUtils.run(dumpOpts)\n+                    .assertNormalExit();\n@@ -105,1 +107,1 @@\n-        output = CDSTestUtils.runWithArchive(runOpts);\n+        OutputAnalyzer output = CDSTestUtils.runWithArchive(runOpts);\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/methodHandles\/MethodHandlesSpreadArgumentsTest.java","additions":10,"deletions":8,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -33,0 +33,2 @@\n+import jdk.test.lib.cds.CDSOptions;\n+import jdk.test.lib.cds.CDSTestUtils;\n@@ -34,1 +36,0 @@\n-import jdk.test.lib.process.ProcessTools;\n@@ -53,2 +54,2 @@\n-        ProcessBuilder dumpPb = ProcessTools.createTestJvm(\n-          TestCommon.concat(vmOptionsPrefix,\n+        CDSOptions opts = (new CDSOptions())\n+            .addPrefix(vmOptionsPrefix,\n@@ -57,7 +58,4 @@\n-            \"-XX:SharedArchiveFile=.\/SharedStringsBasic.jsa\",\n-            \"-Xshare:dump\",\n-            \"-Xlog:cds,cds+hashtables\"));\n-\n-        TestCommon.executeAndLog(dumpPb, \"dump\")\n-            .shouldContain(\"Shared string table stats\")\n-            .shouldHaveExitValue(0);\n+            \"-Xlog:cds,cds+hashtables\")\n+            .setArchiveName(\".\/SharedStringsBasic.jsa\");\n+        OutputAnalyzer output = CDSTestUtils.createArchiveAndCheck(opts);\n+        output.shouldContain(\"Shared string table stats\");\n@@ -65,2 +63,4 @@\n-        ProcessBuilder runPb = ProcessTools.createTestJvm(\n-          TestCommon.concat(vmOptionsPrefix,\n+        opts = (new CDSOptions())\n+            .setUseVersion(false)\n+            .setXShareMode(\"auto\")\n+            .addSuffix(vmOptionsPrefix,\n@@ -69,1 +69,0 @@\n-            \"-Xshare:auto\",\n@@ -71,3 +70,3 @@\n-            \"HelloString\"));\n-\n-        TestCommon.executeAndLog(runPb, \"run\").shouldHaveExitValue(0);\n+            \"HelloString\");\n+        CDSTestUtils.run(opts)\n+                    .assertNormalExit();\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/sharedStrings\/SharedStringsBasic.java","additions":16,"deletions":17,"binary":false,"changes":33,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -34,0 +34,2 @@\n+import jdk.test.lib.cds.CDSOptions;\n+import jdk.test.lib.cds.CDSTestUtils;\n@@ -35,1 +37,0 @@\n-import jdk.test.lib.process.ProcessTools;\n@@ -46,8 +47,0 @@\n-        ProcessBuilder dumpPb = ProcessTools.createTestJvm(\n-          TestCommon.concat(vmOptionsPrefix,\n-            \"-XX:+UseG1GC\", \"-XX:MaxRAMPercentage=12.5\",\n-            \"-cp\", \".\",\n-            \"-XX:SharedBaseAddress=0\", \"-XX:SharedArchiveFile=.\/SysDictCrash.jsa\",\n-            \"-Xshare:dump\",\n-            \"-showversion\", \"-Xlog:cds,cds+hashtables\"));\n-\n@@ -55,1 +48,9 @@\n-        OutputAnalyzer output = TestCommon.executeAndLog(dumpPb, \"dump\");\n+\n+        CDSOptions opts = (new CDSOptions())\n+            .addPrefix(vmOptionsPrefix,\n+                       \"-XX:+UseG1GC\", \"-XX:MaxRAMPercentage=12.5\",\n+                       \"-cp\", \".\",\n+                       \"-XX:SharedBaseAddress=0\",\n+                       \"-showversion\", \"-Xlog:cds,cds+hashtables\")\n+            .setArchiveName(\".\/SysDictCrash.jsa\");\n+        OutputAnalyzer output = CDSTestUtils.createArchive(opts);\n@@ -71,8 +72,10 @@\n-        ProcessBuilder runPb = ProcessTools.createTestJvm(\n-          TestCommon.concat(vmOptionsPrefix,\n-            \"-XX:+UseG1GC\", \"-XX:MaxRAMPercentage=12.5\",\n-            \"-XX:SharedArchiveFile=.\/SysDictCrash.jsa\",\n-            \"-Xshare:on\",\n-            \"-version\"));\n-\n-        TestCommon.checkExec(TestCommon.executeAndLog(runPb, \"exec\"));\n+        opts = (new CDSOptions())\n+            .setArchiveName(\".\/SysDictCrash.jsa\") \/\/ prevents the assignment of a default archive name\n+            .setUseVersion(false) \/\/ the -version must be the last arg for this test to work\n+            .addSuffix(vmOptionsPrefix,\n+                       \"-Xlog:cds\",\n+                       \"-XX:+UseG1GC\", \"-XX:MaxRAMPercentage=12.5\",\n+                       \"-XX:SharedArchiveFile=.\/SysDictCrash.jsa\",\n+                       \"-version\");\n+        CDSTestUtils.run(opts)\n+                    .assertNormalExit();\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/sharedStrings\/SysDictCrash.java","additions":22,"deletions":19,"binary":false,"changes":41,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2017, 2018, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2017, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -53,0 +53,5 @@\n+    public CDSOptions addPrefix(String prefix[], String... extra) {\n+        for (String s : prefix) this.prefix.add(s);\n+        for (String s : extra) this.prefix.add(s);\n+        return this;\n+    }\n@@ -59,0 +64,6 @@\n+    public CDSOptions addSuffix(String suffix[], String... extra) {\n+        for (String s : suffix) this.suffix.add(s);\n+        for (String s : extra) this.suffix.add(s);\n+        return this;\n+    }\n+\n","filename":"test\/lib\/jdk\/test\/lib\/cds\/CDSOptions.java","additions":12,"deletions":1,"binary":false,"changes":13,"status":"modified"}]}