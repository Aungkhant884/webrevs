{"files":[{"patch":"@@ -402,0 +402,8 @@\n+static inline bool target_needs_trampoline(Address entry) {\n+  \/\/ Java method call target can have different compiled versions of a method: C2 or C1.\n+  \/\/ If CodeCache size > 128M, such calls must have reserved trampolines for the case:\n+  \/\/ C2 compiled method calls C1 compiled method.\n+  return  (entry.rspec().type() == relocInfo::runtime_call_type) ? target_needs_far_branch(entry.target())\n+                                                                 : MacroAssembler::far_branches();\n+}\n+\n@@ -571,0 +579,2 @@\n+  bool need_trampoline = target_needs_trampoline(entry);\n+\n@@ -572,1 +582,1 @@\n-  if (far_branches()) {\n+  if (need_trampoline) {\n@@ -593,1 +603,1 @@\n-  if (!far_branches()) {\n+  if (!need_trampoline) {\n","filename":"src\/hotspot\/cpu\/aarch64\/macroAssembler_aarch64.cpp","additions":12,"deletions":2,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -0,0 +1,108 @@\n+\/*\n+ * Copyright Amazon.com Inc. or its affiliates. All Rights Reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\n+ *\/\n+\n+package compiler.c2.aarch64;\n+\n+import java.util.ArrayList;\n+import java.util.Iterator;\n+import jdk.test.lib.process.OutputAnalyzer;\n+import jdk.test.lib.process.ProcessTools;\n+\n+\/**\n+ * @test TestTrampoline\n+ * @summary Checks that trampolines to runtime code are not generated if they are not needed.\n+ * @bug 8285487\n+ * @library \/test\/lib\n+ *\n+ * @requires vm.flagless\n+ * @requires os.arch==\"aarch64\"\n+ * @requires vm.debug == false\n+ * @requires vm.compiler2.enabled\n+ *\n+ * @run driver compiler.c2.aarch64.TestTrampoline\n+ *\/\n+\n+public class TestTrampoline {\n+    private final static int ITERATIONS_TO_HEAT_LOOP = 20_000;\n+\n+    public static void main(String[] args) throws Exception {\n+        String testClassName = TestTrampoline.Test.class.getName();\n+        ArrayList<String> command = new ArrayList<String>();\n+        command.add(\"-XX:+UnlockDiagnosticVMOptions\");\n+        command.add(\"-Xbatch\");\n+        command.add(\"-XX:CompileCommand=print,\" + testClassName + \"::\" + \"test\");\n+        \/\/ As the non-nmethod segment is put between other two segments,\n+        \/\/ ReservedCodeCacheSize=240M guarantees no trampolines for runtime calls to the non-nmethod segment.\n+        command.add(\"-XX:ReservedCodeCacheSize=240M\");\n+        command.add(testClassName);\n+\n+        ProcessBuilder pb = ProcessTools.createJavaProcessBuilder(command);\n+\n+        OutputAnalyzer analyzer = new OutputAnalyzer(pb.start());\n+\n+        analyzer.shouldHaveExitValue(0);\n+\n+        System.out.println(analyzer.getOutput());\n+\n+        checkOutput(analyzer);\n+    }\n+\n+    private static String skipTo(Iterator<String> iter, String substring) {\n+        while (iter.hasNext()) {\n+            String nextLine = iter.next();\n+            if (nextLine.contains(substring)) {\n+                return nextLine;\n+            }\n+        }\n+        return null;\n+    }\n+\n+    private static void checkOutput(OutputAnalyzer output) {\n+        Iterator<String> iter = output.asLines().listIterator();\n+\n+        String match = skipTo(iter, \"Compiled method (c2)\");\n+        if (match == null || !match.contains(\"Test::test\")) {\n+            throw new RuntimeException(\"Missing compiler output for the method 'test'\");\n+        }\n+\n+        match = skipTo(iter, \"[Stub Code]\");\n+        if (match != null && skipTo(iter, \"{trampoline_stub}\") != null) {\n+            throw new RuntimeException(\"Found unexpected {trampoline_stub}\");\n+        }\n+    }\n+\n+    static class Test {\n+        private static void test(String s, int i) {\n+            if (s.charAt(i) > 128)\n+                throw new RuntimeException();\n+        }\n+\n+        public static void main(String[] args) {\n+            String s = \"Returns the char value at the specified index.\";\n+            for (int i = 0; i < ITERATIONS_TO_HEAT_LOOP; ++i) {\n+                test(s, i % s.length());\n+            }\n+        }\n+    }\n+}\n","filename":"test\/hotspot\/jtreg\/compiler\/c2\/aarch64\/TestTrampoline.java","additions":108,"deletions":0,"binary":false,"changes":108,"status":"added"}]}