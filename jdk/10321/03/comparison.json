{"files":[{"patch":"@@ -230,0 +230,1 @@\n+JVM_VirtualThreadHideFrames\n","filename":"make\/data\/hotspot-symbols\/symbols-unix","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -1162,0 +1162,3 @@\n+JNIEXPORT void JNICALL\n+JVM_VirtualThreadHideFrames(JNIEnv* env, jobject vthread, jboolean hide);\n+\n","filename":"src\/hotspot\/share\/include\/jvm.h","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -3950,0 +3950,2 @@\n+  assert(!thread->is_in_tmp_VTMS_transition(), \"sanity check\");\n+  assert(!thread->is_in_VTMS_transition(), \"sanity check\");\n@@ -3974,0 +3976,1 @@\n+  assert(!thread->is_in_tmp_VTMS_transition(), \"sanity check\");\n@@ -4022,1 +4025,1 @@\n-\n+  assert(!thread->is_in_tmp_VTMS_transition(), \"sanity check\");\n@@ -4045,0 +4048,1 @@\n+  assert(!thread->is_in_tmp_VTMS_transition(), \"sanity check\");\n@@ -4051,0 +4055,14 @@\n+JVM_ENTRY(void, JVM_VirtualThreadHideFrames(JNIEnv* env, jobject vthread, jboolean hide))\n+#if INCLUDE_JVMTI\n+  if (!DoJVMTIVirtualThreadTransitions) {\n+    assert(!JvmtiExport::can_support_virtual_threads(), \"sanity check\");\n+    return;\n+  }\n+  assert(!thread->is_in_VTMS_transition(), \"sanity check\");\n+  assert(thread->is_in_tmp_VTMS_transition() != (bool)hide, \"sanity check\");\n+  thread->toggle_is_in_tmp_VTMS_transition();\n+#else\n+  fatal(\"Should only be called with JVMTI enabled\");\n+#endif\n+JVM_END\n+\n","filename":"src\/hotspot\/share\/prims\/jvm.cpp","additions":19,"deletions":1,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -706,4 +706,8 @@\n-  javaVFrame *jvf = JvmtiEnvBase::is_cthread_with_continuation(jt) ?\n-                        jt->carrier_last_java_vframe(reg_map_p) :\n-                        jt->last_java_vframe(reg_map_p);\n-  jvf = check_and_skip_hidden_frames(jt, jvf);\n+  bool cthread_with_cont = JvmtiEnvBase::is_cthread_with_continuation(jt);\n+  javaVFrame *jvf = cthread_with_cont ? jt->carrier_last_java_vframe(reg_map_p)\n+                                      : jt->last_java_vframe(reg_map_p);\n+  \/\/ Skip hidden frames only for carrier threads\n+  \/\/ which are in non-temporary VTMS transition.\n+  if (jt->is_in_VTMS_transition()) {\n+    jvf = check_and_skip_hidden_frames(jt, jvf);\n+  }\n","filename":"src\/hotspot\/share\/prims\/jvmtiEnvBase.cpp","additions":8,"deletions":4,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -896,1 +896,1 @@\n-    assert(!_thread->is_in_VTMS_transition(), \"CFLH events are not allowed in VTMS transition\");\n+    assert(!_thread->is_in_any_VTMS_transition(), \"CFLH events are not allowed in any VTMS transition\");\n@@ -1053,0 +1053,3 @@\n+  if (JavaThread::current()->is_in_tmp_VTMS_transition()) {\n+    return false; \/\/ skip CFLH events in tmp VTMS transition\n+  }\n@@ -1187,2 +1190,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (thread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -1343,1 +1346,4 @@\n-  assert(!thread->is_in_VTMS_transition(), \"class load events are not allowed in VTMS transition\");\n+  if (thread->is_in_tmp_VTMS_transition()) {\n+    return; \/\/ skip ClassLoad events in tmp VTMS transition\n+  }\n+  assert(!thread->is_in_any_VTMS_transition(), \"class load events are not allowed in any VTMS transition\");\n@@ -1378,1 +1384,4 @@\n-  assert(!thread->is_in_VTMS_transition(), \"class prepare events are not allowed in VTMS transition\");\n+  if (thread->is_in_tmp_VTMS_transition()) {\n+    return; \/\/ skip ClassPrepare events in tmp VTMS transition\n+  }\n+  assert(!thread->is_in_any_VTMS_transition(), \"class prepare events are not allowed in any VTMS transition\");\n@@ -1697,2 +1706,2 @@\n-  if (javaThread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (javaThread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -1721,2 +1730,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (thread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -1764,2 +1773,2 @@\n-  if (mh->jvmti_mount_transition() || thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (mh->jvmti_mount_transition() || thread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -1848,2 +1857,2 @@\n-  if (mh->jvmti_mount_transition() || thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (mh->jvmti_mount_transition() || thread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -1924,2 +1933,2 @@\n-  if (mh->jvmti_mount_transition() || thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (mh->jvmti_mount_transition() || thread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -1961,2 +1970,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (thread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -2083,2 +2092,2 @@\n-      if (mh->jvmti_mount_transition() || thread->is_in_VTMS_transition()) {\n-        return; \/\/ no events should be posted if thread is in a VTMS transition\n+      if (mh->jvmti_mount_transition() || thread->is_in_any_VTMS_transition()) {\n+        return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -2129,2 +2138,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (thread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -2165,2 +2174,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (thread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -2215,2 +2224,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (thread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -2246,2 +2255,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (thread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -2321,2 +2330,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (thread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -2360,2 +2369,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (thread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -2434,1 +2443,1 @@\n-  assert(!thread->is_in_VTMS_transition(), \"compiled method load events are not allowed in VTMS transition\");\n+  assert(!thread->is_in_any_VTMS_transition(), \"compiled method load events are not allowed in any VTMS transition\");\n@@ -2457,1 +2466,1 @@\n-  assert(!thread->is_in_VTMS_transition(), \"compiled method load events are not allowed in VTMS transition\");\n+  assert(!thread->is_in_any_VTMS_transition(), \"compiled method load events are not allowed in any VTMS transition\");\n@@ -2482,1 +2491,1 @@\n-  assert(!thread->is_in_VTMS_transition(), \"dynamic code generated events are not allowed in VTMS transition\");\n+  assert(!thread->is_in_any_VTMS_transition(), \"dynamic code generated events are not allowed in any VTMS transition\");\n@@ -2530,1 +2539,1 @@\n-  assert(!thread->is_in_VTMS_transition(), \"dynamic code generated events are not allowed in VTMS transition\");\n+  assert(!thread->is_in_any_VTMS_transition(), \"dynamic code generated events are not allowed in any VTMS transition\");\n@@ -2554,1 +2563,1 @@\n-  assert(!thread->is_in_VTMS_transition(), \"dynamic code generated events are not allowed in VTMS transition\");\n+  assert(!thread->is_in_any_VTMS_transition(), \"dynamic code generated events are not allowed in any VTMS transition\");\n@@ -2684,2 +2693,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (thread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -2717,2 +2726,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (thread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -2751,2 +2760,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (thread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -2785,2 +2794,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (thread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -2817,2 +2826,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (thread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -2851,2 +2860,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (thread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n","filename":"src\/hotspot\/share\/prims\/jvmtiExport.cpp","additions":57,"deletions":48,"binary":false,"changes":105,"status":"modified"},{"patch":"@@ -272,0 +272,1 @@\n+    assert(!thread->is_in_tmp_VTMS_transition(), \"sanity check\");\n","filename":"src\/hotspot\/share\/prims\/jvmtiThreadState.cpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -424,0 +424,1 @@\n+  _is_in_tmp_VTMS_transition(false),\n","filename":"src\/hotspot\/share\/runtime\/javaThread.cpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -313,0 +313,1 @@\n+  bool                  _is_in_tmp_VTMS_transition;      \/\/ thread is in temporary virtual thread mount state transition\n@@ -646,0 +647,3 @@\n+  bool is_in_tmp_VTMS_transition() const         { return _is_in_tmp_VTMS_transition; }\n+  bool is_in_any_VTMS_transition() const         { return _is_in_VTMS_transition || _is_in_tmp_VTMS_transition; }\n+\n@@ -647,0 +651,2 @@\n+  void toggle_is_in_tmp_VTMS_transition()        { _is_in_tmp_VTMS_transition = !_is_in_tmp_VTMS_transition; };\n+\n","filename":"src\/hotspot\/share\/runtime\/javaThread.hpp","additions":6,"deletions":0,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -357,0 +357,33 @@\n+    \/**\n+     * Sets the current thread to the current carrier thread.\n+     * @return true if JVMTI was notified\n+     *\/\n+    @ChangesCurrentThread\n+    @JvmtiMountTransition\n+    private boolean switchToCarrierThread() {\n+        boolean notifyJvmti = notifyJvmtiEvents;\n+        if (notifyJvmti) {\n+            notifyJvmtiHideFrames(true);\n+        }\n+        Thread carrier = this.carrierThread;\n+        assert Thread.currentThread() == this\n+                && carrier == Thread.currentCarrierThread();\n+        carrier.setCurrentThread(carrier);\n+        return notifyJvmti;\n+    }\n+\n+    \/**\n+     * Sets the current thread to the given virtual thread.\n+     * If {@code notifyJvmti} is true then JVMTI is notified.\n+     *\/\n+    @ChangesCurrentThread\n+    @JvmtiMountTransition\n+    private void switchToVirtualThread(VirtualThread vthread, boolean notifyJvmti) {\n+        Thread carrier = vthread.carrierThread;\n+        assert carrier == Thread.currentCarrierThread();\n+        carrier.setCurrentThread(vthread);\n+        if (notifyJvmti) {\n+            notifyJvmtiHideFrames(false);\n+        }\n+    }\n+\n@@ -529,1 +562,1 @@\n-            Future<?> unparker = scheduleUnpark(nanos);\n+            Future<?> unparker = scheduleUnpark(this::unpark, nanos);\n@@ -582,1 +615,1 @@\n-     * Schedules this thread to be unparked after the given delay.\n+     * Schedule an unpark task to run after a given delay.\n@@ -585,4 +618,3 @@\n-    private Future<?> scheduleUnpark(long nanos) {\n-        Thread carrier = this.carrierThread;\n-        \/\/ need to switch to current platform thread to avoid nested parking\n-        carrier.setCurrentThread(carrier);\n+    private Future<?> scheduleUnpark(Runnable unparker, long nanos) {\n+        \/\/ need to switch to current carrier thread to avoid nested parking\n+        boolean notifyJvmti = switchToCarrierThread();\n@@ -590,1 +622,1 @@\n-            return UNPARKER.schedule(() -> unpark(), nanos, NANOSECONDS);\n+            return UNPARKER.schedule(unparker, nanos, NANOSECONDS);\n@@ -592,1 +624,1 @@\n-            carrier.setCurrentThread(this);\n+            switchToVirtualThread(this, notifyJvmti);\n@@ -602,3 +634,2 @@\n-            Thread carrier = this.carrierThread;\n-            \/\/ need to switch to current platform thread to avoid nested parking\n-            carrier.setCurrentThread(carrier);\n+            \/\/ need to switch to current carrier thread to avoid nested parking\n+            boolean notifyJvmti = switchToCarrierThread();\n@@ -608,1 +639,1 @@\n-                carrier.setCurrentThread(this);\n+                switchToVirtualThread(this, notifyJvmti);\n@@ -628,2 +659,1 @@\n-                    Thread carrier = vthread.carrierThread;\n-                    carrier.setCurrentThread(carrier);\n+                    boolean notifyJvmti = vthread.switchToCarrierThread();\n@@ -633,1 +663,1 @@\n-                        carrier.setCurrentThread(vthread);\n+                        switchToVirtualThread(vthread, notifyJvmti);\n@@ -1008,0 +1038,3 @@\n+    @JvmtiMountTransition\n+    private native void notifyJvmtiHideFrames(boolean hide);\n+\n","filename":"src\/java.base\/share\/classes\/java\/lang\/VirtualThread.java","additions":48,"deletions":15,"binary":false,"changes":63,"status":"modified"},{"patch":"@@ -39,0 +39,1 @@\n+    { \"notifyJvmtiHideFrames\",   \"(Z)V\", (void *)&JVM_VirtualThreadHideFrames },\n","filename":"src\/java.base\/share\/native\/libjava\/VirtualThread.c","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"}]}