{"files":[{"patch":"@@ -3950,0 +3950,1 @@\n+  assert(!thread->is_in_tmp_VTMS_transition(), \"sanity check\");\n@@ -3975,0 +3976,1 @@\n+  assert(!thread->is_in_tmp_VTMS_transition(), \"sanity check\");\n@@ -4023,0 +4025,1 @@\n+  assert(!thread->is_in_tmp_VTMS_transition(), \"sanity check\");\n@@ -4045,0 +4048,1 @@\n+  assert(!thread->is_in_tmp_VTMS_transition(), \"sanity check\");\n@@ -4057,0 +4061,1 @@\n+  assert(!thread->is_in_VTMS_transition(), \"sanity check\");\n","filename":"src\/hotspot\/share\/prims\/jvm.cpp","additions":5,"deletions":0,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -706,6 +706,6 @@\n-  javaVFrame *jvf = JvmtiEnvBase::is_cthread_with_continuation(jt) ?\n-                        jt->carrier_last_java_vframe(reg_map_p) :\n-                        jt->last_java_vframe(reg_map_p);\n-  \/\/ Skipping hidden frames when jt->is_in_tmp_VTMS_transition()==true results\n-  \/\/ in returning jvf==NULL, and so, empty stack traces for carrier threads.\n-  if (!jt->is_in_tmp_VTMS_transition()) {\n+  bool cthread_with_cont = JvmtiEnvBase::is_cthread_with_continuation(jt);\n+  javaVFrame *jvf = cthread_with_cont ? jt->carrier_last_java_vframe(reg_map_p)\n+                                      : jt->last_java_vframe(reg_map_p);\n+  \/\/ Skip hidden frames only for carrier threads\n+  \/\/ which are in non-temporary VTMS transition.\n+  if (jt->is_in_VTMS_transition()) {\n@@ -1600,1 +1600,1 @@\n-  assert(!java_thread->is_in_non_tmp_VTMS_transition(), \"sanity check\");\n+  assert(!java_thread->is_in_VTMS_transition(), \"sanity check\");\n@@ -1667,1 +1667,1 @@\n-  assert(!java_thread->is_in_non_tmp_VTMS_transition(), \"sanity check\");\n+  assert(!java_thread->is_in_VTMS_transition(), \"sanity check\");\n","filename":"src\/hotspot\/share\/prims\/jvmtiEnvBase.cpp","additions":8,"deletions":8,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -896,1 +896,1 @@\n-    assert(!_thread->is_in_VTMS_transition(), \"CFLH events are not allowed in VTMS transition\");\n+    assert(!_thread->is_in_any_VTMS_transition(), \"CFLH events are not allowed in any VTMS transition\");\n@@ -1054,1 +1054,1 @@\n-    return false;\n+    return false; \/\/ skip CFLH events in tmp VTMS transition\n@@ -1190,2 +1190,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (thread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -1347,1 +1347,1 @@\n-    return;\n+    return; \/\/ skip ClassLoad events in tmp VTMS transition\n@@ -1349,1 +1349,1 @@\n-  assert(!thread->is_in_VTMS_transition(), \"class load events are not allowed in VTMS transition\");\n+  assert(!thread->is_in_any_VTMS_transition(), \"class load events are not allowed in any VTMS transition\");\n@@ -1385,1 +1385,1 @@\n-    return;\n+    return; \/\/ skip ClassPrepare events in tmp VTMS transition\n@@ -1387,1 +1387,1 @@\n-  assert(!thread->is_in_VTMS_transition(), \"class prepare events are not allowed in VTMS transition\");\n+  assert(!thread->is_in_any_VTMS_transition(), \"class prepare events are not allowed in any VTMS transition\");\n@@ -1706,2 +1706,2 @@\n-  if (javaThread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (javaThread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -1730,2 +1730,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (thread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -1773,2 +1773,2 @@\n-  if (mh->jvmti_mount_transition() || thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (mh->jvmti_mount_transition() || thread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -1857,2 +1857,2 @@\n-  if (mh->jvmti_mount_transition() || thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (mh->jvmti_mount_transition() || thread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -1933,2 +1933,2 @@\n-  if (mh->jvmti_mount_transition() || thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (mh->jvmti_mount_transition() || thread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -1970,2 +1970,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (thread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -2092,2 +2092,2 @@\n-      if (mh->jvmti_mount_transition() || thread->is_in_VTMS_transition()) {\n-        return; \/\/ no events should be posted if thread is in a VTMS transition\n+      if (mh->jvmti_mount_transition() || thread->is_in_any_VTMS_transition()) {\n+        return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -2138,2 +2138,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (thread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -2174,2 +2174,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (thread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -2224,2 +2224,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (thread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -2255,2 +2255,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (thread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -2330,2 +2330,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (thread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -2369,2 +2369,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (thread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -2443,1 +2443,1 @@\n-  assert(!thread->is_in_VTMS_transition(), \"compiled method load events are not allowed in VTMS transition\");\n+  assert(!thread->is_in_any_VTMS_transition(), \"compiled method load events are not allowed in any VTMS transition\");\n@@ -2466,1 +2466,1 @@\n-  assert(!thread->is_in_VTMS_transition(), \"compiled method load events are not allowed in VTMS transition\");\n+  assert(!thread->is_in_any_VTMS_transition(), \"compiled method load events are not allowed in any VTMS transition\");\n@@ -2491,1 +2491,1 @@\n-  assert(!thread->is_in_VTMS_transition(), \"dynamic code generated events are not allowed in VTMS transition\");\n+  assert(!thread->is_in_any_VTMS_transition(), \"dynamic code generated events are not allowed in any VTMS transition\");\n@@ -2539,1 +2539,1 @@\n-  assert(!thread->is_in_VTMS_transition(), \"dynamic code generated events are not allowed in VTMS transition\");\n+  assert(!thread->is_in_any_VTMS_transition(), \"dynamic code generated events are not allowed in any VTMS transition\");\n@@ -2563,1 +2563,1 @@\n-  assert(!thread->is_in_VTMS_transition(), \"dynamic code generated events are not allowed in VTMS transition\");\n+  assert(!thread->is_in_any_VTMS_transition(), \"dynamic code generated events are not allowed in any VTMS transition\");\n@@ -2693,2 +2693,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (thread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -2726,2 +2726,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (thread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -2760,2 +2760,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (thread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -2794,2 +2794,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (thread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -2826,2 +2826,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (thread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n@@ -2860,2 +2860,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in a VTMS transition\n+  if (thread->is_in_any_VTMS_transition()) {\n+    return; \/\/ no events should be posted if thread is in any VTMS transition\n","filename":"src\/hotspot\/share\/prims\/jvmtiExport.cpp","additions":51,"deletions":51,"binary":false,"changes":102,"status":"modified"},{"patch":"@@ -272,0 +272,1 @@\n+    assert(!thread->is_in_tmp_VTMS_transition(), \"sanity check\");\n","filename":"src\/hotspot\/share\/prims\/jvmtiThreadState.cpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -757,1 +757,1 @@\n-  JVMTI_ONLY(assert(!_handshakee->is_in_non_tmp_VTMS_transition(), \"no suspend allowed in VTMS transition\");)\n+  JVMTI_ONLY(assert(!_handshakee->is_in_VTMS_transition(), \"no suspend allowed in VTMS transition\");)\n","filename":"src\/hotspot\/share\/runtime\/handshake.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -1174,1 +1174,1 @@\n-  assert(!is_in_non_tmp_VTMS_transition(), \"no suspend allowed in VTMS transition\");\n+  assert(!is_in_VTMS_transition(), \"no suspend allowed in VTMS transition\");\n","filename":"src\/hotspot\/share\/runtime\/javaThread.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -646,3 +646,1 @@\n-  bool is_in_non_tmp_VTMS_transition() const     { return _is_in_VTMS_transition; }\n-  bool is_in_VTMS_transition() const             { return _is_in_VTMS_transition || _is_in_tmp_VTMS_transition; }\n-  void set_is_in_VTMS_transition(bool val);\n+  bool is_in_VTMS_transition() const             { return _is_in_VTMS_transition; }\n@@ -650,0 +648,3 @@\n+  bool is_in_any_VTMS_transition() const         { return _is_in_VTMS_transition || _is_in_tmp_VTMS_transition; }\n+\n+  void set_is_in_VTMS_transition(bool val);\n@@ -651,0 +652,1 @@\n+\n","filename":"src\/hotspot\/share\/runtime\/javaThread.hpp","additions":5,"deletions":3,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -359,0 +359,1 @@\n+     * @return true if JVMTI was notified\n@@ -361,1 +362,6 @@\n-    private void switchToCarrierThread() {\n+    @JvmtiMountTransition\n+    private boolean switchToCarrierThread() {\n+        boolean notifyJvmti = notifyJvmtiEvents;\n+        if (notifyJvmti) {\n+            notifyJvmtiHideFrames(true);\n+        }\n@@ -365,3 +371,0 @@\n-        if (notifyJvmtiEvents) {\n-            notifyJvmtiHideFrames(true);\n-        }\n@@ -369,0 +372,1 @@\n+        return notifyJvmti;\n@@ -373,0 +377,1 @@\n+     * If {@code notifyJvmti} is true then JVMTI is notified.\n@@ -375,1 +380,2 @@\n-    private void switchToVirtualThread(VirtualThread vthread) {\n+    @JvmtiMountTransition\n+    private void switchToVirtualThread(VirtualThread vthread, boolean notifyJvmti) {\n@@ -379,1 +385,1 @@\n-        if (notifyJvmtiEvents) {\n+        if (notifyJvmti) {\n@@ -556,1 +562,1 @@\n-            Future<?> unparker = scheduleUnpark(nanos);\n+            Future<?> unparker = scheduleUnpark(this::unpark, nanos);\n@@ -609,1 +615,1 @@\n-     * Schedules this thread to be unparked after the given delay.\n+     * Schedule an unpark task to run after a given delay.\n@@ -612,1 +618,1 @@\n-    private Future<?> scheduleUnpark(long nanos) {\n+    private Future<?> scheduleUnpark(Runnable unparker, long nanos) {\n@@ -614,1 +620,1 @@\n-        switchToCarrierThread();\n+        boolean notifyJvmti = switchToCarrierThread();\n@@ -616,1 +622,1 @@\n-            return UNPARKER.schedule(() -> unpark(), nanos, NANOSECONDS);\n+            return UNPARKER.schedule(unparker, nanos, NANOSECONDS);\n@@ -618,1 +624,1 @@\n-            switchToVirtualThread(this);\n+            switchToVirtualThread(this, notifyJvmti);\n@@ -629,1 +635,1 @@\n-            switchToCarrierThread();\n+            boolean notifyJvmti = switchToCarrierThread();\n@@ -633,1 +639,1 @@\n-                switchToVirtualThread(this);\n+                switchToVirtualThread(this, notifyJvmti);\n@@ -653,1 +659,1 @@\n-                    vthread.switchToCarrierThread();\n+                    boolean notifyJvmti = vthread.switchToCarrierThread();\n@@ -657,1 +663,1 @@\n-                        switchToVirtualThread(vthread);\n+                        switchToVirtualThread(vthread, notifyJvmti);\n","filename":"src\/java.base\/share\/classes\/java\/lang\/VirtualThread.java","additions":22,"deletions":16,"binary":false,"changes":38,"status":"modified"}]}