{"files":[{"patch":"@@ -230,1 +230,1 @@\n-JVM_VirtualThreadToggleTmpVTMSTrans\n+JVM_VirtualThreadHideFrames\n","filename":"make\/data\/hotspot-symbols\/symbols-unix","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -1163,1 +1163,1 @@\n-JVM_VirtualThreadToggleTmpVTMSTrans(JNIEnv* env, jobject vthread, jboolean end_tmp_trans);\n+JVM_VirtualThreadHideFrames(JNIEnv* env, jobject vthread, jboolean hide);\n","filename":"src\/hotspot\/share\/include\/jvm.h","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -4051,1 +4051,1 @@\n-JVM_ENTRY(void, JVM_VirtualThreadToggleTmpVTMSTrans(JNIEnv* env, jobject vthread, jboolean end_tmp_trans))\n+JVM_ENTRY(void, JVM_VirtualThreadHideFrames(JNIEnv* env, jobject vthread, jboolean hide))\n@@ -4057,1 +4057,1 @@\n-  assert(thread->is_in_tmp_VTMS_transition() == (bool)end_tmp_trans, \"sanity check\");\n+  assert(thread->is_in_tmp_VTMS_transition() != (bool)hide, \"sanity check\");\n","filename":"src\/hotspot\/share\/prims\/jvm.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -357,0 +357,27 @@\n+    \/**\n+     * Sets the current thread to the current carrier thread.\n+     *\/\n+    @ChangesCurrentThread\n+    private void switchToCarrierThread() {\n+        Thread carrier = this.carrierThread;\n+        assert Thread.currentThread() == this\n+                && carrier == Thread.currentCarrierThread();\n+        if (notifyJvmtiEvents) {\n+            notifyJvmtiHideFrames(true);\n+        }\n+        carrier.setCurrentThread(carrier);\n+    }\n+\n+    \/**\n+     * Sets the current thread to the given virtual thread.\n+     *\/\n+    @ChangesCurrentThread\n+    private void switchToVirtualThread(VirtualThread vthread) {\n+        Thread carrier = vthread.carrierThread;\n+        assert carrier == Thread.currentCarrierThread();\n+        carrier.setCurrentThread(vthread);\n+        if (notifyJvmtiEvents) {\n+            notifyJvmtiHideFrames(false);\n+        }\n+    }\n+\n@@ -586,5 +613,2 @@\n-        if (notifyJvmtiEvents) toggleJvmtiTmpVTMSTrans(false);\n-\n-        Thread carrier = this.carrierThread;\n-        \/\/ need to switch to current platform thread to avoid nested parking\n-        carrier.setCurrentThread(carrier);\n+        \/\/ need to switch to current carrier thread to avoid nested parking\n+        switchToCarrierThread();\n@@ -594,2 +618,1 @@\n-            carrier.setCurrentThread(this);\n-            if (notifyJvmtiEvents) toggleJvmtiTmpVTMSTrans(true);\n+            switchToVirtualThread(this);\n@@ -605,5 +628,2 @@\n-            if (notifyJvmtiEvents) toggleJvmtiTmpVTMSTrans(false);\n-\n-            Thread carrier = this.carrierThread;\n-            \/\/ need to switch to current platform thread to avoid nested parking\n-            carrier.setCurrentThread(carrier);\n+            \/\/ need to switch to current carrier thread to avoid nested parking\n+            switchToCarrierThread();\n@@ -613,2 +633,1 @@\n-                carrier.setCurrentThread(this);\n-                if (notifyJvmtiEvents) toggleJvmtiTmpVTMSTrans(true);\n+                switchToVirtualThread(this);\n@@ -634,4 +653,1 @@\n-                    if (notifyJvmtiEvents) toggleJvmtiTmpVTMSTrans(false);\n-\n-                    Thread carrier = vthread.carrierThread;\n-                    carrier.setCurrentThread(carrier);\n+                    vthread.switchToCarrierThread();\n@@ -641,2 +657,1 @@\n-                        carrier.setCurrentThread(vthread);\n-                        if (notifyJvmtiEvents) toggleJvmtiTmpVTMSTrans(true);\n+                        switchToVirtualThread(vthread);\n@@ -1018,1 +1033,1 @@\n-    private native void toggleJvmtiTmpVTMSTrans(boolean endTmpTrans);\n+    private native void notifyJvmtiHideFrames(boolean hide);\n","filename":"src\/java.base\/share\/classes\/java\/lang\/VirtualThread.java","additions":36,"deletions":21,"binary":false,"changes":57,"status":"modified"},{"patch":"@@ -39,1 +39,1 @@\n-    { \"toggleJvmtiTmpVTMSTrans\", \"(Z)V\", (void *)&JVM_VirtualThreadToggleTmpVTMSTrans },\n+    { \"toggleJvmtiHideFrames\",   \"(Z)V\", (void *)&JVM_VirtualThreadHideFrames },\n","filename":"src\/java.base\/share\/native\/libjava\/VirtualThread.c","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}