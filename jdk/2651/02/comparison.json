{"files":[{"patch":"@@ -2,1 +2,1 @@\n-# Copyright (c) 2011, 2020, Oracle and\/or its affiliates. All rights reserved.\n+# Copyright (c) 2011, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -586,0 +586,28 @@\n+\n+  AC_ARG_WITH([cds-region-alignment],\n+       [AS_HELP_STRING([--with-cds-region-alignment],\n+                       [set cds region alignment (4096, 16384, 65536)])],\n+  [\n+      AC_MSG_CHECKING([if cds-region-alignmenat specified])\n+      CORE_REGION_ALIGNMENT=${withval}\n+      if test \"x$BUILD_CDS_ARCHIVE\" = \"xfalse\"; then\n+          if test \"x$CORE_REGION_ALIGNMENT\" != \"x\"; then\n+              AC_MSG_ERROR([--with-cds-region-alignment used when cds is disabled])\n+          fi\n+      fi\n+      if test \"x$BUILD_CDS_ARCHIVE\" = \"xtrue\"; then\n+          if test \"x$CORE_REGION_ALIGNMENT\" != \"x\"; then\n+              if test \"x$CORE_REGION_ALIGNMENT\" != \"x4096\" && \\\n+                 test \"x$CORE_REGION_ALIGNMENT\" != \"x16384\" && \\\n+                 test \"x$CORE_REGION_ALIGNMENT\" != \"x65536\"; then\n+                  AC_MSG_ERROR([$CORE_REGION_ALIGNMENT: Allowed values are: 4096, 16384 and 65536])\n+              fi\n+          fi\n+          # define CDS_CORE_REGION_ALIGNMENT\n+          CDS_CORE_REGION_ALIGNMENT=$CORE_REGION_ALIGNMENT\n+          AC_SUBST(CDS_CORE_REGION_ALIGNMENT)\n+          AC_MSG_RESULT([yes $CDS_CORE_REGION_ALIGNMENT])\n+      else\n+          AC_MSG_RESULT([no])\n+      fi\n+   ])\n","filename":"make\/autoconf\/jdk-options.m4","additions":29,"deletions":1,"binary":false,"changes":30,"status":"modified"},{"patch":"@@ -352,0 +352,4 @@\n+ifneq (@CDS_CORE_REGION_ALIGNMENT@,)\n+  CDS_CORE_REGION_ALIGNMENT := @CDS_CORE_REGION_ALIGNMENT@\n+endif\n+\n","filename":"make\/autoconf\/spec.gmk.in","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n-# Copyright (c) 2013, 2019, Oracle and\/or its affiliates. All rights reserved.\n+# Copyright (c) 2013, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -102,0 +102,4 @@\n+\n+ifneq ($(CDS_CORE_REGION_ALIGNMENT), )\n+  JVM_CFLAGS += -DCDS_CORE_REGION_ALIGNMENT=\"$(CDS_CORE_REGION_ALIGNMENT)\"\n+endif\n","filename":"make\/hotspot\/lib\/JvmFlags.gmk","additions":5,"deletions":1,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -355,1 +355,1 @@\n-  total += _total_dump_regions * reserve_alignment();\n+  total += _total_dump_regions * MetaspaceShared::core_region_alignment();\n@@ -363,1 +363,1 @@\n-  return align_up(total, reserve_alignment());\n+  return align_up(total, MetaspaceShared::core_region_alignment());\n@@ -368,1 +368,1 @@\n-  ReservedSpace rs(buffer_size);\n+  ReservedSpace rs(buffer_size, MetaspaceShared::core_region_alignment(), false);\n@@ -406,1 +406,1 @@\n-    my_archive_requested_bottom = align_up(_requested_static_archive_top, MetaspaceShared::reserved_space_alignment());\n+    my_archive_requested_bottom = align_up(_requested_static_archive_top, MetaspaceShared::core_region_alignment());\n","filename":"src\/hotspot\/share\/memory\/archiveBuilder.cpp","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -229,3 +229,2 @@\n-  \/\/ Use this when you allocate space with MetaspaceShare::read_only_space_alloc()\n-  \/\/ outside of ArchiveBuilder::dump_{rw,ro}_region. These are usually for misc tables\n-  \/\/ that are allocated in the RO space.\n+  \/\/ Use this when you allocate space outside of ArchiveBuilder::dump_{rw,ro}_region.\n+  \/\/ These are usually for misc tables that are allocated in the RO space.\n@@ -272,4 +271,0 @@\n-  static size_t reserve_alignment() {\n-    return os::vm_allocation_granularity();\n-  }\n-\n","filename":"src\/hotspot\/share\/memory\/archiveBuilder.hpp","additions":2,"deletions":7,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -250,1 +250,1 @@\n-  _end = (char*)align_up(_top, MetaspaceShared::reserved_space_alignment());\n+  _end = (char*)align_up(_top, MetaspaceShared::core_region_alignment());\n","filename":"src\/hotspot\/share\/memory\/archiveUtils.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -50,6 +50,0 @@\n-public:\n-\n-  static size_t reserve_alignment() {\n-    return os::vm_allocation_granularity();\n-  }\n-\n@@ -186,1 +180,1 @@\n-  _header->populate(base_info, os::vm_allocation_granularity());\n+  _header->populate(base_info, base_info->core_region_alignment());\n","filename":"src\/hotspot\/share\/memory\/dynamicArchive.cpp","additions":1,"deletions":7,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -201,2 +201,2 @@\n-void FileMapInfo::populate_header(size_t alignment) {\n-  header()->populate(this, alignment);\n+void FileMapInfo::populate_header(size_t core_region_alignment) {\n+  header()->populate(this, core_region_alignment);\n@@ -205,1 +205,1 @@\n-void FileMapHeader::populate(FileMapInfo* mapinfo, size_t alignment) {\n+void FileMapHeader::populate(FileMapInfo* mapinfo, size_t core_region_alignment) {\n@@ -212,1 +212,1 @@\n-  _alignment = alignment;\n+  _core_region_alignment = core_region_alignment;\n@@ -270,1 +270,1 @@\n-  st->print_cr(\"- alignment:                      \" SIZE_FORMAT, _alignment);\n+  st->print_cr(\"- core_region_alignment:          \" SIZE_FORMAT, _core_region_alignment);\n@@ -1229,1 +1229,1 @@\n-  header_bytes = align_up(header_bytes, os::vm_allocation_granularity());\n+  header_bytes = align_up(header_bytes, MetaspaceShared::core_region_alignment());\n@@ -1255,1 +1255,1 @@\n-  return align_up(used(), os::vm_allocation_granularity());\n+  return align_up(used(), MetaspaceShared::core_region_alignment());\n@@ -1460,1 +1460,1 @@\n-                                  os::vm_allocation_granularity());\n+                                  MetaspaceShared::core_region_alignment());\n@@ -1468,1 +1468,1 @@\n-                                    os::vm_allocation_granularity());\n+                                    MetaspaceShared::core_region_alignment());\n@@ -1511,2 +1511,1 @@\n-  size_t used = si->used();\n-  size_t size = align_up(used, os::vm_allocation_granularity());\n+  size_t size = si->used_aligned();\n@@ -2092,2 +2091,1 @@\n-  size_t used = si->used();\n-  size_t size = align_up(used, os::vm_allocation_granularity());\n+  size_t size = si->used_aligned();\n","filename":"src\/hotspot\/share\/memory\/filemap.cpp","additions":11,"deletions":13,"binary":false,"changes":24,"status":"modified"},{"patch":"@@ -161,1 +161,1 @@\n-  size_t used_aligned()             const; \/\/ aligned up to os::vm_allocation_granularity()\n+  size_t used_aligned()             const; \/\/ aligned up to MetaspaceShared::core_region_alignment()\n@@ -194,1 +194,1 @@\n-  size_t _alignment;                \/\/ how shared archive should be aligned\n+  size_t _core_region_alignment;    \/\/ how shared archive should be aligned\n@@ -259,1 +259,1 @@\n-  size_t alignment()                       const { return _alignment; }\n+  size_t core_region_alignment()           const { return _core_region_alignment; }\n@@ -324,1 +324,1 @@\n-  void populate(FileMapInfo* info, size_t alignment);\n+  void populate(FileMapInfo* info, size_t core_region_alignment);\n@@ -390,1 +390,1 @@\n-  void   populate_header(size_t alignment);\n+  void   populate_header(size_t core_region_alignment);\n@@ -395,1 +395,0 @@\n-  size_t alignment()           const { return header()->alignment(); }\n@@ -401,0 +400,1 @@\n+  size_t  core_region_alignment() const { return header()->core_region_alignment(); }\n","filename":"src\/hotspot\/share\/memory\/filemap.hpp","additions":6,"deletions":6,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -104,1 +104,1 @@\n-\/\/ These regions are aligned with MetaspaceShared::reserved_space_alignment().\n+\/\/ These regions are aligned with MetaspaceShared::core_region_alignment().\n@@ -125,1 +125,17 @@\n-size_t MetaspaceShared::reserved_space_alignment() { return os::vm_allocation_granularity(); }\n+\/\/ core region alignment is configurable during build time.\n+size_t MetaspaceShared::core_region_alignment() {\n+#if defined(CDS_CORE_REGION_ALIGNMENT)\n+  assert(CDS_CORE_REGION_ALIGNMENT == 4096  ||\n+         CDS_CORE_REGION_ALIGNMENT == 16384 ||\n+         CDS_CORE_REGION_ALIGNMENT == 65536, \"Sanity check\");\n+  assert(is_power_of_2(CDS_CORE_REGION_ALIGNMENT),\n+         \"CDS core region alignment must be power of 2.\");\n+  assert(CDS_CORE_REGION_ALIGNMENT >= (size_t)os::vm_allocation_granularity(),\n+         \"CDS core region aligment must be greater or equal to OS page size.\");\n+  assert(CDS_CORE_REGION_ALIGNMENT % os::vm_allocation_granularity() == 0,\n+         \"CDS core region alignment must be divisible by page size\");\n+  return CDS_CORE_REGION_ALIGNMENT;\n+#else\n+  return (size_t)os::vm_allocation_granularity();\n+#endif \/\/ CDS_CORE_REGION_ALIGNMENT\n+}\n@@ -138,1 +154,1 @@\n-    \/\/ align_up(SharedBaseAddress, MetaspaceShared::reserved_space_alignment()) has wrapped around.\n+    \/\/ align_up(SharedBaseAddress, MetaspaceShared::core_region_alignment()) has wrapped around.\n@@ -151,1 +167,1 @@\n-  char* aligned_base = align_up(specified_base, MetaspaceShared::reserved_space_alignment());\n+  char* aligned_base = align_up(specified_base, MetaspaceShared::core_region_alignment());\n@@ -167,1 +183,1 @@\n-  aligned_base = align_up(specified_base, MetaspaceShared::reserved_space_alignment());\n+  aligned_base = align_up(specified_base, MetaspaceShared::core_region_alignment());\n@@ -177,1 +193,1 @@\n-\n+  log_info(cds)(\"Core region alignment: \" SIZE_FORMAT, core_region_alignment());\n@@ -181,1 +197,1 @@\n-  const size_t reserve_alignment = MetaspaceShared::reserved_space_alignment();\n+  const size_t reserve_alignment = core_region_alignment();\n@@ -512,1 +528,1 @@\n-  mapinfo->populate_header(os::vm_allocation_granularity());\n+  mapinfo->populate_header(MetaspaceShared::core_region_alignment());\n@@ -883,0 +899,1 @@\n+    log_info(cds)(\"Core region alignment: \" SIZE_FORMAT, static_mapinfo->core_region_alignment());\n@@ -1003,1 +1020,1 @@\n-                        MetaspaceShared::reserved_space_alignment()),\n+                        core_region_alignment()),\n@@ -1011,1 +1028,1 @@\n-    log_debug(cds)(\"Reserved archive_space_rs     [\" INTPTR_FORMAT \" - \" INTPTR_FORMAT \"] (\" SIZE_FORMAT \") bytes\",\n+    log_info(cds)(\"Reserved archive_space_rs [\" INTPTR_FORMAT \" - \" INTPTR_FORMAT \"] (\" SIZE_FORMAT \") bytes\",\n@@ -1013,1 +1030,1 @@\n-    log_debug(cds)(\"Reserved class_space_rs [\" INTPTR_FORMAT \" - \" INTPTR_FORMAT \"] (\" SIZE_FORMAT \") bytes\",\n+    log_info(cds)(\"Reserved class_space_rs   [\" INTPTR_FORMAT \" - \" INTPTR_FORMAT \"] (\" SIZE_FORMAT \") bytes\",\n@@ -1175,1 +1192,1 @@\n-  const size_t archive_space_alignment = MetaspaceShared::reserved_space_alignment();\n+  const size_t archive_space_alignment = core_region_alignment();\n@@ -1233,2 +1250,1 @@\n-      align_up(archive_space_size + gap_size + class_space_size,\n-               os::vm_allocation_granularity());\n+      align_up(archive_space_size + gap_size + class_space_size, core_region_alignment());\n@@ -1277,1 +1293,1 @@\n-                                                 (size_t)os::vm_allocation_granularity());\n+                                                 (size_t)archive_space_alignment);\n@@ -1330,4 +1346,3 @@\n-\n-  if (mapinfo->alignment() != (size_t)os::vm_allocation_granularity()) {\n-    log_info(cds)(\"Unable to map CDS archive -- os::vm_allocation_granularity() expected: \" SIZE_FORMAT\n-                  \" actual: %d\", mapinfo->alignment(), os::vm_allocation_granularity());\n+  if (mapinfo->core_region_alignment() != (size_t)core_region_alignment()) {\n+    log_info(cds)(\"Unable to map CDS archive -- core_region_alignment() expected: \" SIZE_FORMAT\n+                  \" actual: \" SIZE_FORMAT, mapinfo->core_region_alignment(), core_region_alignment());\n","filename":"src\/hotspot\/share\/memory\/metaspaceShared.cpp","additions":34,"deletions":19,"binary":false,"changes":53,"status":"modified"},{"patch":"@@ -140,1 +140,3 @@\n-  static size_t reserved_space_alignment();\n+  \/\/ Alignment for the 3 core CDS regions (MC\/RW\/RO) only.\n+  \/\/ (Heap region alignments are decided by GC).\n+  static size_t core_region_alignment();\n","filename":"src\/hotspot\/share\/memory\/metaspaceShared.hpp","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -0,0 +1,102 @@\n+\/*\n+ * Copyright (c) 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/**\n+ * @test\n+ * @requires vm.cds\n+ * @requires vm.gc != \"Z\"\n+ * @summary Testing handling of CDS region alignment\n+ * @comment ZGC may exit the VM if -XX:+UseLargePages is specified but\n+ *          unavailable. Since this test is independent of the actual GC type, let's\n+ *          disable it if ZGC is used.\n+ * @bug 8236847\n+ * @library \/test\/lib \/test\/hotspot\/jtreg\/runtime\/cds\/appcds\/test-classes\n+ * @build Hello\n+ * @run driver ClassFileInstaller -jar hello.jar Hello\n+ * @run driver SharedRegionAlignmentTest\n+ *\/\n+\n+import jdk.test.lib.process.OutputAnalyzer;\n+\n+public class SharedRegionAlignmentTest {\n+    static String appJar = ClassFileInstaller.getJarPath(\"hello.jar\");\n+    static String mainClass = \"Hello\";\n+    static String logArg = \"-Xlog:cds\";\n+\n+    static void testCombo() throws Exception {\n+        \/\/ Test the following combinations:\n+        \/\/ Dump (3 combinations): largePageArgs\n+        \/\/ Run  (3 combinations): largePageArgs\n+        String UseLargePages = \"-XX:+UseLargePages\";\n+\n+        String [][] largePageArgs = {\n+            {}, \/\/ default\n+            {UseLargePages}\n+        };\n+\n+        final String logFor64K = \"core_region_alignment = 65535\";\n+\n+        int dumpCase = 0;\n+        for (String[] dumpLP: largePageArgs) {\n+            dumpCase ++;\n+            System.out.println(\"============================================================\");\n+            System.out.println(\"dump case (\" + dumpCase + \"): \" + formatLargePageArgs(dumpLP));\n+            System.out.println(\"============================================================\");\n+\n+            OutputAnalyzer out = TestCommon.dump(appJar,\n+                                                 TestCommon.list(mainClass),\n+                                                 TestCommon.concat(dumpLP, logArg));\n+            out.shouldContain(\"Dumping shared data to file\");\n+            boolean is_aligned_64k = out.getStdout().contains(logFor64K);\n+\n+            int runCase = 0;\n+            for (String[] runLP: largePageArgs) {\n+                runCase++;\n+                System.out.println(\"--------------------------------------------------\");\n+                System.out.println(\"run case (\" + dumpCase + \".\" + runCase + \"):\" + formatLargePageArgs(runLP));\n+                System.out.println(\"--------------------------------------------------\");\n+\n+                TestCommon.run(TestCommon.concat(runLP, \"-cp\", appJar, logArg, mainClass))\n+                    .assertNormalExit(output -> {\n+                            if (is_aligned_64k) {\n+                                output.shouldContain(logFor64K);\n+                            }\n+                            output.shouldContain(\"Hello World\");\n+                        });\n+            }\n+        }\n+    }\n+\n+    static String formatLargePageArgs(String args[]) {\n+        StringBuilder sb = new StringBuilder();\n+        for (String a : args) {\n+            sb.append(\" \");\n+            sb.append(a);\n+        }\n+        return sb.toString();\n+    }\n+\n+    public static void main(String... args) throws Exception {\n+        testCombo();\n+    }\n+}\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/SharedRegionAlignmentTest.java","additions":102,"deletions":0,"binary":false,"changes":102,"status":"added"}]}