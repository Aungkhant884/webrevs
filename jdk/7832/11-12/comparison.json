{"files":[{"patch":"@@ -1664,0 +1664,32 @@\n+void C2_MacroAssembler::load_constant_vector(BasicType bt, XMMRegister dst, InternalAddress src, int vlen) {\n+  int vlen_enc = vector_length_encoding(vlen);\n+  if (VM_Version::supports_avx()) {\n+    if (bt == T_LONG) {\n+      if (VM_Version::supports_avx2()) {\n+        vpbroadcastq(dst, src, vlen_enc, noreg);\n+      } else {\n+        vmovddup(dst, src, vlen_enc, noreg);\n+      }\n+    } else if (bt == T_DOUBLE) {\n+      if (vlen_enc != Assembler::AVX_128bit) {\n+        vbroadcastsd(dst, src, vlen_enc, noreg);\n+      } else {\n+        vmovddup(dst, src, vlen_enc, noreg);\n+      }\n+    } else {\n+      if (VM_Version::supports_avx2() && is_integral_type(bt)) {\n+        vpbroadcastd(dst, src, vlen_enc, noreg);\n+      } else {\n+        vbroadcastss(dst, src, vlen_enc, noreg);\n+      }\n+    }\n+  } else if (VM_Version::supports_sse3()) {\n+    movddup(dst, src);\n+  } else {\n+    movq(dst, src);\n+    if (vlen == 16) {\n+      punpcklqdq(dst, dst);\n+    }\n+  }\n+}\n+\n","filename":"src\/hotspot\/cpu\/x86\/c2_MacroAssembler_x86.cpp","additions":32,"deletions":0,"binary":false,"changes":32,"status":"modified"},{"patch":"@@ -162,0 +162,1 @@\n+  void load_constant_vector(BasicType bt, XMMRegister dst, InternalAddress src, int vlen);\n","filename":"src\/hotspot\/cpu\/x86\/c2_MacroAssembler_x86.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -4230,1 +4230,3 @@\n-    if (VM_Version::supports_avx()) {\n+    if (VM_Version::supports_avx2()) {\n+      __ vpbroadcastd($dst$$XMMRegister, $mem$$Address, vlen_enc);\n+    } else if (VM_Version::supports_avx()) {\n@@ -4251,11 +4253,2 @@\n-    int vlen_enc = vector_length_encoding(this);\n-    if (VM_Version::supports_avx()) {\n-      __ vbroadcastss($dst$$XMMRegister, addr, vlen_enc);\n-    } else if (VM_Version::supports_sse3()) {\n-      __ movddup($dst$$XMMRegister, addr);\n-    } else {\n-      __ movq($dst$$XMMRegister, addr);\n-      if (Matcher::vector_length_in_bytes(this) >= 16) {\n-        __ punpcklqdq($dst$$XMMRegister, $dst$$XMMRegister);\n-      }\n-    }\n+    int vlen = Matcher::vector_length_in_bytes(this);\n+    __ load_constant_vector(bt, $dst$$XMMRegister, addr, vlen);\n@@ -4397,11 +4390,2 @@\n-    int vlen_enc = vector_length_encoding(this);\n-    if (VM_Version::supports_avx2()) {\n-      __ vpbroadcastq($dst$$XMMRegister, addr, vlen_enc);\n-    } else if (VM_Version::supports_sse3()) {\n-      __ movddup($dst$$XMMRegister, addr);\n-    } else {\n-      __ movq($dst$$XMMRegister, addr);\n-      if (Matcher::vector_length_in_bytes(this) >= 16) {\n-        __ punpcklqdq($dst$$XMMRegister, $dst$$XMMRegister);\n-      }\n-    }\n+    int vlen = Matcher::vector_length_in_bytes(this);\n+    __ load_constant_vector(T_LONG, $dst$$XMMRegister, addr, vlen);\n@@ -4487,11 +4471,2 @@\n-    int vlen_enc = vector_length_encoding(this);\n-    if (VM_Version::supports_avx()) {\n-      __ vbroadcastss($dst$$XMMRegister, addr, vlen_enc);\n-    } else if (VM_Version::supports_sse3()) {\n-      __ movddup($dst$$XMMRegister, addr);\n-    } else {\n-      __ movq($dst$$XMMRegister, addr);\n-      if (Matcher::vector_length_in_bytes(this) >= 16) {\n-        __ punpcklqdq($dst$$XMMRegister, $dst$$XMMRegister);\n-      }\n-    }\n+    int vlen = Matcher::vector_length_in_bytes(this);\n+    __ load_constant_vector(T_FLOAT, $dst$$XMMRegister, addr, vlen);\n@@ -4570,11 +4545,2 @@\n-    int vlen_enc = vector_length_encoding(this);\n-    if (Matcher::vector_length(this) >= 4) {\n-      __ vbroadcastsd($dst$$XMMRegister, addr, vlen_enc);\n-    } else if (VM_Version::supports_sse3()) {\n-      __ movddup($dst$$XMMRegister, addr);\n-    } else {\n-      __ movq($dst$$XMMRegister, addr);\n-      if (Matcher::vector_length_in_bytes(this) >= 16) {\n-        __ punpcklqdq($dst$$XMMRegister, $dst$$XMMRegister);\n-      }\n-    }\n+    int vlen = Matcher::vector_length_in_bytes(this);\n+    __ load_constant_vector(T_DOUBLE, $dst$$XMMRegister, addr, vlen);\n","filename":"src\/hotspot\/cpu\/x86\/x86.ad","additions":11,"deletions":45,"binary":false,"changes":56,"status":"modified"}]}