{"files":[{"patch":"@@ -503,10 +503,6 @@\n-                xi.setSecureValidation(secVal);\n-                if (context instanceof XMLSignContext && c14n11\n-                    && !xi.isOctetStream() && !xi.isOutputStreamSet()) {\n-                    TransformService spi = null;\n-                    if (provider == null) {\n-                        spi = TransformService.getInstance(c14nalg, \"DOM\");\n-                    } else {\n-                        try {\n-                            spi = TransformService.getInstance(c14nalg, \"DOM\", provider);\n-                        } catch (NoSuchAlgorithmException nsae) {\n+                try {\n+                    xi.setSecureValidation(secVal);\n+                    if (context instanceof XMLSignContext && c14n11\n+                            && !xi.isOctetStream() && !xi.isOutputStreamSet()) {\n+                        TransformService spi = null;\n+                        if (provider == null) {\n@@ -514,0 +510,6 @@\n+                        } else {\n+                            try {\n+                                spi = TransformService.getInstance(c14nalg, \"DOM\", provider);\n+                            } catch (NoSuchAlgorithmException nsae) {\n+                                spi = TransformService.getInstance(c14nalg, \"DOM\");\n+                            }\n@@ -515,1 +517,0 @@\n-                    }\n@@ -517,9 +518,16 @@\n-                    DOMTransform t = new DOMTransform(spi);\n-                    Element transformsElem = null;\n-                    String dsPrefix = DOMUtils.getSignaturePrefix(context);\n-                    if (allTransforms.isEmpty()) {\n-                        transformsElem = DOMUtils.createElement(\n-                            refElem.getOwnerDocument(),\n-                            \"Transforms\", XMLSignature.XMLNS, dsPrefix);\n-                        refElem.insertBefore(transformsElem,\n-                            DOMUtils.getFirstChildElement(refElem));\n+                        DOMTransform t = new DOMTransform(spi);\n+                        Element transformsElem = null;\n+                        String dsPrefix = DOMUtils.getSignaturePrefix(context);\n+                        if (allTransforms.isEmpty()) {\n+                            transformsElem = DOMUtils.createElement(\n+                                    refElem.getOwnerDocument(),\n+                                    \"Transforms\", XMLSignature.XMLNS, dsPrefix);\n+                            refElem.insertBefore(transformsElem,\n+                                    DOMUtils.getFirstChildElement(refElem));\n+                        } else {\n+                            transformsElem = DOMUtils.getFirstChildElement(refElem);\n+                        }\n+                        t.marshal(transformsElem, dsPrefix,\n+                                (DOMCryptoContext) context);\n+                        allTransforms.add(t);\n+                        xi.updateOutputStream(os, true);\n@@ -527,1 +535,5 @@\n-                        transformsElem = DOMUtils.getFirstChildElement(refElem);\n+                        xi.updateOutputStream(os);\n+                    }\n+                } finally {\n+                    if(xi.getOctetStreamReal() != null) {\n+                        xi.getOctetStreamReal().close();\n@@ -529,6 +541,0 @@\n-                    t.marshal(transformsElem, dsPrefix,\n-                              (DOMCryptoContext)context);\n-                    allTransforms.add(t);\n-                    xi.updateOutputStream(os, true);\n-                } else {\n-                    xi.updateOutputStream(os);\n","filename":"src\/java.xml.crypto\/share\/classes\/org\/jcp\/xml\/dsig\/internal\/dom\/DOMReference.java","additions":33,"deletions":27,"binary":false,"changes":60,"status":"modified"}]}