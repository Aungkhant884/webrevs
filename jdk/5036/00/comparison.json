{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2001, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2001, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -90,2 +90,2 @@\n-                ccreds, ccreds.getClient(), sname, null,\n-                new PAData[] {\n+                ccreds, ccreds.getClient(), sname, client,\n+                null, new PAData[] {\n@@ -139,1 +139,1 @@\n-                ccreds, ccreds.getClient(), backendPrincipal,\n+                ccreds, ccreds.getClient(), backendPrincipal, null,\n@@ -316,1 +316,1 @@\n-                S4U2Type.NONE);\n+                null, S4U2Type.NONE);\n@@ -328,2 +328,2 @@\n-            Ticket[] additionalTickets, PAData[] extraPAs,\n-            S4U2Type s4u2Type)\n+            PrincipalName user, Ticket[] additionalTickets,\n+            PAData[] extraPAs, S4U2Type s4u2Type)\n@@ -334,1 +334,1 @@\n-                        s4u2Type, additionalTickets, extraPAs);\n+                        s4u2Type, user, additionalTickets, extraPAs);\n@@ -342,1 +342,1 @@\n-                additionalTickets, extraPAs);\n+                user, additionalTickets, extraPAs);\n@@ -352,2 +352,2 @@\n-            S4U2Type s4u2Type, Ticket[] additionalTickets,\n-            PAData[] extraPAs)\n+            S4U2Type s4u2Type, PrincipalName user,\n+            Ticket[] additionalTickets, PAData[] extraPAs)\n@@ -365,1 +365,2 @@\n-                    ReferralsCache.get(cname, sname, refSname.getRealmString());\n+                    ReferralsCache.get(cname, sname, user,\n+                            additionalTickets, refSname.getRealmString());\n@@ -370,1 +371,1 @@\n-                        additionalTickets, extraPAs);\n+                        user, additionalTickets, extraPAs);\n@@ -381,9 +382,3 @@\n-                        if (s4u2Type == S4U2Type.NONE) {\n-                            \/\/ Do not store S4U2Self or S4U2Proxy referral\n-                            \/\/ TGTs in the cache. Caching such tickets is not\n-                            \/\/ defined in MS-SFU and may cause unexpected\n-                            \/\/ results when using them in a different context.\n-                            ReferralsCache.put(cname, sname,\n-                                    server.getRealmString(),\n-                                    serverNameStrings[1], creds);\n-                        }\n+                        ReferralsCache.put(cname, sname, user,\n+                                additionalTickets, server.getRealmString(),\n+                                serverNameStrings[1], creds);\n@@ -414,1 +409,1 @@\n-                    handleS4U2SelfReferral(extraPAs, asCreds, creds);\n+                    handleS4U2SelfReferral(extraPAs, user, asCreds, creds);\n@@ -443,2 +438,2 @@\n-            S4U2Type s4u2Type, Ticket[] additionalTickets,\n-            PAData[] extraPAs)\n+            S4U2Type s4u2Type, PrincipalName user,\n+            Ticket[] additionalTickets, PAData[] extraPAs)\n@@ -472,1 +467,1 @@\n-                handleS4U2SelfReferral(extraPAs, asCreds, newTgt);\n+                handleS4U2SelfReferral(extraPAs, user, asCreds, newTgt);\n@@ -501,1 +496,1 @@\n-            Credentials oldCeds, Credentials newCreds)\n+            PrincipalName user, Credentials oldCeds, Credentials newCreds)\n@@ -509,3 +504,0 @@\n-                PAForUserEnc paForUser = new PAForUserEnc(\n-                        new DerValue(pa.getValue()),\n-                        oldCeds.getSessionKey());\n@@ -513,1 +505,1 @@\n-                        new PAForUserEnc(paForUser.getName(),\n+                        new PAForUserEnc(user,\n","filename":"src\/java.security.jgss\/share\/classes\/sun\/security\/krb5\/internal\/CredentialsUtil.java","additions":23,"deletions":31,"binary":false,"changes":54,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2019, Red Hat, Inc.\n+ * Copyright (c) 2019, 2021, Red Hat, Inc.\n@@ -28,0 +28,1 @@\n+import java.util.Arrays;\n@@ -34,0 +35,1 @@\n+import java.util.Objects;\n@@ -54,1 +56,4 @@\n-        ReferralCacheKey (PrincipalName cname, PrincipalName sname) {\n+        private PrincipalName user; \/\/ S4U2Self only\n+        private byte[] clientSvcTicketEnc; \/\/ S4U2Proxy only\n+        ReferralCacheKey (PrincipalName cname, PrincipalName sname,\n+                PrincipalName user, Ticket clientSvcTicket) {\n@@ -57,0 +62,7 @@\n+            this.user = user;\n+            if (clientSvcTicket != null && clientSvcTicket.encPart != null) {\n+                byte[] clientSvcTicketEnc = clientSvcTicket.encPart.getBytes();\n+                if (clientSvcTicketEnc.length > 0) {\n+                    this.clientSvcTicketEnc = clientSvcTicketEnc;\n+                }\n+            }\n@@ -63,1 +75,3 @@\n-                    sname.equals(that.sname);\n+                    sname.equals(that.sname) &&\n+                    Objects.equals(user, that.user) &&\n+                    Arrays.equals(clientSvcTicketEnc, that.clientSvcTicketEnc);\n@@ -66,1 +80,3 @@\n-            return cname.hashCode() + sname.hashCode();\n+            return cname.hashCode() + sname.hashCode() +\n+                    Objects.hashCode(user) +\n+                    Arrays.hashCode(clientSvcTicketEnc);\n@@ -87,1 +103,2 @@\n-     * service principal, source KDC realm, destination KDC realm and\n+     * service principal, user principal (S4U2Self only), client service\n+     * ticket (S4U2Proxy only), source KDC realm, destination KDC realm and\n@@ -97,2 +114,6 @@\n-            String fromRealm, String toRealm, Credentials creds) {\n-        ReferralCacheKey k = new ReferralCacheKey(cname, service);\n+            PrincipalName user, Ticket[] clientSvcTickets, String fromRealm,\n+            String toRealm, Credentials creds) {\n+        Ticket clientSvcTicket = (clientSvcTickets != null ?\n+                clientSvcTickets[0] : null);\n+        ReferralCacheKey k = new ReferralCacheKey(cname, service,\n+                user, clientSvcTicket);\n@@ -128,1 +149,2 @@\n-     * service principal and a source KDC realm.\n+     * a service principal, a user principal (S4U2Self only), a client\n+     * service ticket (S4U2Proxy only) and a source KDC realm.\n@@ -131,2 +153,6 @@\n-            PrincipalName service, String fromRealm) {\n-        ReferralCacheKey k = new ReferralCacheKey(cname, service);\n+            PrincipalName service, PrincipalName user,\n+            Ticket[] clientSvcTickets, String fromRealm) {\n+        Ticket clientSvcTicket = (clientSvcTickets != null ?\n+                clientSvcTickets[0] : null);\n+        ReferralCacheKey k = new ReferralCacheKey(cname, service,\n+                user, clientSvcTicket);\n","filename":"src\/java.security.jgss\/share\/classes\/sun\/security\/krb5\/internal\/ReferralsCache.java","additions":36,"deletions":10,"binary":false,"changes":46,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2019, 2020, Red Hat, Inc.\n+ * Copyright (c) 2019, 2021, Red Hat, Inc.\n@@ -290,0 +290,10 @@\n+        testImpersonationSingle();\n+\n+        \/\/ Try a second time to force the use of the Referrals Cache.\n+        \/\/ During this execution, the referral ticket from RABBIT.HOLE\n+        \/\/ to DEV.RABBIT.HOLE (upon the initial S4U2Self message) will\n+        \/\/ be obtained from the Cache.\n+        testImpersonationSingle();\n+    }\n+\n+    private static void testImpersonationSingle() throws Exception {\n@@ -309,0 +319,10 @@\n+        testDelegationWithReferralsSingle();\n+\n+        \/\/ Try a second time to force the use of the Referrals Cache.\n+        \/\/ During this execution, the referral ticket from RABBIT.HOLE\n+        \/\/ to DEV.RABBIT.HOLE (upon the initial S4U2Proxy message) will\n+        \/\/ be obtained from the Cache.\n+        testDelegationWithReferralsSingle();\n+    }\n+\n+    private static void testDelegationWithReferralsSingle() throws Exception {\n","filename":"test\/jdk\/sun\/security\/krb5\/auto\/ReferralsTest.java","additions":21,"deletions":1,"binary":false,"changes":22,"status":"modified"}]}