{"files":[{"patch":"@@ -595,1 +595,0 @@\n-javax\/net\/ssl\/SSLEngine\/Basics.java                             8298867 generic-all\n","filename":"test\/jdk\/ProblemList.txt","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2003, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2003, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -29,1 +29,0 @@\n- *\n@@ -33,0 +32,1 @@\n+ * @library \/test\/lib\n@@ -34,0 +34,1 @@\n+ * @run main\/othervm Basics\n@@ -39,0 +40,1 @@\n+import java.util.Arrays;\n@@ -42,0 +44,2 @@\n+import jdk.test.lib.security.SecurityUtils;\n+\n@@ -44,4 +48,4 @@\n-    private static String pathToStores = \"..\/etc\";\n-    private static String keyStoreFile = \"keystore\";\n-    private static String trustStoreFile = \"truststore\";\n-    private static String passwd = \"passphrase\";\n+    private static final String pathToStores = \"..\/etc\";\n+    private static final String keyStoreFile = \"keystore\";\n+    private static final String trustStoreFile = \"truststore\";\n+    private static final String passwd = \"passphrase\";\n@@ -49,1 +53,1 @@\n-    private static String keyFilename =\n+    private static final String keyFilename =\n@@ -52,1 +56,1 @@\n-    private static String trustFilename =\n+    private static final String trustFilename =\n@@ -57,0 +61,9 @@\n+        SecurityUtils.removeFromDisabledTlsAlgs(\"TLSv1.1\");\n+\n+        runTest(\"TLSv1.3\", \"TLS_AES_256_GCM_SHA384\");\n+        runTest(\"TLSv1.2\", \"TLS_RSA_WITH_AES_256_GCM_SHA384\");\n+        runTest(\"TLSv1.1\", \"TLS_DHE_DSS_WITH_AES_128_CBC_SHA\");\n+    }\n+\n+    private static void runTest(String protocol, String cipherSuite) throws Exception {\n+        System.out.printf(\"Testing %s with %s%n\", protocol, cipherSuite);\n@@ -80,2 +93,7 @@\n-        String secondSuite = suites[1];\n-        String [] oneSuites = new String [] { secondSuite };\n+        \/\/ sanity check that the ciphersuite we want to use is still supported\n+        Arrays.stream(suites)\n+                .filter(s -> s.equals(cipherSuite))\n+                .findFirst()\n+                .orElseThrow((() ->\n+                        new RuntimeException(cipherSuite +\n+                                \" is not a supported ciphersuite.\")));\n@@ -85,1 +103,1 @@\n-        ssle.setEnabledCipherSuites(oneSuites);\n+        ssle.setEnabledCipherSuites(new String [] { cipherSuite });\n@@ -90,2 +108,2 @@\n-                !(suites[0].equals(secondSuite))) {\n-            throw new Exception(\"set ciphers not what was expected\");\n+                !(suites[0].equals(cipherSuite))) {\n+            throw new RuntimeException(\"set ciphers not what was expected\");\n@@ -97,2 +115,7 @@\n-        String secondProtocol = protocols[1];\n-        String [] oneProtocols = new String [] { protocols[1] };\n+        \/\/ sanity check that the protocol we want is still supported\n+        Arrays.stream(protocols)\n+                .filter(p -> p.equals(protocol))\n+                .findFirst()\n+                .orElseThrow(() ->\n+                        new RuntimeException(protocol +\n+                                \" is not a supported TLS protocol.\"));\n@@ -102,1 +125,1 @@\n-        ssle.setEnabledProtocols(oneProtocols);\n+        ssle.setEnabledProtocols(new String[]{ protocol });\n@@ -107,2 +130,2 @@\n-                !(protocols[0].equals(secondProtocol))) {\n-            throw new Exception(\"set protocols not what was expected\");\n+                !(protocols[0].equals(protocol))) {\n+            throw new RuntimeException(\"set protocols not what was expected\");\n@@ -115,1 +138,1 @@\n-            throw new Exception(\"set\/getUseClientMode false\");\n+            throw new RuntimeException(\"set\/getUseClientMode false\");\n@@ -120,1 +143,1 @@\n-            throw new Exception(\"set\/getUseClientMode true\");\n+            throw new RuntimeException(\"set\/getUseClientMode true\");\n@@ -128,1 +151,1 @@\n-            throw new Exception(\"set\/getNeedClientAuth true\");\n+            throw new RuntimeException(\"set\/getNeedClientAuth true\");\n@@ -133,1 +156,1 @@\n-            throw new Exception(\"set\/getNeedClientAuth false\");\n+            throw new RuntimeException(\"set\/getNeedClientAuth false\");\n@@ -139,1 +162,1 @@\n-            throw new Exception(\"set\/getWantClientAuth need = true\");\n+            throw new RuntimeException(\"set\/getWantClientAuth need = true\");\n@@ -143,1 +166,1 @@\n-            throw new Exception(\"set\/getNeedClientAuth false\");\n+            throw new RuntimeException(\"set\/getNeedClientAuth false\");\n@@ -148,1 +171,1 @@\n-            throw new Exception(\"set\/getNeedClientAuth true\");\n+            throw new RuntimeException(\"set\/getNeedClientAuth true\");\n@@ -160,1 +183,1 @@\n-            throw new Exception(\"set\/getSessionCreation true\");\n+            throw new RuntimeException(\"set\/getSessionCreation true\");\n@@ -165,1 +188,1 @@\n-            throw new Exception(\"set\/getSessionCreation false\");\n+            throw new RuntimeException(\"set\/getSessionCreation false\");\n@@ -173,1 +196,1 @@\n-            throw new Exception(\"wrap should have overflowed\");\n+            throw new RuntimeException(\"wrap should have overflowed\");\n@@ -180,5 +203,0 @@\n-        \/\/\n-        \/\/if (ssle.unwrap(smallBB, smallBB).getStatus() !=\n-        \/\/      Status.BUFFER_OVERFLOW) {\n-        \/\/    throw new Exception(\"unwrap should have overflowed\");\n-        \/\/}\n@@ -199,1 +217,1 @@\n-            throw new Exception(\"initial client hello needs unwrap\");\n+            throw new RuntimeException(\"initial client hello needs unwrap\");\n@@ -202,5 +220,9 @@\n-        \/* Checking for overflow wrap\/unwrap() *\/\n-\n-        if (ssle.wrap(appBB, netBB).getStatus() !=\n-                Status.BUFFER_OVERFLOW) {\n-            throw new Exception(\"unwrap should have overflowed\");\n+        \/*\n+         * After the first call to wrap(), the handshake status is\n+         * NEED_UNWRAP and we need to receive data before doing anymore\n+         * handshaking.\n+         *\/\n+        SSLEngineResult result = ssle.wrap(appBB, netBB);\n+        if (result.getStatus() != Status.OK\n+            && result.bytesConsumed() != 0 && result.bytesProduced() != 0) {\n+            throw new RuntimeException(\"wrap should have returned without doing anything\");\n@@ -221,1 +243,1 @@\n-            throw new Exception(\"unwrap wasn't ReadOnlyBufferException\");\n+            throw new RuntimeException(\"unwrap wasn't ReadOnlyBufferException\");\n@@ -236,1 +258,1 @@\n-            throw new Exception(\"unwrap should underflow\");\n+            throw new RuntimeException(\"unwrap should underflow\");\n@@ -244,1 +266,1 @@\n-            throw new Exception(\"unwrap should underflow\");\n+            throw new RuntimeException(\"unwrap should underflow\");\n@@ -252,1 +274,1 @@\n-            throw new Exception(\"unwrap should underflow\");\n+            throw new RuntimeException(\"unwrap should underflow\");\n@@ -257,0 +279,5 @@\n+            \/*\n+             * Exceptions are thrown when:\n+             *    - the length field is correct but the data can't be decoded.\n+             *    - the length field is larger than max allowed.\n+             *\/\n@@ -258,3 +285,5 @@\n-            throw new Exception(\"Didn't catch the nasty SSLException\");\n-        } catch (SSLException e) {\n-            System.out.println(\"caught the nasty SSLException: \" + e);\n+            throw new RuntimeException(\"Expected SSLProtocolException was not thrown \"\n+                    + \"for bad input\");\n+        } catch (SSLProtocolException e) {\n+            System.out.println(\"caught the SSLProtocolException for bad decoding: \"\n+                    + e);\n@@ -281,2 +310,2 @@\n-        \/\/ \"HELLO HELLO\"\n-        (byte) 0x48, (byte) 0x45, (byte) 0x4C, (byte) 0x4C, (byte) 0x20,\n+        \/\/ bad data but correct record length to cause decryption error\n+        (byte) 0x48, (byte) 0x45, (byte) 0x4C, (byte) 0x00, (byte) 0x04,\n","filename":"test\/jdk\/javax\/net\/ssl\/SSLEngine\/Basics.java","additions":77,"deletions":48,"binary":false,"changes":125,"status":"modified"}]}