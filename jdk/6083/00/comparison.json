{"files":[{"patch":"@@ -422,4 +422,9 @@\n-    if ((*env)->IsInstanceOf(env, jaccessible, sjc_CAccessible)) {\n-        return jaccessible;\n-    } else if ((*env)->IsInstanceOf(env, jaccessible, sjc_Accessible)) {\n-        jobject o = (*env)->CallStaticObjectMethod(env, sjc_CAccessible,  sjm_getCAccessible, jaccessible);\n+\n+    \/\/ jaccessible is a weak ref, check it's still alive\n+    jobject jaccessibleLocal = (*env)->NewLocalRef(env, jaccessible);\n+    if ((*env)->IsSameObject(env, jaccessibleLocal, NULL)) return NULL;\n+\n+    if ((*env)->IsInstanceOf(env, jaccessibleLocal, sjc_CAccessible)) {\n+        return jaccessibleLocal; \/\/ delete in the caller\n+    } else if ((*env)->IsInstanceOf(env, jaccessibleLocal, sjc_Accessible)) {\n+        jobject jCAX = (*env)->CallStaticObjectMethod(env, sjc_CAccessible,  sjm_getCAccessible, jaccessibleLocal);\n@@ -427,1 +432,2 @@\n-        return o;\n+        (*env)->DeleteLocalRef(env, jaccessibleLocal);\n+        return jCAX; \/\/ delete in the caller\n@@ -429,0 +435,1 @@\n+    (*env)->DeleteLocalRef(env, jaccessibleLocal);\n@@ -538,6 +545,4 @@\n-    if (!wrapped) { \/\/ If wrapped is true, then you don't need to get an existing instance, you need to create a new one\n-        CommonComponentAccessibility *value = (CommonComponentAccessibility *) jlong_to_ptr((*env)->GetLongField(env, jCAX, jf_ptr));\n-        if (value != nil) {\n-            (*env)->DeleteLocalRef(env, jCAX);\n-            return [[value retain] autorelease];\n-        }\n+    CommonComponentAccessibility *value = (CommonComponentAccessibility *) jlong_to_ptr((*env)->GetLongField(env, jCAX, jf_ptr));\n+    if (value != nil) {\n+        (*env)->DeleteLocalRef(env, jCAX);\n+        return [[value retain] autorelease];\n@@ -564,4 +569,1 @@\n-    \/\/ the link is removed in the wrapper\n-    if (!wrapped) {\n-        (*env)->DeleteLocalRef(env, jCAX);\n-    }\n+    (*env)->DeleteLocalRef(env, jCAX);\n","filename":"src\/java.desktop\/macosx\/native\/libawt_lwawt\/awt\/a11y\/CommonComponentAccessibility.m","additions":17,"deletions":15,"binary":false,"changes":32,"status":"modified"}]}