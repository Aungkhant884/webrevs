{"files":[{"patch":"@@ -427,0 +427,6 @@\n+    } else if (_mtlc.clip.stencilMaskGenerationInProgress == YES) {\n+        rpd.stencilAttachment.texture = _mtlc.clip.dstOps->pStencilTexture;\n+        rpd.stencilAttachment.clearStencil = 0;\n+        rpd.stencilAttachment.loadAction = _mtlc.clip.stencilMaskGenerationStarted? MTLLoadActionLoad : MTLLoadActionClear;\n+        _mtlc.clip.stencilMaskGenerationStarted = YES;\n+        rpd.stencilAttachment.storeAction = MTLStoreActionStore;\n","filename":"src\/java.desktop\/macosx\/native\/libawt_lwawt\/java2d\/metal\/EncoderManager.m","additions":6,"deletions":0,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -52,0 +52,1 @@\n+@property (readwrite ) BOOL stencilMaskGenerationStarted;\n@@ -56,0 +57,1 @@\n+@property (readonly) BMTLSDOps* dstOps;\n","filename":"src\/java.desktop\/macosx\/native\/libawt_lwawt\/java2d\/metal\/MTLClip.h","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -50,0 +50,1 @@\n+    templateStencilPipelineDesc.stencilAttachmentPixelFormat = MTLPixelFormatStencil8;\n@@ -59,0 +60,1 @@\n+    BOOL _stencilMaskGenerationStarted;\n@@ -64,0 +66,2 @@\n+@synthesize dstOps = _dstOps;\n+\n@@ -71,0 +75,1 @@\n+        _stencilMaskGenerationStarted = NO;\n@@ -146,1 +151,1 @@\n-\n+    _mtlc = mtlc;\n@@ -161,11 +166,1 @@\n-\n-        MTLRenderPassDescriptor* clearPassDescriptor = [MTLRenderPassDescriptor renderPassDescriptor];\n-        \/\/ set color buffer properties\n-        clearPassDescriptor.colorAttachments[0].texture = dstOps->pStencilData;\n-        clearPassDescriptor.colorAttachments[0].loadAction = MTLLoadActionClear;\n-        clearPassDescriptor.colorAttachments[0].clearColor = MTLClearColorMake(0.0f, 0.0f,0.0f, 0.0f);\n-\n-        id<MTLCommandBuffer> commandBuf = [mtlc createCommandBuffer];\n-        id <MTLRenderCommandEncoder> clearEncoder = [commandBuf renderCommandEncoderWithDescriptor:clearPassDescriptor];\n-        [clearEncoder endEncoding];\n-        [commandBuf commit];\n+        _dstOps = dstOps;\n@@ -193,22 +188,2 @@\n-\n-    \/\/ Now the stencil data is ready, this needs to be used while rendering further\n-    @autoreleasepool {\n-        if (_clipShapeSize.width > 0 && _clipShapeSize.height > 0) {\n-            id<MTLCommandBuffer> cb = [mtlc createCommandBuffer];\n-            id<MTLBlitCommandEncoder> blitEncoder = [cb blitCommandEncoder];\n-            [blitEncoder copyFromTexture:dstOps->pStencilData\n-                             sourceSlice:0\n-                             sourceLevel:0\n-                            sourceOrigin:_clipShapeOrigin\n-                              sourceSize:_clipShapeSize\n-                                toBuffer:dstOps->pStencilDataBuf\n-                       destinationOffset:0\n-                  destinationBytesPerRow:_clipShapeSize.width\n-                destinationBytesPerImage:_clipShapeSize.width*_clipShapeSize.height];\n-            [blitEncoder endEncoding];\n-            [cb commit];\n-        }\n-    }\n-\n-    _stencilMaskGenerationInProgress = JNI_FALSE;\n-    _mtlc = mtlc;\n+    _stencilMaskGenerationInProgress = NO;\n+    _stencilMaskGenerationStarted = NO;\n@@ -230,1 +205,2 @@\n-                                                                       fragmentShaderId:@\"frag_stencil\"];\n+                                                                       fragmentShaderId:@\"frag_stencil\"\n+                                                                          stencilNeeded:YES];\n@@ -242,0 +218,2 @@\n+    [encoder setDepthStencilState: _mtlc.stencilManager.genStencilState];\n+    [encoder setStencilReferenceValue:255];\n@@ -304,35 +282,1 @@\n-    id <MTLTexture> _stencilTextureRef = _dstOps->pStencilTexture;\n-\n-    if (!_clipReady) {\n-        @autoreleasepool {\n-\n-            MTLRenderPassDescriptor* clearPassDescriptor = [MTLRenderPassDescriptor renderPassDescriptor];\n-            \/\/ set color buffer properties\n-            clearPassDescriptor.stencilAttachment.texture = _stencilTextureRef;\n-            clearPassDescriptor.stencilAttachment.clearStencil = 0;\n-            clearPassDescriptor.stencilAttachment.loadAction = MTLLoadActionClear;\n-            clearPassDescriptor.stencilAttachment.storeAction = MTLStoreActionStore;\n-\n-            id<MTLCommandBuffer> commandBuf = [_mtlc createCommandBuffer];\n-            id <MTLRenderCommandEncoder> clearEncoder = [commandBuf renderCommandEncoderWithDescriptor:clearPassDescriptor];\n-            [clearEncoder endEncoding];\n-            [commandBuf commit];\n-\n-            id <MTLCommandBuffer> cb = [_mtlc createCommandBuffer];\n-            id <MTLBlitCommandEncoder> blitEncoder = [cb blitCommandEncoder];\n-            id <MTLBuffer> _stencilDataBufRef = _dstOps->pStencilDataBuf;\n-            [blitEncoder copyFromBuffer:_stencilDataBufRef\n-                           sourceOffset:0\n-                      sourceBytesPerRow:_clipShapeSize.width\n-                    sourceBytesPerImage:_clipShapeSize.width * _clipShapeSize.height\n-                             sourceSize:_clipShapeSize\n-                              toTexture:_stencilTextureRef\n-                       destinationSlice:0\n-                       destinationLevel:0\n-                      destinationOrigin:_clipShapeOrigin];\n-            [blitEncoder endEncoding];\n-            [cb commit];\n-            _clipReady = YES;\n-        }\n-    }\n-    return _stencilTextureRef;\n+    return _dstOps->pStencilTexture;;\n","filename":"src\/java.desktop\/macosx\/native\/libawt_lwawt\/java2d\/metal\/MTLClip.m","additions":14,"deletions":70,"binary":false,"changes":84,"status":"modified"},{"patch":"@@ -40,0 +40,1 @@\n+@property (readonly) _Nonnull id<MTLDepthStencilState> genStencilState;\n","filename":"src\/java.desktop\/macosx\/native\/libawt_lwawt\/java2d\/metal\/MTLStencilManager.h","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -33,0 +33,1 @@\n+    id<MTLDepthStencilState> _genStencilState;\n@@ -36,0 +37,1 @@\n+@synthesize genStencilState = _genStencilState;\n@@ -53,0 +55,8 @@\n+\n+        MTLDepthStencilDescriptor* genStencilDescriptor;\n+        genStencilDescriptor = [[MTLDepthStencilDescriptor new] autorelease];\n+        genStencilDescriptor.backFaceStencil.stencilCompareFunction = MTLCompareFunctionAlways;\n+        genStencilDescriptor.backFaceStencil.depthStencilPassOperation = MTLStencilOperationReplace;\n+        genStencilDescriptor.frontFaceStencil.stencilCompareFunction = MTLCompareFunctionAlways;\n+        genStencilDescriptor.frontFaceStencil.depthStencilPassOperation = MTLStencilOperationReplace;\n+        _genStencilState = [device newDepthStencilStateWithDescriptor:genStencilDescriptor];\n","filename":"src\/java.desktop\/macosx\/native\/libawt_lwawt\/java2d\/metal\/MTLStencilManager.m","additions":10,"deletions":0,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -94,4 +94,0 @@\n-        bmtlsdo->pAAStencilData = [ctx.device newTextureWithDescriptor:textureDescriptor];\n-        bmtlsdo->pStencilDataBuf = [ctx.device newBufferWithLength:width*height options:MTLResourceStorageModePrivate];\n-        bmtlsdo->pAAStencilDataBuf = [ctx.device newBufferWithLength:width*height*4 options:MTLResourceStorageModePrivate];\n-\n@@ -104,1 +100,0 @@\n-\n@@ -199,3 +194,0 @@\n-        [(NSObject *)bmtlsdo->pStencilDataBuf release];\n-        [(NSObject *)bmtlsdo->pAAStencilData release];\n-        [(NSObject *)bmtlsdo->pAAStencilDataBuf release];\n","filename":"src\/java.desktop\/macosx\/native\/libawt_lwawt\/java2d\/metal\/MTLSurfaceData.m","additions":0,"deletions":8,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -97,1 +97,0 @@\n-    void*                        pStencilDataBuf;   \/\/ MTLBuffer with stencil data\n@@ -99,2 +98,0 @@\n-    void*                        pAAStencilData;    \/\/ stencil data for AA rendering\n-    void*                        pAAStencilDataBuf; \/\/ MTLBuffer with AA stencil data\n","filename":"src\/java.desktop\/macosx\/native\/libawt_lwawt\/java2d\/metal\/MTLSurfaceDataBase.h","additions":0,"deletions":3,"binary":false,"changes":3,"status":"modified"}]}