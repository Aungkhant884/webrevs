{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2000, 2017, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -239,2 +239,2 @@\n-            \/\/ The last 2 etypes are now weak ones\n-            return Arrays.copyOfRange(result, 0, result.length - 2);\n+            \/\/ The last 4 etypes are now weak ones\n+            return Arrays.copyOfRange(result, 0, result.length - 4);\n","filename":"src\/java.security.jgss\/share\/classes\/sun\/security\/krb5\/internal\/crypto\/EType.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2010, 2018, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2010, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -48,1 +48,1 @@\n-                    \"default_tgs_enctypes=des3-cbc-sha1\");\n+                    \"default_tgs_enctypes=aes128-sha1\");\n","filename":"test\/jdk\/sun\/security\/krb5\/auto\/NewSalt.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2010, 2018, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2010, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -26,1 +26,1 @@\n- * @bug 6932525 6951366 6959292 8194486\n+ * @bug 6932525 6951366 6959292 8194486 8139348\n@@ -30,0 +30,1 @@\n+ * @compile -XDignore.symbol.file W83.java\n@@ -35,1 +36,0 @@\n-import java.io.File;\n@@ -52,1 +52,2 @@\n-        KDC.saveConfig(OneKDC.KRB5_CONF, kdc);\n+        KDC.saveConfig(OneKDC.KRB5_CONF, kdc,\n+                \"allow_weak_crypto = true\");\n","filename":"test\/jdk\/sun\/security\/krb5\/auto\/W83.java","additions":5,"deletions":4,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2010, 2013, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2010, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -25,1 +25,1 @@\n- * @bug 6844909 8012679\n+ * @bug 6844909 8012679 8139348\n@@ -34,1 +34,0 @@\n-import java.io.File;\n@@ -38,0 +37,2 @@\n+import java.util.Arrays;\n+import java.util.List;\n@@ -39,0 +40,1 @@\n+import sun.security.krb5.EncryptionKey;\n@@ -43,0 +45,8 @@\n+\n+    static List<Integer> weakOnes = List.of(\n+            EncryptedData.ETYPE_DES_CBC_CRC,\n+            EncryptedData.ETYPE_DES_CBC_MD5,\n+            EncryptedData.ETYPE_DES3_CBC_HMAC_SHA1_KD,\n+            EncryptedData.ETYPE_ARCFOUR_HMAC\n+    );\n+\n@@ -44,0 +54,1 @@\n+\n@@ -49,2 +60,5 @@\n-        boolean expected = args.length != 0 && args[0].equals(\"true\");\n-        int[] etypes = EType.getBuiltInDefaults();\n+        \/\/ expected number of supported weak etypes\n+        int expected = 0;\n+        if (args.length != 0 && args[0].equals(\"true\")) {\n+            expected = weakOnes.size();\n+        }\n@@ -52,7 +66,5 @@\n-        boolean found = false;\n-        for (int i=0, length = etypes.length; i<length; i++) {\n-            if (etypes[i] == EncryptedData.ETYPE_DES_CBC_CRC ||\n-                    etypes[i] == EncryptedData.ETYPE_DES_CBC_MD4 ||\n-                    etypes[i] == EncryptedData.ETYPE_DES_CBC_MD5) {\n-                found = true;\n-            }\n+        \/\/ Ensure EType.getBuiltInDefaults() has the correct etypes\n+        if (Arrays.stream(EType.getBuiltInDefaults())\n+                .filter(weakOnes::contains)\n+                .count() != expected) {\n+            throw new Exception(\"getBuiltInDefaults fails\");\n@@ -60,2 +72,8 @@\n-        if (expected != found) {\n-            throw new Exception();\n+\n+        \/\/ Ensure keys generated have the correct etypes\n+        if (Arrays.stream(EncryptionKey.acquireSecretKeys(\n+                    \"password\".toCharArray(), \"salt\"))\n+                .map(EncryptionKey::getEType)\n+                .filter(weakOnes::contains)\n+                .count() != expected) {\n+            throw new Exception(\"acquireSecretKeys fails\");\n","filename":"test\/jdk\/sun\/security\/krb5\/etype\/WeakCrypto.java","additions":32,"deletions":14,"binary":false,"changes":46,"status":"modified"},{"patch":"@@ -1,2 +0,0 @@\n-[libdefaults]\n-allow_weak_crypto = false\n","filename":"test\/jdk\/sun\/security\/krb5\/etype\/weakcrypto.conf","additions":0,"deletions":2,"binary":false,"changes":2,"status":"deleted"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2010, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2010, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -37,1 +37,1 @@\n- * @bug 6950546\n+ * @bug 6950546 8139348\n@@ -52,0 +52,4 @@\n+        \/\/ This test uses a krb5.conf file (onlythree.conf) in which\n+        \/\/ only 3 etypes in the default_tkt_enctypes setting are enabled\n+        \/\/ by default: aes128-cts(17), aes256-cts(18), and aes128-sha2(19).\n+\n@@ -53,1 +57,1 @@\n-        check(1,16,1,23,1,17);\n+        check(1,17,1,18,1,19);\n@@ -55,1 +59,1 @@\n-        check(0,16,0,23,0,17);\n+        check(0,17,0,18,0,19);\n@@ -57,1 +61,1 @@\n-        check(0,16,0,23,0,17,1,16,1,23,1,17);\n+        check(0,17,0,18,0,19,1,17,1,18,1,19);\n@@ -59,1 +63,1 @@\n-        check(0,16,0,23,0,17,1,16,1,23,1,17,2,16,2,23,2,17);\n+        check(0,17,0,18,0,19,1,17,1,18,1,19,2,17,2,18,2,19);\n@@ -61,1 +65,1 @@\n-        check(3,16,3,23,3,17);\n+        check(3,17,3,18,3,19);\n@@ -63,1 +67,1 @@\n-        check(3,16,3,23,3,17,4,16,4,23,4,17);\n+        check(3,17,3,18,3,19,4,17,4,18,4,19);\n@@ -65,1 +69,1 @@\n-        check(3,16,3,23,3,17,4,16,4,23,4,17,5,16,5,23,5,17);\n+        check(3,17,3,18,3,19,4,17,4,18,4,19,5,17,5,18,5,19);\n@@ -67,1 +71,1 @@\n-        check(3,16,3,23,3,17,4,16,4,23,4,17,5,16,5,23,5,17,6,16,6,23,6,17);\n+        check(3,17,3,18,3,19,4,17,4,18,4,19,5,17,5,18,5,19,6,17,6,18,6,19);\n@@ -69,3 +73,1 @@\n-        check(4,16,4,23,4,17,5,16,5,23,5,17,6,16,6,23,6,17);\n-        ktab(\"-d me -e 16 6\");\n-        check(4,16,4,23,4,17,5,16,5,23,5,17,6,23,6,17);\n+        check(4,17,4,18,4,19,5,17,5,18,5,19,6,17,6,18,6,19);\n@@ -73,3 +75,5 @@\n-        check(4,16,4,23,4,17,5,16,5,23,5,17,6,23);\n-        ktab(\"-d me -e 16 5\");\n-        check(4,16,4,23,4,17,5,23,5,17,6,23);\n+        check(4,17,4,18,4,19,5,17,5,18,5,19,6,18,6,19);\n+        ktab(\"-d me -e 19 6\");\n+        check(4,17,4,18,4,19,5,17,5,18,5,19,6,18);\n+        ktab(\"-d me -e 17 5\");\n+        check(4,17,4,18,4,19,5,18,5,19,6,18);\n@@ -77,1 +81,1 @@\n-        check(4,16,5,17,6,23);\n+        check(4,17,5,19,6,18);\n@@ -84,1 +88,1 @@\n-        check(4,16,5,17,6,23);\n+        check(4,17,5,19,6,18);\n","filename":"test\/jdk\/sun\/security\/krb5\/tools\/KtabCheck.java","additions":22,"deletions":18,"binary":false,"changes":40,"status":"modified"},{"patch":"@@ -3,1 +3,1 @@\n-default_tkt_enctypes = des3-cbc-sha1 rc4-hmac aes128-cts\n+default_tkt_enctypes = des-cbc-crc des-cbc-md5 des3-cbc-sha1 rc4-hmac aes128-cts aes256-cts aes128-sha2\n","filename":"test\/jdk\/sun\/security\/krb5\/tools\/onlythree.conf","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}