{"files":[{"patch":"@@ -5951,14 +5951,0 @@\n-instruct vshiftS_avx(vec dst, vec src, vec shift) %{\n-  predicate(VectorNode::is_vshift_cnt(n->in(2)) && UseAVX > 0);\n-  match(Set dst ( LShiftVS src shift));\n-  match(Set dst ( RShiftVS src shift));\n-  match(Set dst (URShiftVS src shift));\n-  format %{ \"vshiftw  $dst,$src,$shift\\t! shift packedS\" %}\n-  ins_encode %{\n-    int opcode = this->ideal_Opcode();\n-    int vlen_enc = vector_length_encoding(this);\n-    __ vshiftw(opcode, $dst$$XMMRegister, $src$$XMMRegister, $shift$$XMMRegister, vlen_enc);\n-  %}\n-  ins_pipe( pipe_slow );\n-%}\n-\n@@ -5966,1 +5952,1 @@\n-  predicate(VectorNode::is_vshift_cnt(n->in(2)) && UseAVX == 0);\n+  predicate(VectorNode::is_vshift_cnt(n->in(2)));\n@@ -5974,7 +5960,3 @@\n-    int vlen = vector_length(this);\n-    if (vlen == 2) {\n-      __ movflt($dst$$XMMRegister, $src$$XMMRegister);\n-      __ vshiftw(opcode, $dst$$XMMRegister, $shift$$XMMRegister);\n-    } else if (vlen == 4) {\n-      __ movdbl($dst$$XMMRegister, $src$$XMMRegister);\n-      __ vshiftw(opcode, $dst$$XMMRegister, $shift$$XMMRegister);\n+    if (UseAVX > 0) {\n+      int vlen_enc = vector_length_encoding(this);\n+      __ vshiftw(opcode, $dst$$XMMRegister, $src$$XMMRegister, $shift$$XMMRegister, vlen_enc);\n@@ -5982,3 +5964,12 @@\n-      assert (vlen == 8, \"sanity\");\n-      __ movdqu($dst$$XMMRegister, $src$$XMMRegister);\n-      __ vshiftw(opcode, $dst$$XMMRegister, $shift$$XMMRegister);\n+      int vlen = vector_length(this);\n+      if (vlen == 2) {\n+        __ movflt($dst$$XMMRegister, $src$$XMMRegister);\n+        __ vshiftw(opcode, $dst$$XMMRegister, $shift$$XMMRegister);\n+      } else if (vlen == 4) {\n+        __ movdbl($dst$$XMMRegister, $src$$XMMRegister);\n+        __ vshiftw(opcode, $dst$$XMMRegister, $shift$$XMMRegister);\n+      } else {\n+        assert (vlen == 8, \"sanity\");\n+        __ movdqu($dst$$XMMRegister, $src$$XMMRegister);\n+        __ vshiftw(opcode, $dst$$XMMRegister, $shift$$XMMRegister);\n+      }\n@@ -5991,14 +5982,0 @@\n-instruct vshiftI_avx(vec dst, vec src, vec shift) %{\n-  predicate(VectorNode::is_vshift_cnt(n->in(2)) && UseAVX > 0);\n-  match(Set dst ( LShiftVI src shift));\n-  match(Set dst ( RShiftVI src shift));\n-  match(Set dst (URShiftVI src shift));\n-  format %{ \"vshiftd  $dst,$src,$shift\\t! shift packedI\" %}\n-  ins_encode %{\n-    int opcode = this->ideal_Opcode();\n-    int vlen_enc = vector_length_encoding(this);\n-    __ vshiftd(opcode, $dst$$XMMRegister, $src$$XMMRegister, $shift$$XMMRegister, vlen_enc);\n-  %}\n-  ins_pipe( pipe_slow );\n-%}\n-\n@@ -6006,1 +5983,1 @@\n-  predicate(VectorNode::is_vshift_cnt(n->in(2)) && UseAVX == 0);\n+  predicate(VectorNode::is_vshift_cnt(n->in(2)));\n@@ -6014,4 +5991,3 @@\n-    int vlen = vector_length(this);\n-    if (vlen == 2) {\n-      __ movdbl($dst$$XMMRegister, $src$$XMMRegister);\n-      __ vshiftd(opcode, $dst$$XMMRegister, $shift$$XMMRegister);\n+    if (UseAVX > 0) {\n+      int vlen_enc = vector_length_encoding(this);\n+      __ vshiftd(opcode, $dst$$XMMRegister, $src$$XMMRegister, $shift$$XMMRegister, vlen_enc);\n@@ -6019,3 +5995,9 @@\n-      assert(vlen == 4, \"sanity\");\n-      __ movdqu($dst$$XMMRegister, $src$$XMMRegister);\n-      __ vshiftd(opcode, $dst$$XMMRegister, $shift$$XMMRegister);\n+      int vlen = vector_length(this);\n+      if (vlen == 2) {\n+        __ movdbl($dst$$XMMRegister, $src$$XMMRegister);\n+        __ vshiftd(opcode, $dst$$XMMRegister, $shift$$XMMRegister);\n+      } else {\n+        assert(vlen == 4, \"sanity\");\n+        __ movdqu($dst$$XMMRegister, $src$$XMMRegister);\n+        __ vshiftd(opcode, $dst$$XMMRegister, $shift$$XMMRegister);\n+      }\n@@ -6054,13 +6036,0 @@\n-instruct vshiftL_avx(vec dst, vec src, vec shift) %{\n-  predicate(VectorNode::is_vshift_cnt(n->in(2)) && UseAVX > 0);\n-  match(Set dst ( LShiftVL src shift));\n-  match(Set dst (URShiftVL src shift));\n-  format %{ \"vshiftq  $dst,$src,$shift\\t! shift packedL\" %}\n-  ins_encode %{\n-    int opcode = this->ideal_Opcode();\n-    int vlen_enc = vector_length_encoding(this);\n-    __ vshiftq(opcode, $dst$$XMMRegister, $src$$XMMRegister, $shift$$XMMRegister, vlen_enc);\n-  %}\n-  ins_pipe( pipe_slow );\n-%}\n-\n@@ -6068,1 +6037,1 @@\n-  predicate(VectorNode::is_vshift_cnt(n->in(2)) && UseAVX == 0);\n+  predicate(VectorNode::is_vshift_cnt(n->in(2)));\n@@ -6075,3 +6044,8 @@\n-    assert(vector_length(this) == 2, \"\");\n-    __ movdqu($dst$$XMMRegister, $src$$XMMRegister);\n-    __ vshiftq(opcode, $dst$$XMMRegister, $shift$$XMMRegister);\n+    if (UseAVX > 0) {\n+      int vlen_enc = vector_length_encoding(this);\n+      __ vshiftq(opcode, $dst$$XMMRegister, $src$$XMMRegister, $shift$$XMMRegister, vlen_enc);\n+    } else {\n+      assert(vector_length(this) == 2, \"\");\n+      __ movdqu($dst$$XMMRegister, $src$$XMMRegister);\n+      __ vshiftq(opcode, $dst$$XMMRegister, $shift$$XMMRegister);\n+    }\n","filename":"src\/hotspot\/cpu\/x86\/x86.ad","additions":38,"deletions":64,"binary":false,"changes":102,"status":"modified"}]}