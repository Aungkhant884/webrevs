{"files":[{"patch":"@@ -586,1 +586,4 @@\n-  release_C_heap_structures_internal();\n+  \/\/ Can't release the constant pool here because the constant pool can be\n+  \/\/ deallocated separately from the InstanceKlass for default methods and\n+  \/\/ redefine classes.\n+  release_C_heap_structures(\/* release_constant_pool *\/ false);\n@@ -1641,1 +1644,2 @@\n-  if (!is_loaded()) {\n+  \/\/ Redefined scratch classes are on the list and need to be cleaned\n+  if (!is_loaded() && !is_scratch_class()) {\n@@ -2684,2 +2688,2 @@\n-void InstanceKlass::release_C_heap_structures() {\n-\n+\/\/ Called also by InstanceKlass::deallocate_contents, with false for release_constant_pool.\n+void InstanceKlass::release_C_heap_structures(bool release_constant_pool) {\n@@ -2687,2 +2691,4 @@\n-  release_C_heap_structures_internal();\n-  constants()->release_C_heap_structures();\n+  Klass::release_C_heap_structures();\n+  if (release_constant_pool) {\n+    constants()->release_C_heap_structures();\n+  }\n@@ -2692,8 +2698,0 @@\n-}\n-\n-void InstanceKlass::release_C_heap_structures_internal() {\n-  Klass::release_C_heap_structures();\n-\n-  \/\/ Can't release the constant pool here because the constant pool can be\n-  \/\/ deallocated separately from the InstanceKlass for default methods and\n-  \/\/ redefine classes.\n@@ -3991,2 +3989,0 @@\n-      \/\/ For debugging purposes.\n-      pv_node->set_is_scratch_class();\n@@ -4107,2 +4103,0 @@\n-    \/\/ For debugging purposes.\n-    scratch_class->set_is_scratch_class();\n","filename":"src\/hotspot\/share\/oops\/instanceKlass.cpp","additions":12,"deletions":18,"binary":false,"changes":30,"status":"modified"},{"patch":"@@ -1104,1 +1104,1 @@\n-  virtual void release_C_heap_structures();\n+  virtual void release_C_heap_structures(bool release_constant_pool = true);\n@@ -1221,3 +1221,0 @@\n-  \/\/ Free CHeap allocated fields.\n-  void release_C_heap_structures_internal();\n-\n","filename":"src\/hotspot\/share\/oops\/instanceKlass.hpp","additions":1,"deletions":4,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -108,1 +108,1 @@\n-void Klass::release_C_heap_structures() {\n+void Klass::release_C_heap_structures(bool release_constant_pool) {\n","filename":"src\/hotspot\/share\/oops\/klass.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -664,1 +664,1 @@\n-  virtual void release_C_heap_structures();\n+  virtual void release_C_heap_structures(bool release_constant_pool = true);\n","filename":"src\/hotspot\/share\/oops\/klass.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -4407,0 +4407,3 @@\n+  \/\/ Scratch class is unloaded but still needs cleaning, and skipping for CDS.\n+  scratch_class->set_is_scratch_class();\n+\n","filename":"src\/hotspot\/share\/prims\/jvmtiRedefineClasses.cpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"}]}