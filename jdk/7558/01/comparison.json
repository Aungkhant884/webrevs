{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2021, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -41,0 +41,1 @@\n+import java.util.Locale;\n@@ -49,2 +50,3 @@\n- * @bug 8231640\n- * @run testng PropertiesStoreTest\n+ * @bug 8231640 8282023\n+ * @modules jdk.localedata\n+ * @run testng\/othervm PropertiesStoreTest\n@@ -55,0 +57,5 @@\n+    \/\/ use a neutral locale, since when the date comment was written by Properties.store(...),\n+    \/\/ it internally calls the Date.toString() which always writes in a locale insensitive manner\n+    private static final DateTimeFormatter formatter = DateTimeFormatter.ofPattern(DATE_FORMAT_PATTERN)\n+            .withLocale(Locale.ROOT);\n+    private static final Locale prevLocale = Locale.getDefault();\n@@ -94,0 +101,30 @@\n+    \/**\n+     * Returns a {@link Locale} to use for testing\n+     *\/\n+    @DataProvider(name = \"localeProvider\")\n+    private Object[][] provideLocales() {\n+        \/\/ pick a non-english locale for testing\n+        Locale nonEnglishLocale = null;\n+        for (Locale locale : Locale.getAvailableLocales()) {\n+            \/\/ skip ROOT locale and ENGLISH language ones\n+            if (!locale.getLanguage().isEmpty() && !locale.getLanguage().equals(\"en\")) {\n+                nonEnglishLocale = locale;\n+                System.out.println(\"Selected non-english locale: \" + nonEnglishLocale + \" for tests\");\n+                break;\n+            }\n+        }\n+        if (nonEnglishLocale == null) {\n+            return new Object[][] {\n+                {Locale.getDefault()},\n+                {Locale.US}, \/\/ guaranteed to be present\n+                {Locale.ROOT}, \/\/ guaranteed to be present\n+            };\n+        }\n+        return new Object[][]{\n+                {Locale.getDefault()},\n+                {Locale.US}, \/\/ guaranteed to be present\n+                {Locale.ROOT}, \/\/ guaranteed to be present\n+                {nonEnglishLocale}\n+        };\n+    }\n+\n@@ -156,7 +193,16 @@\n-    @Test\n-    public void testStoreWriterDateComment() throws Exception {\n-        final Properties props = new Properties();\n-        props.setProperty(\"a\", \"b\");\n-        final Path tmpFile = Files.createTempFile(\"8231640\", \"props\");\n-        try (final Writer writer = Files.newBufferedWriter(tmpFile)) {\n-            props.store(writer, null);\n+    @Test(dataProvider = \"localeProvider\")\n+    public void testStoreWriterDateComment(final Locale testLocale) throws Exception {\n+        \/\/ switch the default locale to the one being tested\n+        Locale.setDefault(testLocale);\n+        System.out.println(\"Using locale: \" + testLocale + \" for Properties#store(Writer) test\");\n+        try {\n+            final Properties props = new Properties();\n+            props.setProperty(\"a\", \"b\");\n+            final Path tmpFile = Files.createTempFile(\"8231640\", \"props\");\n+            try (final Writer writer = Files.newBufferedWriter(tmpFile)) {\n+                props.store(writer, null);\n+            }\n+            testDateComment(tmpFile);\n+        } finally {\n+            \/\/ reset to the previous one\n+            Locale.setDefault(prevLocale);\n@@ -164,1 +210,0 @@\n-        testDateComment(tmpFile);\n@@ -170,7 +215,16 @@\n-    @Test\n-    public void testStoreOutputStreamDateComment() throws Exception {\n-        final Properties props = new Properties();\n-        props.setProperty(\"a\", \"b\");\n-        final Path tmpFile = Files.createTempFile(\"8231640\", \"props\");\n-        try (final Writer writer = Files.newBufferedWriter(tmpFile)) {\n-            props.store(writer, null);\n+    @Test(dataProvider = \"localeProvider\")\n+    public void testStoreOutputStreamDateComment(final Locale testLocale) throws Exception {\n+        \/\/ switch the default locale to the one being tested\n+        Locale.setDefault(testLocale);\n+        System.out.println(\"Using locale: \" + testLocale + \" for Properties#store(OutputStream) test\");\n+        try {\n+            final Properties props = new Properties();\n+            props.setProperty(\"a\", \"b\");\n+            final Path tmpFile = Files.createTempFile(\"8231640\", \"props\");\n+            try (final Writer writer = Files.newBufferedWriter(tmpFile)) {\n+                props.store(writer, null);\n+            }\n+            testDateComment(tmpFile);\n+        } finally {\n+            \/\/ reset to the previous one\n+            Locale.setDefault(prevLocale);\n@@ -178,1 +232,0 @@\n-        testDateComment(tmpFile);\n@@ -202,1 +255,1 @@\n-            DateTimeFormatter.ofPattern(DATE_FORMAT_PATTERN).parse(comment);\n+            formatter.parse(comment);\n","filename":"test\/jdk\/java\/util\/Properties\/PropertiesStoreTest.java","additions":73,"deletions":20,"binary":false,"changes":93,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2021, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -47,1 +47,1 @@\n- * @bug 8231640\n+ * @bug 8231640 8282023\n@@ -428,1 +428,1 @@\n-            Instant instant = Instant.from(DateTimeFormatter.ofPattern(DATE_FORMAT_PATTERN).parse(dateComment));\n+            Instant instant = Instant.from(reproducibleDateTimeFormatter.parse(dateComment));\n@@ -431,1 +431,1 @@\n-            throw new RuntimeException(\"Unexpected date \" + dateComment + \" in stored properties \" + destFile);\n+            throw new RuntimeException(\"Unexpected date \" + dateComment + \" in stored properties \" + destFile, pe);\n","filename":"test\/jdk\/java\/util\/Properties\/StoreReproducibilityTest.java","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"}]}