{"files":[{"patch":"@@ -44,1 +44,0 @@\n-  G1RedirtyCardsQueue* _rdcq;\n@@ -52,2 +51,1 @@\n-  UpdateLogBuffersDeferred(G1RedirtyCardsLocalQueueSet* rdc_local_qset,\n-                           G1RedirtyCardsQueue* rdcq) :\n+  UpdateLogBuffersDeferred(G1RedirtyCardsLocalQueueSet* rdc_local_qset) :\n@@ -56,1 +54,0 @@\n-    _rdcq(rdcq),\n@@ -76,1 +73,1 @@\n-      _rdc_local_qset->enqueue(*_rdcq, _ct->byte_for_index(card_index));\n+      _rdc_local_qset->enqueue(_ct->byte_for_index(card_index));\n@@ -209,1 +206,0 @@\n-  G1RedirtyCardsQueue _rdcq;\n@@ -217,2 +213,1 @@\n-    _rdcq(&_rdc_local_qset),\n-    _log_buffer_cl(&_rdc_local_qset, &_rdcq) {\n+    _log_buffer_cl(&_rdc_local_qset) {\n@@ -222,1 +217,0 @@\n-    _rdc_local_qset.flush_queue(_rdcq);\n","filename":"src\/hotspot\/share\/gc\/g1\/g1EvacFailure.cpp","additions":3,"deletions":9,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -62,1 +62,0 @@\n-    _rdcq(&_rdc_local_qset),\n@@ -117,1 +116,0 @@\n-  _rdc_local_qset.flush_queue(_rdcq);\n","filename":"src\/hotspot\/share\/gc\/g1\/g1ParScanThreadState.cpp","additions":0,"deletions":2,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -52,1 +52,0 @@\n-  G1RedirtyCardsQueue _rdcq;\n@@ -151,1 +150,1 @@\n-      _rdc_local_qset.enqueue(_rdcq, ct()->byte_for_index(card_index));\n+      _rdc_local_qset.enqueue(ct()->byte_for_index(card_index));\n","filename":"src\/hotspot\/share\/gc\/g1\/g1ParScanThreadState.hpp","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -36,1 +36,2 @@\n-  _buffers()\n+  _buffers(),\n+  _queue(this)\n@@ -56,3 +57,3 @@\n-void G1RedirtyCardsLocalQueueSet::enqueue(G1RedirtyCardsQueue& queue, void* value) {\n-  if (!try_enqueue(queue, value)) {\n-    BufferNode* old_node = exchange_buffer_with_new(queue);\n+void G1RedirtyCardsLocalQueueSet::enqueue(void* value) {\n+  if (!try_enqueue(_queue, value)) {\n+    BufferNode* old_node = exchange_buffer_with_new(_queue);\n@@ -62,1 +63,1 @@\n-    retry_enqueue(queue, value);\n+    retry_enqueue(_queue, value);\n@@ -67,0 +68,1 @@\n+  flush_queue(_queue);\n@@ -71,5 +73,1 @@\n-void G1RedirtyCardsLocalQueueSet::flush_queue(G1RedirtyCardsQueue& queue) {\n-  PtrQueueSet::flush_queue(queue);\n-}\n-\n-\/\/ G1RedirtyCardsQueue\n+\/\/ G1RedirtyCardsLocalQueueSet::Queue\n@@ -77,1 +75,1 @@\n-G1RedirtyCardsQueue::G1RedirtyCardsQueue(G1RedirtyCardsLocalQueueSet* qset) :\n+G1RedirtyCardsLocalQueueSet::Queue::Queue(G1RedirtyCardsLocalQueueSet* qset) :\n@@ -82,1 +80,1 @@\n-G1RedirtyCardsQueue::~G1RedirtyCardsQueue() {\n+G1RedirtyCardsLocalQueueSet::Queue::~Queue() {\n","filename":"src\/hotspot\/share\/gc\/g1\/g1RedirtyCardsQueue.cpp","additions":10,"deletions":12,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -31,0 +31,1 @@\n+#include \"utilities\/macros.hpp\"\n@@ -32,1 +33,0 @@\n-class G1RedirtyCardsQueue;\n@@ -35,4 +35,9 @@\n-\/\/ Provide G1RedirtyCardsQueue with a thread-local qset.  It provides an\n-\/\/ uncontended staging area for completed buffers, to be flushed to the\n-\/\/ shared qset en masse.\n-class G1RedirtyCardsLocalQueueSet : public PtrQueueSet {\n+\/\/ A thread-local qset and queue.  It provides an uncontended staging\n+\/\/ area for completed buffers, to be flushed to the shared qset en masse.\n+class G1RedirtyCardsLocalQueueSet : private PtrQueueSet {\n+  class Queue : public PtrQueue {\n+  public:\n+    Queue(G1RedirtyCardsLocalQueueSet* qset);\n+    ~Queue() NOT_DEBUG(= default);\n+  };\n+\n@@ -41,0 +46,4 @@\n+  Queue _queue;\n+\n+  \/\/ Add the buffer to the local list.\n+  virtual void enqueue_completed_buffer(BufferNode* node);\n@@ -46,4 +55,1 @@\n-  void enqueue(G1RedirtyCardsQueue& queue, void* value);\n-\n-  \/\/ Add the buffer to the local list.\n-  virtual void enqueue_completed_buffer(BufferNode* node);\n+  void enqueue(void* value);\n@@ -53,9 +59,0 @@\n-\n-  void flush_queue(G1RedirtyCardsQueue& queue);\n-};\n-\n-\/\/ Worker-local queues of card table entries.\n-class G1RedirtyCardsQueue : public PtrQueue {\n-public:\n-  G1RedirtyCardsQueue(G1RedirtyCardsLocalQueueSet* qset);\n-  ~G1RedirtyCardsQueue() NOT_DEBUG(= default);\n","filename":"src\/hotspot\/share\/gc\/g1\/g1RedirtyCardsQueue.hpp","additions":15,"deletions":18,"binary":false,"changes":33,"status":"modified"}]}