{"files":[{"patch":"@@ -372,0 +372,7 @@\n+void ClassLoaderDataGraph::loaded_cld_do_no_keepalive(CLDClosure* cl) {\n+  ClassLoaderDataGraphIteratorNoKeepAlive iter;\n+  while (ClassLoaderData* cld = iter.get_next()) {\n+    cl->do_cld(cld);\n+  }\n+}\n+\n","filename":"src\/hotspot\/share\/classfile\/classLoaderDataGraph.cpp","additions":7,"deletions":0,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -77,0 +77,1 @@\n+  static void loaded_cld_do_no_keepalive(CLDClosure* cl);\n","filename":"src\/hotspot\/share\/classfile\/classLoaderDataGraph.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -49,1 +49,4 @@\n-  oop cl = cld->class_loader();\n+  \/\/ Class loaders are not kept alive so this closure must only be\n+  \/\/ used during a safepoint.\n+  assert_at_safepoint();\n+  oop cl = cld->class_loader_no_keepalive();\n@@ -66,1 +69,1 @@\n-    cls->_parent = java_lang_ClassLoader::parent(cl);\n+    cls->_parent = java_lang_ClassLoader::parent_no_keepalive(cl);\n@@ -152,1 +155,1 @@\n-      cls->_parent = java_lang_ClassLoader::parent(cl);\n+      cls->_parent = java_lang_ClassLoader::parent_no_keepalive(cl);\n@@ -157,1 +160,1 @@\n-    cl = java_lang_ClassLoader::parent(cl);\n+    cl = java_lang_ClassLoader::parent_no_keepalive(cl);\n@@ -164,1 +167,1 @@\n-  ClassLoaderDataGraph::loaded_cld_do(&clsc);\n+  ClassLoaderDataGraph::loaded_cld_do_no_keepalive(&clsc);\n","filename":"src\/hotspot\/share\/classfile\/classLoaderStats.cpp","additions":8,"deletions":5,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -4672,0 +4672,5 @@\n+oop java_lang_ClassLoader::parent_no_keepalive(oop loader) {\n+  assert(is_instance(loader), \"loader must be oop\");\n+  return loader->obj_field_access<AS_NO_KEEPALIVE>(_parent_offset);\n+}\n+\n","filename":"src\/hotspot\/share\/classfile\/javaClasses.cpp","additions":5,"deletions":0,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -1479,0 +1479,1 @@\n+  static oop parent_no_keepalive(oop loader);\n","filename":"src\/hotspot\/share\/classfile\/javaClasses.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -33,0 +33,1 @@\n+#include \"classfile\/classLoaderStats.hpp\"\n@@ -1824,0 +1825,6 @@\n+WB_ENTRY(void, WB_ForceClassLoaderStatsSafepoint(JNIEnv* env, jobject wb))\n+  nullStream dev_null;\n+  ClassLoaderStatsVMOperation force_op(&dev_null);\n+  VMThread::execute(&force_op);\n+WB_END\n+\n@@ -2680,0 +2687,1 @@\n+  {CC\"forceClassLoaderStatsSafepoint\", CC\"()V\",       (void*)&WB_ForceClassLoaderStatsSafepoint },\n","filename":"src\/hotspot\/share\/prims\/whitebox.cpp","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -0,0 +1,152 @@\n+\/*\n+ * Copyright (c) 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/*\n+ * @test Make sure class unloading occur even if ClassLoaderStats VM operations are executed\n+ * @bug 8297427\n+ * @requires vm.opt.final.ClassUnloading\n+ * @modules java.base\/jdk.internal.misc\n+ * @library \/test\/lib classes\n+ * @build jdk.test.whitebox.WhiteBox test.Empty test.LoadInParent test.LoadInChild\n+ * @run driver jdk.test.lib.helpers.ClassFileInstaller jdk.test.whitebox.WhiteBox\n+ * @run main\/othervm -Xbootclasspath\/a:. -XX:+UnlockDiagnosticVMOptions -XX:+WhiteBoxAPI -Xlog:gc*,class+unload=debug UnloadTestDuringClassLoaderStatsVMOperation\n+ *\/\n+import java.lang.ref.Reference;\n+import java.net.URLClassLoader;\n+\n+import jdk.test.lib.classloader.ClassUnloadCommon;\n+import jdk.test.whitebox.WhiteBox;\n+\n+public class UnloadTestDuringClassLoaderStatsVMOperation {\n+    private static final WhiteBox wb = WhiteBox.getWhiteBox();\n+\n+    private static String className = \"test.Empty\";\n+    private static String parentClassName = \"test.LoadInParent\";\n+    private static String childClassName = \"test.LoadInChild\";\n+\n+    public static void main(String args[]) throws Exception {\n+        \/\/ Create a thread forcing ClassLoaderStats VM operations.\n+        var clsThread = new Thread(() -> {\n+            while (true) {\n+                wb.forceClassLoaderStatsSafepoint();\n+            }\n+        });\n+        clsThread.setDaemon(true);\n+        clsThread.start();\n+\n+        \/\/ Make sure classes can be unloaded even though the class loader\n+        \/\/ stats VM operation is running.\n+        testClassIsUnloaded();\n+        testClassLoadedInParentIsUnloaded();\n+    }\n+\n+    public static void testClassIsUnloaded() throws Exception {\n+        ClassUnloadCommon.failIf(wb.isClassAlive(className), className + \" is not expected to be alive yet\");\n+\n+        \/\/ Load a test class and verify that it gets unloaded once we do a major collection.\n+        var classLoader = ClassUnloadCommon.newClassLoader();\n+        var loaded = classLoader.loadClass(className);\n+        var object = loaded.getDeclaredConstructor().newInstance();\n+\n+        ClassUnloadCommon.failIf(!wb.isClassAlive(className), className + \" should be loaded and live\");\n+\n+        \/\/ Using reachabilityFence() to ensure the object is live. If the test\n+        \/\/ is run with -Xcomp and ergonomically triggered GCs occur the class\n+        \/\/ could otherwise be unloaded before verified to be alive above.\n+        Reference.reachabilityFence(object);\n+\n+        System.out.println(\"testClassIsUnloaded loaded klass: \" + className);\n+\n+        \/\/ Make class unloadable.\n+        classLoader = null;\n+        loaded = null;\n+        object = null;\n+\n+        \/\/ Full\/Major collection should always unload classes.\n+        wb.fullGC();\n+        ClassUnloadCommon.failIf(wb.isClassAlive(className), className + \" should have been unloaded\");\n+    }\n+\n+    public static void testClassLoadedInParentIsUnloaded() throws Exception {\n+        ClassUnloadCommon.failIf(wb.isClassAlive(parentClassName), parentClassName + \" is not expected to be alive yet\");\n+        ClassUnloadCommon.failIf(wb.isClassAlive(childClassName), childClassName + \" is not expected to be alive yet\");\n+\n+        \/\/ Create two class loaders and load a test class in the parent and\n+        \/\/ verify that it gets unloaded once we do a major collection.\n+        var parentClassLoader = ClassUnloadCommon.newClassLoader();\n+        var childClassLoader =  new ChildURLClassLoader((URLClassLoader) parentClassLoader);\n+        var loadedParent = parentClassLoader.loadClass(parentClassName);\n+        var loadedChild = childClassLoader.loadClass(childClassName);\n+        var parent = loadedParent.getDeclaredConstructor().newInstance();\n+        var child = loadedChild.getDeclaredConstructor().newInstance();\n+\n+        ClassUnloadCommon.failIf(!wb.isClassAlive(parentClassName), parentClassName + \" should be loaded and live\");\n+        ClassUnloadCommon.failIf(!wb.isClassAlive(childClassName), childClassName + \" should be loaded and live\");\n+\n+        \/\/ Using reachabilityFence() to ensure the objects are live. If the test\n+        \/\/ is run with -Xcomp and ergonomically triggered GCs occur they could\n+        \/\/ otherwise be unloaded before verified to be alive above.\n+        Reference.reachabilityFence(parent);\n+        Reference.reachabilityFence(child);\n+\n+        System.out.println(\"testClassLoadedInParentIsUnloaded loaded klass: \" + loadedParent);\n+        System.out.println(\"testClassLoadedInParentIsUnloaded loaded klass: \" + loadedChild);\n+\n+        \/\/ Clear to allow unloading.\n+        parentClassLoader = null;\n+        childClassLoader = null;\n+        loadedParent = null;\n+        loadedChild = null;\n+        parent = null;\n+        child = null;\n+\n+        \/\/ Full\/Major collection should always unload classes.\n+        wb.fullGC();\n+        ClassUnloadCommon.failIf(wb.isClassAlive(parentClassName), parentClassName + \" should have been unloaded\");\n+        ClassUnloadCommon.failIf(wb.isClassAlive(childClassName), childClassName + \" should have been unloaded\");\n+    }\n+\n+    static class ChildURLClassLoader extends URLClassLoader {\n+        public ChildURLClassLoader(URLClassLoader parent) {\n+            super(\"ChildURLClassLoader\", parent.getURLs(), parent);\n+        }\n+\n+        @Override\n+        public Class<?> loadClass(String cn, boolean resolve) throws ClassNotFoundException {\n+            synchronized (getClassLoadingLock(cn)) {\n+                Class<?> c = findLoadedClass(cn);\n+                if (c == null) {\n+                    try {\n+                        c = findClass(cn);\n+                    } catch (ClassNotFoundException e) {\n+                        c = getParent().loadClass(cn);\n+                    }\n+                }\n+                if (resolve) {\n+                    resolveClass(c);\n+                }\n+                return c;\n+            }\n+        }\n+    }\n+}\n","filename":"test\/hotspot\/jtreg\/runtime\/ClassUnload\/UnloadTestDuringClassLoaderStatsVMOperation.java","additions":152,"deletions":0,"binary":false,"changes":152,"status":"added"},{"patch":"@@ -0,0 +1,29 @@\n+\/*\n+ * Copyright (c) 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\n+ *\/\n+\n+package test;\n+\n+public class LoadInChild {\n+    public String toString() { return \"Load In Child\"; }\n+}\n","filename":"test\/hotspot\/jtreg\/runtime\/ClassUnload\/classes\/test\/LoadInChild.java","additions":29,"deletions":0,"binary":false,"changes":29,"status":"added"},{"patch":"@@ -0,0 +1,29 @@\n+\/*\n+ * Copyright (c) 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\n+ *\/\n+\n+package test;\n+\n+public class LoadInParent {\n+    public String toString() { return \"Load In Parent\"; }\n+}\n","filename":"test\/hotspot\/jtreg\/runtime\/ClassUnload\/classes\/test\/LoadInParent.java","additions":29,"deletions":0,"binary":false,"changes":29,"status":"added"},{"patch":"@@ -124,0 +124,2 @@\n+  public native void forceClassLoaderStatsSafepoint();\n+\n","filename":"test\/lib\/jdk\/test\/whitebox\/WhiteBox.java","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"}]}