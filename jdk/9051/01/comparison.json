{"files":[{"patch":"@@ -24,0 +24,3 @@\n+import java.lang.ref.Reference;\n+import java.lang.ref.WeakReference;\n+\n@@ -26,1 +29,1 @@\n-\/*\n+\/**\n@@ -30,1 +33,3 @@\n- * @run main\/othervm -Xmx10M TestTitledBorderLeak\n+ * @library \/javax\/swing\/regtesthelpers\n+ * @build Util\n+ * @run main\/timeout=60\/othervm -mx32m TestTitledBorderLeak\n@@ -32,16 +37,1 @@\n-public class TestTitledBorderLeak {\n-    public static void main(String[] args) throws Exception {\n-        int max = 100000;\n-        long initialFreeMemory = 0L;\n-        long currentFreeMemory;\n-        try {\n-            for (int i = 1; i <= max; i++) {\n-                new TitledBorder(\"\");\n-                if ((i % 1000) == 0) {\n-                    System.gc();\n-                    currentFreeMemory = dumpMemoryStatus(\"After \" + i);\n-                    if(initialFreeMemory == 0L) {\n-                        initialFreeMemory = currentFreeMemory;\n-                    } else if( currentFreeMemory < initialFreeMemory\/2) {\n-                        throw new RuntimeException(\"Memory halved: there's a leak\");\n-                    }\n+public final class TestTitledBorderLeak {\n@@ -49,6 +39,6 @@\n-                }\n-            }\n-        }catch(OutOfMemoryError e) {\n-            \/\/ Don't think it would work; should not happen\n-            System.gc();\n-            throw new RuntimeException(\"There was OOM\");\n+    public static void main(String[] args) throws Exception {\n+        Reference<TitledBorder> border = getTitleBorder();\n+        int attempt = 0;\n+        while (border.get() != null) {\n+            Util.generateOOME();\n+            System.out.println(\"Not freed, attempt: \" + attempt++);\n@@ -56,1 +46,0 @@\n-        System.out.println(\"Passed\");\n@@ -58,5 +47,4 @@\n-    private static long dumpMemoryStatus(String msg) {\n-        Runtime rt = Runtime.getRuntime();\n-        long freeMem = rt.freeMemory();\n-        System.out.println(msg + \": \" + freeMem + \" free\");\n-        return freeMem;\n+\n+    private static Reference<TitledBorder> getTitleBorder() {\n+        TitledBorder tb = new TitledBorder(\"\");\n+        return new WeakReference<>(tb);\n@@ -65,1 +53,0 @@\n-\n","filename":"test\/jdk\/javax\/swing\/border\/TestTitledBorderLeak.java","additions":18,"deletions":31,"binary":false,"changes":49,"status":"modified"}]}