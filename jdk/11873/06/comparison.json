{"files":[{"patch":"@@ -0,0 +1,32 @@\n+-g\n+-Xlint:all\n+-source\n+21\n+-target\n+21\n+-implicit:none\n+-Xprefer:source\n+-XDignore.symbol.file=true\n+-encoding\n+ascii\n+-Werror\n+-Xdoclint:all\/protected\n+-Xdoclint\/package:java.*,javax.*\n+-XDstringConcat=inline\n+--module-source-path\n+\/Users\/bpb\/Work\/CoreLibs\/jdk\/git\/jdk\/build\/NewDirectByteBuffer-8299684\/support\/gensrc\/*:\/Users\/bpb\/Work\/CoreLibs\/jdk\/git\/jdk\/closed\/src\/*\/macosx\/classes:\/Users\/bpb\/Work\/CoreLibs\/jdk\/git\/jdk\/open\/src\/*\/macosx\/classes:\/Users\/bpb\/Work\/CoreLibs\/jdk\/git\/jdk\/closed\/src\/*\/unix\/classes:\/Users\/bpb\/Work\/CoreLibs\/jdk\/git\/jdk\/open\/src\/*\/unix\/classes:\/Users\/bpb\/Work\/CoreLibs\/jdk\/git\/jdk\/closed\/src\/*\/share\/classes:\/Users\/bpb\/Work\/CoreLibs\/jdk\/git\/jdk\/open\/src\/*\/share\/classes\n+--module-path\n+\n+--system\n+none\n+-classpath\n+\/Users\/bpb\/Work\/CoreLibs\/jdk\/git\/jdk\/build\/NewDirectByteBuffer-8299684\/buildtools\/depend\n+\"-Xplugin:depend \/Users\/bpb\/Work\/CoreLibs\/jdk\/git\/jdk\/build\/NewDirectByteBuffer-8299684\/jdk\/modules\/java.base\/_the.java.base_pubapi\"\n+-XDinternalAPIPath=\/Users\/bpb\/Work\/CoreLibs\/jdk\/git\/jdk\/build\/NewDirectByteBuffer-8299684\/jdk\/modules\/java.base\/_the.java.base_internalapi\n+-XDLOG_LEVEL=warn\n+-XDmodifiedInputs=\/Users\/bpb\/Work\/CoreLibs\/jdk\/git\/jdk\/build\/NewDirectByteBuffer-8299684\/jdk\/modules\/java.base\/_the.java.base_batch.modfiles.fixed\n+-d\n+\/Users\/bpb\/Work\/CoreLibs\/jdk\/git\/jdk\/build\/NewDirectByteBuffer-8299684\/jdk\/modules\n+-h\n+\/Users\/bpb\/Work\/CoreLibs\/jdk\/git\/jdk\/build\/NewDirectByteBuffer-8299684\/support\/headers.java.base.tmp\n+@\/Users\/bpb\/Work\/CoreLibs\/jdk\/git\/jdk\/build\/NewDirectByteBuffer-8299684\/jdk\/modules\/java.base\/_the.java.base_batch.filelist\n","filename":"make\/javac.20230111_091339.args","additions":32,"deletions":0,"binary":false,"changes":32,"status":"added"},{"patch":"@@ -2,1 +2,1 @@\n-# Copyright (c) 2015, 2022, Oracle and\/or its affiliates. All rights reserved.\n+# Copyright (c) 2015, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -81,0 +81,1 @@\n+  BUILD_JDK_JTREG_LIBRARIES_LIBS_libNewDirectByteBuffer := $(WIN_LIB_JAVA)\n@@ -84,0 +85,1 @@\n+  BUILD_JDK_JTREG_LIBRARIES_LIBS_libNewDirectByteBuffer := -ljava\n","filename":"make\/test\/JtregNativeJdk.gmk","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1997, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1997, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -2995,1 +2995,1 @@\n-    directByteBufferConstructor = env->GetMethodID(directByteBufferClass, \"<init>\", \"(JI)V\");\n+    directByteBufferConstructor = env->GetMethodID(directByteBufferClass, \"<init>\", \"(JJ)V\");\n@@ -3047,4 +3047,1 @@\n-  \/\/ NOTE that package-private DirectByteBuffer constructor currently\n-  \/\/ takes int capacity\n-  jint  cap  = (jint)  capacity;\n-  jobject ret = env->NewObject(directByteBufferClass, directByteBufferConstructor, addr, cap);\n+  jobject ret = env->NewObject(directByteBufferClass, directByteBufferConstructor, addr, capacity);\n","filename":"src\/hotspot\/share\/prims\/jni.cpp","additions":3,"deletions":6,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2000, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -181,0 +181,1 @@\n+    \/\/ The long-valued capacity is restricted to int range.\n@@ -182,2 +183,2 @@\n-    private Direct$Type$Buffer(long addr, int cap) {\n-        super(-1, 0, cap, cap, null);\n+    private Direct$Type$Buffer(long addr, long cap) {\n+        super(-1, 0, checkCapacity(cap), (int)cap, null);\n@@ -189,0 +190,16 @@\n+    \/\/ Throw an IllegalArgumentException if the capacity is not in\n+    \/\/ the range [0, Integer.MAX_VALUE]\n+    \/\/\n+    private static int checkCapacity(long capacity) {\n+        if (capacity < 0) {\n+            throw new IllegalArgumentException\n+                (\"JNI NewDirectByteBuffer passed capacity < 0: (\"\n+                + capacity + \")\");\n+        } else if (capacity > Integer.MAX_VALUE) {\n+            throw new IllegalArgumentException\n+                (\"JNI NewDirectByteBuffer passed capacity > Integer.MAX_VALUE: (\"\n+                + capacity + \")\");\n+        }\n+        return (int)capacity;\n+    }\n+\n","filename":"src\/java.base\/share\/classes\/java\/nio\/Direct-X-Buffer.java.template","additions":20,"deletions":3,"binary":false,"changes":23,"status":"modified"},{"patch":"@@ -0,0 +1,113 @@\n+\/*\n+ * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+import java.nio.ByteBuffer;\n+\n+\/*\n+ * @test\n+ * @bug 8299684\n+ * @summary Verify that JNI NewDirectByteBuffer throws IllegalArgumentException\n+ * if the capacity is negative or greater than Integer::MAX_VALUE\n+ * @run main\/native NewDirectByteBuffer\n+ *\/\n+public class NewDirectByteBuffer {\n+    static {\n+        System.loadLibrary(\"NewDirectByteBuffer\");\n+    }\n+\n+    private static final long[] LEGAL_CAPACITIES = {\n+        0L,\n+        1L,\n+        (long)Integer.MAX_VALUE\/2,\n+        (long)Integer.MAX_VALUE - 1,\n+        (long)Integer.MAX_VALUE\n+    };\n+\n+    private static final long[] ILLEGAL_CAPACITIES = {\n+        Long.MIN_VALUE,\n+        (long)Integer.MIN_VALUE - 1L,\n+        -1L,\n+        (long)Integer.MAX_VALUE + 1L,\n+        3_000_000_000L,\n+        5_000_000_000L,\n+        Long.MAX_VALUE\n+    };\n+\n+    private static final void checkBuffer(ByteBuffer buf, long capacity) {\n+        if (!buf.isDirect())\n+            throw new RuntimeException(\"Buffer is not direct\");\n+        long bufferCapacity = getDirectByteBufferCapacity(buf);\n+        if (bufferCapacity != capacity)\n+            throw new RuntimeException(\"GetDirectBufferCapacity \"\n+                + bufferCapacity + \" is not \" + capacity);\n+        if (buf.capacity() != capacity)\n+            throw new RuntimeException(\"buf.capacity() \"\n+                + buf.capacity() + \" is not \" + capacity);\n+        if (buf.position() != 0)\n+            throw new RuntimeException(\"buf.position() \"\n+                + buf.position() + \" is nonzero\");\n+        if (buf.limit() != capacity)\n+            throw new RuntimeException(\"buf.limit() \"\n+                + buf.limit() + \" is not \" + capacity);\n+    }\n+\n+    public static void main(String[] args) {\n+        System.out.println(\"--- Legal Capacities ---\");\n+        for (long cap : LEGAL_CAPACITIES) {\n+            System.out.println(\"Capacity \" + cap);\n+            try {\n+                ByteBuffer buf = newDirectByteBuffer(cap);\n+                if (buf != null) {\n+                    try {\n+                        checkBuffer(buf, cap);\n+                        System.out.println(\"Verified buffer for capacity \" + cap);\n+                    } finally {\n+                        freeDirectByteBufferMemory(buf);\n+                    }\n+                } else {\n+                    throw new RuntimeException(\"Direct buffer is null but no OOME\");\n+                }\n+            } catch (OutOfMemoryError ignored) {\n+                \/\/ Ignore the error so test may continue\n+            }\n+        }\n+\n+        System.out.println(\"\\n--- Illegal Capacities ---\");\n+        for (long cap : ILLEGAL_CAPACITIES) {\n+            System.out.println(\"Capacity \" + cap);\n+            try {\n+                ByteBuffer buf = newDirectByteBuffer(cap);\n+                if (buf != null) {\n+                    freeDirectByteBufferMemory(buf);\n+                }\n+                throw new RuntimeException(\"IAE not thrown for capacity \" + cap);\n+            } catch (IllegalArgumentException expected) {\n+                System.out.println(\"Caught expected IAE for capacity \" + cap);\n+            }\n+        }\n+    }\n+\n+    \/\/ See libNewDirectByteBuffer.c for implementations.\n+    private static native ByteBuffer newDirectByteBuffer(long size);\n+    private static native long getDirectByteBufferCapacity(ByteBuffer buf);\n+    private static native void freeDirectByteBufferMemory(ByteBuffer buf);\n+}\n","filename":"test\/jdk\/java\/nio\/jni\/NewDirectByteBuffer.java","additions":113,"deletions":0,"binary":false,"changes":113,"status":"added"},{"patch":"@@ -0,0 +1,65 @@\n+\/*\n+ * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+#include <stdlib.h>\n+#include \"jni.h\"\n+\n+\/\/ private static native ByteBuffer newDirectByteBuffer(long size)\n+JNIEXPORT jobject JNICALL\n+Java_NewDirectByteBuffer_newDirectByteBuffer\n+    (JNIEnv *env, jclass cls, jlong size)\n+{\n+    \/\/ Allocate memory, on failure throwing an OOME or returning NULL\n+    \/\/ if throwing the OOME fails\n+    void* addr = malloc(size);\n+    if (addr == NULL) {\n+        jclass oomeCls = (*env)->FindClass(env, \"java\/lang\/OutOfMemoryError\");\n+        if ((*env)->ThrowNew(env, oomeCls, \"malloc failed\") < 0) {\n+            return NULL;\n+        }\n+    }\n+\n+    \/\/ Create the direct byte buffer, freeing the native memory if an exception\n+    \/\/ is thrown while constructing the buffer\n+    jobject dbb = (*env)->NewDirectByteBuffer(env, addr, size);\n+    if ((*env)->ExceptionOccurred(env) != NULL) {\n+        free(addr);\n+    }\n+    return dbb;\n+}\n+\n+\/\/ private static native long getDirectByteBufferCapacity(ByteBuffer buf)\n+JNIEXPORT jlong JNICALL\n+Java_NewDirectByteBuffer_getDirectByteBufferCapacity\n+    (JNIEnv *env, jclass cls, jobject buf)\n+{\n+    return (*env)->GetDirectBufferCapacity(env, buf);\n+}\n+\n+\/\/ private static native void freeDirectByteBufferMemory(ByteBuffer buf)\n+JNIEXPORT void JNICALL\n+Java_NewDirectByteBuffer_freeDirectByteBufferMemory\n+    (JNIEnv *env, jclass cls, jobject buf)\n+{\n+    void* addr = (*env)->GetDirectBufferAddress(env, buf);\n+    free(addr);\n+}\n","filename":"test\/jdk\/java\/nio\/jni\/libNewDirectByteBuffer.c","additions":65,"deletions":0,"binary":false,"changes":65,"status":"added"}]}