{"files":[{"patch":"@@ -32,1 +32,0 @@\n-import javax.swing.SwingUtilities;\n@@ -287,11 +286,0 @@\n-    }\n-\n-    \/\/ updateTrayIcons method called from native side\n-    \/\/ when WM_WINDOWPOSCHANGING msg received\n-    static void updateTrayIcons() {\n-        SwingUtilities.invokeLater(()->{\n-            TrayIcon[] trayIconList = systemTray.getTrayIcons();\n-            for (TrayIcon trayIcon : trayIconList) {\n-                trayIcon.updateNotify();\n-            }\n-        });\n","filename":"src\/java.desktop\/share\/classes\/java\/awt\/SystemTray.java","additions":0,"deletions":12,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -710,7 +710,0 @@\n-    void updateNotify() {\n-        TrayIconPeer peer = this.peer;\n-        if (peer != null) {\n-            peer.updateImage();\n-        }\n-    }\n-\n","filename":"src\/java.desktop\/share\/classes\/java\/awt\/TrayIcon.java","additions":0,"deletions":7,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2005, 2018, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2005, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -28,1 +28,0 @@\n-import java.awt.Graphics2D;\n@@ -31,0 +30,1 @@\n+import java.awt.Graphics2D;\n@@ -32,1 +32,1 @@\n-import java.awt.PopupMenu;\n+import java.awt.Image;\n@@ -34,0 +34,1 @@\n+import java.awt.PopupMenu;\n@@ -35,1 +36,0 @@\n-import java.awt.Image;\n@@ -37,0 +37,4 @@\n+import java.awt.image.BufferedImage;\n+import java.awt.image.DataBufferInt;\n+import java.awt.image.ImageObserver;\n+import java.awt.image.Raster;\n@@ -38,1 +42,0 @@\n-import java.awt.image.*;\n","filename":"src\/java.desktop\/windows\/classes\/sun\/awt\/windows\/WTrayIconPeer.java","additions":8,"deletions":5,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -73,0 +73,1 @@\n+jmethodID AwtTrayIcon::idUpdateImage = NULL;\n@@ -77,0 +78,1 @@\n+bool AwtTrayIcon::m_bDPIChanged = false;\n@@ -224,2 +226,2 @@\n-\/\/ trayicon update handler called when Screen scale changes\n-void AwtTrayIcon::UpdateTrayIconHandler()\n+\/\/ Call updateImage() method on the peer when screen scale changes\n+void AwtTrayIcon::UpdateImageDPI()\n@@ -227,3 +229,0 @@\n-    jmethodID updateTrayFn;\n-    jclass systemTrayClass;\n-\n@@ -231,1 +230,0 @@\n-    systemTrayClass = env->FindClass(\"java\/awt\/SystemTray\");\n@@ -233,8 +231,8 @@\n-    if (systemTrayClass != NULL) {\n-         updateTrayFn = env->GetStaticMethodID(\n-                     systemTrayClass, \"updateTrayIcons\", \"()V\");\n-         if (updateTrayFn != NULL) {\n-             env->CallStaticVoidMethod(systemTrayClass,\n-                      updateTrayFn);\n-         }\n-         env->DeleteLocalRef(systemTrayClass);\n+    jobject peer = GetPeer(env);\n+    if (peer != NULL) {\n+        env->CallVoidMethod(peer, idUpdateImage);\n+    }\n+\n+    if (safe_ExceptionOccurred(env)) {\n+        env->ExceptionDescribe();\n+        env->ExceptionClear();\n@@ -271,0 +269,4 @@\n+        case WM_DPICHANGED:\n+            \/\/ Set the flag to update icon images, see WmTaskbarCreated\n+            m_bDPIChanged = true;\n+            break;\n@@ -274,2 +276,0 @@\n-                    \/\/ call tray icon update when taskbar reloads\n-                    AwtTrayIcon::UpdateTrayIconHandler();\n@@ -499,0 +499,4 @@\n+        if (m_bDPIChanged) {\n+            \/\/ Update the icon image\n+            item->m_trayIcon->UpdateImageDPI();\n+        }\n@@ -505,0 +509,1 @@\n+    m_bDPIChanged = false;\n@@ -942,0 +947,8 @@\n+    jclass wPeerCls = env->FindClass(\"sun\/awt\/windows\/WTrayIconPeer\");\n+    DASSERT(wPeerCls != NULL);\n+    CHECK_NULL(wPeerCls);\n+\n+    AwtTrayIcon::idUpdateImage = env->GetMethodID(wPeerCls, \"updateImage\", \"()V\");\n+    DASSERT(AwtTrayIcon::idUpdateImageDPI != NULL);\n+    CHECK_NULL(AwtTrayIcon::idUpdateImage);\n+\n","filename":"src\/java.desktop\/windows\/native\/libawt\/windows\/awt_TrayIcon.cpp","additions":29,"deletions":16,"binary":false,"changes":45,"status":"modified"},{"patch":"@@ -89,0 +89,2 @@\n+    void UpdateImageDPI();\n+\n@@ -112,1 +114,0 @@\n-    static void UpdateTrayIconHandler();\n@@ -125,0 +126,1 @@\n+    static jmethodID idUpdateImage;\n@@ -155,0 +157,2 @@\n+    static bool m_bDPIChanged;\n+\n","filename":"src\/java.desktop\/windows\/native\/libawt\/windows\/awt_TrayIcon.h","additions":5,"deletions":1,"binary":false,"changes":6,"status":"modified"}]}