{"files":[{"patch":"@@ -432,1 +432,5 @@\n-    current->print_stack_on(&ss);\n+    if (current->is_vthread_mounted()) {\n+      current->print_vthread_stack_on(&ss);\n+    } else {\n+      current->print_stack_on(&ss);\n+    }\n@@ -447,1 +451,5 @@\n-      current->print_stack_on(&info_stream);\n+      if (current->is_vthread_mounted()) {\n+        current->print_vthread_stack_on(&info_stream);\n+      } else {\n+        current->print_stack_on(&info_stream);\n+      }\n","filename":"src\/hotspot\/share\/runtime\/synchronizer.cpp","additions":10,"deletions":2,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -36,1 +36,2 @@\n- * @run driver\/timeout=180000 SyncOnValueBasedClassTest\n+ * @enablePreview\n+ * @run main\/othervm\/timeout=180000 --enable-preview SyncOnValueBasedClassTest\n@@ -65,1 +66,1 @@\n-        String[] commonFatalTestsFlags = {\"-XX:+UnlockDiagnosticVMOptions\", \"-XX:-CreateCoredumpOnCrash\", \"-XX:DiagnoseSyncOnValueBasedClasses=1\"};\n+        String[] commonFatalTestsFlags = {\"--enable-preview\", \"-XX:+UnlockDiagnosticVMOptions\", \"-XX:-CreateCoredumpOnCrash\", \"-XX:DiagnoseSyncOnValueBasedClasses=1\"};\n@@ -75,1 +76,1 @@\n-        String[] commonLogTestsFlags = {\"-XX:+UnlockDiagnosticVMOptions\", \"-XX:DiagnoseSyncOnValueBasedClasses=2\"};\n+        String[] commonLogTestsFlags = {\"--enable-preview\", \"-XX:+UnlockDiagnosticVMOptions\", \"-XX:DiagnoseSyncOnValueBasedClasses=2\"};\n@@ -99,0 +100,1 @@\n+        virtualThreadTests();\n@@ -166,0 +168,32 @@\n+\n+    \/\/ Very basic sanity tests to show things work for virtual threads too.\n+    private static void virtualThreadTests() throws Exception {\n+        final String[] vtTest = { \"--enable-preview\", \"-XX:+UnlockDiagnosticVMOptions\", \"-XX:-CreateCoredumpOnCrash\",\n+                                  \"\", \"SyncOnValueBasedClassTest$VTTest\" };\n+        \/\/ Fatal test\n+        vtTest[3] = \"-XX:DiagnoseSyncOnValueBasedClasses=1\";\n+        ProcessBuilder pb = ProcessTools.createJavaProcessBuilder(vtTest);\n+        OutputAnalyzer output = ProcessTools.executeProcess(pb);\n+        output.shouldContain(\"fatal error: Synchronizing on object\");\n+        output.shouldNotContain(\"synchronization on value based class did not fail\");\n+        output.shouldNotHaveExitValue(0);\n+\n+        \/\/ Log test\n+        vtTest[3] = \"-XX:DiagnoseSyncOnValueBasedClasses=2\";\n+        pb = ProcessTools.createJavaProcessBuilder(vtTest);\n+        output = ProcessTools.executeProcess(pb);\n+        output.shouldHaveExitValue(0);\n+        output.shouldContain(\"Synchronizing on object\");\n+        output.shouldContain(\"synchronization on value based class did not fail\");\n+    }\n+\n+    static class VTTest {\n+        public static void main(String[] args) throws Exception {\n+            var thread = Thread.ofVirtual().start(() -> {\n+                    synchronized (Character.valueOf('H')) {\n+                        System.out.println(\"synchronization on value based class did not fail\");\n+                    }\n+                });\n+            thread.join();\n+        }\n+    }\n","filename":"test\/hotspot\/jtreg\/runtime\/Monitor\/SyncOnValueBasedClassTest.java","additions":37,"deletions":3,"binary":false,"changes":40,"status":"modified"}]}