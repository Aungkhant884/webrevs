{"files":[{"patch":"@@ -1761,0 +1761,8 @@\n+void JavaThread::print_active_stack_on(outputStream* st) {\n+  if (is_vthread_mounted()) {\n+    print_vthread_stack_on(st);\n+  } else {\n+    print_stack_on(st);\n+  }\n+}\n+\n","filename":"src\/hotspot\/share\/runtime\/javaThread.cpp","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -941,0 +941,1 @@\n+  \/\/ These variants print carrier\/platform thread information only.\n@@ -943,0 +944,1 @@\n+  \/\/ This prints the currently mounted virtual thread.\n@@ -944,1 +946,2 @@\n-\n+  \/\/ This prints the active stack: either carrier\/platform or virtual.\n+  void print_active_stack_on(outputStream* st);\n","filename":"src\/hotspot\/share\/runtime\/javaThread.hpp","additions":4,"deletions":1,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -432,1 +432,1 @@\n-    current->print_stack_on(&ss);\n+    current->print_active_stack_on(&ss);\n@@ -447,1 +447,1 @@\n-      current->print_stack_on(&info_stream);\n+      current->print_active_stack_on(&info_stream);\n","filename":"src\/hotspot\/share\/runtime\/synchronizer.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -36,1 +36,2 @@\n- * @run driver\/timeout=180000 SyncOnValueBasedClassTest\n+ * @enablePreview\n+ * @run main\/othervm\/timeout=180000 --enable-preview SyncOnValueBasedClassTest\n@@ -65,1 +66,1 @@\n-        String[] commonFatalTestsFlags = {\"-XX:+UnlockDiagnosticVMOptions\", \"-XX:-CreateCoredumpOnCrash\", \"-XX:DiagnoseSyncOnValueBasedClasses=1\"};\n+        String[] commonFatalTestsFlags = {\"--enable-preview\", \"-XX:+UnlockDiagnosticVMOptions\", \"-XX:-CreateCoredumpOnCrash\", \"-XX:DiagnoseSyncOnValueBasedClasses=1\"};\n@@ -75,1 +76,1 @@\n-        String[] commonLogTestsFlags = {\"-XX:+UnlockDiagnosticVMOptions\", \"-XX:DiagnoseSyncOnValueBasedClasses=2\"};\n+        String[] commonLogTestsFlags = {\"--enable-preview\", \"-XX:+UnlockDiagnosticVMOptions\", \"-XX:DiagnoseSyncOnValueBasedClasses=2\"};\n@@ -99,0 +100,1 @@\n+        virtualThreadTests();\n@@ -166,0 +168,32 @@\n+\n+    \/\/ Very basic sanity tests to show things work for virtual threads too.\n+    private static void virtualThreadTests() throws Exception {\n+        final String[] vtTest = { \"--enable-preview\", \"-XX:+UnlockDiagnosticVMOptions\", \"-XX:-CreateCoredumpOnCrash\",\n+                                  \"\", \"SyncOnValueBasedClassTest$VTTest\" };\n+        \/\/ Fatal test\n+        vtTest[3] = \"-XX:DiagnoseSyncOnValueBasedClasses=1\";\n+        ProcessBuilder pb = ProcessTools.createJavaProcessBuilder(vtTest);\n+        OutputAnalyzer output = ProcessTools.executeProcess(pb);\n+        output.shouldContain(\"fatal error: Synchronizing on object\");\n+        output.shouldNotContain(\"synchronization on value based class did not fail\");\n+        output.shouldNotHaveExitValue(0);\n+\n+        \/\/ Log test\n+        vtTest[3] = \"-XX:DiagnoseSyncOnValueBasedClasses=2\";\n+        pb = ProcessTools.createJavaProcessBuilder(vtTest);\n+        output = ProcessTools.executeProcess(pb);\n+        output.shouldHaveExitValue(0);\n+        output.shouldContain(\"Synchronizing on object\");\n+        output.shouldContain(\"synchronization on value based class did not fail\");\n+    }\n+\n+    static class VTTest {\n+        public static void main(String[] args) throws Exception {\n+            var thread = Thread.ofVirtual().start(() -> {\n+                    synchronized (Character.valueOf('H')) {\n+                        System.out.println(\"synchronization on value based class did not fail\");\n+                    }\n+                });\n+            thread.join();\n+        }\n+    }\n","filename":"test\/hotspot\/jtreg\/runtime\/Monitor\/SyncOnValueBasedClassTest.java","additions":37,"deletions":3,"binary":false,"changes":40,"status":"modified"}]}