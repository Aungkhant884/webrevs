{"files":[{"patch":"@@ -41,0 +41,1 @@\n+import java.util.concurrent.locks.ReentrantLock;\n@@ -62,0 +63,1 @@\n+    private final ReentrantLock stateLock = new ReentrantLock();\n@@ -243,1 +245,2 @@\n-        synchronized (this) {\n+        stateLock.lock();\n+        try {\n@@ -245,3 +248,8 @@\n-        }\n-        if (!closed) {\n-            client().connectionOpened(this);\n+            if (!closed) {\n+                client().connectionOpened(this);\n+            }\n+            \/\/ connectionOpened might call close() if the client\n+            \/\/ is shutting down.\n+            closed = this.closed;\n+        } finally {\n+            stateLock.unlock();\n@@ -401,6 +409,3 @@\n-        synchronized (this) {\n-            if (closed) {\n-                return;\n-            }\n-            closed = true;\n-        }\n+        var closed = this.closed;\n+        if (closed) return;\n+        stateLock.lock();\n@@ -408,0 +413,2 @@\n+            if (closed = this.closed) return;\n+            closed = this.closed = true;\n@@ -411,0 +418,1 @@\n+            var connectTimerEvent = this.connectTimerEvent;\n@@ -423,0 +431,1 @@\n+            debug.log(\"Closing resulted in \" + e);\n@@ -424,0 +433,2 @@\n+        } finally {\n+            stateLock.unlock();\n@@ -434,1 +445,1 @@\n-    synchronized boolean connected() {\n+    boolean connected() {\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/PlainHttpConnection.java","additions":22,"deletions":11,"binary":false,"changes":33,"status":"modified"},{"patch":"@@ -26,1 +26,1 @@\n- * @bug 8267140\n+ * @bug 8267140 8309120\n@@ -142,0 +142,2 @@\n+        \/\/ exception from cancelling an HTTP\/2 stream\n+        if (message.matches(\"Stream [0-9]+ cancelled\")) return true;\n","filename":"test\/jdk\/java\/net\/httpclient\/AsyncShutdownNow.java","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -138,1 +138,1 @@\n-        if (message.matches(\"stream [0-9]+ cancelled\")) return true;\n+        if (message.matches(\"Stream [0-9]+ cancelled\")) return true;\n","filename":"test\/jdk\/java\/net\/httpclient\/ShutdownNow.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}