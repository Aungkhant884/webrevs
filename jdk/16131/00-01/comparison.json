{"files":[{"patch":"@@ -27,0 +27,9 @@\n+import java.io.InputStream;\n+import java.util.List;\n+import java.util.ArrayList;\n+\n+import jdk.internal.org.objectweb.asm.ClassReader;\n+import jdk.internal.org.objectweb.asm.ClassVisitor;\n+import jdk.internal.org.objectweb.asm.FieldVisitor;\n+import jdk.internal.org.objectweb.asm.Opcodes;\n+\n@@ -43,1 +52,1 @@\n-    native static void check(int i, Class cls);\n+    native static void check(Class cls, String[] expectedFields);\n@@ -55,11 +64,11 @@\n-            check(0, Class.forName(InnerClass1.class.getName()));\n-            check(1, Class.forName(InnerInterface.class.getName()));\n-            check(2, Class.forName(InnerClass2.class.getName()));\n-            check(3, Class.forName(OuterClass1.class.getName()));\n-            check(4, Class.forName(OuterClass2.class.getName()));\n-            check(5, Class.forName(OuterClass3.class.getName()));\n-            check(6, Class.forName(OuterInterface1.class.getName()));\n-            check(7, Class.forName(OuterInterface2.class.getName()));\n-            check(8, Class.forName(OuterClass4.class.getName()));\n-            check(9, Class.forName(OuterClass5.class.getName()));\n-        } catch (ClassNotFoundException e) {\n+            check(Class.forName(InnerClass1.class.getName()));\n+            check(Class.forName(InnerInterface.class.getName()));\n+            check(Class.forName(InnerClass2.class.getName()));\n+            check(Class.forName(OuterClass1.class.getName()));\n+            check(Class.forName(OuterClass2.class.getName()));\n+            check(Class.forName(OuterClass3.class.getName()));\n+            check(Class.forName(OuterInterface1.class.getName()));\n+            check(Class.forName(OuterInterface2.class.getName()));\n+            check(Class.forName(OuterClass4.class.getName()));\n+            check(Class.forName(OuterClass5.class.getName()));\n+        } catch (Exception e) {\n@@ -71,0 +80,42 @@\n+\n+    static void check(Class cls) throws Exception {\n+        List<String> fields = FieldExplorer.get(cls);\n+        check(cls, fields.toArray(new String[0]));\n+    }\n+\n+    \/\/ helper class to get list of the class field\n+    \/\/ in the order they appear in the class file\n+    static class FieldExplorer extends ClassVisitor {\n+        private Class cls;\n+        private List<String> fieldNameAndSig = new ArrayList<>();\n+        private FieldExplorer(Class cls) {\n+            super(Opcodes.ASM7);\n+            this.cls = cls;\n+        }\n+\n+        @Override\n+        public FieldVisitor visitField(int access, String name, String descriptor, String signature, Object value) {\n+            System.out.println(\"  field '\" + name + \"', type = \" + descriptor);\n+            fieldNameAndSig.add(name);\n+            fieldNameAndSig.add(descriptor);\n+            return super.visitField(access, name, descriptor, signature, value);\n+        }\n+\n+        InputStream getClassBytes() throws Exception {\n+            String clsName = cls.getName();\n+            String clsPath = clsName.replace('.', '\/') + \".class\";\n+            return cls.getClassLoader().getResourceAsStream(clsPath);\n+        }\n+\n+        \/\/ each field is represented by 2 Strings in the list: name and type descriptor\n+        static List<String> get(Class cls) throws Exception {\n+            System.out.println(\"Class \" + cls.getName());\n+            FieldExplorer explorer = new FieldExplorer(cls);\n+            try (InputStream classBytes = explorer.getClassBytes()) {\n+                ClassReader classReader = new ClassReader(classBytes);\n+                classReader.accept(explorer, 0);\n+            }\n+            return explorer.fieldNameAndSig;\n+        }\n+    }\n+\n","filename":"test\/hotspot\/jtreg\/vmTestbase\/nsk\/jvmti\/GetClassFields\/getclfld007.java","additions":63,"deletions":12,"binary":false,"changes":75,"status":"modified"},{"patch":"@@ -48,1 +48,2 @@\n- * @run main\/othervm\/native -agentlib:getclfld007=printdump nsk.jvmti.GetClassFields.getclfld007\n+ * @modules java.base\/jdk.internal.org.objectweb.asm\n+ * @run main\/othervm\/native -agentlib:getclfld007 nsk.jvmti.GetClassFields.getclfld007\n","filename":"test\/hotspot\/jtreg\/vmTestbase\/nsk\/jvmti\/GetClassFields\/getclfld007\/TestDescription.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -36,11 +36,0 @@\n-typedef struct {\n-    const char *name;\n-    const char *sig;\n-} fld_info;\n-\n-typedef struct {\n-    const char *name;\n-    jint fcount;\n-    fld_info *flds;\n-} class_info;\n-\n@@ -49,53 +38,17 @@\n-static jboolean printdump = JNI_FALSE;\n-\n-static fld_info f0[] = {\n-    { \"fld_1\", \"Ljava\/lang\/String;\" }\n-};\n-\n-static fld_info f1[] = {\n-    { \"fld_n1\", \"I\" }\n-};\n-\n-static fld_info f2[] = {\n-    { \"fld_n2\", \"I\" }\n-};\n-\n-static fld_info f4[] = {\n-    { \"fld_o2\", \"I\" }\n-};\n-\n-static fld_info f5[] = {\n-    { \"fld_o3\", \"I\" }\n-};\n-\n-static fld_info f6[] = {\n-    { \"fld_i1\", \"I\" }\n-};\n-\n-static fld_info f7[] = {\n-    { \"fld_i2\", \"I\" }\n-};\n-\n-static fld_info f8[] = {\n-    { \"fld_i2\", \"I\" }\n-};\n-\n-static fld_info f9[] = {\n-    { \"fld_i1\", \"I\" },\n-    { \"fld_s1\", \"Ljava\/lang\/String;\" },\n-    { \"fld_i2\", \"I\" },\n-    { \"fld_s2\", \"Ljava\/lang\/String;\" }\n-};\n-\n-static class_info classes[] = {\n-    { \"InnerClass1\", 1, f0 },\n-    { \"InnerInterface\", 1, f1 },\n-    { \"InnerClass2\", 1, f2 },\n-    { \"OuterClass1\", 0, NULL },\n-    { \"OuterClass2\", 1, f4 },\n-    { \"OuterClass3\", 1, f5 },\n-    { \"OuterInterface1\", 1, f6 },\n-    { \"OuterInterface2\", 1, f7 },\n-    { \"OuterClass4\", 1, f8 },\n-    { \"OuterClass5\", 4, f9 }\n-};\n+\n+\n+\/\/ compares 'value' with jobject_arr[index]\n+static bool equals_str(JNIEnv *env, const char *value, jobjectArray jobject_arr, jint index) {\n+    jstring jstr = (jstring)env->GetObjectArrayElement(jobject_arr, index);\n+    const char* utf = env->GetStringUTFChars(jstr, NULL);\n+    bool res = false;\n+    if (utf != NULL) {\n+        res = strcmp(value, utf) == 0;\n+        env->ReleaseStringUTFChars(jstr, utf);\n+    } else {\n+        printf(\"GetStringUTFChars failed\\n\");\n+        result = STATUS_FAILED;\n+    }\n+    env->DeleteLocalRef(jstr);\n+    return res;\n+}\n@@ -117,4 +70,0 @@\n-    if (options != NULL && strcmp(options, \"printdump\") == 0) {\n-        printdump = JNI_TRUE;\n-    }\n-\n@@ -131,1 +80,1 @@\n-Java_nsk_jvmti_GetClassFields_getclfld007_check(JNIEnv *env, jclass cls, jint i, jclass clazz) {\n+Java_nsk_jvmti_GetClassFields_getclfld007_check(JNIEnv *env, jclass cls, jclass clazz, jobjectArray fieldArr) {\n@@ -135,1 +84,1 @@\n-    char *name, *sig, *generic;\n+    char *name, *sig;\n@@ -140,0 +89,1 @@\n+        fflush(0);\n@@ -144,3 +94,2 @@\n-    if (printdump == JNI_TRUE) {\n-        printf(\">>> %s:\\n\", classes[i].name);\n-    }\n+    \/\/ fieldArr contains 2 elements for each field\n+    jint field_count = env->GetArrayLength(fieldArr) \/ 2;\n@@ -150,2 +99,3 @@\n-        printf(\"(GetClassFields#%d) unexpected error: %s (%d)\\n\",\n-               i, TranslateError(err), err);\n+        printf(\"GetClassFields unexpected error: %s (%d)\\n\",\n+               TranslateError(err), err);\n+        fflush(0);\n@@ -156,3 +106,3 @@\n-    if (fcount != classes[i].fcount) {\n-        printf(\"(%d) wrong number of fields: %d, expected: %d\\n\",\n-               i, fcount, classes[i].fcount);\n+    if (fcount != field_count) {\n+        printf(\"wrong number of fields: %d, expected: %d\\n\",\n+               fcount, field_count);\n@@ -163,1 +113,2 @@\n-            printf(\"(%d:%d) fieldID = null\\n\", i, j);\n+            printf(\"(%d) fieldID = null\\n\", j);\n+            result = STATUS_FAILED;\n@@ -165,2 +116,1 @@\n-            err = jvmti->GetFieldName(clazz, fields[j],\n-                &name, &sig, &generic);\n+            err = jvmti->GetFieldName(clazz, fields[j], &name, &sig, NULL);\n@@ -168,2 +118,2 @@\n-                printf(\"(GetFieldName#%d:%d) unexpected error: %s (%d)\\n\",\n-                       i, j, TranslateError(err), err);\n+                printf(\"(GetFieldName#%d) unexpected error: %s (%d)\\n\",\n+                       j, TranslateError(err), err);\n@@ -171,4 +121,2 @@\n-                if (printdump == JNI_TRUE) {\n-                    printf(\">>>   [%d]: %s, sig = \\\"%s\\\"\\n\", j, name, sig);\n-                }\n-                if ((j < classes[i].fcount) &&\n+                printf(\">>>   [%d]: %s, sig = \\\"%s\\\"\\n\", j, name, sig);\n+                if ((j < field_count) &&\n@@ -176,5 +124,3 @@\n-                        strcmp(name, classes[i].flds[j].name) != 0 ||\n-                        strcmp(sig, classes[i].flds[j].sig) != 0)) {\n-                    printf(\"(%d:%d) wrong field: \\\"%s%s\\\"\", i, j, name, sig);\n-                    printf(\", expected: \\\"%s%s\\\"\\n\",\n-                           classes[i].flds[j].name, classes[i].flds[j].sig);\n+                        !equals_str(env, name, fieldArr, j * 2) ||\n+                        !equals_str(env, sig, fieldArr, j * 2 + 1))) {\n+                    printf(\"(%d) wrong field: \\\"%s%s\\\"\", j, name, sig);\n@@ -183,0 +129,2 @@\n+                jvmti->Deallocate((unsigned char *)name);\n+                jvmti->Deallocate((unsigned char *)sig);\n@@ -186,0 +134,1 @@\n+    fflush(0);\n","filename":"test\/hotspot\/jtreg\/vmTestbase\/nsk\/jvmti\/GetClassFields\/getclfld007\/getclfld007.cpp","additions":41,"deletions":92,"binary":false,"changes":133,"status":"modified"}]}