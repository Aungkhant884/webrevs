{"files":[{"patch":"@@ -42,0 +42,1 @@\n+import java.util.Scanner;\n@@ -2036,1 +2037,1 @@\n-                    && Objects.equals(this.svalue, strVal.svalue);\n+                   && Objects.equals(this.svalue, strVal.svalue);\n@@ -2223,1 +2224,12 @@\n-            return val instanceof CSS.FontSize size && value == size.value;\n+            if (val instanceof CSS.FontSize size) {\n+                \/\/ If fontsize contains numeric along with units\n+                \/\/ and does not contain only alphabets like \"smaller\", \"medium\" etc\n+                if (size.lu != null && !size.svalue.matches(\"^[a-zA-Z]*$\")) {\n+                    int sz = new Scanner(size.svalue).useDelimiter(\"\\\\D\").nextInt();\n+                    int oldsz = new Scanner(svalue).useDelimiter(\"\\\\D\").nextInt();\n+                    return sz == oldsz\n+                           && Objects.equals(size.lu.units, lu.units);\n+                }\n+                return value == size.value;\n+            }\n+            return false;\n@@ -2334,1 +2346,1 @@\n-                       && Objects.equals(family, font.family);\n+                   && Objects.equals(family, font.family);\n@@ -2681,1 +2693,3 @@\n-                return val instanceof CSS.LengthValue lu && span == lu.span;\n+                return val instanceof CSS.LengthValue lu\n+                        && span == lu.span\n+                        && Objects.equals(lu.units, units);\n","filename":"src\/java.desktop\/share\/classes\/javax\/swing\/text\/html\/CSS.java","additions":18,"deletions":4,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -24,0 +24,8 @@\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Objects;\n+\n+import javax.swing.text.AttributeSet;\n+import javax.swing.text.html.StyleSheet;\n+\n@@ -30,5 +38,0 @@\n-\n-import javax.swing.text.SimpleAttributeSet;\n-import javax.swing.text.html.CSS;\n-import javax.swing.text.html.StyleSheet;\n-\n@@ -37,10 +40,48 @@\n-    public static void main(String[] args) {\n-        testFontSize();\n-        testFontFamily();\n-        testFontWeight();\n-        testColor();\n-        testBorderStyle();\n-        testCSSLengthValue();\n-        testBackgroundPosition();\n-        testCSSStringValue();\n-    }\n+    \/**\n+     * CSS declarations which should produce equal attribute sets.\n+     *\/\n+    private static final String[] EQUALS = {\n+            \"font-size: 42\",\n+            \"font-size: 42px\",\n+            \"font-size: 42em\",\n+            \"font-size: medium\",\n+            \"font-size: smaller\",\n+            \"font-size: 200%\",\n+\n+            \"font-family: sans-serif\",\n+            \"font-family: 'DejaVu Serif', serif\",\n+\n+            \"font-weight: bold\",\n+\n+            \"color: red\",\n+            \"color: rgb(255, 0, 0)\",\n+\n+            \"border-style: dashed\",\n+\n+            \"margin-top: 42\",\n+            \"margin-top: 42px\",\n+\/\/            \"margin-top: 100%\",\n+\n+            \"text-decoration: underline\",\n+\n+            \"background-position: top\",\n+            \"background-position: top right\",\n+            \"background-position: 25% 75%\",\n+            \"background-position: 0 0\",\n+            \"background-position: 1cm 2cm\",\n+            \"background-position: 1em 2em\",\n+    };\n+\n+    \/**\n+     * CSS declarations which should produce different attribute sets.\n+     *\/\n+    private static final String[][] NOT_EQUALS = {\n+            {\"font-size: 42px\", \"font-size: 22px\"},\n+            {\"font-size: 42px\", \"font-size: 42pt\"},\n+            {\"font-size: 42em\", \"font-size: 42ex\"},\n+            {\"font-size: 100%\", \"font-size: 200%\"},\n+\n+            {\"margin-top: 42px\", \"margin-top: 22px\"},\n+            {\"margin-top: 42px\", \"margin-top: 42pt\"},\n+\/\/            {\"margin-top: 100%\", \"margin-top: 200%\"},\n+    };\n@@ -48,9 +89,17 @@\n-    private static void checkEquality(SimpleAttributeSet a,\n-                                      SimpleAttributeSet b,\n-                                      String attribName) {\n-        if (a.isEqual(b)) {\n-            System.out.println(\"a equals b\");\n-        } else {\n-            System.out.println(\"a = \" + a);\n-            System.out.println(\"b = \" + b);\n-            throw new RuntimeException(attribName + \" a is not equal to b\");\n+    public static void main(String[] args) {\n+        final List<String> failures = new ArrayList<>();\n+\n+        Arrays.stream(EQUALS)\n+              .map(CSSAttributeEqualityBug::positiveTest)\n+              .filter(Objects::nonNull)\n+              .forEach(failures::add);\n+        Arrays.stream(NOT_EQUALS)\n+              .map(CSSAttributeEqualityBug::negativeTest)\n+              .filter(Objects::nonNull)\n+              .forEach(failures::add);\n+\n+        if (!failures.isEmpty()) {\n+            failures.forEach(System.err::println);\n+            throw new RuntimeException(failures.size()\n+                                       + \" failure(s) detected: \"\n+                                       + failures.get(0));\n@@ -60,1 +109,1 @@\n-    private static void testFontSize() {\n+    private static String positiveTest(String cssDeclaration) {\n@@ -62,1 +111,0 @@\n-        String fontSize = \"42\";\n@@ -64,2 +112,2 @@\n-        SimpleAttributeSet a = new SimpleAttributeSet();\n-        ss.addCSSAttribute(a, CSS.Attribute.FONT_SIZE, fontSize);\n+        AttributeSet a = ss.getDeclaration(cssDeclaration);\n+        AttributeSet b = ss.getDeclaration(cssDeclaration);\n@@ -67,4 +115,1 @@\n-        SimpleAttributeSet b = new SimpleAttributeSet();\n-        ss.addCSSAttribute(b, CSS.Attribute.FONT_SIZE, fontSize);\n-\n-        checkEquality(a, b, \"CSS.Attribute.FontSize\");\n+        return assertEquals(a, b);\n@@ -73,1 +118,1 @@\n-    private static void testFontFamily() {\n+    private static String negativeTest(String[] cssDeclaration) {\n@@ -75,4 +120,0 @@\n-        String fontFamily = \"Sans-Serif\";\n-\n-        SimpleAttributeSet a = new SimpleAttributeSet();\n-        ss.addCSSAttribute(a, CSS.Attribute.FONT_FAMILY, fontFamily);\n@@ -80,2 +121,2 @@\n-        SimpleAttributeSet b = new SimpleAttributeSet();\n-        ss.addCSSAttribute(b, CSS.Attribute.FONT_FAMILY, fontFamily);\n+        AttributeSet a = ss.getDeclaration(cssDeclaration[0]);\n+        AttributeSet b = ss.getDeclaration(cssDeclaration[1]);\n@@ -83,1 +124,1 @@\n-        checkEquality(a, b, \"CSS.Attribute.FontFamily\");\n+        return assertNotEquals(a, b);\n@@ -86,11 +127,5 @@\n-    private static void testFontWeight() {\n-        StyleSheet ss = new StyleSheet();\n-        String fontWeight = \"bold\";\n-\n-        SimpleAttributeSet a = new SimpleAttributeSet();\n-        ss.addCSSAttribute(a, CSS.Attribute.FONT_WEIGHT, fontWeight);\n-\n-        SimpleAttributeSet b = new SimpleAttributeSet();\n-        ss.addCSSAttribute(b, CSS.Attribute.FONT_WEIGHT, fontWeight);\n-\n-        checkEquality(a, b, \"CSS.Attribute.FontWeight\");\n+    private static String assertEquals(AttributeSet a,\n+                                       AttributeSet b) {\n+        return !a.isEqual(b)\n+               ? getErrorMessage(a, b, \"is not equal to\")\n+               : null;\n@@ -99,11 +134,5 @@\n-    private static void testColor() {\n-        StyleSheet ss = new StyleSheet();\n-        String fontColor = \"red\";\n-\n-        SimpleAttributeSet a = new SimpleAttributeSet();\n-        ss.addCSSAttribute(a, CSS.Attribute.COLOR, fontColor);\n-\n-        SimpleAttributeSet b = new SimpleAttributeSet();\n-        ss.addCSSAttribute(b, CSS.Attribute.COLOR, fontColor);\n-\n-        checkEquality(a, b, \"CSS.Attribute.Color\");\n+    private static String assertNotEquals(AttributeSet a,\n+                                          AttributeSet b) {\n+        return a.isEqual(b)\n+               ? getErrorMessage(a, b, \"is equal to\")\n+               : null;\n@@ -112,37 +141,4 @@\n-    private static void testBorderStyle() {\n-        StyleSheet ss = new StyleSheet();\n-        String borderStyle = \"DASHED\";\n-\n-        SimpleAttributeSet a = new SimpleAttributeSet();\n-        ss.addCSSAttribute(a, CSS.Attribute.BORDER_STYLE, borderStyle);\n-\n-        SimpleAttributeSet b = new SimpleAttributeSet();\n-        ss.addCSSAttribute(b, CSS.Attribute.BORDER_STYLE, borderStyle);\n-\n-        checkEquality(a, b, \"CSS.Attribute.BorderStyle\");\n-    }\n-\n-    private static void testCSSLengthValue() {\n-        StyleSheet ss = new StyleSheet();\n-        String lengthUnit = \"42\";\n-\n-        SimpleAttributeSet a = new SimpleAttributeSet();\n-        ss.addCSSAttribute(a, CSS.Attribute.MARGIN_TOP, lengthUnit);\n-\n-        SimpleAttributeSet b = new SimpleAttributeSet();\n-        ss.addCSSAttribute(b, CSS.Attribute.MARGIN_TOP, lengthUnit);\n-\n-        checkEquality(a, b, \"CSS LengthValue\");\n-    }\n-\n-    private static void testBackgroundPosition() {\n-        StyleSheet ss = new StyleSheet();\n-        String bgPosition = \"top\";\n-\n-        SimpleAttributeSet a = new SimpleAttributeSet();\n-        ss.addCSSAttribute(a, CSS.Attribute.BACKGROUND_POSITION, bgPosition);\n-\n-        SimpleAttributeSet b = new SimpleAttributeSet();\n-        ss.addCSSAttribute(b, CSS.Attribute.BACKGROUND_POSITION, bgPosition);\n-\n-        checkEquality(a, b, \"CSS.Attribute.BACKGROUND_POSITION\");\n+    private static String getErrorMessage(AttributeSet a,\n+                                          AttributeSet b,\n+                                          String message) {\n+        return a + \" \" + message + \" \" + b;\n@@ -151,12 +147,0 @@\n-    private static void testCSSStringValue() {\n-        StyleSheet ss = new StyleSheet();\n-        String strVal = \"underline\";\n-\n-        SimpleAttributeSet a = new SimpleAttributeSet();\n-        ss.addCSSAttribute(a, CSS.Attribute.TEXT_DECORATION, strVal);\n-\n-        SimpleAttributeSet b = new SimpleAttributeSet();\n-        ss.addCSSAttribute(b, CSS.Attribute.TEXT_DECORATION, strVal);\n-\n-        checkEquality(a, b, \"CSS.Attribute.TEXT_DECORATION\");\n-    }\n@@ -165,1 +149,0 @@\n-\n","filename":"test\/jdk\/javax\/swing\/text\/html\/CSS\/CSSAttributeEqualityBug.java","additions":95,"deletions":112,"binary":false,"changes":207,"status":"modified"}]}