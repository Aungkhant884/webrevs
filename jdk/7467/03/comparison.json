{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2008, 2015, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2008, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -185,1 +185,1 @@\n-            close(fd);\n+            close(fd, e -> null);\n@@ -280,1 +280,1 @@\n-            close(fd);\n+            close(fd, e -> null);\n","filename":"src\/java.base\/linux\/classes\/sun\/nio\/fs\/LinuxDosFileAttributeView.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2008, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2008, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -73,2 +73,2 @@\n-            UnixNativeDispatcher.close(ifd);\n-            throw new IOException(x.errorString());\n+            throw UnixNativeDispatcher.close(ifd,\n+                new IOException(x.errorString()), y -> y.asIOException(null));\n@@ -299,3 +299,3 @@\n-            UnixNativeDispatcher.close(socketpair[0]);\n-            UnixNativeDispatcher.close(socketpair[1]);\n-            UnixNativeDispatcher.close(ifd);\n+            UnixNativeDispatcher.close(socketpair[0], e -> null);\n+            UnixNativeDispatcher.close(socketpair[1], e -> null);\n+            UnixNativeDispatcher.close(ifd, e -> null);\n","filename":"src\/java.base\/linux\/classes\/sun\/nio\/fs\/LinuxWatchService.java","additions":6,"deletions":6,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2008, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2008, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -189,1 +189,1 @@\n-                    close(sfd);\n+                    close(sfd, x -> x.asIOException(source));\n@@ -213,1 +213,1 @@\n-                close(dfd);\n+                close(dfd, e -> null);\n@@ -291,1 +291,1 @@\n-                close(fo);\n+                close(fo, e -> null);\n@@ -301,1 +301,1 @@\n-            close(fi);\n+            close(fi, e -> null);\n","filename":"src\/java.base\/unix\/classes\/sun\/nio\/fs\/UnixCopyFile.java","additions":5,"deletions":5,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2008, 2016, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2008, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -70,1 +70,1 @@\n-    protected final UnixPath directory() {\n+    final UnixPath directory() {\n","filename":"src\/java.base\/unix\/classes\/sun\/nio\/fs\/UnixDirectoryStream.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2008, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2008, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -163,1 +163,1 @@\n-                close(fd);\n+                close(fd, e -> null);\n","filename":"src\/java.base\/unix\/classes\/sun\/nio\/fs\/UnixFileAttributeViews.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2008, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2008, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -200,1 +200,1 @@\n-            UnixNativeDispatcher.close(fd);\n+            UnixNativeDispatcher.close(fd, e -> null);\n","filename":"src\/java.base\/unix\/classes\/sun\/nio\/fs\/UnixFileStore.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2008, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2008, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -434,7 +434,12 @@\n-            if (dfd1 != -1)\n-                UnixNativeDispatcher.close(dfd1);\n-            if (dfd2 != -1)\n-                UnixNativeDispatcher.close(dfd2);\n-            if (x.errno() == UnixConstants.ENOTDIR)\n-                throw new NotDirectoryException(dir.getPathForExceptionMessage());\n-            x.rethrowAsIOException(dir);\n+            IOException ioe = x.errno() == UnixConstants.ENOTDIR ?\n+                new NotDirectoryException(dir.getPathForExceptionMessage()) :\n+                x.asIOException(dir);\n+            if (dfd1 != -1) {\n+                ioe = UnixNativeDispatcher.close(dfd1, ioe,\n+                    y -> y.asIOException(dir));\n+            }\n+            if (dfd2 != -1) {\n+                ioe = UnixNativeDispatcher.close(dfd2, ioe,\n+                    z -> z.asIOException(dir));\n+            }\n+            throw ioe;\n","filename":"src\/java.base\/unix\/classes\/sun\/nio\/fs\/UnixFileSystemProvider.java","additions":13,"deletions":8,"binary":false,"changes":21,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2008, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2008, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -28,0 +28,2 @@\n+import java.util.function.Function;\n+\n@@ -93,1 +95,1 @@\n-    static void close(int fd) {\n+    static void close(int fd) throws UnixException {\n@@ -98,1 +100,41 @@\n-    private static native void close0(int fd);\n+    private static native void close0(int fd) throws UnixException;\n+\n+    \/**\n+     * close(fd). If close fails then the given exception supplier function is\n+     * invoked to produce an exception to throw. If the function returns null\n+     * then no exception is thrown. If close fails and the exception supplier\n+     * function is null, then no exception is thrown.\n+     *\/\n+    static <X extends Throwable>\n+    void close(int fd, Function<UnixException, X> mapper) throws X {\n+        try {\n+            close(fd);\n+        } catch (UnixException e) {\n+            if (mapper != null) {\n+                X ex = mapper.apply(e);\n+                if (ex != null) throw ex;\n+            }\n+        }\n+    }\n+\n+    \/**\n+     * close(fd). If close is successful then {@code ex} is returned. If\n+     * close fails then the given exception supplier function is invoked\n+     * to produce an exception. If {@code ex} is null then the produced\n+     * exception is returned, otherwise it is added to {@code ex} as a\n+     * suppressed exception and {@code ex} is returned.\n+     *\/\n+    static <X extends Throwable>\n+    X close(int fd, X ex, Function<UnixException, X>  mapper) {\n+        try {\n+            close(fd);\n+        } catch (UnixException ue) {\n+            X closeEx = mapper.apply(ue);\n+            if (ex != null) {\n+                ex.addSuppressed(closeEx);\n+            } else {\n+                ex = closeEx;\n+            }\n+        }\n+        return ex;\n+    }\n","filename":"src\/java.base\/unix\/classes\/sun\/nio\/fs\/UnixNativeDispatcher.java","additions":45,"deletions":3,"binary":false,"changes":48,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2008, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2008, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -64,1 +64,1 @@\n-                UnixNativeDispatcher.close(dfd);\n+                UnixNativeDispatcher.close(dfd, e -> e.asIOException(ds.directory()));\n@@ -120,7 +120,12 @@\n-                if (newdfd1 != -1)\n-                    UnixNativeDispatcher.close(newdfd1);\n-                if (newdfd2 != -1)\n-                    UnixNativeDispatcher.close(newdfd2);\n-                if (x.errno() == UnixConstants.ENOTDIR)\n-                    throw new NotDirectoryException(file.toString());\n-                x.rethrowAsIOException(file);\n+                IOException ioe = x.errno() == UnixConstants.ENOTDIR ?\n+                    new NotDirectoryException(file.toString()) :\n+                    x.asIOException(file);\n+                if (newdfd1 != -1) {\n+                    ioe = UnixNativeDispatcher.close(newdfd1, ioe,\n+                        y -> y.asIOException(file));\n+                }\n+                if (newdfd2 != -1) {\n+                    ioe = UnixNativeDispatcher.close(newdfd1, ioe,\n+                        z -> z.asIOException(file));\n+                }\n+                throw ioe;\n@@ -425,1 +430,1 @@\n-                        UnixNativeDispatcher.close(fd);\n+                        UnixNativeDispatcher.close(fd, e-> null);\n@@ -507,1 +512,1 @@\n-                        UnixNativeDispatcher.close(fd);\n+                        UnixNativeDispatcher.close(fd, e-> null);\n@@ -530,1 +535,1 @@\n-                        UnixNativeDispatcher.close(fd);\n+                        UnixNativeDispatcher.close(fd, e-> null);\n","filename":"src\/java.base\/unix\/classes\/sun\/nio\/fs\/UnixSecureDirectoryStream.java","additions":17,"deletions":12,"binary":false,"changes":29,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2008, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2008, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -136,1 +136,1 @@\n-            close(fd);\n+            close(fd, e -> null);\n@@ -160,1 +160,1 @@\n-            close(fd);\n+            close(fd, e -> null);\n@@ -224,1 +224,1 @@\n-            close(fd);\n+            close(fd, e -> null);\n@@ -286,1 +286,1 @@\n-            close(fd);\n+            close(fd, e -> null);\n@@ -308,1 +308,1 @@\n-            close(fd);\n+            close(fd, e -> null);\n@@ -349,1 +349,1 @@\n-}\n\\ No newline at end of file\n+}\n","filename":"src\/java.base\/unix\/classes\/sun\/nio\/fs\/UnixUserDefinedFileAttributeView.java","additions":7,"deletions":7,"binary":false,"changes":14,"status":"modified"}]}