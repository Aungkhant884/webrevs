{"files":[{"patch":"@@ -102,4 +102,0 @@\n-static bool is_vthread_in_transition(JavaThread* thread) {\n-  return JfrThreadLocal::is_vthread(thread) && (thread->last_continuation() == nullptr);\n-}\n-\n@@ -191,1 +187,1 @@\n-  if (!thread_state_in_java(jt) || is_vthread_in_transition(jt)) {\n+  if (!thread_state_in_java(jt)) {\n@@ -415,1 +411,1 @@\n-    if (thread_state_in_native(thread) && !is_vthread_in_transition(thread)) {\n+    if (thread_state_in_native(thread)) {\n","filename":"src\/hotspot\/share\/jfr\/periodic\/sampling\/jfrThreadSampler.cpp","additions":2,"deletions":6,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -141,0 +141,1 @@\n+  bool _vthread;\n@@ -143,1 +144,0 @@\n-  bool _vthread;\n@@ -168,6 +168,4 @@\n-    _cont_entry(JfrThreadLocal::is_vthread(jt) ? jt->last_continuation() : nullptr),\n-    _async_mode(async_mode), _vthread(JfrThreadLocal::is_vthread(jt)) {\n-  if (_vthread && _cont_entry == nullptr) {\n-    _mode = at_end_mode;\n-    return;\n-  }\n+    _vthread(JfrThreadLocal::is_vthread(jt)),\n+    _cont_entry(_vthread ? jt->last_continuation() : nullptr),\n+    _async_mode(async_mode) {\n+  assert(!_vthread || _cont_entry != nullptr, \"invariant\");\n","filename":"src\/hotspot\/share\/jfr\/recorder\/stacktrace\/jfrStackTrace.cpp","additions":5,"deletions":7,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -398,1 +398,1 @@\n-  if (!t->is_Java_thread() || !Atomic::load_acquire(&tl->_vthread)) {\n+  if (!t->is_Java_thread()) {\n@@ -401,1 +401,0 @@\n-  \/\/ virtual thread\n@@ -403,0 +402,4 @@\n+  if (!is_vthread(jt)) {\n+    return jvm_thread_id(t, tl);\n+  }\n+  \/\/ virtual thread\n@@ -459,1 +462,1 @@\n-  return Atomic::load_acquire(&jt->jfr_thread_local()->_vthread);\n+  return Atomic::load_acquire(&jt->jfr_thread_local()->_vthread) && jt->last_continuation() != nullptr;\n","filename":"src\/hotspot\/share\/jfr\/support\/jfrThreadLocal.cpp","additions":6,"deletions":3,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -295,0 +295,1 @@\n+    @ChangesCurrentThread\n","filename":"src\/java.base\/share\/classes\/java\/lang\/VirtualThread.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"}]}