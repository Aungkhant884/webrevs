{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1997, 2018, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1997, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -2816,1 +2816,4 @@\n-                    if (value instanceof CSS.CssValue) {\n+                    if (value instanceof CSS.FontSize) {\n+                        return ((CSS.FontSize)value)\n+                                     .getValue(this, StyleSheet.this);\n+                    } else if (value instanceof CSS.CssValue) {\n","filename":"src\/java.desktop\/share\/classes\/javax\/swing\/text\/html\/StyleSheet.java","additions":5,"deletions":2,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -0,0 +1,169 @@\n+\/*\n+ * Copyright (c) 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+import java.awt.BorderLayout;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import javax.swing.JEditorPane;\n+import javax.swing.JFrame;\n+import javax.swing.JScrollPane;\n+import javax.swing.SwingUtilities;\n+import javax.swing.text.AbstractDocument.AbstractElement;\n+import javax.swing.text.Document;\n+import javax.swing.text.GlyphView;\n+import javax.swing.text.View;\n+import javax.swing.text.html.HTMLEditorKit;\n+import javax.swing.text.html.StyleSheet;\n+\n+\/*\n+ * @test\n+ * @bug 8260687\n+ * @summary  Tests inherited font-size is the same as explicitly specified\n+ * @run main BodyInheritedFontSize\n+ *\/\n+public class BodyInheritedFontSize {\n+    private static final String HTML_TEXT = \"\"\"\n+            <html>\n+            <body>\n+              <p style=\"font-size: 100%\">100% from body<\/p>\n+              <p>16pt inherited from body<\/p>\n+              <p style=\"font-size: 16pt\">16pt paragraph<\/p>\n+            <\/body>\n+            <\/html>\n+            \"\"\";\n+\n+    private static JEditorPane createEditorPane(boolean w3cUnits, boolean showFrame) {\n+        JEditorPane htmlPane = new JEditorPane();\n+        htmlPane.setEditable(false);\n+\n+        if (w3cUnits) {\n+            htmlPane.putClientProperty(JEditorPane.W3C_LENGTH_UNITS, Boolean.TRUE);\n+        }\n+\n+        HTMLEditorKit kit = new HTMLEditorKit();\n+        htmlPane.setEditorKit(kit);\n+\n+        StyleSheet styleSheet = kit.getStyleSheet();\n+        styleSheet.addRule(\"body { font-family: sans-serif; font-size: 16pt; }\");\n+\n+        Document doc = kit.createDefaultDocument();\n+        htmlPane.setDocument(doc);\n+        htmlPane.setText(HTML_TEXT);\n+\n+        if (showFrame) {\n+            JFrame frame = new JFrame(\"HtmlFontSizeGUITest: \"\n+                                              + (w3cUnits ? \"w3c\" : \"std\"));\n+            frame.setDefaultCloseOperation(JFrame.DISPOSE_ON_CLOSE);\n+            frame.add(new JScrollPane(htmlPane), BorderLayout.CENTER);\n+            frame.setLocationRelativeTo(null);\n+            frame.pack();\n+            frame.setVisible(true);\n+        }\n+\n+        \/\/ Ignore the result but perform layout\n+        htmlPane.getPreferredSize();\n+\n+        return htmlPane;\n+    }\n+\n+    public static void main(String[] args) throws Exception {\n+        final List<String> argsList = Arrays.asList(args);\n+        final boolean showFrame = toShowFrame(argsList);\n+        final boolean debugPrint = toDebugPrint(argsList);\n+\n+        final List<Exception> exceptions = new ArrayList<>(2);\n+        SwingUtilities.invokeAndWait(() -> {\n+            for (boolean w3cUnits : new boolean[] {true, false}) {\n+                JEditorPane htmlPane = createEditorPane(w3cUnits, showFrame);\n+                try {\n+                    checkFontSize(htmlPane, w3cUnits, debugPrint);\n+                } catch (Exception e) {\n+                    exceptions.add(e);\n+                }\n+            }\n+        });\n+        if (exceptions.size() > 0) {\n+            exceptions.forEach(System.err::println);\n+            throw new RuntimeException(\n+                    \"Test failed: \" + exceptions.get(0).getMessage(),\n+                    exceptions.get(0));\n+        }\n+    }\n+\n+    private static boolean toShowFrame(final List<String> argsList) {\n+        return argsList.contains(\"-show\");\n+    }\n+\n+    private static boolean toDebugPrint(final List<String> argsList) {\n+        return argsList.contains(\"-print\");\n+    }\n+\n+    private static void checkFontSize(JEditorPane htmlPane,\n+                                      boolean w3cUnits,\n+                                      boolean debugPrint) {\n+        final View rootView = htmlPane.getUI().getRootView(htmlPane);\n+        final View boxView = rootView.getView(0);\n+        final View bodyView = boxView.getView(1);\n+\n+        int fontSizePercentage = getViewFontSize(bodyView.getView(0), debugPrint);\n+        int fontSizeInherited  = getViewFontSize(bodyView.getView(1), debugPrint);\n+        int fontSizeExplicit   = getViewFontSize(bodyView.getView(2), debugPrint);\n+        if (debugPrint) {\n+            System.out.println(\"w3cUnits: \" + w3cUnits + \"\\n\"\n+                    + \"Percentage: \" + fontSizePercentage + \"\\n\"\n+                    + \"Inherited: \" + fontSizeInherited + \"\\n\"\n+                    + \"Explicit: \" + fontSizeExplicit + \"\\n\");\n+        }\n+        if (fontSizeInherited != fontSizeExplicit\n+                || fontSizePercentage != fontSizeExplicit) {\n+            throw new RuntimeException(\"The font size is different with \"\n+                    + (w3cUnits ? \"w3cUnits\" : \"stdUnits\") + \": \"\n+                    + \"Percentage: \" + fontSizePercentage + \" vs. \"\n+                    + \"Inherited: \" + fontSizeInherited + \" vs. \"\n+                    + \"Explicit: \" + fontSizeExplicit);\n+        }\n+    }\n+\n+    private static int getViewFontSize(View paragraphView, boolean debugPrint) {\n+        GlyphView inlineView = findFirstTextRun(paragraphView);\n+        int fontSize = inlineView.getFont().getSize();\n+        if (debugPrint) {\n+            ((AbstractElement) inlineView.getElement()).dump(System.out, 1);\n+        }\n+        return fontSize;\n+    }\n+\n+    private static GlyphView findFirstTextRun(View view) {\n+        if (view instanceof GlyphView) {\n+            return (GlyphView) view;\n+        }\n+        for (int i = 0; i < view.getViewCount(); i++) {\n+            GlyphView textRun = findFirstTextRun(view.getView(i));\n+            if (textRun != null) {\n+                return textRun;\n+            }\n+        }\n+        return null;\n+    }\n+}\n","filename":"test\/jdk\/javax\/swing\/text\/html\/StyleSheet\/8260687\/BodyInheritedFontSize.java","additions":169,"deletions":0,"binary":false,"changes":169,"status":"added"},{"patch":"@@ -41,1 +41,2 @@\n- * @run main TestWrongCSSFontSize\n+ * @run main TestWrongCSSFontSize false\n+ * @run main TestWrongCSSFontSize true\n@@ -45,1 +46,1 @@\n-    private static String text =\n+    private static final String TEXT =\n@@ -64,2 +65,4 @@\n-    private static int expectedFontSize = 21;\n-    private static int expectedAssertions = 8;\n+    private static final int expectedFontSize = 21;\n+    private static final int expectedAssertions = 8;\n+\n+    private final boolean w3cUnits;\n@@ -69,0 +72,4 @@\n+    public TestWrongCSSFontSize(boolean w3cUnits) {\n+        this.w3cUnits = w3cUnits;\n+    }\n+\n@@ -72,1 +79,4 @@\n-        editor.setText(text);\n+        if (w3cUnits) {\n+            editor.putClientProperty(JEditorPane.W3C_LENGTH_UNITS, Boolean.TRUE);\n+        }\n+        editor.setText(TEXT);\n@@ -80,1 +90,2 @@\n-            throw new AssertionError(\"assertion count expected [\"\n+            throw new AssertionError((w3cUnits ? \"w3cUnits - \" : \"\")\n+                    + \"assertion count expected [\"\n@@ -107,1 +118,2 @@\n-            throw new AssertionError(\"font size expected [\"\n+            throw new AssertionError((w3cUnits ? \"w3cUnits - \" : \"\")\n+                    + \"font size expected [\"\n@@ -137,1 +149,2 @@\n-        TestWrongCSSFontSize test = new TestWrongCSSFontSize();\n+        TestWrongCSSFontSize test = new TestWrongCSSFontSize(\n+                (args.length > 0) && Boolean.parseBoolean(args[0]));\n","filename":"test\/jdk\/javax\/swing\/text\/html\/StyleSheet\/TestWrongCSSFontSize.java","additions":21,"deletions":8,"binary":false,"changes":29,"status":"modified"}]}