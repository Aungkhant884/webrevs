{"files":[{"patch":"@@ -1682,0 +1682,2 @@\n+int java_lang_Thread::_jvmti_VTMS_transition_disable_count_offset;\n+int java_lang_Thread::_jvmti_is_in_VTMS_transition_offset;\n@@ -1732,0 +1734,25 @@\n+int java_lang_Thread::VTMS_transition_disable_count(oop java_thread) {\n+  return java_thread->int_field(_jvmti_VTMS_transition_disable_count_offset);\n+}\n+\n+void java_lang_Thread::inc_VTMS_transition_disable_count(oop java_thread) {\n+  assert(JvmtiVTMSTransition_lock->owned_by_self(), \"Must be locked\");\n+  int val = VTMS_transition_disable_count(java_thread);\n+  java_thread->int_field_put(_jvmti_VTMS_transition_disable_count_offset, val + 1);\n+}\n+\n+void java_lang_Thread::dec_VTMS_transition_disable_count(oop java_thread) {\n+  assert(JvmtiVTMSTransition_lock->owned_by_self(), \"Must be locked\");\n+  int val = VTMS_transition_disable_count(java_thread);\n+  assert(val > 0, \"VTMS_transition_disable_count should never be negative\");\n+  java_thread->int_field_put(_jvmti_VTMS_transition_disable_count_offset, val - 1);\n+}\n+\n+bool java_lang_Thread::is_in_VTMS_transition(oop java_thread) {\n+  return java_thread->bool_field_volatile(_jvmti_is_in_VTMS_transition_offset);\n+}\n+\n+void java_lang_Thread::set_is_in_VTMS_transition(oop java_thread, bool val) {\n+  java_thread->bool_field_put_volatile(_jvmti_is_in_VTMS_transition_offset, val);\n+}\n+\n","filename":"src\/hotspot\/share\/classfile\/javaClasses.cpp","additions":27,"deletions":0,"binary":false,"changes":27,"status":"modified"},{"patch":"@@ -338,0 +338,2 @@\n+  macro(java_lang_Thread, jvmti_VTMS_transition_disable_count, int_signature, false) \\\n+  macro(java_lang_Thread, jvmti_is_in_VTMS_transition, bool_signature, false) \\\n@@ -351,0 +353,2 @@\n+  static int _jvmti_VTMS_transition_disable_count_offset;\n+  static int _jvmti_is_in_VTMS_transition_offset;\n@@ -400,0 +404,5 @@\n+  static int  VTMS_transition_disable_count(oop java_thread);\n+  static void inc_VTMS_transition_disable_count(oop java_thread);\n+  static void dec_VTMS_transition_disable_count(oop java_thread);\n+  static bool is_in_VTMS_transition(oop java_thread);\n+  static void set_is_in_VTMS_transition(oop java_thread, bool val);\n","filename":"src\/hotspot\/share\/classfile\/javaClasses.hpp","additions":9,"deletions":0,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -523,0 +523,2 @@\n+  template(jvmti_VTMS_transition_disable_count_name,  \"jvmti_VTMS_transition_disable_count\")      \\\n+  template(jvmti_is_in_VTMS_transition_name,          \"jvmti_is_in_VTMS_transition\")              \\\n","filename":"src\/hotspot\/share\/classfile\/vmSymbols.hpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -152,1 +152,1 @@\n-  JvmtiVTMSTransitionDisabler disabler;\n+  JvmtiVTMSTransitionDisabler disabler(thread);\n@@ -205,1 +205,1 @@\n-    JvmtiVTMSTransitionDisabler disabler;\n+    JvmtiVTMSTransitionDisabler disabler(thread);\n@@ -578,1 +578,1 @@\n-  JvmtiVTMSTransitionDisabler disabler;\n+  JvmtiVTMSTransitionDisabler disabler(event_thread);\n@@ -859,1 +859,1 @@\n-  JvmtiVTMSTransitionDisabler disabler;\n+  JvmtiVTMSTransitionDisabler disabler(thread);\n@@ -1184,1 +1184,1 @@\n-  JvmtiVTMSTransitionDisabler disabler;\n+  JvmtiVTMSTransitionDisabler disabler(thread);\n@@ -1216,1 +1216,1 @@\n-  JvmtiVTMSTransitionDisabler disabler;\n+  JvmtiVTMSTransitionDisabler disabler(thread);\n@@ -1261,1 +1261,1 @@\n-  JvmtiVTMSTransitionDisabler disabler;\n+  JvmtiVTMSTransitionDisabler disabler(thread);\n@@ -1361,1 +1361,1 @@\n-  JvmtiVTMSTransitionDisabler disabler;\n+  JvmtiVTMSTransitionDisabler disabler(thread);\n@@ -1434,1 +1434,1 @@\n-  JvmtiVTMSTransitionDisabler disabler;\n+  JvmtiVTMSTransitionDisabler disabler(thread);\n@@ -1504,1 +1504,1 @@\n-  JvmtiVTMSTransitionDisabler disabler;\n+  JvmtiVTMSTransitionDisabler disabler(thread);\n@@ -1718,1 +1718,1 @@\n-  JvmtiVTMSTransitionDisabler disabler;\n+  JvmtiVTMSTransitionDisabler disabler(thread);\n@@ -1836,1 +1836,1 @@\n-  JvmtiVTMSTransitionDisabler disabler;\n+  JvmtiVTMSTransitionDisabler disabler(thread);\n@@ -1880,1 +1880,1 @@\n-  JvmtiVTMSTransitionDisabler disabler;\n+  JvmtiVTMSTransitionDisabler disabler(thread);\n@@ -1928,1 +1928,1 @@\n-  JvmtiVTMSTransitionDisabler disabler;\n+  JvmtiVTMSTransitionDisabler disabler(thread);\n@@ -1968,1 +1968,1 @@\n-  JvmtiVTMSTransitionDisabler disabler;\n+  JvmtiVTMSTransitionDisabler disabler(thread);\n@@ -2246,1 +2246,1 @@\n-  JvmtiVTMSTransitionDisabler disabler;\n+  JvmtiVTMSTransitionDisabler disabler(thread);\n@@ -2287,1 +2287,1 @@\n-  JvmtiVTMSTransitionDisabler disabler;\n+  JvmtiVTMSTransitionDisabler disabler(thread);\n@@ -2329,1 +2329,1 @@\n-  JvmtiVTMSTransitionDisabler disabler;\n+  JvmtiVTMSTransitionDisabler disabler(thread);\n@@ -2371,1 +2371,1 @@\n-  JvmtiVTMSTransitionDisabler disabler;\n+  JvmtiVTMSTransitionDisabler disabler(thread);\n@@ -2413,1 +2413,1 @@\n-  JvmtiVTMSTransitionDisabler disabler;\n+  JvmtiVTMSTransitionDisabler disabler(thread);\n@@ -2455,1 +2455,1 @@\n-  JvmtiVTMSTransitionDisabler disabler;\n+  JvmtiVTMSTransitionDisabler disabler(thread);\n@@ -2496,1 +2496,1 @@\n-  JvmtiVTMSTransitionDisabler disabler;\n+  JvmtiVTMSTransitionDisabler disabler(thread);\n@@ -2533,1 +2533,1 @@\n-  JvmtiVTMSTransitionDisabler disabler;\n+  JvmtiVTMSTransitionDisabler disabler(thread);\n@@ -2570,1 +2570,1 @@\n-  JvmtiVTMSTransitionDisabler disabler;\n+  JvmtiVTMSTransitionDisabler disabler(thread);\n@@ -2607,1 +2607,1 @@\n-  JvmtiVTMSTransitionDisabler disabler;\n+  JvmtiVTMSTransitionDisabler disabler(thread);\n@@ -2644,1 +2644,1 @@\n-  JvmtiVTMSTransitionDisabler disabler;\n+  JvmtiVTMSTransitionDisabler disabler(thread);\n","filename":"src\/hotspot\/share\/prims\/jvmtiEnv.cpp","additions":26,"deletions":26,"binary":false,"changes":52,"status":"modified"},{"patch":"@@ -683,1 +683,1 @@\n-  jvf = check_and_skip_hidden_frames(state->is_in_VTMS_transition(), jvf);\n+  jvf = check_and_skip_hidden_frames(java_lang_Thread::is_in_VTMS_transition(vthread), jvf);\n@@ -1915,1 +1915,1 @@\n-  JvmtiVTMSTransitionDisabler disabler;\n+  JvmtiVTMSTransitionDisabler disabler(thread);\n","filename":"src\/hotspot\/share\/prims\/jvmtiEnvBase.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -379,1 +379,0 @@\n-    assert(!jvmti_thread_state()->is_in_VTMS_transition(), \"sanity check\");\n","filename":"src\/hotspot\/share\/prims\/jvmtiEnvThreadState.cpp","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -87,1 +87,0 @@\n-  _is_in_VTMS_transition = false;\n@@ -221,2 +220,5 @@\n-\/\/ VTMS transitions is disabled while this counter is positive\n-volatile int JvmtiVTMSTransitionDisabler::_VTMS_transition_disable_count = 0;\n+\/\/ VTMS transitions for one virtual thread are disabled while it is positive\n+volatile int JvmtiVTMSTransitionDisabler::_VTMS_transition_disable_for_one_count = 0;\n+\n+\/\/ VTMs transitions for all virtual threads are disabled while it is positive\n+volatile int JvmtiVTMSTransitionDisabler::_VTMS_transition_disable_for_all_count = 0;\n@@ -231,2 +233,3 @@\n-  log_error(jvmti)(\"_VTMS_transition_disable_count: %d _VTMS_transition_count: %d\\n\\n\",\n-                   _VTMS_transition_disable_count, _VTMS_transition_count);\n+  log_error(jvmti)(\"_VTMS_transition_count: %d\\n\", _VTMS_transition_count);\n+  log_error(jvmti)(\"_VTMS_transition_disable_for_one_count: %d\\n\", _VTMS_transition_disable_for_one_count);\n+  log_error(jvmti)(\"_VTMS_transition_disable_for_all_count: %d\\n\\n\", _VTMS_transition_disable_for_all_count);\n@@ -243,1 +246,22 @@\n-JvmtiVTMSTransitionDisabler::JvmtiVTMSTransitionDisabler(bool is_SR) {\n+\/\/ disable VTMS transitions for one virtual thread\n+\/\/ no-op if thread is non-NULL and not a virtual thread\n+JvmtiVTMSTransitionDisabler::JvmtiVTMSTransitionDisabler(jthread thread)\n+  : _is_SR(false), _thread(thread)\n+{\n+  if (!Continuations::enabled()) {\n+    return; \/\/ JvmtiVTMSTransitionDisabler is no-op without virtual threads\n+  }\n+  if (Thread::current_or_null() == nullptr) {\n+    return;  \/\/ Detached thread, can be a call from Agent_OnLoad.\n+  }\n+  if (_thread != nullptr) {\n+    VTMS_transition_disable_for_one(); \/\/ disable VTMS transitions for one virtual thread\n+  } else {\n+    VTMS_transition_disable_for_all(); \/\/ disable VTMS transitions for all virtual threads\n+  }\n+}\n+\n+\/\/ disable VTMS transitions for all virtual threads\n+JvmtiVTMSTransitionDisabler::JvmtiVTMSTransitionDisabler(bool is_SR)\n+  : _is_SR(is_SR), _thread(nullptr)\n+{\n@@ -247,1 +271,1 @@\n-  if (Thread::current_or_null() == NULL) {\n+  if (Thread::current_or_null() == nullptr) {\n@@ -250,2 +274,1 @@\n-  _is_SR = is_SR;\n-  disable_VTMS_transitions();\n+  VTMS_transition_disable_for_all();\n@@ -258,1 +281,1 @@\n-  if (Thread::current_or_null() == NULL) {\n+  if (Thread::current_or_null() == nullptr) {\n@@ -261,1 +284,5 @@\n-  enable_VTMS_transitions();\n+  if (_thread != nullptr) {\n+    VTMS_transition_enable_for_one(); \/\/ enable VTMS transitions for one virtual thread\n+  } else {\n+    VTMS_transition_enable_for_all(); \/\/ enable VTMS transitions for all virtual threads\n+  }\n@@ -264,0 +291,1 @@\n+\/\/ disable VTMS transitions for one virtual thread\n@@ -265,1 +293,28 @@\n-JvmtiVTMSTransitionDisabler::disable_VTMS_transitions() {\n+JvmtiVTMSTransitionDisabler::VTMS_transition_disable_for_one() {\n+  assert(_thread != NULL, \"sanity check\");\n+  JavaThread* thread = JavaThread::current();\n+  HandleMark hm(thread);\n+  Handle vth = Handle(thread, JNIHandles::resolve_external_guard(_thread));\n+  if (!java_lang_VirtualThread::is_instance(vth())) {\n+    return; \/\/ no-op if _thread is not a virtual thread\n+  }\n+  ThreadBlockInVM tbivm(thread);\n+  MonitorLocker ml(JvmtiVTMSTransition_lock, Mutex::_no_safepoint_check_flag);\n+\n+  while (_SR_mode) { \/\/ suspender or resumer is a JvmtiVTMSTransitionDisabler monopolist\n+    ml.wait(10); \/\/ wait while there is an active suspender or resumer\n+  }\n+  Atomic::inc(&_VTMS_transition_disable_for_one_count);\n+  java_lang_Thread::inc_VTMS_transition_disable_count(vth());\n+\n+  while (java_lang_Thread::is_in_VTMS_transition(vth())) {\n+    ml.wait(10); \/\/ wait while the virtual thread is in transition\n+  }\n+#ifdef ASSERT\n+  thread->set_is_VTMS_transition_disabler(true);\n+#endif\n+}\n+\n+\/\/ disable VTMS transitions for all virtual threads\n+void\n+JvmtiVTMSTransitionDisabler::VTMS_transition_disable_for_all() {\n@@ -279,1 +334,1 @@\n-      while (_VTMS_transition_disable_count > 0) {\n+      while (_VTMS_transition_disable_for_all_count > 0) {\n@@ -283,1 +338,1 @@\n-    Atomic::inc(&_VTMS_transition_disable_count);\n+    Atomic::inc(&_VTMS_transition_disable_for_all_count);\n@@ -303,1 +358,1 @@\n-      fatal(\"stuck in JvmtiVTMSTransitionDisabler::disable_VTMS_transitions\");\n+      fatal(\"stuck in JvmtiVTMSTransitionDisabler::VTMS_transition_disable\");\n@@ -308,0 +363,1 @@\n+\/\/ enable VTMS transitions for one virtual thread\n@@ -309,1 +365,21 @@\n-JvmtiVTMSTransitionDisabler::enable_VTMS_transitions() {\n+JvmtiVTMSTransitionDisabler::VTMS_transition_enable_for_one() {\n+  JavaThread* thread = JavaThread::current();\n+  HandleMark hm(thread);\n+  Handle vth = Handle(thread, JNIHandles::resolve_external_guard(_thread));\n+  if (!java_lang_VirtualThread::is_instance(vth())) {\n+    return; \/\/ no-op if _thread is not a virtual thread\n+  }\n+  MonitorLocker ml(JvmtiVTMSTransition_lock, Mutex::_no_safepoint_check_flag);\n+  java_lang_Thread::dec_VTMS_transition_disable_count(vth());\n+  Atomic::dec(&_VTMS_transition_disable_for_one_count);\n+  if (_VTMS_transition_disable_for_one_count == 0 || _is_SR) {\n+    ml.notify_all();\n+  }\n+#ifdef ASSERT\n+  thread->set_is_VTMS_transition_disabler(false);\n+#endif\n+}\n+\n+\/\/ enable VTMS transitions for all virtual threads\n+void\n+JvmtiVTMSTransitionDisabler::VTMS_transition_enable_for_all() {\n@@ -313,1 +389,1 @@\n-    assert(_VTMS_transition_disable_count > 0, \"VTMS_transition sanity check\");\n+    assert(_VTMS_transition_disable_for_all_count > 0, \"VTMS_transition sanity check\");\n@@ -318,2 +394,2 @@\n-    Atomic::dec(&_VTMS_transition_disable_count);\n-    if (_VTMS_transition_disable_count == 0 || _is_SR) {\n+    Atomic::dec(&_VTMS_transition_disable_for_all_count);\n+    if (_VTMS_transition_disable_for_all_count == 0 || _is_SR) {\n@@ -338,0 +414,1 @@\n+  java_lang_Thread::set_is_in_VTMS_transition(vth(), true);\n@@ -342,1 +419,3 @@\n-  if (_VTMS_transition_disable_count > 0 ||\n+\n+  if (_VTMS_transition_disable_for_all_count > 0 ||\n+      java_lang_Thread::VTMS_transition_disable_count(vth()) > 0 ||\n@@ -349,0 +428,1 @@\n+    java_lang_Thread::set_is_in_VTMS_transition(vth(), false);\n@@ -356,1 +436,2 @@\n-      if (_VTMS_transition_disable_count > 0 ||\n+      if (_VTMS_transition_disable_for_all_count > 0 ||\n+          java_lang_Thread::VTMS_transition_disable_count(vth()) > 0 ||\n@@ -368,0 +449,1 @@\n+      java_lang_Thread::set_is_in_VTMS_transition(vth(), true);\n@@ -382,4 +464,0 @@\n-  JvmtiThreadState* vstate = java_lang_Thread::jvmti_thread_state(vth());\n-  if (vstate != NULL) {\n-    vstate->set_is_in_VTMS_transition(true);\n-  }\n@@ -396,4 +474,1 @@\n-  JvmtiThreadState* vstate = java_lang_Thread::jvmti_thread_state(vt);\n-  if (vstate != NULL) {\n-    vstate->set_is_in_VTMS_transition(false);\n-  }\n+  java_lang_Thread::set_is_in_VTMS_transition(vt, false);\n@@ -404,1 +479,2 @@\n-  if (_VTMS_transition_disable_count > 0) {\n+  if (_VTMS_transition_disable_for_one_count > 0 ||\n+      _VTMS_transition_disable_for_all_count > 0) {\n","filename":"src\/hotspot\/share\/prims\/jvmtiThreadState.cpp","additions":106,"deletions":30,"binary":false,"changes":136,"status":"modified"},{"patch":"@@ -82,3 +82,4 @@\n-  static volatile bool _SR_mode;                      \/\/ there is an active suspender or resumer\n-  static volatile int _VTMS_transition_count;         \/\/ current number of VTMS transitions\n-  static volatile int _VTMS_transition_disable_count; \/\/ VTMS transitions are disabled while it is non-zero\n+  static volatile int _VTMS_transition_disable_for_one_count; \/\/ transitions for one virtual thread are disabled while it is positive\n+  static volatile int _VTMS_transition_disable_for_all_count; \/\/ transitions for all virtual threads are disabled while it is positive\n+  static volatile bool _SR_mode;                         \/\/ there is an active suspender or resumer\n+  static volatile int _VTMS_transition_count;            \/\/ current number of VTMS transitions\n@@ -86,4 +87,2 @@\n-  bool _is_SR;                                        \/\/ is suspender or resumer\n-\n-  void disable_VTMS_transitions();\n-  void enable_VTMS_transitions();\n+  bool _is_SR;                                           \/\/ is suspender or resumer\n+  jthread _thread;                                       \/\/ virtual thread to disable transitions for, no-op if it is a platform thread\n@@ -92,0 +91,5 @@\n+  void VTMS_transition_disable_for_one();\n+  void VTMS_transition_disable_for_all();\n+  void VTMS_transition_enable_for_one();\n+  void VTMS_transition_enable_for_all();\n+\n@@ -95,0 +99,1 @@\n+  JvmtiVTMSTransitionDisabler(jthread thread);\n@@ -156,1 +161,0 @@\n-  bool              _is_in_VTMS_transition; \/\/ saved JavaThread.is_in_VTMS_transition()\n@@ -273,3 +277,0 @@\n-  \/\/ The JavaThread is_in_VTMS_transition() bit saved at unmount to restore at mount.\n-  inline bool is_in_VTMS_transition() { return _is_in_VTMS_transition; }\n-  inline void set_is_in_VTMS_transition(bool val) { _is_in_VTMS_transition = val; }\n","filename":"src\/hotspot\/share\/prims\/jvmtiThreadState.hpp","additions":12,"deletions":11,"binary":false,"changes":23,"status":"modified"}]}