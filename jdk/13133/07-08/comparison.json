{"files":[{"patch":"@@ -1536,0 +1536,1 @@\n+  \/\/ This function is called only if _enable == true.\n@@ -1547,1 +1548,1 @@\n-      bool virt = vt_oop != nullptr && vt_oop != ct_oop;\n+      bool virt = vt_oop != nullptr && java_lang_VirtualThread::is_instance(vt_oop);\n@@ -1554,5 +1555,4 @@\n-      if (jt_state != ct_state && jt_state != vt_state) {\n-        JvmtiThreadState* cur_state = virt ? vt_state : ct_state;\n-        jt->set_jvmti_thread_state(cur_state); \/\/ restore jt->jvmti_thread_state()\n-        if (virt) {\n-          jt->set_jvmti_vthread(vt_oop);       \/\/ restore jt->jvmti_vthread()\n+      if (virt) {\n+        if (jt_state != vt_state) {\n+          jt->set_jvmti_thread_state(vt_state); \/\/ restore jt->jvmti_thread_state()\n+          jt->set_jvmti_vthread(vt_oop);        \/\/ restore jt->jvmti_vthread()\n@@ -1560,1 +1560,1 @@\n-            vt_state->set_thread(jt);          \/\/ restore JavaThread link\n+            vt_state->set_thread(jt);           \/\/ restore JavaThread link\n@@ -1562,2 +1562,5 @@\n-        } else {\n-          jt->set_jvmti_vthread(nullptr);      \/\/ reset jt->jvmti_vthread()\n+        }\n+      } else { \/\/ !virt\n+        if (jt_state != ct_state) {\n+          jt->set_jvmti_thread_state(ct_state); \/\/ restore jt->jvmti_thread_state()\n+          jt->set_jvmti_vthread(ct_oop);        \/\/ reset jt->jvmti_vthread()\n@@ -1576,1 +1579,1 @@\n-    int count = count_transitions_and_correct_jvmti_thread_states();\n+    int count = _enable ? count_transitions_and_correct_jvmti_thread_states() : 0;\n","filename":"src\/hotspot\/share\/prims\/jvmtiEnvBase.cpp","additions":13,"deletions":10,"binary":false,"changes":23,"status":"modified"}]}