{"files":[{"patch":"@@ -26,2 +26,3 @@\n- * @bug 4533243\n- * @summary Closing a keep alive stream gives NullPointerException\n+ * @bug 4533243 8263364\n+ * @summary Closing a keep alive stream should not give NullPointerException and should accept a connection from  a\n+ *          client only from this test\n@@ -34,0 +35,1 @@\n+\n@@ -38,0 +40,3 @@\n+    private final static String path = \"\/KeepAliveStreamCloseWithWrongContentLength\";\n+    private final static String getRequest1stLine = \"GET %s\".formatted(path);\n+\n@@ -39,4 +44,0 @@\n-        ServerSocket srv;\n-        Socket s;\n-        InputStream is;\n-        OutputStream os;\n@@ -44,2 +45,5 @@\n-        XServer (ServerSocket s) {\n-            srv = s;\n+        ServerSocket serverSocket;\n+        OutputStream outputStream;\n+\n+        XServer (ServerSocket socket) {\n+            serverSocket = socket;\n@@ -50,6 +54,30 @@\n-                s = srv.accept ();\n-                \/\/ read HTTP request from client\n-                InputStream is = s.getInputStream();\n-                \/\/ read the first ten bytes\n-                for (int i=0; i<10; i++) {\n-                    is.read();\n+\n+                ByteArrayOutputStream clientBytes;\n+                Socket socket = null;\n+\n+                \/\/ in a concurrent test environment it can happen that other rouge clients connect to this server\n+                \/\/ so we need to identify and connect only to the client from this test\n+                \/\/ if the rouge client sends as least bytes as there is in getRequest1stLine it will be discarded and\n+                \/\/ the test should proceed otherwise it should timeout on readNBytes below\n+                do {\n+                    if (socket != null) {\n+                        final String client = \"%s:%d\".formatted(\n+                                socket.getInetAddress().getHostAddress(),\n+                                socket.getPort()\n+                        );\n+                        try {\n+                            socket.close();\n+                        }\n+                        catch (IOException ioe) {\n+                            ioe.printStackTrace();\n+                        }\n+                        finally {\n+                            System.err.println(\"rogue client (%s) connection attempt, ignoring\".formatted(client));\n+                        }\n+                    }\n+\n+                    socket = serverSocket.accept();\n+\n+                    \/\/ read HTTP request from client\n+                    clientBytes = new ByteArrayOutputStream();\n+                    clientBytes.write(socket.getInputStream().readNBytes(getRequest1stLine.getBytes().length));\n@@ -57,3 +85,4 @@\n-                OutputStreamWriter ow =\n-                    new OutputStreamWriter((os = s.getOutputStream()));\n-                ow.write(\"HTTP\/1.0 200 OK\\n\");\n+                while(!getRequest1stLine.equals(clientBytes.toString()));\n+\n+                OutputStreamWriter outputStreamWriter = new OutputStreamWriter(outputStream = socket.getOutputStream());\n+                outputStreamWriter.write(\"HTTP\/1.0 200 OK\\n\");\n@@ -62,2 +91,2 @@\n-                ow.write(\"Content-Length: 10\\n\");\n-                ow.write(\"Content-Type: text\/html\\n\");\n+                outputStreamWriter.write(\"Content-Length: 10\\n\");\n+                outputStreamWriter.write(\"Content-Type: text\/html\\n\");\n@@ -66,2 +95,2 @@\n-                ow.write(\"Connection: Keep-Alive\\n\");\n-                ow.write(\"\\n\");\n+                outputStreamWriter.write(\"Connection: Keep-Alive\\n\");\n+                outputStreamWriter.write(\"\\n\");\n@@ -70,2 +99,2 @@\n-                ow.write(\"123456789\");\n-                ow.flush();\n+                outputStreamWriter.write(\"123456789\");\n+                outputStreamWriter.flush();\n@@ -73,0 +102,1 @@\n+                e.printStackTrace();\n@@ -74,1 +104,1 @@\n-                try {if (os != null) { os.close(); }} catch (IOException e) {}\n+                try {if (outputStream != null) { outputStream.close(); }} catch (IOException e) {}\n@@ -80,0 +110,3 @@\n+\n+        final Integer port = 61234;\n+\n@@ -82,1 +115,1 @@\n-        serversocket.bind(new InetSocketAddress(loopback, 0));\n+        serversocket.bind(new InetSocketAddress(loopback, port));\n@@ -85,2 +118,1 @@\n-            int port = serversocket.getLocalPort ();\n-            XServer server = new XServer (serversocket);\n+            XServer server = new XServer(serversocket);\n@@ -91,0 +123,1 @@\n+                .path(path)\n@@ -94,1 +127,1 @@\n-            InputStream is = urlc.getInputStream ();\n+            InputStream is = urlc.getInputStream();\n@@ -106,1 +139,1 @@\n-            return;\n+            throw new RuntimeException (e);\n","filename":"test\/jdk\/sun\/net\/www\/http\/KeepAliveStream\/KeepAliveStreamCloseWithWrongContentLength.java","additions":62,"deletions":29,"binary":false,"changes":91,"status":"modified"}]}