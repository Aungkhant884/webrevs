{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2005, 2018, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2005, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -61,3 +61,2 @@\n-    \/\/ file descriptors used for interrupt\n-    private final int fd0;\n-    private final int fd1;\n+    \/\/ eventfd object used for interrupt\n+    private final EventFD eventfd;\n@@ -83,3 +82,1 @@\n-            long fds = IOUtil.makePipe(false);\n-            this.fd0 = (int) (fds >>> 32);\n-            this.fd1 = (int) fds;\n+            this.eventfd = new EventFD();\n@@ -93,1 +90,1 @@\n-        EPoll.ctl(epfd, EPOLL_CTL_ADD, fd0, EPOLLIN);\n+        EPoll.ctl(epfd, EPOLL_CTL_ADD, eventfd.efd(), EPOLLIN);\n@@ -191,1 +188,1 @@\n-            if (fd == fd0) {\n+            if (fd == eventfd.efd()) {\n@@ -221,2 +218,1 @@\n-        FileDispatcherImpl.closeIntFD(fd0);\n-        FileDispatcherImpl.closeIntFD(fd1);\n+        eventfd.close();\n@@ -254,1 +250,1 @@\n-                    IOUtil.write1(fd1, (byte)0);\n+                    eventfd.set();\n@@ -266,1 +262,1 @@\n-            IOUtil.drain(fd0);\n+            eventfd.reset();\n","filename":"src\/java.base\/linux\/classes\/sun\/nio\/ch\/EPollSelectorImpl.java","additions":9,"deletions":13,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -0,0 +1,64 @@\n+\/*\n+ * Copyright (c) 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package sun.nio.ch;\n+\n+import java.io.IOException;\n+\n+\/*\n+ * Provides access to the Linux eventfd object.\n+ *\/\n+final class EventFD {\n+    private final int efd;\n+\n+    \/**\n+     * Creates a non-blocking eventfd object with initial value zero.\n+     *\/\n+    EventFD() throws IOException {\n+        efd = eventfd0();\n+    }\n+\n+    int efd() {\n+        return efd;\n+    }\n+\n+    void set() throws IOException {\n+        IOUtil.write(efd, 1L);\n+    }\n+\n+    void reset() throws IOException {\n+        IOUtil.drain(efd);\n+    }\n+\n+    void close() throws IOException {\n+        FileDispatcherImpl.closeIntFD(efd);\n+    }\n+\n+    static native int eventfd0() throws IOException;\n+\n+    static {\n+        IOUtil.load();\n+    }\n+}\n","filename":"src\/java.base\/linux\/classes\/sun\/nio\/ch\/EventFD.java","additions":64,"deletions":0,"binary":false,"changes":64,"status":"added"},{"patch":"@@ -0,0 +1,46 @@\n+\/*\n+ * Copyright (c) 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+ #include <sys\/eventfd.h>\n+\n+#include \"jni.h\"\n+#include \"jni_util.h\"\n+#include \"jvm.h\"\n+#include \"jlong.h\"\n+#include \"nio.h\"\n+#include \"nio_util.h\"\n+\n+#include \"sun_nio_ch_EventFD.h\"\n+\n+JNIEXPORT jint JNICALL\n+Java_sun_nio_ch_EventFD_eventfd0(JNIEnv *env, jclass klazz)\n+{\n+    int efd = eventfd((uint64_t)0, EFD_NONBLOCK);\n+    if (efd == -1) {\n+        JNU_ThrowIOExceptionWithLastError(env, \"eventfd failed\");\n+        return IOS_THROWN;\n+    }\n+    return efd;\n+}\n","filename":"src\/java.base\/linux\/native\/libnio\/ch\/EventFD.c","additions":46,"deletions":0,"binary":false,"changes":46,"status":"added"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2000, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -404,0 +404,2 @@\n+    static native int write(int fd, long value) throws IOException;\n+\n","filename":"src\/java.base\/share\/classes\/sun\/nio\/ch\/IOUtil.java","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2000, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -112,0 +112,7 @@\n+}\n+\n+JNIEXPORT jint JNICALL\n+Java_sun_nio_ch_IOUtil_write(JNIEnv *env, jclass cl, jint fd, jlong value)\n+{\n+    long buf = (long)value;\n+    return convertReturnVal(env, write(fd, &buf, sizeof(long)), JNI_FALSE);\n","filename":"src\/java.base\/unix\/native\/libnio\/ch\/IOUtil.c","additions":8,"deletions":1,"binary":false,"changes":9,"status":"modified"}]}