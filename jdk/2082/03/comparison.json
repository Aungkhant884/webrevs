{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2005, 2018, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2005, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -61,3 +61,2 @@\n-    \/\/ file descriptors used for interrupt\n-    private final int fd0;\n-    private final int fd1;\n+    \/\/ eventfd object used for interrupt\n+    private final EventFD eventfd;\n@@ -83,3 +82,1 @@\n-            long fds = IOUtil.makePipe(false);\n-            this.fd0 = (int) (fds >>> 32);\n-            this.fd1 = (int) fds;\n+            this.eventfd = new EventFD();\n@@ -93,1 +90,1 @@\n-        EPoll.ctl(epfd, EPOLL_CTL_ADD, fd0, EPOLLIN);\n+        EPoll.ctl(epfd, EPOLL_CTL_ADD, eventfd.efd(), EPOLLIN);\n@@ -191,1 +188,1 @@\n-            if (fd == fd0) {\n+            if (fd == eventfd.efd()) {\n@@ -221,2 +218,1 @@\n-        FileDispatcherImpl.closeIntFD(fd0);\n-        FileDispatcherImpl.closeIntFD(fd1);\n+        eventfd.close();\n@@ -254,1 +250,1 @@\n-                    IOUtil.write1(fd1, (byte)0);\n+                    eventfd.set();\n@@ -266,1 +262,1 @@\n-            IOUtil.drain(fd0);\n+            eventfd.reset();\n","filename":"src\/java.base\/linux\/classes\/sun\/nio\/ch\/EPollSelectorImpl.java","additions":9,"deletions":13,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -0,0 +1,74 @@\n+\/*\n+ * Copyright (c) 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package sun.nio.ch;\n+\n+import java.io.IOException;\n+\n+\/*\n+ * Provides access to the Linux eventfd object.\n+ *\/\n+final class EventFD {\n+    private final int efd;\n+\n+    \/**\n+     * Creates a non-blocking eventfd object with initial value zero.\n+     *\/\n+    EventFD() throws IOException {\n+        efd = eventfd0();\n+        IOUtil.configureBlocking(IOUtil.newFD(efd), false);\n+    }\n+\n+    int efd() {\n+        return efd;\n+    }\n+\n+    void set() throws IOException {\n+        set0(efd);\n+    }\n+\n+    void reset() throws IOException {\n+        IOUtil.drain(efd);\n+    }\n+\n+    void close() throws IOException {\n+        FileDispatcherImpl.closeIntFD(efd);\n+    }\n+\n+    static native int eventfd0() throws IOException;\n+\n+    \/**\n+     * Writes the value 1 to the eventfd object as a long in the\n+     * native byte order of the platform.\n+     *\n+     * @param the integral eventfd file descriptor\n+     * @return the number of bytes written; should equal 8\n+     *\/\n+    static native int set0(int efd) throws IOException;\n+\n+    static {\n+        IOUtil.load();\n+    }\n+}\n","filename":"src\/java.base\/linux\/classes\/sun\/nio\/ch\/EventFD.java","additions":74,"deletions":0,"binary":false,"changes":74,"status":"added"},{"patch":"@@ -0,0 +1,54 @@\n+\/*\n+ * Copyright (c) 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+ #include <sys\/eventfd.h>\n+\n+#include \"jni.h\"\n+#include \"jni_util.h\"\n+#include \"jvm.h\"\n+#include \"jlong.h\"\n+#include \"nio.h\"\n+#include \"nio_util.h\"\n+\n+#include \"sun_nio_ch_EventFD.h\"\n+\n+JNIEXPORT jint JNICALL\n+Java_sun_nio_ch_EventFD_eventfd0(JNIEnv *env, jclass klazz)\n+{\n+    int efd = eventfd((uint64_t)0, 0);\n+    if (efd == -1) {\n+        JNU_ThrowIOExceptionWithLastError(env, \"eventfd failed\");\n+        return IOS_THROWN;\n+    }\n+    return efd;\n+}\n+\n+JNIEXPORT jint JNICALL\n+Java_sun_nio_ch_EventFD_set0(JNIEnv *env, jclass klazz, jint efd)\n+{\n+    long one = 1L;\n+    return convertReturnVal(env, write(efd, (void*)&one, sizeof(long)),\n+        JNI_FALSE);\n+}\n","filename":"src\/java.base\/linux\/native\/libnio\/ch\/EventFD.c","additions":54,"deletions":0,"binary":false,"changes":54,"status":"added"},{"patch":"@@ -0,0 +1,62 @@\n+\/*\n+ * Copyright (c) 2014, Oracle America, Inc.\n+ * All rights reserved.\n+ *\n+ * Redistribution and use in source and binary forms, with or without\n+ * modification, are permitted provided that the following conditions are met:\n+ *\n+ *  * Redistributions of source code must retain the above copyright notice,\n+ *    this list of conditions and the following disclaimer.\n+ *\n+ *  * Redistributions in binary form must reproduce the above copyright\n+ *    notice, this list of conditions and the following disclaimer in the\n+ *    documentation and\/or other materials provided with the distribution.\n+ *\n+ *  * Neither the name of Oracle nor the names of its contributors may be used\n+ *    to endorse or promote products derived from this software without\n+ *    specific prior written permission.\n+ *\n+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\"\n+ * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE\n+ * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE\n+ * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE\n+ * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR\n+ * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF\n+ * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS\n+ * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN\n+ * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n+ * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF\n+ * THE POSSIBILITY OF SUCH DAMAGE.\n+ *\/\n+\n+package org.openjdk.bench.java.nio;\n+\n+import org.openjdk.jmh.annotations.Benchmark;\n+import org.openjdk.jmh.annotations.Level;\n+import org.openjdk.jmh.annotations.Scope;\n+import org.openjdk.jmh.annotations.Setup;\n+import org.openjdk.jmh.annotations.State;\n+\n+import java.io.*;\n+import java.net.*;\n+import java.nio.*;\n+import java.nio.channels.*;\n+\n+\/**\n+ * Benchmark for the Selector wakeup mechanism. Intended primarily for the\n+ * epoll(2)-based implementation on Linux.\n+ *\/\n+@State(Scope.Thread)\n+public class SelectorWakeup {\n+    private Selector sel;\n+\n+    @Setup(Level.Iteration)\n+    public void setup() throws IOException {\n+        sel = Selector.open();\n+    }\n+\n+    @Benchmark\n+    public int test() throws IOException {\n+        return sel.wakeup().select();\n+    }\n+}\n","filename":"test\/micro\/org\/openjdk\/bench\/java\/nio\/SelectorWakeup.java","additions":62,"deletions":0,"binary":false,"changes":62,"status":"added"}]}