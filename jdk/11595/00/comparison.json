{"files":[{"patch":"@@ -1011,0 +1011,1 @@\n+        if (debug.on()) debug.log(\"Close all streams\");\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/Http2Connection.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -276,0 +276,1 @@\n+        assert pendingResponseSubscriber == null;\n@@ -475,2 +476,8 @@\n-            if (cancelled) connection.dropDataFrame((DataFrame) frame);\n-            else receiveDataFrame((DataFrame) frame);\n+            if (cancelled) {\n+                if (debug.on()) {\n+                    debug.log(\"request cancelled or stream closed: dropping data frame\");\n+                }\n+                connection.dropDataFrame((DataFrame) frame);\n+            } else {\n+                receiveDataFrame((DataFrame) frame);\n+            }\n@@ -1286,0 +1293,1 @@\n+\n@@ -1287,1 +1295,3 @@\n-            if (responseSubscriber != null || pendingResponseSubscriber != null)\n+            if (responseSubscriber != null || pendingResponseSubscriber != null) {\n+                if (debug.on())\n+                    debug.log(\"stream %s closing due to %s\", streamid, (Object)errorRef.get());\n@@ -1289,0 +1299,10 @@\n+            } else {\n+                if (debug.on())\n+                    debug.log(\"stream %s closing due to %s before subscriber registered\",\n+                        streamid, (Object)errorRef.get());\n+            }\n+        } else {\n+            if (debug.on()) {\n+                debug.log(\"stream %s already closed due to %s\",\n+                        streamid, (Object)errorRef.get());\n+            }\n@@ -1290,0 +1310,1 @@\n+\n@@ -1333,0 +1354,8 @@\n+        var s = responseSubscriber == null\n+                ? pendingResponseSubscriber\n+                : responseSubscriber;\n+        if (debug.on()) debug.log(\"subscriber is %s\", s);\n+        if (s instanceof Http2StreamResponseSubscriber<?> sw) {\n+            if (debug.on()) debug.log(\"closing response subscriber stream %s\", streamid);\n+            sw.streamClosed(errorRef.get());\n+        }\n@@ -1557,0 +1586,1 @@\n+\n@@ -1561,0 +1591,18 @@\n+\n+        \/**\n+         * Make sure the subscriber gets completed if the stream gets closed\n+         * asynchronously outside of cancelImpl.\n+         * @param cause the error cause, if any\n+         *\/\n+        public void streamClosed(Throwable cause) {\n+            \/\/ if the subscriber has already completed,\n+            \/\/ there is nothing to do...\n+            if (!completed()) {\n+                \/\/ otherwise makes sur it will be completed\n+                var ex = cause == null\n+                        ? new IOException(\"stream closed\")\n+                        : cause;\n+                complete(ex);\n+            }\n+        }\n+\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/Stream.java","additions":51,"deletions":3,"binary":false,"changes":54,"status":"modified"},{"patch":"@@ -33,1 +33,0 @@\n-import java.util.concurrent.CompletableFuture;\n@@ -179,0 +178,8 @@\n+    \/**\n+     * {@return true if this subscriber has already completed, either normally\n+     * or abnormally}\n+     *\/\n+    public boolean completed() {\n+        return completed.get();\n+    }\n+\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/common\/HttpBodySubscriberWrapper.java","additions":8,"deletions":1,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -26,1 +26,1 @@\n- * @bug 8245462 8229822 8254786 8297075 8297149\n+ * @bug 8245462 8229822 8254786 8297075 8297149 8298340\n","filename":"test\/jdk\/java\/net\/httpclient\/CancelRequestTest.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}