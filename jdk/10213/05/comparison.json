{"files":[{"patch":"@@ -58,1 +58,1 @@\n-    static JmodOutputStream newOutputStream(Path file, LocalDateTime date) throws IOException {\n+    static JmodOutputStream newOutputStream(Path file, LocalDateTime date, int compressLevel) throws IOException {\n@@ -61,1 +61,1 @@\n-        return new JmodOutputStream(bos, date);\n+        return new JmodOutputStream(bos, date, compressLevel);\n@@ -66,1 +66,1 @@\n-    private JmodOutputStream(OutputStream out, LocalDateTime date) {\n+    private JmodOutputStream(OutputStream out, LocalDateTime date, int compressLevel) {\n@@ -68,0 +68,1 @@\n+        this.zos.setLevel(compressLevel);\n","filename":"src\/jdk.jlink\/share\/classes\/jdk\/tools\/jmod\/JmodOutputStream.java","additions":4,"deletions":3,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -63,0 +63,1 @@\n+import java.util.zip.Deflater;\n@@ -170,0 +171,1 @@\n+        int compressLevel;\n@@ -441,1 +443,1 @@\n-            try (JmodOutputStream jos = JmodOutputStream.newOutputStream(tempTarget, options.date)) {\n+            try (JmodOutputStream jos = JmodOutputStream.newOutputStream(tempTarget, options.date, options.compressLevel)) {\n@@ -1027,1 +1029,1 @@\n-                 JmodOutputStream jos = JmodOutputStream.newOutputStream(tempTarget, options.date))\n+                 JmodOutputStream jos = JmodOutputStream.newOutputStream(tempTarget, options.date, options.compressLevel))\n@@ -1182,0 +1184,27 @@\n+    static class CompLevelConverter implements ValueConverter<Integer> {\n+        @Override\n+        public Integer convert(String value) {\n+            int idx = value.indexOf(\"-\");\n+            int lastIdx = value.lastIndexOf(\"-\");\n+            if (idx == -1 || idx != lastIdx) {\n+                throw new CommandException(\"err.compress.incorrect\", value);\n+            }\n+            if (!value.substring(0, idx).equals(\"zip\")) {\n+                throw new CommandException(\"err.compress.incorrect\", value);\n+            }\n+            try {\n+                int level = Integer.parseInt(value.substring(idx + 1));\n+                if (level < 0 || level > 9) {\n+                    throw new CommandException(\"err.compress.incorrect\", value);\n+                }\n+                return level;\n+            } catch (NumberFormatException x) {\n+                throw new CommandException(\"err.compress.incorrect\", value);\n+            }\n+        }\n+\n+        @Override public Class<Integer> valueType() { return Integer.class; }\n+\n+        @Override public String valuePattern() { return \"compress\"; }\n+    }\n+\n@@ -1422,0 +1451,5 @@\n+        OptionSpec<Integer> compress\n+                = parser.accepts(\"compress\", getMessage(\"main.opt.compress\"))\n+                        .withRequiredArg()\n+                        .withValuesConvertedBy(new CompLevelConverter());\n+\n@@ -1491,0 +1525,11 @@\n+            if (opts.has(compress)) {\n+                if (!options.mode.equals(Mode.CREATE)) {\n+                    throw new CommandException(\"err.compress.wrong.mode\")\n+                            .showUsage(true);\n+                }\n+                options.compressLevel = getLastElement(opts.valuesOf(compress));\n+            } else {\n+                \/\/ Default to the default from zlib. Hard-coded here to avoid accidental\n+                \/\/ compression level change if zlib ever changes the default.\n+                options.compressLevel = 6;\n+            }\n","filename":"src\/jdk.jlink\/share\/classes\/jdk\/tools\/jmod\/JmodTask.java","additions":48,"deletions":3,"binary":false,"changes":51,"status":"modified"},{"patch":"@@ -85,0 +85,4 @@\n+main.opt.compress=Compression to use when creating the JMOD archive.\\\n+\\ Accepted values are: zip-[0-9], where zip-0 provides no compression, and zip-9\\\n+\\ provides the best compression. Default is \"zip-6\".\n+\n@@ -116,0 +120,2 @@\n+err.compress.incorrect=--compress value is invalid: {0}\n+err.compress.wrong.mode=--compress is only accepted with create mode\n","filename":"src\/jdk.jlink\/share\/classes\/jdk\/tools\/jmod\/resources\/jmod.properties","additions":6,"deletions":0,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -742,0 +742,95 @@\n+    @Test\n+    public void testCompressionLevel() throws IOException {\n+        String cp = EXPLODED_DIR.resolve(\"foo\").resolve(\"classes\").toString();\n+        Path jmod = MODS_DIR.resolve(\"foo.jmod\");\n+        FileUtils.deleteFileIfExistsWithRetry(jmod);\n+\n+        jmod(\"create\",\n+             \"--class-path\", cp,\n+             \"--compress\", \"zip-0\",\n+             jmod.toString())\n+            .assertSuccess();\n+\n+        jmod(\"list\",\n+             \"--compress\", \"zip-0\",\n+             jmod.toString())\n+            .assertFailure()\n+            .resultChecker(r -> {\n+                assertTrue(r.output.contains(\"--compress is only accepted with create mode\"), \"Error message printed\");\n+            });\n+\n+        FileUtils.deleteFileIfExistsWithRetry(jmod);\n+\n+        jmod(\"create\",\n+             \"--class-path\", cp,\n+             \"--compress\", \"zip-9\",\n+             jmod.toString())\n+            .assertSuccess();\n+\n+        FileUtils.deleteFileIfExistsWithRetry(jmod);\n+\n+        jmod(\"create\",\n+             \"--class-path\", cp,\n+             \"--compress\", \"zip--1\",\n+             jmod.toString())\n+            .assertFailure()\n+            .resultChecker(r -> {\n+                assertTrue(r.output.contains(\"--compress value is invalid\"), \"Error message printed\");\n+            });\n+\n+        FileUtils.deleteFileIfExistsWithRetry(jmod);\n+\n+        jmod(\"create\",\n+             \"--class-path\", cp,\n+             \"--compress\", \"zip-1-something\",\n+             jmod.toString())\n+            .assertFailure()\n+            .resultChecker(r -> {\n+                assertTrue(r.output.contains(\"--compress value is invalid\"), \"Error message printed\");\n+            });\n+\n+        FileUtils.deleteFileIfExistsWithRetry(jmod);\n+\n+        jmod(\"create\",\n+             \"--class-path\", cp,\n+             \"--compress\", \"zip-10\",\n+             jmod.toString())\n+            .assertFailure()\n+            .resultChecker(r -> {\n+                assertTrue(r.output.contains(\"--compress value is invalid\"), \"Error message printed\");\n+            });\n+\n+        FileUtils.deleteFileIfExistsWithRetry(jmod);\n+\n+        jmod(\"create\",\n+             \"--class-path\", cp,\n+             \"--compress\", \"zip-\",\n+             jmod.toString())\n+            .assertFailure()\n+            .resultChecker(r -> {\n+                assertTrue(r.output.contains(\"--compress value is invalid\"), \"Error message printed\");\n+            });\n+\n+        FileUtils.deleteFileIfExistsWithRetry(jmod);\n+\n+        jmod(\"create\",\n+             \"--class-path\", cp,\n+             \"--compress\", \"test\",\n+             jmod.toString())\n+            .assertFailure()\n+            .resultChecker(r -> {\n+                assertTrue(r.output.contains(\"--compress value is invalid\"), \"Error message printed\");\n+            });\n+\n+        FileUtils.deleteFileIfExistsWithRetry(jmod);\n+\n+        jmod(\"create\",\n+             \"--class-path\", cp,\n+             \"--compress\", \"test-0\",\n+             jmod.toString())\n+            .assertFailure()\n+            .resultChecker(r -> {\n+                assertTrue(r.output.contains(\"--compress value is invalid\"), \"Error message printed\");\n+            });\n+    }\n+\n","filename":"test\/jdk\/tools\/jmod\/JmodTest.java","additions":96,"deletions":1,"binary":false,"changes":97,"status":"modified"}]}