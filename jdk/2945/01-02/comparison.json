{"files":[{"patch":"@@ -140,0 +140,4 @@\n+  if (heap->is_concurrent_weak_root_in_progress()) {\n+    entry_rendezvous_roots();\n+  }\n+\n@@ -168,6 +172,0 @@\n-  } else {\n-    \/\/ Concurrent weak\/strong root flags are unset concurrently. We depend on updateref GC safepoints\n-    \/\/ to ensure the changes are visible to all mutators before gc cycle is completed.\n-    \/\/ In case of no evacuation, updateref GC safepoints are skipped. Therefore, we will need\n-    \/\/ to perform thread handshake to ensure their consistences.\n-    entry_rendezvous_roots();\n@@ -807,4 +805,0 @@\n-\n-  if (!ShenandoahHeap::heap()->unload_classes()) {\n-    heap->disable_concurrent_weak_root_in_progress_concurrently();\n-  }\n@@ -819,1 +813,0 @@\n-  heap->disable_concurrent_weak_root_in_progress_concurrently();\n@@ -911,1 +904,1 @@\n-  ShenandoahHeap::heap()->rendezvous_threads();\n+  ShenandoahHeap::heap()->disable_concurrent_weak_root_in_progress_concurrently();\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahConcurrentGC.cpp","additions":5,"deletions":12,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -1734,6 +1734,0 @@\n-  \/\/ Perform handshake to flush out dead oops\n-  {\n-    ShenandoahTimingsTracker t(ShenandoahPhaseTimings::conc_weak_roots_rendezvous);\n-    ShenandoahDisableWeakRootsClosure cl;\n-    Handshake::execute(&cl);\n-  }\n@@ -1741,0 +1735,9 @@\n+  \/\/ We need a rendezvous here to avoid the following race:\n+  \/\/ 1. Java thread reads referent, sees non-null but unreachable oop\n+  \/\/ 2. GC thread clears the referent\n+  \/\/ 3. GC thread turns off conc-ref-processing (we are here!)\n+  \/\/ 4. Java thread sees conc-ref-processing is off, publishes the dead oop\n+  rendezvous_threads();\n+\n+  \/\/ We need to turn off global flag before propagating the change to thread, otherwise new\n+  \/\/ threads might pick-up the old state but miss the update.\n@@ -1742,0 +1745,4 @@\n+\n+  \/\/ Propagate flag-change to threads.\n+  ShenandoahDisableWeakRootsClosure cl;\n+  Handshake::execute(&cl);\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahHeap.cpp","additions":13,"deletions":6,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -267,1 +267,1 @@\n-    \/\/ Weak-reference\/roots-processing in progress: need weak-LRB\n+    \/\/ Heap is under weak-reference\/roots processing: needs weak-LRB barriers.\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahHeap.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -607,1 +607,1 @@\n-    char actual = ShenandoahThreadLocalData::gc_state(t) & ~((char)ShenandoahHeap::WEAK_ROOTS);\n+    char actual = ShenandoahThreadLocalData::gc_state(t);\n@@ -642,0 +642,4 @@\n+        if (!_heap->is_stw_gc_in_progress()) {\n+          \/\/ Only concurrent GC sets this.\n+          expected |= ShenandoahHeap::WEAK_ROOTS;\n+        }\n@@ -647,0 +651,8 @@\n+      case _verify_gcstate_stable_weakroots:\n+        enabled = true;\n+        expected = ShenandoahHeap::STABLE;\n+        if (!_heap->is_stw_gc_in_progress()) {\n+          \/\/ Only concurrent GC sets this.\n+          expected |= ShenandoahHeap::WEAK_ROOTS;\n+        }\n+        break;\n@@ -653,1 +665,1 @@\n-      char actual = _heap->gc_state() & ~((char)ShenandoahHeap::WEAK_ROOTS);\n+      char actual = _heap->gc_state();\n@@ -802,1 +814,1 @@\n-          _verify_gcstate_stable       \/\/ mark should have stabilized the heap\n+          _verify_gcstate_stable_weakroots  \/\/ heap is still stable, weakroots are in progress\n@@ -814,1 +826,1 @@\n-          _verify_gcstate_stable                     \/\/ mark should have stabilized the heap\n+          _verify_gcstate_stable_weakroots           \/\/ heap is still stable, weakroots are in progress\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahVerifier.cpp","additions":16,"deletions":4,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -132,0 +132,3 @@\n+    \/\/ Nothing is in progress, no forwarded objects, weak roots handling\n+    _verify_gcstate_stable_weakroots,\n+\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahVerifier.hpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"}]}