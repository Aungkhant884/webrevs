{"files":[{"patch":"@@ -3532,4 +3532,1 @@\n-bool os::Linux::hugetlbfs_sanity_check(bool warn, size_t page_size) {\n-  bool result = false;\n-\n-  int flags = MAP_ANONYMOUS | MAP_PRIVATE | MAP_HUGETLB;\n+int os::Linux::hugetlbfs_page_size_flag(size_t page_size) {\n@@ -3537,1 +3534,1 @@\n-    flags |= (exact_log2(page_size) << MAP_HUGE_SHIFT);\n+    return (exact_log2(page_size) << MAP_HUGE_SHIFT);\n@@ -3539,0 +3536,2 @@\n+  return 0;\n+}\n@@ -3540,0 +3539,5 @@\n+bool os::Linux::hugetlbfs_sanity_check(bool warn, size_t page_size) {\n+  bool result = false;\n+\n+  \/\/ Include the page size flag to ensure we sanity check the correct page size.\n+  int flags = MAP_ANONYMOUS | MAP_PRIVATE | MAP_HUGETLB | hugetlbfs_page_size_flag(page_size);\n@@ -3987,0 +3991,2 @@\n+  \/\/ Ensure the correct page size flag is used when needed.\n+  flags |= hugetlbfs_page_size_flag(os::large_page_size());\n@@ -3988,3 +3994,0 @@\n-  if (os::large_page_size() != default_large_page_size()) {\n-    flags |= (exact_log2(os::large_page_size()) << MAP_HUGE_SHIFT);\n-  }\n@@ -4060,5 +4063,1 @@\n-  flags |= MAP_HUGETLB;\n-\n-  if (os::large_page_size() != default_large_page_size()) {\n-    flags |= (exact_log2(os::large_page_size()) << MAP_HUGE_SHIFT);\n-  }\n+  flags |= MAP_HUGETLB | hugetlbfs_page_size_flag(os::large_page_size());\n","filename":"src\/hotspot\/os\/linux\/os_linux.cpp","additions":12,"deletions":13,"binary":false,"changes":25,"status":"modified"},{"patch":"@@ -90,0 +90,2 @@\n+  static int hugetlbfs_page_size_flag(size_t page_size);\n+\n","filename":"src\/hotspot\/os\/linux\/os_linux.hpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"}]}