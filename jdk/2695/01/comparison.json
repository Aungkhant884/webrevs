{"files":[{"patch":"@@ -3532,0 +3532,7 @@\n+int os::Linux::hugetlbfs_page_size_flag(size_t page_size) {\n+  if (page_size != default_large_page_size()) {\n+    return (exact_log2(page_size) << MAP_HUGE_SHIFT);\n+  }\n+  return 0;\n+}\n+\n@@ -3534,3 +3541,4 @@\n-  void *p = mmap(NULL, page_size, PROT_READ|PROT_WRITE,\n-                 MAP_ANONYMOUS|MAP_PRIVATE|MAP_HUGETLB,\n-                 -1, 0);\n+\n+  \/\/ Include the page size flag to ensure we sanity check the correct page size.\n+  int flags = MAP_ANONYMOUS | MAP_PRIVATE | MAP_HUGETLB | hugetlbfs_page_size_flag(page_size);\n+  void *p = mmap(NULL, page_size, PROT_READ|PROT_WRITE, flags, -1, 0);\n@@ -3983,0 +3991,2 @@\n+  \/\/ Ensure the correct page size flag is used when needed.\n+  flags |= hugetlbfs_page_size_flag(os::large_page_size());\n@@ -3984,3 +3994,0 @@\n-  if (os::large_page_size() != default_large_page_size()) {\n-    flags |= (exact_log2(os::large_page_size()) << MAP_HUGE_SHIFT);\n-  }\n@@ -4056,5 +4063,1 @@\n-  flags |= MAP_HUGETLB;\n-\n-  if (os::large_page_size() != default_large_page_size()) {\n-    flags |= (exact_log2(os::large_page_size()) << MAP_HUGE_SHIFT);\n-  }\n+  flags |= MAP_HUGETLB | hugetlbfs_page_size_flag(os::large_page_size());\n","filename":"src\/hotspot\/os\/linux\/os_linux.cpp","additions":14,"deletions":11,"binary":false,"changes":25,"status":"modified"},{"patch":"@@ -90,0 +90,2 @@\n+  static int hugetlbfs_page_size_flag(size_t page_size);\n+\n","filename":"src\/hotspot\/os\/linux\/os_linux.hpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"}]}