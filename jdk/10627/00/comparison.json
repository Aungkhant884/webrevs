{"files":[{"patch":"@@ -1848,1 +1848,1 @@\n-\/\/ Merge CMoveD into new vector-nodes\n+\/\/ Merge qualified CMoveD into new vector-nodes\n@@ -1870,0 +1870,1 @@\n+\/\/ Also clear unqualified CMove pack from the packset.\n@@ -1873,1 +1874,16 @@\n-    _cmovev_kit.make_cmovevd_pack(_packset.at(i));\n+    Node_List* unused_cmove_pk = _cmovev_kit.make_cmovevd_pack(_packset.at(i));\n+\n+    \/\/ Clear the unused cmove pack and its related packs from superword candidate packset.\n+    if (unused_cmove_pk != NULL) {\n+      Node* cmove = unused_cmove_pk->at(0);\n+      Node* bol = cmove->as_CMove()->in(CMoveNode::Condition);\n+      if (my_pack(bol)) {\n+        remove_pack(my_pack(bol));\n+      }\n+      Node* cmp = bol->in(1);\n+      if (my_pack(cmp)) {\n+        remove_pack(my_pack(cmp));\n+      }\n+      remove_pack(unused_cmove_pk);\n+    }\n+\n@@ -1875,0 +1891,1 @@\n+\n@@ -1912,0 +1929,6 @@\n+\/\/ Determine if the current pack is an ideal cmove pack, and if its related packs,\n+\/\/ i.e. bool node pack and cmp node pack, can be successfully merged for vectorization.\n+\/\/ If yes, create a new cmove pack to substitute the old one, map all info to the\n+\/\/ new pack and delete the old cmove pack and related packs from the packset.\n+\/\/ If no, return immediately with the unqualified cmove pack, delete related packs from\n+\/\/ the packset and clear all info as well.\n@@ -1914,7 +1937,3 @@\n-  if (!cmovd->is_CMove()) {\n-    return NULL;\n-  }\n-  if (cmovd->Opcode() != Op_CMoveF && cmovd->Opcode() != Op_CMoveD) {\n-    return NULL;\n-  }\n-  if (pack(cmovd) != NULL) { \/\/ already in the cmov pack\n+\n+  if ((cmovd->Opcode() != Op_CMoveF && cmovd->Opcode() != Op_CMoveD) ||\n+      pack(cmovd) != NULL \/* already in the cmov pack *\/) {\n@@ -1923,0 +1942,1 @@\n+\n@@ -1925,1 +1945,1 @@\n-    return NULL;\n+    return cmovd_pk;\n@@ -1935,1 +1955,1 @@\n-      return NULL;\n+    return cmovd_pk;\n@@ -1939,1 +1959,1 @@\n-    return NULL;\n+    return cmovd_pk;\n@@ -1949,1 +1969,1 @@\n-      return NULL;\n+    return cmovd_pk;\n@@ -1953,1 +1973,1 @@\n-    return NULL;\n+    return cmovd_pk;\n@@ -1958,1 +1978,1 @@\n-    return NULL;\n+    return cmovd_pk;\n@@ -1973,1 +1993,0 @@\n-\n@@ -1981,1 +2000,1 @@\n-  return new_cmpd_pk;\n+  return NULL;\n@@ -3678,0 +3697,10 @@\n+\/\/------------------------------remove_pack------------------------------\n+\/\/ Remove the pack in the packset\n+void SuperWord::remove_pack(Node_List* p) {\n+  for (uint i = 0; i < p->size(); i++) {\n+    Node* s = p->at(i);\n+    set_my_pack(s, NULL);\n+  }\n+  _packset.remove(p);\n+}\n+\n","filename":"src\/hotspot\/share\/opto\/superword.cpp","additions":46,"deletions":17,"binary":false,"changes":63,"status":"modified"},{"patch":"@@ -587,0 +587,2 @@\n+  \/\/ Remove the pack in the packset\n+  void remove_pack(Node_List* p);\n","filename":"src\/hotspot\/share\/opto\/superword.hpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -26,1 +26,1 @@\n- * @bug 8268883\n+ * @bug 8268883 8293833\n@@ -28,0 +28,1 @@\n+ *          Error mixing types with -XX:+UseCMoveUnconditionally -XX:+UseVectorCmov\n@@ -30,0 +31,2 @@\n+ * @run main\/othervm -Xcomp -XX:-TieredCompilation -XX:CompileOnly=TestCondAddDeadBranch\n+ *                   -XX:+UseCMoveUnconditionally -XX:+UseVectorCmov -XX:MaxVectorSize=32  TestCondAddDeadBranch\n","filename":"test\/hotspot\/jtreg\/compiler\/c2\/TestCondAddDeadBranch.java","additions":4,"deletions":1,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -26,1 +26,1 @@\n- * @bug 8268017\n+ * @bug 8268017 8293833\n@@ -28,0 +28,1 @@\n+ *          Error mixing types with -XX:+UseCMoveUnconditionally -XX:+UseVectorCmov\n@@ -30,0 +31,2 @@\n+ * @run main\/othervm -Xcomp -XX:-TieredCompilation -XX:CompileOnly=TestCastFFAtPhi -XX:+UseCMoveUnconditionally\n+ *                   -XX:+UseVectorCmov -XX:MaxVectorSize=32 TestCastFFAtPhi\n","filename":"test\/hotspot\/jtreg\/compiler\/loopopts\/TestCastFFAtPhi.java","additions":4,"deletions":1,"binary":false,"changes":5,"status":"modified"}]}