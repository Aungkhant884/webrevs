{"files":[{"patch":"@@ -32,0 +32,1 @@\n+import java.nio.charset.StandardCharsets;\n@@ -84,1 +85,0 @@\n-    private static final int CASE_DIFF = ('a' - 'A');\n@@ -141,0 +141,18 @@\n+    private static void encodeByte(StringBuilder out, byte b) {\n+        out.append('%');\n+\n+        int n0 = (b >> 4) & 0xF;\n+        if (n0 < 10) {\n+            out.append((char) ('0' + n0));\n+        } else {\n+            out.append((char) ('A' - 10 + n0));\n+        }\n+\n+        int n1 = b & 0xF;\n+        if (n1 < 10) {\n+            out.append((char) ('0' + n1));\n+        } else {\n+            out.append((char) ('A' - 10 + n1));\n+        }\n+    }\n+\n@@ -225,2 +243,12 @@\n-        boolean needToChange = false;\n-        StringBuilder out = new StringBuilder(s.length());\n+        int i;\n+        for (i = 0; i < s.length(); i++) {\n+            char c = s.charAt(i);\n+            if (c >= 128 || !DONT_NEED_ENCODING.test(c) || c == ' ') {\n+                break;\n+            }\n+        }\n+        if (i == s.length()) {\n+            return s;\n+        }\n+\n+        StringBuilder out = new StringBuilder(s.length() << 1);\n@@ -228,0 +256,3 @@\n+        if (i > 0) {\n+            out.append(s, 0, i);\n+        }\n@@ -229,3 +260,2 @@\n-        for (int i = 0; i < s.length();) {\n-            int c = s.charAt(i);\n-            \/\/System.out.println(\"Examining character: \" + c);\n+        while (i < s.length()) {\n+            char c = s.charAt(i);\n@@ -235,1 +265,0 @@\n-                    needToChange = true;\n@@ -237,2 +266,1 @@\n-                \/\/System.out.println(\"Storing: \" + c);\n-                out.append((char)c);\n+                out.append(c);\n@@ -248,1 +276,1 @@\n-                     * surrogate pairs range occurs outside of a legal\n+                     * surrogate pairs range occurs outside a legal\n@@ -252,17 +280,4 @@\n-                    if (c >= 0xD800 && c <= 0xDBFF) {\n-                        \/*\n-                          System.out.println(Integer.toHexString(c)\n-                          + \" is high surrogate\");\n-                        *\/\n-                        if ( (i+1) < s.length()) {\n-                            int d = s.charAt(i+1);\n-                            \/*\n-                              System.out.println(\"\\tExamining \"\n-                              + Integer.toHexString(d));\n-                            *\/\n-                            if (d >= 0xDC00 && d <= 0xDFFF) {\n-                                \/*\n-                                  System.out.println(\"\\t\"\n-                                  + Integer.toHexString(d)\n-                                  + \" is low surrogate\");\n-                                *\/\n+                    if (Character.isHighSurrogate(c)) {\n+                        if ((i + 1) < s.length()) {\n+                            char d = s.charAt(i + 1);\n+                            if (Character.isLowSurrogate(d)) {\n@@ -277,1 +292,0 @@\n-                charArrayWriter.flush();\n@@ -281,13 +295,1 @@\n-                    out.append('%');\n-                    char ch = Character.forDigit((b >> 4) & 0xF, 16);\n-                    \/\/ converting to use uppercase letter as part of\n-                    \/\/ the hex value if ch is a letter.\n-                    if (Character.isLetter(ch)) {\n-                        ch -= CASE_DIFF;\n-                    }\n-                    out.append(ch);\n-                    ch = Character.forDigit(b & 0xF, 16);\n-                    if (Character.isLetter(ch)) {\n-                        ch -= CASE_DIFF;\n-                    }\n-                    out.append(ch);\n+                    encodeByte(out, b);\n@@ -296,1 +298,0 @@\n-                needToChange = true;\n@@ -300,1 +301,1 @@\n-        return (needToChange? out.toString() : s);\n+        return out.toString();\n","filename":"src\/java.base\/share\/classes\/java\/net\/URLEncoder.java","additions":44,"deletions":43,"binary":false,"changes":87,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2001, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2001, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -29,1 +29,1 @@\n- *\n+ * @run junit SurrogatePairs\n@@ -32,2 +32,9 @@\n-import java.io.*;\n-import java.net.*;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.MethodSource;\n+\n+import java.net.URLDecoder;\n+import java.net.URLEncoder;\n+import java.util.stream.Collectors;\n+\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+import static org.junit.jupiter.api.Assertions.*;\n@@ -43,29 +50,17 @@\n-    static String[] testStrings = {\"\\uD800\\uDC00\",\n-                                   \"\\uD800\\uDFFF\",\n-                                   \"\\uDBFF\\uDC00\",\n-                                   \"\\uDBFF\\uDFFF\",\n-                                   \"1\\uDBFF\\uDC00\",\n-                                   \"@\\uDBFF\\uDC00\",\n-                                   \"\\uDBFF\\uDC001\",\n-                                   \"\\uDBFF\\uDC00@\",\n-                                   \"\\u0101\\uDBFF\\uDC00\",\n-                                   \"\\uDBFF\\uDC00\\u0101\"\n-    };\n-\n-    static String[] correctEncodings = {\"%F0%90%80%80\",\n-                                        \"%F0%90%8F%BF\",\n-                                        \"%F4%8F%B0%80\",\n-                                        \"%F4%8F%BF%BF\",\n-                                        \"1%F4%8F%B0%80\",\n-                                        \"%40%F4%8F%B0%80\",\n-                                        \"%F4%8F%B0%801\",\n-                                        \"%F4%8F%B0%80%40\",\n-                                        \"%C4%81%F4%8F%B0%80\",\n-                                        \"%F4%8F%B0%80%C4%81\"\n-    };\n-\n-    public static void main(String[] args) throws Exception {\n-\n-        for (int i=0; i < testStrings.length; i++) {\n-            test(testStrings[i], correctEncodings[i]);\n-        }\n+    public static String[][] arguments() {\n+        return new String[][] {\n+                {\"\\uD800\\uDC00\", \"%F0%90%80%80\"},\n+                {\"\\uD800\\uDFFF\", \"%F0%90%8F%BF\"},\n+                {\"\\uDBFF\\uDC00\", \"%F4%8F%B0%80\"},\n+                {\"\\uDBFF\\uDFFF\", \"%F4%8F%BF%BF\"},\n+                {\"1\\uDBFF\\uDC00\", \"1%F4%8F%B0%80\"},\n+                {\"@\\uDBFF\\uDC00\", \"%40%F4%8F%B0%80\"},\n+                {\"\\uDBFF\\uDC001\", \"%F4%8F%B0%801\"},\n+                {\"\\uDBFF\\uDC00@\", \"%F4%8F%B0%80%40\"},\n+                {\"\\u0101\\uDBFF\\uDC00\", \"%C4%81%F4%8F%B0%80\"},\n+                {\"\\uDBFF\\uDC00\\u0101\", \"%F4%8F%B0%80%C4%81\"},\n+                {\"\\uDE0A\\uD83D\", \"%3F%3F\"},\n+                {\"1\\uDE0A\\uD83D\", \"1%3F%3F\"},\n+                {\"@\\uDE0A\\uD83D\", \"%40%3F%3F\"},\n+                {\"1@1\\uDE0A\\uD800\\uDC00 \\uD83D\", \"1%401%3F%F0%90%80%80+%3F\"}\n+        };\n@@ -74,28 +69,13 @@\n-    private static void test(String str, String correctEncoding)\n-        throws Exception {\n-\n-        System.out.println(\"Unicode bytes of test string are: \"\n-                           + getHexBytes(str));\n-\n-        String encoded = URLEncoder.encode(str, \"UTF-8\");\n-\n-        System.out.println(\"URLEncoding is: \" + encoded);\n-\n-        if (encoded.equals(correctEncoding))\n-            System.out.println(\"The encoding is correct!\");\n-        else {\n-            throw new Exception(\"The encoding is incorrect!\" +\n-                                \" It should be \" + correctEncoding);\n-        }\n-\n-        String decoded = URLDecoder.decode(encoded, \"UTF-8\");\n-\n-        System.out.println(\"Unicode bytes for URLDecoding are: \"\n-                           + getHexBytes(decoded));\n-\n-        if (str.equals(decoded))\n-            System.out.println(\"The decoding is correct\");\n-        else {\n-            throw new Exception(\"The decoded is not equal to the original\");\n-        }\n-        System.out.println(\"---\");\n+    @ParameterizedTest\n+    @MethodSource(\"arguments\")\n+    public void test(String str, String correctEncoding) {\n+        String encoded = URLEncoder.encode(str, UTF_8);\n+        assertEquals(correctEncoding, encoded, () ->\n+                \"str=%s, expected=%s, actual=%s\"\n+                        .formatted(escape(str), escape(correctEncoding), escape(encoded)));\n+\n+        \/\/ Map unmappable characters to '?'\n+        String cleanStr = new String(str.getBytes(UTF_8), UTF_8);\n+        String decoded = URLDecoder.decode(encoded, UTF_8);\n+        assertEquals(cleanStr, decoded, () ->\n+                \"expected=%s, actual=%s\".formatted(escape(str), escape(decoded)));\n@@ -104,19 +84,3 @@\n-    private static String getHexBytes(String s) throws Exception {\n-        StringBuffer sb = new StringBuffer();\n-        for (int i = 0; i < s.length(); i++) {\n-\n-            int a = s.charAt(i);\n-            int b1 = (a >>8) & 0xff;\n-            int b2 = (byte)a;\n-            int b11 = (b1>>4) & 0x0f;\n-            int b12 = b1 & 0x0f;\n-            int b21 = (b2 >>4) & 0x0f;\n-            int b22 = b2 & 0x0f;\n-\n-            sb.append(Integer.toHexString(b11));\n-            sb.append(Integer.toHexString(b12));\n-            sb.append(Integer.toHexString(b21));\n-            sb.append(Integer.toHexString(b22));\n-            sb.append(' ');\n-        }\n-        return sb.toString();\n+    private static String escape(String s) {\n+        return s.chars().mapToObj(c -> String.format(\"\\\\u%04x\", c))\n+                .collect(Collectors.joining());\n@@ -124,1 +88,0 @@\n-\n","filename":"test\/jdk\/java\/net\/URLEncoder\/SurrogatePairs.java","additions":44,"deletions":81,"binary":false,"changes":125,"status":"modified"}]}