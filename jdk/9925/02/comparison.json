{"files":[{"patch":"@@ -178,0 +178,10 @@\n+    \/\/ Check whether the destination is in append mode: copy_file_range fails\n+    \/\/ with EBADF in this case and sendfile fails with EINVAL.\n+    int dstFlags = fcntl(dstFD, F_GETFL);\n+    if (dstFlags < 0) {\n+        JNU_ThrowIOExceptionWithLastError(env, \"Destination flags\");\n+        return IOS_THROWN;\n+    }\n+    if ((dstFlags & O_APPEND) != 0)\n+        return IOS_UNSUPPORTED_CASE;\n+\n@@ -179,1 +189,22 @@\n-    jlong n = sendfile64(dstFD, srcFD, &offset, (size_t)count);\n+    jlong n;\n+    if (my_copy_file_range_func) {\n+        size_t len = (size_t)count;\n+        n = my_copy_file_range_func(srcFD, &offset, dstFD, NULL, len, 0);\n+        if (n < 0) {\n+            switch (errno) {\n+                case EINTR:\n+                    return IOS_INTERRUPTED;\n+                case EINVAL:\n+                case EXDEV:\n+                    \/\/ ignore and try sendfile()\n+                    break;\n+                default:\n+                    JNU_ThrowIOExceptionWithLastError(env, \"Copy failed\");\n+                    return IOS_THROWN;\n+            }\n+        }\n+        if (n >= 0)\n+            return n;\n+    }\n+\n+    n = sendfile64(dstFD, srcFD, &offset, (size_t)count);\n@@ -275,1 +306,2 @@\n-    jlong n = my_copy_file_range_func(srcFD, NULL, dstFD, &offset, count, 0);\n+    size_t len = (size_t)count;\n+    jlong n = my_copy_file_range_func(srcFD, NULL, dstFD, &offset, len, 0);\n","filename":"src\/java.base\/unix\/native\/libnio\/ch\/FileChannelImpl.c","additions":34,"deletions":2,"binary":false,"changes":36,"status":"modified"}]}