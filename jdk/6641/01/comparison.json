{"files":[{"patch":"@@ -97,1 +97,1 @@\n-        return new AArch64HotSpotRegisterConfig(target, config.useCompressedOops, canUsePlatformRegister);\n+        return new AArch64HotSpotRegisterConfig(target, config.useCompressedOops, canUsePlatformRegister, config.macOs);\n","filename":"src\/jdk.internal.vm.ci\/share\/classes\/jdk.vm.ci.hotspot.aarch64\/src\/jdk\/vm\/ci\/hotspot\/aarch64\/AArch64HotSpotJVMCIBackendFactory.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -119,0 +119,2 @@\n+    private final boolean macOS;\n+\n@@ -165,2 +167,2 @@\n-    public AArch64HotSpotRegisterConfig(TargetDescription target, boolean useCompressedOops, boolean canUsePlatformRegister) {\n-        this(target, initAllocatable(target.arch, useCompressedOops, canUsePlatformRegister));\n+    public AArch64HotSpotRegisterConfig(TargetDescription target, boolean useCompressedOops, boolean canUsePlatformRegister, boolean macOs) {\n+        this(target, initAllocatable(target.arch, useCompressedOops, canUsePlatformRegister), macOs);\n@@ -170,1 +172,1 @@\n-    public AArch64HotSpotRegisterConfig(TargetDescription target, RegisterArray allocatable) {\n+    public AArch64HotSpotRegisterConfig(TargetDescription target, RegisterArray allocatable, boolean macOs) {\n@@ -172,0 +174,1 @@\n+        this.macOS = macOs;\n@@ -268,0 +271,6 @@\n+                int kindSize = valueKind.getPlatformKind().getSizeInBytes();\n+                if (macOS && currentStackOffset % kindSize != 0) {\n+                    \/\/ In MacOS natural alignment is used\n+                    \/\/ See https:\/\/developer.apple.com\/documentation\/xcode\/writing-arm64-code-for-apple-platforms\n+                    currentStackOffset += kindSize - currentStackOffset % kindSize;\n+                }\n@@ -269,1 +278,7 @@\n-                currentStackOffset += Math.max(valueKind.getPlatformKind().getSizeInBytes(), target.wordSize);\n+                if (macOS) {\n+                    \/\/ In MacOS \"Function arguments may consume slots on the stack that are not multiples of 8 bytes\"\n+                    \/\/ See https:\/\/developer.apple.com\/documentation\/xcode\/writing-arm64-code-for-apple-platforms\n+                    currentStackOffset += kindSize;\n+                } else {\n+                    currentStackOffset += Math.max(kindSize, target.wordSize);\n+                }\n@@ -272,1 +287,3 @@\n-\n+        if (currentStackOffset % target.stackAlignment != 0) {\n+            currentStackOffset += target.stackAlignment - currentStackOffset % target.stackAlignment;\n+        }\n","filename":"src\/jdk.internal.vm.ci\/share\/classes\/jdk.vm.ci.hotspot.aarch64\/src\/jdk\/vm\/ci\/hotspot\/aarch64\/AArch64HotSpotRegisterConfig.java","additions":22,"deletions":5,"binary":false,"changes":27,"status":"modified"},{"patch":"@@ -41,0 +41,1 @@\n+    final boolean macOs = Services.getSavedProperty(\"os.name\", \"\").startsWith(\"Mac\");\n","filename":"src\/jdk.internal.vm.ci\/share\/classes\/jdk.vm.ci.hotspot.aarch64\/src\/jdk\/vm\/ci\/hotspot\/aarch64\/AArch64HotSpotVMConfig.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -49,1 +49,0 @@\n-compiler\/jvmci\/jdk.vm.ci.code.test\/src\/jdk\/vm\/ci\/code\/test\/NativeCallTest.java 8262901 macosx-aarch64\n","filename":"test\/hotspot\/jtreg\/ProblemList.txt","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -192,0 +192,33 @@\n+jint JNICALL I32I(jint i00, jint i01, jint i02, jint i03, jint i04, jint i05, jint i06, jint i07,\n+                  jint i08, jint i09, jint i0a, jint i0b, jint i0c, jint i0d, jint i0e, jint i0f,\n+                  jint i10, jint i11, jint i12, jint i13, jint i14, jint i15, jint i16, jint i17,\n+                  jint i18, jint i19, jint i1a, jint i1b, jint i1c, jint i1d, jint i1e, jint i1f,\n+                  jint a) {\n+  return i00 + i01 + i02 + i03 + i04 + i05 + i06 + i07 +\n+         i08 + i09 + i0a + i0b + i0c + i0d + i0e + i0f +\n+         i10 + i11 + i12 + i13 + i14 + i15 + i16 + i17 +\n+         i18 + i19 + i1a + i1b + i1c + i1d + i1e + i1f +\n+         a;\n+}\n+\n+JNIEXPORT jlong JNICALL Java_jdk_vm_ci_code_test_NativeCallTest_getI32I(JNIEnv *env, jclass clazz) {\n+  return (jlong) (intptr_t) I32I;\n+}\n+\n+JNIEXPORT jint JNICALL Java_jdk_vm_ci_code_test_NativeCallTest__1I32I(JNIEnv *env, jclass clazz,\n+                                                                      jint i00, jint i01, jint i02, jint i03,\n+                                                                      jint i04, jint i05, jint i06, jint i07,\n+                                                                      jint i08, jint i09, jint i0a, jint i0b,\n+                                                                      jint i0c, jint i0d, jint i0e, jint i0f,\n+                                                                      jint i10, jint i11, jint i12, jint i13,\n+                                                                      jint i14, jint i15, jint i16, jint i17,\n+                                                                      jint i18, jint i19, jint i1a, jint i1b,\n+                                                                      jint i1c, jint i1d, jint i1e, jint i1f,\n+                                                                      jint a) {\n+  return I32I(i00, i01, i02, i03, i04, i05, i06, i07,\n+              i08, i09, i0a, i0b, i0c, i0d, i0e, i0f,\n+              i10, i11, i12, i13, i14, i15, i16, i17,\n+              i18, i19, i1a, i1b, i1c, i1d, i1e, i1f,\n+              a);\n+}\n+\n","filename":"test\/hotspot\/jtreg\/compiler\/jvmci\/jdk.vm.ci.code.test\/libNativeCallTest.c","additions":33,"deletions":0,"binary":false,"changes":33,"status":"modified"},{"patch":"@@ -128,0 +128,20 @@\n+    @Test\n+    public void testI32I() {\n+        int sCount = 32;\n+        \/\/ Pairs of <Object>, <Class>\n+        Object[] remainingArgs = new Object[]{\n+                        12, int.class\n+        };\n+        Class<?>[] argClazz = new Class[sCount + remainingArgs.length \/ 2];\n+        Object[] argValues = new Object[sCount + remainingArgs.length \/ 2];\n+        for (int i = 0; i < sCount; i++) {\n+            argValues[i] = i;\n+            argClazz[i] = int.class;\n+        }\n+        for (int i = 0; i < remainingArgs.length; i += 2) {\n+            argValues[sCount + i \/ 2] = remainingArgs[i + 0];\n+            argClazz[sCount + i \/ 2] = (Class<?>) remainingArgs[i + 1];\n+        }\n+        test(\"I32I\", getI32I(), int.class, argClazz, argValues);\n+    }\n+\n@@ -247,0 +267,20 @@\n+\n+    public static native long getI32I();\n+\n+    public static native int _I32I(int i00, int i01, int i02, int i03, int i04, int i05, int i06, int i07,\n+                    int i08, int i09, int i0a, int i0b, int i0c, int i0d, int i0e, int i0f,\n+                    int i10, int i11, int i12, int i13, int i14, int i15, int i16, int i17,\n+                    int i18, int i19, int i1a, int i1b, int i1c, int i1d, int i1e, int i1f,\n+                    int a);\n+\n+    public static int I32I(int i00, int i01, int i02, int i03, int i04, int i05, int i06, int i07,\n+                    int i08, int i09, int i0a, int i0b, int i0c, int i0d, int i0e, int i0f,\n+                    int i10, int i11, int i12, int i13, int i14, int i15, int i16, int i17,\n+                    int i18, int i19, int i1a, int i1b, int i1c, int i1d, int i1e, int i1f,\n+                    int a) {\n+        return _I32I(i00, i01, i02, i03, i04, i05, i06, i07,\n+                    i08, i09, i0a, i0b, i0c, i0d, i0e, i0f,\n+                    i10, i11, i12, i13, i14, i15, i16, i17,\n+                    i18, i19, i1a, i1b, i1c, i1d, i1e, i1f,\n+                    a);\n+    }\n","filename":"test\/hotspot\/jtreg\/compiler\/jvmci\/jdk.vm.ci.code.test\/src\/jdk\/vm\/ci\/code\/test\/NativeCallTest.java","additions":40,"deletions":0,"binary":false,"changes":40,"status":"modified"}]}