{"files":[{"patch":"@@ -317,2 +317,3 @@\n-            int w = (int) Math.ceil(destWidth);\n-            int h = (int) Math.ceil(destHeight);\n+            int w = (int) Math.floor(destWidth + 0.5);\n+            int h = (int) Math.floor(destHeight + 0.5);\n+\n","filename":"src\/java.desktop\/share\/classes\/sun\/swing\/CachedPainter.java","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -43,2 +43,14 @@\n-import java.awt.*;\n-import java.awt.image.*;\n+import java.awt.Color;\n+import java.awt.Component;\n+import java.awt.Dimension;\n+import java.awt.Graphics;\n+import java.awt.Graphics2D;\n+import java.awt.GraphicsConfiguration;\n+import java.awt.Image;\n+import java.awt.Insets;\n+import java.awt.Point;\n+import java.awt.Rectangle;\n+import java.awt.Toolkit;\n+import java.awt.image.BufferedImage;\n+import java.awt.image.DataBufferInt;\n+import java.awt.image.WritableRaster;\n@@ -46,1 +58,0 @@\n-import java.util.*;\n@@ -48,3 +59,18 @@\n-import javax.swing.*;\n-import javax.swing.border.*;\n-import javax.swing.plaf.*;\n+import java.util.HashMap;\n+import javax.swing.AbstractButton;\n+import javax.swing.CellRendererPane;\n+import javax.swing.JButton;\n+import javax.swing.JCheckBox;\n+import javax.swing.JComboBox;\n+import javax.swing.JComponent;\n+import javax.swing.JRadioButton;\n+import javax.swing.JToolBar;\n+import javax.swing.SwingUtilities;\n+import javax.swing.UIManager;\n+import javax.swing.border.AbstractBorder;\n+import javax.swing.border.Border;\n+import javax.swing.border.EmptyBorder;\n+import javax.swing.border.LineBorder;\n+import javax.swing.plaf.ColorUIResource;\n+import javax.swing.plaf.InsetsUIResource;\n+import javax.swing.plaf.UIResource;\n@@ -58,1 +84,1 @@\n-import static com.sun.java.swing.plaf.windows.TMSchema.*;\n+import java.awt.geom.AffineTransform;\n@@ -60,0 +86,4 @@\n+import static com.sun.java.swing.plaf.windows.TMSchema.Part;\n+import static com.sun.java.swing.plaf.windows.TMSchema.Prop;\n+import static com.sun.java.swing.plaf.windows.TMSchema.State;\n+import static com.sun.java.swing.plaf.windows.TMSchema.TypeEnum;\n@@ -678,0 +708,5 @@\n+            \/\/ Get DPI to pass further to ThemeReader.paintBackground()\n+            Graphics2D g2d = (Graphics2D) g;\n+            AffineTransform  at = g2d.getTransform();\n+            int dpi = (int)(at.getScaleX() * 96);\n+\n@@ -685,1 +720,2 @@\n-                                        0, 0, w, h, w);\n+                                        0, 0, w, h, w, dpi);\n+\n","filename":"src\/java.desktop\/windows\/classes\/com\/sun\/java\/swing\/plaf\/windows\/XPStyle.java","additions":44,"deletions":8,"binary":false,"changes":52,"status":"modified"},{"patch":"@@ -46,2 +46,3 @@\n-\n-    private static final Map<String, Long> widgetToTheme = new HashMap<>();\n+    private static final int defaultDPI = 96;\n+    private static final Map<Integer, Map<String, Long>> dpiAwareWidgetToTheme\n+            = new HashMap<Integer, Map<String, Long>>();\n@@ -84,2 +85,9 @@\n-    private static Long getThemeImpl(String widget) {\n-        Long theme = widgetToTheme.get(widget);\n+    private static Long getThemeImpl(String widget, int dpi) {\n+        Long theme = null;\n+\n+        Map<String, Long> dpiWidgetToTheme = dpiAwareWidgetToTheme.get(dpi);\n+\n+        if (dpiWidgetToTheme != null) {\n+            theme = dpiWidgetToTheme.get(widget);\n+        }\n+\n@@ -92,1 +100,1 @@\n-                theme = openTheme(widget.substring(i+2));\n+                theme = openTheme(widget.substring(i + 2), dpi);\n@@ -95,1 +103,1 @@\n-                theme = openTheme(widget);\n+                theme = openTheme(widget, dpi);\n@@ -97,1 +105,3 @@\n-            widgetToTheme.put(widget, theme);\n+\n+            dpiAwareWidgetToTheme.computeIfAbsent(dpi, key->new HashMap<>()).put(widget, theme);\n+\n@@ -104,1 +114,1 @@\n-    private static Long getTheme(String widget) {\n+    private static Long getTheme(String widget, int dpi) {\n@@ -114,2 +124,9 @@\n-                    for (Long value : widgetToTheme.values()) {\n-                        closeTheme(value);\n+                    if (!dpiAwareWidgetToTheme.isEmpty()) {\n+                        for (Map <String, Long> dpiVal: dpiAwareWidgetToTheme.values()) {\n+                            for (Long value : dpiVal.values()) {\n+                                closeTheme(value);\n+                            }\n+                        }\n+                        dpiAwareWidgetToTheme.get(dpi).clear();\n+                        dpiAwareWidgetToTheme.clear();\n+                        valid = true;\n@@ -117,2 +134,0 @@\n-                    widgetToTheme.clear();\n-                    valid = true;\n@@ -127,1 +142,6 @@\n-        Long theme = widgetToTheme.get(widget);\n+        Long theme = null;\n+\n+        if (dpiAwareWidgetToTheme.get(dpi) != null)\n+        {\n+            theme = dpiAwareWidgetToTheme.get(dpi).get(widget);\n+        }\n@@ -132,1 +152,1 @@\n-                theme = getThemeImpl(widget);\n+                theme = getThemeImpl(widget, dpi);\n@@ -142,2 +162,2 @@\n-                                               int part, int state, int x,\n-                                               int y, int w, int h, int stride);\n+                                               int part, int state, int rectRight,\n+                                               int rectBottom, int w, int h, int stride);\n@@ -146,1 +166,1 @@\n-           int part, int state, int x, int y, int w, int h, int stride) {\n+           int part, int state, int x, int y, int w, int h, int stride, int dpi) {\n@@ -149,1 +169,6 @@\n-            paintBackground(buffer, getTheme(widget), part, state, x, y, w, h, stride);\n+\n+            \/* We get the part size based on the theme for current screen DPI\n+            and pass it to paintBackground *\/\n+            Dimension d = getPartSize(getTheme(widget, dpi), part, state);\n+            paintBackground(buffer, getTheme(widget, dpi), part, state,\n+                            d.width, d.height , w, h, stride);\n@@ -161,1 +186,1 @@\n-            return getThemeMargins(getTheme(widget), part, state, marginType);\n+            return getThemeMargins(getTheme(widget, defaultDPI), part, state, marginType);\n@@ -172,1 +197,1 @@\n-            return isThemePartDefined(getTheme(widget), part, state);\n+            return isThemePartDefined(getTheme(widget, defaultDPI), part, state);\n@@ -184,1 +209,1 @@\n-            return getColor(getTheme(widget), part, state, property);\n+            return getColor(getTheme(widget, defaultDPI), part, state, property);\n@@ -196,1 +221,1 @@\n-            return getInt(getTheme(widget), part, state, property);\n+            return getInt(getTheme(widget, defaultDPI), part, state, property);\n@@ -208,1 +233,1 @@\n-            return getEnum(getTheme(widget), part, state, property);\n+            return getEnum(getTheme(widget, defaultDPI), part, state, property);\n@@ -221,1 +246,1 @@\n-            return getBoolean(getTheme(widget), part, state, property);\n+            return getBoolean(getTheme(widget, defaultDPI), part, state, property);\n@@ -232,1 +257,1 @@\n-            return getSysBoolean(getTheme(widget), property);\n+            return getSysBoolean(getTheme(widget, defaultDPI), property);\n@@ -244,1 +269,1 @@\n-            return getPoint(getTheme(widget), part, state, property);\n+            return getPoint(getTheme(widget, defaultDPI), part, state, property);\n@@ -257,1 +282,1 @@\n-            return getPosition(getTheme(widget), part,state,property);\n+            return getPosition(getTheme(widget, defaultDPI), part,state,property);\n@@ -269,1 +294,1 @@\n-            return getPartSize(getTheme(widget), part, state);\n+            return getPartSize(getTheme(widget, defaultDPI), part, state);\n@@ -275,1 +300,1 @@\n-    private static native long openTheme(String widget);\n+    private static native long openTheme(String widget, int dpi);\n@@ -288,2 +313,3 @@\n-            return getThemeTransitionDuration(getTheme(widget),\n-                                              part, stateFrom, stateTo, propId);\n+            return getThemeTransitionDuration(getTheme(widget, defaultDPI),\n+                                              part, stateFrom, stateTo,\n+                                              propId);\n@@ -302,2 +328,3 @@\n-            return getThemeBackgroundContentMargins(getTheme(widget),\n-                                    part, state, boundingWidth, boundingHeight);\n+            return getThemeBackgroundContentMargins(getTheme(widget, defaultDPI),\n+                                                    part, state, boundingWidth,\n+                                                    boundingHeight);\n","filename":"src\/java.desktop\/windows\/classes\/sun\/awt\/windows\/ThemeReader.java","additions":60,"deletions":33,"binary":false,"changes":93,"status":"modified"},{"patch":"@@ -43,1 +43,0 @@\n-\n@@ -49,1 +48,1 @@\n-typedef HTHEME(__stdcall *PFNOPENTHEMEDATA)(HWND hwnd, LPCWSTR pszClassList);\n+typedef HTHEME(__stdcall *PFNOPENTHEMEDATAFORDPI)(HWND hwnd, LPCWSTR pszClassList, UINT dpi);\n@@ -93,1 +92,1 @@\n-static PFNOPENTHEMEDATA OpenThemeDataFunc = NULL;\n+static PFNOPENTHEMEDATAFORDPI OpenThemeDataFuncForDpi = NULL;\n@@ -119,2 +118,2 @@\n-        OpenThemeDataFunc = (PFNOPENTHEMEDATA)GetProcAddress(hModThemes,\n-                                                        \"OpenThemeData\");\n+        OpenThemeDataFuncForDpi = (PFNOPENTHEMEDATAFORDPI)GetProcAddress(\n+                                   hModThemes, \"OpenThemeDataForDpi\");\n@@ -155,1 +154,1 @@\n-        if(OpenThemeDataFunc\n+        if(OpenThemeDataFuncForDpi\n@@ -174,3 +173,6 @@\n-              \/\/ We need to make sure we can load the Theme. This may not be\n-              \/\/ the case on a WinXP machine with classic mode enabled.\n-              HTHEME hTheme = OpenThemeDataFunc(AwtToolkit::GetInstance().GetHWnd(), L\"Button\");\n+              \/\/ We need to make sure we can load the Theme.\n+              \/\/ Use the default DPI value of 96 on windows.\n+              unsigned int dpi =96;\n+              HTHEME hTheme = OpenThemeDataFuncForDpi (\n+                              AwtToolkit::GetInstance().GetHWnd(),\n+                              L\"Button\", dpi);\n@@ -239,1 +241,1 @@\n-(JNIEnv *env, jclass klass, jstring widget) {\n+(JNIEnv *env, jclass klass, jstring widget, jint dpi) {\n@@ -241,1 +243,1 @@\n-    LPCTSTR str = (LPCTSTR) JNU_GetStringPlatformChars(env, widget, NULL);\n+    LPCTSTR str = (LPCTSTR)JNU_GetStringPlatformChars(env, widget, NULL);\n@@ -248,1 +250,3 @@\n-    HTHEME htheme = OpenThemeDataFunc(AwtToolkit::GetInstance().GetHWnd(), str);\n+    HTHEME htheme = OpenThemeDataFuncForDpi(\n+                    AwtToolkit::GetInstance().GetHWnd(),\n+                    str, dpi);\n@@ -250,1 +254,1 @@\n-    return (jlong) htheme;\n+    return (jlong)htheme;\n@@ -381,1 +385,1 @@\n-    jint x, jint y, jint w, jint h, jint stride) {\n+    jint rectRight, jint rectBottom, jint w, jint h, jint stride) {\n@@ -427,2 +431,3 @@\n-    rect.bottom = h;\n-    rect.right = w;\n+    rect.bottom = rectBottom ;\n+    rect.right  = rectRight;\n+\n@@ -717,21 +722,0 @@\n-void rescale(SIZE *size) {\n-    static int dpiX = -1;\n-    static int dpiY = -1;\n-    if (dpiX == -1 || dpiY == -1) {\n-        HWND hWnd = ::GetDesktopWindow();\n-        HDC hDC = ::GetDC(hWnd);\n-        dpiX = ::GetDeviceCaps(hDC, LOGPIXELSX);\n-        dpiY = ::GetDeviceCaps(hDC, LOGPIXELSY);\n-        ::ReleaseDC(hWnd, hDC);\n-    }\n-\n-    if (dpiX !=0 && dpiX != 96) {\n-        float invScaleX = 96.0f \/ dpiX;\n-        size->cx = (int) round(size->cx * invScaleX);\n-    }\n-    if (dpiY != 0 && dpiY != 96) {\n-        float invScaleY = 96.0f \/ dpiY;\n-        size->cy = (int) round(size->cy * invScaleY);\n-    }\n-}\n-\n@@ -764,1 +748,0 @@\n-            rescale(&size);\n","filename":"src\/java.desktop\/windows\/native\/libawt\/windows\/ThemeReader.cpp","additions":21,"deletions":38,"binary":false,"changes":59,"status":"modified"}]}