{"files":[{"patch":"@@ -1692,0 +1692,3 @@\n+  const bool clear_all_soft_refs =\n+      heap->soft_ref_policy()->should_clear_all_soft_refs();\n+\n@@ -1693,1 +1696,1 @@\n-    PSScavenge::invoke_no_policy();\n+    PSScavenge::invoke_no_policy(clear_all_soft_refs || maximum_heap_compaction);\n@@ -1696,3 +1699,0 @@\n-  const bool clear_all_soft_refs =\n-    heap->soft_ref_policy()->should_clear_all_soft_refs();\n-\n","filename":"src\/hotspot\/share\/gc\/parallel\/psParallelCompact.cpp","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -241,1 +241,1 @@\n-  const bool scavenge_done = PSScavenge::invoke_no_policy();\n+  const bool scavenge_done = PSScavenge::invoke_no_policy(false);\n@@ -357,1 +357,1 @@\n-bool PSScavenge::invoke_no_policy() {\n+bool PSScavenge::invoke_no_policy(bool clear_all_soft_refs) {\n@@ -438,1 +438,1 @@\n-    reference_processor()->start_discovery(false \/* always_clear *\/);\n+    reference_processor()->start_discovery(clear_all_soft_refs);\n","filename":"src\/hotspot\/share\/gc\/parallel\/psScavenge.cpp","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -112,1 +112,1 @@\n-  static bool invoke_no_policy();\n+  static bool invoke_no_policy(bool clear_all_soft_refs);\n","filename":"src\/hotspot\/share\/gc\/parallel\/psScavenge.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -158,1 +158,0 @@\n-vmTestbase\/gc\/gctests\/WeakReference\/weak006\/weak006.java 8286737 generic-all\n","filename":"test\/hotspot\/jtreg\/ProblemList.txt","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -57,0 +57,14 @@\n+\n+class MySoftReference<T> extends SoftReference<T> {\n+    public MySoftReference(T obj) {\n+        super(obj);\n+    }\n+}\n+\n+\n+class MyWeakReference<T> extends WeakReference<T> {\n+    public MyWeakReference(T obj) {\n+        super(obj);\n+    }\n+}\n+\n@@ -66,1 +80,1 @@\n-        private Object makeReference(int n, Object o) {\n+        private Reference<Object> makeReference(int n, Object o) {\n@@ -69,1 +83,1 @@\n-                    return new WeakReference(o);\n+                    return new MyWeakReference(o);\n@@ -71,26 +85,1 @@\n-                    return new SoftReference(o);\n-                case 2:\n-                    return new PhantomReference(o, null);\n-                case 4: {\n-                    \/\/ Array of strong references\n-                    int len = Memory.getArrayLength(objectSize, Memory.getReferenceSize());\n-                    Object[] arr = new Object[len];\n-                    for (int i = 0; i < len; ++i) {\n-                        arr[i] = o;\n-                    }\n-                    return arr;\n-                }\n-                case 5: {\n-                    \/\/ reference to array of strong references and strong reference to reference\n-                    int len = Memory.getArrayLength(objectSize, Memory.getReferenceSize());\n-                    Object[] arr = new Object[len];\n-                    for (int i = 1; i < len; ++i) {\n-                        arr[i] = o;\n-                    }\n-                    Reference ref = (Reference) makeReference(LocalRandom.nextInt(3), arr);\n-                    if (len > 0) {\n-                        arr[0] = ref;\n-                    }\n-                    return ref;\n-                }\n-                case 3:\n+                    return new MySoftReference(o);\n@@ -98,2 +87,1 @@\n-                    \/\/ Strong reference\n-                    return o;\n+                    throw new RuntimeException(\"Incorrect reference type\");\n@@ -111,1 +99,1 @@\n-            references[0] = new WeakReference(obj);\n+            references[0] = new MyWeakReference(obj);\n@@ -116,1 +104,1 @@\n-                    lastReference = (Reference) makeReference(n, references[i - 1]);\n+                    lastReference = makeReference(n, references[i - 1]);\n","filename":"test\/hotspot\/jtreg\/vmTestbase\/gc\/gctests\/WeakReference\/weak006\/weak006.java","additions":20,"deletions":32,"binary":false,"changes":52,"status":"modified"}]}