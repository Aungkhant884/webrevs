[{"commit":{"message":"8286823: Default to UseAVX=2 on all Skylake\/Cascade Lake CPUs\n\nThe current code already does this for 'older' Skylake processors,\nnamely those with _stepping < 5. My testing indicates this is a\nproblem for later processors in this family too, so I have removed the\nmax stepping condition.\n\nThe original exclusion was added in https:\/\/bugs.openjdk.java.net\/browse\/JDK-8221092.\n\nA general description of the overall issue is given at\nhttps:\/\/en.wikipedia.org\/wiki\/Advanced_Vector_Extensions#Downclocking.\n\nAccording to https:\/\/en.wikichip.org\/wiki\/intel\/microarchitectures\/cascade_lake#CPUID,\nstepping values 5..7 indicate Cascade Lake. I have tested on a CPU with stepping=7,\nand I see CPU frequency reduction from 3.1GHz down to 2.7GHz (~23%) when using\n-XX:UseAVX=3, along with a corresponding performance reduction.\n\nI first saw this issue in a real production workload, where the main AVX3 instructions\nbeing executed were those generated for various flavours of disjoint_arraycopy.\n\nI can reproduce a similar effect using SPECjvm2008's xml.transform benchmark.\n\n```\njava --add-opens=java.xml\/com.sun.org.apache.xerces.internal.parsers=ALL-UNNAMED \\\n--add-opens=java.xml\/com.sun.org.apache.xerces.internal.util=ALL-UNNAMED \\\n-jar SPECjvm2008.jar -ikv -ict xml.transform\n```\n\nBefore the change, or with -XX:UseAVX=3:\n\n```\nValid run!\nScore on xml.transform: 776.00 ops\/m\n```\n\nAfter the change, or with -XX:UseAVX=2:\n\n```\nValid run!\nScore on xml.transform: 894.07 ops\/m\n```\n\nSo, a 15% improvement in this benchmark. It's possible some benchmarks will be negatively\naffected by this change, but I contend that this is still the right move given the stark\ndifference in this benchmark combined with the fact that use of AVX3 instructions can\naffect *all* processes\/code on the host due to the downclocking, and the fact that this\neffect is very hard to root-cause, for example CPU profiles look very similar before and\nafter since all code is equally slowed."},"files":[{"filename":"src\/hotspot\/cpu\/x86\/vm_version_x86.cpp"}],"sha":"d77e5680af382f8215b5b1f9cd4754056bccc9e5"}]