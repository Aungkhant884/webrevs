{"files":[{"patch":"@@ -125,2 +125,2 @@\n- * Throw an exception by name, using a given message and the string\n- * returned by getLastErrorString to construct the detail string.\n+ * Throw an exception by name, using a given message and a string\n+ * identical to one generated by perror() to construct the detail string.\n@@ -129,1 +129,1 @@\n-JNU_ThrowByNameWithMessageAndLastError\n+JNU_PerrorThrowByNameWithMessage\n@@ -132,2 +132,1 @@\n-    char buf[256];\n-    size_t n = getLastErrorString(buf, sizeof(buf), SYSTEM);\n+    char* buf = NULL;\n@@ -136,1 +135,4 @@\n-    if (n > 0) {\n+    int error = errno;\n+    if (error != 0) buf = strerror(error);\n+\n+    if (buf != NULL) {\n","filename":"src\/java.base\/share\/native\/libjava\/jni_util.c","additions":8,"deletions":6,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -81,2 +81,2 @@\n-\/* Throw an exception by name, using a given message and the string\n- * returned by getLastErrorString to construct the detail string.\n+\/* Throw an exception by name, using a given message and a string\n+ * identical to one generated by perror() to construct the detail string.\n@@ -85,1 +85,1 @@\n-JNU_ThrowByNameWithMessageAndLastError\n+JNU_PerrorThrowByNameWithMessage\n@@ -341,0 +341,2 @@\n+JNIEXPORT void JNICALL\n+throwByNameWithMessageAndWinError(JNIEnv *env, const char *name, const char *message);\n","filename":"src\/java.base\/share\/native\/libjava\/jni_util.h","additions":5,"deletions":3,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -688,1 +688,1 @@\n-        JNU_ThrowByNameWithMessageAndLastError\n+        JNU_PerrorThrowByNameWithMessage\n@@ -1135,1 +1135,1 @@\n-            JNU_ThrowByNameWithMessageAndLastError\n+            JNU_PerrorThrowByNameWithMessage\n@@ -1157,1 +1157,1 @@\n-                JNU_ThrowByNameWithMessageAndLastError\n+                JNU_PerrorThrowByNameWithMessage\n@@ -1162,1 +1162,1 @@\n-            JNU_ThrowByNameWithMessageAndLastError\n+            JNU_PerrorThrowByNameWithMessage\n@@ -1186,1 +1186,1 @@\n-        JNU_ThrowByNameWithMessageAndLastError\n+        JNU_PerrorThrowByNameWithMessage\n@@ -1195,1 +1195,1 @@\n-        JNU_ThrowByNameWithMessageAndLastError\n+        JNU_PerrorThrowByNameWithMessage\n@@ -1331,1 +1331,1 @@\n-        JNU_ThrowByNameWithMessageAndLastError\n+        JNU_PerrorThrowByNameWithMessage\n@@ -1355,1 +1355,1 @@\n-        JNU_ThrowByNameWithMessageAndLastError\n+        JNU_PerrorThrowByNameWithMessage\n@@ -1400,1 +1400,1 @@\n-                JNU_ThrowByNameWithMessageAndLastError\n+                JNU_PerrorThrowByNameWithMessage\n@@ -1405,1 +1405,1 @@\n-            JNU_ThrowByNameWithMessageAndLastError\n+            JNU_PerrorThrowByNameWithMessage\n@@ -1425,1 +1425,1 @@\n-        JNU_ThrowByNameWithMessageAndLastError\n+        JNU_PerrorThrowByNameWithMessage\n@@ -1436,1 +1436,1 @@\n-        JNU_ThrowByNameWithMessageAndLastError\n+        JNU_PerrorThrowByNameWithMessage\n@@ -1506,1 +1506,1 @@\n-        JNU_ThrowByNameWithMessageAndLastError\n+        JNU_PerrorThrowByNameWithMessage\n@@ -1515,1 +1515,1 @@\n-        JNU_ThrowByNameWithMessageAndLastError\n+        JNU_PerrorThrowByNameWithMessage\n@@ -1637,1 +1637,1 @@\n-        JNU_ThrowByNameWithMessageAndLastError\n+        JNU_PerrorThrowByNameWithMessage\n@@ -1677,1 +1677,1 @@\n-                JNU_ThrowByNameWithMessageAndLastError\n+                JNU_PerrorThrowByNameWithMessage\n@@ -1682,1 +1682,1 @@\n-            JNU_ThrowByNameWithMessageAndLastError\n+            JNU_PerrorThrowByNameWithMessage\n@@ -1698,1 +1698,1 @@\n-        JNU_ThrowByNameWithMessageAndLastError\n+        JNU_PerrorThrowByNameWithMessage\n@@ -1742,1 +1742,1 @@\n-        JNU_ThrowByNameWithMessageAndLastError\n+        JNU_PerrorThrowByNameWithMessage\n@@ -1838,1 +1838,1 @@\n-        JNU_ThrowByNameWithMessageAndLastError\n+        JNU_PerrorThrowByNameWithMessage\n","filename":"src\/java.base\/unix\/native\/libnet\/NetworkInterface.c","additions":20,"deletions":20,"binary":false,"changes":40,"status":"modified"},{"patch":"@@ -69,1 +69,1 @@\n-    JNU_ThrowByNameWithMessageAndLastError(env, name, defaultDetail);\n+    JNU_PerrorThrowByNameWithMessage(env, name, defaultDetail);\n","filename":"src\/java.base\/unix\/native\/libnet\/net_util_md.c","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -93,0 +93,53 @@\n+\n+JNIEXPORT void JNICALL\n+throwByNameWithMessageAndWinError\n+  (JNIEnv *env, const char *name, const char *message) {\n+\n+    char buf[256];\n+    size_t n = getLastWinErrorString(buf, sizeof(buf));\n+    size_t messagelen = message == NULL ? 0 : strlen(message);\n+\n+    if (n > 0) {\n+        jstring s = JNU_NewStringPlatform(env, buf);\n+        if (s != NULL) {\n+            jobject x = NULL;\n+            if (messagelen) {\n+                jstring s2 = NULL;\n+                size_t messageextlen = messagelen + 4;\n+                char *str1 = (char *)malloc((messageextlen) * sizeof(char));\n+                if (str1 == 0) {\n+                    JNU_ThrowOutOfMemoryError(env, 0);\n+                    return;\n+                }\n+                jio_snprintf(str1, messageextlen, \" (%s)\", message);\n+                s2 = (*env)->NewStringUTF(env, str1);\n+                free(str1);\n+                JNU_CHECK_EXCEPTION(env);\n+                if (s2 != NULL) {\n+                    jstring s3 = JNU_CallMethodByName(\n+                                     env, NULL, s, \"concat\",\n+                                     \"(Ljava\/lang\/String;)Ljava\/lang\/String;\",\n+                                     s2).l;\n+                    (*env)->DeleteLocalRef(env, s2);\n+                    JNU_CHECK_EXCEPTION(env);\n+                    if (s3 != NULL) {\n+                        (*env)->DeleteLocalRef(env, s);\n+                        s = s3;\n+                    }\n+                }\n+            }\n+            x = JNU_NewObjectByName(env, name, \"(Ljava\/lang\/String;)V\", s);\n+            if (x != NULL) {\n+                (*env)->Throw(env, x);\n+            }\n+        }\n+    }\n+\n+    if (!(*env)->ExceptionOccurred(env)) {\n+        if (messagelen) {\n+            JNU_ThrowByName(env, name, message);\n+        } else {\n+            JNU_ThrowByName(env, name, \"no further information\");\n+        }\n+    }\n+}\n","filename":"src\/java.base\/windows\/native\/libjava\/jni_util_md.c","additions":53,"deletions":0,"binary":false,"changes":53,"status":"modified"},{"patch":"@@ -213,1 +213,1 @@\n-                JNU_ThrowByNameWithMessageAndLastError(env,\n+                throwByNameWithMessageAndWinError(env,\n@@ -413,1 +413,1 @@\n-                JNU_ThrowByNameWithMessageAndLastError(env,\n+                throwByNameWithMessageAndWinError(env,\n","filename":"src\/java.base\/windows\/native\/libnet\/NetworkInterface.c","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -132,1 +132,1 @@\n-                JNU_ThrowByNameWithMessageAndLastError(env,\n+                throwByNameWithMessageAndWinError(env,\n@@ -202,1 +202,1 @@\n-                JNU_ThrowByNameWithMessageAndLastError(env,\n+                throwByNameWithMessageAndWinError(env,\n","filename":"src\/java.base\/windows\/native\/libnet\/NetworkInterface_winXP.c","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -199,1 +199,1 @@\n-    JNU_ThrowByNameWithMessageAndLastError(env, name, defaultDetail);\n+\tthrowByNameWithMessageAndWinError(env, name, defaultDetail);\n","filename":"src\/java.base\/windows\/native\/libnet\/net_util_md.c","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}