{"files":[{"patch":"@@ -92,1 +92,1 @@\n-  if (entry->pd_set_acquire() != NULL) {\n+  while (entry->pd_set_acquire() != NULL) {\n","filename":"src\/hotspot\/share\/classfile\/dictionary.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -76,0 +76,2 @@\n+static GrowableArray<ProtectionDomainEntry*>* _delete_list = NULL;\n+\n@@ -86,1 +88,1 @@\n-static void purge_deleted_entries(GrowableArray<ProtectionDomainEntry*>* delete_list) {\n+static void purge_deleted_entries() {\n@@ -93,1 +95,1 @@\n-  if (delete_list->length() != 0) {\n+  if (_delete_list->length() >= 10) {\n@@ -97,2 +99,3 @@\n-    for (int i = 0; i < delete_list->length(); i++) {\n-      ProtectionDomainEntry* entry = delete_list->at(i);\n+    for (int i = _delete_list->length() - 1; i >= 0; i--) {\n+      ProtectionDomainEntry* entry = _delete_list->at(i);\n+      _delete_list->remove_at(i);\n@@ -101,0 +104,1 @@\n+    assert(_delete_list->length() == 0, \"should be cleared\");\n@@ -108,2 +112,6 @@\n-  ResourceMark rm;\n-  GrowableArray<ProtectionDomainEntry*> delete_list;\n+  \/\/ Create a list for holding deleted entries\n+  if (_delete_list == NULL) {\n+    _delete_list = new (ResourceObj::C_HEAP, mtClass)\n+                       GrowableArray<ProtectionDomainEntry*>(20, mtClass);\n+  }\n+\n@@ -117,1 +125,1 @@\n-    CleanProtectionDomainEntries clean(&delete_list);\n+    CleanProtectionDomainEntries clean(_delete_list);\n@@ -122,1 +130,1 @@\n-  purge_deleted_entries(&delete_list);\n+  purge_deleted_entries();\n@@ -211,1 +219,0 @@\n-\n","filename":"src\/hotspot\/share\/classfile\/protectionDomainCache.cpp","additions":16,"deletions":9,"binary":false,"changes":25,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2018, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2018, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -87,1 +87,3 @@\n-            loadAndRun(jarFilePath);\n+            for (int i = 0; i < 20; i++) {\n+                loadAndRun(jarFilePath);\n+            }\n@@ -104,1 +106,1 @@\n-                                      \"-Xlog:gc+verify,protectiondomain=debug\",\n+                                      \"-Xlog:gc+verify,protectiondomain=trace\",\n@@ -109,0 +111,1 @@\n+        output.shouldContain(\"HandshakeForPD::do_thread\");\n","filename":"test\/hotspot\/jtreg\/runtime\/Dictionary\/ProtectionDomainCacheTest.java","additions":6,"deletions":3,"binary":false,"changes":9,"status":"modified"}]}