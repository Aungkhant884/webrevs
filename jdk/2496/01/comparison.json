{"files":[{"patch":"@@ -215,1 +215,5 @@\n-  __ ldr(tmp, Address(dst, oopDesc::mark_offset_in_bytes()));\n+\n+  \/\/ Make sure to load the forwardee with acquire semantics.\n+  \/\/ This matches accesses in C++ ShenandoahForwarding helpers.\n+  __ lea(tmp, Address(dst, oopDesc::mark_offset_in_bytes()));\n+  __ ldar(tmp, tmp);\n","filename":"src\/hotspot\/cpu\/aarch64\/gc\/shenandoah\/shenandoahBarrierSetAssembler_aarch64.cpp","additions":5,"deletions":1,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -43,1 +43,1 @@\n-  markWord mark = obj->mark();\n+  markWord mark = obj->mark_acquire();\n@@ -58,1 +58,1 @@\n-  markWord mark = obj->mark();\n+  markWord mark = obj->mark_acquire();\n@@ -78,1 +78,1 @@\n-  markWord old_mark = obj->mark();\n+  markWord old_mark = obj->mark_acquire();\n@@ -84,1 +84,6 @@\n-  markWord prev_mark = obj->cas_set_mark(new_mark, old_mark, memory_order_conservative);\n+\n+  \/\/ We need a stronger acq\/rel memory order here. Release on successful forwardee\n+  \/\/ update guarantees publishing the new object copy contents correctly\n+  \/\/ (would be paired with acquire in forwardee accessors). Acquire on failed update\n+  \/\/ would get the updated object after the forwardee load.\n+  markWord prev_mark = obj->cas_set_mark(new_mark, old_mark, memory_order_acq_rel);\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahForwarding.inline.hpp","additions":9,"deletions":4,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -61,2 +61,3 @@\n-  inline markWord  mark()          const;\n-  inline markWord* mark_addr() const;\n+  inline markWord  mark()         const;\n+  inline markWord  mark_acquire() const;\n+  inline markWord* mark_addr()    const;\n","filename":"src\/hotspot\/share\/oops\/oop.hpp","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -49,0 +49,5 @@\n+  return markWord(v);\n+}\n+\n+markWord oopDesc::mark_acquire() const {\n+  uintptr_t v = HeapAccess<MO_ACQUIRE>::load_at(as_oop(), mark_offset_in_bytes());\n","filename":"src\/hotspot\/share\/oops\/oop.inline.hpp","additions":5,"deletions":0,"binary":false,"changes":5,"status":"modified"}]}