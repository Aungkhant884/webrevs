{"files":[{"patch":"@@ -38,0 +38,1 @@\n+#include \"runtime\/atomic.hpp\"\n@@ -356,2 +357,2 @@\n-  int64_t get_java_period() const { return _java_period_millis; };\n-  int64_t get_native_period() const { return _native_period_millis; };\n+  int64_t get_java_period() const { return Atomic::load(&_java_period_millis); };\n+  int64_t get_native_period() const { return Atomic::load(&_native_period_millis); };\n@@ -420,1 +421,1 @@\n-  _java_period_millis = period_millis;\n+  Atomic::store(&_java_period_millis, period_millis);\n@@ -425,1 +426,1 @@\n-  _native_period_millis = period_millis;\n+  Atomic::store(&_native_period_millis, period_millis);\n@@ -504,2 +505,11 @@\n-    const int64_t java_period_millis = _java_period_millis == 0 ? max_jlong : MAX2<int64_t>(_java_period_millis, 1);\n-    const int64_t native_period_millis = _native_period_millis == 0 ? max_jlong : MAX2<int64_t>(_native_period_millis, 1);\n+\n+    int64_t java_period_millis = get_java_period();\n+    java_period_millis = java_period_millis == 0 ? max_jlong : MAX2<int64_t>(java_period_millis, 1);\n+    int64_t native_period_millis = get_native_period();\n+    native_period_millis = native_period_millis == 0 ? max_jlong : MAX2<int64_t>(native_period_millis, 1);\n+\n+    \/\/ If both periods are max_jlong, it implies the sampler is in the process of\n+    \/\/ disenrolling. Loop back for graceful disenroll by means of the semaphore.\n+    if (java_period_millis == max_jlong && native_period_millis == max_jlong) {\n+      continue;\n+    }\n@@ -524,1 +534,1 @@\n-      os::naked_short_sleep(sleep_to_next);\n+      os::naked_sleep(sleep_to_next);\n","filename":"src\/hotspot\/share\/jfr\/periodic\/sampling\/jfrThreadSampler.cpp","additions":17,"deletions":7,"binary":false,"changes":24,"status":"modified"},{"patch":"@@ -41,0 +41,2 @@\n+\n+serviceability\/jvmti\/vthread\/ContStackDepthTest\/ContStackDepthTest.java 8288949 generic-all\n","filename":"test\/hotspot\/jtreg\/ProblemList-Xcomp.txt","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"}]}