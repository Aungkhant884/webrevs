{"files":[{"patch":"@@ -63,2 +63,2 @@\n-      fatal(\"VM operation took too long: \" JLONG_FORMAT \" ms elapsed since VM-op start (timeout: \" INTX_FORMAT \" ms)\",\n-            delay, AbortVMOnVMOperationTimeoutDelay);\n+      fatal(\"%s VM operation took too long: \" JLONG_FORMAT \" ms elapsed since VM-op start (timeout: \" INTX_FORMAT \" ms)\",\n+            _vm_op_name, delay, AbortVMOnVMOperationTimeoutDelay);\n@@ -73,1 +73,2 @@\n-jlong VMOperationTimeoutTask::arm() {\n+void VMOperationTimeoutTask::arm(const char* vm_op_name) {\n+  _vm_op_name = vm_op_name;\n@@ -76,1 +77,0 @@\n-  return _arm_time;\n@@ -81,0 +81,13 @@\n+\n+  \/\/ The two stores to `_armed` are counted in VM-op, but they should be\n+  \/\/ insignificant compared to the actual VM-op duration.\n+  jlong vm_op_duration = nanos_to_millis(os::javaTimeNanos() - _arm_time);\n+\n+  \/\/ Repeat the timeout-check logic on the VM thread, because\n+  \/\/ VMOperationTimeoutTask might miss the arm-disarm window depending on\n+  \/\/ the scheduling.\n+  assert(Thread::current()->is_VM_thread(), \"Check timeout on VM thread\");\n+  if (vm_op_duration > AbortVMOnVMOperationTimeoutDelay) {\n+    fatal(\"%s VM operation took too long: completed in \" JLONG_FORMAT \" ms (timeout: \" INTX_FORMAT \" ms)\",\n+          _vm_op_name, vm_op_duration, AbortVMOnVMOperationTimeoutDelay);\n+  }\n@@ -407,2 +420,1 @@\n-  bool should_abort_on_timeout = AbortVMOnVMOperationTimeout;\n-  jlong vm_op_start_ns;\n+  bool has_timeout_task = (_timeout_task != nullptr);\n@@ -412,3 +424,2 @@\n-    if (should_abort_on_timeout) {\n-      assert(_timeout_task != nullptr, \"must created\");\n-      vm_op_start_ns = _timeout_task->arm();\n+    if (has_timeout_task) {\n+      _timeout_task->arm(_cur_vm_operation->name());\n@@ -422,1 +433,1 @@\n-    if (should_abort_on_timeout) {\n+    if (has_timeout_task) {\n@@ -424,5 +435,0 @@\n-      jlong delay = nanos_to_millis(os::javaTimeNanos() - vm_op_start_ns);\n-      if (delay > AbortVMOnVMOperationTimeoutDelay) {\n-        fatal(\"%s VM operation took too long: completed in \" JLONG_FORMAT \" ms (timeout: \" INTX_FORMAT \" ms)\",\n-              _cur_vm_operation->name(), delay, AbortVMOnVMOperationTimeoutDelay);\n-      }\n","filename":"src\/hotspot\/share\/runtime\/vmThread.cpp","additions":21,"deletions":15,"binary":false,"changes":36,"status":"modified"},{"patch":"@@ -42,1 +42,1 @@\n-\n+  const char* _vm_op_name = nullptr;\n@@ -50,1 +50,1 @@\n-  jlong arm();\n+  void arm(const char* vm_op_name);\n","filename":"src\/hotspot\/share\/runtime\/vmThread.hpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"}]}