{"files":[{"patch":"@@ -63,2 +63,2 @@\n-      fatal(\"VM operation took too long: \" JLONG_FORMAT \" ms elapsed since VM-op start (timeout: \" INTX_FORMAT \" ms)\",\n-            delay, AbortVMOnVMOperationTimeoutDelay);\n+      fatal(\"%s VM operation took too long: \" JLONG_FORMAT \" ms elapsed since VM-op start (timeout: \" INTX_FORMAT \" ms)\",\n+            _vm_op_name, delay, AbortVMOnVMOperationTimeoutDelay);\n@@ -73,1 +73,2 @@\n-void VMOperationTimeoutTask::arm() {\n+void VMOperationTimeoutTask::arm(const char* vm_op_name) {\n+  _vm_op_name = vm_op_name;\n@@ -80,0 +81,13 @@\n+\n+  \/\/ The two stores to `_armed` are counted in VM-op, but they should be\n+  \/\/ insignificant compared to the actual VM-op duration.\n+  jlong vm_op_duration = nanos_to_millis(os::javaTimeNanos() - _arm_time);\n+\n+  \/\/ Repeat the timeout-check logic on the VM thread, because\n+  \/\/ VMOperationTimeoutTask might miss the arm-disarm window depending on\n+  \/\/ the scheduling.\n+  if (vm_op_duration > AbortVMOnVMOperationTimeoutDelay) {\n+    fatal(\"%s VM operation took too long: completed in \" JLONG_FORMAT \" ms (timeout: \" INTX_FORMAT \" ms)\",\n+          _vm_op_name, vm_op_duration, AbortVMOnVMOperationTimeoutDelay);\n+  }\n+  _vm_op_name = nullptr;\n@@ -406,0 +420,1 @@\n+  bool has_timeout_task = (_timeout_task != nullptr);\n@@ -409,2 +424,2 @@\n-    if (_timeout_task != NULL) {\n-      _timeout_task->arm();\n+    if (has_timeout_task) {\n+      _timeout_task->arm(_cur_vm_operation->name());\n@@ -418,1 +433,1 @@\n-    if (_timeout_task != NULL) {\n+    if (has_timeout_task) {\n","filename":"src\/hotspot\/share\/runtime\/vmThread.cpp","additions":21,"deletions":6,"binary":false,"changes":27,"status":"modified"},{"patch":"@@ -42,1 +42,1 @@\n-\n+  const char* _vm_op_name;\n@@ -45,1 +45,1 @@\n-          PeriodicTask(interval_time), _armed(0), _arm_time(0) {}\n+          PeriodicTask(interval_time), _armed(0), _arm_time(0), _vm_op_name(nullptr) {}\n@@ -50,1 +50,1 @@\n-  void arm();\n+  void arm(const char* vm_op_name);\n","filename":"src\/hotspot\/share\/runtime\/vmThread.hpp","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"}]}