{"files":[{"patch":"@@ -28,6 +28,0 @@\n-import sun.awt.AppContext;\n-import sun.awt.SunToolkit;\n-\n-import java.util.Collections;\n-import java.util.Map;\n-import java.util.WeakHashMap;\n@@ -37,0 +31,3 @@\n+import java.awt.Graphics;\n+import java.awt.Graphics2D;\n+import java.awt.Stroke;\n@@ -38,0 +35,5 @@\n+import java.awt.geom.AffineTransform;\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.WeakHashMap;\n+\n@@ -41,0 +43,5 @@\n+import sun.awt.AppContext;\n+import sun.awt.SunToolkit;\n+\n+import static sun.java2d.pipe.Region.clipRound;\n+\n@@ -138,0 +145,62 @@\n+\n+    @FunctionalInterface\n+    public interface UnscaledBorderPainter {\n+        void paintUnscaledBorder(Component c, Graphics g,\n+                                 int w, int h, double scaleFactor);\n+    }\n+\n+    public static void paintBorder(Component c, Graphics g, int x, int y,\n+                                   int w, int h, UnscaledBorderPainter painter) {\n+\n+        \/\/ Step 1: Reset Transform\n+        AffineTransform at = null;\n+        Stroke oldStk = null;\n+        boolean resetTransform = false;\n+        double scaleFactor = 1;\n+\n+        int xtranslation = x;\n+        int ytranslation = y;\n+        int width = w;\n+        int height = h;\n+\n+        if (g instanceof Graphics2D) {\n+            Graphics2D g2d = (Graphics2D) g;\n+            at = g2d.getTransform();\n+            oldStk = g2d.getStroke();\n+            scaleFactor = Math.min(at.getScaleX(), at.getScaleY());\n+\n+            \/\/ if m01 or m10 is non-zero, then there is a rotation or shear\n+            \/\/ or if scale=1, skip resetting the transform\n+            resetTransform = ((at.getShearX() == 0) && (at.getShearY() == 0))\n+                    && ((at.getScaleX() > 1) || (at.getScaleY() > 1));\n+\n+            if (resetTransform) {\n+                \/* Deactivate the HiDPI scaling transform,\n+                 * so we can do paint operations in the device\n+                 * pixel coordinate system instead of the logical coordinate system.\n+                 *\/\n+                g2d.setTransform(new AffineTransform());\n+                double xx = at.getScaleX() * x + at.getTranslateX();\n+                double yy = at.getScaleY() * y + at.getTranslateY();\n+                xtranslation = clipRound(xx);\n+                ytranslation = clipRound(yy);\n+                width = clipRound(at.getScaleX() * w + xx) - xtranslation;\n+                height = clipRound(at.getScaleY() * h + yy) - ytranslation;\n+            }\n+        }\n+\n+        g.translate(xtranslation, ytranslation);\n+\n+        \/\/ Step 2: Call respective paintBorder with transformed values\n+        painter.paintUnscaledBorder(c, g, width, height, scaleFactor);\n+\n+        \/\/ Step 3: Restore previous stroke & transform\n+        g.translate(-xtranslation, -ytranslation);\n+        if (g instanceof Graphics2D) {\n+            Graphics2D g2d = (Graphics2D) g;\n+            g2d.setStroke(oldStk);\n+            if (resetTransform) {\n+                g2d.setTransform(at);\n+            }\n+        }\n+    }\n","filename":"src\/java.desktop\/share\/classes\/com\/sun\/java\/swing\/SwingUtilities3.java","additions":75,"deletions":6,"binary":false,"changes":81,"status":"modified"},{"patch":"@@ -33,2 +33,0 @@\n-import java.awt.Stroke;\n-import java.awt.geom.AffineTransform;\n@@ -37,0 +35,2 @@\n+import com.sun.java.swing.SwingUtilities3;\n+\n@@ -153,6 +153,6 @@\n-        \/\/ We remove any initial transforms to prevent rounding errors\n-        \/\/ when drawing in non-integer scales\n-        AffineTransform at = null;\n-        Stroke oldStk = null;\n-        int stkWidth = 1;\n-        boolean resetTransform = false;\n+        SwingUtilities3.paintBorder(c, g, x, y, width, height, this::paintUnscaledBorder);\n+    }\n+\n+    private void paintUnscaledBorder(Component c, Graphics g,\n+                                     int w, int h, double scaleFactor) {\n+        int stkWidth = (int) Math.floor(scaleFactor);\n@@ -161,26 +161,1 @@\n-            at = g2d.getTransform();\n-            oldStk = g2d.getStroke();\n-            \/\/ if m01 or m10 is non-zero, then there is a rotation or shear\n-            \/\/ skip resetting the transform\n-            resetTransform = (at.getShearX() == 0) && (at.getShearY() == 0);\n-            if (resetTransform) {\n-                g2d.setTransform(new AffineTransform());\n-                stkWidth = (int) Math.floor(Math.min(at.getScaleX(), at.getScaleY()));\n-                g2d.setStroke(new BasicStroke((float) stkWidth));\n-            }\n-        }\n-\n-        int w;\n-        int h;\n-        int xtranslation;\n-        int ytranslation;\n-        if (resetTransform) {\n-            w = (int) Math.floor(at.getScaleX() * width - 1);\n-            h = (int) Math.floor(at.getScaleY() * height - 1);\n-            xtranslation = (int) Math.ceil(at.getScaleX()*x+at.getTranslateX());\n-            ytranslation = (int) Math.ceil(at.getScaleY()*y+at.getTranslateY());\n-        } else {\n-            w = width;\n-            h = height;\n-            xtranslation = x;\n-            ytranslation = y;\n+            g2d.setStroke(new BasicStroke((float) stkWidth));\n@@ -189,2 +164,0 @@\n-        g.translate(xtranslation, ytranslation);\n-\n@@ -197,9 +170,0 @@\n-\n-        g.translate(-xtranslation, -ytranslation);\n-\n-        \/\/ Set the transform we removed earlier\n-        if (resetTransform) {\n-            Graphics2D g2d = (Graphics2D) g;\n-            g2d.setTransform(at);\n-            g2d.setStroke(oldStk);\n-        }\n","filename":"src\/java.desktop\/share\/classes\/javax\/swing\/border\/EtchedBorder.java","additions":9,"deletions":45,"binary":false,"changes":54,"status":"modified"},{"patch":"@@ -37,1 +37,0 @@\n-import java.awt.geom.AffineTransform;\n@@ -39,1 +38,1 @@\n-import static sun.java2d.pipe.Region.clipRound;\n+import com.sun.java.swing.SwingUtilities3;\n@@ -147,0 +146,5 @@\n+        SwingUtilities3.paintBorder(c, g, x, y, width, height, this::paintUnscaledBorder);\n+    }\n+\n+    private void paintUnscaledBorder(Component c, Graphics g,\n+                                     int w, int h, double scaleFactor) {\n@@ -149,38 +153,1 @@\n-\n-            AffineTransform at = g2d.getTransform();\n-\n-            \/\/ if m01 or m10 is non-zero, then there is a rotation or shear\n-            \/\/ or if no Scaling enabled,\n-            \/\/ skip resetting the transform\n-            boolean resetTransform = ((at.getShearX() == 0) && (at.getShearY() == 0)) &&\n-                    ((at.getScaleX() > 1) || (at.getScaleY() > 1));\n-\n-            int xtranslation;\n-            int ytranslation;\n-            int w;\n-            int h;\n-            int offs;\n-\n-            if (resetTransform) {\n-                \/* Deactivate the HiDPI scaling transform,\n-                 * so we can do paint operations in the device\n-                 * pixel coordinate system instead of the logical coordinate system.\n-                 *\/\n-                g2d.setTransform(new AffineTransform());\n-                double xx = at.getScaleX() * x + at.getTranslateX();\n-                double yy = at.getScaleY() * y + at.getTranslateY();\n-                xtranslation = clipRound(xx);\n-                ytranslation = clipRound(yy);\n-                w = clipRound(at.getScaleX() * width + xx) - xtranslation;\n-                h = clipRound(at.getScaleY() * height + yy) - ytranslation;\n-                offs = this.thickness * (int) at.getScaleX();\n-            } else {\n-                w = width;\n-                h = height;\n-                xtranslation = x;\n-                ytranslation = y;\n-                offs = this.thickness;\n-            }\n-\n-            g2d.translate(xtranslation, ytranslation);\n-\n+            int offs = this.thickness * (int) scaleFactor;\n@@ -192,1 +159,0 @@\n-\n@@ -198,2 +164,1 @@\n-            }\n-            else {\n+            } else {\n@@ -203,0 +168,1 @@\n+\n@@ -207,7 +173,1 @@\n-            g2d.setColor(oldColor);\n-\n-            g2d.translate(-xtranslation, -ytranslation);\n-\n-            if (resetTransform) {\n-                g2d.setTransform(at);\n-            }\n+            g.setColor(oldColor);\n","filename":"src\/java.desktop\/share\/classes\/javax\/swing\/border\/LineBorder.java","additions":10,"deletions":50,"binary":false,"changes":60,"status":"modified"},{"patch":"@@ -36,1 +36,0 @@\n-import java.awt.Stroke;\n@@ -38,1 +37,0 @@\n-import java.awt.geom.AffineTransform;\n@@ -65,0 +63,1 @@\n+import com.sun.java.swing.SwingUtilities3;\n@@ -253,0 +252,5 @@\n+            SwingUtilities3.paintBorder(c, g, x, y, w, h, this::paintUnscaledBorder);\n+        }\n+\n+        private void paintUnscaledBorder(Component c, Graphics g,\n+                                         int width, int height, double scaleFactor) {\n@@ -267,42 +271,0 @@\n-            AffineTransform at = null;\n-            Stroke oldStk = null;\n-            boolean resetTransform = false;\n-            int stkWidth = 1;\n-            double scaleFactor = 1;\n-\n-            if (g instanceof Graphics2D g2d) {\n-                at = g2d.getTransform();\n-                scaleFactor = at.getScaleX();\n-                oldStk = g2d.getStroke();\n-\n-                \/\/ if m01 or m10 is non-zero, then there is a rotation or shear\n-                \/\/ skip resetting the transform\n-                resetTransform = ((at.getShearX() == 0) && (at.getShearY() == 0));\n-\n-                if (resetTransform) {\n-                    g2d.setTransform(new AffineTransform());\n-                    stkWidth = clipRound(Math.min(at.getScaleX(), at.getScaleY()));\n-                    g2d.setStroke(new BasicStroke((float) stkWidth));\n-                }\n-            }\n-\n-            int xtranslation;\n-            int ytranslation;\n-            int width;\n-            int height;\n-\n-            if (resetTransform) {\n-                double xx = at.getScaleX() * x + at.getTranslateX();\n-                double yy = at.getScaleY() * y + at.getTranslateY();\n-                xtranslation = clipRound(xx);\n-                ytranslation = clipRound(yy);\n-                width = clipRound(at.getScaleX() * w + xx) - xtranslation;\n-                height = clipRound(at.getScaleY() * h + yy) - ytranslation;\n-            } else {\n-                xtranslation = x;\n-                ytranslation = y;\n-                width = w;\n-                height = h;\n-            }\n-            g.translate(xtranslation, ytranslation);\n-\n@@ -322,0 +284,1 @@\n+                int stkWidth = clipRound(scaleFactor);\n@@ -328,0 +291,5 @@\n+                if (g instanceof Graphics2D) {\n+                    Graphics2D g2d = (Graphics2D) g;\n+                    g2d.setStroke(new BasicStroke((float) stkWidth));\n+                }\n+\n@@ -346,8 +314,0 @@\n-\n-            \/\/ restore previous transform\n-            g.translate(-xtranslation, -ytranslation);\n-            if (resetTransform) {\n-                Graphics2D g2d = (Graphics2D) g;\n-                g2d.setTransform(at);\n-                g2d.setStroke(oldStk);\n-            }\n","filename":"src\/java.desktop\/share\/classes\/javax\/swing\/plaf\/metal\/MetalBorders.java","additions":12,"deletions":52,"binary":false,"changes":64,"status":"modified"}]}