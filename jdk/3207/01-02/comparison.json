{"files":[{"patch":"@@ -569,2 +569,8 @@\n-    \/\/ For when TRAPS is JavaThread.\n-    counters = MethodCounters::allocate(mh, current->as_Java_thread());\n+    Thread* THREAD = current;\n+    counters = MethodCounters::allocate(mh, THREAD);\n+    if (HAS_PENDING_EXCEPTION) {\n+      CLEAR_PENDING_EXCEPTION;  \/\/ MethodData above doesn't clear exception\n+      CompileBroker::log_metaspace_failure();\n+      ClassLoaderDataGraph::set_metaspace_oom(true);\n+      return NULL;\n+    }\n@@ -572,0 +578,2 @@\n+    \/\/ Call metaspace allocation that doesn't throw exception if the\n+    \/\/ current thread isn't a JavaThread, ie. the VMThread.\n@@ -573,6 +581,5 @@\n-  }\n-  if (counters == NULL || current->has_pending_exception()) {\n-    current->clear_pending_exception(); \/\/ MethodData above doesn't clear exception\n-    CompileBroker::log_metaspace_failure();\n-    ClassLoaderDataGraph::set_metaspace_oom(true);\n-    return NULL;\n+    if (counters == NULL) {\n+      CompileBroker::log_metaspace_failure();\n+      ClassLoaderDataGraph::set_metaspace_oom(true);\n+      return NULL;\n+    }\n","filename":"src\/hotspot\/share\/oops\/method.cpp","additions":15,"deletions":8,"binary":false,"changes":23,"status":"modified"}]}