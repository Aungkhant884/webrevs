{"files":[{"patch":"@@ -1500,1 +1500,0 @@\n-                                          preferred_page_size,\n@@ -1502,0 +1501,1 @@\n+                                          preferred_page_size,\n","filename":"src\/hotspot\/share\/gc\/g1\/g1CollectedHeap.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -53,1 +53,2 @@\n-  os::trace_page_sizes(\"Mark Bitmap\", raw_bytes, raw_bytes, page_sz,\n+  const size_t used_page_sz = ReservedSpace::actual_reserved_page_size(rs);\n+  os::trace_page_sizes(\"Mark Bitmap\", raw_bytes, raw_bytes, used_page_sz,\n","filename":"src\/hotspot\/share\/gc\/parallel\/parMarkBitMap.cpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -175,0 +175,1 @@\n+  size_t used_page_size = ReservedSpace::actual_reserved_page_size(heap_rs);\n@@ -179,1 +180,1 @@\n-                       alignment,\n+                       used_page_size,\n","filename":"src\/hotspot\/share\/gc\/shared\/genCollectedHeap.cpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -52,0 +52,5 @@\n+    static boolean checkLargePagesEnabled(OutputAnalyzer output) {\n+        String lp = output.firstMatch(\"Large Page Support: (\\\\w*)\", 1);\n+        return lp != null && lp.equals(\"Enabled\");\n+    }\n+\n@@ -53,1 +58,10 @@\n-        String pageSizeStr = output.firstMatch(pattern, 1);\n+        \/\/ First check if there is a large page failure associated with\n+        \/\/ the data structure being checked.\n+        String failureMatch = output.firstMatch(\"Reserve regular memory without large pages\\\\n.*\" + pattern, 1);\n+        if (failureMatch != null) {\n+            \/\/ This should only happen when we are expecting large pages\n+            if (expectedSize == smallPageSize) {\n+                throw new RuntimeException(\"Expected small page size when large page failure was detected\");\n+            }\n+            expectedSize = smallPageSize;\n+        }\n@@ -55,0 +69,2 @@\n+        \/\/ Now check what page size is traced.\n+        String pageSizeStr = output.firstMatch(pattern, 1);\n@@ -85,1 +101,1 @@\n-                                                   \"-Xlog:pagesize\",\n+                                                   \"-Xlog:pagesize,gc+init,gc+heap+coops=debug\",\n@@ -92,2 +108,9 @@\n-        checkSmallTables(output, (cardsShouldUseLargePages ? largePageSize : smallPageSize));\n-        checkBitmaps(output, (bitmapShouldUseLargePages ? largePageSize : smallPageSize));\n+        \/\/ Only expect large page size if no large page allocation failures\n+        \/\/ are present in the log.\n+        if (checkLargePagesEnabled(output)) {\n+            checkSmallTables(output, (cardsShouldUseLargePages ? largePageSize : smallPageSize));\n+            checkBitmaps(output, (bitmapShouldUseLargePages ? largePageSize : smallPageSize));\n+        } else {\n+            checkSmallTables(output, smallPageSize);\n+            checkBitmaps(output, smallPageSize);\n+        }\n","filename":"test\/hotspot\/jtreg\/gc\/g1\/TestLargePageUseForAuxMemory.java","additions":27,"deletions":4,"binary":false,"changes":31,"status":"modified"}]}