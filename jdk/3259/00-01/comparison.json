{"files":[{"patch":"@@ -171,1 +171,1 @@\n-static bool read_fully(const char *fname, char *buf, int buflen) {\n+static bool read_fully(const char *fname, char *buf, size_t buflen) {\n@@ -176,1 +176,1 @@\n-    ssize_t read_sz = read(fd, buf, buflen - 1);\n+    ssize_t read_sz = read(fd, buf, buflen);\n@@ -178,5 +178,9 @@\n-    if ((read_sz > 0) && isgraph(*buf)) {\n-      buf[read_sz] = '\\0';\n-      \/\/ Replace control chars to ' '\n-      for (char *ch = buf; ch < buf + read_sz; ch++) {\n-        if (iscntrl(*ch)) {\n+\n+    \/\/ Skip if the contents starts with '\\n' because some machine only sets\n+    \/\/ '\\n' to the board name.\n+    \/\/ (e.g. \/sys\/devices\/virtual\/dmi\/id\/board_name)\n+    if ((read_sz > 0) && (*buf != '\\n')) {\n+      buf[read_sz - 1] = '\\0';\n+      \/\/ Replace '\\0' to ' '\n+      for (char *ch = buf; ch < buf + read_sz - 1; ch++) {\n+        if (*ch == '\\0') {\n@@ -194,5 +198,11 @@\n-  if (read_fully(\"\/proc\/device-tree\/compatible\", buf, buflen)) {\n-    return;\n-  }\n-  if (read_fully(\"\/sys\/devices\/virtual\/dmi\/id\/board_name\", buf, buflen)) {\n-    return;\n+  const char *board_name_file_list[] = {\n+    \"\/proc\/device-tree\/compatible\",\n+    \"\/sys\/devices\/virtual\/dmi\/id\/board_name\",\n+    \"\/sys\/devices\/virtual\/dmi\/id\/product_name\",\n+    NULL\n+  };\n+\n+  for (const char **fname = board_name_file_list; *fname != NULL; fname++) {\n+    if (read_fully(*fname, buf, buflen)) {\n+      return;\n+    }\n@@ -200,1 +210,0 @@\n-  read_fully(\"\/sys\/devices\/virtual\/dmi\/id\/product_name\", buf, buflen);\n","filename":"src\/hotspot\/os_cpu\/linux_aarch64\/vm_version_linux_aarch64.cpp","additions":22,"deletions":13,"binary":false,"changes":35,"status":"modified"}]}