{"files":[{"patch":"@@ -2950,9 +2950,9 @@\n-              bool is_assignable = current_type().is_assignable_from(\n-                stack_object_type, this, true, CHECK_VERIFY(this));\n-              if (!is_assignable) {\n-                if (ref_class_type.name() == vmSymbols::java_lang_Object()\n-                    && stack_object_type.is_array()\n-                    && method_name == vmSymbols::clone_name()) {\n-                  \/\/ Special case: arrays pretend to implement public Object\n-                  \/\/ clone().\n-                } else {\n+              if (ref_class_type.name() == vmSymbols::java_lang_Object()\n+                  && stack_object_type.is_array()\n+                  && method_name == vmSymbols::clone_name()) {\n+                \/\/ Special case: arrays pretend to implement public Object\n+                \/\/ clone().\n+              } else {\n+                bool is_assignable = current_type().is_assignable_from(\n+                  stack_object_type, this, true, CHECK_VERIFY(this));\n+                if (!is_assignable) {\n","filename":"src\/hotspot\/share\/classfile\/verifier.cpp","additions":9,"deletions":9,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -0,0 +1,79 @@\n+\/*\n+ * Copyright (c) 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/*\n+ * @test Verifier handling of invoking java\/lang\/Object::clone() on object arrays.\n+ * @bug 8286277\n+ * @requires vm.cds\n+ * @library \/test\/lib \/test\/hotspot\/jtreg\/runtime\/verifier \/test\/hotspot\/jtreg\/runtime\/cds\/appcds\/test-classes\n+ * @build InvokeCloneValid InvokeCloneInvalid VerifyObjArrayCloneTestApp\n+ * @run driver jdk.test.lib.helpers.ClassFileInstaller -jar app.jar VerifyObjArrayCloneTestApp\n+ * @run driver jdk.test.lib.helpers.ClassFileInstaller -jar tests.jar InvokeCloneValid InvokeCloneInvalid\n+ * @run driver VerifyObjArrayCloneTest\n+ *\/\n+\n+import java.io.File;\n+import jdk.test.lib.Platform;\n+import jdk.test.lib.helpers.ClassFileInstaller;\n+\n+public class VerifyObjArrayCloneTest {\n+    private static String appJar = ClassFileInstaller.getJarPath(\"app.jar\");\n+    private static String testsJar = ClassFileInstaller.getJarPath(\"tests.jar\");\n+    private static String mainAppClass = \"VerifyObjArrayCloneTestApp\";\n+\n+    public static void main(String... args) throws Exception {\n+        testInAppPath();\n+        if (Platform.areCustomLoadersSupportedForCDS()) {\n+            testInCustomLoader();\n+        }\n+    }\n+\n+    \/\/ Try to load InvokeCloneValid and InvokeCloneInvalid from the AppClassLoader\n+    static void testInAppPath() throws Exception {\n+        String cp = appJar + File.pathSeparator + testsJar;\n+        TestCommon.dump(cp, TestCommon.list(mainAppClass,\n+                                            \"InvokeCloneValid\",\n+                                            \"InvokeCloneInvalid\"));\n+\n+        TestCommon.run(\"-cp\", cp, \"-Xlog:cds+verification=trace\",\n+                       mainAppClass)\n+            .assertNormalExit();\n+    }\n+\n+    \/\/ Try to load InvokeCloneValid and InvokeCloneInvalid from a custom class loader\n+    static void testInCustomLoader() throws Exception {\n+        String cp = appJar;\n+\n+        String classlist[] = new String[] {\n+            mainAppClass,\n+            \"java\/lang\/Object id: 1\",\n+            \"InvokeCloneValid id: 2 super: 1 source: \" + testsJar,\n+            \"InvokeCloneInvalid id: 3 super: 1 source: \" + testsJar,\n+        };\n+\n+        TestCommon.dump(cp, classlist);\n+        TestCommon.run(\"-cp\", cp, \"-Xlog:cds+verification=trace\",\n+                       mainAppClass, testsJar)\n+            .assertNormalExit();\n+    }\n+}\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/VerifyObjArrayCloneTest.java","additions":79,"deletions":0,"binary":false,"changes":79,"status":"added"},{"patch":"@@ -0,0 +1,82 @@\n+\/*\n+ * Copyright (c) 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/*\n+ * @test Verifier handling of invoking java\/lang\/Object::clone() on object arrays.\n+ * @bug 8286277\n+ * @requires vm.cds\n+ * @library \/test\/lib \/test\/hotspot\/jtreg\/runtime\/verifier\n+ *          \/test\/hotspot\/jtreg\/runtime\/cds\/appcds\n+ *          \/test\/hotspot\/jtreg\/runtime\/cds\/appcds\/test-classes\n+ * @build sun.hotspot.WhiteBox\n+  * @build InvokeCloneValid InvokeCloneInvalid VerifyObjArrayCloneTestApp\n+ * @run driver jdk.test.lib.helpers.ClassFileInstaller -jar app.jar VerifyObjArrayCloneTestApp\n+ * @run driver jdk.test.lib.helpers.ClassFileInstaller -jar tests.jar InvokeCloneValid InvokeCloneInvalid\n+ * @run driver jdk.test.lib.helpers.ClassFileInstaller -jar WhiteBox.jar sun.hotspot.WhiteBox\n+ * @run main\/othervm -XX:+UnlockDiagnosticVMOptions -XX:+WhiteBoxAPI -Xbootclasspath\/a:.\/WhiteBox.jar VerifyObjArrayCloneTest\n+ *\/\n+\n+import java.io.File;\n+import jdk.test.lib.helpers.ClassFileInstaller;\n+\n+public class VerifyObjArrayCloneTest extends DynamicArchiveTestBase {\n+    private static String appJar = ClassFileInstaller.getJarPath(\"app.jar\");\n+    private static String testsJar = ClassFileInstaller.getJarPath(\"tests.jar\");\n+    private static String mainAppClass = \"VerifyObjArrayCloneTestApp\";\n+\n+    public static void main(String[] args) throws Exception {\n+        runTest(VerifyObjArrayCloneTest::testInAppPath);\n+        runTest(VerifyObjArrayCloneTest::testInCustomLoader);\n+    }\n+\n+    \/\/ Try to load InvokeCloneValid and InvokeCloneInvalid from the AppClassLoader\n+    private static void testInAppPath() throws Exception {\n+        String cp = appJar + File.pathSeparator + testsJar;\n+        String topArchiveName = getNewArchiveName(\"top\");\n+        dump(topArchiveName,\n+             \"-cp\", cp,\n+             mainAppClass)\n+             .assertNormalExit();\n+\n+        run(topArchiveName,\n+            \"-cp\", cp,\n+             mainAppClass)\n+            .assertNormalExit();\n+    }\n+\n+    \/\/ Try to load InvokeCloneValid and InvokeCloneInvalid from a custom class loader\n+    private static void testInCustomLoader() throws Exception {\n+        String cp = appJar;\n+        String topArchiveName = getNewArchiveName(\"top\");\n+        dump(topArchiveName,\n+             \"-cp\", cp,\n+             \"-Xlog:cds+class=debug\",\n+             mainAppClass, testsJar)\n+             .assertNormalExit();\n+\n+        run(topArchiveName,\n+            \"-cp\", cp,\n+             mainAppClass, testsJar)\n+            .assertNormalExit();\n+    }\n+}\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/dynamicArchive\/VerifyObjArrayCloneTest.java","additions":82,"deletions":0,"binary":false,"changes":82,"status":"added"},{"patch":"@@ -0,0 +1,56 @@\n+\/*\n+ * Copyright (c) 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+import java.io.File;\n+import java.net.URL;\n+import java.net.URLClassLoader;\n+\n+public class VerifyObjArrayCloneTestApp {\n+    public static void main(String args[]) throws Exception {\n+        ClassLoader appLoader = VerifyObjArrayCloneTestApp.class.getClassLoader();\n+        if (args.length == 0) {\n+            \/\/ Load the test classes from the classpath\n+            doTest(appLoader);\n+        } else {\n+            File f = new File(args[0]);\n+            URL[] classLoaderUrls = new URL[] {f.getAbsoluteFile().toURI().toURL()};\n+            URLClassLoader customLoader = new URLClassLoader(classLoaderUrls, appLoader);\n+            doTest(customLoader);\n+        }\n+    }\n+\n+    public static void doTest(ClassLoader loader) throws Exception {\n+        try {\n+            Class.forName(\"InvokeCloneValid\", \/*initialize=*\/true, loader);\n+        }  catch (VerifyError e) {\n+            throw new RuntimeException(\"Unexpected VerifyError\", e);\n+        }\n+\n+        try {\n+            Class.forName(\"InvokeCloneInvalid\", \/*initialize=*\/true, loader);\n+            throw new RuntimeException(\"VerifyError expected but not thrown\");\n+        } catch (VerifyError e) {\n+            System.out.println(\"Expected: \" + e);\n+        }\n+    }\n+}\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/test-classes\/VerifyObjArrayCloneTestApp.java","additions":56,"deletions":0,"binary":false,"changes":56,"status":"added"},{"patch":"@@ -0,0 +1,46 @@\n+\/*\n+ * Copyright (c) 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/*\n+ * @test Verifier handling of invoking java\/lang\/Object::clone() on object arrays.\n+ * @bug 8286277\n+ * @build InvokeCloneValid InvokeCloneInvalid\n+ * @run main\/othervm -Xverify InvokeClone\n+ *\/\n+\n+public class InvokeClone {\n+    public static void main(String[] args) throws ClassNotFoundException {\n+        try {\n+            Class.forName(\"InvokeCloneValid\");\n+        }  catch (VerifyError e) {\n+            throw new RuntimeException(\"Unexpected VerifyError\", e);\n+        }\n+\n+        try {\n+            Class.forName(\"InvokeCloneInvalid\");\n+            throw new RuntimeException(\"VerifyError expected but not thrown\");\n+        } catch (VerifyError e) {\n+            System.out.println(\"Expected: \" + e);\n+        }\n+    }\n+}\n","filename":"test\/hotspot\/jtreg\/runtime\/verifier\/InvokeClone.java","additions":46,"deletions":0,"binary":false,"changes":46,"status":"added"},{"patch":"@@ -0,0 +1,34 @@\n+\/*\n+ * Copyright (c) 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+super public class InvokeCloneInvalid\n+    version 52:0\n+{\n+  public static Method test:\"(Ljava\/lang\/String;)V\"\n+    stack 1 locals 1\n+  {\n+    aload_0;\n+    invokevirtual Method \"java\/lang\/Object\".clone:\"()Ljava\/lang\/Object;\";\n+    return;\n+  }\n+}\n","filename":"test\/hotspot\/jtreg\/runtime\/verifier\/InvokeCloneInvalid.jasm","additions":34,"deletions":0,"binary":false,"changes":34,"status":"added"},{"patch":"@@ -0,0 +1,42 @@\n+\/*\n+ * Copyright (c) 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+super public class InvokeCloneValid\n+    version 52:0\n+{\n+  public static Method test:\"([Ljava\/lang\/Object;)V\"\n+    stack 1 locals 1\n+  {\n+    aload_0;\n+    invokevirtual Method \"java\/lang\/Object\".clone:\"()Ljava\/lang\/Object;\";\n+    return;\n+  }\n+\n+  public static Method test2:\"([Ljava\/lang\/String;)V\"\n+    stack 1 locals 1\n+  {\n+    aload_0;\n+    invokevirtual Method \"java\/lang\/Object\".clone:\"()Ljava\/lang\/Object;\";\n+    return;\n+  }\n+}\n\\ No newline at end of file\n","filename":"test\/hotspot\/jtreg\/runtime\/verifier\/InvokeCloneValid.jasm","additions":42,"deletions":0,"binary":false,"changes":42,"status":"added"}]}