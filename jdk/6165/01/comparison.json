{"files":[{"patch":"@@ -56,0 +56,1 @@\n+import jdk.javadoc.internal.doclets.formats.html.markup.HtmlAttr;\n@@ -383,1 +384,2 @@\n-    protected Content snippetTagOutput(Element element, SnippetTree tag, StyledText content) {\n+    protected Content snippetTagOutput(Element element, SnippetTree tag, StyledText content,\n+                                       String id, String lang) {\n@@ -385,1 +387,9 @@\n-        result.add(Text.of(utils.normalizeNewlines(\"\\n\")));\n+        if (id != null && !id.isBlank()) {\n+            result.put(HtmlAttr.ID, id);\n+        }\n+        HtmlTree code = new HtmlTree(TagName.CODE)\n+                .add(HtmlTree.EMPTY); \/\/ Make sure the element is always rendered\n+        if (lang != null && !lang.isBlank()) {\n+            code.addStyle(\"language-\" + lang);\n+        }\n+\n@@ -389,1 +399,1 @@\n-                result.add(text);\n+                code.add(text);\n@@ -434,1 +444,1 @@\n-                result.add(c);\n+                code.add(c);\n@@ -437,1 +447,1 @@\n-        return result;\n+        return result.add(code);\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/TagletWriterImpl.java","additions":15,"deletions":5,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -264,1 +264,15 @@\n-        return writer.snippetTagOutput(holder, snippetTag, text);\n+        String lang = null;\n+        AttributeTree langAttr = attributes.get(\"lang\");\n+        if (langAttr != null && langAttr.getValueKind() != AttributeTree.ValueKind.EMPTY) {\n+            lang = stringOf(langAttr.getValue());\n+        } else if (containsClass) {\n+            lang = \"java\";\n+        } else if (containsFile) {\n+            lang = languageFromFileName(fileObject.getName());\n+        }\n+        AttributeTree idAttr = attributes.get(\"id\");\n+        String id = idAttr == null || idAttr.getValueKind() == AttributeTree.ValueKind.EMPTY\n+                        ? null\n+                        : stringOf(idAttr.getValue());\n+\n+        return writer.snippetTagOutput(holder, snippetTag, text, id, lang);\n@@ -301,0 +315,26 @@\n+    private String languageFromFileName(String fileName) {\n+        int lastDot = fileName.lastIndexOf('.');\n+        if (lastDot == -1) {\n+            return null;\n+        }\n+        return switch (Utils.toLowerCase(fileName.substring(lastDot))) {\n+            \/\/ TODO: this list could probably be expanded\n+            case \".bat\"                              -> \"batch\";\n+            case \".c\", \".h\"                          -> \"c\";\n+            case \".clj\", \".cljs\", \".cljc\"            -> \"clojure\";\n+            case \".cpp\", \".hpp\"                      -> \"cpp\";\n+            case \".groovy\", \".gvy\", \".gy\", \".gsh\"    -> \"groovy\";\n+            case \".java\"                             -> \"java\";\n+            case \".js\"                               -> \"javascript\";\n+            case \".json\"                             -> \"json\";\n+            case \".kt\", \".ktm\", \".kts\"               -> \"kotlin\";\n+            case \".properties\"                       -> \"properties\";\n+            case \".py\"                               -> \"python\";\n+            case \".rb\"                               -> \"ruby\";\n+            case \".scala\", \".sc\"                     -> \"scala\";\n+            case \".sh\"                               -> \"bash\";\n+            case \".tex\"                              -> \"latex\";\n+            default                                  -> null;\n+        };\n+    }\n+\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/toolkit\/taglets\/SnippetTaglet.java","additions":41,"deletions":1,"binary":false,"changes":42,"status":"modified"},{"patch":"@@ -184,0 +184,2 @@\n+     * @param id         the value of the id attribute, or null if not defined\n+     * @param lang       the value of the lang attribute, or null if not defined\n@@ -187,1 +189,2 @@\n-    protected abstract Content snippetTagOutput(Element element, SnippetTree snippetTag, StyledText text);\n+    protected abstract Content snippetTagOutput(Element element, SnippetTree snippetTag, StyledText text,\n+                                                String id, String lang);\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/toolkit\/taglets\/TagletWriter.java","additions":4,"deletions":1,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -26,1 +26,1 @@\n- * @bug 8266666\n+ * @bug 8266666 8275788\n@@ -87,4 +87,2 @@\n-     * While the \"id\" and \"lang\" attributes are advertised in JEP 413, they are\n-     * currently unused by the implementation. The goal of this test is to make\n-     * sure that specifying these attributes causes no errors and exhibits no\n-     * unexpected behavior.\n+     * Make sure the \"id\" and \"lang\" attributes defined in JEP 413 are rendered\n+     * properly as recommended by the HTML5 specification.\n@@ -96,0 +94,11 @@\n+\n+        \/\/ A record of a snippet content and matching expected attribute values\n+        record SnippetAttributes(String content, String id, String lang) {\n+            public String idAttribute() {\n+                return id == null ? \"\" : \" id=\\\"\" + id + \"\\\"\";\n+            }\n+            public String langAttribute() {\n+                return lang == null ? \"\" : \" class=\\\"language-\" + lang + \"\\\"\";\n+            }\n+        }\n+\n@@ -97,25 +106,25 @@\n-                \"\"\"\n-                {@snippet id=\"foo\" :\n-                    Hello, Snippet!\n-                }\n-                \"\"\",\n-                \"\"\"\n-                {@snippet id=\"foo\":\n-                    Hello, Snippet!\n-                }\n-                \"\"\",\n-                \"\"\"\n-                {@snippet id='foo' :\n-                    Hello, Snippet!\n-                }\n-                \"\"\",\n-                \"\"\"\n-                {@snippet id='foo':\n-                    Hello, Snippet!\n-                }\n-                \"\"\",\n-                \"\"\"\n-                {@snippet id=foo :\n-                    Hello, Snippet!\n-                }\n-                \"\"\",\n+                new SnippetAttributes(\"\"\"\n+                    {@snippet id=\"foo1\" :\n+                        Hello, Snippet!\n+                    }\n+                    \"\"\", \"foo1\", null),\n+                new SnippetAttributes(\"\"\"\n+                    {@snippet id=\"foo2\":\n+                        Hello, Snippet!\n+                    }\n+                    \"\"\", \"foo2\", null),\n+                new SnippetAttributes(\"\"\"\n+                    {@snippet id='foo3' :\n+                        Hello, Snippet!\n+                    }\n+                    \"\"\", \"foo3\", null),\n+                new SnippetAttributes(\"\"\"\n+                    {@snippet id='foo4':\n+                        Hello, Snippet!\n+                    }\n+                    \"\"\", \"foo4\", null),\n+                new SnippetAttributes(\"\"\"\n+                    {@snippet id=foo5 :\n+                        Hello, Snippet!\n+                    }\n+                    \"\"\", \"foo5\", null),\n@@ -126,70 +135,71 @@\n-\/\/                \"\"\"\n-\/\/                {@snippet id=foo:\n-\/\/                    Hello, Snippet!\n-\/\/                }\n-\/\/                \"\"\",\n-                \"\"\"\n-                {@snippet id=\"\" :\n-                    Hello, Snippet!\n-                }\n-                \"\"\",\n-                \"\"\"\n-                {@snippet id=\"\":\n-                    Hello, Snippet!\n-                }\n-                \"\"\",\n-                \"\"\"\n-                {@snippet id='':\n-                    Hello, Snippet!\n-                }\n-                \"\"\",\n-                \"\"\"\n-                {@snippet id=:\n-                    Hello, Snippet!\n-                }\n-                \"\"\",\n-                \"\"\"\n-                {@snippet lang=\"java\" :\n-                    Hello, Snippet!\n-                }\n-                \"\"\",\n-                \"\"\"\n-                {@snippet lang=\"java\":\n-                    Hello, Snippet!\n-                }\n-                \"\"\",\n-                \"\"\"\n-                {@snippet lang='java' :\n-                    Hello, Snippet!\n-                }\n-                \"\"\",\n-                \"\"\"\n-                {@snippet lang='java':\n-                    Hello, Snippet!\n-                }\n-                \"\"\",\n-                \"\"\"\n-                {@snippet lang=java :\n-                    Hello, Snippet!\n-                }\n-                \"\"\",\n-                \"\"\"\n-                {@snippet lang=\"properties\" :\n-                    Hello, Snippet!\n-                }\n-                \"\"\",\n-                \"\"\"\n-                {@snippet lang=\"text\" :\n-                    Hello, Snippet!\n-                }\n-                \"\"\",\n-                \"\"\"\n-                {@snippet lang=\"\" :\n-                    Hello, Snippet!\n-                }\n-                \"\"\",\n-                \"\"\"\n-                {@snippet lang=\"foo\" id=\"bar\" :\n-                    Hello, Snippet!\n-                }\n-                \"\"\"\n+\/\/                new SnippetAttributes(\"\"\"\n+\/\/                    {@snippet id=foo6:\n+\/\/                        Hello, SnippetAttributes!\n+\/\/                    }\n+\/\/                    \"\"\", \"foo6\", null),\n+\n+                new SnippetAttributes(\"\"\"\n+                    {@snippet id=\"\" :\n+                        Hello, Snippet!\n+                    }\n+                    \"\"\", null, null),\n+                new SnippetAttributes(\"\"\"\n+                    {@snippet id=\"\":\n+                        Hello, Snippet!\n+                    }\n+                    \"\"\", null, null),\n+                new SnippetAttributes(\"\"\"\n+                    {@snippet id='':\n+                        Hello, Snippet!\n+                    }\n+                    \"\"\", null, null),\n+                new SnippetAttributes(\"\"\"\n+                    {@snippet id=:\n+                        Hello, Snippet!\n+                    }\n+                    \"\"\", null, null),\n+                new SnippetAttributes(\"\"\"\n+                    {@snippet lang=\"java\" :\n+                        Hello, Snippet!\n+                    }\n+                    \"\"\", null, \"java\"),\n+                new SnippetAttributes(\"\"\"\n+                    {@snippet lang=\"java\":\n+                        Hello, Snippet!\n+                    }\n+                    \"\"\", null, \"java\"),\n+                new SnippetAttributes(\"\"\"\n+                    {@snippet lang='java' :\n+                        Hello, Snippet!\n+                    }\n+                    \"\"\", null, \"java\"),\n+                new SnippetAttributes(\"\"\"\n+                    {@snippet lang='java':\n+                        Hello, Snippet!\n+                    }\n+                    \"\"\", null, \"java\"),\n+                new SnippetAttributes(\"\"\"\n+                    {@snippet lang=java :\n+                        Hello, Snippet!\n+                    }\n+                    \"\"\", null, \"java\"),\n+                new SnippetAttributes(\"\"\"\n+                    {@snippet lang=\"properties\" :\n+                        Hello, Snippet!\n+                    }\n+                    \"\"\", null, \"properties\"),\n+                new SnippetAttributes(\"\"\"\n+                    {@snippet lang=\"text\" :\n+                        Hello, Snippet!\n+                    }\n+                    \"\"\", null, \"text\"),\n+                new SnippetAttributes(\"\"\"\n+                    {@snippet lang=\"\" :\n+                        Hello, Snippet!\n+                    }\n+                    \"\"\", null, null),\n+                new SnippetAttributes(\"\"\"\n+                    {@snippet lang=\"foo\" id=\"bar\" :\n+                        Hello, Snippet!\n+                    }\n+                    \"\"\", \"bar\", \"foo\")\n@@ -202,1 +212,1 @@\n-                            .setComments(s));\n+                            .setComments(\"A method.\", s.content()));\n@@ -209,0 +219,1 @@\n+        checkLinks();\n@@ -210,0 +221,1 @@\n+            SnippetAttributes snippet = snippets.get(j);\n@@ -213,4 +225,4 @@\n-                        <div class=\"block\">\n-                        <pre class=\"snippet\">\n-                            Hello, Snippet!\n-                        <\/pre>\n+                        <div class=\"block\">A method.\n+                         \\s\n+                        <pre class=\"snippet\"%s><code%s>    Hello, Snippet!\n+                        <\/code><\/pre>\n@@ -218,1 +230,1 @@\n-                        \"\"\".formatted(j));\n+                        \"\"\".formatted(j, snippet.idAttribute(), snippet.langAttribute()));\n@@ -222,0 +234,81 @@\n+    \/*\n+     * Make sure the lang attribute is derived correctly from the snippet source file\n+     * for external snippets when it is not defined in the snippet. Defining the lang\n+     * attribute in the snippet should always override this mechanism.\n+     *\/\n+    @Test\n+    public void testExternalImplicitAttributes(Path base) throws IOException {\n+        Path srcDir = base.resolve(\"src\");\n+        Path outDir = base.resolve(\"out\");\n+\n+        ClassBuilder classBuilder = new ClassBuilder(tb, \"com.example.Cls\")\n+                .setModifiers(\"public\", \"class\");\n+        classBuilder.setComments(\"\"\"\n+                {@snippet class=\"Snippets\" region=\"code\" id=\"snippet1\"}\n+                {@snippet file=\"Snippets.java\" region=\"code\" id=\"snippet2\"}\n+                {@snippet class=\"Snippets\" region=\"code\" id=\"snippet3\" lang=\"none\"}\n+                {@snippet file=\"Snippets.java\" region=\"code\" id=\"snippet4\" lang=\"none\"}\n+                {@snippet class=\"Snippets\" region=\"code\" id=\"snippet5\" lang=\"\"}\n+                {@snippet file=\"Snippets.java\" region=\"code\" id=\"snippet6\" lang=\"\"}\n+                {@snippet file=\"user.properties\" id=\"snippet7\"}\n+                {@snippet file=\"user.properties\" id=\"snippet8\" lang=\"none\"}\n+                {@snippet file=\"user.properties\" id=\"snippet9\" lang=\"\"}\n+                \"\"\");\n+        addSnippetFile(srcDir, \"com.example\", \"Snippets.java\", \"\"\"\n+                public class Snippets {\n+                    public static void printMessage(String msg) {\n+                        \/\/ @start region=\"code\"\n+                        System.out.println(msg);\n+                        \/\/ @end\n+                    }\n+                }\n+                \"\"\");\n+        addSnippetFile(srcDir, \"com.example\", \"user.properties\", \"\"\"\n+                user=jane\n+                home=\/home\/jane\n+                \"\"\");\n+        classBuilder.write(srcDir);\n+        javadoc(\"-d\", outDir.toString(),\n+                \"-sourcepath\", srcDir.toString(),\n+                \"com.example\");\n+        checkExit(Exit.OK);\n+        checkLinks();\n+        checkOutput(\"com\/example\/Cls.html\", true, \"\"\"\n+                    <pre class=\"snippet\" id=\"snippet1\"><code class=\"language-java\">\n+                    System.out.println(msg);\n+                    <\/code><\/pre>\n+\n+                    <pre class=\"snippet\" id=\"snippet2\"><code class=\"language-java\">\n+                    System.out.println(msg);\n+                    <\/code><\/pre>\n+\n+                    <pre class=\"snippet\" id=\"snippet3\"><code class=\"language-none\">\n+                    System.out.println(msg);\n+                    <\/code><\/pre>\n+\n+                    <pre class=\"snippet\" id=\"snippet4\"><code class=\"language-none\">\n+                    System.out.println(msg);\n+                    <\/code><\/pre>\n+\n+                    <pre class=\"snippet\" id=\"snippet5\"><code>\n+                    System.out.println(msg);\n+                    <\/code><\/pre>\n+\n+                    <pre class=\"snippet\" id=\"snippet6\"><code>\n+                    System.out.println(msg);\n+                    <\/code><\/pre>\n+\n+                    <pre class=\"snippet\" id=\"snippet7\"><code class=\"language-properties\">user=jane\n+                    home=\/home\/jane\n+                    <\/code><\/pre>\n+\n+                    <pre class=\"snippet\" id=\"snippet8\"><code class=\"language-none\">user=jane\n+                    home=\/home\/jane\n+                    <\/code><\/pre>\n+\n+                    <pre class=\"snippet\" id=\"snippet9\"><code>user=jane\n+                    home=\/home\/jane\n+                    <\/code><\/pre>\n+                    \"\"\");\n+    }\n+\n@@ -855,2 +948,1 @@\n-                        <pre class=\"snippet\">\n-                        %s<\/pre>\n+                        <pre class=\"snippet\"><code>%s<\/code><\/pre>\n@@ -949,2 +1041,1 @@\n-                        <pre class=\"snippet\">\n-                        %s<\/pre>\n+                        <pre class=\"snippet\"><code>%s<\/code><\/pre>\n@@ -1508,2 +1599,1 @@\n-                        <pre class=\"snippet\">\n-                        %s<\/pre>\n+                        <pre class=\"snippet\"><code>%s<\/code><\/pre>\n@@ -1623,2 +1713,1 @@\n-                    <pre class=\"snippet\">\n-                    <\/pre>\n+                    <pre class=\"snippet\"><code><\/code><\/pre>\n@@ -1630,2 +1719,1 @@\n-                    <pre class=\"snippet\">\n-                    <\/pre>\n+                    <pre class=\"snippet\"><code><\/code><\/pre>\n@@ -1729,2 +1817,1 @@\n-                        <pre class=\"snippet\">\n-                        2<\/pre>\n+                        <pre class=\"snippet\"><code>2<\/code><\/pre>\n@@ -1811,2 +1898,1 @@\n-                        <pre class=\"snippet\">\n-                        %s<\/pre>\n+                        <pre class=\"snippet\"><code>%s<\/code><\/pre>\n@@ -2141,2 +2227,1 @@\n-                        <pre class=\"snippet\">\n-                        %s<\/pre>\n+                        <pre class=\"snippet\"><code>%s<\/code><\/pre>\n","filename":"test\/langtools\/jdk\/javadoc\/doclet\/testSnippetTag\/TestSnippetTag.java","additions":207,"deletions":122,"binary":false,"changes":329,"status":"modified"}]}