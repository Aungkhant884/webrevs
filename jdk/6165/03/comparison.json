{"files":[{"patch":"@@ -384,14 +384,12 @@\n-    protected Content snippetTagOutput(Element element, SnippetTree tag, StyledText content) {\n-        String copyText = resources.getText(\"doclet.Copy_snippet_to_clipboard\");\n-        String copiedText = resources.getText(\"doclet.Copied_snippet_to_clipboard\");\n-        HtmlTree copy = HtmlTree.DIV(HtmlStyle.snippetContainer,\n-                HtmlTree.A(\"#\", new HtmlTree(TagName.IMG)\n-                                .put(HtmlAttr.SRC, htmlWriter.pathToRoot.resolve(DocPaths.CLIPBOARD_SVG).getPath())\n-                                .put(HtmlAttr.ALT, copyText))\n-                        .addStyle(HtmlStyle.snippetCopy)\n-                        .put(HtmlAttr.ONCLICK, \"copySnippet(this)\")\n-                        .put(HtmlAttr.ARIA_LABEL, copyText)\n-                        .put(HtmlAttr.DATA_COPIED, copiedText));\n-        HtmlTree pre = new HtmlTree(TagName.PRE)\n-                .setStyle(HtmlStyle.snippet);\n-        pre.add(Text.of(utils.normalizeNewlines(\"\\n\")));\n+    protected Content snippetTagOutput(Element element, SnippetTree tag, StyledText content,\n+                                       String id, String lang) {\n+        HtmlTree pre = new HtmlTree(TagName.PRE).setStyle(HtmlStyle.snippet);\n+        if (id != null && !id.isBlank()) {\n+            pre.put(HtmlAttr.ID, id);\n+        }\n+        HtmlTree code = new HtmlTree(TagName.CODE)\n+                .add(HtmlTree.EMPTY); \/\/ Make sure the element is always rendered\n+        if (lang != null && !lang.isBlank()) {\n+            code.addStyle(\"language-\" + lang);\n+        }\n+\n@@ -401,1 +399,1 @@\n-                pre.add(text);\n+                code.add(text);\n@@ -446,1 +444,1 @@\n-                pre.add(c);\n+                code.add(c);\n@@ -449,1 +447,11 @@\n-        return copy.add(pre);\n+        String copyText = resources.getText(\"doclet.Copy_snippet_to_clipboard\");\n+        String copiedText = resources.getText(\"doclet.Copied_snippet_to_clipboard\");\n+        HtmlTree snippetContainer = HtmlTree.DIV(HtmlStyle.snippetContainer,\n+                HtmlTree.A(\"#\", new HtmlTree(TagName.IMG)\n+                                .put(HtmlAttr.SRC, htmlWriter.pathToRoot.resolve(DocPaths.CLIPBOARD_SVG).getPath())\n+                                .put(HtmlAttr.ALT, copyText))\n+                        .addStyle(HtmlStyle.snippetCopy)\n+                        .put(HtmlAttr.ONCLICK, \"copySnippet(this)\")\n+                        .put(HtmlAttr.ARIA_LABEL, copyText)\n+                        .put(HtmlAttr.DATA_COPIED, copiedText));\n+        return snippetContainer.add(pre.add(code));\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/TagletWriterImpl.java","additions":25,"deletions":17,"binary":false,"changes":42,"status":"modified"},{"patch":"@@ -264,1 +264,15 @@\n-        return writer.snippetTagOutput(holder, snippetTag, text);\n+        String lang = null;\n+        AttributeTree langAttr = attributes.get(\"lang\");\n+        if (langAttr != null && langAttr.getValueKind() != AttributeTree.ValueKind.EMPTY) {\n+            lang = stringOf(langAttr.getValue());\n+        } else if (containsClass) {\n+            lang = \"java\";\n+        } else if (containsFile) {\n+            lang = languageFromFileName(fileObject.getName());\n+        }\n+        AttributeTree idAttr = attributes.get(\"id\");\n+        String id = idAttr == null || idAttr.getValueKind() == AttributeTree.ValueKind.EMPTY\n+                        ? null\n+                        : stringOf(idAttr.getValue());\n+\n+        return writer.snippetTagOutput(holder, snippetTag, text, id, lang);\n@@ -301,0 +315,10 @@\n+    private String languageFromFileName(String fileName) {\n+        \/\/ TODO: find a way to extend\/customize the list of recognized file name extensions\n+        if (fileName.endsWith(\".java\")) {\n+            return \"java\";\n+        } else if (fileName.endsWith(\".properties\")) {\n+            return \"properties\";\n+        }\n+        return null;\n+    }\n+\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/toolkit\/taglets\/SnippetTaglet.java","additions":25,"deletions":1,"binary":false,"changes":26,"status":"modified"},{"patch":"@@ -184,0 +184,2 @@\n+     * @param id         the value of the id attribute, or null if not defined\n+     * @param lang       the value of the lang attribute, or null if not defined\n@@ -187,1 +189,2 @@\n-    protected abstract Content snippetTagOutput(Element element, SnippetTree snippetTag, StyledText text);\n+    protected abstract Content snippetTagOutput(Element element, SnippetTree snippetTag, StyledText text,\n+                                                String id, String lang);\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/toolkit\/taglets\/TagletWriter.java","additions":4,"deletions":1,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -26,1 +26,1 @@\n- * @bug 8266666\n+ * @bug 8266666 8275788\n@@ -87,4 +87,2 @@\n-     * While the \"id\" and \"lang\" attributes are advertised in JEP 413, they are\n-     * currently unused by the implementation. The goal of this test is to make\n-     * sure that specifying these attributes causes no errors and exhibits no\n-     * unexpected behavior.\n+     * Make sure the \"id\" and \"lang\" attributes defined in JEP 413 are rendered\n+     * properly as recommended by the HTML5 specification.\n@@ -96,0 +94,11 @@\n+\n+        \/\/ A record of a snippet content and matching expected attribute values\n+        record SnippetAttributes(String content, String id, String lang) {\n+            public String idAttribute() {\n+                return id == null ? \"\" : \" id=\\\"\" + id + \"\\\"\";\n+            }\n+            public String langAttribute() {\n+                return lang == null ? \"\" : \" class=\\\"language-\" + lang + \"\\\"\";\n+            }\n+        }\n+\n@@ -97,25 +106,25 @@\n-                \"\"\"\n-                {@snippet id=\"foo\" :\n-                    Hello, Snippet!\n-                }\n-                \"\"\",\n-                \"\"\"\n-                {@snippet id=\"foo\":\n-                    Hello, Snippet!\n-                }\n-                \"\"\",\n-                \"\"\"\n-                {@snippet id='foo' :\n-                    Hello, Snippet!\n-                }\n-                \"\"\",\n-                \"\"\"\n-                {@snippet id='foo':\n-                    Hello, Snippet!\n-                }\n-                \"\"\",\n-                \"\"\"\n-                {@snippet id=foo :\n-                    Hello, Snippet!\n-                }\n-                \"\"\",\n+                new SnippetAttributes(\"\"\"\n+                    {@snippet id=\"foo1\" :\n+                        Hello, Snippet!\n+                    }\n+                    \"\"\", \"foo1\", null),\n+                new SnippetAttributes(\"\"\"\n+                    {@snippet id=\"foo2\":\n+                        Hello, Snippet!\n+                    }\n+                    \"\"\", \"foo2\", null),\n+                new SnippetAttributes(\"\"\"\n+                    {@snippet id='foo3' :\n+                        Hello, Snippet!\n+                    }\n+                    \"\"\", \"foo3\", null),\n+                new SnippetAttributes(\"\"\"\n+                    {@snippet id='foo4':\n+                        Hello, Snippet!\n+                    }\n+                    \"\"\", \"foo4\", null),\n+                new SnippetAttributes(\"\"\"\n+                    {@snippet id=foo5 :\n+                        Hello, Snippet!\n+                    }\n+                    \"\"\", \"foo5\", null),\n@@ -126,70 +135,71 @@\n-\/\/                \"\"\"\n-\/\/                {@snippet id=foo:\n-\/\/                    Hello, Snippet!\n-\/\/                }\n-\/\/                \"\"\",\n-                \"\"\"\n-                {@snippet id=\"\" :\n-                    Hello, Snippet!\n-                }\n-                \"\"\",\n-                \"\"\"\n-                {@snippet id=\"\":\n-                    Hello, Snippet!\n-                }\n-                \"\"\",\n-                \"\"\"\n-                {@snippet id='':\n-                    Hello, Snippet!\n-                }\n-                \"\"\",\n-                \"\"\"\n-                {@snippet id=:\n-                    Hello, Snippet!\n-                }\n-                \"\"\",\n-                \"\"\"\n-                {@snippet lang=\"java\" :\n-                    Hello, Snippet!\n-                }\n-                \"\"\",\n-                \"\"\"\n-                {@snippet lang=\"java\":\n-                    Hello, Snippet!\n-                }\n-                \"\"\",\n-                \"\"\"\n-                {@snippet lang='java' :\n-                    Hello, Snippet!\n-                }\n-                \"\"\",\n-                \"\"\"\n-                {@snippet lang='java':\n-                    Hello, Snippet!\n-                }\n-                \"\"\",\n-                \"\"\"\n-                {@snippet lang=java :\n-                    Hello, Snippet!\n-                }\n-                \"\"\",\n-                \"\"\"\n-                {@snippet lang=\"properties\" :\n-                    Hello, Snippet!\n-                }\n-                \"\"\",\n-                \"\"\"\n-                {@snippet lang=\"text\" :\n-                    Hello, Snippet!\n-                }\n-                \"\"\",\n-                \"\"\"\n-                {@snippet lang=\"\" :\n-                    Hello, Snippet!\n-                }\n-                \"\"\",\n-                \"\"\"\n-                {@snippet lang=\"foo\" id=\"bar\" :\n-                    Hello, Snippet!\n-                }\n-                \"\"\"\n+\/\/                new SnippetAttributes(\"\"\"\n+\/\/                    {@snippet id=foo6:\n+\/\/                        Hello, Snippet!\n+\/\/                    }\n+\/\/                    \"\"\", \"foo6\", null),\n+\n+                new SnippetAttributes(\"\"\"\n+                    {@snippet id=\"\" :\n+                        Hello, Snippet!\n+                    }\n+                    \"\"\", null, null),\n+                new SnippetAttributes(\"\"\"\n+                    {@snippet id=\"\":\n+                        Hello, Snippet!\n+                    }\n+                    \"\"\", null, null),\n+                new SnippetAttributes(\"\"\"\n+                    {@snippet id='':\n+                        Hello, Snippet!\n+                    }\n+                    \"\"\", null, null),\n+                new SnippetAttributes(\"\"\"\n+                    {@snippet id=:\n+                        Hello, Snippet!\n+                    }\n+                    \"\"\", null, null),\n+                new SnippetAttributes(\"\"\"\n+                    {@snippet lang=\"java\" :\n+                        Hello, Snippet!\n+                    }\n+                    \"\"\", null, \"java\"),\n+                new SnippetAttributes(\"\"\"\n+                    {@snippet lang=\"java\":\n+                        Hello, Snippet!\n+                    }\n+                    \"\"\", null, \"java\"),\n+                new SnippetAttributes(\"\"\"\n+                    {@snippet lang='java' :\n+                        Hello, Snippet!\n+                    }\n+                    \"\"\", null, \"java\"),\n+                new SnippetAttributes(\"\"\"\n+                    {@snippet lang='java':\n+                        Hello, Snippet!\n+                    }\n+                    \"\"\", null, \"java\"),\n+                new SnippetAttributes(\"\"\"\n+                    {@snippet lang=java :\n+                        Hello, Snippet!\n+                    }\n+                    \"\"\", null, \"java\"),\n+                new SnippetAttributes(\"\"\"\n+                    {@snippet lang=\"properties\" :\n+                        Hello, Snippet!\n+                    }\n+                    \"\"\", null, \"properties\"),\n+                new SnippetAttributes(\"\"\"\n+                    {@snippet lang=\"text\" :\n+                        Hello, Snippet!\n+                    }\n+                    \"\"\", null, \"text\"),\n+                new SnippetAttributes(\"\"\"\n+                    {@snippet lang=\"\" :\n+                        Hello, Snippet!\n+                    }\n+                    \"\"\", null, null),\n+                new SnippetAttributes(\"\"\"\n+                    {@snippet lang=\"foo\" id=\"bar\" :\n+                        Hello, Snippet!\n+                    }\n+                    \"\"\", \"bar\", \"foo\")\n@@ -202,1 +212,1 @@\n-                            .setComments(s));\n+                            .setComments(\"A method.\", s.content()));\n@@ -209,0 +219,1 @@\n+        checkLinks();\n@@ -210,0 +221,1 @@\n+            SnippetAttributes snippet = snippets.get(j);\n@@ -213,1 +225,2 @@\n-                        <div class=\"block\">\n+                        <div class=\"block\">A method.\n+                         \\s\n@@ -217,3 +230,2 @@\n-                        <pre class=\"snippet\">\n-                            Hello, Snippet!\n-                        <\/pre>\n+                        <pre class=\"snippet\"%s><code%s>    Hello, Snippet!\n+                        <\/code><\/pre>\n@@ -221,1 +233,1 @@\n-                        \"\"\".formatted(j));\n+                        \"\"\".formatted(j, snippet.idAttribute(), snippet.langAttribute()));\n@@ -225,0 +237,81 @@\n+    \/*\n+     * Make sure the lang attribute is derived correctly from the snippet source file\n+     * for external snippets when it is not defined in the snippet. Defining the lang\n+     * attribute in the snippet should always override this mechanism.\n+     *\/\n+    @Test\n+    public void testExternalImplicitAttributes(Path base) throws IOException {\n+        Path srcDir = base.resolve(\"src\");\n+        Path outDir = base.resolve(\"out\");\n+\n+        ClassBuilder classBuilder = new ClassBuilder(tb, \"com.example.Cls\")\n+                .setModifiers(\"public\", \"class\");\n+        classBuilder.setComments(\"\"\"\n+                {@snippet class=\"Snippets\" region=\"code\" id=\"snippet1\"}\n+                {@snippet file=\"Snippets.java\" region=\"code\" id=\"snippet2\"}\n+                {@snippet class=\"Snippets\" region=\"code\" id=\"snippet3\" lang=\"none\"}\n+                {@snippet file=\"Snippets.java\" region=\"code\" id=\"snippet4\" lang=\"none\"}\n+                {@snippet class=\"Snippets\" region=\"code\" id=\"snippet5\" lang=\"\"}\n+                {@snippet file=\"Snippets.java\" region=\"code\" id=\"snippet6\" lang=\"\"}\n+                {@snippet file=\"user.properties\" id=\"snippet7\"}\n+                {@snippet file=\"user.properties\" id=\"snippet8\" lang=\"none\"}\n+                {@snippet file=\"user.properties\" id=\"snippet9\" lang=\"\"}\n+                \"\"\");\n+        addSnippetFile(srcDir, \"com.example\", \"Snippets.java\", \"\"\"\n+                public class Snippets {\n+                    public static void printMessage(String msg) {\n+                        \/\/ @start region=\"code\"\n+                        System.out.println(msg);\n+                        \/\/ @end\n+                    }\n+                }\n+                \"\"\");\n+        addSnippetFile(srcDir, \"com.example\", \"user.properties\", \"\"\"\n+                user=jane\n+                home=\/home\/jane\n+                \"\"\");\n+        classBuilder.write(srcDir);\n+        javadoc(\"-d\", outDir.toString(),\n+                \"-sourcepath\", srcDir.toString(),\n+                \"com.example\");\n+        checkExit(Exit.OK);\n+        checkLinks();\n+        checkOutput(\"com\/example\/Cls.html\", true,\n+                \"\"\"\n+                    <pre class=\"snippet\" id=\"snippet1\"><code class=\"language-java\">\n+                    System.out.println(msg);\n+                    <\/code><\/pre>\"\"\",\n+                \"\"\"\n+                    <pre class=\"snippet\" id=\"snippet2\"><code class=\"language-java\">\n+                    System.out.println(msg);\n+                    <\/code><\/pre>\"\"\",\n+                \"\"\"\n+                    <pre class=\"snippet\" id=\"snippet3\"><code class=\"language-none\">\n+                    System.out.println(msg);\n+                    <\/code><\/pre>\"\"\",\n+                \"\"\"\n+                    <pre class=\"snippet\" id=\"snippet4\"><code class=\"language-none\">\n+                    System.out.println(msg);\n+                    <\/code><\/pre>\"\"\",\n+                \"\"\"\n+                    <pre class=\"snippet\" id=\"snippet5\"><code>\n+                    System.out.println(msg);\n+                    <\/code><\/pre>\"\"\",\n+                \"\"\"\n+                    <pre class=\"snippet\" id=\"snippet6\"><code>\n+                    System.out.println(msg);\n+                    <\/code><\/pre>\"\"\",\n+                \"\"\"\n+                    <pre class=\"snippet\" id=\"snippet7\"><code class=\"language-properties\">user=jane\n+                    home=\/home\/jane\n+                    <\/code><\/pre>\"\"\",\n+                \"\"\"\n+                    <pre class=\"snippet\" id=\"snippet8\"><code class=\"language-none\">user=jane\n+                    home=\/home\/jane\n+                    <\/code><\/pre>\"\"\",\n+                \"\"\"\n+                    <pre class=\"snippet\" id=\"snippet9\"><code>user=jane\n+                    home=\/home\/jane\n+                    <\/code><\/pre>\"\"\");\n+    }\n+\n@@ -861,2 +954,1 @@\n-                        <pre class=\"snippet\">\n-                        %s<\/pre>\n+                        <pre class=\"snippet\"><code>%s<\/code><\/pre>\n@@ -958,2 +1050,1 @@\n-                        <pre class=\"snippet\">\n-                        %s<\/pre>\n+                        <pre class=\"snippet\"><code>%s<\/code><\/pre>\n@@ -1520,2 +1611,1 @@\n-                        <pre class=\"snippet\">\n-                        %s<\/pre>\n+                        <pre class=\"snippet\"><code>%s<\/code><\/pre>\n@@ -1638,2 +1728,1 @@\n-                    <pre class=\"snippet\">\n-                    <\/pre>\n+                    <pre class=\"snippet\"><code><\/code><\/pre>\n@@ -1648,2 +1737,1 @@\n-                    <pre class=\"snippet\">\n-                    <\/pre>\n+                    <pre class=\"snippet\"><code><\/code><\/pre>\n@@ -1750,2 +1838,1 @@\n-                        <pre class=\"snippet\">\n-                        2<\/pre>\n+                        <pre class=\"snippet\"><code>2<\/code><\/pre>\n@@ -1835,2 +1922,1 @@\n-                        <pre class=\"snippet\">\n-                        %s<\/pre>\n+                        <pre class=\"snippet\"><code>%s<\/code><\/pre>\n@@ -2168,2 +2254,1 @@\n-                        <pre class=\"snippet\">\n-                        %s<\/pre>\n+                        <pre class=\"snippet\"><code>%s<\/code><\/pre>\n","filename":"test\/langtools\/jdk\/javadoc\/doclet\/testSnippetTag\/TestSnippetTag.java","additions":207,"deletions":122,"binary":false,"changes":329,"status":"modified"}]}