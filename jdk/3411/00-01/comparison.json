{"files":[{"patch":"@@ -31,0 +31,1 @@\n+#include \"ci\/ciUtilities.inline.hpp\"\n@@ -568,0 +569,26 @@\n+static bool is_klass_initialized(Symbol* klass_name) {\n+  VM_ENTRY_MARK;\n+  InstanceKlass* ik = SystemDictionary::find_instance_klass(klass_name, Handle(), Handle());\n+  return ik != nullptr && ik->is_initialized();\n+}\n+\n+static bool is_box_cache_valid(CallNode* call) {\n+  ciInstanceKlass* klass = call->as_CallStaticJava()->method()->holder();\n+  BasicType box_type = klass->box_klass_type();\n+\n+  if (box_type != T_OBJECT) {\n+    switch(box_type) {\n+      case T_INT:     return is_klass_initialized(java_lang_Integer_IntegerCache::symbol());\n+      case T_CHAR:    return is_klass_initialized(java_lang_Character_CharacterCache::symbol());\n+      case T_SHORT:   return is_klass_initialized(java_lang_Short_ShortCache::symbol());\n+      case T_BYTE:    return is_klass_initialized(java_lang_Byte_ByteCache::symbol());\n+      case T_LONG:    return is_klass_initialized(java_lang_Long_LongCache::symbol());\n+      case T_BOOLEAN:\n+      case T_FLOAT:\n+      case T_DOUBLE:  return true;\n+      default:;\n+    }\n+  }\n+  return false;\n+}\n+\n@@ -663,1 +690,1 @@\n-        if (!has_non_debug_usages(callprojs.resproj)) {\n+        if (!has_non_debug_usages(callprojs.resproj) && is_box_cache_valid(call)) {\n","filename":"src\/hotspot\/share\/opto\/callGenerator.cpp","additions":28,"deletions":1,"binary":false,"changes":29,"status":"modified"},{"patch":"@@ -905,1 +905,1 @@\n-  static InstanceKlass* find_cache_klass(Symbol* klass_name, TRAPS) {\n+  static InstanceKlass* find_cache_klass(Symbol* klass_name) {\n@@ -910,1 +910,1 @@\n-    if (!ik->is_initialized()) ik->initialize(CHECK_NULL);\n+    guarantee(ik->is_initialized(), \"%s must be initialized\", klass_name_str);\n@@ -923,1 +923,1 @@\n-    InstanceKlass* ik = BoxCacheBase<CacheType>::find_cache_klass(CacheType::symbol(), thread);\n+    InstanceKlass* ik = BoxCacheBase<CacheType>::find_cache_klass(CacheType::symbol());\n@@ -979,1 +979,1 @@\n-    InstanceKlass* ik = find_cache_klass(java_lang_Boolean::symbol(), thread);\n+    InstanceKlass* ik = find_cache_klass(java_lang_Boolean::symbol());\n","filename":"src\/hotspot\/share\/runtime\/deoptimization.cpp","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"}]}