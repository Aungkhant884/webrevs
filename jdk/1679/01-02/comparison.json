{"files":[{"patch":"@@ -65,2 +65,0 @@\n-+ (AWTView *) awtView:(JNIEnv *)env ofAccessible:(jobject)jaccessible;\n-\n","filename":"src\/java.desktop\/macosx\/native\/libawt_lwawt\/awt\/AWTView.h","additions":0,"deletions":2,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -603,10 +603,0 @@\n-+ (AWTView *) awtView:(JNIEnv*)env ofAccessible:(jobject)jaccessible\n-{\n-    static JNF_STATIC_MEMBER_CACHE(jm_getAWTView, sjc_CAccessibility, \"getAWTView\", \"(Ljavax\/accessibility\/Accessible;)J\");\n-\n-    jlong jptr = JNFCallStaticLongMethod(env, jm_getAWTView, jaccessible);\n-    if (jptr == 0) return nil;\n-\n-    return (AWTView *)jlong_to_ptr(jptr);\n-}\n-\n","filename":"src\/java.desktop\/macosx\/native\/libawt_lwawt\/awt\/AWTView.m","additions":0,"deletions":10,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -30,0 +30,1 @@\n+#import \"JNIUtilities.h\"\n@@ -60,2 +61,0 @@\n-    static JNF_STATIC_MEMBER_CACHE(jm_getAccessibleActionDescription, sjc_CAccessibility, \"getAccessibleActionDescription\", \"(Ljavax\/accessibility\/AccessibleAction;ILjava\/awt\/Component;)Ljava\/lang\/String;\");\n-\n@@ -63,0 +62,3 @@\n+    DECLARE_CLASS_RETURN(sjc_CAccessibility, \"sun\/lwawt\/macosx\/CAccessibility\", nil);\n+    DECLARE_METHOD_RETURN(jm_getAccessibleActionDescription, sjc_CAccessibility, \"getAccessibleActionDescription\",\n+                          \"(Ljavax\/accessibility\/AccessibleAction;ILjava\/awt\/Component;)Ljava\/lang\/String;\", nil);\n@@ -69,1 +71,1 @@\n-    jstring jstr = JNFCallStaticObjectMethod( env,\n+    jstring jstr = (*env)->CallStaticObjectMethod(env, sjc_CAccessibility,\n@@ -74,0 +76,1 @@\n+    CHECK_EXCEPTION();\n@@ -84,2 +87,0 @@\n-    static JNF_STATIC_MEMBER_CACHE(jm_doAccessibleAction, sjc_CAccessibility, \"doAccessibleAction\", \"(Ljavax\/accessibility\/AccessibleAction;ILjava\/awt\/Component;)V\");\n-\n@@ -87,0 +88,3 @@\n+    DECLARE_CLASS(sjc_CAccessibility, \"sun\/lwawt\/macosx\/CAccessibility\");\n+    DECLARE_METHOD(jm_doAccessibleAction, sjc_CAccessibility, \"doAccessibleAction\",\n+                    \"(Ljavax\/accessibility\/AccessibleAction;ILjava\/awt\/Component;)V\");\n@@ -88,1 +92,3 @@\n-    JNFCallStaticVoidMethod(env, jm_doAccessibleAction, fAccessibleAction, fIndex, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoopMode)\n+    (*env)->CallStaticVoidMethod(env, sjc_CAccessibility, jm_doAccessibleAction,\n+             fAccessibleAction, fIndex, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoopMode)\n+    CHECK_EXCEPTION();\n","filename":"src\/java.desktop\/macosx\/native\/libawt_lwawt\/awt\/JavaAccessibilityAction.m","additions":12,"deletions":6,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -33,12 +33,4 @@\n-extern JNFClassInfo sjc_CAccessibility;\n-extern JNFClassInfo sjc_AccessibleComponent;\n-extern JNFClassInfo sjc_AccessibleContext;\n-extern JNFClassInfo sjc_Accessible;\n-extern JNFClassInfo sjc_AccessibleRole;\n-extern JNFClassInfo sjc_Point;\n-extern JNFClassInfo sjc_AccessibleText;\n-\n-extern JNFMemberInfo *sjm_getAccessibleRole;\n-extern JNFMemberInfo *sjf_key;\n-extern JNFMemberInfo *sjf_X;\n-extern JNFMemberInfo *sjf_Y;\n+#define GET_CACCESSIBILITY_CLASS() \\\n+    GET_CLASS(sjc_CAccessibility, \"sun\/lwawt\/macosx\/CAccessibility\");\n+#define GET_CACCESSIBILITY_CLASS_RETURN(ret) \\\n+    GET_CLASS_RETURN(sjc_CAccessibility, \"sun\/lwawt\/macosx\/CAccessibility\", ret);\n","filename":"src\/java.desktop\/macosx\/native\/libawt_lwawt\/awt\/JavaAccessibilityUtilities.h","additions":4,"deletions":12,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -27,0 +27,1 @@\n+#import \"JNIUtilities.h\"\n@@ -46,1 +47,3 @@\n-static JNF_CLASS_CACHE(sjc_AccessibleState, \"javax\/accessibility\/AccessibleState\");\n+static jclass sjc_AccessibleState = NULL;\n+#define GET_ACCESSIBLESTATE_CLASS_RETURN(ret) \\\n+     GET_CLASS_RETURN(sjc_AccessibleState, \"javax\/accessibility\/AccessibleState\", ret);\n@@ -48,12 +51,1 @@\n-\/\/ Duplicate\n-JNF_CLASS_CACHE(sjc_CAccessibility, \"sun\/lwawt\/macosx\/CAccessibility\");\n-JNF_CLASS_CACHE(sjc_AccessibleComponent, \"javax\/accessibility\/AccessibleComponent\");\n-JNF_CLASS_CACHE(sjc_AccessibleContext, \"javax\/accessibility\/AccessibleContext\");\n-JNF_CLASS_CACHE(sjc_Accessible, \"javax\/accessibility\/Accessible\");\n-JNF_CLASS_CACHE(sjc_AccessibleRole, \"javax\/accessibility\/AccessibleRole\");\n-JNF_CLASS_CACHE(sjc_Point, \"java\/awt\/Point\");\n-JNF_CLASS_CACHE(sjc_AccessibleText, \"javax\/accessibility\/AccessibleText\");\n-\n-JNF_MEMBER_CACHE(sjf_key, sjc_AccessibleRole, \"key\", \"Ljava\/lang\/String;\");\n-JNF_MEMBER_CACHE(sjf_X, sjc_Point, \"x\", \"I\");\n-JNF_MEMBER_CACHE(sjf_Y, sjc_Point, \"y\", \"I\");\n+static jclass sjc_CAccessibility = NULL;\n@@ -63,4 +55,5 @@\n-    static JNF_CLASS_CACHE(jc_Dimension, \"java\/awt\/Dimension\");\n-    static JNF_MEMBER_CACHE(jf_width, jc_Dimension, \"width\", \"I\");\n-    static JNF_MEMBER_CACHE(jf_height, jc_Dimension, \"height\", \"I\");\n-    static JNF_STATIC_MEMBER_CACHE(jm_getSize, sjc_CAccessibility, \"getSize\", \"(Ljavax\/accessibility\/AccessibleComponent;Ljava\/awt\/Component;)Ljava\/awt\/Dimension;\");\n+    DECLARE_CLASS_RETURN(jc_Dimension, \"java\/awt\/Dimension\", NSZeroSize);\n+    DECLARE_FIELD_RETURN(jf_width, jc_Dimension, \"width\", \"I\", NSZeroSize);\n+    DECLARE_FIELD_RETURN(jf_height, jc_Dimension, \"height\", \"I\", NSZeroSize);\n+    DECLARE_METHOD_RETURN(jm_getSize, sjc_CAccessibility, \"getSize\",\n+           \"(Ljavax\/accessibility\/AccessibleComponent;Ljava\/awt\/Component;)Ljava\/awt\/Dimension;\", NSZeroSize);\n@@ -68,1 +61,2 @@\n-    jobject dimension = JNFCallStaticObjectMethod(env, jm_getSize, axComponent, component); \/\/ AWT_THREADING Safe (AWTRunLoopMode)\n+    jobject dimension = (*env)->CallStaticObjectMethod(env, jc_Dimension, jm_getSize, axComponent, component); \/\/ AWT_THREADING Safe (AWTRunLoopMode)\n+    CHECK_EXCEPTION();\n@@ -71,1 +65,1 @@\n-    return NSMakeSize(JNFGetIntField(env, dimension, jf_width), JNFGetIntField(env, dimension, jf_height));\n+    return NSMakeSize((*env)->GetIntField(env, dimension, jf_width), (*env)->GetIntField(env, dimension, jf_height));\n@@ -76,2 +70,6 @@\n-    static JNF_STATIC_MEMBER_CACHE(sjm_getAccessibleRole, sjc_CAccessibility, \"getAccessibleRole\", \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)Ljava\/lang\/String;\");\n-    jobject axRole = JNFCallStaticObjectMethod(env, sjm_getAccessibleRole, axComponent, component); \/\/ AWT_THREADING Safe (AWTRunLoopMode)\n+    GET_CACCESSIBILITY_CLASS_RETURN(nil);\n+    DECLARE_METHOD_RETURN(sjm_getAccessibleRole, sjc_CAccessibility, \"getAccessibleRole\",\n+                           \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)Ljava\/lang\/String;\", nil);\n+    jobject axRole = (*env)->CallStaticObjectMethod(env, sjc_CAccessibility, sjm_getAccessibleRole,\n+                      axComponent, component); \/\/ AWT_THREADING Safe (AWTRunLoopMode)\n+    CHECK_EXCEPTION();\n@@ -87,2 +85,7 @@\n-    static JNF_STATIC_MEMBER_CACHE(jm_getAccessibleSelection, sjc_CAccessibility, \"getAccessibleSelection\", \"(Ljavax\/accessibility\/AccessibleContext;Ljava\/awt\/Component;)Ljavax\/accessibility\/AccessibleSelection;\");\n-    return JNFCallStaticObjectMethod(env, jm_getAccessibleSelection, axContext, component); \/\/ AWT_THREADING Safe (AWTRunLoopMode)\n+    GET_CACCESSIBILITY_CLASS_RETURN(nil);\n+    DECLARE_METHOD_RETURN(jm_getAccessibleSelection, sjc_CAccessibility, \"getAccessibleSelection\",\n+            \"(Ljavax\/accessibility\/AccessibleContext;Ljava\/awt\/Component;)Ljavax\/accessibility\/AccessibleSelection;\", nil);\n+    jobject o = (*env)->CallStaticObjectMethod(env, sjc_CAccessibility, jm_getAccessibleSelection,\n+                      axContext, component); \/\/ AWT_THREADING Safe (AWTRunLoopMode)\n+    CHECK_EXCEPTION();\n+    return o;\n@@ -93,2 +96,6 @@\n-    static JNF_STATIC_MEMBER_CACHE(jm_ax_getAccessibleSelection, sjc_CAccessibility, \"ax_getAccessibleSelection\", \"(Ljavax\/accessibility\/AccessibleContext;ILjava\/awt\/Component;)Ljavax\/accessibility\/Accessible;\");\n-    return JNFCallStaticObjectMethod(env, jm_ax_getAccessibleSelection, axContext, index, component); \/\/ AWT_THREADING Safe (AWTRunLoopMode)\n+    GET_CACCESSIBILITY_CLASS_RETURN(nil);\n+    DECLARE_METHOD_RETURN(jm_ax_getAccessibleSelection, sjc_CAccessibility, \"ax_getAccessibleSelection\",\n+                  \"(Ljavax\/accessibility\/AccessibleContext;ILjava\/awt\/Component;)Ljavax\/accessibility\/Accessible;\", nil);\n+    return (*env)->CallStaticObjectMethod(env, sjc_CAccessibility, jm_ax_getAccessibleSelection,\n+                    axContext, index, component); \/\/ AWT_THREADING Safe (AWTRunLoopMode)\n+    CHECK_EXCEPTION();\n@@ -99,2 +106,6 @@\n-    static JNF_STATIC_MEMBER_CACHE(jm_addAccessibleSelection, sjc_CAccessibility, \"addAccessibleSelection\", \"(Ljavax\/accessibility\/AccessibleContext;ILjava\/awt\/Component;)V\");\n-    JNFCallStaticVoidMethod(env, jm_addAccessibleSelection, axContext, index, component); \/\/ AWT_THREADING Safe (AWTRunLoopMode)\n+    GET_CACCESSIBILITY_CLASS();\n+    DECLARE_METHOD(jm_addAccessibleSelection, sjc_CAccessibility, \"addAccessibleSelection\",\n+                   \"(Ljavax\/accessibility\/AccessibleContext;ILjava\/awt\/Component;)V\");\n+    (*env)->CallStaticVoidMethod(env, sjc_CAccessibility, jm_addAccessibleSelection,\n+                    axContext, index, component); \/\/ AWT_THREADING Safe (AWTRunLoopMode)\n+    CHECK_EXCEPTION();\n@@ -105,2 +116,7 @@\n-    static JNF_STATIC_MEMBER_CACHE(jm_getAccessibleContext, sjc_CAccessibility, \"getAccessibleContext\", \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)Ljavax\/accessibility\/AccessibleContext;\");\n-    return JNFCallStaticObjectMethod(env, jm_getAccessibleContext, accessible, component); \/\/ AWT_THREADING Safe (AWTRunLoopMode)\n+    GET_CACCESSIBILITY_CLASS_RETURN(nil);\n+    DECLARE_METHOD_RETURN(jm_getAccessibleContext, sjc_CAccessibility, \"getAccessibleContext\",\n+               \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)Ljavax\/accessibility\/AccessibleContext;\", nil);\n+    jobject o = (*env)->CallStaticObjectMethod(env, sjc_CAccessibility, jm_getAccessibleContext,\n+                    accessible, component); \/\/ AWT_THREADING Safe (AWTRunLoopMode)\n+    CHECK_EXCEPTION();\n+    return o;\n@@ -111,2 +127,7 @@\n-    static JNF_STATIC_MEMBER_CACHE(jm_isAccessibleChildSelected, sjc_CAccessibility, \"isAccessibleChildSelected\", \"(Ljavax\/accessibility\/Accessible;ILjava\/awt\/Component;)Z\");\n-    return JNFCallStaticBooleanMethod(env, jm_isAccessibleChildSelected, accessible, index, component); \/\/ AWT_THREADING Safe (AWTRunLoopMode)\n+    GET_CACCESSIBILITY_CLASS_RETURN(NO);\n+    DECLARE_METHOD_RETURN(jm_isAccessibleChildSelected, sjc_CAccessibility, \"isAccessibleChildSelected\",\n+                \"(Ljavax\/accessibility\/Accessible;ILjava\/awt\/Component;)Z\", NO);\n+    jboolean b = (*env)->CallStaticBooleanMethod(env, sjc_CAccessibility, jm_isAccessibleChildSelected,\n+                    accessible, index, component); \/\/ AWT_THREADING Safe (AWTRunLoopMode)\n+    CHECK_EXCEPTION();\n+    return b;\n@@ -117,2 +138,7 @@\n-    static JNF_STATIC_MEMBER_CACHE(jm_getAccessibleStateSet, sjc_CAccessibility, \"getAccessibleStateSet\", \"(Ljavax\/accessibility\/AccessibleContext;Ljava\/awt\/Component;)Ljavax\/accessibility\/AccessibleStateSet;\");\n-    return JNFCallStaticObjectMethod(env, jm_getAccessibleStateSet, axContext, component); \/\/ AWT_THREADING Safe (AWTRunLoopMode)\n+    GET_CACCESSIBILITY_CLASS_RETURN(nil);\n+    DECLARE_METHOD_RETURN(jm_getAccessibleStateSet, sjc_CAccessibility, \"getAccessibleStateSet\",\n+               \"(Ljavax\/accessibility\/AccessibleContext;Ljava\/awt\/Component;)Ljavax\/accessibility\/AccessibleStateSet;\", nil);\n+    jobject o = (*env)->CallStaticObjectMethod(env, sjc_CAccessibility, jm_getAccessibleStateSet,\n+                    axContext, component); \/\/ AWT_THREADING Safe (AWTRunLoopMode)\n+    CHECK_EXCEPTION();\n+    return o;\n@@ -123,2 +149,6 @@\n-    static JNF_STATIC_MEMBER_CACHE(jm_contains, sjc_CAccessibility, \"contains\", \"(Ljavax\/accessibility\/AccessibleContext;Ljavax\/accessibility\/AccessibleState;Ljava\/awt\/Component;)Z\");\n-    return JNFCallStaticBooleanMethod(env, jm_contains, axContext, axState, component); \/\/ AWT_THREADING Safe (AWTRunLoopMode)\n+    GET_CACCESSIBILITY_CLASS_RETURN(NO);\n+    DECLARE_METHOD_RETURN(jm_contains, sjc_CAccessibility, \"contains\",\n+               \"(Ljavax\/accessibility\/AccessibleContext;Ljavax\/accessibility\/AccessibleState;Ljava\/awt\/Component;)Z\", NO);\n+    jboolean b = (*env)->CallStaticBooleanMethod(env, jm_contains, axContext, axState, component); \/\/ AWT_THREADING Safe (AWTRunLoopMode)\n+    CHECK_EXCEPTION();\n+    return b;\n@@ -129,2 +159,4 @@\n-    static JNF_STATIC_MEMBER_CACHE(jm_VERTICAL, sjc_AccessibleState, \"VERTICAL\", \"Ljavax\/accessibility\/AccessibleState;\");\n-    jobject axVertState = JNFGetStaticObjectField(env, jm_VERTICAL);\n+    GET_ACCESSIBLESTATE_CLASS_RETURN(NO);\n+    DECLARE_STATIC_FIELD_RETURN(jm_VERTICAL, sjc_AccessibleState, \"VERTICAL\", \"Ljavax\/accessibility\/AccessibleState;\", NO);\n+    jobject axVertState = (*env)->GetStaticObjectField(env, sjc_AccessibleState, jm_VERTICAL);\n+    CHECK_EXCEPTION_NULL_RETURN(axVertState, NO);\n@@ -138,2 +170,4 @@\n-    static JNF_STATIC_MEMBER_CACHE(jm_HORIZONTAL, sjc_AccessibleState, \"HORIZONTAL\", \"Ljavax\/accessibility\/AccessibleState;\");\n-    jobject axHorizState = JNFGetStaticObjectField(env, jm_HORIZONTAL);\n+    GET_ACCESSIBLESTATE_CLASS_RETURN(NO);\n+    DECLARE_STATIC_FIELD_RETURN(jm_HORIZONTAL, sjc_AccessibleState, \"HORIZONTAL\", \"Ljavax\/accessibility\/AccessibleState;\", NO);\n+    jobject axHorizState = (*env)->GetStaticObjectField(env, sjc_AccessibleState, jm_HORIZONTAL);\n+    CHECK_EXCEPTION_NULL_RETURN(axHorizState, NO);\n@@ -147,2 +181,4 @@\n-    static JNF_STATIC_MEMBER_CACHE(jm_SHOWING, sjc_AccessibleState, \"SHOWING\", \"Ljavax\/accessibility\/AccessibleState;\");\n-    jobject axVisibleState = JNFGetStaticObjectField(env, jm_SHOWING);\n+    GET_ACCESSIBLESTATE_CLASS_RETURN(NO);\n+    DECLARE_STATIC_FIELD_RETURN(jm_SHOWING, sjc_AccessibleState, \"SHOWING\", \"Ljavax\/accessibility\/AccessibleState;\", NO);\n+    jobject axVisibleState = (*env)->GetStaticObjectField(env, sjc_AccessibleState, jm_SHOWING);\n+    CHECK_EXCEPTION_NULL_RETURN(axVisibleState, NO);\n@@ -156,1 +192,2 @@\n-    static JNF_STATIC_MEMBER_CACHE( jm_SELECTABLE,\n+    GET_ACCESSIBLESTATE_CLASS_RETURN(NO);\n+    DECLARE_STATIC_FIELD_RETURN(jm_SELECTABLE,\n@@ -159,2 +196,3 @@\n-                                    \"Ljavax\/accessibility\/AccessibleState;\" );\n-    jobject axSelectableState = JNFGetStaticObjectField(env, jm_SELECTABLE);\n+                                    \"Ljavax\/accessibility\/AccessibleState;\", NO );\n+    jobject axSelectableState = (*env)->GetStaticObjectField(env, sjc_AccessibleState, jm_SELECTABLE);\n+    CHECK_EXCEPTION_NULL_RETURN(axSelectableState, NO);\n@@ -168,2 +206,9 @@\n-    static JNF_STATIC_MEMBER_CACHE(jm_getLocationOnScreen, sjc_CAccessibility, \"getLocationOnScreen\", \"(Ljavax\/accessibility\/AccessibleComponent;Ljava\/awt\/Component;)Ljava\/awt\/Point;\");\n-    jobject jpoint = JNFCallStaticObjectMethod(env, jm_getLocationOnScreen, axComponent, component); \/\/ AWT_THREADING Safe (AWTRunLoopMode)\n+    GET_CACCESSIBILITY_CLASS_RETURN(NSZeroPoint);\n+    DECLARE_STATIC_METHOD_RETURN(jm_getLocationOnScreen, sjc_CAccessibility, \"getLocationOnScreen\",\n+                  \"(Ljavax\/accessibility\/AccessibleComponent;Ljava\/awt\/Component;)Ljava\/awt\/Point;\", NSZeroPoint);\n+    DECLARE_CLASS_RETURN(sjc_Point, \"java\/awt\/Point\", NSZeroPoint);\n+    DECLARE_FIELD_RETURN(sjf_X, sjc_Point, \"x\", \"I\", NSZeroPoint);\n+    DECLARE_FIELD_RETURN(sjf_Y, sjc_Point, \"y\", \"I\", NSZeroPoint);\n+    jobject jpoint = (*env)->CallStaticObjectMethod(env, sjc_Point, jm_getLocationOnScreen,\n+                      axComponent, component); \/\/ AWT_THREADING Safe (AWTRunLoopMode)\n+    CHECK_EXCEPTION();\n@@ -171,1 +216,1 @@\n-    return NSMakePoint(JNFGetIntField(env, jpoint, sjf_X), JNFGetIntField(env, jpoint, sjf_Y));\n+    return NSMakePoint((*env)->GetIntField(env, jpoint, sjf_X), (*env)->GetIntField(env, jpoint, sjf_Y));\n@@ -176,2 +221,6 @@\n-    static JNF_STATIC_MEMBER_CACHE(jm_getCharCount, sjc_CAccessibility, \"getCharCount\", \"(Ljavax\/accessibility\/AccessibleText;Ljava\/awt\/Component;)I\");\n-    return JNFCallStaticIntMethod(env, jm_getCharCount, axText, component); \/\/ AWT_THREADING Safe (AWTRunLoopMode)\n+    GET_CACCESSIBILITY_CLASS_RETURN(0);\n+    DECLARE_STATIC_METHOD_RETURN(jm_getCharCount, sjc_CAccessibility, \"getCharCount\",\n+                  \"(Ljavax\/accessibility\/AccessibleText;Ljava\/awt\/Component;)I\", 0);\n+    int i = (*env)->CallStaticIntMethod(env, sjc_CAccessibility, jm_getCharCount, axText, component); \/\/ AWT_THREADING Safe (AWTRunLoopMode)\n+    CHECK_EXCEPTION();\n+    return i;\n@@ -268,1 +317,3 @@\n-    return JNFGetObjectField(env, axRole, sjf_key);\n+    DECLARE_CLASS_RETURN(sjc_AccessibleRole, \"javax\/accessibility\/AccessibleRole\", NULL);\n+    DECLARE_FIELD_RETURN(sjf_key, sjc_AccessibleRole, \"key\", \"Ljava\/lang\/String;\", NULL);\n+    return (*env)->GetObjectField(env, axRole, sjf_key);\n","filename":"src\/java.desktop\/macosx\/native\/libawt_lwawt\/awt\/JavaAccessibilityUtilities.m","additions":101,"deletions":50,"binary":false,"changes":151,"status":"modified"},{"patch":"@@ -47,0 +47,1 @@\n+#import \"JNIUtilities.h\"\n@@ -56,8 +57,2 @@\n-static JNF_STATIC_MEMBER_CACHE(jm_getChildrenAndRoles, sjc_CAccessibility, \"getChildrenAndRoles\", \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;IZ)[Ljava\/lang\/Object;\");\n-static JNF_STATIC_MEMBER_CACHE(jm_getTableInfo, sjc_CAccessibility, \"getTableInfo\", \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;I)I\");\n-static JNF_STATIC_MEMBER_CACHE(sjm_getAccessibleComponent, sjc_CAccessibility, \"getAccessibleComponent\", \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)Ljavax\/accessibility\/AccessibleComponent;\");\n-static JNF_STATIC_MEMBER_CACHE(sjm_getAccessibleValue, sjc_CAccessibility, \"getAccessibleValue\", \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)Ljavax\/accessibility\/AccessibleValue;\");\n-static JNF_STATIC_MEMBER_CACHE(sjm_getAccessibleName, sjc_CAccessibility, \"getAccessibleName\", \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)Ljava\/lang\/String;\");\n-static JNF_STATIC_MEMBER_CACHE(sjm_getAccessibleDescription, sjc_CAccessibility, \"getAccessibleDescription\", \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)Ljava\/lang\/String;\");\n-static JNF_STATIC_MEMBER_CACHE(sjm_isFocusTraversable, sjc_CAccessibility, \"isFocusTraversable\", \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)Z\");\n-static JNF_STATIC_MEMBER_CACHE(sjm_getAccessibleIndexInParent, sjc_CAccessibility, \"getAccessibleIndexInParent\", \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)I\");\n+\/\/ GET* macros defined in JavaAccessibilityUtilities.h, so they can be shared.\n+static jclass sjc_CAccessibility = NULL;\n@@ -65,1 +60,27 @@\n-static JNF_CLASS_CACHE(sjc_CAccessible, \"sun\/lwawt\/macosx\/CAccessible\");\n+static jmethodID sjm_getAccessibleName = NULL;\n+#define GET_ACCESSIBLENAME_METHOD_RETURN(ret) \\\n+    GET_CACCESSIBILITY_CLASS_RETURN(ret); \\\n+    GET_METHOD_RETURN(sjm_getAccessibleName, sjc_CAccessibility, \"getAccessibleName\", \\\n+                     \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)Ljava\/lang\/String;\", ret);\n+\n+static jmethodID jm_getChildrenAndRoles = NULL;\n+#define GET_CHILDRENANDROLES_METHOD_RETURN(ret) \\\n+    GET_CACCESSIBILITY_CLASS_RETURN(ret); \\\n+    GET_METHOD_RETURN(jm_getChildrenAndRoles, sjc_CAccessibility, \"getChildrenAndRoles\",\\\n+                      \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;IZ)[Ljava\/lang\/Object;\", ret);\n+\n+static jmethodID sjm_getAccessibleComponent = NULL;\n+#define GET_ACCESSIBLECOMPONENT_STATIC_METHOD_RETURN(ret) \\\n+    GET_CACCESSIBILITY_CLASS_RETURN(ret); \\\n+    GET_STATIC_METHOD_RETURN(sjm_getAccessibleComponent, sjc_CAccessibility, \"getAccessibleComponent\", \\\n+           \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)Ljavax\/accessibility\/AccessibleComponent;\", ret);\n+\n+static jmethodID sjm_getAccessibleIndexInParent = NULL;\n+#define GET_ACCESSIBLEINDEXINPARENT_STATIC_METHOD_RETURN(ret) \\\n+    GET_CACCESSIBILITY_CLASS_RETURN(ret); \\\n+    GET_STATIC_METHOD_RETURN(sjm_getAccessibleIndexInParent, sjc_CAccessibility, \"getAccessibleIndexInParent\", \\\n+                             \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)I\", ret);\n+\n+static jclass sjc_CAccessible = NULL;\n+#define GET_CACCESSIBLE_CLASS_RETURN(ret) \\\n+    GET_CLASS_RETURN(sjc_CAccessible, \"sun\/lwawt\/macosx\/CAccessible\", ret);\n@@ -67,2 +88,0 @@\n-static JNF_MEMBER_CACHE(jf_ptr, sjc_CAccessible, \"ptr\", \"J\");\n-static JNF_STATIC_MEMBER_CACHE(sjm_getCAccessible, sjc_CAccessible, \"getCAccessible\", \"(Ljavax\/accessibility\/Accessible;)Lsun\/lwawt\/macosx\/CAccessible;\");\n@@ -291,1 +310,4 @@\n-        JNF_STATIC_MEMBER_CACHE(jm_getAccessibility, sjc_CAccessibility, \"getAccessibility\", \"([Ljava\/lang\/String;)Lsun\/lwawt\/macosx\/CAccessibility;\");\n+        JNIEnv *env = [ThreadUtilities getJNIEnv];\n+\n+        GET_CACCESSIBILITY_CLASS();\n+        DECLARE_STATIC_METHOD(jm_getAccessibility, sjc_CAccessibility, \"getAccessibility\", \"([Ljava\/lang\/String;)Lsun\/lwawt\/macosx\/CAccessibility;\");\n@@ -301,4 +323,3 @@\n-        JNIEnv *env = [ThreadUtilities getJNIEnv];\n-\n-        static JNF_CLASS_CACHE(jc_String, \"java\/lang\/String\");\n-        result = JNFNewObjectArray(env, &jc_String, count);\n+        DECLARE_CLASS(jc_String, \"java\/lang\/String\");\n+        result = (*env)->NewObjectArray(env, count, jc_String, NULL);\n+        CHECK_EXCEPTION();\n@@ -317,1 +338,1 @@\n-        sAccessibilityClass = JNFCallStaticObjectMethod(env, jm_getAccessibility, result); \/\/ AWT_THREADING Safe (known object)\n+        sAccessibilityClass = (*env)->CallStaticObjectMethod(env, sjc_CAccessibility, jm_getAccessibility, result); \/\/ AWT_THREADING Safe (known object)\n@@ -328,1 +349,5 @@\n-    if (JNFIsInstanceOf(env, jaccessible, &sjc_CAccessible)) {\n+    DECLARE_CLASS_RETURN(sjc_Accessible, \"javax\/accessibility\/Accessible\", NULL);\n+    GET_CACCESSIBLE_CLASS_RETURN(NULL);\n+    DECLARE_STATIC_METHOD_RETURN(sjm_getCAccessible, sjc_CAccessible, \"getCAccessible\",\n+                                \"(Ljavax\/accessibility\/Accessible;)Lsun\/lwawt\/macosx\/CAccessible;\", NULL);\n+    if ((*env)->IsInstanceOf(env, jaccessible, sjc_CAccessible)) {\n@@ -330,2 +355,4 @@\n-    } else if (JNFIsInstanceOf(env, jaccessible, &sjc_Accessible)) {\n-        return JNFCallStaticObjectMethod(env, sjm_getCAccessible, jaccessible);\n+    } else if ((*env)->IsInstanceOf(env, jaccessible, sjc_Accessible)) {\n+        jobject o = (*env)->CallStaticObjectMethod(env, sjc_CAccessible,  sjm_getCAccessible, jaccessible);\n+        CHECK_EXCEPTION();\n+        return o;\n@@ -339,1 +366,4 @@\n-    jobjectArray jchildrenAndRoles = (jobjectArray)JNFCallStaticObjectMethod(env, jm_getChildrenAndRoles, parent->fAccessible, parent->fComponent, whichChildren, allowIgnored); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    GET_CHILDRENANDROLES_METHOD_RETURN(nil);\n+    jobjectArray jchildrenAndRoles = (jobjectArray)(*env)->CallStaticObjectMethod(env, sjc_CAccessibility, jm_getChildrenAndRoles,\n+                  parent->fAccessible, parent->fComponent, whichChildren, allowIgnored); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    CHECK_EXCEPTION();\n@@ -354,1 +384,4 @@\n-            jobject jkey = JNFGetObjectField(env, jchildJavaRole, sjf_key);\n+            DECLARE_CLASS_RETURN(sjc_AccessibleRole, \"javax\/accessibility\/AccessibleRole\", nil);\n+            DECLARE_FIELD_RETURN(sjf_key, sjc_AccessibleRole, \"key\", \"Ljava\/lang\/String;\", nil);\n+            jobject jkey = (*env)->GetObjectField(env, jchildJavaRole, sjf_key);\n+            CHECK_EXCEPTION();\n@@ -374,0 +407,1 @@\n+    GET_ACCESSIBLEINDEXINPARENT_STATIC_METHOD_RETURN(nil);\n@@ -376,1 +410,2 @@\n-    jint index = JNFCallStaticIntMethod(env, sjm_getAccessibleIndexInParent, jaccessible, jcomponent);\n+    jint index = (*env)->CallStaticIntMethod(env, sjc_CAccessibility, sjm_getAccessibleIndexInParent, jaccessible, jcomponent);\n+    CHECK_EXCEPTION();\n@@ -392,0 +427,2 @@\n+    GET_CACCESSIBLE_CLASS_RETURN(NULL);\n+    DECLARE_FIELD_RETURN(jf_ptr, sjc_CAccessible, \"ptr\", \"J\", NULL);\n@@ -395,1 +432,1 @@\n-    JavaComponentAccessibility *value = (JavaComponentAccessibility *) jlong_to_ptr(JNFGetLongField(env, jCAX, jf_ptr));\n+    JavaComponentAccessibility *value = (JavaComponentAccessibility *) jlong_to_ptr((*env)->GetLongField(env, jCAX, jf_ptr));\n@@ -431,1 +468,1 @@\n-    JNFSetLongField(env, jCAX, jf_ptr, ptr_to_jlong(newChild));\n+    (*env)->SetLongField(env, jCAX, jf_ptr, ptr_to_jlong(newChild));\n@@ -440,1 +477,3 @@\n-    static JNF_STATIC_MEMBER_CACHE(jm_getInitialAttributeStates, sjc_CAccessibility, \"getInitialAttributeStates\", \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)[Z\");\n+    GET_CACCESSIBILITY_CLASS_RETURN(nil);\n+    DECLARE_STATIC_METHOD_RETURN(jm_getInitialAttributeStates, sjc_CAccessibility, \"getInitialAttributeStates\",\n+                                  \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)[Z\", nil);\n@@ -465,1 +504,3 @@\n-    jbooleanArray attributeStates = (jbooleanArray)JNFCallStaticObjectMethod(env, jm_getInitialAttributeStates, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    jbooleanArray attributeStates = (jbooleanArray)(*env)->CallStaticObjectMethod(env, sjc_CAccessibility,\n+                     jm_getInitialAttributeStates, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    CHECK_EXCEPTION();\n@@ -557,1 +598,3 @@\n-    static JNF_STATIC_MEMBER_CACHE(jm_getAccessibleAction, sjc_CAccessibility, \"getAccessibleAction\", \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)Ljavax\/accessibility\/AccessibleAction;\");\n+    GET_CACCESSIBILITY_CLASS();\n+    DECLARE_STATIC_METHOD(jm_getAccessibleAction, sjc_CAccessibility, \"getAccessibleAction\",\n+                           \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)Ljavax\/accessibility\/AccessibleAction;\");\n@@ -561,1 +604,2 @@\n-    jobject axAction = JNFCallStaticObjectMethod(env, jm_getAccessibleAction, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    jobject axAction = (*env)->CallStaticObjectMethod(env, sjc_CAccessibility, jm_getAccessibleAction, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    CHECK_EXCEPTION();\n@@ -580,4 +624,0 @@\n-    static JNF_CLASS_CACHE(sjc_Window, \"java\/awt\/Window\");\n-    static JNF_STATIC_MEMBER_CACHE(sjm_getAccessibleParent, sjc_CAccessibility, \"getAccessibleParent\", \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)Ljavax\/accessibility\/Accessible;\");\n-    static JNF_STATIC_MEMBER_CACHE(sjm_getSwingAccessible, sjc_CAccessible, \"getSwingAccessible\", \"(Ljavax\/accessibility\/Accessible;)Ljavax\/accessibility\/Accessible;\");\n-\n@@ -586,0 +626,7 @@\n+        GET_CACCESSIBILITY_CLASS_RETURN(nil);\n+        DECLARE_STATIC_METHOD_RETURN(sjm_getAccessibleParent, sjc_CAccessibility, \"getAccessibleParent\",\n+                                 \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)Ljavax\/accessibility\/Accessible;\", nil);\n+        GET_CACCESSIBLE_CLASS_RETURN(nil);\n+        DECLARE_STATIC_METHOD_RETURN(sjm_getSwingAccessible, sjc_CAccessible, \"getSwingAccessible\",\n+                                 \"(Ljavax\/accessibility\/Accessible;)Ljavax\/accessibility\/Accessible;\", nil);\n+        DECLARE_CLASS_RETURN(sjc_Window, \"java\/awt\/Window\", nil);\n@@ -587,1 +634,2 @@\n-        jobject jparent = JNFCallStaticObjectMethod(env, sjm_getAccessibleParent, fAccessible, fComponent);\n+        jobject jparent = (*env)->CallStaticObjectMethod(env, sjc_CAccessibility,  sjm_getAccessibleParent, fAccessible, fComponent);\n+        CHECK_EXCEPTION();\n@@ -593,1 +641,1 @@\n-            jobject jax = JNFCallStaticObjectMethod(env, sjm_getSwingAccessible, fAccessible);\n+            jobject jax = (*env)->CallStaticObjectMethod(env, sjc_CAccessible, sjm_getSwingAccessible, fAccessible);\n@@ -595,1 +643,1 @@\n-            if (JNFIsInstanceOf(env, jax, &sjc_Window)) {\n+            if ((*env)->IsInstanceOf(env, jax, sjc_Window)) {\n@@ -597,1 +645,3 @@\n-                view = [AWTView awtView:env ofAccessible:jparent];\n+                DECLARE_METHOD_RETURN(jm_getAWTView, sjc_CAccessibility, \"getAWTView\", \"(Ljavax\/accessibility\/Accessible;)J\", nil);\n+                jlong jptr = (*env)->CallStaticLongMethod(env, jm_getAWTView, jparent);\n+                 view = (jptr == 0) ? nil : (AWTView *)jlong_to_ptr(jptr);\n@@ -599,0 +649,1 @@\n+            CHECK_EXCEPTION();\n@@ -801,0 +852,2 @@\n+    JNIEnv *env = [ThreadUtilities getJNIEnv];\n+    GET_ACCESSIBLEINDEXINPARENT_STATIC_METHOD_RETURN(0);\n@@ -802,1 +855,2 @@\n-        JNFCallStaticIntMethod( [ThreadUtilities getJNIEnv],\n+        (*env)->CallStaticIntMethod( env,\n+                                sjc_CAccessibility,\n@@ -806,0 +860,1 @@\n+    CHECK_EXCEPTION();\n@@ -824,2 +879,0 @@\n-    static JNF_STATIC_MEMBER_CACHE(jm_isEnabled, sjc_CAccessibility, \"isEnabled\", \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)Z\");\n-\n@@ -827,1 +880,5 @@\n-    NSNumber *value = [NSNumber numberWithBool:JNFCallStaticBooleanMethod(env, jm_isEnabled, fAccessible, fComponent)]; \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    GET_CACCESSIBILITY_CLASS_RETURN(nil);\n+    DECLARE_STATIC_METHOD_RETURN(jm_isEnabled, sjc_CAccessibility, \"isEnabled\", \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)Z\", nil);\n+\n+    NSNumber *value = [NSNumber numberWithBool:(*env)->CallStaticBooleanMethod(env, sjc_CAccessibility, jm_isEnabled, fAccessible, fComponent)]; \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    CHECK_EXCEPTION();\n@@ -851,0 +908,3 @@\n+    GET_CACCESSIBILITY_CLASS_RETURN(NO);\n+    DECLARE_STATIC_METHOD_RETURN(sjm_isFocusTraversable, sjc_CAccessibility, \"isFocusTraversable\",\n+                                 \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)Z\", NO);\n@@ -855,1 +915,1 @@\n-    if (JNFCallStaticBooleanMethod(env, sjm_isFocusTraversable, fAccessible, fComponent)) { \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    if ((*env)->CallStaticBooleanMethod(env, sjc_CAccessibility, sjm_isFocusTraversable, fAccessible, fComponent)) { \/\/ AWT_THREADING Safe (AWTRunLoop)\n@@ -858,0 +918,1 @@\n+    CHECK_EXCEPTION();\n@@ -864,1 +925,4 @@\n-    static JNF_STATIC_MEMBER_CACHE(jm_requestFocus, sjc_CAccessibility, \"requestFocus\", \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)V\");\n+    JNIEnv* env = [ThreadUtilities getJNIEnv];\n+\n+    GET_CACCESSIBILITY_CLASS();\n+    DECLARE_STATIC_METHOD(jm_requestFocus, sjc_CAccessibility, \"requestFocus\", \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)V\");\n@@ -868,2 +932,1 @@\n-        JNIEnv* env = [ThreadUtilities getJNIEnv];\n-        JNFCallStaticVoidMethod(env, jm_requestFocus, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+        (*env)->CallStaticVoidMethod(env, sjc_CAccessibility, jm_requestFocus, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n@@ -878,1 +941,6 @@\n-    jobject val = JNFCallStaticObjectMethod(env, sjm_getAccessibleDescription, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    GET_CACCESSIBILITY_CLASS_RETURN(nil);\n+    DECLARE_STATIC_METHOD_RETURN(sjm_getAccessibleDescription, sjc_CAccessibility, \"getAccessibleDescription\",\n+                                 \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)Ljava\/lang\/String;\", nil);\n+    jobject val = (*env)->CallStaticObjectMethod(env, sjc_CAccessibility,\n+                                   sjm_getAccessibleDescription, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    CHECK_EXCEPTION();\n@@ -907,2 +975,0 @@\n-    static JNF_STATIC_MEMBER_CACHE(jm_getMaximumAccessibleValue, sjc_CAccessibility, \"getMaximumAccessibleValue\", \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)Ljava\/lang\/Number;\");\n-\n@@ -910,0 +976,3 @@\n+    GET_CACCESSIBILITY_CLASS_RETURN(nil);\n+    DECLARE_STATIC_METHOD_RETURN(jm_getMaximumAccessibleValue, sjc_CAccessibility, \"getMaximumAccessibleValue\",\n+                                  \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)Ljava\/lang\/Number;\", nil);\n@@ -911,1 +980,2 @@\n-    jobject axValue = JNFCallStaticObjectMethod(env, jm_getMaximumAccessibleValue, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    jobject axValue = (*env)->CallStaticObjectMethod(env, sjc_CAccessibility, jm_getMaximumAccessibleValue, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    CHECK_EXCEPTION();\n@@ -928,2 +998,0 @@\n-    static JNF_STATIC_MEMBER_CACHE(jm_getMinimumAccessibleValue, sjc_CAccessibility, \"getMinimumAccessibleValue\", \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)Ljava\/lang\/Number;\");\n-\n@@ -931,0 +999,3 @@\n+    GET_CACCESSIBILITY_CLASS_RETURN(nil);\n+    DECLARE_STATIC_METHOD_RETURN(jm_getMinimumAccessibleValue, sjc_CAccessibility, \"getMinimumAccessibleValue\",\n+                                  \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)Ljava\/lang\/Number;\", nil);\n@@ -932,1 +1003,2 @@\n-    jobject axValue = JNFCallStaticObjectMethod(env, jm_getMinimumAccessibleValue, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    jobject axValue = (*env)->CallStaticObjectMethod(env, sjc_CAccessibility, jm_getMinimumAccessibleValue, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    CHECK_EXCEPTION();\n@@ -986,1 +1058,4 @@\n-    jobject axComponent = JNFCallStaticObjectMethod(env, sjm_getAccessibleComponent, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    GET_ACCESSIBLECOMPONENT_STATIC_METHOD_RETURN(nil);\n+    jobject axComponent = (*env)->CallStaticObjectMethod(env, sjc_CAccessibility, sjm_getAccessibleComponent,\n+                           fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    CHECK_EXCEPTION();\n@@ -1047,2 +1122,0 @@\n-        static JNF_STATIC_MEMBER_CACHE(jm_getAccessibleRoleDisplayString, sjc_CAccessibility, \"getAccessibleRoleDisplayString\", \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)Ljava\/lang\/String;\");\n-\n@@ -1050,0 +1123,3 @@\n+        GET_CACCESSIBILITY_CLASS_RETURN(nil);\n+        DECLARE_STATIC_METHOD_RETURN(jm_getAccessibleRoleDisplayString, sjc_CAccessibility, \"getAccessibleRoleDisplayString\",\n+                                     \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)Ljava\/lang\/String;\", nil);\n@@ -1051,1 +1127,3 @@\n-        jobject axRole = JNFCallStaticObjectMethod(env, jm_getAccessibleRoleDisplayString, fAccessible, fComponent);\n+\n+        jobject axRole = (*env)->CallStaticObjectMethod(env, jm_getAccessibleRoleDisplayString, fAccessible, fComponent);\n+        CHECK_EXCEPTION();\n@@ -1101,4 +1179,6 @@\n-    static JNF_STATIC_MEMBER_CACHE( jm_requestSelection,\n-                                    sjc_CAccessibility,\n-                                    \"requestSelection\",\n-                                    \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)V\" );\n+   JNIEnv* env = [ThreadUtilities getJNIEnv];\n+    GET_CACCESSIBILITY_CLASS();\n+    DECLARE_STATIC_METHOD(jm_requestSelection,\n+                          sjc_CAccessibility,\n+                          \"requestSelection\",\n+                          \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)V\");\n@@ -1107,2 +1187,2 @@\n-        JNIEnv* env = [ThreadUtilities getJNIEnv];\n-        JNFCallStaticVoidMethod(env, jm_requestSelection, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+        (*env)->CallStaticVoidMethod(env, sjc_CAccessibility, jm_requestSelection, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+        CHECK_EXCEPTION();\n@@ -1115,1 +1195,4 @@\n-    jobject axComponent = JNFCallStaticObjectMethod(env, sjm_getAccessibleComponent, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    GET_ACCESSIBLECOMPONENT_STATIC_METHOD_RETURN(nil);\n+    jobject axComponent = (*env)->CallStaticObjectMethod(env, sjc_CAccessibility,\n+                           sjm_getAccessibleComponent, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    CHECK_EXCEPTION();\n@@ -1175,1 +1258,3 @@\n-    jobject val = JNFCallStaticObjectMethod(env, sjm_getAccessibleName, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    GET_ACCESSIBLENAME_METHOD_RETURN(nil);\n+    jobject val = (*env)->CallStaticObjectMethod(env, sjm_getAccessibleName, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    CHECK_EXCEPTION();\n@@ -1205,2 +1290,0 @@\n-    static JNF_STATIC_MEMBER_CACHE(jm_getCurrentAccessibleValue, sjc_CAccessibility, \"getCurrentAccessibleValue\", \"(Ljavax\/accessibility\/AccessibleValue;Ljava\/awt\/Component;)Ljava\/lang\/Number;\");\n-\n@@ -1231,0 +1314,2 @@\n+                GET_CACCESSIBILITY_CLASS_RETURN(nil);\n+                GET_ACCESSIBLENAME_METHOD_RETURN(nil);\n@@ -1232,1 +1317,1 @@\n-                        JNFCallStaticObjectMethod( env,\n+                        (*env)->CallStaticObjectMethod( env,\n@@ -1236,0 +1321,1 @@\n+                CHECK_EXCEPTION();\n@@ -1253,1 +1339,5 @@\n-    jobject axValue = JNFCallStaticObjectMethod(env, sjm_getAccessibleValue, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    GET_CACCESSIBILITY_CLASS_RETURN(nil);\n+    DECLARE_STATIC_METHOD_RETURN(sjm_getAccessibleValue, sjc_CAccessibility, \"getAccessibleValue\",\n+                \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)Ljavax\/accessibility\/AccessibleValue;\", nil);\n+    jobject axValue = (*env)->CallStaticObjectMethod(env, sjc_CAccessibility, sjm_getAccessibleValue, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    CHECK_EXCEPTION();\n@@ -1255,1 +1345,4 @@\n-        jobject str = JNFCallStaticObjectMethod(env, jm_getCurrentAccessibleValue, axValue, fComponent);\n+        DECLARE_STATIC_METHOD_RETURN(jm_getCurrentAccessibleValue, sjc_CAccessibility, \"getCurrentAccessibleValue\",\n+                                     \"(Ljavax\/accessibility\/AccessibleValue;Ljava\/awt\/Component;)Ljava\/lang\/Number;\", nil);\n+        jobject str = (*env)->CallStaticObjectMethod(env, sjc_CAccessibility, jm_getCurrentAccessibleValue, axValue, fComponent);\n+        CHECK_EXCEPTION();\n@@ -1353,2 +1446,3 @@\n-    static JNF_CLASS_CACHE(jc_Container, \"java\/awt\/Container\");\n-    static JNF_STATIC_MEMBER_CACHE(jm_accessibilityHitTest, sjc_CAccessibility, \"accessibilityHitTest\", \"(Ljava\/awt\/Container;FF)Ljavax\/accessibility\/Accessible;\");\n+    DECLARE_CLASS_RETURN(jc_Container, \"java\/awt\/Container\", nil);\n+    DECLARE_STATIC_METHOD_RETURN(jm_accessibilityHitTest, sjc_CAccessibility, \"accessibilityHitTest\",\n+                                 \"(Ljava\/awt\/Container;FF)Ljavax\/accessibility\/Accessible;\", nil);\n@@ -1363,1 +1457,3 @@\n-        jobject jaccessible = JNFCallStaticObjectMethod(env, jm_accessibilityHitTest, jparent, (jfloat)point.x, (jfloat)point.y); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+        jobject jaccessible = (*env)->CallStaticObjectMethod(env, sjc_CAccessibility, jm_accessibilityHitTest,\n+                               jparent, (jfloat)point.x, (jfloat)point.y); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+        CHECK_EXCEPTION();\n@@ -1386,2 +1482,0 @@\n-    static JNF_STATIC_MEMBER_CACHE(jm_getFocusOwner, sjc_CAccessibility, \"getFocusOwner\", \"(Ljava\/awt\/Component;)Ljavax\/accessibility\/Accessible;\");\n-\n@@ -1389,0 +1483,2 @@\n+    DECLARE_STATIC_METHOD_RETURN(jm_getFocusOwner, sjc_CAccessibility, \"getFocusOwner\",\n+                                  \"(Ljava\/awt\/Component;)Ljavax\/accessibility\/Accessible;\", nil);\n@@ -1392,1 +1488,1 @@\n-    jobject focused = JNFCallStaticObjectMethod(env, jm_getFocusOwner, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    jobject focused = (*env)->CallStaticObjectMethod(env, sjc_CAccessibility, jm_getFocusOwner, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n@@ -1394,0 +1490,1 @@\n+    CHECK_EXCEPTION();\n@@ -1396,1 +1493,2 @@\n-        if (JNFIsInstanceOf(env, focused, &sjc_Accessible)) {\n+        DECLARE_CLASS_RETURN(sjc_Accessible, \"javax\/accessibility\/Accessible\", nil);\n+        if ((*env)->IsInstanceOf(env, focused, sjc_Accessible)) {\n@@ -1399,0 +1497,1 @@\n+        CHECK_EXCEPTION();\n@@ -1589,1 +1688,4 @@\n-    jobjectArray jtabsAndRoles = (jobjectArray)JNFCallStaticObjectMethod(env, jm_getChildrenAndRoles, fAccessible, fComponent, whichTabs, allowIgnored); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    GET_CHILDRENANDROLES_METHOD_RETURN(nil);\n+    jobjectArray jtabsAndRoles = (jobjectArray)(*env)->CallStaticObjectMethod(env, sjc_CAccessibility, jm_getChildrenAndRoles,\n+                                  fAccessible, fComponent, whichTabs, allowIgnored); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    CHECK_EXCEPTION();\n@@ -1605,1 +1707,4 @@\n-    jobject jkey = JNFGetObjectField(env, jtabJavaRole, sjf_key);\n+    DECLARE_CLASS_RETURN(sjc_AccessibleRole, \"javax\/accessibility\/AccessibleRole\", nil);\n+    DECLARE_FIELD_RETURN(sjf_key, sjc_AccessibleRole, \"key\", \"Ljava\/lang\/String;\", nil);\n+    jobject jkey = (*env)->GetObjectField(env, jtabJavaRole, sjf_key);\n+    CHECK_EXCEPTION();\n@@ -1921,1 +2026,4 @@\n-    jint count = JNFCallStaticIntMethod(env, jm_getTableInfo, fAccessible,\n+    GET_CACCESSIBILITY_CLASS_RETURN(nil);\n+    DECLARE_STATIC_METHOD_RETURN(jm_getTableInfo, sjc_CAccessibility, \"getTableInfo\",\n+                          \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;I)I\", nil);\n+    jint count = (*env)->CallStaticIntMethod(env, sjc_CAccessibility, jm_getTableInfo, fAccessible,\n@@ -1923,0 +2031,1 @@\n+    CHECK_EXCEPTION();\n@@ -1942,3 +2051,3 @@\n-    jobject axComponent = JNFCallStaticObjectMethod(env, sjm_getAccessibleComponent,\n-                                                    fAccessible, fComponent);\n-\n+    GET_ACCESSIBLECOMPONENT_STATIC_METHOD_RETURN(NSZeroRect);\n+    jobject axComponent = (*env)->CallStaticObjectMethod(env, sjc_CAccessibility, sjm_getAccessibleComponent, fAccessible, fComponent);\n+    CHECK_EXCEPTION();\n@@ -1968,1 +2077,0 @@\n-static JNF_CLASS_CACHE(sjc_Object, \"java\/lang\/Object\");\n@@ -1971,1 +2079,2 @@\n-    static JNF_MEMBER_CACHE(jm_equals, sjc_Object, \"equals\", \"(Ljava\/lang\/Object;)Z\");\n+    DECLARE_CLASS_RETURN(sjc_Object, \"java\/lang\/Object\", NO);\n+    DECLARE_METHOD_RETURN(jm_equals, sjc_Object, \"equals\", \"(Ljava\/lang\/Object;)Z\", NO);\n@@ -1978,3 +2087,5 @@\n-        static JNF_CLASS_CACHE(sjc_LWCToolkit, \"sun\/lwawt\/macosx\/LWCToolkit\");\n-        static JNF_STATIC_MEMBER_CACHE(jm_doEquals, sjc_LWCToolkit, \"doEquals\", \"(Ljava\/lang\/Object;Ljava\/lang\/Object;Ljava\/awt\/Component;)Z\");\n-        return JNFCallStaticBooleanMethod(env, jm_doEquals, a, b, component); \/\/ AWT_THREADING Safe (AWTRunLoopMode)\n+        DECLARE_CLASS_RETURN(sjc_LWCToolkit, \"sun\/lwawt\/macosx\/LWCToolkit\", NO);\n+        DECLARE_STATIC_METHOD_RETURN(jm_doEquals, sjc_LWCToolkit, \"doEquals\",\n+                                     \"(Ljava\/lang\/Object;Ljava\/lang\/Object;Ljava\/awt\/Component;)Z\", NO);\n+        return (*env)->CallStaticBooleanMethod(env, sjc_LWCToolkit, jm_doEquals, a, b, component); \/\/ AWT_THREADING Safe (AWTRunLoopMode)\n+        CHECK_EXCEPTION();\n@@ -1983,1 +2094,3 @@\n-    return JNFCallBooleanMethod(env, a, jm_equals, b); \/\/ AWT_THREADING Safe (!appKit)\n+    jboolean jb = (*env)->CallBooleanMethod(env, a, jm_equals, b); \/\/ AWT_THREADING Safe (!appKit)\n+    CHECK_EXCEPTION();\n+    return jb;\n","filename":"src\/java.desktop\/macosx\/native\/libawt_lwawt\/awt\/JavaComponentAccessibility.m","additions":201,"deletions":88,"binary":false,"changes":289,"status":"modified"},{"patch":"@@ -30,0 +30,1 @@\n+#import \"JNIUtilities.h\"\n@@ -31,0 +32,23 @@\n+static jclass sjc_CAccessibility = NULL;\n+#define GET_CACCESSIBLITY_CLASS() \\\n+     GET_CLASS(sjc_CAccessibility, \"sun\/lwawt\/macosx\/CAccessibility\");\n+#define GET_CACCESSIBLITY_CLASS_RETURN(ret) \\\n+     GET_CLASS_RETURN(sjc_CAccessibility, \"sun\/lwawt\/macosx\/CAccessibility\", ret);\n+\n+static jmethodID sjm_getAccessibleText = NULL;\n+#define GET_ACCESSIBLETEXT_METHOD() \\\n+    GET_CACCESSIBLITY_CLASS(); \\\n+    GET_METHOD(sjm_getAccessibleText, sjc_CAccessibility, \"getAccessibleText\", \\\n+              \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)Ljavax\/accessibility\/AccessibleText;\");\n+\n+static jclass sjc_CAccessibleText = NULL;\n+#define GET_CACCESSIBLETEXT_CLASS() \\\n+    GET_CLASS(sjc_CAccessibleText, \"sun\/lwawt\/macosx\/CAccessibleText\");\n+#define GET_CACCESSIBLETEXT_CLASS_RETURN(ret) \\\n+    GET_CLASS_RETURN(sjc_CAccessibleText, \"sun\/lwawt\/macosx\/CAccessibleText\", ret);\n+\n+static jmethodID sjm_getAccessibleEditableText = NULL;\n+#define GET_ACCESSIBLEEDITABLETEXT_METHOD() \\\n+    GET_CACCESSIBLETEXT_CLASS(); \\\n+    GET_METHOD(sjm_getAccessibleEditableText, sjc_CAccessibleText, \"getAccessibleEditableText\", \\\n+              \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)Ljavax\/accessibility\/AccessibleEditableText;\");\n@@ -32,4 +56,0 @@\n-static JNF_CLASS_CACHE(sjc_CAccessibleText, \"sun\/lwawt\/macosx\/CAccessibleText\");\n-static JNF_STATIC_MEMBER_CACHE(sjm_getAccessibleText, sjc_CAccessibility, \"getAccessibleText\", \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)Ljavax\/accessibility\/AccessibleText;\");\n-static JNF_STATIC_MEMBER_CACHE(sjm_getAccessibleEditableText, sjc_CAccessibleText, \"getAccessibleEditableText\", \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)Ljavax\/accessibility\/AccessibleEditableText;\");\n-static JNF_STATIC_MEMBER_CACHE(sjm_getAccessibleName, sjc_CAccessibility, \"getAccessibleName\", \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)Ljava\/lang\/String;\");\n@@ -111,0 +131,3 @@\n+    GET_CACCESSIBLITY_CLASS_RETURN(nil);\n+    DECLARE_METHOD_RETURN(sjm_getAccessibleName, sjc_CAccessibility, \"getAccessibleName\",\n+                          \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)Ljava\/lang\/String;\", nil);\n@@ -113,1 +136,3 @@\n-        jobject axName = JNFCallStaticObjectMethod(env, sjm_getAccessibleName, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+        jobject axName = (*env)->CallStaticObjectMethod(env, sjc_CAccessibility,\n+                           sjm_getAccessibleName, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+        CHECK_EXCEPTION();\n@@ -123,1 +148,3 @@\n-    jobject axText = JNFCallStaticObjectMethod(env, sjm_getAccessibleText, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    jobject axText = (*env)->CallStaticObjectMethod(env, sjc_CAccessibility,\n+                      sjm_getAccessibleText, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    CHECK_EXCEPTION();\n@@ -127,1 +154,3 @@\n-    jobject axEditableText = JNFCallStaticObjectMethod(env, sjm_getAccessibleEditableText, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    jobject axEditableText = (*env)->CallStaticObjectMethod(env, sjc_CAccessibleText,\n+                       sjm_getAccessibleEditableText, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    CHECK_EXCEPTION();\n@@ -130,2 +159,6 @@\n-    static JNF_STATIC_MEMBER_CACHE(jm_getTextRange, sjc_CAccessibleText, \"getTextRange\", \"(Ljavax\/accessibility\/AccessibleEditableText;IILjava\/awt\/Component;)Ljava\/lang\/String;\");\n-    jobject jrange = JNFCallStaticObjectMethod(env, jm_getTextRange, axEditableText, 0, getAxTextCharCount(env, axEditableText, fComponent), fComponent);\n+    DECLARE_METHOD_RETURN(jm_getTextRange, sjc_CAccessibleText, \"getTextRange\",\n+                    \"(Ljavax\/accessibility\/AccessibleEditableText;IILjava\/awt\/Component;)Ljava\/lang\/String;\", nil);\n+    CHECK_EXCEPTION();\n+    jobject jrange = (*env)->CallStaticObjectMethod(env, sjc_CAccessibleText, jm_getTextRange,\n+                       axEditableText, 0, getAxTextCharCount(env, axEditableText, fComponent), fComponent);\n+    CHECK_EXCEPTION();\n@@ -148,1 +181,3 @@\n-    jobject axEditableText = JNFCallStaticObjectMethod(env, sjm_getAccessibleEditableText, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    jobject axEditableText = (*env)->CallStaticObjectMethod(env, sjc_CAccessibleText,\n+                     sjm_getAccessibleEditableText, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    CHECK_EXCEPTION();\n@@ -166,2 +201,6 @@\n-    static JNF_STATIC_MEMBER_CACHE(jm_getSelectedText, sjc_CAccessibleText, \"getSelectedText\", \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)Ljava\/lang\/String;\");\n-    jobject axText = JNFCallStaticObjectMethod(env, jm_getSelectedText, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    GET_CACCESSIBLETEXT_CLASS_RETURN(nil);\n+    DECLARE_METHOD_RETURN(jm_getSelectedText, sjc_CAccessibleText, \"getSelectedText\",\n+              \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)Ljava\/lang\/String;\", nil);\n+    jobject axText = (*env)->CallStaticObjectMethod(env, sjc_CAccessibleText, jm_getSelectedText,\n+                        fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    CHECK_EXCEPTION();\n@@ -190,2 +229,6 @@\n-    static JNF_STATIC_MEMBER_CACHE(jm_setSelectedText, sjc_CAccessibleText, \"setSelectedText\", \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;Ljava\/lang\/String;)V\");\n-    JNFCallStaticVoidMethod(env, jm_setSelectedText, fAccessible, fComponent, jstringValue); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    GET_CACCESSIBLETEXT_CLASS();\n+    DECLARE_METHOD(jm_setSelectedText, sjc_CAccessibleText, \"setSelectedText\",\n+                   \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;Ljava\/lang\/String;)V\");\n+    (*env)->CallStaticVoidMethod(env, sjc_CAccessibleText, jm_setSelectedText,\n+              fAccessible, fComponent, jstringValue); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    CHECK_EXCEPTION();\n@@ -198,2 +241,6 @@\n-    static JNF_STATIC_MEMBER_CACHE(jm_getSelectedTextRange, sjc_CAccessibleText, \"getSelectedTextRange\", \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)[I\");\n-    jintArray axTextRange = JNFCallStaticObjectMethod(env, jm_getSelectedTextRange, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    GET_CACCESSIBLETEXT_CLASS_RETURN(nil);\n+    DECLARE_METHOD_RETURN(jm_getSelectedTextRange, sjc_CAccessibleText, \"getSelectedTextRange\",\n+           \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)[I\", nil);\n+    jintArray axTextRange = (*env)->CallStaticObjectMethod(env, sjc_CAccessibleText,\n+                jm_getSelectedTextRange, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    CHECK_EXCEPTION();\n@@ -224,2 +271,6 @@\n-    static JNF_STATIC_MEMBER_CACHE(jm_setSelectedTextRange, sjc_CAccessibleText, \"setSelectedTextRange\", \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;II)V\");\n-    JNFCallStaticVoidMethod(env, jm_setSelectedTextRange, fAccessible, fComponent, startIndex, endIndex); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    GET_CACCESSIBLETEXT_CLASS();\n+    DECLARE_METHOD(jm_setSelectedTextRange, sjc_CAccessibleText, \"setSelectedTextRange\",\n+                  \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;II)V\");\n+    (*env)->CallStaticVoidMethod(env, sjc_CAccessibleText, jm_setSelectedTextRange,\n+                  fAccessible, fComponent, startIndex, endIndex); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    CHECK_EXCEPTION();\n@@ -233,1 +284,3 @@\n-    jobject axText = JNFCallStaticObjectMethod(env, sjm_getAccessibleText, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    jobject axText = (*env)->CallStaticObjectMethod(env, sjc_CAccessibility,\n+                     sjm_getAccessibleText, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    CHECK_EXCEPTION();\n@@ -247,2 +300,6 @@\n-    static JNF_STATIC_MEMBER_CACHE(jm_getVisibleCharacterRange, sjc_CAccessibleText, \"getVisibleCharacterRange\", \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)[I\");\n-    jintArray axTextRange = JNFCallStaticObjectMethod(env, jm_getVisibleCharacterRange, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    GET_CACCESSIBLETEXT_CLASS_RETURN(nil);\n+    DECLARE_METHOD_RETURN(jm_getVisibleCharacterRange, sjc_CAccessibleText, \"getVisibleCharacterRange\",\n+                          \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)[I\", nil);\n+    jintArray axTextRange = (*env)->CallStaticObjectMethod(env, sjc_CAccessibleText,\n+                 jm_getVisibleCharacterRange, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    CHECK_EXCEPTION();\n@@ -265,2 +322,6 @@\n-    static JNF_STATIC_MEMBER_CACHE(jm_getLineNumberForInsertionPoint, sjc_CAccessibleText, \"getLineNumberForInsertionPoint\", \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)I\");\n-    jint row = JNFCallStaticIntMethod(env, jm_getLineNumberForInsertionPoint, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    GET_CACCESSIBLETEXT_CLASS_RETURN(nil);\n+    DECLARE_METHOD_RETURN(jm_getLineNumberForInsertionPoint, sjc_CAccessibleText,\n+             \"getLineNumberForInsertionPoint\", \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;)I\", nil);\n+    jint row = (*env)->CallStaticIntMethod(env, sjc_CAccessibleText,\n+                  jm_getLineNumberForInsertionPoint, fAccessible, fComponent); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    CHECK_EXCEPTION();\n@@ -300,2 +361,6 @@\n-    static JNF_STATIC_MEMBER_CACHE(jm_getBoundsForRange, sjc_CAccessibleText, \"getBoundsForRange\", \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;II)[D\");\n-    jdoubleArray axBounds = (jdoubleArray)JNFCallStaticObjectMethod(env, jm_getBoundsForRange, fAccessible, fComponent, range.location, range.length); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    GET_CACCESSIBLETEXT_CLASS_RETURN(nil);\n+    DECLARE_METHOD_RETURN(jm_getBoundsForRange, sjc_CAccessibleText, \"getBoundsForRange\",\n+                         \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;II)[D\", nil);\n+    jdoubleArray axBounds = (jdoubleArray)(*env)->CallStaticObjectMethod(env, sjc_CAccessibleText, jm_getBoundsForRange,\n+                              fAccessible, fComponent, range.location, range.length); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    CHECK_EXCEPTION();\n@@ -306,0 +371,1 @@\n+    CHECK_EXCEPTION();\n@@ -327,2 +393,6 @@\n-    static JNF_STATIC_MEMBER_CACHE(jm_getLineNumberForIndex, sjc_CAccessibleText, \"getLineNumberForIndex\", \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;I)I\");\n-    jint row = JNFCallStaticIntMethod(env, jm_getLineNumberForIndex, fAccessible, fComponent, [line intValue]); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    GET_CACCESSIBLETEXT_CLASS_RETURN(nil);\n+    DECLARE_METHOD_RETURN(jm_getLineNumberForIndex, sjc_CAccessibleText, \"getLineNumberForIndex\",\n+                           \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;I)I\", nil);\n+    jint row = (*env)->CallStaticIntMethod(env, sjc_CAccessibleText, jm_getLineNumberForIndex,\n+                       fAccessible, fComponent, [line intValue]); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    CHECK_EXCEPTION();\n@@ -339,2 +409,6 @@\n-    static JNF_STATIC_MEMBER_CACHE(jm_getRangeForLine, sjc_CAccessibleText, \"getRangeForLine\", \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;I)[I\");\n-    jintArray axTextRange = (jintArray)JNFCallStaticObjectMethod(env, jm_getRangeForLine, fAccessible, fComponent, [line intValue]); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    GET_CACCESSIBLETEXT_CLASS_RETURN(nil);\n+    DECLARE_METHOD_RETURN(jm_getRangeForLine, sjc_CAccessibleText, \"getRangeForLine\",\n+                 \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;I)[I\", nil);\n+    jintArray axTextRange = (jintArray)(*env)->CallStaticObjectMethod(env, sjc_CAccessibleText,\n+                jm_getRangeForLine, fAccessible, fComponent, [line intValue]); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    CHECK_EXCEPTION();\n@@ -365,3 +439,6 @@\n-    static JNF_STATIC_MEMBER_CACHE(jm_getStringForRange, sjc_CAccessibleText, \"getStringForRange\", \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;II)Ljava\/lang\/String;\");\n-    jstring jstringForRange = (jstring)JNFCallStaticObjectMethod(env, jm_getStringForRange, fAccessible, fComponent, range.location, range.length); \/\/ AWT_THREADING Safe (AWTRunLoop)\n-\n+    GET_CACCESSIBLETEXT_CLASS_RETURN(nil);\n+    DECLARE_METHOD_RETURN(jm_getStringForRange, sjc_CAccessibleText, \"getStringForRange\",\n+                 \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;II)Ljava\/lang\/String;\", nil);\n+    jstring jstringForRange = (jstring)(*env)->CallStaticObjectMethod(env, sjc_CAccessibleText, jm_getStringForRange,\n+                            fAccessible, fComponent, range.location, range.length); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    CHECK_EXCEPTION();\n@@ -394,2 +471,6 @@\n-    static JNF_STATIC_MEMBER_CACHE(jm_getCharacterIndexAtPosition, sjc_CAccessibleText, \"getCharacterIndexAtPosition\", \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;II)I\");\n-    jint charIndex = JNFCallStaticIntMethod(env, jm_getCharacterIndexAtPosition, fAccessible, fComponent, point.x, point.y); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    GET_CACCESSIBLETEXT_CLASS_RETURN(nil);\n+    DECLARE_METHOD_RETURN(jm_getCharacterIndexAtPosition, sjc_CAccessibleText, \"getCharacterIndexAtPosition\",\n+                           \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;II)I\", nil);\n+    jint charIndex = (*env)->CallStaticIntMethod(env, sjc_CAccessibleText, jm_getCharacterIndexAtPosition,\n+                            fAccessible, fComponent, point.x, point.y); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    CHECK_EXCEPTION();\n@@ -423,2 +504,6 @@\n-    static JNF_STATIC_MEMBER_CACHE(jm_getRangeForIndex, sjc_CAccessibleText, \"getRangeForIndex\", \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;I)[I\");\n-    jintArray axTextRange = (jintArray)JNFCallStaticObjectMethod(env, jm_getRangeForIndex, fAccessible, fComponent, index); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    GET_CACCESSIBLETEXT_CLASS_RETURN(nil);\n+    DECLARE_METHOD_RETURN(jm_getRangeForIndex, sjc_CAccessibleText, \"getRangeForIndex\",\n+                    \"(Ljavax\/accessibility\/Accessible;Ljava\/awt\/Component;I)[I\", nil);\n+    jintArray axTextRange = (jintArray)(*env)->CallStaticObjectMethod(env, sjc_CAccessibleText, jm_getRangeForIndex,\n+                              fAccessible, fComponent, index); \/\/ AWT_THREADING Safe (AWTRunLoop)\n+    CHECK_EXCEPTION();\n","filename":"src\/java.desktop\/macosx\/native\/libawt_lwawt\/awt\/JavaTextAccessibility.m","additions":121,"deletions":36,"binary":false,"changes":157,"status":"modified"},{"patch":"@@ -122,0 +122,10 @@\n+#define GET_STATIC_FIELD_RETURN(dst_var, cls, name, signature, ret) \\\n+     if (dst_var == NULL) { \\\n+         dst_var = (*env)->GetStaticFieldID(env, cls, name, signature); \\\n+     } \\\n+     CHECK_NULL_RETURN(dst_var, ret);\n+\n+#define DECLARE_STATIC_FIELD_RETURN(dst_var, cls, name, signature, ret) \\\n+     static jfieldID dst_var = NULL; \\\n+     GET_STATIC_FIELD_RETURN(dst_var, cls, name, signature, ret);\n+\n","filename":"src\/java.desktop\/macosx\/native\/libosxapp\/JNIUtilities.h","additions":10,"deletions":0,"binary":false,"changes":10,"status":"modified"}]}