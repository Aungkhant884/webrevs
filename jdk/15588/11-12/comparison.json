{"files":[{"patch":"@@ -395,8 +395,12 @@\n-                    if (condyType == CondyType.CALL_DIRECT_BSM || condyType == CondyType.CALL_DIRECT_WITH_ARGS_BSM) {\n-                        Assert.assertTrue(bsm.startsWith(\"jdk.vm.ci.hotspot.test.TestDynamicConstant.get\") && bsm.endsWith(\"BSM\"), bsm);\n-                        if (condyType == CondyType.CALL_DIRECT_WITH_ARGS_BSM) {\n-                            List<JavaConstant> staticArguments = bsmi.getStaticArguments();\n-                            if (staticArguments.size() > 0) {\n-                                JavaConstant primitiveConstant = staticArguments.get(0);\n-                                Assert.assertTrue(primitiveConstant instanceof PrimitiveConstant);\n-                                BootstrapMethodInvocation innerBsmi = cp.lookupBootstrapMethodInvocation(primitiveConstant.asInt(), -1);\n+                    checkBsmName(condyType, bsm);\n+                    List<JavaConstant> staticArguments = bsmi.getStaticArguments();\n+                    for (int i = 0; i < staticArguments.size(); ++i) {\n+                        JavaConstant constant = staticArguments.get(i);\n+                        if (constant instanceof PrimitiveConstant) {\n+                            String innerTag = String.valueOf(getTagAt.invoke(cp, constant.asInt()));\n+                            if (condyType == CondyType.CALL_DIRECT_WITH_ARGS_BSM) {\n+                                Assert.assertEquals(i, 0);\n+                                Assert.assertEquals(innerTag, \"Dynamic\");\n+                            }\n+                            if (innerTag.equals(\"Dynamic\")) {\n+                                BootstrapMethodInvocation innerBsmi = cp.lookupBootstrapMethodInvocation(constant.asInt(), -1);\n@@ -404,2 +408,7 @@\n-                                Assert.assertTrue(innerBsm.startsWith(\"jdk.vm.ci.hotspot.test.TestDynamicConstant.get\") && bsm.endsWith(\"BSM\"), bsm);\n-                                Assert.assertTrue(staticArguments.get(1) instanceof HotSpotObjectConstant);\n+                                checkBsmName(condyType, innerBsm);\n+                            } else {\n+                                Assert.assertEquals(innerTag, \"MethodHandle\");\n+                            }\n+                        } else {\n+                            if (condyType == CondyType.CALL_DIRECT_WITH_ARGS_BSM) {\n+                                Assert.assertEquals(i, 1);\n@@ -407,0 +416,1 @@\n+                            Assert.assertTrue(staticArguments.get(i) instanceof HotSpotObjectConstant);\n@@ -408,2 +418,0 @@\n-                    } else {\n-                        Assert.assertEquals(bsm, \"java.lang.invoke.ConstantBootstraps.invoke\");\n@@ -420,0 +428,8 @@\n+    private static void checkBsmName(CondyType condyType, String bsm) {\n+        if (condyType == CondyType.CALL_DIRECT_BSM || condyType == CondyType.CALL_DIRECT_WITH_ARGS_BSM) {\n+            Assert.assertTrue(bsm.startsWith(\"jdk.vm.ci.hotspot.test.TestDynamicConstant.get\") && bsm.endsWith(\"BSM\"), bsm);\n+        } else {\n+            Assert.assertEquals(bsm, \"java.lang.invoke.ConstantBootstraps.invoke\");\n+        }\n+    }\n+\n","filename":"test\/hotspot\/jtreg\/compiler\/jvmci\/jdk.vm.ci.hotspot.test\/src\/jdk\/vm\/ci\/hotspot\/test\/TestDynamicConstant.java","additions":28,"deletions":12,"binary":false,"changes":40,"status":"modified"}]}