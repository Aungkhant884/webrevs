{"files":[{"patch":"@@ -321,0 +321,2 @@\n+    NSPaperOrientation orientation = [dstPrintInfo orientation];\n+\n@@ -323,1 +325,1 @@\n-            [dstPrintInfo setOrientation:NS_PORTRAIT];\n+            orientation = NS_PORTRAIT;\n@@ -327,1 +329,1 @@\n-            [dstPrintInfo setOrientation:NS_LANDSCAPE]; \/\/+++gdb Are LANDSCAPE and REVERSE_LANDSCAPE still inverted?\n+            orientation = NS_LANDSCAPE; \/\/+++gdb Are LANDSCAPE and REVERSE_LANDSCAPE still inverted?\n@@ -332,1 +334,1 @@\n-            [dstPrintInfo setOrientation:NS_LANDSCAPE]; \/\/+++gdb Are LANDSCAPE and REVERSE_LANDSCAPE still inverted?\n+            orientation = NS_LANDSCAPE; \/\/+++gdb Are LANDSCAPE and REVERSE_LANDSCAPE still inverted?\n@@ -336,1 +338,1 @@\n-            [dstPrintInfo setOrientation:NS_PORTRAIT];\n+            orientation = NS_PORTRAIT;\n@@ -339,0 +341,30 @@\n+\n+    \/\/ It is not possible to set NSPrintInfo paper size and orientation independently.\n+    \/\/ Setting paper size width large than height changes NSPrintInfo orientation to landscape.\n+    \/\/ Setting size width less than height changes NSPrintInfo orientation to portrait.\n+    \/\/ Updating NSPrintInfo orientation from landscape to portrait or from portrait to landscape\n+    \/\/ swaps NSPrintInfo paper width and height.\n+\n+    \/\/ There are four possible cases:\n+    \/\/ 1. Input: paper size: (w > h), orientation portrait\n+    \/\/   [dstPrintInfo setPaperSize: NSMakeSize(w, h)] \/\/ size: (w, h), orientation: landscape\n+    \/\/   [dstPrintInfo setOrientation: NS_PORTRAIT]    \/\/ size: (h, w), orientation: portrait\n+    \/\/   Note: width and height are swapped\n+    \/\/ 2. Input: paper size: (w > h), orientation landscape\n+    \/\/   [dstPrintInfo setPaperSize: NSMakeSize(h, w)] \/\/ size: (h, w), orientation: portrait\n+    \/\/   [dstPrintInfo setOrientation: NS_LANDSCAPE]   \/\/ size: (w, h), orientation: landscape\n+    \/\/ 3. Input: paper size: (w < h), orientation portrait\n+    \/\/   [dstPrintInfo setPaperSize: NSMakeSize(w, h)] \/\/ size: (w, h), orientation: portrait\n+    \/\/   [dstPrintInfo setOrientation: NS_PORTRAIT]    \/\/ size: (w, h), orientation: portrait\n+    \/\/ 4. Input: paper size: (w < h), orientation landscape\n+    \/\/   [dstPrintInfo setPaperSize: NSMakeSize(h, w)] \/\/ size: (h, w), orientation: landscape\n+    \/\/   [dstPrintInfo setOrientation: NS_LANDSCAPE]   \/\/ size: (h, w), orientation: landscape\n+    \/\/   Note: width and height are swapped\n+    NSSize size = [dstPrintInfo paperSize];\n+    \/\/ Enlarge height only for cases 1 and 4.\n+    if ([dstPrintInfo orientation] == NS_LANDSCAPE && size.width > size.height) {\n+        size.height = size.width + ((orientation == NS_PORTRAIT) ? 1 : 0);\n+        [dstPrintInfo setPaperSize: size];\n+    }\n+\n+    [dstPrintInfo setOrientation:orientation];\n","filename":"src\/java.desktop\/macosx\/native\/libawt_lwawt\/awt\/CPrinterJob.m","additions":36,"deletions":4,"binary":false,"changes":40,"status":"modified"},{"patch":"@@ -0,0 +1,324 @@\n+\/*\n+ * Copyright (c) 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2022, BELLSOFT. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/**\n+ * @test\n+ * @bug 8295737\n+ * @summary macOS: Print content cut off when width > height with portrait orientation\n+ * @run main\/othervm\/manual CutOffImage\n+ *\/\n+\n+import javax.print.PrintServiceLookup;\n+import javax.swing.*;\n+import java.awt.*;\n+import java.awt.event.WindowAdapter;\n+import java.awt.event.WindowEvent;\n+import java.awt.font.FontRenderContext;\n+import java.awt.font.GlyphVector;\n+import java.awt.geom.AffineTransform;\n+import java.awt.print.PageFormat;\n+import java.awt.print.Printable;\n+import java.awt.print.PrinterException;\n+import java.awt.print.PrinterJob;\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+\n+import java.awt.print.Book;\n+import java.awt.geom.AffineTransform;\n+import java.awt.image.BufferedImage;\n+import java.awt.print.Paper;\n+\n+\n+public class CutOffImage {\n+\n+    private static final String DESCRIPTION =\n+            \" 1. Setup printer on the system.\\n\" +\n+                    \" 2. Press Print button to print 4 rectangles.\\n\" +\n+                    \"    - rectangle size: 300x100, orientation portrait\\n\" +\n+                    \"    - rectangle size: 300x100, orientation landscape\\n\" +\n+                    \"    - rectangle size: 100x300, orientation portrait\\n\" +\n+                    \"    - rectangle size: 100x300, orientation landscape\\n\" +\n+                    \" 3. Check that 4 printed rectangles have fully drawn 8 vertical areas labeled from 1 to 8.\\n\" +\n+                    \" 4. If so, press PASS button, otherwise press FAIL button.\\n\";\n+\n+\n+    private static final CountDownLatch testEndedSignal = new CountDownLatch(1);\n+    private static final int testTimeout = 300000;\n+    private static volatile String testFailureMsg;\n+    private static volatile boolean testPassed;\n+    private static volatile boolean testFinished;\n+\n+    private static final double DOC_WIDTH = 300;\n+    private static final double DOC_HEIGHT = 100;\n+\n+    public static void main(String[] args) throws Exception {\n+\n+        SwingUtilities.invokeLater(() -> createAndShowTestDialog());\n+\n+        try {\n+            if (!testEndedSignal.await(testTimeout, TimeUnit.MILLISECONDS)) {\n+                throw new RuntimeException(String.format(\n+                        \"Test timeout '%d ms' elapsed.\", testTimeout));\n+            }\n+            if (!testPassed) {\n+                String failureMsg = testFailureMsg;\n+                if ((failureMsg != null) && (!failureMsg.trim().isEmpty())) {\n+                    throw new RuntimeException(failureMsg);\n+                } else {\n+                    throw new RuntimeException(\"Test failed.\");\n+                }\n+            }\n+        } catch (InterruptedException ie) {\n+            throw new RuntimeException(ie);\n+        } finally {\n+            testFinished = true;\n+        }\n+    }\n+\n+    private static void pass() {\n+        testPassed = true;\n+        testEndedSignal.countDown();\n+    }\n+\n+    private static void fail(String failureMsg) {\n+        testFailureMsg = failureMsg;\n+        testPassed = false;\n+        testEndedSignal.countDown();\n+    }\n+\n+    private static String convertMillisToTimeStr(int millis) {\n+        if (millis < 0) {\n+            return \"00:00:00\";\n+        }\n+        int hours = millis \/ 3600000;\n+        int minutes = (millis - hours * 3600000) \/ 60000;\n+        int seconds = (millis - hours * 3600000 - minutes * 60000) \/ 1000;\n+        return String.format(\"%02d:%02d:%02d\", hours, minutes, seconds);\n+    }\n+\n+    private static void createAndShowTestDialog() {\n+\n+        final JDialog dialog = new JDialog();\n+        dialog.setDefaultCloseOperation(WindowConstants.DISPOSE_ON_CLOSE);\n+        dialog.addWindowListener(new WindowAdapter() {\n+            @Override\n+            public void windowClosing(WindowEvent e) {\n+                dialog.dispose();\n+                fail(\"Main dialog was closed.\");\n+            }\n+        });\n+\n+        final JLabel testTimeoutLabel = new JLabel(String.format(\n+                \"Test timeout: %s\", convertMillisToTimeStr(testTimeout)));\n+        final long startTime = System.currentTimeMillis();\n+        final Timer timer = new Timer(0, null);\n+        timer.setDelay(1000);\n+        timer.addActionListener((e) -> {\n+            int leftTime = testTimeout - (int) (System.currentTimeMillis() - startTime);\n+            if ((leftTime < 0) || testFinished) {\n+                timer.stop();\n+                dialog.dispose();\n+            }\n+            testTimeoutLabel.setText(String.format(\n+                    \"Test timeout: %s\", convertMillisToTimeStr(leftTime)));\n+        });\n+        timer.start();\n+\n+        JTextArea textArea = new JTextArea(DESCRIPTION);\n+        textArea.setEditable(false);\n+\n+        final JButton testButton = new JButton(\"Print\");\n+        final JButton passButton = new JButton(\"PASS\");\n+        final JButton failButton = new JButton(\"FAIL\");\n+\n+        testButton.addActionListener((e) -> {\n+            testButton.setEnabled(false);\n+            new Thread(() -> {\n+                try {\n+                    doTest();\n+\n+                    SwingUtilities.invokeLater(() -> {\n+                        passButton.setEnabled(true);\n+                        failButton.setEnabled(true);\n+                    });\n+                } catch (Throwable t) {\n+                    t.printStackTrace();\n+                    dialog.dispose();\n+                    fail(\"Exception occurred in a thread executing the test.\");\n+                }\n+            }).start();\n+        });\n+        passButton.setEnabled(false);\n+        passButton.addActionListener((e) -> {\n+            dialog.dispose();\n+            pass();\n+        });\n+        failButton.setEnabled(false);\n+        failButton.addActionListener((e) -> {\n+            dialog.dispose();\n+            fail(\"TitledBorder label is cut off\");\n+        });\n+\n+        JPanel mainPanel = new JPanel(new BorderLayout());\n+\n+        JPanel labelPanel = new JPanel(new FlowLayout());\n+        labelPanel.add(testTimeoutLabel);\n+        mainPanel.add(labelPanel, BorderLayout.NORTH);\n+        mainPanel.add(textArea, BorderLayout.CENTER);\n+        JPanel buttonPanel = new JPanel(new FlowLayout());\n+        buttonPanel.add(testButton);\n+        buttonPanel.add(passButton);\n+        buttonPanel.add(failButton);\n+        mainPanel.add(buttonPanel, BorderLayout.SOUTH);\n+        dialog.add(mainPanel);\n+\n+        dialog.pack();\n+        dialog.setVisible(true);\n+    }\n+\n+    private static void doTest() throws Exception {\n+        SwingUtilities.invokeAndWait(() -> {\n+            try {\n+                print(DOC_WIDTH, DOC_HEIGHT);\n+            } catch (PrinterException e) {\n+                throw new RuntimeException(e);\n+            }\n+        });\n+    }\n+\n+    private static String getOrientation(int orientation) {\n+        switch (orientation) {\n+            case PageFormat.LANDSCAPE:\n+                return \"LANDSCAPE\";\n+            case PageFormat.PORTRAIT:\n+                return \"PORTRAIT\";\n+            case PageFormat.REVERSE_LANDSCAPE:\n+                return \"REVERSE_LANDSCAPE\";\n+            default:\n+                return \"UNKNOWN\";\n+        }\n+    }\n+\n+    private static void paintImage(Graphics2D g, int width, int height, int orientation) {\n+        BufferedImage img = createImage(width, height, orientation);\n+        g.drawImage(img, 0, 0, null);\n+    }\n+\n+    private static void appendToBook(PrinterJob job, Book book, double width, double height, int orientation) {\n+\n+        PageFormat page = job.getPageFormat(null);\n+        page.setOrientation(orientation);\n+        Paper paper = page.getPaper();\n+\n+        boolean isPortrait = (orientation == PageFormat.PORTRAIT);\n+        double w = (isPortrait) ? width : height;\n+        double h = (isPortrait) ? height : width;\n+        paper.setSize(w, h);\n+        paper.setImageableArea(0, 0, w, h);\n+\n+        page.setPaper(paper);\n+        page.setOrientation(orientation);\n+        book.append(new TestPrintable(width, height), page);\n+    }\n+\n+    private static void print(double width, double height) throws PrinterException {\n+        PrinterJob job = PrinterJob.getPrinterJob();\n+        job.setPrintService(PrintServiceLookup.lookupDefaultPrintService());\n+\n+        Book book = new Book();\n+        appendToBook(job, book, width, height, PageFormat.PORTRAIT);\n+        appendToBook(job, book, width, height, PageFormat.LANDSCAPE);\n+        appendToBook(job, book, height, width, PageFormat.PORTRAIT);\n+        appendToBook(job, book, height, width, PageFormat.LANDSCAPE);\n+\n+        job.setPageable(book);\n+\n+        if (job.printDialog()) {\n+            job.print();\n+        } else {\n+            throw new RuntimeException(\"Printing was canceled!\");\n+        }\n+    }\n+\n+    private static String getLabel(int width, int height, int orientation) {\n+        return String.format(\"%dx%d %s\", width, height, getOrientation(orientation));\n+    }\n+\n+    private static BufferedImage createImage(int w, int h, int orientation) {\n+\n+        int x = 0;\n+        int y = 0;\n+\n+        BufferedImage img = new BufferedImage(w, h, BufferedImage.TYPE_INT_ARGB);\n+        Graphics2D g = img.createGraphics();\n+\n+        g.setColor(Color.ORANGE);\n+        g.fillRect(x, y, w, h);\n+\n+        g.setColor(Color.BLUE);\n+        g.drawRect(x, y, w, h);\n+        g.drawRect(x + 1, y + 1, w - 2, h - 2);\n+        g.drawLine(x, y, x + w, y + h);\n+        g.drawLine(x, y + h, x + w, y);\n+\n+        g.setFont(g.getFont().deriveFont(10.0f));\n+\n+        int N = 8;\n+        int dx = w \/ N;\n+\n+        for (int i = 0; i < N; i++) {\n+            int xx = i * dx + x;\n+            g.setColor(Color.BLUE);\n+            g.drawLine(xx, y, xx, y + h);\n+            g.setColor(Color.BLUE);\n+            g.drawString(\"\" + (i + 1), xx + 3, y + h \/ 2);\n+        }\n+\n+        g.setColor(Color.RED);\n+        String label = getLabel(w, h, orientation);\n+        g.drawString(label, x + w \/ 10, y + h \/ 4);\n+\n+        g.dispose();\n+        return img;\n+    }\n+\n+    private static class TestPrintable implements Printable {\n+\n+        private final double width;\n+        private final double height;\n+\n+        TestPrintable(double width, double height) {\n+            this.width = width;\n+            this.height = height;\n+        }\n+\n+        @Override\n+        public int print(Graphics graphics, PageFormat pageFormat, int index) {\n+            paintImage((Graphics2D) graphics, (int) width, (int) height, pageFormat.getOrientation());\n+            return PAGE_EXISTS;\n+        }\n+    }\n+}\n","filename":"test\/jdk\/java\/awt\/print\/PageFormat\/CutOffImage.java","additions":324,"deletions":0,"binary":false,"changes":324,"status":"added"}]}