{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2019, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2019, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -100,1 +100,2 @@\n-    public static void printStackTraces(String file) throws IOException {\n+    \/* Returns false if the attempt should be retried. *\/\n+    public static boolean printStackTraces(String file, boolean allowRetry) throws IOException {\n@@ -107,1 +108,10 @@\n-                throw new RuntimeException(\"'JShellToolProvider' missing from stdout\/stderr\");\n+                \/\/ This check will very rarely fail due to not be able to get the stack trace\n+                \/\/ of the main thread do to it actively executing. See JDK-8269556. We retry once\n+                \/\/ if that happens. This failure is so rare that this should be enough to make it\n+                \/\/ extremely unlikely that we ever see this test fail again for this reason.\n+                if (!allowRetry) {\n+                    throw new RuntimeException(\"'JShellToolProvider' missing from stdout\/stderr\");\n+                } else {\n+                    System.out.println(\"'JShellToolProvider' missing. Allow one retry.\");\n+                    return true; \/\/ Allow one retry\n+                }\n@@ -112,0 +122,1 @@\n+        return false;\n@@ -114,1 +125,2 @@\n-    public static void testHeapDump() throws IOException {\n+    \/* Returns false if the attempt should be retried. *\/\n+    public static boolean testHeapDump(boolean allowRetry) throws IOException {\n@@ -127,1 +139,1 @@\n-        printStackTraces(hprofFile.getAbsolutePath());\n+        boolean retry = printStackTraces(hprofFile.getAbsolutePath(), allowRetry);\n@@ -131,0 +143,2 @@\n+\n+        return retry;\n@@ -152,1 +166,1 @@\n-                Thread.sleep(2000);\n+                Thread.sleep(4000);\n@@ -169,1 +183,6 @@\n-        testHeapDump();\n+\n+        boolean retry = testHeapDump(true);\n+        \/\/ In case of rare failure to find 'JShellToolProvider' in the output, allow one retry.\n+        if (retry) {\n+            testHeapDump(false);\n+        }\n","filename":"test\/jdk\/sun\/tools\/jhsdb\/JShellHeapDumpTest.java","additions":26,"deletions":7,"binary":false,"changes":33,"status":"modified"}]}