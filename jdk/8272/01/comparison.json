{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1999, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1999, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -28,0 +28,5 @@\n+import java.lang.ref.Cleaner;\n+import java.util.Arrays;\n+\n+import jdk.internal.ref.CleanerFactory;\n+\n@@ -41,0 +46,2 @@\n+    private transient Cleaner.Cleanable cleanable;\n+\n@@ -45,1 +52,2 @@\n-    private String prompt;\n+    private final String prompt;\n+\n@@ -50,1 +58,2 @@\n-    private boolean echoOn;\n+    private final boolean echoOn;\n+\n@@ -110,0 +119,5 @@\n+\n+        if (this.inputPassword != null) {\n+            cleanable = CleanerFactory.cleaner().register(\n+                    this, cleanerFor(inputPassword));\n+        }\n@@ -129,3 +143,3 @@\n-        if (inputPassword != null) {\n-            for (int i = 0; i < inputPassword.length; i++)\n-                inputPassword[i] = ' ';\n+        \/\/ Cleanup the last retrieved password copy.\n+        if (inputPassword != null && cleanable != null) {\n+            cleanable.clean();\n@@ -134,0 +148,6 @@\n+\n+    private static Runnable cleanerFor(char[] password) {\n+        return () -> {\n+            Arrays.fill(password, ' ');\n+        };\n+    }\n","filename":"src\/java.base\/share\/classes\/javax\/security\/auth\/callback\/PasswordCallback.java","additions":26,"deletions":6,"binary":false,"changes":32,"status":"modified"},{"patch":"@@ -0,0 +1,87 @@\n+\/*\n+ * Copyright (C) 2022 THL A29 Limited, a Tencent company. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/*\n+ * @test\n+ * @bug 8284910\n+ * @summary Buffer clean in PasswordCallback\n+ *\/\n+\n+import javax.security.auth.callback.PasswordCallback;\n+import java.util.WeakHashMap;\n+\n+public final class PasswordCleanup {\n+    private final static WeakHashMap<PasswordCallback, ?> weakHashMap =\n+            new WeakHashMap<>();\n+\n+    public static void main(String[] args) throws Exception {\n+        \/\/ Test password clearing at finalization.\n+        clearAtCollection();\n+\n+        \/\/ Test password clearing with the specific method.\n+        clearWithMethod();\n+    }\n+\n+    private static void clearAtCollection() throws Exception {\n+        \/\/ Create an object\n+        PasswordCallback passwordCallback =\n+                new PasswordCallback(\"Password: \", false);\n+        passwordCallback.setPassword(\"ThisIsAPassword\".toCharArray());\n+        passwordCallback.clearPassword();\n+        weakHashMap.put(passwordCallback, null);\n+        passwordCallback = null;\n+\n+        \/\/ Check the clearing\n+        checkClearing();\n+    }\n+\n+    private static void clearWithMethod() throws Exception {\n+        \/\/ Create an object\n+        PasswordCallback passwordCallback =\n+                new PasswordCallback(\"Password: \", false);\n+        passwordCallback.setPassword(\"ThisIsAPassword\".toCharArray());\n+\n+        \/\/ Use password clear method.\n+        passwordCallback.clearPassword();\n+\n+        weakHashMap.put(passwordCallback, null);\n+        passwordCallback = null;\n+\n+        \/\/ Check the clearing\n+        checkClearing();\n+    }\n+\n+    private static void checkClearing() throws Exception {\n+        \/\/ Wait to trigger the cleanup.\n+        for (int i = 0; i < 10 && weakHashMap.size() != 0; i++) {\n+            System.gc();\n+            Thread.sleep(100);\n+        }\n+\n+        \/\/ Check if the object has been collected.\n+        if (weakHashMap.size() > 0) {\n+            throw new RuntimeException(\"GSSName object is not released\");\n+        }\n+    }\n+}\n+\n","filename":"test\/jdk\/javax\/security\/auth\/callback\/PasswordCleanup.java","additions":87,"deletions":0,"binary":false,"changes":87,"status":"added"}]}