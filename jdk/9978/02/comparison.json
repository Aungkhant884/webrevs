{"files":[{"patch":"@@ -2175,4 +2175,0 @@\n-      methodHandle method(thread, target_handle);\n-      runtime = env.runtime();\n-      runtime->compile_method(&env, jvmci, method, osr_bci);\n-\n@@ -2180,7 +2176,14 @@\n-      failure_reason_on_C_heap = compile_state.failure_reason_on_C_heap();\n-      if (!compile_state.retryable()) {\n-        retry_message = \"not retryable\";\n-        compilable = ciEnv::MethodCompilable_not_at_tier;\n-      }\n-      if (!task->is_success()) {\n-        assert(failure_reason != NULL, \"must specify failure_reason\");\n+      if (failure_reason == nullptr) {\n+        methodHandle method(thread, target_handle);\n+        runtime = env.runtime();\n+        runtime->compile_method(&env, jvmci, method, osr_bci);\n+\n+        failure_reason = compile_state.failure_reason();\n+        failure_reason_on_C_heap = compile_state.failure_reason_on_C_heap();\n+        if (!compile_state.retryable()) {\n+          retry_message = \"not retryable\";\n+          compilable = ciEnv::MethodCompilable_not_at_tier;\n+        }\n+        if (!task->is_success()) {\n+          assert(failure_reason != NULL, \"must specify failure_reason\");\n+        }\n","filename":"src\/hotspot\/share\/compiler\/compileBroker.cpp","additions":14,"deletions":11,"binary":false,"changes":25,"status":"modified"},{"patch":"@@ -159,1 +159,1 @@\n-void JVMCIEnv::init_env_mode_runtime(JavaThread* thread, JNIEnv* parent_env) {\n+void JVMCIEnv::init_env_mode_runtime(JavaThread* thread, JNIEnv* parent_env, bool attach_OOME_is_fatal) {\n@@ -211,1 +211,8 @@\n-      if (_runtime->AttachCurrentThread(thread, (void**) &_env, &attach_args) != JNI_OK) {\n+      jint attach_result = _runtime->AttachCurrentThread(thread, (void**) &_env, &attach_args);\n+      if (attach_result == JNI_OK) {\n+        _detach_on_close = true;\n+      } else if (!attach_OOME_is_fatal && attach_result == JNI_ENOMEM) {\n+        _env = NULL;\n+        _attach_threw_OOME = true;\n+        return;\n+      } else {\n@@ -214,1 +221,0 @@\n-      _detach_on_close = true;\n@@ -232,2 +238,7 @@\n-    _throw_to_caller(false), _file(file), _line(line), _compile_state(compile_state) {\n-  init_env_mode_runtime(thread, NULL);\n+    _throw_to_caller(false), _file(file), _line(line), _attach_threw_OOME(false), _compile_state(compile_state) {\n+  \/\/ In case of OOME, there's a good chance a subsequent attempt to attach might succeed.\n+  \/\/ Other errors most likely indicate a non-recoverable error in the JVMCI runtime.\n+  init_env_mode_runtime(thread, NULL, false);\n+  if (_attach_threw_OOME) {\n+    compile_state->set_failure(true, \"Out of memory while attaching JVMCI compiler to current thread\");\n+  }\n@@ -237,1 +248,1 @@\n-    _throw_to_caller(false), _file(file), _line(line), _compile_state(NULL) {\n+    _throw_to_caller(false), _file(file), _line(line), _attach_threw_OOME(false), _compile_state(NULL) {\n@@ -242,1 +253,1 @@\n-    _throw_to_caller(true), _file(file), _line(line), _compile_state(NULL) {\n+    _throw_to_caller(true), _file(file), _line(line), _attach_threw_OOME(false), _compile_state(NULL) {\n@@ -252,0 +263,1 @@\n+  _attach_threw_OOME = false;\n@@ -418,0 +430,3 @@\n+  if (_attach_threw_OOME) {\n+    return;\n+  }\n","filename":"src\/hotspot\/share\/jvmci\/jvmciEnv.cpp","additions":22,"deletions":7,"binary":false,"changes":29,"status":"modified"},{"patch":"@@ -159,1 +159,1 @@\n-  void init_env_mode_runtime(JavaThread* thread, JNIEnv* parent_env);\n+  void init_env_mode_runtime(JavaThread* thread, JNIEnv* parent_env, bool attach_OOME_is_fatal = true);\n@@ -171,0 +171,1 @@\n+  bool    _attach_threw_OOME;    \/\/ Failed to attach thread due to OutOfMemoryError, the JVMCIEnv is invalid\n","filename":"src\/hotspot\/share\/jvmci\/jvmciEnv.hpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"}]}