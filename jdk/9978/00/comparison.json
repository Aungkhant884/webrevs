{"files":[{"patch":"@@ -2248,4 +2248,0 @@\n-      methodHandle method(thread, target_handle);\n-      runtime = env.runtime();\n-      runtime->compile_method(&env, jvmci, method, osr_bci);\n-\n@@ -2253,7 +2249,14 @@\n-      failure_reason_on_C_heap = compile_state.failure_reason_on_C_heap();\n-      if (!compile_state.retryable()) {\n-        retry_message = \"not retryable\";\n-        compilable = ciEnv::MethodCompilable_not_at_tier;\n-      }\n-      if (task->code() == NULL) {\n-        assert(failure_reason != NULL, \"must specify failure_reason\");\n+      if (failure_reason == nullptr) {\n+        methodHandle method(thread, target_handle);\n+        runtime = env.runtime();\n+        runtime->compile_method(&env, jvmci, method, osr_bci);\n+\n+        failure_reason = compile_state.failure_reason();\n+        failure_reason_on_C_heap = compile_state.failure_reason_on_C_heap();\n+        if (!compile_state.retryable()) {\n+          retry_message = \"not retryable\";\n+          compilable = ciEnv::MethodCompilable_not_at_tier;\n+        }\n+        if (task->code() == NULL) {\n+          assert(failure_reason != NULL, \"must specify failure_reason\");\n+        }\n","filename":"src\/hotspot\/share\/compiler\/compileBroker.cpp","additions":14,"deletions":11,"binary":false,"changes":25,"status":"modified"},{"patch":"@@ -159,1 +159,1 @@\n-void JVMCIEnv::init_env_mode_runtime(JavaThread* thread, JNIEnv* parent_env) {\n+void JVMCIEnv::init_env_mode_runtime(JavaThread* thread, JNIEnv* parent_env, bool attach_OOME_is_fatal) {\n@@ -211,1 +211,8 @@\n-      if (_runtime->AttachCurrentThread(thread, (void**) &_env, &attach_args) != JNI_OK) {\n+      jint attach_result = _runtime->AttachCurrentThread(thread, (void**) &_env, &attach_args);\n+      if (attach_result == JNI_OK) {\n+        _detach_on_close = true;\n+      } else if (!attach_OOME_is_fatal && attach_result == JNI_ENOMEM) {\n+        _env = NULL;\n+        _attach_threw_OOME = true;\n+        return;\n+      } else {\n@@ -214,1 +221,0 @@\n-      _detach_on_close = true;\n@@ -232,2 +238,5 @@\n-    _throw_to_caller(false), _file(file), _line(line), _compile_state(compile_state) {\n-  init_env_mode_runtime(thread, NULL);\n+    _throw_to_caller(false), _file(file), _line(line), _attach_threw_OOME(false), _compile_state(compile_state) {\n+  init_env_mode_runtime(thread, NULL, false);\n+  if (_attach_threw_OOME) {\n+    compile_state->set_failure(true, \"Out of memory\");\n+  }\n@@ -237,1 +246,1 @@\n-    _throw_to_caller(false), _file(file), _line(line), _compile_state(NULL) {\n+    _throw_to_caller(false), _file(file), _line(line), _attach_threw_OOME(false), _compile_state(NULL) {\n@@ -242,1 +251,1 @@\n-    _throw_to_caller(true), _file(file), _line(line), _compile_state(NULL) {\n+    _throw_to_caller(true), _file(file), _line(line), _attach_threw_OOME(false), _compile_state(NULL) {\n@@ -252,0 +261,1 @@\n+  _attach_threw_OOME = false;\n@@ -418,0 +428,3 @@\n+  if (_attach_threw_OOME) {\n+    return;\n+  }\n","filename":"src\/hotspot\/share\/jvmci\/jvmciEnv.cpp","additions":20,"deletions":7,"binary":false,"changes":27,"status":"modified"},{"patch":"@@ -160,1 +160,1 @@\n-  void init_env_mode_runtime(JavaThread* thread, JNIEnv* parent_env);\n+  void init_env_mode_runtime(JavaThread* thread, JNIEnv* parent_env, bool attach_OOME_is_fatal = true);\n@@ -172,0 +172,1 @@\n+  bool    _attach_threw_OOME;    \/\/ Failed to attach thread due to OutOfMemoryError, the JVMCIEnv is invalid\n","filename":"src\/hotspot\/share\/jvmci\/jvmciEnv.hpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"}]}