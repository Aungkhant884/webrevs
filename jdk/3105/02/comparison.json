{"files":[{"patch":"@@ -159,55 +159,0 @@\n-void PhaseMacroExpand::extract_call_projections(CallNode *call) {\n-  _fallthroughproj = NULL;\n-  _fallthroughcatchproj = NULL;\n-  _ioproj_fallthrough = NULL;\n-  _ioproj_catchall = NULL;\n-  _catchallcatchproj = NULL;\n-  _memproj_fallthrough = NULL;\n-  _memproj_catchall = NULL;\n-  _resproj = NULL;\n-  for (DUIterator_Fast imax, i = call->fast_outs(imax); i < imax; i++) {\n-    ProjNode *pn = call->fast_out(i)->as_Proj();\n-    switch (pn->_con) {\n-      case TypeFunc::Control:\n-      {\n-        \/\/ For Control (fallthrough) and I_O (catch_all_index) we have CatchProj -> Catch -> Proj\n-        _fallthroughproj = pn;\n-        DUIterator_Fast jmax, j = pn->fast_outs(jmax);\n-        const Node *cn = pn->fast_out(j);\n-        if (cn->is_Catch()) {\n-          ProjNode *cpn = NULL;\n-          for (DUIterator_Fast kmax, k = cn->fast_outs(kmax); k < kmax; k++) {\n-            cpn = cn->fast_out(k)->as_Proj();\n-            assert(cpn->is_CatchProj(), \"must be a CatchProjNode\");\n-            if (cpn->_con == CatchProjNode::fall_through_index)\n-              _fallthroughcatchproj = cpn;\n-            else {\n-              assert(cpn->_con == CatchProjNode::catch_all_index, \"must be correct index.\");\n-              _catchallcatchproj = cpn;\n-            }\n-          }\n-        }\n-        break;\n-      }\n-      case TypeFunc::I_O:\n-        if (pn->_is_io_use)\n-          _ioproj_catchall = pn;\n-        else\n-          _ioproj_fallthrough = pn;\n-        break;\n-      case TypeFunc::Memory:\n-        if (pn->_is_io_use)\n-          _memproj_catchall = pn;\n-        else\n-          _memproj_fallthrough = pn;\n-        break;\n-      case TypeFunc::Parms:\n-        _resproj = pn;\n-        break;\n-      default:\n-        assert(false, \"unexpected projection from allocation node.\");\n-    }\n-  }\n-\n-}\n-\n@@ -995,1 +940,1 @@\n-  if (_resproj != NULL && _resproj->outcnt() != 0) {\n+  if (_callprojs.resproj != NULL && _callprojs.resproj->outcnt() != 0) {\n@@ -999,2 +944,2 @@\n-    for (DUIterator_Fast jmax, j = _resproj->fast_outs(jmax);  j < jmax; j++) {\n-      Node *use = _resproj->fast_out(j);\n+    for (DUIterator_Fast jmax, j = _callprojs.resproj->fast_outs(jmax);  j < jmax; j++) {\n+      Node *use = _callprojs.resproj->fast_out(j);\n@@ -1007,3 +952,3 @@\n-    for (DUIterator_Last jmin, j = _resproj->last_outs(jmin); j >= jmin; ) {\n-      Node *use = _resproj->last_out(j);\n-      uint oc1 = _resproj->outcnt();\n+    for (DUIterator_Last jmin, j = _callprojs.resproj->last_outs(jmin); j >= jmin; ) {\n+      Node *use = _callprojs.resproj->last_out(j);\n+      uint oc1 = _callprojs.resproj->outcnt();\n@@ -1019,1 +964,1 @@\n-          assert(tmp == _fallthroughcatchproj, \"allocation control projection\");\n+          assert(tmp == _callprojs.fallthrough_catchproj, \"allocation control projection\");\n@@ -1027,1 +972,1 @@\n-            assert(mem->in(TypeFunc::Memory) == _memproj_fallthrough, \"allocation memory projection\");\n+            assert(mem->in(TypeFunc::Memory) == _callprojs.fallthrough_memproj, \"allocation memory projection\");\n@@ -1029,1 +974,1 @@\n-            assert(mem == _memproj_fallthrough, \"allocation memory projection\");\n+            assert(mem == _callprojs.fallthrough_memproj, \"allocation memory projection\");\n@@ -1037,1 +982,1 @@\n-      j -= (oc1 - _resproj->outcnt());\n+      j -= (oc1 - _callprojs.resproj->outcnt());\n@@ -1040,2 +985,2 @@\n-  if (_fallthroughcatchproj != NULL) {\n-    _igvn.replace_node(_fallthroughcatchproj, alloc->in(TypeFunc::Control));\n+  if (_callprojs.fallthrough_catchproj != NULL) {\n+    _igvn.replace_node(_callprojs.fallthrough_catchproj, alloc->in(TypeFunc::Control));\n@@ -1043,2 +988,2 @@\n-  if (_memproj_fallthrough != NULL) {\n-    _igvn.replace_node(_memproj_fallthrough, alloc->in(TypeFunc::Memory));\n+  if (_callprojs.fallthrough_memproj != NULL) {\n+    _igvn.replace_node(_callprojs.fallthrough_memproj, alloc->in(TypeFunc::Memory));\n@@ -1046,2 +991,2 @@\n-  if (_memproj_catchall != NULL) {\n-    _igvn.replace_node(_memproj_catchall, C->top());\n+  if (_callprojs.catchall_memproj != NULL) {\n+    _igvn.replace_node(_callprojs.catchall_memproj, C->top());\n@@ -1049,2 +994,2 @@\n-  if (_ioproj_fallthrough != NULL) {\n-    _igvn.replace_node(_ioproj_fallthrough, alloc->in(TypeFunc::I_O));\n+  if (_callprojs.fallthrough_ioproj != NULL) {\n+    _igvn.replace_node(_callprojs.fallthrough_ioproj, alloc->in(TypeFunc::I_O));\n@@ -1052,2 +997,2 @@\n-  if (_ioproj_catchall != NULL) {\n-    _igvn.replace_node(_ioproj_catchall, C->top());\n+  if (_callprojs.catchall_ioproj != NULL) {\n+    _igvn.replace_node(_callprojs.catchall_ioproj, C->top());\n@@ -1055,2 +1000,2 @@\n-  if (_catchallcatchproj != NULL) {\n-    _igvn.replace_node(_catchallcatchproj, C->top());\n+  if (_callprojs.catchall_catchproj != NULL) {\n+    _igvn.replace_node(_callprojs.catchall_catchproj, C->top());\n@@ -1081,1 +1026,1 @@\n-  extract_call_projections(alloc);\n+  alloc->extract_projections(&_callprojs, false\/*separate_io_proj*\/, false\/*do_asserts*\/);\n@@ -1136,1 +1081,1 @@\n-  extract_call_projections(boxing);\n+  boxing->extract_projections(&_callprojs, false\/*separate_io_proj*\/, false\/*do_asserts*\/);\n@@ -1466,1 +1411,1 @@\n-  extract_call_projections(call);\n+  call->extract_projections(&_callprojs, false\/*separate_io_proj*\/, false\/*do_asserts*\/);\n@@ -1472,9 +1417,9 @@\n-  if (expand_fast_path && _memproj_fallthrough != NULL) {\n-    migrate_outs(_memproj_fallthrough, result_phi_rawmem);\n-  }\n-  \/\/ Now change uses of _memproj_catchall to use _memproj_fallthrough and delete\n-  \/\/ _memproj_catchall so we end up with a call that has only 1 memory projection.\n-  if (_memproj_catchall != NULL ) {\n-    if (_memproj_fallthrough == NULL) {\n-      _memproj_fallthrough = new ProjNode(call, TypeFunc::Memory);\n-      transform_later(_memproj_fallthrough);\n+  if (expand_fast_path && _callprojs.fallthrough_memproj != NULL) {\n+    migrate_outs(_callprojs.fallthrough_memproj, result_phi_rawmem);\n+  }\n+  \/\/ Now change uses of catchall_memproj to use fallthrough_memproj and delete\n+  \/\/ catchall_memproj so we end up with a call that has only 1 memory projection.\n+  if (_callprojs.catchall_memproj != NULL ) {\n+    if (_callprojs.fallthrough_memproj == NULL) {\n+      _callprojs.fallthrough_memproj = new ProjNode(call, TypeFunc::Memory);\n+      transform_later(_callprojs.fallthrough_memproj);\n@@ -1482,2 +1427,2 @@\n-    migrate_outs(_memproj_catchall, _memproj_fallthrough);\n-    _igvn.remove_dead_node(_memproj_catchall);\n+    migrate_outs(_callprojs.catchall_memproj, _callprojs.fallthrough_memproj);\n+    _igvn.remove_dead_node(_callprojs.catchall_memproj);\n@@ -1491,9 +1436,9 @@\n-  if (_ioproj_fallthrough != NULL) {\n-    migrate_outs(_ioproj_fallthrough, result_phi_i_o);\n-  }\n-  \/\/ Now change uses of _ioproj_catchall to use _ioproj_fallthrough and delete\n-  \/\/ _ioproj_catchall so we end up with a call that has only 1 i_o projection.\n-  if (_ioproj_catchall != NULL ) {\n-    if (_ioproj_fallthrough == NULL) {\n-      _ioproj_fallthrough = new ProjNode(call, TypeFunc::I_O);\n-      transform_later(_ioproj_fallthrough);\n+  if (_callprojs.fallthrough_ioproj != NULL) {\n+    migrate_outs(_callprojs.fallthrough_ioproj, result_phi_i_o);\n+  }\n+  \/\/ Now change uses of catchall_ioproj to use fallthrough_ioproj and delete\n+  \/\/ catchall_ioproj so we end up with a call that has only 1 i_o projection.\n+  if (_callprojs.catchall_ioproj != NULL ) {\n+    if (_callprojs.fallthrough_ioproj == NULL) {\n+      _callprojs.fallthrough_ioproj = new ProjNode(call, TypeFunc::I_O);\n+      transform_later(_callprojs.fallthrough_ioproj);\n@@ -1501,2 +1446,2 @@\n-    migrate_outs(_ioproj_catchall, _ioproj_fallthrough);\n-    _igvn.remove_dead_node(_ioproj_catchall);\n+    migrate_outs(_callprojs.catchall_ioproj, _callprojs.fallthrough_ioproj);\n+    _igvn.remove_dead_node(_callprojs.catchall_ioproj);\n@@ -1521,2 +1466,2 @@\n-  if (_fallthroughcatchproj != NULL) {\n-    ctrl = _fallthroughcatchproj->clone();\n+  if (_callprojs.fallthrough_catchproj != NULL) {\n+    ctrl = _callprojs.fallthrough_catchproj->clone();\n@@ -1524,1 +1469,1 @@\n-    _igvn.replace_node(_fallthroughcatchproj, result_region);\n+    _igvn.replace_node(_callprojs.fallthrough_catchproj, result_region);\n@@ -1529,1 +1474,1 @@\n-  if (_resproj == NULL) {\n+  if (_callprojs.resproj == NULL) {\n@@ -1533,1 +1478,1 @@\n-    slow_result = _resproj->clone();\n+    slow_result = _callprojs.resproj->clone();\n@@ -1535,1 +1480,1 @@\n-    _igvn.replace_node(_resproj, result_phi_rawoop);\n+    _igvn.replace_node(_callprojs.resproj, result_phi_rawoop);\n@@ -1545,1 +1490,1 @@\n-  result_phi_rawmem->init_req(slow_result_path, _memproj_fallthrough);\n+  result_phi_rawmem->init_req(slow_result_path, _callprojs.fallthrough_memproj);\n@@ -1557,4 +1502,4 @@\n-  extract_call_projections(alloc);\n-  if (_resproj != NULL) {\n-    for (DUIterator_Fast imax, i = _resproj->fast_outs(imax); i < imax; i++) {\n-      Node* use = _resproj->fast_out(i);\n+  alloc->extract_projections(&_callprojs, false\/*separate_io_proj*\/, false\/*do_asserts*\/);\n+  if (_callprojs.resproj != NULL) {\n+    for (DUIterator_Fast imax, i = _callprojs.resproj->fast_outs(imax); i < imax; i++) {\n+      Node* use = _callprojs.resproj->fast_out(i);\n@@ -1565,2 +1510,2 @@\n-    assert(_resproj->outcnt() == 0, \"all uses must be deleted\");\n-    _igvn.remove_dead_node(_resproj);\n+    assert(_callprojs.resproj->outcnt() == 0, \"all uses must be deleted\");\n+    _igvn.remove_dead_node(_callprojs.resproj);\n@@ -1568,3 +1513,3 @@\n-  if (_fallthroughcatchproj != NULL) {\n-    migrate_outs(_fallthroughcatchproj, ctrl);\n-    _igvn.remove_dead_node(_fallthroughcatchproj);\n+  if (_callprojs.fallthrough_catchproj != NULL) {\n+    migrate_outs(_callprojs.fallthrough_catchproj, ctrl);\n+    _igvn.remove_dead_node(_callprojs.fallthrough_catchproj);\n@@ -1572,3 +1517,3 @@\n-  if (_catchallcatchproj != NULL) {\n-    _igvn.rehash_node_delayed(_catchallcatchproj);\n-    _catchallcatchproj->set_req(0, top());\n+  if (_callprojs.catchall_catchproj != NULL) {\n+    _igvn.rehash_node_delayed(_callprojs.catchall_catchproj);\n+    _callprojs.catchall_catchproj->set_req(0, top());\n@@ -1576,2 +1521,2 @@\n-  if (_fallthroughproj != NULL) {\n-    Node* catchnode = _fallthroughproj->unique_ctrl_out();\n+  if (_callprojs.fallthrough_proj != NULL) {\n+    Node* catchnode = _callprojs.fallthrough_proj->unique_ctrl_out();\n@@ -1579,1 +1524,1 @@\n-    _igvn.remove_dead_node(_fallthroughproj);\n+    _igvn.remove_dead_node(_callprojs.fallthrough_proj);\n@@ -1581,3 +1526,3 @@\n-  if (_memproj_fallthrough != NULL) {\n-    migrate_outs(_memproj_fallthrough, mem);\n-    _igvn.remove_dead_node(_memproj_fallthrough);\n+  if (_callprojs.fallthrough_memproj != NULL) {\n+    migrate_outs(_callprojs.fallthrough_memproj, mem);\n+    _igvn.remove_dead_node(_callprojs.fallthrough_memproj);\n@@ -1585,3 +1530,3 @@\n-  if (_ioproj_fallthrough != NULL) {\n-    migrate_outs(_ioproj_fallthrough, i_o);\n-    _igvn.remove_dead_node(_ioproj_fallthrough);\n+  if (_callprojs.fallthrough_ioproj != NULL) {\n+    migrate_outs(_callprojs.fallthrough_ioproj, i_o);\n+    _igvn.remove_dead_node(_callprojs.fallthrough_ioproj);\n@@ -1589,3 +1534,3 @@\n-  if (_memproj_catchall != NULL) {\n-    _igvn.rehash_node_delayed(_memproj_catchall);\n-    _memproj_catchall->set_req(0, top());\n+  if (_callprojs.catchall_memproj != NULL) {\n+    _igvn.rehash_node_delayed(_callprojs.catchall_memproj);\n+    _callprojs.catchall_memproj->set_req(0, top());\n@@ -1593,3 +1538,3 @@\n-  if (_ioproj_catchall != NULL) {\n-    _igvn.rehash_node_delayed(_ioproj_catchall);\n-    _ioproj_catchall->set_req(0, top());\n+  if (_callprojs.catchall_ioproj != NULL) {\n+    _igvn.rehash_node_delayed(_callprojs.catchall_ioproj);\n+    _callprojs.catchall_ioproj->set_req(0, top());\n@@ -2154,1 +2099,1 @@\n-  extract_call_projections(alock);\n+  alock->extract_projections(&_callprojs, false\/*separate_io_proj*\/, false\/*do_asserts*\/);\n@@ -2158,2 +2103,2 @@\n-         _fallthroughproj != NULL &&\n-         _memproj_fallthrough != NULL,\n+         _callprojs.fallthrough_proj != NULL &&\n+         _callprojs.fallthrough_memproj != NULL,\n@@ -2162,2 +2107,2 @@\n-  Node* fallthroughproj = _fallthroughproj;\n-  Node* memproj_fallthrough = _memproj_fallthrough;\n+  Node* fallthroughproj = _callprojs.fallthrough_proj;\n+  Node* memproj_fallthrough = _callprojs.fallthrough_memproj;\n@@ -2417,1 +2362,1 @@\n-  extract_call_projections(call);\n+  call->extract_projections(&_callprojs, false\/*separate_io_proj*\/, false\/*do_asserts*\/);\n@@ -2423,2 +2368,2 @@\n-  assert ( _ioproj_fallthrough == NULL && _ioproj_catchall == NULL &&\n-           _memproj_catchall == NULL && _catchallcatchproj == NULL, \"Unexpected projection from Lock\");\n+  assert ( _callprojs.fallthrough_ioproj == NULL && _callprojs.catchall_ioproj == NULL &&\n+           _callprojs.catchall_memproj == NULL && _callprojs.catchall_catchproj == NULL, \"Unexpected projection from Lock\");\n@@ -2429,1 +2374,1 @@\n-  Node *slow_ctrl = _fallthroughproj->clone();\n+  Node *slow_ctrl = _callprojs.fallthrough_proj->clone();\n@@ -2431,2 +2376,2 @@\n-  _igvn.hash_delete(_fallthroughproj);\n-  _fallthroughproj->disconnect_inputs(C);\n+  _igvn.hash_delete(_callprojs.fallthrough_proj);\n+  _callprojs.fallthrough_proj->disconnect_inputs(C);\n@@ -2436,1 +2381,1 @@\n-  _igvn.replace_node(_fallthroughproj, region);\n+  _igvn.replace_node(_callprojs.fallthrough_proj, region);\n@@ -2441,1 +2386,1 @@\n-  _igvn.replace_node(_memproj_fallthrough, mem_phi);\n+  _igvn.replace_node(_callprojs.fallthrough_memproj, mem_phi);\n@@ -2488,4 +2433,3 @@\n-  extract_call_projections(call);\n-\n-  assert ( _ioproj_fallthrough == NULL && _ioproj_catchall == NULL &&\n-           _memproj_catchall == NULL && _catchallcatchproj == NULL, \"Unexpected projection from Lock\");\n+  call->extract_projections(&_callprojs, false\/*separate_io_proj*\/, false\/*do_asserts*\/);\n+  assert ( _callprojs.fallthrough_ioproj == NULL && _callprojs.catchall_ioproj == NULL &&\n+           _callprojs.catchall_memproj == NULL && _callprojs.catchall_catchproj == NULL, \"Unexpected projection from Lock\");\n@@ -2497,1 +2441,1 @@\n-  Node *slow_ctrl = _fallthroughproj->clone();\n+  Node *slow_ctrl = _callprojs.fallthrough_proj->clone();\n@@ -2499,2 +2443,2 @@\n-  _igvn.hash_delete(_fallthroughproj);\n-  _fallthroughproj->disconnect_inputs(C);\n+  _igvn.hash_delete(_callprojs.fallthrough_proj);\n+  _callprojs.fallthrough_proj->disconnect_inputs(C);\n@@ -2504,1 +2448,1 @@\n-  _igvn.replace_node(_fallthroughproj, region);\n+  _igvn.replace_node(_callprojs.fallthrough_proj, region);\n@@ -2510,1 +2454,1 @@\n-  _igvn.replace_node(_memproj_fallthrough, mem_phi);\n+  _igvn.replace_node(_callprojs.fallthrough_memproj, mem_phi);\n","filename":"src\/hotspot\/share\/opto\/macro.cpp","additions":102,"deletions":158,"binary":false,"changes":260,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2005, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2005, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -85,8 +85,1 @@\n-  ProjNode *_fallthroughproj;\n-  ProjNode *_fallthroughcatchproj;\n-  ProjNode *_ioproj_fallthrough;\n-  ProjNode *_ioproj_catchall;\n-  ProjNode *_catchallcatchproj;\n-  ProjNode *_memproj_fallthrough;\n-  ProjNode *_memproj_catchall;\n-  ProjNode *_resproj;\n+  CallProjections _callprojs;\n@@ -202,1 +195,0 @@\n-  void extract_call_projections(CallNode *call);\n","filename":"src\/hotspot\/share\/opto\/macro.hpp","additions":2,"deletions":10,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -829,3 +829,3 @@\n-  _igvn.replace_node(_memproj_fallthrough, out_mem);\n-  _igvn.replace_node(_ioproj_fallthrough, *io);\n-  _igvn.replace_node(_fallthroughcatchproj, *ctrl);\n+  _igvn.replace_node(_callprojs.fallthrough_memproj, out_mem);\n+  _igvn.replace_node(_callprojs.fallthrough_ioproj, *io);\n+  _igvn.replace_node(_callprojs.fallthrough_catchproj, *ctrl);\n@@ -1077,2 +1077,2 @@\n-  extract_call_projections(call);\n-  *ctrl = _fallthroughcatchproj->clone();\n+  call->extract_projections(&_callprojs, false\/*separate_io_proj*\/, false\/*do_asserts*\/);\n+  *ctrl = _callprojs.fallthrough_catchproj->clone();\n@@ -1081,1 +1081,1 @@\n-  Node* m = _memproj_fallthrough->clone();\n+  Node* m = _callprojs.fallthrough_memproj->clone();\n@@ -1094,1 +1094,1 @@\n-  *io = _ioproj_fallthrough->clone();\n+  *io = _callprojs.fallthrough_ioproj->clone();\n@@ -1329,3 +1329,3 @@\n-    _igvn.replace_node(_memproj_fallthrough, merge_mem);\n-    _igvn.replace_node(_ioproj_fallthrough, io);\n-    _igvn.replace_node(_fallthroughcatchproj, ctrl);\n+    _igvn.replace_node(_callprojs.fallthrough_memproj, merge_mem);\n+    _igvn.replace_node(_callprojs.fallthrough_ioproj, io);\n+    _igvn.replace_node(_callprojs.fallthrough_catchproj, ctrl);\n","filename":"src\/hotspot\/share\/opto\/macroArrayCopy.cpp","additions":10,"deletions":10,"binary":false,"changes":20,"status":"modified"}]}