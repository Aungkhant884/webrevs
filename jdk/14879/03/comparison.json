{"files":[{"patch":"@@ -264,1 +264,2 @@\n-    sort_symbols_and_fix_hash();\n+    log_info(cds)(\"Sorting symbols ... \");\n+    _symbols->sort(compare_symbols_by_address);\n@@ -282,10 +283,0 @@\n-void ArchiveBuilder::sort_symbols_and_fix_hash() {\n-  log_info(cds)(\"Sorting symbols and fixing identity hash ... \");\n-  os::init_random(0x12345678);\n-  _symbols->sort(compare_symbols_by_address);\n-  for (int i = 0; i < _symbols->length(); i++) {\n-    assert(_symbols->at(i)->is_permanent(), \"archived symbols must be permanent\");\n-    _symbols->at(i)->update_identity_hash();\n-  }\n-}\n-\n@@ -648,0 +639,8 @@\n+\n+  \/\/ Update the hash of buffered sorted symbols for static dump so that the symbols have deterministic contents\n+  if (DumpSharedSpaces && (src_info->msotype() == MetaspaceObj::SymbolType)) {\n+    Symbol* buffered_symbol = (Symbol*)dest;\n+    assert(((Symbol*)src)->is_permanent(), \"archived symbols must be permanent\");\n+    buffered_symbol->update_identity_hash();\n+  }\n+\n","filename":"src\/hotspot\/share\/cds\/archiveBuilder.cpp","additions":10,"deletions":11,"binary":false,"changes":21,"status":"modified"},{"patch":"@@ -244,1 +244,0 @@\n-  void sort_symbols_and_fix_hash();\n","filename":"src\/hotspot\/share\/cds\/archiveBuilder.hpp","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -136,1 +136,4 @@\n-KlassToOopHandleTable* HeapShared::_scratch_java_mirror_table = nullptr;\n+MetaspaceObjToOopHandleTable* HeapShared::_scratch_java_mirror_table = nullptr;\n+MetaspaceObjToOopHandleTable* HeapShared::_scratch_references_table = nullptr;\n+ClassLoaderData* HeapShared::_saved_java_platform_loader_data = nullptr;\n+ClassLoaderData* HeapShared::_saved_java_system_loader_data = nullptr;\n@@ -301,1 +304,1 @@\n-      \/\/ class_data will be restored explicitly at run time.\n+      \/\/ class_data will be restored explicitly at run time and after dumptime\n@@ -305,0 +308,5 @@\n+      if (obj == SystemDictionary::java_platform_loader()) {\n+        _saved_java_platform_loader_data = java_lang_ClassLoader::loader_data_acquire(SystemDictionary::java_platform_loader());\n+      } else if (obj == SystemDictionary::java_system_loader()) {\n+        _saved_java_system_loader_data = java_lang_ClassLoader::loader_data_acquire(SystemDictionary::java_system_loader());\n+      }\n@@ -312,1 +320,7 @@\n-class KlassToOopHandleTable: public ResourceHashtable<Klass*, OopHandle,\n+void HeapShared::restore_loader_data() {\n+  log_info(cds)(\"Restoring java platform and system loaders\");\n+  java_lang_ClassLoader::release_set_loader_data(SystemDictionary::java_platform_loader(), _saved_java_platform_loader_data);\n+  java_lang_ClassLoader::release_set_loader_data(SystemDictionary::java_system_loader(), _saved_java_system_loader_data);\n+}\n+\n+class MetaspaceObjToOopHandleTable: public ResourceHashtable<MetaspaceObj*, OopHandle,\n@@ -317,1 +331,1 @@\n-  oop get_oop(Klass* k) {\n+  oop get_oop(MetaspaceObj* ptr) {\n@@ -319,1 +333,1 @@\n-    OopHandle* handle = get(k);\n+    OopHandle* handle = get(ptr);\n@@ -326,1 +340,1 @@\n-  void set_oop(Klass* k, oop o) {\n+  void set_oop(MetaspaceObj* ptr, oop o) {\n@@ -329,1 +343,1 @@\n-    bool is_new = put(k, handle);\n+    bool is_new = put(ptr, handle);\n@@ -332,1 +346,1 @@\n-  void remove_oop(Klass* k) {\n+  void remove_oop(MetaspaceObj* ptr) {\n@@ -334,1 +348,1 @@\n-    OopHandle* handle = get(k);\n+    OopHandle* handle = get(ptr);\n@@ -337,1 +351,1 @@\n-      remove(k);\n+      remove(ptr);\n@@ -342,0 +356,8 @@\n+void HeapShared::add_scratch_resolved_references(ConstantPool* src, objArrayOop dest) {\n+  _scratch_references_table->set_oop(src, dest);\n+}\n+\n+objArrayOop HeapShared::scratch_resolved_references(ConstantPool* src) {\n+  return (objArrayOop)_scratch_references_table->get_oop(src);\n+}\n+\n@@ -350,1 +372,2 @@\n-  _scratch_java_mirror_table = new (mtClass)KlassToOopHandleTable();\n+  _scratch_java_mirror_table = new (mtClass)MetaspaceObjToOopHandleTable();\n+  _scratch_references_table = new (mtClass)MetaspaceObjToOopHandleTable();\n@@ -369,0 +392,3 @@\n+  if (k->is_instance_klass()) {\n+    _scratch_references_table->remove(InstanceKlass::cast(k)->constants());\n+  }\n","filename":"src\/hotspot\/share\/cds\/heapShared.cpp","additions":37,"deletions":11,"binary":false,"changes":48,"status":"modified"},{"patch":"@@ -46,1 +46,1 @@\n-class KlassToOopHandleTable;\n+class MetaspaceObjToOopHandleTable;\n@@ -283,1 +283,5 @@\n-  static KlassToOopHandleTable* _scratch_java_mirror_table;\n+  static MetaspaceObjToOopHandleTable* _scratch_java_mirror_table;\n+  static MetaspaceObjToOopHandleTable* _scratch_references_table;\n+\n+  static ClassLoaderData* _saved_java_platform_loader_data;\n+  static ClassLoaderData* _saved_java_system_loader_data;\n@@ -397,0 +401,2 @@\n+  static objArrayOop scratch_resolved_references(ConstantPool* src);\n+  static void add_scratch_resolved_references(ConstantPool* src, objArrayOop dest) NOT_CDS_JAVA_HEAP_RETURN;\n@@ -398,0 +404,1 @@\n+  static void restore_loader_data() NOT_CDS_JAVA_HEAP_RETURN;\n","filename":"src\/hotspot\/share\/cds\/heapShared.hpp","additions":9,"deletions":2,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -506,0 +506,3 @@\n+  \/\/ Initialize random for updating the hash of symbols\n+  os::init_random(0x12345678);\n+\n@@ -546,2 +549,0 @@\n-\n-  MetaspaceShared::exit_after_static_dump();\n@@ -664,4 +665,0 @@\n-  } else {\n-    \/\/ On success, the VM_PopulateDumpSharedSpace op should have\n-    \/\/ exited the VM.\n-    ShouldNotReachHere();\n@@ -669,0 +666,7 @@\n+\n+#if INCLUDE_CDS_JAVA_HEAP\n+  \/\/ Restore the java loaders that were cleared at dump time\n+  if (use_full_module_graph()) {\n+    HeapShared::restore_loader_data();\n+  }\n+#endif\n@@ -899,8 +903,0 @@\n-\/\/ We have finished dumping the static archive. At this point, there may be pending VM\n-\/\/ operations. We have changed some global states (such as vmClasses::_klasses) that\n-\/\/ may cause these VM operations to fail. For safety, forget these operations and\n-\/\/ exit the VM directly.\n-void MetaspaceShared::exit_after_static_dump() {\n-  os::_exit(0);\n-}\n-\n","filename":"src\/hotspot\/share\/cds\/metaspaceShared.cpp","additions":10,"deletions":14,"binary":false,"changes":24,"status":"modified"},{"patch":"@@ -108,1 +108,0 @@\n-  static void exit_after_static_dump();\n","filename":"src\/hotspot\/share\/cds\/metaspaceShared.hpp","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -219,0 +219,6 @@\n+\n+    \/\/ Create a \"scratch\" copy of the resolved references array to archive\n+    if (DumpSharedSpaces) {\n+      objArrayOop scratch_references = oopFactory::new_objArray(vmClasses::Object_klass(), map_length, CHECK);\n+      HeapShared::add_scratch_resolved_references(this, scratch_references);\n+    }\n@@ -289,0 +295,2 @@\n+    ConstantPool* orig_pool = ArchiveBuilder::current()->get_source_addr(this);\n+    objArrayOop scratch_rr = HeapShared::scratch_resolved_references(orig_pool);\n@@ -294,1 +302,1 @@\n-      rr->obj_at_put(i, nullptr);\n+      scratch_rr->obj_at_put(i, nullptr);\n@@ -300,1 +308,1 @@\n-            rr->obj_at_put(i, obj);\n+            scratch_rr->obj_at_put(i, nullptr);\n@@ -305,0 +313,1 @@\n+    return scratch_rr;\n","filename":"src\/hotspot\/share\/oops\/constantPool.cpp","additions":11,"deletions":2,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -817,1 +817,0 @@\n-    ShouldNotReachHere();\n","filename":"src\/hotspot\/share\/runtime\/threads.cpp","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -88,0 +88,1 @@\n+static jboolean dumpSharedSpaces = JNI_FALSE; \/* -Xshare:dump *\/\n@@ -458,0 +459,8 @@\n+    \/*\n+     * -Xshare:dump does not have a main class so the VM can safely exit now\n+     *\/\n+    if (dumpSharedSpaces) {\n+        CHECK_EXCEPTION_LEAVE(1);\n+        LEAVE();\n+    }\n+\n@@ -1435,0 +1444,7 @@\n+\n+        \/*\n+        * Check for CDS option\n+        *\/\n+        if (JLI_StrCmp(arg, \"-Xshare:dump\") == 0) {\n+            dumpSharedSpaces = JNI_TRUE;\n+        }\n@@ -1443,1 +1459,1 @@\n-        if (!listModules && !describeModule && !validateModules) {\n+        if (!listModules && !describeModule && !validateModules && !dumpSharedSpaces) {\n","filename":"src\/java.base\/share\/native\/libjli\/java.c","additions":17,"deletions":1,"binary":false,"changes":18,"status":"modified"}]}