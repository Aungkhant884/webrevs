{"files":[{"patch":"@@ -262,1 +262,2 @@\n-    sort_symbols_and_fix_hash();\n+    log_info(cds)(\"Sorting symbols and fixing identity hash ... \");\n+    _symbols->sort(compare_symbols_by_address);\n@@ -280,10 +281,0 @@\n-void ArchiveBuilder::sort_symbols_and_fix_hash() {\n-  log_info(cds)(\"Sorting symbols and fixing identity hash ... \");\n-  os::init_random(0x12345678);\n-  _symbols->sort(compare_symbols_by_address);\n-  for (int i = 0; i < _symbols->length(); i++) {\n-    assert(_symbols->at(i)->is_permanent(), \"archived symbols must be permanent\");\n-    _symbols->at(i)->update_identity_hash();\n-  }\n-}\n-\n@@ -646,0 +637,8 @@\n+\n+  \/\/ Update the hash of buffered sorted symbols for static dump\n+  if (DumpSharedSpaces && (src_info->msotype() == MetaspaceObj::SymbolType)) {\n+    Symbol* buffered_symbol = (Symbol*)dest;\n+    assert(((Symbol*)src)->is_permanent(), \"archived symbols must be permanent\");\n+    buffered_symbol->update_identity_hash();\n+  }\n+\n","filename":"src\/hotspot\/share\/cds\/archiveBuilder.cpp","additions":10,"deletions":11,"binary":false,"changes":21,"status":"modified"},{"patch":"@@ -244,1 +244,0 @@\n-  void sort_symbols_and_fix_hash();\n","filename":"src\/hotspot\/share\/cds\/archiveBuilder.hpp","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -137,0 +137,1 @@\n+HeapShared::ResolvedReferenceScratchTable* HeapShared::_scratch_references_table = nullptr;\n@@ -342,0 +343,23 @@\n+void HeapShared::init_scratch_references() {\n+  if (_scratch_references_table == nullptr)\n+    _scratch_references_table = new (mtClass)ResolvedReferenceScratchTable();\n+}\n+\n+void HeapShared::add_scratch_resolved_reference(intptr_t src, int index, oop new_result) {\n+  MutexLocker ml(ScratchObjects_lock, Mutex::_no_safepoint_check_flag);\n+  OopHandle* scratch_handle = _scratch_references_table->get(src);\n+  objArrayOop scratch = (objArrayOop)(scratch_handle->resolve());\n+  scratch->obj_at_put(index, new_result);\n+}\n+\n+void HeapShared::add_scratch_resolved_references(intptr_t src, OopHandle dest) {\n+  assert(_scratch_references_table != nullptr, \"must be initialized\");\n+  MutexLocker ml(ScratchObjects_lock, Mutex::_no_safepoint_check_flag);\n+  _scratch_references_table->put(src, dest);\n+}\n+\n+OopHandle HeapShared::scratch_resolved_references(intptr_t src) {\n+  MutexLocker ml(ScratchObjects_lock, Mutex::_no_safepoint_check_flag);\n+  return *(_scratch_references_table->get(src));\n+}\n+\n","filename":"src\/hotspot\/share\/cds\/heapShared.cpp","additions":24,"deletions":0,"binary":false,"changes":24,"status":"modified"},{"patch":"@@ -285,0 +285,6 @@\n+  typedef ResourceHashtable<intptr_t, OopHandle,\n+    36137, \/\/ prime number\n+    AnyObj::C_HEAP,\n+    mtClassShared> ResolvedReferenceScratchTable;\n+  static ResolvedReferenceScratchTable* _scratch_references_table;\n+\n@@ -396,0 +402,4 @@\n+  static void init_scratch_references() NOT_CDS_JAVA_HEAP_RETURN;\n+  static OopHandle scratch_resolved_references(intptr_t src);\n+  static void add_scratch_resolved_reference(intptr_t src, int index, oop new_result) NOT_CDS_JAVA_HEAP_RETURN;\n+  static void add_scratch_resolved_references(intptr_t src, OopHandle dest) NOT_CDS_JAVA_HEAP_RETURN;\n","filename":"src\/hotspot\/share\/cds\/heapShared.hpp","additions":10,"deletions":0,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -506,0 +506,3 @@\n+  \/\/ Initialize random for updating the hash of symbols\n+  os::init_random(0x12345678);\n+\n@@ -546,2 +549,0 @@\n-\n-  MetaspaceShared::exit_after_static_dump();\n@@ -664,4 +665,0 @@\n-  } else {\n-    \/\/ On success, the VM_PopulateDumpSharedSpace op should have\n-    \/\/ exited the VM.\n-    ShouldNotReachHere();\n@@ -899,8 +896,0 @@\n-\/\/ We have finished dumping the static archive. At this point, there may be pending VM\n-\/\/ operations. We have changed some global states (such as vmClasses::_klasses) that\n-\/\/ may cause these VM operations to fail. For safety, forget these operations and\n-\/\/ exit the VM directly.\n-void MetaspaceShared::exit_after_static_dump() {\n-  os::_exit(0);\n-}\n-\n","filename":"src\/hotspot\/share\/cds\/metaspaceShared.cpp","additions":3,"deletions":14,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -108,1 +108,0 @@\n-  static void exit_after_static_dump();\n","filename":"src\/hotspot\/share\/cds\/metaspaceShared.hpp","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -1082,2 +1082,4 @@\n-  guarantee(this == class_loader_data(cl) || has_class_mirror_holder(), \"Must be the same\");\n-  guarantee(cl != nullptr || this == ClassLoaderData::the_null_class_loader_data() || has_class_mirror_holder(), \"must be\");\n+  if (!DumpSharedSpaces) {\n+    guarantee(this == class_loader_data(cl) || has_class_mirror_holder(), \"Must be the same\");\n+    guarantee(cl != nullptr || this == ClassLoaderData::the_null_class_loader_data() || has_class_mirror_holder(), \"must be\");\n+  }\n","filename":"src\/hotspot\/share\/classfile\/classLoaderData.cpp","additions":4,"deletions":2,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -219,0 +219,9 @@\n+\n+    \/\/ Create a \"scratch\" copy of the resolved references array to archive\n+    if (DumpSharedSpaces) {\n+      HeapShared::init_scratch_references();\n+      objArrayOop scratch_references = oopFactory::new_objArray(vmClasses::Object_klass(), map_length, CHECK);\n+      HandleMark hm(THREAD);\n+      Handle scratch_handle(THREAD, scratch_references);\n+      HeapShared::add_scratch_resolved_references(resolved_references()->identity_hash(), loader_data->add_handle(scratch_handle));\n+    }\n@@ -289,0 +298,1 @@\n+    intptr_t hash = rr->identity_hash();\n@@ -294,1 +304,1 @@\n-      rr->obj_at_put(i, nullptr);\n+      HeapShared::add_scratch_resolved_reference(hash, i, nullptr);\n@@ -300,1 +310,1 @@\n-            rr->obj_at_put(i, obj);\n+            HeapShared::add_scratch_resolved_reference(hash, i, obj);\n@@ -305,0 +315,2 @@\n+    OopHandle handle = HeapShared::scratch_resolved_references(rr->identity_hash());\n+    return (objArrayOop)(handle.resolve());\n","filename":"src\/hotspot\/share\/oops\/constantPool.cpp","additions":14,"deletions":2,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -812,1 +812,1 @@\n-    ShouldNotReachHere();\n+    *canTryAgain = false; \/\/ don't let caller call JNI_CreateJavaVM again\n","filename":"src\/hotspot\/share\/runtime\/threads.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -88,0 +88,1 @@\n+static jboolean dumpSharedSpaces = JNI_FALSE; \/* -Xshare:dump *\/\n@@ -458,0 +459,8 @@\n+    \/*\n+     * -Xshare:dump does not have a main class so the VM can safely exit now\n+     *\/\n+    if (dumpSharedSpaces) {\n+      CHECK_EXCEPTION_LEAVE(0);\n+      LEAVE();\n+    }\n+\n@@ -1435,0 +1444,7 @@\n+\n+\/*\n+ * Check for CDS option\n+ *\/\n+        if (JLI_StrCmp(arg, \"-Xshare:dump\") == 0) {\n+          dumpSharedSpaces = JNI_TRUE;\n+        }\n@@ -1443,1 +1459,1 @@\n-        if (!listModules && !describeModule && !validateModules) {\n+        if (!listModules && !describeModule && !validateModules && !dumpSharedSpaces) {\n","filename":"src\/java.base\/share\/native\/libjli\/java.c","additions":17,"deletions":1,"binary":false,"changes":18,"status":"modified"}]}