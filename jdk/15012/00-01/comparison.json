{"files":[{"patch":"@@ -242,0 +242,12 @@\n+        \/**\n+         * Cancels this event. Should be called with stateLock held\n+         *\/\n+        void cancel() {\n+            assert stateLock.isHeldByCurrentThread() : \"Current thread doesn't hold \" + stateLock;\n+            \/\/ mark as cancelled to prevent potentially already triggered event from actually\n+            \/\/ doing the shutdown\n+            this.cancelled = true;\n+            \/\/ cancel the timer to prevent the event from being triggered (if it hasn't already)\n+            client().cancelTimer(this);\n+        }\n+\n@@ -322,1 +334,1 @@\n-    private final Lock stateLock = new ReentrantLock();\n+    private final ReentrantLock stateLock = new ReentrantLock();\n@@ -1022,4 +1034,1 @@\n-        final int closedSt = closedState;\n-        return !isMarked(closedSt, IDLE_SHUTDOWN_INITIATED)\n-                && !isMarked(closedSt, SHUTDOWN_REQUESTED)\n-                && connection.channel().isOpen();\n+        return !isMarkedForShutdown() && connection.channel().isOpen();\n@@ -1330,5 +1339,1 @@\n-                \/\/ mark as cancelled to prevent potentially already triggered event from actually\n-                \/\/ doing the shutdown\n-                idleTimeoutEvent.cancelled = true;\n-                \/\/ cancel the timer to prevent the event from being triggered (if it hasn't already)\n-                client().cancelTimer(idleTimeoutEvent);\n+                idleTimeoutEvent.cancel();\n@@ -1350,1 +1355,1 @@\n-            if (!isMarked(closedState, SHUTDOWN_REQUESTED)) {\n+            if (!isMarkedForShutdown()) {\n@@ -1359,1 +1364,0 @@\n-                    client().cancelTimer(idleTimeoutEvent);\n@@ -1361,0 +1365,1 @@\n+                    idleTimeoutEvent.cancel();\n@@ -1725,0 +1730,6 @@\n+    private boolean isMarkedForShutdown() {\n+        final int closedSt = closedState;\n+        return isMarked(closedSt, IDLE_SHUTDOWN_INITIATED)\n+                || isMarked(closedSt, SHUTDOWN_REQUESTED);\n+    }\n+\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/Http2Connection.java","additions":23,"deletions":12,"binary":false,"changes":35,"status":"modified"}]}