{"files":[{"patch":"@@ -28,1 +28,15 @@\n-      echo \"usage: $0 [-h|--help] [-v|--verbose] [-o|--output <path>] [modules]+\"\n+      echo \"Usage: $0 [-h|--help] [-q|--quiet] [-a|--absolute-paths] [-o|--output <path>] [modules...]\"\n+      echo \"    -h | --help\"\n+      echo \"    -q | --quiet\n+        No stdout output\"\n+      echo \"    -a | --absolute-paths\n+        Use absolute paths to this jdk, so that generated .idea\n+        project files can be moved independently of jdk sources\"\n+      echo \"    -o | --output <path>\n+        Where .idea directory with project files will be generated\n+        (e.g. using '-o .' will place project files in '.\/.idea')\n+        Default: $TOPLEVEL_DIR\"\n+      echo \"    [modules...]\n+        Generate project modules for specific java modules\n+        (e.g. 'java.base java.desktop')\n+        Default: all existing modules (java.* and jdk.*)\"\n@@ -36,0 +50,1 @@\n+cd .. ; TOPLEVEL_DIR=`pwd`\n@@ -38,3 +53,3 @@\n-IDEA_OUTPUT=$TOP\/.idea\n-CUSTOM_IDEA_OUTPUT=false\n-VERBOSE=\"false\"\n+IDEA_OUTPUT=$TOPLEVEL_DIR\/.idea\n+VERBOSE=true\n+ABSOLUTE_PATHS=false\n@@ -48,2 +63,6 @@\n-    -v | --vebose )\n-      VERBOSE=\"true\"\n+    -q | --quiet )\n+      VERBOSE=false\n+      ;;\n+\n+    -a | --absolute-paths )\n+      ABSOLUTE_PATHS=true\n@@ -54,1 +73,0 @@\n-      CUSTOM_IDEA_OUTPUT=true\n@@ -71,0 +89,1 @@\n+cd ..; IDEA_OUTPUT_PARENT=`pwd`\n@@ -72,7 +91,1 @@\n-if [ \"x$TOPLEVEL_DIR\" = \"x\" ] ; then\n-    cd $SCRIPT_DIR\/..\n-    TOPLEVEL_DIR=`pwd`\n-    cd $IDEA_OUTPUT\n-fi\n-\n-MAKE_DIR=\"$SCRIPT_DIR\/..\/make\"\n+MAKE_DIR=\"$TOPLEVEL_DIR\/make\"\n@@ -91,3 +104,2 @@\n-if [ \"$VERBOSE\" = \"true\" ] ; then\n-  echo \"output dir: $IDEA_OUTPUT\"\n-  echo \"idea template dir: $IDEA_TEMPLATE\"\n+if [ \"$VERBOSE\" = true ] ; then\n+  echo \"Will generate IDEA project files in \\\"$IDEA_OUTPUT\\\" for project \\\"$TOPLEVEL_DIR\\\"\"\n@@ -96,1 +108,2 @@\n-cd $TOP ; make -f \"$IDEA_MAKE\/idea.gmk\" -I $MAKE_DIR\/.. idea MAKEOVERRIDES= OUT=$IDEA_OUTPUT\/env.cfg MODULES=\"$*\" || exit 1\n+cd $TOP ; make -f \"$IDEA_MAKE\/idea.gmk\" -I \"$TOPLEVEL_DIR\" idea \\\n+    MAKEOVERRIDES= IDEA_OUTPUT_PARENT=\"$IDEA_OUTPUT_PARENT\" OUT=\"$IDEA_OUTPUT\/env.cfg\" MODULES=\"$*\" || exit 1\n@@ -101,1 +114,1 @@\n-# Expect MODULES, MODULE_NAMES, BOOT_JDK & SPEC to be set\n+# Expect MODULES, MODULE_NAMES, RELATIVE_PROJECT_DIR, RELATIVE_BUILD_DIR to be set\n@@ -110,2 +123,2 @@\n-if [ \"x$BOOT_JDK\" = \"x\" ] ; then\n-  echo \"FATAL: BOOT_JDK is empty\" >&2; exit 1\n+if [ \"x$RELATIVE_PROJECT_DIR\" = \"x\" ] ; then\n+  echo \"FATAL: RELATIVE_PROJECT_DIR is empty\" >&2; exit 1\n@@ -114,2 +127,2 @@\n-if [ \"x$SPEC\" = \"x\" ] ; then\n-  echo \"FATAL: SPEC is empty\" >&2; exit 1\n+if [ \"x$RELATIVE_BUILD_DIR\" = \"x\" ] ; then\n+  echo \"FATAL: RELATIVE_BUILD_DIR is empty\" >&2; exit 1\n@@ -126,0 +139,23 @@\n+if [ \"$ABSOLUTE_PATHS\" = true ] ; then\n+  if [ \"x$PATHTOOL\" != \"x\" ]; then\n+    PROJECT_DIR=\"`$PATHTOOL -am $TOPLEVEL_DIR`\"\n+  else\n+    PROJECT_DIR=\"$TOPLEVEL_DIR\"\n+  fi\n+  MODULE_DIR=\"$PROJECT_DIR\"\n+  cd \"$TOPLEVEL_DIR\" && cd \"$RELATIVE_BUILD_DIR\" && BUILD_DIR=\"`pwd`\"\n+else\n+  if [ \"$RELATIVE_PROJECT_DIR\" = \".\" ] ; then\n+    PROJECT_DIR=\"\"\n+  else\n+    PROJECT_DIR=\"\/$RELATIVE_PROJECT_DIR\"\n+  fi\n+  MODULE_DIR=\"\\$MODULE_DIR\\$$PROJECT_DIR\"\n+  PROJECT_DIR=\"\\$PROJECT_DIR\\$$PROJECT_DIR\"\n+  BUILD_DIR=\"\\$PROJECT_DIR\\$\/$RELATIVE_BUILD_DIR\"\n+fi\n+if [ \"$VERBOSE\" = true ] ; then\n+  echo \"Project root: $PROJECT_DIR\"\n+  echo \"Generating IDEA project files...\"\n+fi\n+\n@@ -149,0 +185,2 @@\n+add_replacement \"###PROJECT_DIR###\" \"$PROJECT_DIR\"\n+add_replacement \"###MODULE_DIR###\" \"$MODULE_DIR\"\n@@ -151,4 +189,1 @@\n-SPEC_DIR=`dirname $SPEC`\n-RELATIVE_SPEC_DIR=\"`realpath --relative-to=\\\"$TOPLEVEL_DIR\\\" \\\"$SPEC_DIR\\\"`\"\n-add_replacement \"###BUILD_DIR###\" \"$RELATIVE_SPEC_DIR\"\n-add_replacement \"###IMAGES_DIR###\" \"$RELATIVE_SPEC_DIR\/images\/jdk\"\n+add_replacement \"###BUILD_DIR###\" \"$BUILD_DIR\"\n@@ -156,5 +191,1 @@\n-  if [ \"$CUSTOM_IDEA_OUTPUT\" = true ]; then\n-    add_replacement \"###BASH_RUNNER_PREFIX###\" \"`$PATHTOOL -am $IDEA_OUTPUT\/.idea\/bash.bat`\"\n-  else\n-    add_replacement \"###BASH_RUNNER_PREFIX###\" \".idea\\\\\\\\bash.bat\"\n-  fi\n+  add_replacement \"###BASH_RUNNER_PREFIX###\" \"\\$PROJECT_DIR\\$\/.idea\/bash.bat\"\n@@ -187,0 +218,3 @@\n+if [ \"$VERBOSE\" = true ] ; then\n+    echo \"Generating project modules:\"\n+  fi\n@@ -190,5 +224,0 @@\n-if [ \"x$PATHTOOL\" != \"x\" ]; then\n-  TOPDIR_FOR_RELATIVITY_CHECKS=\"`echo \\\"$TOPLEVEL_DIR\\\" | tr '[:upper:]' '[:lower:]'`\"\n-else\n-  TOPDIR_FOR_RELATIVITY_CHECKS=\"$TOPLEVEL_DIR\"\n-fi\n@@ -198,2 +227,2 @@\n-  if [ \"$VERBOSE\" = \"true\" ] ; then\n-    echo \"generating project module: $module\"\n+  if [ \"$VERBOSE\" = true ] ; then\n+    echo \"    $module\"\n@@ -201,1 +230,1 @@\n-  add_replacement \"###MODULE_DIR###\" \"src\/$module\"\n+  add_replacement \"###MODULE_CONTENT###\" \"src\/$module\"\n@@ -205,4 +234,0 @@\n-    if [ \"x$PATHTOOL\" != \"x\" ]; then\n-      dir=\"`echo \\\"$dir\\\" | tr '[:upper:]' '[:lower:]'`\"\n-    fi\n-    dir=\"`realpath --relative-to=\\\"$TOPDIR_FOR_RELATIVITY_CHECKS\\\" \\\"$dir\\\"`\"\n@@ -210,2 +235,1 @@\n-      \"$SPEC_DIR\"*) ;;\n-      *) SOURCE_DIRS=\"$SOURCE_DIRS<sourceFolder url=\\\"file:\/\/\\$MODULE_DIR\\$\/$dir\\\" isTestSource=\\\"false\\\" \/> \"\n+      \"src\/\"*) SOURCE_DIRS=\"$SOURCE_DIRS<sourceFolder url=\\\"file:\/\/$MODULE_DIR\/$dir\\\" isTestSource=\\\"false\\\" \/> \"\n@@ -217,1 +241,3 @@\n-    DEPENDENCIES=\"$DEPENDENCIES<orderEntry type=\\\"module\\\" module-name=\\\"$dep\\\" \/> \"\n+    case $MODULE_NAMES in # Exclude skipped modules from dependencies\n+      *\"$dep\"*) DEPENDENCIES=\"$DEPENDENCIES<orderEntry type=\\\"module\\\" module-name=\\\"$dep\\\" \/> \"\n+    esac\n","filename":"bin\/idea.sh","additions":73,"deletions":47,"binary":false,"changes":120,"status":"modified"},{"patch":"@@ -95,0 +95,1 @@\n+# On Windows paths are treated as case-insensitive\n@@ -99,6 +100,12 @@\n-    $(patsubst x%,%,$(subst $(SPACE),\/,$(strip \\\n-        $(call FindCommonPathPrefixHelper, \\\n-            $(subst \/,$(SPACE),x$(strip $1)), $(subst \/,$(SPACE),x$(strip $2))) \\\n-    )))\n-\n-FindCommonPathPrefixHelper = \\\n+    $(call DecodeSpace,$(patsubst x%,%,$(subst $(SPACE),\/,$(strip \\\n+        $(call FindCommonPathPrefixHelper1, \\\n+            $(subst \/,$(SPACE),x$(call EncodeSpace,$(strip $1))), \\\n+            $(subst \/,$(SPACE),x$(call EncodeSpace,$(strip $2)))) \\\n+    ))))\n+\n+FindCommonPathPrefixHelper1 = \\\n+    $(if $(filter $(OPENJDK_TARGET_OS), windows), \\\n+        $(call FindCommonPathPrefixHelper2,$(call uppercase,$1),$(call uppercase,$2),$1), \\\n+        $(call FindCommonPathPrefixHelper2,$1,$2,$1))\n+\n+FindCommonPathPrefixHelper2 = \\\n@@ -106,3 +113,7 @@\n-      $(firstword $1) \\\n-      $(call FindCommonPathPrefixHelper, \\\n-          $(wordlist 2, $(words $1), $1), $(wordlist 2, $(words $2), $2) \\\n+      $(if $(call equals, $(firstword $1),),, \\\n+        $(firstword $3) \\\n+        $(call FindCommonPathPrefixHelper2, \\\n+            $(wordlist 2, $(words $1), $1), \\\n+            $(wordlist 2, $(words $2), $2), \\\n+            $(wordlist 2, $(words $3), $3) \\\n+        ) \\\n@@ -112,8 +123,0 @@\n-# Convert a partial path into as many directory levels of ..\/, removing\n-# leading and following \/.\n-# Ex: foo\/bar\/baz\/ -> ..\/..\/..\n-#     foo\/bar -> ..\/..\n-#     \/foo -> ..\n-DirToDotDot = \\\n-    $(subst $(SPACE),\/,$(foreach d, $(subst \/,$(SPACE),$1),..))\n-\n@@ -124,5 +127,20 @@\n-    $(eval $1_prefix := $(call FindCommonPathPrefix, $1, $2)) \\\n-    $(eval $1_dotdots := $(call DirToDotDot, $(patsubst $($(strip $1)_prefix)%, %, $2))) \\\n-    $(eval $1_dotdots := $(if $($(strip $1)_dotdots),$($(strip $1)_dotdots),.)) \\\n-    $(eval $1_suffix := $(patsubst $($(strip $1)_prefix)\/%, %, $1)) \\\n-    $($(strip $1)_dotdots)\/$($(strip $1)_suffix)\n+    $(call DecodeSpace,$(strip $(call RelativePathHelper,$(call EncodeSpace \\\n+        ,$(strip $1)),$(call EncodeSpace \\\n+        ,$(strip $2)),$(call EncodeSpace \\\n+        ,$(call FindCommonPathPrefix,$1,$2)))))\n+\n+RelativePathHelper = \\\n+    $(eval $3_prefix_length := $(words $(subst \/,$(SPACE),$3))) \\\n+    $(eval $1_words := $(subst \/,$(SPACE),$1)) \\\n+    $(eval $2_words := $(subst \/,$(SPACE),$2)) \\\n+    $(if $(call equals,$($3_prefix_length),0),, \\\n+        $(eval $1_words := $(wordlist 2,$(words $($1_words)),$(wordlist \\\n+            $($3_prefix_length),$(words $($1_words)),$($1_words)))) \\\n+        $(eval $2_words := $(wordlist 2,$(words $($2_words)),$(wordlist \\\n+            $($3_prefix_length),$(words $($2_words)),$($2_words)))) \\\n+    ) \\\n+    $(eval $1_suffix := $(subst $(SPACE),\/,$($1_words))) \\\n+    $(eval $2_dotdots := $(subst $(SPACE),\/,$(foreach d,$($2_words),..))) \\\n+    $(if $($1_suffix), \\\n+        $(if $($2_dotdots), $($2_dotdots)\/$($1_suffix), $($1_suffix)), \\\n+        $(if $($2_dotdots), $($2_dotdots), .))\n","filename":"make\/common\/Utils.gmk","additions":40,"deletions":22,"binary":false,"changes":62,"status":"modified"},{"patch":"@@ -49,1 +49,0 @@\n-\t$(ECHO) \"SUPPORT=$(SUPPORT_OUTPUTDIR)\" > $(OUT)\n@@ -52,1 +51,1 @@\n-\t          moduleSrcDirs='$(call FindModuleSrcDirs,$(mod))' \\\n+\t          moduleSrcDirs='$(foreach m,$(call FindModuleSrcDirs,$(mod)),$(call RelativePath,$m,$(topdir)))' \\\n@@ -54,1 +53,1 @@\n-\t        #)\\\"\" >> $(OUT)\n+\t        #)\\\"\" > $(OUT)\n@@ -56,2 +55,2 @@\n-\t$(ECHO) \"SEL_MODULES=\\\"$(SEL_MODULES)\\\"\" >> $(OUT)\n-\t$(ECHO) \"BOOT_JDK=\\\"$(BOOT_JDK)\\\"\" >> $(OUT)\n+\t$(ECHO) \"RELATIVE_PROJECT_DIR=\\\"$(call RelativePath,$(topdir),$(IDEA_OUTPUT_PARENT))\\\"\" >> $(OUT)\n+\t$(ECHO) \"RELATIVE_BUILD_DIR=\\\"$(call RelativePath,$(OUTPUTDIR),$(IDEA_OUTPUT_PARENT))\\\"\" >> $(OUT)\n@@ -59,1 +58,0 @@\n-\t$(ECHO) \"SPEC=\\\"$(SPEC)\\\"\" >> $(OUT)\n","filename":"make\/ide\/idea\/jdk\/idea.gmk","additions":4,"deletions":6,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -6,4 +6,4 @@\n-      <directory url=\"file:\/\/$PROJECT_DIR$\/src\" includeSubdirectories=\"true\" \/>\n-      <directory url=\"file:\/\/$PROJECT_DIR$\/build\" includeSubdirectories=\"true\" \/>\n-      <directory url=\"file:\/\/$PROJECT_DIR$\/make\" includeSubdirectories=\"true\" \/>\n-      <directory url=\"file:\/\/$PROJECT_DIR$\/test\" includeSubdirectories=\"false\" \/>\n+      <directory url=\"file:\/\/###PROJECT_DIR###\/src\" includeSubdirectories=\"true\" \/>\n+      <directory url=\"file:\/\/###PROJECT_DIR###\/build\" includeSubdirectories=\"true\" \/>\n+      <directory url=\"file:\/\/###PROJECT_DIR###\/make\" includeSubdirectories=\"true\" \/>\n+      <directory url=\"file:\/\/###PROJECT_DIR###\/test\" includeSubdirectories=\"false\" \/>\n","filename":"make\/ide\/idea\/jdk\/template\/compiler.xml","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -5,3 +5,3 @@\n-    <content url=\"file:\/\/$MODULE_DIR$\">\n-      <excludeFolder url=\"file:\/\/$MODULE_DIR$\/build\" \/>\n-      <excludeFolder url=\"file:\/\/$MODULE_DIR$\/make\" \/>\n+    <content url=\"file:\/\/###MODULE_DIR###\">\n+      <excludeFolder url=\"file:\/\/###MODULE_DIR###\/build\" \/>\n+      <excludeFolder url=\"file:\/\/###MODULE_DIR###\/make\" \/>\n","filename":"make\/ide\/idea\/jdk\/template\/jdk.iml","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -8,2 +8,2 @@\n-    <workDir>$PROJECT_DIR$\/###BUILD_DIR###<\/workDir>\n-    <jre alt=\"true\" value=\"$PROJECT_DIR$\/###IMAGES_DIR###\" \/>\n+    <workDir>###BUILD_DIR###<\/workDir>\n+    <jre alt=\"true\" value=\"###BUILD_DIR###\/images\/jdk\" \/>\n@@ -11,3 +11,0 @@\n-    <ant>\n-      <target file=\"file:\/\/$PROJECT_DIR$\/make\/ide\/idea\/jdk\/build.xml\" name=\"images\" \/>\n-    <\/ant>\n@@ -16,1 +13,1 @@\n-    <output url=\"file:\/\/$PROJECT_DIR$\/###BUILD_DIR###\/idea\" \/>\n+    <output url=\"file:\/\/###BUILD_DIR###\/idea\" \/>\n","filename":"make\/ide\/idea\/jdk\/template\/misc.xml","additions":3,"deletions":6,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -5,1 +5,1 @@\n-    <content url=\"file:\/\/$MODULE_DIR$\/###MODULE_DIR###\">\n+    <content url=\"file:\/\/###MODULE_DIR###\/###MODULE_CONTENT###\">\n","filename":"make\/ide\/idea\/jdk\/template\/module.iml","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -5,1 +5,1 @@\n-    <content url=\"file:\/\/$MODULE_DIR$\/test\/jdk\"><\/content>\n+    <content url=\"file:\/\/###MODULE_DIR###\/test\/jdk\"><\/content>\n","filename":"make\/ide\/idea\/jdk\/template\/test.iml","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -4,1 +4,1 @@\n-    <mapping directory=\"$PROJECT_DIR$\" vcs=\"###VCS_TYPE###\" \/>\n+    <mapping directory=\"###PROJECT_DIR###\" vcs=\"###VCS_TYPE###\" \/>\n","filename":"make\/ide\/idea\/jdk\/template\/vcs.xml","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -5,1 +5,1 @@\n-    <ignored path=\"$PROJECT_DIR$\/build\/idea\/out\/\" \/>\n+    <ignored path=\"###PROJECT_DIR###\/build\/idea\/out\/\" \/>\n@@ -18,1 +18,1 @@\n-      <option name=\"SCRIPT_WORKING_DIRECTORY\" value=\"$PROJECT_DIR$\" \/>\n+      <option name=\"SCRIPT_WORKING_DIRECTORY\" value=\"###PROJECT_DIR###\" \/>\n@@ -33,1 +33,1 @@\n-      <option name=\"SCRIPT_WORKING_DIRECTORY\" value=\"$PROJECT_DIR$\" \/>\n+      <option name=\"SCRIPT_WORKING_DIRECTORY\" value=\"###PROJECT_DIR###\" \/>\n@@ -48,1 +48,1 @@\n-      <option name=\"SCRIPT_WORKING_DIRECTORY\" value=\"$PROJECT_DIR$\" \/>\n+      <option name=\"SCRIPT_WORKING_DIRECTORY\" value=\"###PROJECT_DIR###\" \/>\n","filename":"make\/ide\/idea\/jdk\/template\/workspace.xml","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -347,9 +347,0 @@\n-################################################################################\n-# DirToDotDot\n-\n-$(call AssertEquals, \\\n-    $(call DirToDotDot, foo\/bar\/baz\/), \\\n-    ..\/..\/.., \\\n-    DirToDotDot, \\\n-)\n-\n@@ -357,3 +348,3 @@\n-    $(call DirToDotDot, foo\/bar), \\\n-    ..\/.., \\\n-    DirToDotDot, \\\n+    $(call FindCommonPathPrefix, \/foo\/bar\/, \/foo\/bar), \\\n+    \/foo\/bar, \\\n+    FindCommonPathPrefix, \\\n@@ -363,3 +354,3 @@\n-    $(call DirToDotDot, \/foo), \\\n-    .., \\\n-    DirToDotDot, \\\n+    $(call FindCommonPathPrefix, \/fo oo\/bar1\/, \/fo oo\/bar2), \\\n+    \/fo oo, \\\n+    FindCommonPathPrefix, \\\n@@ -391,1 +382,1 @@\n-    .\/banan\/kung, \\\n+    banan\/kung, \\\n@@ -397,1 +388,31 @@\n-    .\/banan\/kung, \\\n+    banan\/kung, \\\n+    RelativePath, \\\n+)\n+\n+$(call AssertEquals, \\\n+    $(call RelativePath, \/foo\/bar, \/foo\/bar\/baz), \\\n+    .., \\\n+    RelativePath, \\\n+)\n+\n+$(call AssertEquals, \\\n+    $(call RelativePath, \/foo\/bar\/baz\/, \/foo\/bar\/baz), \\\n+    ., \\\n+    RelativePath, \\\n+)\n+\n+$(call AssertEquals, \\\n+    $(call RelativePath, \/fo oo\/bar\/baz\/ban an, \/fo oo\/bar\/), \\\n+    baz\/ban an, \\\n+    RelativePath, \\\n+)\n+\n+$(call AssertEquals, \\\n+    $(call RelativePath, \/foo\/ba rr\/ba zz, \/foo\/ba rr\/banan), \\\n+    ..\/ba zz, \\\n+    RelativePath, \\\n+)\n+\n+$(call AssertEquals, \\\n+    $(call RelativePath, \/foo, \/bar), \\\n+    ..\/foo, \\\n","filename":"test\/make\/TestMakeBase.gmk","additions":38,"deletions":17,"binary":false,"changes":55,"status":"modified"}]}