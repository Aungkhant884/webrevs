{"files":[{"patch":"@@ -1233,0 +1233,4 @@\n+    \/* Setting this flag is needed by findThread(). It's ok to set it before\n+       the callbacks are cleared.*\/\n+    gdata->jvmtiCallBacksCleared = JNI_TRUE;\n+\n","filename":"src\/jdk.jdwp.agent\/share\/native\/libjdwp\/eventHandler.c","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -257,2 +257,17 @@\n-         * Search runningThreads list. The TLS lookup may have failed because the\n-         * thread has terminated, but the ThreadNode may still be present.\n+         * Normally we can assume that a thread with no TLS will never be in the runningThreads\n+         * list. This is because we always set the TLS when adding to runningThreads.\n+         * However, when a thread exits, its TLS is automatically cleared. Normally this\n+         * is not a problem because the debug agent will first get a THREAD_END event,\n+         * and that will cause the thread to be removed from runningThreads, thus we\n+         * avoid this situation of having a thread in runningThreads, but with no TLS.\n+         *\n+         * However... there is one exception to this. While handling VM_DEATH, the first thing\n+         * the debug agent does is clear all the callbacks. This means we will no longer\n+         * get THREAD_END events as threads exit. This means we might find threads on\n+         * runningThreads with no TLS during VM_DEATH. Essentially the THREAD_END that\n+         * would normally have resulted in removing the thread from runningThreads is\n+         * missed, so the thread remains on runningThreads.\n+         *\n+         * The end result of all this is that if the TLS lookup failed, we still need to check\n+         * if the thread is on runningThreads, but only if JVMTI callbacks have been cleared.\n+         * Otherwise the thread should not be on the runningThreads.\n@@ -260,3 +275,12 @@\n-        if ( node == NULL ) {\n-            if ( list == NULL || list == &runningThreads ) {\n-                node = nonTlsSearch(getEnv(), &runningThreads, thread);\n+        if ( !gdata->jvmtiCallBacksCleared ) {\n+            \/* The thread better not be on runningThreads if the TLS lookup failed. *\/\n+            JDI_ASSERT(!nonTlsSearch(getEnv(), &runningThreads, thread));\n+        } else {\n+            \/*\n+             * Search the runningThreads list. The TLS lookup may have failed because the\n+             * thread has terminated, but we never got the THREAD_END event.\n+             *\/\n+            if ( node == NULL ) {\n+                if ( list == NULL || list == &runningThreads ) {\n+                    node = nonTlsSearch(getEnv(), &runningThreads, thread);\n+                }\n","filename":"src\/jdk.jdwp.agent\/share\/native\/libjdwp\/threadControl.c","additions":29,"deletions":5,"binary":false,"changes":34,"status":"modified"},{"patch":"@@ -136,2 +136,5 @@\n-     \/* Indication that the agent has been loaded *\/\n-     jboolean isLoaded;\n+    \/* Indication that the agent has been loaded *\/\n+    jboolean isLoaded;\n+\n+    \/* Indication that VM_DEATH has been recieved and the JVMTI callbacks have been cleared. *\/\n+    volatile jboolean jvmtiCallBacksCleared;\n","filename":"src\/jdk.jdwp.agent\/share\/native\/libjdwp\/util.h","additions":5,"deletions":2,"binary":false,"changes":7,"status":"modified"}]}