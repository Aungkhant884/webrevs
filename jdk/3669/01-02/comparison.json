{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2000, 2011, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -106,1 +106,1 @@\n-        agent.startServer(pid, serverID);\n+        agent.startServer(pid, serverID, null);\n@@ -110,1 +110,1 @@\n-        agent.startServer(javaExecutableName, coreFileName, serverID);\n+        agent.startServer(javaExecutableName, coreFileName, serverID, null);\n","filename":"src\/jdk.hotspot.agent\/share\/classes\/sun\/jvm\/hotspot\/DebugServer.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -93,0 +93,1 @@\n+    private String serverName;\n@@ -206,1 +207,2 @@\n-                                         String uniqueID,\n+                                         String serverID,\n+                                         String serverName,\n@@ -214,1 +216,2 @@\n-        serverID = uniqueID;\n+        this.serverID = serverID;\n+        this.serverName = serverName;\n@@ -223,2 +226,2 @@\n-    public synchronized void startServer(int processID, String uniqueID) {\n-        startServer(processID, uniqueID, 0);\n+    public synchronized void startServer(int processID, String serverID, String serverName) {\n+        startServer(processID, serverID, serverName, 0);\n@@ -232,1 +235,1 @@\n-        startServer(processID, null);\n+        startServer(processID, null, null);\n@@ -242,1 +245,2 @@\n-                                         String uniqueID,\n+                                         String serverID,\n+                                         String serverName,\n@@ -254,1 +258,2 @@\n-        serverID = uniqueID;\n+        this.serverID = serverID;\n+        this.serverName = serverName;\n@@ -265,2 +270,3 @@\n-                                         String uniqueID) {\n-        startServer(javaExecutableName, coreFileName, uniqueID, 0);\n+                                         String serverID,\n+                                         String serverName) {\n+        startServer(javaExecutableName, coreFileName, serverID, serverName, 0);\n@@ -274,1 +280,1 @@\n-        startServer(javaExecutableName, coreFileName, null);\n+        startServer(javaExecutableName, coreFileName, null, null);\n@@ -305,1 +311,1 @@\n-                RMIHelper.unbind(serverID);\n+                RMIHelper.unbind(serverID, serverName);\n@@ -380,1 +386,1 @@\n-                RMIHelper.rebind(serverID, remote);\n+                RMIHelper.rebind(serverID, serverName, remote);\n","filename":"src\/jdk.hotspot.agent\/share\/classes\/sun\/jvm\/hotspot\/HotSpotAgent.java","additions":18,"deletions":12,"binary":false,"changes":30,"status":"modified"},{"patch":"@@ -36,1 +36,2 @@\n-    private static final Pattern CONNECT_PATTERN = Pattern.compile(\"^((?<id>.+?)@)?(?<host>.+?)(\/(?<prefix>.+))?$\");\n+    private static final Pattern CONNECT_PATTERN = Pattern.compile(\"^((?<serverid>.+?)@)?(?<host>.+?)(\/(?<servername>.+))?$\");\n+    private static final String DEFAULT_RMI_OBJECT_NAME = \"SARemoteDebugger\";\n@@ -38,1 +39,0 @@\n-    private static String serverNamePrefix;\n@@ -58,2 +58,0 @@\n-\n-        serverNamePrefix = System.getProperty(\"sun.jvm.hotspot.rmi.serverNamePrefix\", \"SARemoteDebugger\");\n@@ -62,2 +60,2 @@\n-    public static void rebind(String uniqueID, Remote object) throws DebuggerException {\n-        String name = getName(uniqueID);\n+    public static void rebind(String serverID, String serverName, Remote object) throws DebuggerException {\n+        String name = getName(serverID, serverName);\n@@ -83,2 +81,2 @@\n-    public static void unbind(String uniqueID) throws DebuggerException {\n-        String name = getName(uniqueID);\n+    public static void unbind(String serverID, String serverName) throws DebuggerException {\n+        String name = getName(serverID, serverName);\n@@ -92,4 +90,4 @@\n-    public static Remote lookup(String debugServerID) throws DebuggerException {\n-        \/\/ debugServerID follows the pattern [unique_id@]host[:port][\/prefix]\n-        \/\/ we have to transform this as \/\/host[:port]\/<serverNamePrefix>['_'<unique_id>]\n-        Matcher matcher = CONNECT_PATTERN.matcher(debugServerID);\n+    public static Remote lookup(String connectionString) throws DebuggerException {\n+        \/\/ connectionString follows the pattern [serverid@]host[:port][\/servername]\n+        \/\/ we have to transform this as \/\/host[:port]\/<servername>['_'<serverid>]\n+        Matcher matcher = CONNECT_PATTERN.matcher(connectionString);\n@@ -98,0 +96,8 @@\n+        String rmiObjectName = matcher.group(\"servername\") == null ? DEFAULT_RMI_OBJECT_NAME\n+                                                                   : matcher.group(\"servername\");\n+        String serverNamePrefix = System.getProperty(\"sun.jvm.hotspot.rmi.serverNamePrefix\");\n+        if (serverNamePrefix != null) {\n+            System.err.println(\"WARNING: sun.jvm.hotspot.rmi.serverNamePrefix is deprecated. Please specify it in --connect.\");\n+            rmiObjectName = serverNamePrefix;\n+        }\n+\n@@ -101,2 +107,2 @@\n-        nameBuf.append(matcher.group(\"prefix\") == null ? serverNamePrefix : matcher.group(\"prefix\"));\n-        if (matcher.group(\"id\") != null) {\n+        nameBuf.append(rmiObjectName);\n+        if (matcher.group(\"serverid\") != null) {\n@@ -104,1 +110,1 @@\n-            nameBuf.append(matcher.group(\"id\"));\n+            nameBuf.append(matcher.group(\"serverid\"));\n@@ -114,6 +120,9 @@\n-    private static String getName(String uniqueID) {\n-        String name = null;\n-        if (uniqueID != null) {\n-           name = serverNamePrefix + \"_\" + uniqueID;\n-        } else {\n-           name = serverNamePrefix;\n+    private static String getName(String serverID, String serverName) {\n+        String name = serverName == null ? DEFAULT_RMI_OBJECT_NAME : serverName;\n+        String serverNamePrefix = System.getProperty(\"sun.jvm.hotspot.rmi.serverNamePrefix\");\n+        if (serverNamePrefix != null) {\n+            System.err.println(\"WARNING: sun.jvm.hotspot.rmi.serverNamePrefix is deprecated. Please specify it in --servername.\");\n+            name = serverNamePrefix;\n+        }\n+        if (serverID != null) {\n+           name += \"_\" + serverID;\n","filename":"src\/jdk.hotspot.agent\/share\/classes\/sun\/jvm\/hotspot\/RMIHelper.java","additions":30,"deletions":21,"binary":false,"changes":51,"status":"modified"},{"patch":"@@ -71,1 +71,1 @@\n-            System.out.println(\"    --connect [<id>@]<host>[:registryport][\/prefix] To connect to a remote debug server (debugd).\");\n+            System.out.println(\"    --connect [<serverid>@]<host>[:registryport][\/servername] To connect to a remote debug server (debugd).\");\n@@ -88,1 +88,1 @@\n-            System.out.println(\"          or  jhsdb \" + mode + \" --connect id@debugserver:1234\/prefix\");\n+            System.out.println(\"          or  jhsdb \" + mode + \" --connect serverid@debugserver:1234\/servername\");\n@@ -94,2 +94,0 @@\n-        \/\/ [options] <pid> [server-id]\n-        \/\/ [options] <executable> <core> [server-id]\n@@ -107,1 +105,1 @@\n-        System.out.println(\"    --prefix   <url prefix> Sets the prefix to distinguish SA debugee.\");\n+        System.out.println(\"    --servername <name>     Instance name of debugd server.\");\n@@ -381,1 +379,1 @@\n-                \"prefix=\", \"prefix\");\n+                \"servername=\", \"servername\");\n@@ -396,1 +394,1 @@\n-        String prefix = argMap.get(\"prefix\");\n+        String serverName = argMap.get(\"servername\");\n@@ -428,5 +426,0 @@\n-        \/\/ Set RMI URL prefix if specified\n-        if (prefix != null) {\n-            System.setProperty(\"sun.jvm.hotspot.rmi.serverNamePrefix\", prefix);\n-        }\n-\n@@ -445,1 +438,1 @@\n-                agent.startServer(pid, serverID, rmiPort);\n+                agent.startServer(pid, serverID, serverName, rmiPort);\n@@ -457,1 +450,1 @@\n-                agent.startServer(javaExecutableName, coreFileName, serverID, rmiPort);\n+                agent.startServer(javaExecutableName, coreFileName, serverID, serverName, rmiPort);\n","filename":"src\/jdk.hotspot.agent\/share\/classes\/sun\/jvm\/hotspot\/SALauncher.java","additions":7,"deletions":14,"binary":false,"changes":21,"status":"modified"},{"patch":"@@ -35,1 +35,1 @@\n-\\f[CB]\\-\\-connect\\f[R] \\f[I][server\\-id\\@]debugd\\-host[:registryport][\/prefix]\\f[R]\\]\n+\\f[CB]\\-\\-connect\\f[R] \\f[I][serverid\\@]debugd\\-host[:registryport][\/servername]\\f[R]\\]\n@@ -39,1 +39,1 @@\n-\\f[CB]\\-\\-connect\\f[R] \\f[I][server\\-id\\@]debugd\\-host[:registryport][\/prefix]\\f[R]\\]\n+\\f[CB]\\-\\-connect\\f[R] \\f[I][serverid\\@]debugd\\-host[:registryport][\/servername]\\f[R]\\]\n@@ -47,1 +47,1 @@\n-| \\f[CB]\\-\\-connect\\f[R] \\f[I][server\\-id\\@]debugd\\-host[:registryport][\/prefix]\\f[R])\n+| \\f[CB]\\-\\-connect\\f[R] \\f[I][serverid\\@]debugd\\-host[:registryport][\/servername]\\f[R])\n@@ -52,1 +52,1 @@\n-| \\f[CB]\\-\\-connect\\f[R] \\f[I][server\\-id\\@]debugd\\-host[:registryport][\/prefix]\\f[R])\n+| \\f[CB]\\-\\-connect\\f[R] \\f[I][serverid\\@]debugd\\-host[:registryport][\/servername]\\f[R])\n@@ -57,1 +57,1 @@\n-| \\f[CB]\\-\\-connect\\f[R] \\f[I][server\\-id\\@]debugd\\-host[:registryport][\/prefix]\\f[R])\n+| \\f[CB]\\-\\-connect\\f[R] \\f[I][serverid\\@]debugd\\-host[:registryport][\/servername]\\f[R])\n@@ -62,1 +62,1 @@\n-| \\f[CB]\\-\\-connect\\f[R] \\f[I][server\\-id\\@]debugd\\-host[:registryport][\/prefix]\\f[R])\n+| \\f[CB]\\-\\-connect\\f[R] \\f[I][serverid\\@]debugd\\-host[:registryport][\/servername]\\f[R])\n@@ -84,1 +84,1 @@\n-.B \\f[I][server\\-id\\@]debugd\\-host[:registryport][\/prefix]\\f[R]\n+.B \\f[I][serverid\\@]debugd\\-host[:registryport][\/servername]\\f[R]\n@@ -161,1 +161,1 @@\n-.B \\f[CB]\\-\\-serverid\\f[R] \\f[I]server\\-id\\f[R]\n+.B \\f[CB]\\-\\-serverid\\f[R] \\f[I]serverid\\f[R]\n@@ -163,1 +163,2 @@\n-This is required if multiple debug servers are run on the same machine.\n+This is required if multiple debug servers are run on the same server instance.\n+It would be added to RMI object name for server instance.\n@@ -202,6 +203,4 @@\n-.B \\f[CB]\\-\\-prefix\\f[R] \\f[I]prefix\\f[R]\n-Sets the prefix to distinguish SA debugee.\n-This option overrides the system property\n-\\[aq]sun.jvm.hotspot.rmi.serverNamePrefix\\[aq].\n-If not specified, the system property is used.\n-If the system property is not set, \"SARemoteDebugger\" will be set.\n+.B \\f[CB]\\-\\-servername\\f[R] \\f[I]servername\\f[R]\n+Sets the instance name of debugd server to distinguish SA debugee.\n+It is used for RMI object name for server instance.\n+If not specified, \"SARemoteDebugger\" will be set.\n","filename":"src\/jdk.hotspot.agent\/share\/man\/jhsdb.1","additions":14,"deletions":15,"binary":false,"changes":29,"status":"modified"},{"patch":"@@ -57,1 +57,1 @@\n-            debugd = new DebugdUtils(null);\n+            debugd = new DebugdUtils();\n","filename":"test\/hotspot\/jtreg\/serviceability\/sa\/sadebugd\/ClhsdbAttachToDebugServer.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -56,1 +56,1 @@\n-            debugd = new DebugdUtils(null);\n+            debugd = new DebugdUtils();\n","filename":"test\/hotspot\/jtreg\/serviceability\/sa\/sadebugd\/ClhsdbTestConnectArgument.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2019, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2019, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -47,1 +47,1 @@\n-    private static OutputAnalyzer runJHSDB(String command, String id) throws IOException, InterruptedException {\n+    private static OutputAnalyzer runJHSDB(String command, String serverID) throws IOException, InterruptedException {\n@@ -52,2 +52,2 @@\n-        if (id != null) {\n-            jhsdbLauncher.addToolArg(id + \"@localhost\");\n+        if (serverID != null) {\n+            jhsdbLauncher.addToolArg(serverID + \"@localhost\");\n@@ -69,2 +69,2 @@\n-    private static void runJSTACK(String id) throws IOException, InterruptedException {\n-        OutputAnalyzer out = runJHSDB(\"jstack\", id);\n+    private static void runJSTACK(String serverID) throws IOException, InterruptedException {\n+        OutputAnalyzer out = runJHSDB(\"jstack\", serverID);\n@@ -77,2 +77,2 @@\n-    private static void runJMAP(String id) throws IOException, InterruptedException {\n-        OutputAnalyzer out = runJHSDB(\"jmap\", id);\n+    private static void runJMAP(String serverID) throws IOException, InterruptedException {\n+        OutputAnalyzer out = runJHSDB(\"jmap\", serverID);\n@@ -85,2 +85,2 @@\n-    private static void runJINFO(String id) throws IOException, InterruptedException {\n-        OutputAnalyzer out = runJHSDB(\"jinfo\", id);\n+    private static void runJINFO(String serverID) throws IOException, InterruptedException {\n+        OutputAnalyzer out = runJHSDB(\"jinfo\", serverID);\n@@ -93,2 +93,2 @@\n-    private static void runJSNAP(String id) throws IOException, InterruptedException {\n-        OutputAnalyzer out = runJHSDB(\"jsnap\", id);\n+    private static void runJSNAP(String serverID) throws IOException, InterruptedException {\n+        OutputAnalyzer out = runJHSDB(\"jsnap\", serverID);\n@@ -101,2 +101,5 @@\n-    private static void runTests(String id, long debuggeePid) throws IOException, InterruptedException {\n-        DebugdUtils debugd = new DebugdUtils(id);\n+    private static void runTests(String serverID, long debuggeePid) throws IOException, InterruptedException {\n+        DebugdUtils debugd = new DebugdUtils();\n+        if (serverID != null) {\n+            debugd.setServerID(serverID);\n+        }\n@@ -106,4 +109,4 @@\n-            runJSTACK(id);\n-            runJMAP(id);\n-            runJINFO(id);\n-            runJSNAP(id);\n+            runJSTACK(serverID);\n+            runJMAP(serverID);\n+            runJINFO(serverID);\n+            runJSNAP(serverID);\n","filename":"test\/hotspot\/jtreg\/serviceability\/sa\/sadebugd\/DebugdConnectTest.java","additions":21,"deletions":18,"binary":false,"changes":39,"status":"modified"},{"patch":"@@ -34,1 +34,1 @@\n-    private final String id;\n+    private String serverID;\n@@ -37,1 +37,1 @@\n-    private String prefix;\n+    private String serverName;\n@@ -40,2 +40,2 @@\n-    public DebugdUtils(String id) {\n-        this.id = id;\n+    public DebugdUtils() {\n+        this.serverID = null;\n@@ -44,1 +44,1 @@\n-        this.prefix = null;\n+        this.serverName = null;\n@@ -56,2 +56,6 @@\n-    public void setPrefix(String prefix) {\n-        this.prefix = prefix;\n+    public void setServerID(String serverID) {\n+        this.serverID = serverID;\n+    }\n+\n+    public void setServerName(String serverName) {\n+        this.serverName = serverName;\n@@ -66,1 +70,1 @@\n-        if (id != null) {\n+        if (serverID != null) {\n@@ -68,1 +72,1 @@\n-            jhsdbLauncher.addToolArg(id);\n+            jhsdbLauncher.addToolArg(serverID);\n@@ -77,3 +81,3 @@\n-        if (prefix != null) {\n-            jhsdbLauncher.addToolArg(\"--prefix\");\n-            jhsdbLauncher.addToolArg(prefix);\n+        if (serverName != null) {\n+            jhsdbLauncher.addToolArg(\"--servername\");\n+            jhsdbLauncher.addToolArg(serverName);\n","filename":"test\/hotspot\/jtreg\/serviceability\/sa\/sadebugd\/DebugdUtils.java","additions":16,"deletions":12,"binary":false,"changes":28,"status":"modified"},{"patch":"@@ -49,2 +49,2 @@\n-    private static DebugdUtils attachWithDebugd(int pid, boolean disableRegistry, String prefix) throws IOException {\n-        var debugd = new DebugdUtils(null);\n+    private static DebugdUtils attachWithDebugd(int pid, boolean disableRegistry, String serverName) throws IOException {\n+        var debugd = new DebugdUtils();\n@@ -53,1 +53,1 @@\n-        debugd.setPrefix(prefix);\n+        debugd.setServerName(serverName);\n@@ -58,2 +58,2 @@\n-    private static void test(String prefix) throws IOException, InterruptedException {\n-        assert prefix != null;\n+    private static void test(String serverName) throws IOException, InterruptedException {\n+        assert serverName != null;\n@@ -64,1 +64,1 @@\n-        jhsdbLauncher.addToolArg(\"localhost:\" + REGISTRY_PORT + \"\/\" + prefix);\n+        jhsdbLauncher.addToolArg(\"localhost:\" + REGISTRY_PORT + \"\/\" + serverName);\n","filename":"test\/hotspot\/jtreg\/serviceability\/sa\/sadebugd\/DisableRegistryTest.java","additions":6,"deletions":6,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -52,1 +52,1 @@\n-            debugd = new DebugdUtils(null);\n+            debugd = new DebugdUtils();\n","filename":"test\/hotspot\/jtreg\/serviceability\/sa\/sadebugd\/PmapOnDebugdTest.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -55,1 +55,1 @@\n-            debugd = new DebugdUtils(null);\n+            debugd = new DebugdUtils();\n","filename":"test\/hotspot\/jtreg\/serviceability\/sa\/sadebugd\/RunCommandOnServerTest.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}