{"files":[{"patch":"@@ -241,3 +241,11 @@\n-        if (out instanceof ChannelOutputStream cos\n-                && ch instanceof FileChannel fc) {\n-            WritableByteChannel wbc = cos.channel();\n+        if (out instanceof ChannelOutputStream cos) {\n+            if (ch instanceof FileChannel fc) {\n+                WritableByteChannel wbc = cos.channel();\n+\n+                if (wbc instanceof SelectableChannel sc) {\n+                    synchronized (sc.blockingLock()) {\n+                        if (!sc.isBlocking())\n+                            throw new IllegalBlockingModeException();\n+                        return transfer(fc, wbc);\n+                    }\n+                }\n@@ -245,2 +253,1 @@\n-            if (wbc instanceof FileChannel dst) {\n-                return transfer(fc, dst);\n+                return transfer(fc, wbc);\n@@ -249,5 +256,9 @@\n-            if (wbc instanceof SelectableChannel sc) {\n-                synchronized (sc.blockingLock()) {\n-                    if (!sc.isBlocking())\n-                        throw new IllegalBlockingModeException();\n-                    return transfer(fc, wbc);\n+            if (cos.channel() instanceof FileChannel fc) {\n+                ReadableByteChannel rbc = ch;\n+\n+                if (rbc instanceof SelectableChannel sc) {\n+                    synchronized (sc.blockingLock()) {\n+                        if (!sc.isBlocking())\n+                            throw new IllegalBlockingModeException();\n+                        return transfer(rbc, fc);\n+                    }\n@@ -255,1 +266,0 @@\n-            }\n@@ -257,1 +267,2 @@\n-            return transfer(fc, wbc);\n+                return transfer(rbc, fc);\n+            }\n@@ -275,0 +286,24 @@\n+\n+    private static long transfer(ReadableByteChannel src, FileChannel dst) throws IOException {\n+        long initialPos = dst.position();\n+        long pos = initialPos;\n+        ByteBuffer bb = Util.getTemporaryDirectBuffer(DEFAULT_BUFFER_SIZE);\n+        try {\n+            for (int bytesRead = 0; bytesRead > -1;) {\n+                pos += dst.transferFrom(src, pos, Long.MAX_VALUE);\n+                bytesRead = src.read(bb); \/\/ detect end-of-stream\n+                if (bytesRead > -1) {\n+                    bb.flip();\n+                    while (bb.hasRemaining()) {\n+                        dst.write(bb);\n+                    }\n+                    bb.clear();\n+                    pos += bytesRead;\n+                }\n+            };\n+        } finally {\n+            dst.position(pos);\n+            Util.releaseTemporaryDirectBuffer(bb);\n+        }\n+        return pos - initialPos;\n+    }\n","filename":"src\/java.base\/share\/classes\/sun\/nio\/ch\/ChannelInputStream.java","additions":47,"deletions":12,"binary":false,"changes":59,"status":"modified"},{"patch":"@@ -95,1 +95,1 @@\n-            \/\/ tests FileChannel.transferTo(WritableChannelOutput) optimized case\n+            \/\/ tests FileChannel.transferTo(WritableByteChannelOutput) optimized case\n@@ -98,0 +98,6 @@\n+            \/\/ tests FileChannel.transferFrom(SelectableChannelOutput) optimized case\n+            { selectableChannelInput(), fileChannelOutput() },\n+\n+            \/\/ tests FileChannel.transferFrom(ReadableByteChannelInput) optimized case\n+            { readableByteChannelInput(), fileChannelOutput() },\n+\n@@ -312,0 +318,19 @@\n+    \/*\n+     * Creates a provider for an input stream which wraps a selectable channel\n+     *\/\n+    private static InputStreamProvider selectableChannelInput() throws IOException {\n+        return new InputStreamProvider() {\n+            public InputStream input(byte... bytes) throws Exception {\n+                Pipe pipe = Pipe.open();\n+                new Thread(() -> {\n+                    try (OutputStream os = Channels.newOutputStream(pipe.sink())) {\n+                      os.write(bytes);\n+                    } catch (IOException e) {\n+                        throw new RuntimeException(e);\n+                    }\n+                }).start();\n+                return Channels.newInputStream(pipe.source());\n+            }\n+        };\n+    }\n+\n@@ -332,0 +357,3 @@\n+    \/*\n+     * Creates a provider for an output stream which wraps a selectable channel\n+     *\/\n@@ -358,0 +386,3 @@\n+    \/*\n+     * Creates a provider for an output stream which wraps a writable byte channel but is not a file channel\n+     *\/\n","filename":"test\/jdk\/java\/nio\/channels\/Channels\/TransferTo.java","additions":32,"deletions":1,"binary":false,"changes":33,"status":"modified"}]}