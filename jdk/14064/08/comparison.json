{"files":[{"patch":"@@ -46,1 +46,1 @@\n-      SRC := $(STATIC_LIBS_IMAGE_DIR)\/lib, \\\n+      SRC := $(STATIC_LIBS_GRAAL_IMAGE_DIR)\/lib, \\\n@@ -49,1 +49,1 @@\n-          $(call FindFiles, $(STATIC_LIBS_IMAGE_DIR)\/lib)), \\\n+          $(call FindFiles, $(STATIC_LIBS_GRAAL_IMAGE_DIR)\/lib)), \\\n","filename":"make\/GraalBuilderImage.gmk","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -236,0 +236,1 @@\n+HOTSPOT_VARIANT_STATIC_LIBS_TARGETS := $(addsuffix -static-libs, $(HOTSPOT_VARIANT_TARGETS))\n@@ -254,0 +255,8 @@\n+define DeclareHotspotStaticLibsRecipe\n+  hotspot-$1-static-libs:\n+\t+($(CD) $(TOPDIR)\/make\/hotspot && $(MAKE) $(MAKE_ARGS) -f lib\/CompileLibraries.gmk \\\n+\t    JVM_VARIANT=$1 STATIC_LIBS=true)\n+endef\n+\n+$(foreach v, $(JVM_VARIANTS), $(eval $(call DeclareHotspotStaticLibsRecipe,$v)))\n+\n@@ -301,1 +310,1 @@\n-    $(HOTSPOT_VARIANT_LIBS_TARGETS)\n+    $(HOTSPOT_VARIANT_LIBS_TARGETS) $(HOTSPOT_VARIANT_STATIC_LIBS_TARGETS)\n@@ -465,0 +474,6 @@\n+    TARGET := static-libs-image, \\\n+))\n+\n+$(eval $(call SetupTarget, static-libs-graal-image, \\\n+    MAKEFILE := StaticLibsImage, \\\n+    TARGET := static-libs-graal-image, \\\n@@ -492,1 +507,1 @@\n-    DEPS := jdk-image static-libs-image, \\\n+    DEPS := jdk-image static-libs-graal-image, \\\n@@ -892,0 +907,1 @@\n+      $(eval hotspot-$v-static-libs: hotspot-$v-gensrc java.base-copy) \\\n@@ -1050,1 +1066,3 @@\n-  static-libs-image: $(STATIC_LIBS_TARGETS)\n+  static-libs-image: hotspot-static-libs $(STATIC_LIBS_TARGETS)\n+\n+  static-libs-graal-image: $(STATIC_LIBS_TARGETS)\n@@ -1100,0 +1118,1 @@\n+  $(eval hotspot-static-libs: hotspot-$v-static-libs) \\\n@@ -1262,1 +1281,2 @@\n-ALL_TARGETS += buildtools hotspot hotspot-libs hotspot-gensrc gensrc gendata \\\n+ALL_TARGETS += buildtools hotspot hotspot-libs hotspot-static-libs \\\n+    hotspot-gensrc gensrc gendata \\\n","filename":"make\/Main.gmk","additions":24,"deletions":4,"binary":false,"changes":28,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n-# Copyright (c) 2019, Oracle and\/or its affiliates. All rights reserved.\n+# Copyright (c) 2019, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -41,0 +41,7 @@\n+ifneq ($(filter static-libs-image, $(MAKECMDGOALS)), )\n+  IMAGE_DEST_DIR=$(STATIC_LIBS_IMAGE_DIR)\/lib\n+else ifneq ($(filter static-libs-graal-image, $(MAKECMDGOALS)), )\n+  IMAGE_DEST_DIR=$(STATIC_LIBS_GRAAL_IMAGE_DIR)\/lib\n+endif\n+\n+# Copy JDK static libs to the image.\n@@ -45,1 +52,1 @@\n-      DEST := $(STATIC_LIBS_IMAGE_DIR)\/lib, \\\n+      DEST := $(IMAGE_DEST_DIR), \\\n@@ -50,0 +57,1 @@\n+  $(eval STATIC_LIBS_TARGETS += $$(COPY_STATIC_LIBS_$m)) \\\n@@ -52,0 +60,13 @@\n+ifneq ($(filter static-libs-image, $(MAKECMDGOALS)), )\n+  # Copy libjvm static library to the image.\n+  $(foreach v, $(JVM_VARIANTS), \\\n+    $(eval $(call SetupCopyFiles, COPY_STATIC_LIBS_$v, \\\n+        SRC := $(HOTSPOT_OUTPUTDIR)\/variant-$v\/libjvm\/objs\/static, \\\n+        DEST := $(IMAGE_DEST_DIR)\/$v, \\\n+        FILES := $(wildcard $(HOTSPOT_OUTPUTDIR)\/variant-$v\/libjvm\/objs\/static\/*$(STATIC_LIBRARY_SUFFIX)), \\\n+    )) \\\n+    $(eval TARGETS += $$(COPY_STATIC_LIBS_$v)) \\\n+    $(eval HOTSPOT_VARIANT_STATIC_LIBS_TARGETS += $$(COPY_STATIC_LIBS_$v)) \\\n+  )\n+endif\n+\n@@ -54,0 +75,3 @@\n+static-libs-image: $(HOTSPOT_VARIANT_STATIC_LIBS_TARGETS) $(STATIC_LIBS_TARGETS)\n+static-libs-graal-image: $(STATIC_LIBS_TARGETS)\n+\n","filename":"make\/StaticLibsImage.gmk","additions":26,"deletions":2,"binary":false,"changes":28,"status":"modified"},{"patch":"@@ -75,0 +75,2 @@\n+    LDFLAGS_CXX_PARTIAL_LINKING=\"$MACHINE_FLAG -r\"\n+\n@@ -78,0 +80,3 @@\n+\n+    LDFLAGS_CXX_PARTIAL_LINKING=\"$MACHINE_FLAG -r\"\n+\n@@ -164,0 +169,1 @@\n+  AC_SUBST(LDFLAGS_CXX_PARTIAL_LINKING)\n","filename":"make\/autoconf\/flags-ldflags.m4","additions":6,"deletions":0,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -304,0 +304,1 @@\n+  AC_SUBST(MACHINE_FLAG)\n","filename":"make\/autoconf\/flags.m4","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -549,0 +549,2 @@\n+MACHINE_FLAG := @MACHINE_FLAG@\n+\n@@ -575,0 +577,3 @@\n+# LDFLAGS specific to partial linking.\n+LDFLAGS_CXX_PARTIAL_LINKING:=@LDFLAGS_CXX_PARTIAL_LINKING@\n+\n@@ -931,0 +936,4 @@\n+# Graal static libs image\n+STATIC_LIBS_GRAAL_IMAGE_SUBDIR := static-libs-graal\n+STATIC_LIBS_GRAAL_IMAGE_DIR := $(IMAGES_OUTPUTDIR)\/$(STATIC_LIBS_GRAAL_IMAGE_SUBDIR)\n+\n","filename":"make\/autoconf\/spec.gmk.in","additions":9,"deletions":0,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n-# Copyright (c) 2011, 2022, Oracle and\/or its affiliates. All rights reserved.\n+# Copyright (c) 2011, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -551,0 +551,1 @@\n+#   STATIC_LIB_EXCLUDE_OBJS exclude objects that matches from static library\n@@ -729,0 +730,6 @@\n+  ifeq ($(STATIC_LIBS), true)\n+    # Exclude the object files that match with $1_STATIC_LIB_EXCLUDE_OBJS.\n+    ifneq ($$($1_STATIC_LIB_EXCLUDE_OBJS), )\n+      $1_ALL_OBJS := $$(call not-containing, $$($1_STATIC_LIB_EXCLUDE_OBJS), $$($1_ALL_OBJS))\n+    endif\n+  endif\n@@ -1133,0 +1140,41 @@\n+  $1_LD_OBJ_ARG := $$($1_ALL_OBJS)\n+\n+  # If there are many object files, use an @-file...\n+  ifneq ($$(word 17, $$($1_ALL_OBJS)), )\n+    $1_OBJ_FILE_LIST := $$($1_OBJECT_DIR)\/_$1_objectfilenames.txt\n+    ifneq ($(COMPILER_COMMAND_FILE_FLAG), )\n+      $1_LD_OBJ_ARG := $(COMPILER_COMMAND_FILE_FLAG)$$($1_OBJ_FILE_LIST)\n+    else\n+      # ...except for toolchains which don't support them.\n+      $1_LD_OBJ_ARG := `cat $$($1_OBJ_FILE_LIST)`\n+    endif\n+\n+    # If we are building static library, 'AR' on macosx may not support @-file.\n+    ifeq ($$($1_TYPE), STATIC_LIBRARY)\n+      ifeq ($(call isTargetOs, macosx), true)\n+        $1_LD_OBJ_ARG := `cat $$($1_OBJ_FILE_LIST)`\n+      endif\n+    endif\n+  endif\n+\n+  # Unfortunately the @-file trick does not work reliably when using clang.\n+  # Clang does not propagate the @-file parameter to the ld sub process, but\n+  # instead puts the full content on the command line. At least the llvm ld\n+  # does not even support an @-file.\n+  #\n+  # When linking a large amount of object files, we risk hitting the limit\n+  # of the command line length even on posix systems if the path length of\n+  # the output dir is very long due to our use of absolute paths. To\n+  # mitigate this, use paths relative to the output dir when linking over\n+  # 500 files with clang and the output dir path is deep.\n+  ifneq ($$(word 500, $$($1_ALL_OBJS)), )\n+    ifeq ($$(TOOLCHAIN_TYPE), clang)\n+      # There is no strlen function in make, but checking path depth is a\n+      # reasonable approximation.\n+      ifneq ($$(word 10, $$(subst \/, ,$$(OUTPUTDIR))), )\n+        $1_LINK_OBJS_RELATIVE := true\n+        $1_ALL_OBJS_RELATIVE := $$(patsubst $$(OUTPUTDIR)\/%, %, $$($1_ALL_OBJS))\n+      endif\n+    endif\n+  endif\n+\n@@ -1134,0 +1182,7 @@\n+    # Include partial linking when building the static library with clang on linux.\n+    ifeq ($(call isTargetOs, linux), true)\n+      ifneq ($(findstring $(TOOLCHAIN_TYPE), clang), )\n+        $1_ENABLE_PARTIAL_LINKING := true\n+      endif\n+    endif\n+\n@@ -1136,0 +1191,3 @@\n+    ifeq ($$($1_ENABLE_PARTIAL_LINKING), true)\n+      $1_VARDEPS += $$($1_LD) $$($1_SYSROOT_LDFLAGS)\n+    endif\n@@ -1148,0 +1206,8 @@\n+    $1_AR_OBJ_ARG := $$($1_LD_OBJ_ARG)\n+    # With clang on linux, partial linking is enabled and 'AR' takes the output\n+    # object from the partial linking step.\n+    ifeq ($$($1_ENABLE_PARTIAL_LINKING), true)\n+      $1_TARGET_RELOCATABLE := $$($1_OBJECT_DIR)\/$$($1_PREFIX)$$($1_NAME)_relocatable$(OBJ_SUFFIX)\n+      $1_AR_OBJ_ARG := $$($1_TARGET_RELOCATABLE)\n+    endif\n+\n@@ -1149,0 +1215,7 @@\n+        ifneq ($$($1_OBJ_FILE_LIST), )\n+          ifeq ($$($1_LINK_OBJS_RELATIVE), true)\n+\t    $$(eval $$(call ListPathsSafely, $1_ALL_OBJS_RELATIVE, $$($1_OBJ_FILE_LIST)))\n+          else\n+\t    $$(eval $$(call ListPathsSafely, $1_ALL_OBJS, $$($1_OBJ_FILE_LIST)))\n+          endif\n+        endif\n@@ -1151,0 +1224,8 @@\n+        # Do partial linking.\n+        ifeq ($$($1_ENABLE_PARTIAL_LINKING), true)\n+\t  $$(call ExecuteWithLog, $$($1_OBJECT_DIR)\/$$($1_SAFE_NAME)_partial_link, \\\n+\t    $(if $$($1_LINK_OBJS_RELATIVE), $$(CD) $$(OUTPUTDIR) ; ) \\\n+\t      $$($1_LD) $(LDFLAGS_CXX_PARTIAL_LINKING) $$($1_SYSROOT_LDFLAGS) \\\n+\t        $(LD_OUT_OPTION)$$($1_TARGET_RELOCATABLE) \\\n+                $$($1_LD_OBJ_ARG))\n+        endif\n@@ -1152,1 +1233,2 @@\n-\t    $$($1_AR) $$(ARFLAGS) $$($1_ARFLAGS) $(AR_OUT_OPTION)$$($1_TARGET) $$($1_ALL_OBJS) \\\n+\t  $(if $$($1_LINK_OBJS_RELATIVE), $$(CD) $$(OUTPUTDIR) ; ) \\\n+\t    $$($1_AR) $$(ARFLAGS) $$($1_ARFLAGS) $(AR_OUT_OPTION)$$($1_TARGET) $$($1_AR_OBJ_ARG) \\\n@@ -1204,34 +1286,0 @@\n-    $1_LD_OBJ_ARG := $$($1_ALL_OBJS)\n-\n-    # If there are many object files, use an @-file...\n-    ifneq ($$(word 17, $$($1_ALL_OBJS)), )\n-      $1_OBJ_FILE_LIST := $$($1_OBJECT_DIR)\/_$1_objectfilenames.txt\n-      ifneq ($(COMPILER_COMMAND_FILE_FLAG), )\n-        $1_LD_OBJ_ARG := $(COMPILER_COMMAND_FILE_FLAG)$$($1_OBJ_FILE_LIST)\n-      else\n-        # ...except for toolchains which don't support them.\n-        $1_LD_OBJ_ARG := `cat $$($1_OBJ_FILE_LIST)`\n-      endif\n-    endif\n-\n-    # Unfortunately the @-file trick does not work reliably when using clang.\n-    # Clang does not propagate the @-file parameter to the ld sub process, but\n-    # instead puts the full content on the command line. At least the llvm ld\n-    # does not even support an @-file.\n-    #\n-    # When linking a large amount of object files, we risk hitting the limit\n-    # of the command line length even on posix systems if the path length of\n-    # the output dir is very long due to our use of absolute paths. To\n-    # mitigate this, use paths relative to the output dir when linking over\n-    # 500 files with clang and the output dir path is deep.\n-    ifneq ($$(word 500, $$($1_ALL_OBJS)), )\n-      ifeq ($$(TOOLCHAIN_TYPE), clang)\n-        # There is no strlen function in make, but checking path depth is a\n-        # reasonable approximation.\n-        ifneq ($$(word 10, $$(subst \/, ,$$(OUTPUTDIR))), )\n-          $1_LINK_OBJS_RELATIVE := true\n-          $1_ALL_OBJS_RELATIVE := $$(patsubst $$(OUTPUTDIR)\/%, %, $$($1_ALL_OBJS))\n-        endif\n-      endif\n-    endif\n-\n","filename":"make\/common\/NativeCompilation.gmk","additions":84,"deletions":36,"binary":false,"changes":120,"status":"modified"},{"patch":"@@ -142,0 +142,7 @@\n+# The global operator new functions defined in operator_new.cpp are intended\n+# to detect and prevent the VM code from calling them. See more details in\n+# operator_new.cpp. Exclude operator_new.o when statically linking the VM\n+# code with JDK natives, as the JDK natives might need to call the global\n+# operator new.\n+LIBJVM_STATIC_EXCLUDE_OBJS := operator_new.o\n+\n@@ -193,0 +200,1 @@\n+    STATIC_LIB_EXCLUDE_OBJS := $(LIBJVM_STATIC_EXCLUDE_OBJS), \\\n","filename":"make\/hotspot\/lib\/CompileJvm.gmk","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -156,0 +156,3 @@\n+  # Extra files from the zlib.\n+  LIBJLI_EXTRA_FILE_LIST := inflate.c inftrees.c inffast.c zadler32.c zcrc32.c zutil.c\n+\n@@ -158,7 +161,8 @@\n-          inflate.c \\\n-          inftrees.c \\\n-          inffast.c \\\n-          zadler32.c \\\n-          zcrc32.c \\\n-          zutil.c \\\n-      )\n+          $(LIBJLI_EXTRA_FILE_LIST))\n+\n+  # Do not include these libz objects in the static libjli library.\n+  # When statically linking the java launcher with all JDK and VM\n+  # static libraries, we use the --whole-archive linker option.\n+  # The duplicate objects in different static libraries cause linking\n+  # errors due to duplicate symbols.\n+  LIBJLI_STATIC_EXCLUDE_OBJS := $(subst .c,$(OBJ_SUFFIX),$(LIBJLI_EXTRA_FILE_LIST))\n@@ -183,0 +187,1 @@\n+    STATIC_LIB_EXCLUDE_OBJS := $(LIBJLI_STATIC_EXCLUDE_OBJS), \\\n","filename":"make\/modules\/java.base\/lib\/CoreLibraries.gmk","additions":12,"deletions":7,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -224,0 +224,8 @@\n+    # These are the object files provided by the awt native\n+    # library. Do not include these external (non-awt_xawt library)\n+    # objects in the static library. When statically linking the java\n+    # launcher with all JDK and VM static libraries, we use the\n+    # --whole-archive linker option. The duplicate objects in different\n+    # static libraries cause linking errors due to duplicate symbols.\n+    LIBAWT_XAWT_STATIC_EXCLUDE_OBJS := systemScale.o\n+\n@@ -258,0 +266,1 @@\n+        STATIC_LIB_EXCLUDE_OBJS := $(LIBAWT_XAWT_STATIC_EXCLUDE_OBJS), \\\n@@ -381,0 +390,8 @@\n+  # These are the object files provided by the awt native\n+  # library. Do not include these external (non-awt_headless library)\n+  # objects in the static library. When statically linking the java\n+  # launcher with all JDK and VM static libraries, we use the\n+  # --whole-archive linker option. The duplicate objects in different\n+  # static libraries cause linking errors due to duplicate symbols.\n+  LIBAWT_HEADLESS_STATIC_EXCLUDE_OBJS := systemScale.o\n+\n@@ -396,0 +413,1 @@\n+      STATIC_LIB_EXCLUDE_OBJS := $(LIBAWT_HEADLESS_STATIC_EXCLUDE_OBJS), \\\n","filename":"make\/modules\/java.desktop\/lib\/Awt2dLibraries.gmk","additions":18,"deletions":0,"binary":false,"changes":18,"status":"modified"}]}