{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2003, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2003, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -71,1 +71,3 @@\n-     *  The attribute indicates {@code value} has been deleted partially.\n+     *  The attribute indicates {@code value} is in UTF16 but may be compressible.\n+     *  An inflated byte array becomes compressible only when those non-latin1 chars are deleted.\n+     *  Therefore, sett this attribute in all methods that delete chars.\n@@ -73,1 +75,1 @@\n-    boolean growOnly = true;\n+    boolean maybeLatin1 = false;\n@@ -139,2 +141,3 @@\n-            if (seq instanceof AbstractStringBuilder) {\n-                initCoder = ((AbstractStringBuilder)seq).getCoder();\n+            if (seq instanceof AbstractStringBuilder asb) {\n+                initCoder = asb.getCoder();\n+                maybeLatin1 |= asb.maybeLatin1;\n@@ -201,8 +204,0 @@\n-    \/**\n-     * Return true if value has been deleted partially. coder may not be accurate.\n-     * @return the attribute growOnly.\n-     *\/\n-    boolean isGrowOnly() {\n-        return growOnly;\n-    }\n-\n@@ -335,1 +330,1 @@\n-            growOnly = false;\n+            maybeLatin1 = true;\n@@ -545,0 +540,1 @@\n+            maybeLatin1 = true;\n@@ -546,1 +542,0 @@\n-        growOnly = false;\n@@ -615,0 +610,1 @@\n+        maybeLatin1 |= asb.maybeLatin1;\n@@ -925,1 +921,1 @@\n-            growOnly = false;\n+            maybeLatin1 = true;\n@@ -977,1 +973,1 @@\n-        growOnly = false;\n+        maybeLatin1 = true;\n@@ -1013,1 +1009,1 @@\n-            growOnly = false;\n+            maybeLatin1 = true;\n","filename":"src\/java.base\/share\/classes\/java\/lang\/AbstractStringBuilder.java","additions":14,"deletions":18,"binary":false,"changes":32,"status":"modified"},{"patch":"@@ -4515,1 +4515,1 @@\n-            if (COMPACT_STRINGS && !asb.isGrowOnly()) {\n+            if (COMPACT_STRINGS && asb.maybeLatin1) {\n","filename":"src\/java.base\/share\/classes\/java\/lang\/String.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, 2018, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -370,0 +370,37 @@\n+    \/*\n+     * Tests for maybeLatin1 attribute\n+     *\/\n+    @Test\n+    public void testCompactStringForMaybeLatin1() {\n+      StringBuilder sb = new StringBuilder(\"A\\uDC01\");\n+\n+      sb.setLength(0);      \/\/ maybeLatin1 become true\n+      check(sb, \"\");\n+      check(new StringBuilder(sb).append('A'), \"A\");\n+      check(new StringBuilder().append(sb), \"\");\n+\n+      sb = new StringBuilder(\"A\\uDC01\");\n+      sb.setCharAt(1, 'B');   \/\/ maybeLatin1 become true\n+      check(sb, \"AB\");\n+      check(new StringBuilder(sb).append('A'), \"ABA\");\n+      check(new StringBuilder().append(sb), \"AB\");\n+\n+      sb = new StringBuilder(\"A\\uDC01\");\n+      sb.deleteCharAt(1);   \/\/ maybeLatin1 become true\n+      check(sb, \"A\");\n+      check(new StringBuilder(sb).append('B'), \"AB\");\n+      check(new StringBuilder().append(sb), \"A\");\n+\n+      sb = new StringBuilder(\"A\\uDC01\\uFF21\\uD801\");\n+      sb.delete(1, 4);\n+      check(sb, \"A\");      \/\/ maybeLatin1 become true\n+      check(new StringBuilder(sb).append('B'), \"AB\");\n+      check(new StringBuilder().append(sb), \"A\");\n+\n+      sb = new StringBuilder(\"A\\uDC01\\uFF21\\uD801\");\n+      sb.replace(1, 4, \"B\");\n+      check(sb, \"AB\");      \/\/ maybeLatin1 become true\n+      check(new StringBuilder(sb).append('A'), \"ABA\");\n+      check(new StringBuilder().append(sb), \"AB\");\n+    }\n+\n","filename":"test\/jdk\/java\/lang\/StringBuilder\/CompactStringBuilder.java","additions":38,"deletions":1,"binary":false,"changes":39,"status":"modified"}]}