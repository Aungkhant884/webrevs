{"files":[{"patch":"@@ -3152,0 +3152,1 @@\n+  static const int max_attempts = 20;\n@@ -3153,4 +3154,3 @@\n-  do {\n-    char* extra_base = file_desc != -1 ?\n-      os::map_memory_to_file(extra_size, file_desc) :\n-      os::reserve_memory(extra_size);\n+  for (int attempt = 0; attempt < max_attempts && aligned_base == NULL; attempt ++) {\n+    char* extra_base = file_desc != -1 ? os::map_memory_to_file(extra_size, file_desc) :\n+                                         os::reserve_memory(extra_size);\n@@ -3163,4 +3163,5 @@\n-    if (file_desc != -1) {\n-      os::unmap_memory(extra_base, extra_size);\n-    } else {\n-      os::release_memory(extra_base, extra_size);\n+    bool rc = (file_desc != -1) ? os::unmap_memory(extra_base, extra_size) :\n+                                  os::release_memory(extra_base, extra_size);\n+    assert(rc, \"release failed\");\n+    if (!rc) {\n+      return NULL;\n@@ -3169,3 +3170,5 @@\n-    aligned_base = file_desc != -1 ?\n-      os::attempt_map_memory_to_file_at(aligned_base, size, file_desc) :\n-      os::attempt_reserve_memory_at(aligned_base, size);\n+    \/\/ Attempt to map, into the just vacated space, the slightly smaller aligned area.\n+    \/\/ Which may fail, hence the loop.\n+    aligned_base = file_desc != -1 ? os::attempt_map_memory_to_file_at(aligned_base, size, file_desc) :\n+                                     os::attempt_reserve_memory_at(aligned_base, size);\n+  }\n@@ -3173,1 +3176,1 @@\n-  } while (aligned_base == NULL);\n+  assert(aligned_base != NULL, \"Did not manage to re-map after %d attempts?\", max_attempts);\n","filename":"src\/hotspot\/os\/windows\/os_windows.cpp","additions":15,"deletions":12,"binary":false,"changes":27,"status":"modified"}]}