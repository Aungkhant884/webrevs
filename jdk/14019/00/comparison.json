{"files":[{"patch":"@@ -57,2 +57,2 @@\n-  void verify_before();\n-  void verify_after();\n+  void verify_before() NOT_DEBUG_RETURN;\n+  void verify_after() NOT_DEBUG_RETURN;\n@@ -69,0 +69,17 @@\n+  \/\/ Should notify allocation when either of these happen:\n+  \/\/   - a non-TLAB allocation;\n+  \/\/   - a TLAB allocation that refills the TLAB;\n+  \/\/   - a TLAB allocation that expands due to taking a sampler induced slow path;\n+  \/\/   - (optionally) the enabled JVMTI event that wants to capture all allocations;\n+\n+  bool should_notify_allocation_no_jvmti_vmobjalloc() {\n+    return _allocated_outside_tlab ||\n+           _allocated_tlab_size != 0 ||\n+           _tlab_end_reset_for_sample;\n+  }\n+\n+  bool should_notify_allocation() {\n+    return should_notify_allocation_no_jvmti_vmobjalloc() ||\n+           JvmtiExport::should_post_vm_object_alloc();\n+  }\n+\n@@ -87,1 +104,3 @@\n-      notify_allocation(_thread);\n+      if (should_notify_allocation()) {\n+        notify_allocation(_thread);\n+      }\n@@ -144,0 +163,1 @@\n+#ifdef ASSERT\n@@ -149,1 +169,1 @@\n-  debug_only(check_for_valid_allocation_state());\n+  check_for_valid_allocation_state();\n@@ -154,1 +174,1 @@\n-  NOT_PRODUCT(check_for_bad_heap_word_value();)\n+  check_for_bad_heap_word_value();\n@@ -169,1 +189,0 @@\n-#ifdef ASSERT\n@@ -190,3 +209,2 @@\n-  if (!_allocated_outside_tlab && _allocated_tlab_size == 0 && !_tlab_end_reset_for_sample) {\n-    \/\/ Sample if it's a non-TLAB allocation, or a TLAB allocation that either refills the TLAB\n-    \/\/ or expands it due to taking a sampler induced slow path.\n+  if (!should_notify_allocation_no_jvmti_vmobjalloc()) {\n+    \/\/ Called here only for JVMTI object alloc\n","filename":"src\/hotspot\/share\/gc\/shared\/memAllocator.cpp","additions":27,"deletions":9,"binary":false,"changes":36,"status":"modified"}]}