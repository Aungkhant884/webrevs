{"files":[{"patch":"@@ -1731,1 +1731,1 @@\n-    p_sig_msem = (msemaphore*)os::reserve_memory(sizeof(msemaphore), NULL);\n+    p_sig_msem = (msemaphore*)os::reserve_memory(sizeof(msemaphore));\n@@ -2350,13 +2350,1 @@\n-\/\/ Will assert if a wish address is given and could not be obtained.\n-char* os::pd_reserve_memory(size_t bytes, char* requested_addr, size_t alignment_hint) {\n-\n-  \/\/ All other Unices do a mmap(MAP_FIXED) if the addr is given,\n-  \/\/ thereby clobbering old mappings at that place. That is probably\n-  \/\/ not intended, never used and almost certainly an error were it\n-  \/\/ ever be used this way (to try attaching at a specified address\n-  \/\/ without clobbering old mappings an alternate API exists,\n-  \/\/ os::attempt_reserve_memory_at()).\n-  \/\/ Instead of mimicking the dangerous coding of the other platforms, here I\n-  \/\/ just ignore the request address (release) or assert(debug).\n-  assert0(requested_addr == NULL);\n-\n+char* os::pd_reserve_memory(size_t bytes, size_t alignment_hint) {\n@@ -2371,1 +2359,1 @@\n-    return reserve_mmaped_memory(bytes, requested_addr, alignment_hint);\n+    return reserve_mmaped_memory(bytes, NULL \/* requested_addr *\/, alignment_hint);\n@@ -2374,1 +2362,1 @@\n-      return reserve_shmated_memory(bytes, requested_addr, alignment_hint);\n+      return reserve_shmated_memory(bytes, NULL \/* requested_addr *\/, alignment_hint);\n@@ -2376,1 +2364,1 @@\n-      return reserve_mmaped_memory(bytes, requested_addr, alignment_hint);\n+      return reserve_mmaped_memory(bytes, NULL \/* requested_addr *\/, alignment_hint);\n@@ -2547,1 +2535,1 @@\n-char* os::pd_attempt_reserve_memory_at(size_t bytes, char* requested_addr, int file_desc) {\n+char* os::pd_attempt_reserve_memory_at(char* requested_addr, size_t bytes, int file_desc) {\n@@ -2565,1 +2553,1 @@\n-char* os::pd_attempt_reserve_memory_at(size_t bytes, char* requested_addr) {\n+char* os::pd_attempt_reserve_memory_at(char* requested_addr, size_t bytes) {\n","filename":"src\/hotspot\/os\/aix\/os_aix.cpp","additions":7,"deletions":19,"binary":false,"changes":26,"status":"modified"},{"patch":"@@ -2021,3 +2021,0 @@\n-\/\/ If 'fixed' is true, anon_mmap() will attempt to reserve anonymous memory\n-\/\/ at 'requested_addr'. If there are existing memory mappings at the same\n-\/\/ location, however, they will be overwritten. If 'fixed' is false,\n@@ -2027,9 +2024,2 @@\n-static char* anon_mmap(char* requested_addr, size_t bytes, bool fixed) {\n-  char * addr;\n-  int flags;\n-\n-  flags = MAP_PRIVATE | MAP_NORESERVE | MAP_ANONYMOUS;\n-  if (fixed) {\n-    assert((uintptr_t)requested_addr % os::Bsd::page_size() == 0, \"unaligned address\");\n-    flags |= MAP_FIXED;\n-  }\n+static char* anon_mmap(char* requested_addr, size_t bytes) {\n+  int flags = MAP_PRIVATE | MAP_NORESERVE | MAP_ANONYMOUS;\n@@ -2040,2 +2030,1 @@\n-  addr = (char*)::mmap(requested_addr, bytes, PROT_NONE,\n-                       flags, -1, 0);\n+  char* addr = (char*)::mmap(requested_addr, bytes, PROT_NONE, flags, -1, 0);\n@@ -2050,3 +2039,3 @@\n-char* os::pd_reserve_memory(size_t bytes, char* requested_addr,\n-                            size_t alignment_hint) {\n-  return anon_mmap(requested_addr, bytes, (requested_addr != NULL));\n+char* os::pd_reserve_memory(size_t bytes, size_t alignment_hint) {\n+  \/\/ Ignores alignment hint\n+  return anon_mmap(NULL \/* addr *\/, bytes);\n@@ -2135,1 +2124,1 @@\n-char* os::pd_attempt_reserve_memory_at(size_t bytes, char* requested_addr, int file_desc) {\n+char* os::pd_attempt_reserve_memory_at(char* requested_addr, size_t bytes, int file_desc) {\n@@ -2137,1 +2126,1 @@\n-  char* result = pd_attempt_reserve_memory_at(bytes, requested_addr);\n+  char* result = pd_attempt_reserve_memory_at(requested_addr, bytes);\n@@ -2149,1 +2138,1 @@\n-char* os::pd_attempt_reserve_memory_at(size_t bytes, char* requested_addr) {\n+char* os::pd_attempt_reserve_memory_at(char* requested_addr, size_t bytes) {\n@@ -2162,1 +2151,1 @@\n-  char * addr = anon_mmap(requested_addr, bytes, false);\n+  char * addr = anon_mmap(requested_addr, bytes);\n","filename":"src\/hotspot\/os\/bsd\/os_bsd.cpp","additions":10,"deletions":21,"binary":false,"changes":31,"status":"modified"},{"patch":"@@ -3648,3 +3648,0 @@\n-\/\/ If 'fixed' is true, anon_mmap() will attempt to reserve anonymous memory\n-\/\/ at 'requested_addr'. If there are existing memory mappings at the same\n-\/\/ location, however, they will be overwritten. If 'fixed' is false,\n@@ -3654,9 +3651,2 @@\n-static char* anon_mmap(char* requested_addr, size_t bytes, bool fixed) {\n-  char * addr;\n-  int flags;\n-\n-  flags = MAP_PRIVATE | MAP_NORESERVE | MAP_ANONYMOUS;\n-  if (fixed) {\n-    assert((uintptr_t)requested_addr % os::Linux::page_size() == 0, \"unaligned address\");\n-    flags |= MAP_FIXED;\n-  }\n+static char* anon_mmap(char* requested_addr, size_t bytes) {\n+  int flags = MAP_PRIVATE | MAP_NORESERVE | MAP_ANONYMOUS;\n@@ -3667,2 +3657,1 @@\n-  addr = (char*)::mmap(requested_addr, bytes, PROT_NONE,\n-                       flags, -1, 0);\n+  char* addr = (char*)::mmap(requested_addr, bytes, PROT_NONE, flags, -1, 0);\n@@ -3681,2 +3670,1 @@\n-static char* anon_mmap_aligned(size_t bytes, size_t alignment, char* req_addr) {\n-\n+static char* anon_mmap_aligned(char* req_addr, size_t bytes, size_t alignment) {\n@@ -3688,6 +3676,2 @@\n-  char* start = (char*) ::mmap(req_addr, extra_size, PROT_NONE,\n-    MAP_PRIVATE|MAP_ANONYMOUS|MAP_NORESERVE,\n-    -1, 0);\n-  if (start == MAP_FAILED) {\n-    start = NULL;\n-  } else {\n+  char* start = anon_mmap(req_addr, bytes);\n+  if (start != NULL) {\n@@ -3719,3 +3703,3 @@\n-char* os::pd_reserve_memory(size_t bytes, char* requested_addr,\n-                            size_t alignment_hint) {\n-  return anon_mmap(requested_addr, bytes, (requested_addr != NULL));\n+char* os::pd_reserve_memory(size_t bytes, size_t alignment_hint) {\n+  \/\/ Ignores alignment hint\n+  return anon_mmap(NULL, bytes);\n@@ -4079,1 +4063,1 @@\n-  char* pre_reserved_addr = anon_mmap_aligned(bytes, alignment, NULL);\n+  char* pre_reserved_addr = anon_mmap_aligned(NULL \/* req_addr *\/, bytes, alignment);\n@@ -4248,1 +4232,1 @@\n-  char* const start = anon_mmap_aligned(bytes, alignment, req_addr);\n+  char* const start = anon_mmap_aligned(req_addr, bytes, alignment);\n@@ -4401,1 +4385,1 @@\n-char* os::pd_attempt_reserve_memory_at(size_t bytes, char* requested_addr, int file_desc) {\n+char* os::pd_attempt_reserve_memory_at(char* requested_addr, size_t bytes, int file_desc) {\n@@ -4403,1 +4387,1 @@\n-  char* result = pd_attempt_reserve_memory_at(bytes, requested_addr);\n+  char* result = pd_attempt_reserve_memory_at(requested_addr, bytes);\n@@ -4415,1 +4399,1 @@\n-char* os::pd_attempt_reserve_memory_at(size_t bytes, char* requested_addr) {\n+char* os::pd_attempt_reserve_memory_at(char* requested_addr, size_t bytes) {\n@@ -4428,1 +4412,1 @@\n-  char * addr = anon_mmap(requested_addr, bytes, false);\n+  char * addr = anon_mmap(requested_addr, bytes);\n","filename":"src\/hotspot\/os\/linux\/os_linux.cpp","additions":15,"deletions":31,"binary":false,"changes":46,"status":"modified"},{"patch":"@@ -329,1 +329,1 @@\n-    extra_base = os::reserve_memory(extra_size, NULL, alignment);\n+    extra_base = os::reserve_memory(extra_size, alignment);\n","filename":"src\/hotspot\/os\/posix\/os_posix.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -3066,2 +3066,2 @@\n-  reserve_memory(split, base);\n-  reserve_memory(size - split, split_address);\n+  attempt_reserve_memory_at(base, split);\n+  attempt_reserve_memory_at(split_address, size - split);\n@@ -3089,1 +3089,1 @@\n-    char* extra_base = os::reserve_memory(extra_size, NULL, alignment, file_desc);\n+    char* extra_base = os::reserve_memory_with_fd(extra_size, alignment, file_desc);\n@@ -3102,1 +3102,1 @@\n-    aligned_base = os::reserve_memory(size, aligned_base, 0, file_desc);\n+    aligned_base = os::attempt_reserve_memory_at(aligned_base, size, file_desc);\n@@ -3109,1 +3109,8 @@\n-char* os::pd_reserve_memory(size_t bytes, char* addr, size_t alignment_hint) {\n+char* os::pd_reserve_memory(size_t bytes, size_t alignment_hint) {\n+  \/\/ Ignores alignment hint\n+  return pd_attempt_reserve_memory_at(NULL \/* addr *\/, bytes);\n+}\n+\n+\/\/ Reserve memory at an arbitrary address, only if that area is\n+\/\/ available (and not reserved for something else).\n+char* os::pd_attempt_reserve_memory_at(char* addr, size_t bytes) {\n@@ -3140,9 +3147,1 @@\n-\/\/ Reserve memory at an arbitrary address, only if that area is\n-\/\/ available (and not reserved for something else).\n-char* os::pd_attempt_reserve_memory_at(size_t bytes, char* requested_addr) {\n-  \/\/ Windows os::reserve_memory() fails of the requested address range is\n-  \/\/ not avilable.\n-  return reserve_memory(bytes, requested_addr);\n-}\n-\n-char* os::pd_attempt_reserve_memory_at(size_t bytes, char* requested_addr, int file_desc) {\n+char* os::pd_attempt_reserve_memory_at(char* requested_addr, size_t bytes, int file_desc) {\n","filename":"src\/hotspot\/os\/windows\/os_windows.cpp","additions":13,"deletions":14,"binary":false,"changes":27,"status":"modified"},{"patch":"@@ -794,1 +794,1 @@\n-  char* addr = reserve_memory(bytes, NULL);\n+  char* addr = reserve_memory(bytes);\n","filename":"src\/hotspot\/os_cpu\/bsd_x86\/os_bsd_x86.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -250,1 +250,1 @@\n-  char* addr = reserve_memory(bytes, NULL);\n+  char* addr = reserve_memory(bytes);\n","filename":"src\/hotspot\/os_cpu\/bsd_zero\/os_bsd_zero.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -653,1 +653,1 @@\n-  char* addr = reserve_memory(bytes, NULL);\n+  char* addr = reserve_memory(bytes);\n@@ -862,1 +862,1 @@\n-  char* codebuf = os::attempt_reserve_memory_at(page_size, hint);\n+  char* codebuf = os::attempt_reserve_memory_at(hint, page_size);\n@@ -870,1 +870,1 @@\n-    codebuf = os::attempt_reserve_memory_at(page_size, hint);\n+    codebuf = os::attempt_reserve_memory_at(hint, page_size);\n","filename":"src\/hotspot\/os_cpu\/linux_x86\/os_linux_x86.cpp","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -276,1 +276,1 @@\n-  char* addr = reserve_memory(bytes, NULL);\n+  char* addr = reserve_memory(bytes);\n","filename":"src\/hotspot\/os_cpu\/linux_zero\/os_linux_zero.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -223,1 +223,1 @@\n-  char* ret = os::attempt_reserve_memory_at(rs.size(), rs.base(), _backing_fd);\n+  char* ret = os::attempt_reserve_memory_at(rs.base(), rs.size(), _backing_fd);\n@@ -270,1 +270,1 @@\n-  char* base = os::attempt_reserve_memory_at(rs_dram.size(), rs_dram.base());\n+  char* base = os::attempt_reserve_memory_at(rs_dram.base(), rs_dram.size());\n","filename":"src\/hotspot\/share\/gc\/g1\/g1RegionToSpaceMapper.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -46,1 +46,1 @@\n-  const uintptr_t addr = (uintptr_t)os::reserve_memory(size, NULL, alignment, mtGC);\n+  const uintptr_t addr = (uintptr_t)os::reserve_memory(size, alignment, mtGC);\n","filename":"src\/hotspot\/share\/gc\/z\/zMarkStackAllocator.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -60,1 +60,1 @@\n-  char* addr = os::reserve_memory(size, NULL, alignment, flags);\n+  char* addr = os::reserve_memory(size, alignment, flags);\n@@ -78,1 +78,1 @@\n-  char* addr = os::reserve_memory(size, NULL, alignment, flags);\n+  char* addr = os::reserve_memory(size, alignment, flags);\n","filename":"src\/hotspot\/share\/memory\/allocation.inline.hpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -191,1 +191,1 @@\n-      base = os::attempt_reserve_memory_at(size, requested_address, _fd_for_heap);\n+      base = os::attempt_reserve_memory_at(requested_address, size, _fd_for_heap);\n@@ -197,1 +197,1 @@\n-      base = os::reserve_memory(size, NULL, alignment, _fd_for_heap);\n+      base = os::reserve_memory_with_fd(size, alignment, _fd_for_heap);\n@@ -383,1 +383,1 @@\n-      base = os::attempt_reserve_memory_at(size, requested_address, _fd_for_heap);\n+      base = os::attempt_reserve_memory_at(requested_address, size, _fd_for_heap);\n@@ -385,1 +385,1 @@\n-      base = os::reserve_memory(size, NULL, alignment, _fd_for_heap);\n+      base = os::reserve_memory_with_fd(size, alignment, _fd_for_heap);\n","filename":"src\/hotspot\/share\/memory\/virtualspace.cpp","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -765,1 +765,1 @@\n-  addr = (jlong)(uintptr_t)os::attempt_reserve_memory_at((size_t)size, (char*)(uintptr_t)addr);\n+  addr = (jlong)(uintptr_t)os::attempt_reserve_memory_at((char*)(uintptr_t)addr, (size_t)size);\n@@ -1476,1 +1476,1 @@\n-  p = os::reserve_memory(os::vm_allocation_granularity(), NULL, 0);\n+  p = os::reserve_memory(os::vm_allocation_granularity());\n","filename":"src\/hotspot\/share\/prims\/whitebox.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -1655,2 +1655,14 @@\n-char* os::reserve_memory(size_t bytes, char* addr, size_t alignment_hint, int file_desc) {\n-  char* result = NULL;\n+char* os::reserve_memory(size_t bytes, size_t alignment_hint, MEMFLAGS flags) {\n+  char* result = pd_reserve_memory(bytes, alignment_hint);\n+  if (result != NULL) {\n+    MemTracker::record_virtual_memory_reserve(result, bytes, CALLER_PC);\n+    if (flags != mtOther) {\n+      MemTracker::record_virtual_memory_type(result, flags);\n+    }\n+  }\n+\n+  return result;\n+}\n+\n+char* os::reserve_memory_with_fd(size_t bytes, size_t alignment_hint, int file_desc) {\n+  char* result;\n@@ -1661,1 +1673,1 @@\n-    result = os::map_memory_to_file(addr, bytes, file_desc);\n+    result = os::map_memory_to_file(NULL \/* addr *\/, bytes, file_desc);\n@@ -1663,1 +1675,1 @@\n-      MemTracker::record_virtual_memory_reserve_and_commit((address)result, bytes, CALLER_PC);\n+      MemTracker::record_virtual_memory_reserve_and_commit(result, bytes, CALLER_PC);\n@@ -1666,1 +1678,1 @@\n-    result = pd_reserve_memory(bytes, addr, alignment_hint);\n+    result = pd_reserve_memory(bytes, alignment_hint);\n@@ -1668,1 +1680,1 @@\n-      MemTracker::record_virtual_memory_reserve((address)result, bytes, CALLER_PC);\n+      MemTracker::record_virtual_memory_reserve(result, bytes, CALLER_PC);\n@@ -1675,12 +1687,1 @@\n-char* os::reserve_memory(size_t bytes, char* addr, size_t alignment_hint,\n-   MEMFLAGS flags) {\n-  char* result = pd_reserve_memory(bytes, addr, alignment_hint);\n-  if (result != NULL) {\n-    MemTracker::record_virtual_memory_reserve((address)result, bytes, CALLER_PC);\n-    MemTracker::record_virtual_memory_type((address)result, flags);\n-  }\n-\n-  return result;\n-}\n-\n-char* os::attempt_reserve_memory_at(size_t bytes, char* addr, int file_desc) {\n+char* os::attempt_reserve_memory_at(char* addr, size_t bytes, int file_desc) {\n@@ -1689,1 +1690,1 @@\n-    result = pd_attempt_reserve_memory_at(bytes, addr, file_desc);\n+    result = pd_attempt_reserve_memory_at(addr, bytes, file_desc);\n@@ -1694,1 +1695,1 @@\n-    result = pd_attempt_reserve_memory_at(bytes, addr);\n+    result = pd_attempt_reserve_memory_at(addr, bytes);\n","filename":"src\/hotspot\/share\/runtime\/os.cpp","additions":21,"deletions":20,"binary":false,"changes":41,"status":"modified"},{"patch":"@@ -116,4 +116,5 @@\n-  static char*  pd_reserve_memory(size_t bytes, char* addr = 0,\n-                                  size_t alignment_hint = 0);\n-  static char*  pd_attempt_reserve_memory_at(size_t bytes, char* addr);\n-  static char*  pd_attempt_reserve_memory_at(size_t bytes, char* addr, int file_desc);\n+  static char*  pd_reserve_memory(size_t bytes, size_t alignment_hint);\n+\n+  static char*  pd_attempt_reserve_memory_at(char* addr, size_t bytes);\n+  static char*  pd_attempt_reserve_memory_at(char* addr, size_t bytes, int file_desc);\n+\n@@ -313,4 +314,10 @@\n-  static char*  reserve_memory(size_t bytes, char* addr = 0,\n-                               size_t alignment_hint = 0, int file_desc = -1);\n-  static char*  reserve_memory(size_t bytes, char* addr,\n-                               size_t alignment_hint, MEMFLAGS flags);\n+\n+  \/\/ Reserves virtual memory.\n+  \/\/ alignment_hint - currently only used by AIX\n+  static char*  reserve_memory(size_t bytes, size_t alignment_hint = 0, MEMFLAGS flags = mtOther);\n+\n+  \/\/ Reserves virtual memory.\n+  \/\/ if file_desc != -1, also attaches the memory to the file.\n+  static char*  reserve_memory_with_fd(size_t bytes, size_t alignment_hint, int file_desc);\n+\n+  \/\/ Reserves virtual memory that starts at an address that is aligned to 'alignment'.\n@@ -318,1 +325,0 @@\n-  static char*  attempt_reserve_memory_at(size_t bytes, char* addr, int file_desc = -1);\n@@ -320,0 +326,3 @@\n+  \/\/ Attempts to reserve the virtual memory at [addr, addr + bytes).\n+  \/\/ Does not overwrite existing mappings.\n+  static char*  attempt_reserve_memory_at(char* addr, size_t bytes, int file_desc = -1);\n","filename":"src\/hotspot\/share\/runtime\/os.hpp","additions":18,"deletions":9,"binary":false,"changes":27,"status":"modified"},{"patch":"@@ -50,1 +50,1 @@\n-    char* polling_page = os::reserve_memory(allocation_size, NULL, page_size);\n+    char* polling_page = os::reserve_memory(allocation_size, page_size);\n","filename":"src\/hotspot\/share\/runtime\/safepointMechanism.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -104,1 +104,1 @@\n-    char* base = os::reserve_memory(size, NULL, page_sz, mtThreadStack);\n+    char* base = os::reserve_memory(size, page_sz, mtThreadStack);\n@@ -172,1 +172,1 @@\n-    char* base = os::reserve_memory(size, NULL, page_sz, mtTest);\n+    char* base = os::reserve_memory(size, page_sz, mtTest);\n","filename":"test\/hotspot\/gtest\/runtime\/test_committed_virtualmemory.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"}]}