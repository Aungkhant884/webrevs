{"files":[{"patch":"@@ -343,0 +343,3 @@\n+    SETBC_OPCODE  = (31u << OPCODE_SHIFT | 384u << 1),\n+    SETNBC_OPCODE = (31u << OPCODE_SHIFT | 448u << 1),\n+\n@@ -1680,0 +1683,6 @@\n+  \/\/ >= Power10\n+  inline void setbc( Register d, int biint);\n+  inline void setbc( Register d, ConditionRegister cr, Condition cc);\n+  inline void setnbc(Register d, int biint);\n+  inline void setnbc(Register d, ConditionRegister cr, Condition cc);\n+\n","filename":"src\/hotspot\/cpu\/ppc\/assembler_ppc.hpp","additions":9,"deletions":0,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -384,0 +384,11 @@\n+inline void Assembler::setbc(Register d, int biint)\n+                                                  { emit_int32(SETBC_OPCODE | rt(d) | bi(biint)); }\n+inline void Assembler::setbc(Register d, ConditionRegister cr, Condition cc) {\n+    setbc(d, bi0(cr, cc));\n+}\n+inline void Assembler::setnbc(Register d, int biint)\n+                                                  { emit_int32(SETNBC_OPCODE | rt(d) | bi(biint)); }\n+inline void Assembler::setnbc(Register d, ConditionRegister cr, Condition cc) {\n+    setnbc(d, bi0(cr, cc));\n+}\n+\n","filename":"src\/hotspot\/cpu\/ppc\/assembler_ppc.inline.hpp","additions":11,"deletions":0,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -1530,1 +1530,0 @@\n-  Label done;\n@@ -1540,2 +1539,1 @@\n-    __ li(Rdst, is_unordered_less ? -1 : 1);\n-    __ bso(CCR0, done);\n+    __ set_cmpu3(Rdst, is_unordered_less); \/\/ is_unordered_less ? -1 : 1\n@@ -1544,0 +1542,1 @@\n+    __ set_cmp3(Rdst);  \/\/ set result as follows: <: -1, =: 0, >: 1\n@@ -1547,5 +1546,0 @@\n-  __ mfcr(R0); \/\/ set bit 32..33 as follows: <: 0b10, =: 0b00, >: 0b01\n-  __ srwi(Rdst, R0, 30);\n-  __ srawi(R0, R0, 31);\n-  __ orr(Rdst, R0, Rdst); \/\/ set result as follows: <: -1, =: 0, >: 1\n-  __ bind(done);\n","filename":"src\/hotspot\/cpu\/ppc\/c1_LIRAssembler_ppc.cpp","additions":2,"deletions":8,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -164,0 +164,4 @@\n+  \/\/ set dst to -1, 0, +1\n+  void inline set_cmp3(Register dst);\n+  \/\/ set dst to (treat_unordered_like_less ? -1 : +1)\n+  void inline set_cmpu3(Register dst, bool treat_unordered_like_less);\n","filename":"src\/hotspot\/cpu\/ppc\/macroAssembler_ppc.hpp","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -239,0 +239,24 @@\n+\/\/ set dst to -1, 0, +1\n+inline void MacroAssembler::set_cmp3(Register dst) {\n+  assert_different_registers(dst, R0);\n+  \/\/ P10, prefer using setbc intructions\n+  if (VM_Version::has_brw()) {\n+    setbc(R0, CCR0, Assembler::greater);\n+    setnbc(dst, CCR0, Assembler::less);\n+  } else {\n+    mfcr(R0); \/\/ set bit 32..33 as follows: <: 0b10, =: 0b00, >: 0b01\n+    srwi(dst, R0, 30);\n+    srawi(R0, R0, 31);\n+  }\n+  orr(dst, dst, R0);\n+}\n+\n+\/\/ set dst to (treat_unordered_like_less ? -1 : +1)\n+inline void MacroAssembler::set_cmpu3(Register dst, bool treat_unordered_like_less) {\n+  if (treat_unordered_like_less) {\n+    cror(CCR0, Assembler::less, CCR0, Assembler::summary_overflow); \/\/ treat unordered like less\n+  } else {\n+    cror(CCR0, Assembler::greater, CCR0, Assembler::summary_overflow); \/\/ treat unordered like greater\n+  }\n+  set_cmp3(dst);\n+}\n","filename":"src\/hotspot\/cpu\/ppc\/macroAssembler_ppc.inline.hpp","additions":24,"deletions":0,"binary":false,"changes":24,"status":"modified"},{"patch":"@@ -11421,4 +11421,5 @@\n-instruct cmovI_conIvalueMinus1_conIvalue1(iRegIdst dst, flagsRegSrc crx) %{\n-  \/\/ no match-rule, false predicate\n-  effect(DEF dst, USE crx);\n-  predicate(false);\n+\/\/ Manifest a CmpL3 result in an integer register.\n+instruct cmpL3_reg_reg(iRegIdst dst, iRegLsrc src1, iRegLsrc src2) %{\n+  match(Set dst (CmpL3 src1 src2));\n+  ins_cost(DEFAULT_COST * 5);\n+  size(VM_Version::has_brw() ? 16 : 20);\n@@ -11426,1 +11427,1 @@\n-  ins_variable_size_depending_on_alignment(true);\n+  format %{ \"cmpL3_reg_reg $dst, $src1, $src2\" %}\n@@ -11428,3 +11429,0 @@\n-  format %{ \"cmovI   $crx, $dst, -1, 0, +1\" %}\n-  \/\/ Worst case is branch + move + branch + move + stop, no stop without scheduler.\n-  size(16);\n@@ -11432,72 +11430,2 @@\n-    Label done;\n-    \/\/ li(Rdst, 0);              \/\/ equal -> 0\n-    __ beq($crx$$CondRegister, done);\n-    __ li($dst$$Register, 1);    \/\/ greater -> +1\n-    __ bgt($crx$$CondRegister, done);\n-    __ li($dst$$Register, -1);   \/\/ unordered or less -> -1\n-    __ bind(done);\n-  %}\n-  ins_pipe(pipe_class_compare);\n-%}\n-\n-instruct cmovI_conIvalueMinus1_conIvalue0_conIvalue1_Ex(iRegIdst dst, flagsRegSrc crx) %{\n-  \/\/ no match-rule, false predicate\n-  effect(DEF dst, USE crx);\n-  predicate(false);\n-\n-  format %{ \"CmovI    $crx, $dst, -1, 0, +1 \\t\/\/ postalloc expanded\" %}\n-  postalloc_expand %{\n-    \/\/\n-    \/\/ replaces\n-    \/\/\n-    \/\/   region  crx\n-    \/\/    \\       |\n-    \/\/     dst=cmovI_conIvalueMinus1_conIvalue0_conIvalue1\n-    \/\/\n-    \/\/ with\n-    \/\/\n-    \/\/   region\n-    \/\/    \\\n-    \/\/     dst=loadConI16(0)\n-    \/\/      |\n-    \/\/      ^  region  crx\n-    \/\/      |   \\       |\n-    \/\/      dst=cmovI_conIvalueMinus1_conIvalue1\n-    \/\/\n-\n-    \/\/ Create new nodes.\n-    MachNode *m1 = new loadConI16Node();\n-    MachNode *m2 = new cmovI_conIvalueMinus1_conIvalue1Node();\n-\n-    \/\/ inputs for new nodes\n-    m1->add_req(n_region);\n-    m2->add_req(n_region, n_crx);\n-    m2->add_prec(m1);\n-\n-    \/\/ operands for new nodes\n-    m1->_opnds[0] = op_dst;\n-    m1->_opnds[1] = new immI16Oper(0);\n-    m2->_opnds[0] = op_dst;\n-    m2->_opnds[1] = op_crx;\n-\n-    \/\/ registers for new nodes\n-    ra_->set_pair(m1->_idx, ra_->get_reg_second(this), ra_->get_reg_first(this)); \/\/ dst\n-    ra_->set_pair(m2->_idx, ra_->get_reg_second(this), ra_->get_reg_first(this)); \/\/ dst\n-\n-    \/\/ Insert new nodes.\n-    nodes->push(m1);\n-    nodes->push(m2);\n-  %}\n-%}\n-\n-\/\/ Manifest a CmpL3 result in an integer register. Very painful.\n-\/\/ This is the test to avoid.\n-\/\/ (src1 < src2) ? -1 : ((src1 > src2) ? 1 : 0)\n-instruct cmpL3_reg_reg_ExEx(iRegIdst dst, iRegLsrc src1, iRegLsrc src2) %{\n-  match(Set dst (CmpL3 src1 src2));\n-  ins_cost(DEFAULT_COST*5+BRANCH_COST);\n-\n-  expand %{\n-    flagsReg tmp1;\n-    cmpL_reg_reg(tmp1, src1, src2);\n-    cmovI_conIvalueMinus1_conIvalue0_conIvalue1_Ex(dst, tmp1);\n+    __ cmpd(CCR0, $src1$$Register, $src2$$Register);\n+    __ set_cmp3($dst$$Register);\n@@ -11505,0 +11433,1 @@\n+  ins_pipe(pipe_class_default);\n@@ -11827,1 +11756,1 @@\n-instruct cmpF3_reg_reg_ExEx(iRegIdst dst, regF src1, regF src2) %{\n+instruct cmpF3_reg_reg(iRegIdst dst, regF src1, regF src2) %{\n@@ -11829,1 +11758,2 @@\n-  ins_cost(DEFAULT_COST*5+BRANCH_COST);\n+  ins_cost(DEFAULT_COST * 6);\n+  size(VM_Version::has_brw() ? 20 : 24);\n@@ -11831,4 +11761,6 @@\n-  expand %{\n-    flagsReg tmp1;\n-    cmpFUnordered_reg_reg(tmp1, src1, src2);\n-    cmovI_conIvalueMinus1_conIvalue0_conIvalue1_Ex(dst, tmp1);\n+  format %{ \"cmpF3_reg_reg $dst, $src1, $src2\" %}\n+\n+  ins_encode %{\n+    __ fcmpu(CCR0, $src1$$FloatRegister, $src2$$FloatRegister);\n+    __ cror(CCR0, Assembler::less, CCR0, Assembler::summary_overflow);\n+    __ set_cmp3($dst$$Register);\n@@ -11836,0 +11768,1 @@\n+  ins_pipe(pipe_class_default);\n@@ -11907,1 +11840,1 @@\n-instruct cmpD3_reg_reg_ExEx(iRegIdst dst, regD src1, regD src2) %{\n+instruct cmpD3_reg_reg(iRegIdst dst, regD src1, regD src2) %{\n@@ -11909,1 +11842,2 @@\n-  ins_cost(DEFAULT_COST*5+BRANCH_COST);\n+  ins_cost(DEFAULT_COST * 6);\n+  size(VM_Version::has_brw() ? 20 : 24);\n@@ -11911,4 +11845,6 @@\n-  expand %{\n-    flagsReg tmp1;\n-    cmpDUnordered_reg_reg(tmp1, src1, src2);\n-    cmovI_conIvalueMinus1_conIvalue0_conIvalue1_Ex(dst, tmp1);\n+  format %{ \"cmpD3_reg_reg $dst, $src1, $src2\" %}\n+\n+  ins_encode %{\n+    __ fcmpu(CCR0, $src1$$FloatRegister, $src2$$FloatRegister);\n+    __ cror(CCR0, Assembler::less, CCR0, Assembler::summary_overflow);\n+    __ set_cmp3($dst$$Register);\n@@ -11916,0 +11852,1 @@\n+  ins_pipe(pipe_class_default);\n","filename":"src\/hotspot\/cpu\/ppc\/ppc.ad","additions":29,"deletions":92,"binary":false,"changes":121,"status":"modified"},{"patch":"@@ -1593,4 +1593,1 @@\n-  __ mfcr(R17_tos); \/\/ set bit 32..33 as follows: <: 0b10, =: 0b00, >: 0b01\n-  __ srwi(Rscratch, R17_tos, 30);\n-  __ srawi(R17_tos, R17_tos, 31);\n-  __ orr(R17_tos, Rscratch, R17_tos); \/\/ set result as follows: <: -1, =: 0, >: 1\n+  __ set_cmp3(R17_tos); \/\/ set result as follows: <: -1, =: 0, >: 1\n@@ -1613,1 +1610,0 @@\n-  Label Lunordered, Ldone;\n@@ -1615,13 +1611,2 @@\n-  if (unordered_result) {\n-    __ bso(CCR0, Lunordered);\n-  }\n-  __ mfcr(R17_tos); \/\/ set bit 32..33 as follows: <: 0b10, =: 0b00, >: 0b01\n-  __ srwi(Rscratch, R17_tos, 30);\n-  __ srawi(R17_tos, R17_tos, 31);\n-  __ orr(R17_tos, Rscratch, R17_tos); \/\/ set result as follows: <: -1, =: 0, >: 1\n-  if (unordered_result) {\n-    __ b(Ldone);\n-    __ bind(Lunordered);\n-    __ load_const_optimized(R17_tos, unordered_result);\n-  }\n-  __ bind(Ldone);\n+  \/\/ if unordered_result is 1, treat unordered_result like 'greater than'\n+  __ set_cmpu3(R17_tos, (unordered_result == 1) ? false : true);\n","filename":"src\/hotspot\/cpu\/ppc\/templateTable_ppc_64.cpp","additions":3,"deletions":18,"binary":false,"changes":21,"status":"modified"}]}