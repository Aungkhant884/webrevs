{"files":[{"patch":"@@ -407,5 +407,0 @@\n-template <typename T> T* ArchiveHeapWriter::requested_field_addr_in_buffer(oop requested_obj, size_t field_offset) {\n-  T* request_p = (T*)(cast_from_oop<address>(requested_obj) + field_offset);\n-  return requested_addr_to_buffered_addr(request_p);\n-}\n-\n@@ -421,2 +416,1 @@\n-template <typename T> oop ArchiveHeapWriter::load_source_field_from_requested_obj(oop requested_obj, size_t field_offset) {\n-  T* buffered_addr = requested_field_addr_in_buffer<T>(requested_obj, field_offset);\n+template <typename T> oop ArchiveHeapWriter::load_source_oop_from_buffer(T* buffered_addr) {\n@@ -428,4 +422,4 @@\n-template <typename T> void ArchiveHeapWriter::store_requested_field_in_requested_obj(oop requested_obj, size_t field_offset,\n-                                                                                     oop request_field_val) {\n-  T* buffered_addr = requested_field_addr_in_buffer<T>(requested_obj, field_offset);\n-  store_oop_in_buffer(buffered_addr, request_field_val);\n+template <typename T> void ArchiveHeapWriter::store_requested_oop_in_buffer(T* buffered_addr,\n+                                                                            oop request_oop) {\n+  assert(is_in_requested_regions(request_oop), \"must be\");\n+  store_oop_in_buffer(buffered_addr, request_oop);\n@@ -454,2 +448,2 @@\n-template <typename T> void ArchiveHeapWriter::relocate_field_in_requested_obj(oop requested_obj, size_t field_offset) {\n-  oop source_referent = load_source_field_from_requested_obj<T>(requested_obj, field_offset);\n+template <typename T> void ArchiveHeapWriter::relocate_field_in_buffer(T* field_addr_in_buffer) {\n+  oop source_referent = load_source_oop_from_buffer<T>(field_addr_in_buffer);\n@@ -458,2 +452,2 @@\n-    store_requested_field_in_requested_obj<T>(requested_obj, field_offset, request_referent);\n-    mark_oop_pointer<T>(requested_obj, field_offset);\n+    store_requested_oop_in_buffer<T>(field_addr_in_buffer, request_referent);\n+    mark_oop_pointer<T>(field_addr_in_buffer);\n@@ -463,2 +457,2 @@\n-template <typename T> void ArchiveHeapWriter::mark_oop_pointer(oop requested_obj, size_t field_offset) {\n-  T* request_p = (T*)(cast_from_oop<address>(requested_obj) + field_offset);\n+template <typename T> void ArchiveHeapWriter::mark_oop_pointer(T* buffered_addr) {\n+  T* request_p = (T*)(buffered_addr_to_requested_addr((address)buffered_addr));\n@@ -512,1 +506,1 @@\n-  relocate_field_in_requested_obj<T>(requested_roots, offset);\n+  relocate_field_in_buffer<T>((T*)(buffered_heap_roots_addr() + offset));\n@@ -517,1 +511,2 @@\n-  oop _requested_obj;\n+  address _buffered_obj;\n+\n@@ -519,2 +514,2 @@\n-  EmbeddedOopRelocator(oop src_obj, oop requested_obj) :\n-    _src_obj(src_obj), _requested_obj(requested_obj) {}\n+  EmbeddedOopRelocator(oop src_obj, address buffered_obj) :\n+    _src_obj(src_obj), _buffered_obj(buffered_obj) {}\n@@ -528,1 +523,1 @@\n-    ArchiveHeapWriter::relocate_field_in_requested_obj<T>(_requested_obj, field_offset);\n+    ArchiveHeapWriter::relocate_field_in_buffer<T>((T*)(_buffered_obj + field_offset));\n@@ -548,1 +543,3 @@\n-    EmbeddedOopRelocator relocator(src_obj, requested_obj);\n+\n+    address buffered_obj = offset_to_buffered_address<address>(info.buffer_offset());\n+    EmbeddedOopRelocator relocator(src_obj, buffered_obj);\n","filename":"src\/hotspot\/share\/cds\/archiveHeapWriter.cpp","additions":20,"deletions":23,"binary":false,"changes":43,"status":"modified"},{"patch":"@@ -168,2 +168,2 @@\n-  template <typename T> static oop load_source_field_from_requested_obj(oop requested_obj, size_t field_offset);\n-  template <typename T> static void store_requested_field_in_requested_obj(oop requested_obj, size_t field_offset, oop request_field_val);\n+  template <typename T> static oop load_source_oop_from_buffer(T* buffered_addr);\n+  template <typename T> static void store_requested_oop_in_buffer(T* buffered_addr, oop request_oop);\n@@ -172,3 +172,2 @@\n-  template <typename T> static T* requested_field_addr_in_buffer(oop request_p, size_t field_offset);\n-  template <typename T> static void relocate_field_in_requested_obj(oop requested_obj, size_t field_offset);\n-  template <typename T> static void mark_oop_pointer(oop requested_obj, size_t field_offset);\n+  template <typename T> static void relocate_field_in_buffer(T* field_addr_in_buffer);\n+  template <typename T> static void mark_oop_pointer(T* buffered_addr);\n","filename":"src\/hotspot\/share\/cds\/archiveHeapWriter.hpp","additions":4,"deletions":5,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -862,1 +862,3 @@\n-    roots_oop = ArchiveHeapWriter::heap_roots_requested_address();\n+    if (HeapShared::can_write()) {\n+      roots_oop = ArchiveHeapWriter::heap_roots_requested_address();\n+    }\n","filename":"src\/hotspot\/share\/cds\/heapShared.cpp","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"}]}