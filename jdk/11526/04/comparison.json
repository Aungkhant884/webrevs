{"files":[{"patch":"@@ -30,0 +30,2 @@\n+#include \"metaprogramming\/removeCV.hpp\"\n+#include \"metaprogramming\/removePointer.hpp\"\n@@ -64,1 +66,1 @@\n-  static void free_metadata(ClassLoaderData* loader_data, T md) {\n+  static void free_metadata(ClassLoaderData* loader_data, T md, bool invoke_destructor = false) {\n@@ -72,1 +74,10 @@\n-      loader_data->metaspace_non_null()->deallocate((MetaWord*)md, size, md->is_klass());\n+      bool is_klass = md->is_klass();\n+      \/\/ If requested, call the destructor.\n+      if (invoke_destructor) {\n+        \/\/ This is currently used for MethodData which has a member that needs to be destructed to\n+        \/\/ release resources. Most Metadata derived classes have noop destructors and\/or cleanup\n+        \/\/ using deallocate_contents.\n+        using U = typename RemoveCV<typename RemovePointer<T>::type>::type;\n+        md->~U();\n+      }\n+      loader_data->metaspace_non_null()->deallocate((MetaWord*)md, size, is_klass);\n","filename":"src\/hotspot\/share\/memory\/metadataFactory.hpp","additions":13,"deletions":2,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -134,1 +134,1 @@\n-  MetadataFactory::free_metadata(loader_data, method_data());\n+  MetadataFactory::free_metadata(loader_data, method_data(), \/*invoke_destructor*\/ true);\n@@ -147,2 +147,0 @@\n-    \/\/ Destroy MethodData\n-    method_data()->~MethodData();\n@@ -602,1 +600,1 @@\n-    MetadataFactory::free_metadata(loader_data, method_data);\n+    MetadataFactory::free_metadata(loader_data, method_data, \/*invoke_destructor*\/ true);\n","filename":"src\/hotspot\/share\/oops\/method.cpp","additions":2,"deletions":4,"binary":false,"changes":6,"status":"modified"}]}