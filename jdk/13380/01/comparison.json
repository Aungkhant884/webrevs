{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2013, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2013, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -24,3 +24,0 @@\n-import test.java.awt.regtesthelpers.Util;\n-\n-import javax.swing.SwingUtilities;\n@@ -30,0 +27,1 @@\n+import java.awt.Toolkit;\n@@ -32,0 +30,1 @@\n+import javax.swing.SwingUtilities;\n@@ -33,1 +32,1 @@\n-\/**\n+\/*\n@@ -38,4 +37,20 @@\n- * @library ..\/..\/regtesthelpers\n- * @build Util\n- * @compile GetMousePositionWithPopup.java\n- * @run main GetMousePositionWithPopup\n+ *\n+ * @requires (os.family == \"windows\")\n+ * @run main\/othervm -Dsun.java2d.uiScale.enabled=true -Dsun.java2d.uiScale=1 GetMousePositionWithPopup\n+ * @run main\/othervm -Dsun.java2d.uiScale.enabled=true -Dsun.java2d.uiScale=1.25 GetMousePositionWithPopup\n+ * @run main\/othervm -Dsun.java2d.uiScale.enabled=true -Dsun.java2d.uiScale=1.5 GetMousePositionWithPopup\n+ * @run main\/othervm -Dsun.java2d.uiScale.enabled=true -Dsun.java2d.uiScale=1.75 GetMousePositionWithPopup\n+ * @run main\/othervm -Dsun.java2d.uiScale.enabled=true -Dsun.java2d.uiScale=2 GetMousePositionWithPopup\n+ * @run main\/othervm -Dsun.java2d.uiScale.enabled=true -Dsun.java2d.uiScale=3 GetMousePositionWithPopup\n+ *\/\n+\n+\/*\n+ * @test\n+ * @key headful\n+ * @bug 8012026 8027154\n+ * @summary Component.getMousePosition() does not work in an applet on MacOS\n+ *\n+ * @requires (os.family == \"mac\" | os.family == \"linux\")\n+ * @run main\/othervm -Dsun.java2d.uiScale.enabled=true -Dsun.java2d.uiScale=1 GetMousePositionWithPopup\n+ * @run main\/othervm -Dsun.java2d.uiScale.enabled=true -Dsun.java2d.uiScale=2 GetMousePositionWithPopup\n+ * @run main\/othervm -Dsun.java2d.uiScale.enabled=true -Dsun.java2d.uiScale=3 GetMousePositionWithPopup\n@@ -48,0 +63,12 @@\n+    private static Robot robot;\n+\n+    private static final int MOUSE_POS1 = 0;\n+    private static final int MOUSE_POS2 = 149;\n+    private static final int MOUSE_POS3 = 170;\n+\n+    private static final int FRAME1_DIM = 100;\n+    private static final int FRAME2_DIM = 120;\n+\n+    \/\/expected mouse position w.r.t to Component\n+    \/\/(2nd Frame in this test) after 3rd mouse move.\n+    private static final int EXPECTED_MOUSE_POS = MOUSE_POS3 - FRAME2_DIM;\n@@ -51,4 +78,2 @@\n-        Robot r = Util.createRobot();\n-        r.setAutoDelay(100);\n-        r.mouseMove(0, 0);\n-        Util.waitForIdle(null);\n+            robot = new Robot();\n+            robot.setAutoDelay(200);\n@@ -56,6 +81,6 @@\n-        SwingUtilities.invokeAndWait(new Runnable() {\n-            @Override\n-            public void run() {\n-                constructTestUI();\n-            }\n-        });\n+            \/\/1st mouse move\n+            robot.mouseMove(MOUSE_POS1, MOUSE_POS1);\n+            syncLocationToWindowManager();\n+\n+            SwingUtilities.invokeAndWait(GetMousePositionWithPopup::createTestUI);\n+            syncLocationToWindowManager();\n@@ -63,5 +88,3 @@\n-        Util.waitForIdle(null);\n-        r.mouseMove(149, 149);\n-        Util.waitForIdle(null);\n-        r.mouseMove(170, 170);\n-        Util.waitForIdle(null);\n+            \/\/2nd mouse move\n+            robot.mouseMove(MOUSE_POS2, MOUSE_POS2);\n+            syncLocationToWindowManager();\n@@ -69,0 +92,4 @@\n+            SwingUtilities.invokeAndWait(GetMousePositionWithPopup::addMouseListenerToFrame2);\n+            \/\/3rd mouse move\n+            robot.mouseMove(MOUSE_POS3, MOUSE_POS3);\n+            syncLocationToWindowManager();\n@@ -70,6 +97,3 @@\n-            SwingUtilities.invokeLater(new Runnable() {\n-                @Override\n-                public void run() {\n-                    frame1.dispose();\n-                    frame2.dispose();\n-                }\n+            SwingUtilities.invokeLater(() -> {\n+                frame1.dispose();\n+                frame2.dispose();\n@@ -80,1 +104,1 @@\n-    private static void constructTestUI() {\n+    private static void createTestUI() {\n@@ -82,1 +106,1 @@\n-        frame1.setBounds(100, 100, 100, 100);\n+        frame1.setBounds(FRAME1_DIM, FRAME1_DIM, FRAME1_DIM, FRAME1_DIM);\n@@ -91,1 +115,1 @@\n-                frame2.setBounds(120, 120, 120, 120);\n+                frame2.setBounds(FRAME2_DIM, FRAME2_DIM, FRAME2_DIM, FRAME2_DIM);\n@@ -93,18 +117,0 @@\n-                frame2.addMouseMotionListener(new MouseMotionAdapter() {\n-                    @Override\n-                    public void mouseMoved(MouseEvent e)\n-                    {\n-                        Point positionInFrame2 = frame2.getMousePosition();\n-                        int deltaX = Math.abs(50 - positionInFrame2.x);\n-                        int deltaY = Math.abs(50 - positionInFrame2.y);\n-                        if (deltaX > 2 || deltaY > 2) {\n-                            throw new RuntimeException(\"Wrong position reported. Should be [50, 50] but was [\" +\n-                                    positionInFrame2.x + \", \" + positionInFrame2.y + \"]\");\n-                        }\n-\n-                        Point positionInFrame1 = frame1.getMousePosition();\n-                        if (positionInFrame1 != null) {\n-                            throw new RuntimeException(\"Wrong position reported. Should be null\");\n-                        }\n-                    }\n-                });\n@@ -114,0 +120,32 @@\n+\n+    private static void addMouseListenerToFrame2() {\n+        frame2.addMouseMotionListener(new MouseMotionAdapter() {\n+            @Override\n+            public void mouseMoved(MouseEvent e) {\n+                Point positionInFrame2 = frame2.getMousePosition();\n+                int deltaX = Math.abs(EXPECTED_MOUSE_POS - positionInFrame2.x);\n+                int deltaY = Math.abs(EXPECTED_MOUSE_POS - positionInFrame2.y);\n+                if (deltaX > 2 || deltaY > 2) {\n+                    throw new RuntimeException(\"Wrong position reported for Frame 2.\"\n+                            + \" Should be [50, 50] but was \" + \"[\" + positionInFrame2.x\n+                            + \", \" + positionInFrame2.y + \"]\");\n+                }\n+\n+                Point positionInFrame1 = frame1.getMousePosition();\n+                if (positionInFrame1 != null) {\n+                    throw new RuntimeException(\"Wrong position reported for Frame 1.\"\n+                            + \" Should be null\");\n+                }\n+            }\n+        });\n+    }\n+\n+    private static void syncLocationToWindowManager() {\n+        Toolkit.getDefaultToolkit().sync();\n+        try {\n+            Thread.sleep(500);\n+        } catch (InterruptedException e) {\n+            e.printStackTrace();\n+        }\n+        robot.waitForIdle();\n+    }\n","filename":"test\/jdk\/java\/awt\/Mouse\/GetMousePositionTest\/GetMousePositionWithPopup.java","additions":89,"deletions":51,"binary":false,"changes":140,"status":"modified"}]}