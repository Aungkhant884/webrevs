{"files":[{"patch":"@@ -299,3 +299,3 @@\n-      if (PrintDeoptimizationDetails) {\n-        ResourceMark rm;\n-        stringStream st;\n+      LogMessage(deoptimization) lm;\n+      if (lm.is_debug()) {\n+        NonInterleavingLogStream ls(LogLevelType::Debug, lm);\n@@ -307,1 +307,1 @@\n-              st.print_cr(\"RELOCK OBJECTS in thread \" INTPTR_FORMAT, p2i(thread));\n+              ls.print_cr(\"RELOCK OBJECTS in thread \" INTPTR_FORMAT, p2i(thread));\n@@ -312,1 +312,1 @@\n-                st.print_cr(\"     object <\" INTPTR_FORMAT \"> DEFERRED relocking after wait\", p2i(mi->owner()));\n+                ls.print_cr(\"     object <\" INTPTR_FORMAT \"> DEFERRED relocking after wait\", p2i(mi->owner()));\n@@ -318,1 +318,1 @@\n-              st.print_cr(\"     failed reallocation for klass %s\", k->external_name());\n+              ls.print_cr(\"     failed reallocation for klass %s\", k->external_name());\n@@ -320,1 +320,1 @@\n-              st.print_cr(\"     object <\" INTPTR_FORMAT \"> locked\", p2i(mi->owner()));\n+              ls.print_cr(\"     object <\" INTPTR_FORMAT \"> locked\", p2i(mi->owner()));\n@@ -324,1 +324,0 @@\n-        tty->print_raw(st.freeze());\n@@ -442,3 +441,4 @@\n-    if (PrintDeoptimizationDetails) {\n-      tty->print_cr(\"Exception to be rethrown in the interpreter for method %s::%s at bci %d\", trap_scope->method()->method_holder()->name()->as_C_string(), trap_scope->method()->name()->as_C_string(), trap_scope->bci());\n-    }\n+    log_debug(deoptimization)(\n+        \"Exception to be rethrown in the interpreter for method %s::%s at bci %d\",\n+        trap_scope->method()->method_holder()->name()->as_C_string(),\n+        trap_scope->method()->name()->as_C_string(), trap_scope->bci());\n@@ -1452,3 +1452,1 @@\n-    if (PrintDeoptimizationDetails) {\n-      tty->print_cr(\"reassign fields for object of type %s!\", k->name()->as_C_string());\n-    }\n+    log_debug(deoptimization)(\"reassign fields for object of type %s!\", k->name()->as_C_string());\n@@ -1474,3 +1472,5 @@\n-        if (PrintDeoptimizationDetails) {\n-          tty->print_cr(\"skip field reassignment for this vector - it should be assigned already\");\n-          if (Verbose) {\n+        log_debug(deoptimization)(\"skip field reassignment for this vector - it should be assigned already\");\n+        {\n+          LogMessage(deoptimization) lm;\n+          if (lm.is_trace()) {\n+            NonInterleavingLogStream ls(LogLevelType::Debug, lm);\n@@ -1478,1 +1478,1 @@\n-            k->oop_print_on(obj(), tty);\n+            k->oop_print_on(obj(), &ls);\n","filename":"src\/hotspot\/share\/runtime\/deoptimization.cpp","additions":18,"deletions":18,"binary":false,"changes":36,"status":"modified"},{"patch":"@@ -1269,3 +1269,0 @@\n-  develop(bool, PrintDeoptimizationDetails, false,                          \\\n-          \"Print more information about deoptimization\")                    \\\n-                                                                            \\\n","filename":"src\/hotspot\/share\/runtime\/globals.hpp","additions":0,"deletions":3,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -135,0 +135,3 @@\n+  print_on(tty);\n+}\n+void StackValueCollection::print_on(outputStream* st) const {\n@@ -136,2 +139,2 @@\n-    tty->print(\"\\t  %2d \", index);\n-    at(index)->print_on(tty);\n+    st->print(\"\\t  %2d \", index);\n+    at(index)->print_on(st);\n@@ -141,4 +144,4 @@\n-      tty->print(\"  \" INT64_FORMAT \" (long)\", (int64_t)long_at(index));\n-      tty->cr();\n-      tty->print(\"\\t     %.15e (double)\", double_at(index));\n-      tty->print(\"  \" INT64_FORMAT_X_0 \" (longhex)\", (int64_t)long_at(index));\n+      st->print(\"  \" INT64_FORMAT \" (long)\", (int64_t)long_at(index));\n+      st->cr();\n+      st->print(\"\\t     %.15e (double)\", double_at(index));\n+      st->print(\"  \" INT64_FORMAT_X_0 \" (longhex)\", (int64_t)long_at(index));\n@@ -146,1 +149,1 @@\n-    tty->cr();\n+    st->cr();\n@@ -149,1 +152,1 @@\n-#endif\n+#endif \/\/ !PRODUCT\n","filename":"src\/hotspot\/share\/runtime\/stackValueCollection.cpp","additions":11,"deletions":8,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -59,0 +59,1 @@\n+#ifndef PRODUCT\n@@ -60,0 +61,2 @@\n+  void print_on(outputStream* st) const override;\n+#endif \/\/ !PRODUCT\n","filename":"src\/hotspot\/share\/runtime\/stackValueCollection.hpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -54,0 +54,1 @@\n+#include \"runtime\/vframe.hpp\"\n@@ -681,1 +682,4 @@\n-  if (WizardMode) _fr.print_value_on(tty,NULL);\n+  if (WizardMode) print_on(tty);\n+}\n+void vframe::print_on(outputStream* st) const {\n+  if (WizardMode) _fr.print_value_on(st,NULL);\n@@ -693,0 +697,6 @@\n+void entryVFrame::print_on(outputStream *st) const {\n+  vframe::print_on(st);\n+  st->print_cr(\"C Chunk in between Java\");\n+  st->print_cr(\"C     link \" INTPTR_FORMAT, p2i(_fr.link()));\n+}\n+\n@@ -694,3 +704,1 @@\n-  vframe::print();\n-  tty->print_cr(\"C Chunk in between Java\");\n-  tty->print_cr(\"C     link \" INTPTR_FORMAT, p2i(_fr.link()));\n+  print_on(tty);\n@@ -702,1 +710,2 @@\n-static void print_stack_values(const char* title, StackValueCollection* values) {\n+static void print_stack_values_on(const char* title, StackValueCollection* values,\n+                                  outputStream* st) {\n@@ -704,2 +713,2 @@\n-  tty->print_cr(\"\\t%s:\", title);\n-  values->print();\n+  st->print_cr(\"\\t%s:\", title);\n+  values->print_on(st);\n@@ -708,1 +717,0 @@\n-\n@@ -710,0 +718,4 @@\n+  print_on(tty);\n+}\n+\n+void javaVFrame::print_on(outputStream* st) const {\n@@ -714,5 +726,5 @@\n-  vframe::print();\n-  tty->print(\"\\t\");\n-  method()->print_value();\n-  tty->cr();\n-  tty->print_cr(\"\\tbci:    %d\", bci());\n+  vframe::print_on(st);\n+  st->print(\"\\t\");\n+  method()->print_value_on(st);\n+  st->cr();\n+  st->print_cr(\"\\tbci:    %d\", bci());\n@@ -720,2 +732,2 @@\n-  print_stack_values(\"locals\",      locals());\n-  print_stack_values(\"expressions\", expressions());\n+  print_stack_values_on(\"locals\",      locals(), st);\n+  print_stack_values_on(\"expressions\", expressions(), st);\n@@ -725,1 +737,1 @@\n-  tty->print_cr(\"\\tmonitor list:\");\n+  st->print_cr(\"\\tmonitor list:\");\n@@ -728,1 +740,1 @@\n-    tty->print(\"\\t  obj\\t\");\n+    st->print(\"\\t  obj\\t\");\n@@ -731,1 +743,1 @@\n-      tty->print(\"( is scalar replaced %s)\", k->external_name());\n+      st->print(\"( is scalar replaced %s)\", k->external_name());\n@@ -733,1 +745,1 @@\n-      tty->print(\"( null )\");\n+      st->print(\"( null )\");\n@@ -736,1 +748,1 @@\n-      tty->print(\"(owner=\" INTPTR_FORMAT \")\", p2i(monitor->owner()));\n+      st->print(\"(owner=\" INTPTR_FORMAT \")\", p2i(monitor->owner()));\n@@ -740,1 +752,1 @@\n-        tty->print(\" ( lock is eliminated in compiled frame )\");\n+        st->print(\" ( lock is eliminated in compiled frame )\");\n@@ -742,1 +754,1 @@\n-        tty->print(\" ( lock is eliminated, frame not compiled )\");\n+        st->print(\" ( lock is eliminated, frame not compiled )\");\n@@ -745,4 +757,4 @@\n-    tty->cr();\n-    tty->print(\"\\t  \");\n-    monitor->lock()->print_on(tty, monitor->owner());\n-    tty->cr();\n+    st->cr();\n+    st->print(\"\\t  \");\n+    monitor->lock()->print_on(st, monitor->owner());\n+    st->cr();\n@@ -838,0 +850,4 @@\n+void externalVFrame::print_on(outputStream *st) const {\n+  _fr.print_value_on(st,NULL);\n+}\n+\n@@ -839,1 +855,1 @@\n-  _fr.print_value_on(tty,NULL);\n+  print_on(tty);\n","filename":"src\/hotspot\/share\/runtime\/vframe.cpp","additions":43,"deletions":27,"binary":false,"changes":70,"status":"modified"},{"patch":"@@ -113,0 +113,1 @@\n+  void print_on(outputStream* st) const override;\n@@ -158,2 +159,3 @@\n-  void print();\n-  void print_value() const;\n+  void print() override;\n+  void print_on(outputStream* st) const override;\n+  void print_value() const override;\n@@ -223,1 +225,2 @@\n-  void print();\n+  void print_on(outputStream* st) const override;\n+  void print() override;\n@@ -246,1 +249,2 @@\n-  void print();\n+  void print_on(outputStream* st) const override;\n+  void print() override;\n","filename":"src\/hotspot\/share\/runtime\/vframe.hpp","additions":8,"deletions":4,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -30,0 +30,1 @@\n+#include \"logging\/logStream.hpp\"\n@@ -326,1 +327,0 @@\n-\n@@ -328,3 +328,1 @@\n-  if (PrintDeoptimizationDetails) {\n-    tty->print_cr(\"Expressions size: %d\", expressions()->size());\n-  }\n+  log_debug(deoptimization)(\"Expressions size: %d\", expressions()->size());\n@@ -332,1 +330,0 @@\n-\n@@ -339,0 +336,1 @@\n+\n@@ -347,3 +345,1 @@\n-        if (PrintDeoptimizationDetails) {\n-          tty->print_cr(\" - Reconstructed expression %d (INT): %d\", i, (int)(*addr));\n-        }\n+        log_debug(deoptimization)(\" - Reconstructed expression %d (INT): %d\", i, (int)(*addr));\n@@ -355,8 +351,12 @@\n-        if (PrintDeoptimizationDetails) {\n-          tty->print(\" - Reconstructed expression %d (OBJECT): \", i);\n-          oop o = cast_to_oop((address)(*addr));\n-          if (o == NULL) {\n-            tty->print_cr(\"NULL\");\n-          } else {\n-            ResourceMark rm;\n-            tty->print_raw_cr(o->klass()->name()->as_C_string());\n+        {\n+          LogTarget(Debug, deoptimization) lt;\n+          if (lt.is_enabled()) {\n+            LogStream ls(lt);\n+            ls.print(\" - Reconstructed expression %d (OBJECT): \", i);\n+            oop o = cast_to_oop((address)(*addr));\n+            if (o == NULL) {\n+              ls.print_cr(\"NULL\");\n+            } else {\n+              ResourceMark rm;\n+              ls.print_raw_cr(o->klass()->name()->as_C_string());\n+            }\n@@ -375,1 +375,0 @@\n-\n@@ -377,3 +376,1 @@\n-  if (PrintDeoptimizationDetails) {\n-    tty->print_cr(\"Locals size: %d\", locals()->size());\n-  }\n+  log_debug(deoptimization)(\"Locals size: %d\", locals()->size());\n@@ -381,1 +378,0 @@\n-\n@@ -391,3 +387,1 @@\n-        if (PrintDeoptimizationDetails) {\n-          tty->print_cr(\" - Reconstructed local %d (INT): %d\", i, (int)(*addr));\n-        }\n+        log_debug(deoptimization)(\" - Reconstructed local %d (INT): %d\", i, (int)(*addr));\n@@ -399,8 +393,12 @@\n-        if (PrintDeoptimizationDetails) {\n-          tty->print(\" - Reconstructed local %d (OBJECT): \", i);\n-          oop o = cast_to_oop((address)(*addr));\n-          if (o == NULL) {\n-            tty->print_cr(\"NULL\");\n-          } else {\n-            ResourceMark rm;\n-            tty->print_raw_cr(o->klass()->name()->as_C_string());\n+        {\n+          LogTarget(Debug, deoptimization) lt;\n+          if (lt.is_enabled()) {\n+            LogStream ls(lt);\n+            ls.print(\" - Reconstructed local %d (OBJECT): \", i);\n+            oop o = cast_to_oop((address)(*addr));\n+            if (o == NULL) {\n+              ls.print_cr(\"NULL\");\n+            } else {\n+              ResourceMark rm;\n+              ls.print_raw_cr(o->klass()->name()->as_C_string());\n+            }\n@@ -449,1 +447,0 @@\n-\n@@ -451,12 +448,15 @@\n-  if (PrintDeoptimizationDetails) {\n-    ttyLocker ttyl;\n-    tty->print_cr(\"[%d. Interpreted Frame]\", ++unpack_counter);\n-    iframe()->print_on(tty);\n-    RegisterMap map(thread,\n-                    RegisterMap::UpdateMap::include,\n-                    RegisterMap::ProcessFrames::include,\n-                    RegisterMap::WalkContinuation::skip);\n-    vframe* f = vframe::new_vframe(iframe(), &map, thread);\n-    f->print();\n-    if (WizardMode && Verbose) method()->print_codes();\n-    tty->cr();\n+  {\n+    LogMessage(deoptimization) lm;\n+    if (lm.is_debug()) {\n+      NonInterleavingLogStream ls(LogLevelType::Debug, lm);\n+      ls.print_cr(\"[%d. Interpreted Frame]\", ++unpack_counter);\n+      iframe()->print_on(&ls);\n+      RegisterMap map(thread,\n+                      RegisterMap::UpdateMap::include,\n+                      RegisterMap::ProcessFrames::include,\n+                      RegisterMap::WalkContinuation::skip);\n+      vframe* f = vframe::new_vframe(iframe(), &map, thread);\n+      f->print_on(&ls);\n+      if (lm.is_trace()) method()->print_codes_on(&ls);\n+      ls.cr();\n+    }\n@@ -465,1 +465,0 @@\n-\n","filename":"src\/hotspot\/share\/runtime\/vframeArray.cpp","additions":45,"deletions":46,"binary":false,"changes":91,"status":"modified"},{"patch":"@@ -158,1 +158,0 @@\n-\n","filename":"test\/hotspot\/gtest\/logging\/test_logStream.cpp","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -45,1 +45,1 @@\n- *      -XX:+UseZGC -XX:+LogCompilation -XX:+PrintDeoptimizationDetails -XX:+TraceDeoptimization -XX:+Verbose\n+ *      -XX:+UseZGC -XX:+LogCompilation -Xlog:deoptimization=trace -XX:+TraceDeoptimization -XX:+Verbose\n","filename":"test\/hotspot\/jtreg\/compiler\/uncommontrap\/TestDeoptOOM.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}