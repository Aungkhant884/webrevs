{"files":[{"patch":"@@ -299,3 +299,3 @@\n-      if (PrintDeoptimizationDetails) {\n-        ResourceMark rm;\n-        stringStream st;\n+      LogMessage(deoptimization) lm;\n+      if (lm.is_debug()) {\n+        NonInterleavingLogStream ls(LogLevelType::Debug, lm);\n@@ -307,1 +307,1 @@\n-              st.print_cr(\"RELOCK OBJECTS in thread \" INTPTR_FORMAT, p2i(thread));\n+              ls.print_cr(\"RELOCK OBJECTS in thread \" INTPTR_FORMAT, p2i(thread));\n@@ -312,1 +312,1 @@\n-                st.print_cr(\"     object <\" INTPTR_FORMAT \"> DEFERRED relocking after wait\", p2i(mi->owner()));\n+                ls.print_cr(\"     object <\" INTPTR_FORMAT \"> DEFERRED relocking after wait\", p2i(mi->owner()));\n@@ -318,1 +318,1 @@\n-              st.print_cr(\"     failed reallocation for klass %s\", k->external_name());\n+              ls.print_cr(\"     failed reallocation for klass %s\", k->external_name());\n@@ -320,1 +320,1 @@\n-              st.print_cr(\"     object <\" INTPTR_FORMAT \"> locked\", p2i(mi->owner()));\n+              ls.print_cr(\"     object <\" INTPTR_FORMAT \"> locked\", p2i(mi->owner()));\n@@ -324,1 +324,0 @@\n-        tty->print_raw(st.freeze());\n@@ -442,3 +441,4 @@\n-    if (PrintDeoptimizationDetails) {\n-      tty->print_cr(\"Exception to be rethrown in the interpreter for method %s::%s at bci %d\", trap_scope->method()->method_holder()->name()->as_C_string(), trap_scope->method()->name()->as_C_string(), trap_scope->bci());\n-    }\n+    log_debug(deoptimization)(\n+        \"Exception to be rethrown in the interpreter for method %s::%s at bci %d\",\n+        trap_scope->method()->method_holder()->name()->as_C_string(),\n+        trap_scope->method()->name()->as_C_string(), trap_scope->bci());\n@@ -1452,3 +1452,1 @@\n-    if (PrintDeoptimizationDetails) {\n-      tty->print_cr(\"reassign fields for object of type %s!\", k->name()->as_C_string());\n-    }\n+    log_debug(deoptimization)(\"reassign fields for object of type %s!\", k->name()->as_C_string());\n@@ -1474,3 +1472,5 @@\n-        if (PrintDeoptimizationDetails) {\n-          tty->print_cr(\"skip field reassignment for this vector - it should be assigned already\");\n-          if (Verbose) {\n+        log_debug(deoptimization)(\"skip field reassignment for this vector - it should be assigned already\");\n+        {\n+          LogMessage(deoptimization) lm;\n+          if (lm.is_trace()) {\n+            NonInterleavingLogStream ls(LogLevelType::Debug, lm);\n@@ -1478,1 +1478,1 @@\n-            k->oop_print_on(obj(), tty);\n+            k->oop_print_on(obj(), &ls);\n","filename":"src\/hotspot\/share\/runtime\/deoptimization.cpp","additions":18,"deletions":18,"binary":false,"changes":36,"status":"modified"},{"patch":"@@ -1269,3 +1269,0 @@\n-  develop(bool, PrintDeoptimizationDetails, false,                          \\\n-          \"Print more information about deoptimization\")                    \\\n-                                                                            \\\n","filename":"src\/hotspot\/share\/runtime\/globals.hpp","additions":0,"deletions":3,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -681,1 +681,4 @@\n-  if (WizardMode) _fr.print_value_on(tty,NULL);\n+  print_on(tty);\n+}\n+void vframe::print_on(outputStream* st) const {\n+  _fr.print_value_on(st,NULL);\n","filename":"src\/hotspot\/share\/runtime\/vframe.cpp","additions":4,"deletions":1,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -113,0 +113,1 @@\n+  void print_on(outputStream* st) const override;\n","filename":"src\/hotspot\/share\/runtime\/vframe.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -30,0 +30,1 @@\n+#include \"logging\/logStream.hpp\"\n@@ -326,1 +327,0 @@\n-\n@@ -328,3 +328,1 @@\n-  if (PrintDeoptimizationDetails) {\n-    tty->print_cr(\"Expressions size: %d\", expressions()->size());\n-  }\n+  log_debug(deoptimization)(\"Expressions size: %d\", expressions()->size());\n@@ -332,1 +330,0 @@\n-\n@@ -339,0 +336,1 @@\n+\n@@ -347,3 +345,1 @@\n-        if (PrintDeoptimizationDetails) {\n-          tty->print_cr(\" - Reconstructed expression %d (INT): %d\", i, (int)(*addr));\n-        }\n+        log_debug(deoptimization)(\" - Reconstructed expression %d (INT): %d\", i, (int)(*addr));\n@@ -355,8 +351,12 @@\n-        if (PrintDeoptimizationDetails) {\n-          tty->print(\" - Reconstructed expression %d (OBJECT): \", i);\n-          oop o = cast_to_oop((address)(*addr));\n-          if (o == NULL) {\n-            tty->print_cr(\"NULL\");\n-          } else {\n-            ResourceMark rm;\n-            tty->print_raw_cr(o->klass()->name()->as_C_string());\n+        {\n+          LogTarget(Debug, deoptimization) lt;\n+          if (lt.is_enabled()) {\n+            LogStream ls(lt);\n+            ls.print(\" - Reconstructed expression %d (OBJECT): \", i);\n+            oop o = cast_to_oop((address)(*addr));\n+            if (o == NULL) {\n+              ls.print_cr(\"NULL\");\n+            } else {\n+              ResourceMark rm;\n+              ls.print_raw_cr(o->klass()->name()->as_C_string());\n+            }\n@@ -375,1 +375,0 @@\n-\n@@ -377,3 +376,1 @@\n-  if (PrintDeoptimizationDetails) {\n-    tty->print_cr(\"Locals size: %d\", locals()->size());\n-  }\n+  log_debug(deoptimization)(\"Locals size: %d\", locals()->size());\n@@ -381,1 +378,0 @@\n-\n@@ -391,3 +387,1 @@\n-        if (PrintDeoptimizationDetails) {\n-          tty->print_cr(\" - Reconstructed local %d (INT): %d\", i, (int)(*addr));\n-        }\n+        log_debug(deoptimization)(\" - Reconstructed local %d (INT): %d\", i, (int)(*addr));\n@@ -399,8 +393,12 @@\n-        if (PrintDeoptimizationDetails) {\n-          tty->print(\" - Reconstructed local %d (OBJECT): \", i);\n-          oop o = cast_to_oop((address)(*addr));\n-          if (o == NULL) {\n-            tty->print_cr(\"NULL\");\n-          } else {\n-            ResourceMark rm;\n-            tty->print_raw_cr(o->klass()->name()->as_C_string());\n+        {\n+          LogTarget(Debug, deoptimization) lt;\n+          if (lt.is_enabled()) {\n+            LogStream ls(lt);\n+            ls.print(\" - Reconstructed local %d (OBJECT): \", i);\n+            oop o = cast_to_oop((address)(*addr));\n+            if (o == NULL) {\n+              ls.print_cr(\"NULL\");\n+            } else {\n+              ResourceMark rm;\n+              ls.print_raw_cr(o->klass()->name()->as_C_string());\n+            }\n@@ -449,1 +447,0 @@\n-\n@@ -451,12 +448,15 @@\n-  if (PrintDeoptimizationDetails) {\n-    ttyLocker ttyl;\n-    tty->print_cr(\"[%d. Interpreted Frame]\", ++unpack_counter);\n-    iframe()->print_on(tty);\n-    RegisterMap map(thread,\n-                    RegisterMap::UpdateMap::include,\n-                    RegisterMap::ProcessFrames::include,\n-                    RegisterMap::WalkContinuation::skip);\n-    vframe* f = vframe::new_vframe(iframe(), &map, thread);\n-    f->print();\n-    if (WizardMode && Verbose) method()->print_codes();\n-    tty->cr();\n+  {\n+    LogMessage(deoptimization) lm;\n+    if (lm.is_debug()) {\n+      NonInterleavingLogStream ls(LogLevelType::Debug, lm);\n+      ls.print_cr(\"[%d. Interpreted Frame]\", ++unpack_counter);\n+      iframe()->print_on(&ls);\n+      RegisterMap map(thread,\n+                      RegisterMap::UpdateMap::include,\n+                      RegisterMap::ProcessFrames::include,\n+                      RegisterMap::WalkContinuation::skip);\n+      vframe* f = vframe::new_vframe(iframe(), &map, thread);\n+      f->print_on(&ls);\n+      if (WizardMode && Verbose) method()->print_codes_on(&ls);\n+      ls.cr();\n+    }\n@@ -465,1 +465,0 @@\n-\n","filename":"src\/hotspot\/share\/runtime\/vframeArray.cpp","additions":45,"deletions":46,"binary":false,"changes":91,"status":"modified"},{"patch":"@@ -158,1 +158,0 @@\n-\n","filename":"test\/hotspot\/gtest\/logging\/test_logStream.cpp","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -45,1 +45,1 @@\n- *      -XX:+UseZGC -XX:+LogCompilation -XX:+PrintDeoptimizationDetails -XX:+TraceDeoptimization -XX:+Verbose\n+ *      -XX:+UseZGC -XX:+LogCompilation -Xlog:disable -Xlog:deoptimization=trace -XX:+TraceDeoptimization -XX:+Verbose\n","filename":"test\/hotspot\/jtreg\/compiler\/uncommontrap\/TestDeoptOOM.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}