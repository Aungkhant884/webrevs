{"files":[{"patch":"@@ -36,8 +36,3 @@\n-static void unmap(uintptr_t start, size_t size) {\n-  const int res = munmap((void*)start, size);\n-  assert(res == 0, \"Failed to unmap memory\");\n-}\n-\n-static bool map(uintptr_t start, size_t size) {\n-  const void* const res = mmap((void*)start, size, PROT_NONE, MAP_ANONYMOUS|MAP_PRIVATE|MAP_NORESERVE, -1, 0);\n-  if (res == MAP_FAILED) {\n+uintptr_t ZVirtualMemoryManager::os_reserve(uintptr_t addr, size_t size) {\n+  const uintptr_t res = (uintptr_t)mmap((void*)addr, size, PROT_NONE, MAP_ANONYMOUS|MAP_PRIVATE|MAP_NORESERVE, -1, 0);\n+  if (res == (uintptr_t)MAP_FAILED) {\n@@ -45,1 +40,1 @@\n-    return false;\n+    return 0;\n@@ -48,1 +43,1 @@\n-  if ((uintptr_t)res != start) {\n+  if (res != addr) {\n@@ -50,2 +45,1 @@\n-    unmap((uintptr_t)res, size);\n-    return false;\n+    munmap((void*)res, size);\n@@ -54,2 +48,1 @@\n-  \/\/ Success\n-  return true;\n+  return res;\n@@ -58,27 +51,3 @@\n-bool ZVirtualMemoryManager::reserve_contiguous_platform(uintptr_t start, size_t size) {\n-  \/\/ Reserve address views\n-  const uintptr_t marked0 = ZAddress::marked0(start);\n-  const uintptr_t marked1 = ZAddress::marked1(start);\n-  const uintptr_t remapped = ZAddress::remapped(start);\n-\n-  if (!map(marked0, size)) {\n-    return false;\n-  }\n-\n-  if (!map(marked1, size)) {\n-    unmap(marked0, size);\n-    return false;\n-  }\n-\n-  if (!map(remapped, size)) {\n-    unmap(marked0, size);\n-    unmap(marked1, size);\n-    return false;\n-  }\n-\n-  \/\/ Register address views with native memory tracker\n-  nmt_reserve(marked0, size);\n-  nmt_reserve(marked1, size);\n-  nmt_reserve(remapped, size);\n-\n-  return true;\n+void ZVirtualMemoryManager::os_unreserve(uintptr_t addr, size_t size) {\n+  const int res = munmap((void*)addr, size);\n+  assert(res == 0, \"Failed to unmap memory\");\n","filename":"src\/hotspot\/os\/posix\/gc\/z\/zVirtualMemory_posix.cpp","additions":10,"deletions":41,"binary":false,"changes":51,"status":"modified"},{"patch":"@@ -119,28 +119,3 @@\n-bool ZVirtualMemoryManager::reserve_contiguous_platform(uintptr_t start, size_t size) {\n-  assert(is_aligned(size, ZGranuleSize), \"Must be granule aligned\");\n-\n-  \/\/ Reserve address views\n-  const uintptr_t marked0 = ZAddress::marked0(start);\n-  const uintptr_t marked1 = ZAddress::marked1(start);\n-  const uintptr_t remapped = ZAddress::remapped(start);\n-\n-  \/\/ Reserve address space\n-  if (ZMapper::reserve(marked0, size) != marked0) {\n-    return false;\n-  }\n-\n-  if (ZMapper::reserve(marked1, size) != marked1) {\n-    ZMapper::unreserve(marked0, size);\n-    return false;\n-  }\n-\n-  if (ZMapper::reserve(remapped, size) != remapped) {\n-    ZMapper::unreserve(marked0, size);\n-    ZMapper::unreserve(marked1, size);\n-    return false;\n-  }\n-\n-  \/\/ Register address views with native memory tracker\n-  nmt_reserve(marked0, size);\n-  nmt_reserve(marked1, size);\n-  nmt_reserve(remapped, size);\n+uintptr_t ZVirtualMemoryManager::os_reserve(uintptr_t addr, size_t size) {\n+  return ZMapper::reserve(addr, size);\n+}\n@@ -148,1 +123,2 @@\n-  return true;\n+void ZVirtualMemoryManager::os_unreserve(uintptr_t addr, size_t size) {\n+  ZMapper::unreserve(addr, size);\n","filename":"src\/hotspot\/os\/windows\/gc\/z\/zVirtualMemory_windows.cpp","additions":5,"deletions":29,"binary":false,"changes":34,"status":"modified"},{"patch":"@@ -26,0 +26,1 @@\n+#include \"gc\/z\/zAddress.inline.hpp\"\n@@ -30,1 +31,0 @@\n-#include \"utilities\/debug.hpp\"\n@@ -32,0 +32,1 @@\n+#include \"utilities\/debug.hpp\"\n@@ -65,3 +66,1 @@\n-  if (reserve_contiguous_platform(start, size)) {\n-    \/\/ Make the address range free\n-    _manager.free(start, size);\n+  if (reserve_contiguous(start, size)) {\n@@ -102,0 +101,43 @@\n+bool ZVirtualMemoryManager::reserve_contiguous_inner(uintptr_t start, size_t size) {\n+  assert(is_aligned(size, ZGranuleSize), \"Must be granule aligned\");\n+\n+  \/\/ Reserve address views\n+  const uintptr_t marked0 = ZAddress::marked0(start);\n+  const uintptr_t marked1 = ZAddress::marked1(start);\n+  const uintptr_t remapped = ZAddress::remapped(start);\n+\n+  \/\/ Reserve address space\n+  if (os_reserve(marked0, size) != marked0) {\n+    return false;\n+  }\n+\n+  if (os_reserve(marked1, size) != marked1) {\n+    os_unreserve(marked0, size);\n+    return false;\n+  }\n+\n+  if (os_reserve(remapped, size) != remapped) {\n+    os_unreserve(marked0, size);\n+    os_unreserve(marked1, size);\n+    return false;\n+  }\n+\n+  \/\/ Register address views with native memory tracker\n+  nmt_reserve(marked0, size);\n+  nmt_reserve(marked1, size);\n+  nmt_reserve(remapped, size);\n+\n+  return true;\n+}\n+\n+bool ZVirtualMemoryManager::reserve_contiguous(uintptr_t start, size_t size) {\n+  if (reserve_contiguous_inner(start, size)) {\n+    \/\/ Make the address range free\n+    _manager.free(start, size);\n+\n+    return true;\n+  }\n+\n+  return false;\n+}\n+\n@@ -108,4 +150,1 @@\n-    if (reserve_contiguous_platform(start, size)) {\n-      \/\/ Make the address range free\n-      _manager.free(start, size);\n-\n+    if (reserve_contiguous(start, size)) {\n","filename":"src\/hotspot\/share\/gc\/z\/zVirtualMemory.cpp","additions":47,"deletions":8,"binary":false,"changes":55,"status":"modified"},{"patch":"@@ -53,0 +53,1 @@\n+  \/\/ OS specific implementation\n@@ -54,0 +55,2 @@\n+  uintptr_t os_reserve(uintptr_t start, size_t size);\n+  void os_unreserve(uintptr_t start, size_t size);\n@@ -55,1 +58,2 @@\n-  bool reserve_contiguous_platform(uintptr_t start, size_t size);\n+  bool reserve_contiguous_inner(uintptr_t start, size_t size);\n+  bool reserve_contiguous(uintptr_t start, size_t size);\n","filename":"src\/hotspot\/share\/gc\/z\/zVirtualMemory.hpp","additions":5,"deletions":1,"binary":false,"changes":6,"status":"modified"}]}