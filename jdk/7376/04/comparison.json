{"files":[{"patch":"@@ -307,10 +307,0 @@\n-  \/\/ Convert \"x+(0-y)\" into \"(x-y)\"\n-  if (op2 == Op_Sub(bt) && phase->type(in2->in(1)) == TypeInteger::zero(bt)) {\n-    return SubNode::make(in1, in2->in(2), bt);\n-  }\n-\n-  \/\/ Convert \"(0-y)+x\" into \"(x-y)\"\n-  if (op1 == Op_Sub(bt) && phase->type(in1->in(1)) == TypeInteger::zero(bt)) {\n-    return SubNode::make(in2, in1->in(2), bt);\n-  }\n-\n@@ -370,8 +360,3 @@\n-  \/\/ Convert (~x+c) into (c-1)-x. Note there isn't a bitwise not\n-  \/\/ bytecode, \"~x\" would typically represented as \"x^(-1)\", so (~x+c)\n-  \/\/ will be (x^(-1))+c.\n-  if (op1 == Op_Xor(bt) &&\n-      (in2->Opcode() == Op_ConI || in2->Opcode() == Op_ConL) &&\n-      phase->type(in1->in(2)) == TypeInteger::minus_1(bt)) {\n-    Node* c_minus_one = phase->makecon(add_ring(phase->type(in(2)), TypeInteger::minus_1(bt)));\n-    return SubNode::make(c_minus_one, in1->in(1), bt);\n+  \/\/ Convert (con - x) + y into \"(y - x) + con\"\n+  if (op1 == Op_Sub(bt) && in1->in(1)->Opcode() == Op_ConIL(bt)) {\n+    return AddNode::make(phase->transform(SubNode::make(in2, in1->in(2), bt)), in1->in(1), bt);\n@@ -379,0 +364,16 @@\n+\n+  \/\/ Convert y + (con - x) into \"(y - x) + con\"\n+  if (op2 == Op_Sub(bt) && in2->in(1)->Opcode() == Op_ConIL(bt)) {\n+    return AddNode::make(phase->transform(SubNode::make(in1, in2->in(2), bt)), in2->in(1), bt);\n+  }\n+\n+  \/\/ Convert ~x + rhs, which is (x ^ (-1)) + rhs, into (-1 - x) + rhs.\n+  if (op1 == Op_Xor(bt) && phase->type(in1->in(2)) == TypeInteger::minus_1(bt)) {\n+    return AddNode::make(phase->transform(SubNode::make(phase->integercon(-1, bt), in1->in(1), bt)), in2, bt);\n+  }\n+\n+  \/\/ Convert lhs + ~x, which is lhs + (x ^ (-1)), into lhs + (-1 - x).\n+  if (op2 == Op_Xor(bt) && phase->type(in2->in(2)) == TypeInteger::minus_1(bt)) {\n+    return AddNode::make(in1, phase->transform(SubNode::make(phase->integercon(-1, bt), in2->in(1), bt)), bt);\n+  }\n+\n@@ -968,0 +969,9 @@\n+  \/\/ Convert ~(c-x) into x+(-c-1). Note there isn't a bitwise not\n+  \/\/ bytecode, \"~x\" would typically represented as \"x^(-1)\", so ~(c-x)\n+  \/\/ will eventually be (c-x)^-1.\n+  if (op1 == Op_SubL && phase->type(in2) == TypeLong::MINUS_1 &&\n+      in1->in(1)->Opcode() == Op_ConL) {\n+    jlong c = phase->type(in1->in(1))->isa_long()->get_con();\n+    Node* neg_c_minus_one = phase->longcon(java_add(-c, (jlong)-1));\n+    return new AddLNode(in1->in(2), neg_c_minus_one);\n+  }\n","filename":"src\/hotspot\/share\/opto\/addnode.cpp","additions":28,"deletions":18,"binary":false,"changes":46,"status":"modified"},{"patch":"@@ -1860,0 +1860,8 @@\n+inline int Op_ConIL(BasicType bt) {\n+  assert(bt == T_INT || bt == T_LONG, \"only for int or longs\");\n+  if (bt == T_INT) {\n+    return Op_ConI;\n+  }\n+  return Op_ConL;\n+}\n+\n","filename":"src\/hotspot\/share\/opto\/node.hpp","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -325,0 +325,10 @@\n+  \/\/ Convert ~x - rhs, which is (x ^ (-1)) - rhs, into (-1 - x) - rhs.\n+  if (op1 == Op_XorI && phase->type(in1->in(2)) == TypeInt::MINUS_1) {\n+    return new SubINode(phase->transform(new SubINode(phase->intcon(-1), in1->in(1))), in2);\n+  }\n+\n+  \/\/ Convert lhs - ~x, which is lhs - (x ^ (-1)), into lhs - (-1 - x).\n+  if (op2 == Op_XorI && phase->type(in2->in(2)) == TypeInt::MINUS_1) {\n+    return new SubINode(in1, phase->transform(new SubINode(phase->intcon(-1), in2->in(1))));\n+  }\n+\n@@ -502,0 +512,10 @@\n+  \/\/ Convert ~x - rhs, which is (x ^ (-1)) - rhs, into (-1 - x) - rhs.\n+  if (op1 == Op_XorL && phase->type(in1->in(2)) == TypeLong::MINUS_1) {\n+    return new SubLNode(phase->transform(new SubLNode(phase->longcon(-1), in1->in(1))), in2);\n+  }\n+\n+  \/\/ Convert lhs - ~x, which is lhs - (x ^ (-1)), into lhs - (-1 - x).\n+  if (op2 == Op_XorL && phase->type(in2->in(2)) == TypeLong::MINUS_1) {\n+    return new SubLNode(in1, phase->transform(new SubLNode(phase->longcon(-1), in2->in(1))));\n+  }\n+\n","filename":"src\/hotspot\/share\/opto\/subnode.cpp","additions":20,"deletions":0,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -46,1 +46,3 @@\n-                 \"test17\", \"test18\", \"test19\"})\n+                 \"test17\", \"test18\", \"test19\",\n+                 \"test20\", \"test21\", \"test22\",\n+                 \"test23\", \"test24\"})\n@@ -85,0 +87,5 @@\n+        Asserts.assertEQ(b - a            , test20(a, b));\n+        Asserts.assertEQ(a - b            , test21(a, b));\n+        Asserts.assertEQ(b - a            , test22(a, b));\n+        Asserts.assertEQ(a - b            , test23(a, b));\n+        Asserts.assertEQ(2021 - a         , test24(a));\n@@ -250,0 +257,40 @@\n+\n+    @Test\n+    @IR(failOn = {IRNode.XOR, IRNode.ADD})\n+    @IR(counts = {IRNode.SUB, \"1\"})\n+    \/\/ Checks (~x + y) + 1 => y - x\n+    public int test20(int x, int y) {\n+        return (~x + y) + 1;\n+    }\n+\n+    @Test\n+    @IR(failOn = {IRNode.XOR, IRNode.ADD})\n+    @IR(counts = {IRNode.SUB, \"1\"})\n+    \/\/ Checks (x + ~y) + 1 => x - y\n+    public int test21(int x, int y) {\n+        return (x + ~y) + 1;\n+    }\n+\n+    @Test\n+    @IR(failOn = {IRNode.XOR, IRNode.ADD})\n+    @IR(counts = {IRNode.SUB, \"1\"})\n+    \/\/ Checks ~x + (y + 1) => y - x\n+    public int test22(int x, int y) {\n+        return ~x + (y + 1);\n+    }\n+\n+    @Test\n+    @IR(failOn = {IRNode.XOR, IRNode.ADD})\n+    @IR(counts = {IRNode.SUB, \"1\"})\n+    \/\/ Checks (x + 1) + ~y => x - y\n+    public int test23(int x, int y) {\n+        return (x + 1) + ~y;\n+    }\n+\n+    @Test\n+    @IR(failOn = {IRNode.ADD, IRNode.XOR})\n+    @IR(counts = {IRNode.SUB, \"1\"})\n+    \/\/ Checks ~x + c => (c - 1) - x\n+    public int test24(int x) {\n+        return ~x + 2022;\n+    }\n","filename":"test\/hotspot\/jtreg\/compiler\/c2\/irTests\/AddINodeIdealizationTests.java","additions":48,"deletions":1,"binary":false,"changes":49,"status":"modified"},{"patch":"@@ -46,1 +46,3 @@\n-                 \"test17\", \"test18\"})\n+                 \"test17\", \"test18\", \"test19\",\n+                 \"test20\", \"test21\", \"test22\",\n+                 \"test23\"})\n@@ -84,0 +86,5 @@\n+        Asserts.assertEQ(b - a            , test19(a, b));\n+        Asserts.assertEQ(a - b            , test20(a, b));\n+        Asserts.assertEQ(b - a            , test21(a, b));\n+        Asserts.assertEQ(a - b            , test22(a, b));\n+        Asserts.assertEQ(2021 - a         , test23(a));\n@@ -241,0 +248,40 @@\n+\n+    @Test\n+    @IR(failOn = {IRNode.XOR, IRNode.ADD})\n+    @IR(counts = {IRNode.SUB, \"1\"})\n+    \/\/ Checks (~x + y) + 1 => y - x\n+    public long test19(long x, long y) {\n+        return (~x + y) + 1;\n+    }\n+\n+    @Test\n+    @IR(failOn = {IRNode.XOR, IRNode.ADD})\n+    @IR(counts = {IRNode.SUB, \"1\"})\n+    \/\/ Checks (x + ~y) + 1 => x - y\n+    public long test20(long x, long y) {\n+        return (x + ~y) + 1;\n+    }\n+\n+    @Test\n+    @IR(failOn = {IRNode.XOR, IRNode.ADD})\n+    @IR(counts = {IRNode.SUB, \"1\"})\n+    \/\/ Checks ~x + (y + 1) => y - x\n+    public long test21(long x, long y) {\n+        return ~x + (y + 1);\n+    }\n+\n+    @Test\n+    @IR(failOn = {IRNode.XOR, IRNode.ADD})\n+    @IR(counts = {IRNode.SUB, \"1\"})\n+    \/\/ Checks (x + 1) + ~y => x - y\n+    public long test22(long x, long y) {\n+        return (x + 1) + ~y;\n+    }\n+\n+    @Test\n+    @IR(failOn = {IRNode.ADD, IRNode.XOR})\n+    @IR(counts = {IRNode.SUB, \"1\"})\n+    \/\/ Checks ~x + c => (c - 1) - x\n+    public long test23(long x) {\n+        return ~x + 2022;\n+    }\n","filename":"test\/hotspot\/jtreg\/compiler\/c2\/irTests\/AddLNodeIdealizationTests.java","additions":48,"deletions":1,"binary":false,"changes":49,"status":"modified"},{"patch":"@@ -46,1 +46,3 @@\n-                 \"test19\", \"test20\", \"test21\"})\n+                 \"test19\", \"test20\", \"test21\",\n+                 \"test22\", \"test23\", \"test24\",\n+                 \"test25\"})\n@@ -84,0 +86,4 @@\n+        Asserts.assertEQ(b - a            , test22(a, b));\n+        Asserts.assertEQ(a + 2023         , test23(a));\n+        Asserts.assertEQ(a + 1            , test24(a));\n+        Asserts.assertEQ(a                , test25(a));\n@@ -252,0 +258,31 @@\n+\n+    @Test\n+    @IR(failOn = {IRNode.XOR})\n+    @IR(counts = {IRNode.SUB, \"1\"})\n+    \/\/ Checks ~x - ~y => y - x\n+    public int test22(int x, int y) {\n+        return ~x - ~y; \/\/ transformed to y - x\n+    }\n+\n+    @Test\n+    @IR(failOn = {IRNode.SUB, IRNode.XOR})\n+    @IR(counts = {IRNode.ADD, \"1\"})\n+    \/\/ Checks c - ~x => x + (c + 1)\n+    public int test23(int x) {\n+        return 2022 - ~x;\n+    }\n+\n+    @Test\n+    @IR(failOn = {IRNode.SUB, IRNode.XOR})\n+    @IR(counts = {IRNode.ADD, \"1\"})\n+    \/\/ Checks 0 - ~x => x + 1\n+    public int test24(int x) {\n+        return 0 - ~x; \/\/ transformed to x + 1\n+    }\n+\n+    @Test\n+    @IR(failOn = {IRNode.SUB, IRNode.XOR, IRNode.ADD})\n+    \/\/ Checks -1 - ~x => x\n+    public int test25(int x) {\n+        return -1 - ~x;\n+    }\n","filename":"test\/hotspot\/jtreg\/compiler\/c2\/irTests\/SubINodeIdealizationTests.java","additions":38,"deletions":1,"binary":false,"changes":39,"status":"modified"},{"patch":"@@ -46,1 +46,3 @@\n-                 \"test19\", \"test20\", \"test21\"})\n+                 \"test19\", \"test20\", \"test21\",\n+                 \"test22\", \"test23\", \"test24\",\n+                 \"test25\"})\n@@ -84,0 +86,4 @@\n+        Asserts.assertEQ(b - a            , test22(a, b));\n+        Asserts.assertEQ(a + 2023         , test23(a));\n+        Asserts.assertEQ(a + 1            , test24(a));\n+        Asserts.assertEQ(a                , test25(a));\n@@ -252,0 +258,31 @@\n+\n+    @Test\n+    @IR(failOn = {IRNode.XOR})\n+    @IR(counts = {IRNode.SUB, \"1\"})\n+    \/\/ Checks ~x - ~y => y - x\n+    public long test22(long x, long y) {\n+        return ~x - ~y; \/\/ transformed to y - x\n+    }\n+\n+    @Test\n+    @IR(failOn = {IRNode.SUB, IRNode.XOR})\n+    @IR(counts = {IRNode.ADD, \"1\"})\n+    \/\/ Checks c - ~x => x + (c + 1)\n+    public long test23(long x) {\n+        return 2022 - ~x;\n+    }\n+\n+    @Test\n+    @IR(failOn = {IRNode.SUB, IRNode.XOR})\n+    @IR(counts = {IRNode.ADD, \"1\"})\n+    \/\/ Checks 0 - ~x => x + 1\n+    public long test24(long x) {\n+        return 0 - ~x; \/\/ transformed to x + 1\n+    }\n+\n+    @Test\n+    @IR(failOn = {IRNode.SUB, IRNode.XOR, IRNode.ADD})\n+    \/\/ Checks -1 - ~x => x\n+    public long test25(long x) {\n+        return -1 - ~x;\n+    }\n","filename":"test\/hotspot\/jtreg\/compiler\/c2\/irTests\/SubLNodeIdealizationTests.java","additions":38,"deletions":1,"binary":false,"changes":39,"status":"modified"},{"patch":"@@ -149,0 +149,1 @@\n+    public static final String XOR = START + \"Xor(I|L)\" + MID + END;\n","filename":"test\/hotspot\/jtreg\/compiler\/lib\/ir_framework\/IRNode.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"}]}