{"files":[{"patch":"@@ -162,0 +162,1 @@\n+    public final Content relatedPackages;\n@@ -308,0 +309,1 @@\n+        relatedPackages = getContent(\"doclet.Related_Packages\");\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/Contents.java","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -165,0 +165,6 @@\n+    @Override\n+    public void addRelatedPackagesSummary(List<PackageElement> relatedPackages, Content summaryContentTree) {\n+        TableHeader tableHeader= new TableHeader(contents.packageLabel, contents.descriptionLabel);\n+        addPackageSummary(relatedPackages, contents.relatedPackages, tableHeader, summaryContentTree);\n+    }\n+\n@@ -238,0 +244,27 @@\n+    public void addPackageSummary(List<PackageElement> packages, Content label,\n+                                  TableHeader tableHeader, Content summaryContentTree) {\n+        if(!packages.isEmpty()) {\n+            Table table = new Table(HtmlStyle.summaryTable)\n+                    .setCaption(label)\n+                    .setHeader(tableHeader)\n+                    .setColumnStyles(HtmlStyle.colFirst, HtmlStyle.colLast);\n+\n+            for (PackageElement pkg : packages) {\n+                Content classLink = getPackageLink(pkg, Text.of(pkg.getQualifiedName()));\n+                ContentBuilder description = new ContentBuilder();\n+                addPreviewSummary(pkg, description);\n+                if (utils.isDeprecated(pkg)) {\n+                    description.add(getDeprecatedPhrase(pkg));\n+                    List<? extends DeprecatedTree> tags = utils.getDeprecatedTrees(pkg);\n+                    if (!tags.isEmpty()) {\n+                        addSummaryDeprecatedComment(pkg, tags.get(0), description);\n+                    }\n+                } else {\n+                    addSummaryComment(pkg, description);\n+                }\n+                table.addRow(classLink, description);\n+            }\n+            summaryContentTree.add(HtmlTree.LI(table));\n+        }\n+    }\n+\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/PackageWriterImpl.java","additions":33,"deletions":0,"binary":false,"changes":33,"status":"modified"},{"patch":"@@ -28,0 +28,1 @@\n+import java.util.List;\n@@ -30,0 +31,1 @@\n+import javax.lang.model.element.PackageElement;\n@@ -66,0 +68,8 @@\n+    \/**\n+     * Adds the table of related packages to the documentation tree.\n+     *\n+     * @param relatedPackages the interfaces to document.\n+     * @param summaryContentTree the content tree to which the summaries will be added\n+     *\/\n+    void addRelatedPackagesSummary(List<PackageElement> relatedPackages, Content summaryContentTree);\n+\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/toolkit\/PackageSummaryWriter.java","additions":10,"deletions":0,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -28,0 +28,2 @@\n+import java.util.ArrayList;\n+import java.util.List;\n@@ -30,0 +32,3 @@\n+import java.util.function.Predicate;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n@@ -60,0 +65,4 @@\n+    \/\/ Maximum number of subpackages and sibling packages to list in related packages table\n+    private final static int MAX_SUBPACKAGES = 20;\n+    private final static int MAX_SIBLING_PACKAGES = 5;\n+\n@@ -149,0 +158,1 @@\n+        buildRelatedPackagesSummary(summariesList);\n@@ -160,0 +170,12 @@\n+    \/**\n+     * Builds a list of \"nearby\" packages (subpackages, super and sibling packages).\n+     *\n+     * @param summariesList the list of summaries to which the summary will be added\n+     *\/\n+    protected void buildRelatedPackagesSummary(Content summariesList) {\n+        List<PackageElement> packages = findRelatedPackages();\n+        if (!packages.isEmpty()) {\n+            packageWriter.addRelatedPackagesSummary(packages, summariesList);\n+        }\n+    }\n+\n@@ -294,0 +316,36 @@\n+\n+    private List<PackageElement> findRelatedPackages() {\n+        String pkgName = packageElement.getQualifiedName().toString();\n+\n+        \/\/ always add super package\n+        int lastdot = pkgName.lastIndexOf('.');\n+        String pkgPrefix = lastdot > 0 ? pkgName.substring(0, lastdot) : null;\n+        List<PackageElement> packages = new ArrayList<>(\n+                filterPackages(p -> p.getQualifiedName().toString().equals(pkgPrefix)));\n+\n+        \/\/ add subpackages unless there are very many of them\n+        Pattern subPattern = Pattern.compile(pkgName.replace(\".\", \"\\\\.\") + \"\\\\.\\\\w+\");\n+        List<PackageElement> subpackages = filterPackages(\n+                p -> subPattern.matcher(p.getQualifiedName().toString()).matches());\n+        if (subpackages.size() <= MAX_SUBPACKAGES) {\n+            packages.addAll(subpackages);\n+        }\n+\n+        \/\/ only add sibling packages if we are beneath threshold, and number of siblings is beneath threshold as well\n+        if (pkgPrefix != null && packages.size() <= MAX_SIBLING_PACKAGES) {\n+            Pattern siblingPattern = Pattern.compile(pkgPrefix.replace(\".\", \"\\\\.\") + \"\\\\.\\\\w+\");\n+\n+            List<PackageElement> siblings = filterPackages(\n+                    p -> siblingPattern.matcher(p.getQualifiedName().toString()).matches());\n+            if (siblings.size() <= MAX_SIBLING_PACKAGES) {\n+                packages.addAll(siblings);\n+            }\n+        }\n+        return packages;\n+    }\n+\n+    private List<PackageElement> filterPackages(Predicate<? super PackageElement> filter) {\n+        return configuration.packages.stream()\n+                .filter(p -> p != packageElement && filter.test(p))\n+                .collect(Collectors.toList());\n+    }\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/toolkit\/builders\/PackageSummaryBuilder.java","additions":58,"deletions":0,"binary":false,"changes":58,"status":"modified"},{"patch":"@@ -137,0 +137,1 @@\n+doclet.Related_Packages=Related Packages\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/toolkit\/resources\/doclets.properties","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -3178,1 +3178,1 @@\n-            parentPreviewAPI = configuration.workArounds.isPreviewAPI(el.getEnclosingElement());\n+            parentPreviewAPI = configuration.workArounds.isPreviewAPI(enclosing);\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/toolkit\/util\/Utils.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -0,0 +1,141 @@\n+\/*\n+ * Copyright (c) 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/*\n+ * @test\n+ * @bug 8260388\n+ * @summary Listing (sub)packages at package level of API documentation\n+ * @library \/tools\/lib ..\/..\/lib\n+ * @modules jdk.javadoc\/jdk.javadoc.internal.tool\n+ * @build toolbox.ToolBox javadoc.tester.*\n+ * @run main TestRelatedPackages\n+ *\/\n+\n+import toolbox.ToolBox;\n+import javadoc.tester.JavadocTester;\n+\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+\n+public class TestRelatedPackages extends JavadocTester {\n+\n+    public static void main(String... args) throws Exception {\n+        TestRelatedPackages tester = new TestRelatedPackages();\n+        tester.runTests(m -> new Object[]{Paths.get(m.getName())});\n+    }\n+\n+    @Test\n+    public void testRelatedPackages(Path base) throws Exception {\n+        ToolBox tb = new ToolBox();\n+        tb.writeFile(base.resolve(\"p1\/package-info.java\"), \"package p1;\\n\");\n+        tb.writeFile(base.resolve(\"p1\/s1\/A.java\"), \"package p1.s1; public class A {}\\n\");\n+        tb.writeFile(base.resolve(\"p1\/s2\/package-info.java\"), \"package p1.s1;\\n\");\n+        tb.writeFile(base.resolve(\"p1\/s3\/B.java\"), \"package p1.s3; public class B {}\\n\");\n+        tb.writeFile(base.resolve(\"p1\/s3\/t1\/package-info.java\"), \"package p1.s3.t1;\\n\");\n+        tb.writeFile(base.resolve(\"p1\/s3\/t2\/C.java\"), \"package p1.s3.t2; public class C {}\\n\");\n+\n+        javadoc(\"-d\", \"out\",\n+                \"-sourcepath\", base.toString(),\n+                \"-subpackages\", \"p1\");\n+        checkExit(Exit.OK);\n+        checkOutput(\"p1\/package-summary.html\", true,\n+                \"\"\"\n+                    <div class=\"caption\"><span>Related Packages<\/span><\/div>\n+                    <div class=\"summary-table two-column-summary\">\n+                    <div class=\"table-header col-first\">Package<\/div>\n+                    <div class=\"table-header col-last\">Description<\/div>\n+                    <div class=\"col-first even-row-color\"><a href=\"s1\/package-summary.html\">p1.s1<\/a><\/div>\n+                    <div class=\"col-last even-row-color\">&nbsp;<\/div>\n+                    <div class=\"col-first odd-row-color\"><a href=\"s2\/package-summary.html\">p1.s2<\/a><\/div>\n+                    <div class=\"col-last odd-row-color\">&nbsp;<\/div>\n+                    <div class=\"col-first even-row-color\"><a href=\"s3\/package-summary.html\">p1.s3<\/a><\/div>\n+                    <div class=\"col-last even-row-color\">&nbsp;<\/div>\n+                    <\/div>\"\"\");\n+        checkOutput(\"p1\/s1\/package-summary.html\", true,\n+                \"\"\"\n+                    <div class=\"caption\"><span>Related Packages<\/span><\/div>\n+                    <div class=\"summary-table two-column-summary\">\n+                    <div class=\"table-header col-first\">Package<\/div>\n+                    <div class=\"table-header col-last\">Description<\/div>\n+                    <div class=\"col-first even-row-color\"><a href=\"..\/package-summary.html\">p1<\/a><\/div>\n+                    <div class=\"col-last even-row-color\">&nbsp;<\/div>\n+                    <div class=\"col-first odd-row-color\"><a href=\"..\/s2\/package-summary.html\">p1.s2<\/a><\/div>\n+                    <div class=\"col-last odd-row-color\">&nbsp;<\/div>\n+                    <div class=\"col-first even-row-color\"><a href=\"..\/s3\/package-summary.html\">p1.s3<\/a><\/div>\n+                    <div class=\"col-last even-row-color\">&nbsp;<\/div>\n+                    <\/div>\"\"\");\n+        checkOutput(\"p1\/s2\/package-summary.html\", true,\n+                \"\"\"\n+                    <div class=\"caption\"><span>Related Packages<\/span><\/div>\n+                    <div class=\"summary-table two-column-summary\">\n+                    <div class=\"table-header col-first\">Package<\/div>\n+                    <div class=\"table-header col-last\">Description<\/div>\n+                    <div class=\"col-first even-row-color\"><a href=\"..\/package-summary.html\">p1<\/a><\/div>\n+                    <div class=\"col-last even-row-color\">&nbsp;<\/div>\n+                    <div class=\"col-first odd-row-color\"><a href=\"..\/s1\/package-summary.html\">p1.s1<\/a><\/div>\n+                    <div class=\"col-last odd-row-color\">&nbsp;<\/div>\n+                    <div class=\"col-first even-row-color\"><a href=\"..\/s3\/package-summary.html\">p1.s3<\/a><\/div>\n+                    <div class=\"col-last even-row-color\">&nbsp;<\/div>\n+                    <\/div>\"\"\");\n+        checkOutput(\"p1\/s3\/package-summary.html\", true,\n+                \"\"\"\n+                    <div class=\"caption\"><span>Related Packages<\/span><\/div>\n+                    <div class=\"summary-table two-column-summary\">\n+                    <div class=\"table-header col-first\">Package<\/div>\n+                    <div class=\"table-header col-last\">Description<\/div>\n+                    <div class=\"col-first even-row-color\"><a href=\"..\/package-summary.html\">p1<\/a><\/div>\n+                    <div class=\"col-last even-row-color\">&nbsp;<\/div>\n+                    <div class=\"col-first odd-row-color\"><a href=\"t1\/package-summary.html\">p1.s3.t1<\/a><\/div>\n+                    <div class=\"col-last odd-row-color\">&nbsp;<\/div>\n+                    <div class=\"col-first even-row-color\"><a href=\"t2\/package-summary.html\">p1.s3.t2<\/a><\/div>\n+                    <div class=\"col-last even-row-color\">&nbsp;<\/div>\n+                    <div class=\"col-first odd-row-color\"><a href=\"..\/s1\/package-summary.html\">p1.s1<\/a><\/div>\n+                    <div class=\"col-last odd-row-color\">&nbsp;<\/div>\n+                    <div class=\"col-first even-row-color\"><a href=\"..\/s2\/package-summary.html\">p1.s2<\/a><\/div>\n+                    <div class=\"col-last even-row-color\">&nbsp;<\/div>\n+                    <\/div>\"\"\");\n+        checkOutput(\"p1\/s3\/t1\/package-summary.html\", true,\n+                \"\"\"\n+                    <div class=\"caption\"><span>Related Packages<\/span><\/div>\n+                    <div class=\"summary-table two-column-summary\">\n+                    <div class=\"table-header col-first\">Package<\/div>\n+                    <div class=\"table-header col-last\">Description<\/div>\n+                    <div class=\"col-first even-row-color\"><a href=\"..\/package-summary.html\">p1.s3<\/a><\/div>\n+                    <div class=\"col-last even-row-color\">&nbsp;<\/div>\n+                    <div class=\"col-first odd-row-color\"><a href=\"..\/t2\/package-summary.html\">p1.s3.t2<\/a><\/div>\n+                    <div class=\"col-last odd-row-color\">&nbsp;<\/div>\n+                    <\/div>\"\"\");\n+        checkOutput(\"p1\/s3\/t2\/package-summary.html\", true,\n+                \"\"\"\n+                    <div class=\"caption\"><span>Related Packages<\/span><\/div>\n+                    <div class=\"summary-table two-column-summary\">\n+                    <div class=\"table-header col-first\">Package<\/div>\n+                    <div class=\"table-header col-last\">Description<\/div>\n+                    <div class=\"col-first even-row-color\"><a href=\"..\/package-summary.html\">p1.s3<\/a><\/div>\n+                    <div class=\"col-last even-row-color\">&nbsp;<\/div>\n+                    <div class=\"col-first odd-row-color\"><a href=\"..\/t1\/package-summary.html\">p1.s3.t1<\/a><\/div>\n+                    <div class=\"col-last odd-row-color\">&nbsp;<\/div>\n+                    <\/div>\"\"\");\n+    }\n+\n+}\n","filename":"test\/langtools\/jdk\/javadoc\/doclet\/testRelatedPackages\/TestRelatedPackages.java","additions":141,"deletions":0,"binary":false,"changes":141,"status":"added"}]}