{"files":[{"patch":"@@ -790,1 +790,1 @@\n-  address narrow_klass_base = _requested_static_archive_bottom - ArchiveHeapWriter::precomputed_narrow_klass_base_delta;\n+  address narrow_klass_base = _requested_static_archive_bottom; \/\/ future encoding base == future mapping start\n","filename":"src\/hotspot\/share\/cds\/archiveBuilder.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -198,2 +198,1 @@\n-  \/\/ 1) (mapping start - base) == 0, so base is the future mapping start address. nKlass are relative\n-  \/\/    to base: we can map the archive anywhere but then need to set encoding base to that address.\n+  \/\/ 1) the encoding base must be the mapping start address.\n@@ -207,1 +206,1 @@\n-  static constexpr size_t precomputed_narrow_klass_base_delta = 0;\n+\n","filename":"src\/hotspot\/share\/cds\/archiveHeapWriter.hpp","additions":2,"deletions":3,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -225,7 +225,0 @@\n-#if INCLUDE_CDS_JAVA_HEAP\n-  _narrow_klass_base_delta = ArchiveHeapWriter::precomputed_narrow_klass_base_delta;\n-  _narrow_klass_shift = ArchiveHeapWriter::precomputed_narrow_klass_shift;\n-#else\n-  _narrow_klass_base_delta = 0;\n-  _narrow_klass_shift = -1;\n-#endif\n@@ -292,2 +285,0 @@\n-  st->print_cr(\"- narrow_klass_base_delta:        \" SIZE_FORMAT, _narrow_klass_base_delta);\n-  st->print_cr(\"- narrow_klass_shift:             %d\", _narrow_klass_shift);\n@@ -2026,0 +2017,7 @@\n+  \/\/ We pre-compute narrow Klass IDs with the future mapping start intended to be the base, and a shift of\n+  \/\/ ArchiveHeapWriter::precomputed_narrow_klass_shift. We enforce this encoding at runtime (see\n+  \/\/ CompressedKlassPointers::initialize_for_given_encoding()). Therefore, the following assertions must\n+  \/\/ hold:\n+  address archive_narrow_klass_base = (address)header()->mapped_base_address();\n+  const int archive_narrow_klass_shift = ArchiveHeapWriter::precomputed_narrow_klass_shift;\n+\n@@ -2028,2 +2026,2 @@\n-  log_info(cds)(\"    narrow_klass_base_delta = \" SIZE_FORMAT \", narrow_klass_shift = %d\",\n-                narrow_klass_base_delta(), narrow_klass_shift());\n+  log_info(cds)(\"    narrow_klass_base at mapping start address, narrow_klass_shift = %d\",\n+                archive_narrow_klass_shift);\n@@ -2047,1 +2045,4 @@\n-  address archive_narrow_klass_base = (address)header()->mapped_base_address() - narrow_klass_base_delta();\n+  assert(archive_narrow_klass_base == CompressedKlassPointers::base(), \"Unexpected encoding base encountered \"\n+         \"(\" PTR_FORMAT \", expected \" PTR_FORMAT \")\", p2i(CompressedKlassPointers::base()), p2i(archive_narrow_klass_base));\n+  assert(archive_narrow_klass_shift == CompressedKlassPointers::shift(), \"Unexpected encoding shift encountered \"\n+         \"(%d, expected %d)\", CompressedKlassPointers::shift(), archive_narrow_klass_shift);\n@@ -2049,5 +2050,0 @@\n-  if (archive_narrow_klass_base != CompressedKlassPointers::base() ||\n-      narrow_klass_shift() != CompressedKlassPointers::shift()) {\n-    log_info(cds)(\"CDS heap data cannot be used because the archive was created with an incompatible narrow klass encoding mode.\");\n-    return false;\n-  }\n","filename":"src\/hotspot\/share\/cds\/filemap.cpp","additions":13,"deletions":17,"binary":false,"changes":30,"status":"modified"},{"patch":"@@ -197,2 +197,0 @@\n-  size_t  _narrow_klass_base_delta;               \/\/ narrow Klass base and shift used to pre-calculate nKlass ids\n-  int     _narrow_klass_shift;                    \/\/  in archived objects (see comment in archiveHeapWriter.hpp)\n@@ -266,2 +264,0 @@\n-  size_t narrow_klass_base_delta()         const { return _narrow_klass_base_delta; }\n-  int narrow_klass_shift()                 const { return _narrow_klass_shift; }\n@@ -386,2 +382,0 @@\n-  size_t  narrow_klass_base_delta() const { return header()->narrow_klass_base_delta(); }\n-  int     narrow_klass_shift() const { return header()->narrow_klass_shift(); }\n","filename":"src\/hotspot\/share\/cds\/filemap.hpp","additions":0,"deletions":6,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -72,0 +72,1 @@\n+#include \"runtime\/globals.hpp\"\n@@ -1149,2 +1150,2 @@\n-          address precomputed_narrow_klass_base = cds_base - static_mapinfo->narrow_klass_base_delta();\n-          const int precomputed_narrow_klass_shift = static_mapinfo->narrow_klass_shift();\n+          address precomputed_narrow_klass_base = cds_base;\n+          const int precomputed_narrow_klass_shift = ArchiveHeapWriter::precomputed_narrow_klass_shift;\n","filename":"src\/hotspot\/share\/cds\/metaspaceShared.cpp","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"}]}