{"files":[{"patch":"@@ -557,0 +557,1 @@\n+  VTMS_unmount_begin(vthread, \/* last_unmount *\/ true);\n@@ -558,0 +559,1 @@\n+    assert(thread->jvmti_thread_state()->is_virtual(), \"wrong JvmtiThreadState\");\n@@ -559,3 +561,2 @@\n-    thread->set_jvmti_thread_state(nullptr);\n-    oop vt = JNIHandles::resolve(vthread);\n-    java_lang_Thread::set_jvmti_thread_state(vt, nullptr);\n+    assert(thread->jvmti_thread_state() == nullptr, \"should be null\");\n+    assert(java_lang_Thread::jvmti_thread_state(JNIHandles::resolve(vthread)) == nullptr, \"should be null\");\n@@ -563,1 +564,1 @@\n-  VTMS_unmount_begin(vthread);\n+  thread->rebind_to_jvmti_thread_state_of(thread->threadObj());\n@@ -584,1 +585,1 @@\n-    VTMS_unmount_begin(vthread);\n+    VTMS_unmount_begin(vthread, \/* last_unmount *\/ false);\n@@ -618,1 +619,1 @@\n-JvmtiVTMSTransitionDisabler::VTMS_unmount_begin(jobject vthread) {\n+JvmtiVTMSTransitionDisabler::VTMS_unmount_begin(jobject vthread, bool last_unmount) {\n@@ -625,1 +626,3 @@\n-  thread->rebind_to_jvmti_thread_state_of(thread->threadObj());\n+  if (!last_unmount) {\n+    thread->rebind_to_jvmti_thread_state_of(thread->threadObj());\n+  }\n","filename":"src\/hotspot\/share\/prims\/jvmtiThreadState.cpp","additions":10,"deletions":7,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -123,1 +123,1 @@\n-  static void VTMS_unmount_begin(jobject vthread);\n+  static void VTMS_unmount_begin(jobject vthread, bool last_unmount);\n","filename":"src\/hotspot\/share\/prims\/jvmtiThreadState.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}