{"files":[{"patch":"@@ -95,1 +95,1 @@\n-  address src_obj = src_info->obj();\n+  address src_obj = src_info->source_addr();\n@@ -179,2 +179,0 @@\n-  clean_up_src_obj_table();\n-\n@@ -430,1 +428,0 @@\n-  ref->set_keep_after_pushing();\n@@ -592,2 +589,1 @@\n-  MetaspaceClosure::Ref* ref = src_info->ref();\n-  address src = ref->obj();\n+  address src = src_info->source_addr();\n@@ -600,1 +596,1 @@\n-  if (ref->msotype() == MetaspaceObj::ClassType) {\n+  if (src_info->msotype() == MetaspaceObj::ClassType) {\n@@ -624,1 +620,1 @@\n-  intptr_t* archived_vtable = CppVtables::get_archived_vtable(ref->msotype(), (address)dest);\n+  intptr_t* archived_vtable = CppVtables::get_archived_vtable(src_info->msotype(), (address)dest);\n@@ -633,1 +629,1 @@\n-  _alloc_stats.record(ref->msotype(), int(newtop - oldtop), src_info->read_only());\n+  _alloc_stats.record(src_info->msotype(), int(newtop - oldtop), src_info->read_only());\n@@ -1100,5 +1096,0 @@\n-void ArchiveBuilder::clean_up_src_obj_table() {\n-  SrcObjTableCleaner cleaner;\n-  _src_obj_table.iterate(&cleaner);\n-}\n-\n","filename":"src\/hotspot\/share\/cds\/archiveBuilder.cpp","additions":5,"deletions":14,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -126,1 +126,0 @@\n-    MetaspaceClosure::Ref* _ref; \/\/ The object that's copied into the buffer\n@@ -133,4 +132,2 @@\n-    address _source_addr;    \/\/ The value of the source object (_ref->obj()) when this\n-                             \/\/ SourceObjInfo was created. Note that _ref->obj() may change\n-                             \/\/ later if _ref is relocated.\n-    address _buffered_addr;  \/\/ The copy of _ref->obj() insider the buffer.\n+    address _source_addr;    \/\/ The source object to be copied.\n+    address _buffered_addr;  \/\/ The copy of this object insider the buffer.\n@@ -139,1 +136,1 @@\n-      _ref(ref), _ptrmap_start(0), _ptrmap_end(0), _read_only(read_only), _follow_mode(follow_mode),\n+      _ptrmap_start(0), _ptrmap_end(0), _read_only(read_only), _follow_mode(follow_mode),\n@@ -150,1 +147,0 @@\n-    MetaspaceClosure::Ref* ref() const { return  _ref; }\n@@ -164,1 +160,6 @@\n-    address buffered_addr() const  { return _buffered_addr; }\n+    address buffered_addr() const  {\n+      if (_follow_mode != set_to_null) {\n+        assert(_buffered_addr != nullptr, \"must be initialized\");\n+      }\n+      return _buffered_addr;\n+    }\n@@ -166,3 +167,0 @@\n-\n-    \/\/ convenience accessor\n-    address obj() const { return ref()->obj(); }\n@@ -190,8 +188,0 @@\n-  class SrcObjTableCleaner {\n-  public:\n-    bool do_entry(address key, const SourceObjInfo& value) {\n-      delete value.ref();\n-      return true;\n-    }\n-  };\n-\n","filename":"src\/hotspot\/share\/cds\/archiveBuilder.hpp","additions":9,"deletions":19,"binary":false,"changes":28,"status":"modified"},{"patch":"@@ -38,3 +38,1 @@\n-    if (!ref->keep_after_pushing()) {\n-      delete ref;\n-    }\n+    delete ref;\n@@ -83,3 +81,1 @@\n-    if (!ref->keep_after_pushing()) {\n-      delete ref;\n-    }\n+    delete ref;\n","filename":"src\/hotspot\/share\/memory\/metaspaceClosure.cpp","additions":2,"deletions":6,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -109,1 +109,0 @@\n-    bool _keep_after_pushing;\n@@ -116,1 +115,1 @@\n-    Ref(Writability w) : _writability(w), _keep_after_pushing(false), _next(nullptr), _user_data(nullptr) {}\n+    Ref(Writability w) : _writability(w), _next(nullptr), _user_data(nullptr) {}\n@@ -137,2 +136,0 @@\n-    void set_keep_after_pushing()   { _keep_after_pushing = true; }\n-    bool keep_after_pushing()       { return _keep_after_pushing; }\n","filename":"src\/hotspot\/share\/memory\/metaspaceClosure.hpp","additions":1,"deletions":4,"binary":false,"changes":5,"status":"modified"}]}