{"files":[{"patch":"@@ -116,4 +116,6 @@\n-  MutexLocker ml(MetaspaceCritical_lock, Mutex::_no_safepoint_check_flag);\n-  if (_requests_head == request) {\n-    \/\/ The first request can't opportunistically ride on a previous GC\n-    return false;\n+  {\n+    MutexLocker ml(MetaspaceCritical_lock, Mutex::_no_safepoint_check_flag);\n+    if (_requests_head == request) {\n+      \/\/ The first request can't opportunistically ride on a previous GC\n+      return false;\n+    }\n@@ -127,2 +129,6 @@\n-  while (!request->has_result()) {\n-    ThreadBlockInVM tbivm(JavaThread::current());\n+  ThreadBlockInVM tbivm(JavaThread::current());\n+  MutexLocker ml(MetaspaceCritical_lock, Mutex::_no_safepoint_check_flag);\n+  for (;;) {\n+    if (request->has_result()) {\n+      break;\n+    }\n","filename":"src\/hotspot\/share\/memory\/metaspaceCriticalAllocation.cpp","additions":12,"deletions":6,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -31,1 +31,1 @@\n- * In this test a 1000 classes are loaded and unloaded in a loop.\n+ * In this test 1000 classes are loaded and unloaded in a loop.\n@@ -33,1 +33,1 @@\n- * the way uptill class1000.  The classes should be unloaded whenever a\n+ * the way up to class1000.  The classes should be unloaded whenever a\n@@ -35,1 +35,1 @@\n- * at the end of the each loop iteration. The loop is repeated 1000 times.\n+ * at the end of each loop iteration. The loop is repeated 1000 times.\n@@ -48,0 +48,24 @@\n+\/*\n+ * @test\n+ * @key stress\n+ *\n+ * @summary converted from VM Testbase gc\/gctests\/LoadUnloadGC.\n+ * VM Testbase keywords: [gc, stress, stressopt, nonconcurrent, monitoring]\n+ * VM Testbase readme:\n+ * In this test 1000 classes are loaded and unloaded in a loop.\n+ * Class0 gets loaded which results in Class1 getting loaded and so on all\n+ * the way up to class1000.  The classes should be unloaded whenever a\n+ * garbage collection takes place because their classloader is made unreachable\n+ * at the end of each loop iteration. The loop is repeated 1000 times.\n+ *\n+ * @requires vm.opt.final.ClassUnloading\n+ * @library \/vmTestbase\n+ *          \/test\/lib\n+ * @build nsk.share.gc.ClassChain\n+ * @run main\/othervm\n+ *      -XX:MaxMetaspaceSize=64M\n+ *      -XX:MetaspaceSize=64M\n+ *      -XX:CompressedClassSpaceSize=32M\n+ *      gc.gctests.LoadUnloadGC.LoadUnloadGC\n+ *\/\n+\n","filename":"test\/hotspot\/jtreg\/vmTestbase\/gc\/gctests\/LoadUnloadGC\/LoadUnloadGC.java","additions":27,"deletions":3,"binary":false,"changes":30,"status":"modified"}]}