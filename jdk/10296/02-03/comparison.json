{"files":[{"patch":"@@ -469,7 +469,5 @@\n-    if (r->mapped_base() != NULL) {\n-      if (MetaspaceShared::relocation_delta() != 0 && r->has_ptrmap()) {\n-        log_info(cds, heap)(\"Patching native pointers in heap region %d\", i);\n-        BitMapView bm = r->ptrmap_view();\n-        PatchNativePointers patcher((Metadata**)r->mapped_base());\n-        bm.iterate(&patcher);\n-      }\n+    if (r->mapped_base() != NULL && r->has_ptrmap()) {\n+      log_info(cds, heap)(\"Patching native pointers in heap region %d\", i);\n+      BitMapView bm = r->ptrmap_view();\n+      PatchNativePointers patcher((Metadata**)r->mapped_base());\n+      bm.iterate(&patcher);\n","filename":"src\/hotspot\/share\/cds\/archiveHeapLoader.cpp","additions":5,"deletions":7,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -66,1 +66,1 @@\n-        String logArg = \"-Xlog:cds=debug,cds+reloc=debug\";\n+        String logArg = \"-Xlog:cds=debug,cds+reloc=debug,cds+heap\";\n@@ -79,0 +79,1 @@\n+                        output.shouldContain(\"Patching native pointers in heap region\");\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/ArchiveRelocationTest.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -103,1 +103,4 @@\n-        if (dumpGC.equals(G1)) {\n+        if (out.getOutput().contains(\"Trying to map heap\") || out.getOutput().contains(\"Loaded heap\")) {\n+            \/\/ The native data in the RO\/RW regions have been relocated. If the CDS heap is\n+            \/\/ mapped\/loaded, we must patch all the native pointers. (CDS heap is\n+            \/\/ not supported on all platforms)\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/TestSerialGCWithCDS.java","additions":4,"deletions":1,"binary":false,"changes":5,"status":"modified"}]}