{"files":[{"patch":"@@ -114,0 +114,14 @@\n+  fail_continue_impl(LogLevel::Info, msg, ap);\n+  va_end(ap);\n+}\n+\n+void FileMapInfo::fail_continue(LogLevelType level, const char *msg, ...) {\n+  va_list ap;\n+  va_start(ap, msg);\n+  fail_continue_impl(level, msg, ap);\n+  va_end(ap);\n+}\n+\n+void FileMapInfo::fail_continue_impl(LogLevelType level, const char *msg, va_list ap) {\n+  va_list ap_copy;\n+  va_copy(ap_copy, ap);\n@@ -119,1 +133,1 @@\n-    tty->vprint(msg, ap);\n+    tty->vprint(msg, ap_copy);\n@@ -123,1 +137,1 @@\n-      fail_exit(msg, ap);\n+      fail_exit(msg, ap_copy);\n@@ -125,0 +139,4 @@\n+      \/\/ LogMessage::vwrite, which makes a copy of the va_list, must be called before\n+      \/\/ LogStream::vprint_cr.\n+      LogMessage(cds) lm;\n+      lm.vwrite(level, msg, ap_copy);\n@@ -128,1 +146,1 @@\n-        ls.vprint_cr(msg, ap);\n+        ls.vprint_cr(msg, ap_copy);\n@@ -132,1 +150,1 @@\n-  va_end(ap);\n+  va_end(ap_copy);\n@@ -1120,5 +1138,4 @@\n-      const char* mismatch_msg = \"shared class paths mismatch (hint: enable -Xlog:class+path=info to diagnose the failure)\";\n-      fail_continue(\"%s\", mismatch_msg);\n-      if (!log_is_enabled(Info, cds) && !log_is_enabled(Info, class, path)) {\n-        log_warning(cds)(\"%s\", mismatch_msg);\n-      }\n+      const char* mismatch_msg = \"shared class paths mismatch\";\n+      const char* hint_msg = log_is_enabled(Info, class, path) ?\n+          \"\" : \" (hint: enable -Xlog:class+path=info to diagnose the failure)\";\n+      fail_continue(LogLevel::Warning, \"%s%s\", mismatch_msg, hint_msg);\n","filename":"src\/hotspot\/share\/cds\/filemap.cpp","additions":26,"deletions":9,"binary":false,"changes":35,"status":"modified"},{"patch":"@@ -30,0 +30,1 @@\n+#include \"logging\/logLevel.hpp\"\n@@ -484,0 +485,2 @@\n+  static void fail_continue(LogLevelType level, const char *msg, ...) ATTRIBUTE_PRINTF(2, 3);\n+  static void fail_continue_impl(LogLevelType level, const char *msg, va_list ap) ATTRIBUTE_PRINTF(2, 0);\n","filename":"src\/hotspot\/share\/cds\/filemap.hpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -44,1 +44,2 @@\n-    String mismatchMsg = \"shared class paths mismatch (hint: enable -Xlog:class+path=info to diagnose the failure)\";\n+    String mismatchMsg = \"shared class paths mismatch\";\n+    String hintMsg = \"(hint: enable -Xlog:class+path=info to diagnose the failure)\";\n@@ -54,1 +55,1 @@\n-        .assertAbnormalExit(unableToUseMsg, mismatchMsg);\n+        .assertAbnormalExit(unableToUseMsg, mismatchMsg, hintMsg);\n@@ -59,1 +60,13 @@\n-    output.shouldContain(mismatchMsg);\n+    output.shouldContain(mismatchMsg)\n+          .shouldContain(hintMsg);\n+\n+    \/\/ Run with -Xshare:on and -Xlog:class+path=info, the mismatchMsg should\n+    \/\/ be there, the hintMsg should NOT be there.\n+    TestCommon.run(\n+        \"-Xlog:class+path=info\",\n+        \"Hello\")\n+        .assertAbnormalExit( out -> {\n+            out.shouldContain(unableToUseMsg)\n+               .shouldContain(mismatchMsg)\n+               .shouldNotContain(hintMsg);\n+        });\n@@ -69,1 +82,1 @@\n-        .assertAbnormalExit(unableToUseMsg, mismatchMsg);\n+        .assertAbnormalExit(unableToUseMsg, mismatchMsg, hintMsg);\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/WrongClasspath.java","additions":17,"deletions":4,"binary":false,"changes":21,"status":"modified"},{"patch":"@@ -64,0 +64,2 @@\n+        String mismatchMsg = \"shared class paths mismatch\";\n+        String hintMsg = \"(hint: enable -Xlog:class+path=info to diagnose the failure)\";\n@@ -85,2 +87,14 @@\n-          .assertNormalExit(topArchiveMsg,\n-                            \"shared class paths mismatch (hint: enable -Xlog:class+path=info to diagnose the failure)\");\n+          .assertNormalExit(topArchiveMsg, mismatchMsg, hintMsg);\n+\n+        \/\/ Enable class+path logging and run with -Xshare:on, the mismatchMsg\n+        \/\/ should be there, the hintMsg should NOT be there.\n+        run2_WB(baseArchiveName, topArchiveName,\n+                \"-Xlog:class+path=info\",\n+                \"-Xshare:on\",\n+                \"-cp\", wrongJar, mainClass,\n+                \"assertShared:java.lang.Object\",  \/\/ base archive still useable\n+                \"assertNotShared:GenericTestApp\") \/\/ but top archive is not useable\n+          .assertAbnormalExit( output -> {\n+            output.shouldContain(mismatchMsg)\n+                  .shouldNotContain(hintMsg);\n+          });\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/dynamicArchive\/WrongTopClasspath.java","additions":16,"deletions":2,"binary":false,"changes":18,"status":"modified"}]}