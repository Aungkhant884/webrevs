{"files":[{"patch":"@@ -199,4 +199,0 @@\n-        int aoffset = UNSAFE.arrayBaseOffset(arrayClass);\n-        int ascale = UNSAFE.arrayIndexScale(arrayClass);\n-        int ashift = 31 - Integer.numberOfLeadingZeros(ascale);\n-\n@@ -204,0 +200,3 @@\n+            int aoffset = UNSAFE.arrayBaseOffset(arrayClass);\n+            int ascale = UNSAFE.arrayIndexScale(arrayClass);\n+            int ashift = 31 - Integer.numberOfLeadingZeros(ascale);\n@@ -207,1 +206,1 @@\n-            return maybeAdapt(new VarHandleBooleans.Array(aoffset, ashift));\n+            return maybeAdapt(VarHandleBooleans.Array.INSTANCE);\n@@ -210,1 +209,1 @@\n-            return maybeAdapt(new VarHandleBytes.Array(aoffset, ashift));\n+            return maybeAdapt(VarHandleBytes.Array.INSTANCE);\n@@ -213,1 +212,1 @@\n-            return maybeAdapt(new VarHandleShorts.Array(aoffset, ashift));\n+            return maybeAdapt(VarHandleShorts.Array.INSTANCE);\n@@ -216,1 +215,1 @@\n-            return maybeAdapt(new VarHandleChars.Array(aoffset, ashift));\n+            return maybeAdapt(VarHandleChars.Array.INSTANCE);\n@@ -219,1 +218,1 @@\n-            return maybeAdapt(new VarHandleInts.Array(aoffset, ashift));\n+            return maybeAdapt(VarHandleInts.Array.INSTANCE);\n@@ -222,1 +221,1 @@\n-            return maybeAdapt(new VarHandleLongs.Array(aoffset, ashift));\n+            return maybeAdapt(VarHandleLongs.Array.INSTANCE);\n@@ -225,1 +224,1 @@\n-            return maybeAdapt(new VarHandleFloats.Array(aoffset, ashift));\n+            return maybeAdapt(VarHandleFloats.Array.INSTANCE);\n@@ -228,1 +227,1 @@\n-            return maybeAdapt(new VarHandleDoubles.Array(aoffset, ashift));\n+            return maybeAdapt(VarHandleDoubles.Array.INSTANCE);\n","filename":"src\/java.base\/share\/classes\/java\/lang\/invoke\/VarHandles.java","additions":11,"deletions":12,"binary":false,"changes":23,"status":"modified"},{"patch":"@@ -732,0 +732,1 @@\n+#if[Object]\n@@ -734,2 +735,1 @@\n-#if[Object]\n-        final Class<{#if[Object]??:$type$[]}> arrayType;\n+        final Class<?> arrayType;\n@@ -737,0 +737,3 @@\n+#else[Object]\n+        private static final int BASE = UNSAFE.arrayBaseOffset($type$[].class);\n+        private static final int SHIFT = 31 - Integer.numberOfLeadingZeros(UNSAFE.arrayIndexScale($type$[].class));\n@@ -739,2 +742,3 @@\n-        Array(int abase, int ashift{#if[Object]?, Class<?> arrayType}) {\n-            this(abase, ashift{#if[Object]?, arrayType}, false);\n+#if[Object]\n+        Array(int abase, int ashift, Class<?> arrayType) {\n+            this(abase, ashift, arrayType, false);\n@@ -743,1 +747,2 @@\n-        private Array(int abase, int ashift{#if[Object]?, Class<?> arrayType}, boolean exact) {\n+#end[Object]\n+        private Array({#if[Object]?int abase, int ashift, Class<?> arrayType, }boolean exact) {\n@@ -745,0 +750,1 @@\n+#if[Object]\n@@ -747,2 +753,1 @@\n-#if[Object]\n-            this.arrayType = {#if[Object]?arrayType:$type$[].class};\n+            this.arrayType = arrayType;\n@@ -757,1 +762,1 @@\n-                : new Array(abase, ashift{#if[Object]?, arrayType}, true);\n+                : {#if[Object]?new Array(abase, ashift, arrayType, true):EXACT_INSTANCE};\n@@ -764,1 +769,1 @@\n-                : new Array(abase, ashift{#if[Object]?, arrayType}, false);\n+                : {#if[Object]?new Array(abase, ashift, arrayType, false):INSTANCE};\n@@ -801,0 +806,1 @@\n+\n@@ -802,0 +808,4 @@\n+        @ForceInline\n+        static long offset({#if[Object]?Array handle, Object:$type$}[] array, int index)  {\n+            return (((long) Preconditions.checkIndex(index, array.length, Preconditions.AIOOBE_FORMATTER)) << {#if[Object]?handle.ashift:SHIFT}) + {#if[Object]?handle.abase:BASE};\n+        }\n@@ -805,1 +815,0 @@\n-            Array handle = (Array)ob;\n@@ -807,0 +816,1 @@\n+            Array handle = (Array)ob;\n@@ -816,1 +826,0 @@\n-            Array handle = (Array)ob;\n@@ -818,0 +827,1 @@\n+            Array handle = (Array)ob;\n@@ -827,1 +837,0 @@\n-            Array handle = (Array)ob;\n@@ -829,0 +838,1 @@\n+            Array handle = (Array)ob;\n@@ -834,1 +844,1 @@\n-                    (((long) Preconditions.checkIndex(index, array.length, Preconditions.AIOOBE_FORMATTER)) << handle.ashift) + handle.abase);\n+                    offset({#if[Object]?handle, }array, index));\n@@ -839,1 +849,0 @@\n-            Array handle = (Array)ob;\n@@ -841,0 +850,1 @@\n+            Array handle = (Array)ob;\n@@ -846,1 +856,1 @@\n-                    (((long) Preconditions.checkIndex(index, array.length, Preconditions.AIOOBE_FORMATTER)) << handle.ashift) + handle.abase,\n+                    offset({#if[Object]?handle, }array, index),\n@@ -852,1 +862,0 @@\n-            Array handle = (Array)ob;\n@@ -854,0 +863,1 @@\n+            Array handle = (Array)ob;\n@@ -859,1 +869,1 @@\n-                    (((long) Preconditions.checkIndex(index, array.length, Preconditions.AIOOBE_FORMATTER)) << handle.ashift) + handle.abase);\n+                    offset({#if[Object]?handle, }array, index));\n@@ -864,1 +874,0 @@\n-            Array handle = (Array)ob;\n@@ -866,0 +875,1 @@\n+            Array handle = (Array)ob;\n@@ -871,1 +881,1 @@\n-                    (((long) Preconditions.checkIndex(index, array.length, Preconditions.AIOOBE_FORMATTER)) << handle.ashift) + handle.abase,\n+                    offset({#if[Object]?handle, }array, index),\n@@ -877,1 +887,0 @@\n-            Array handle = (Array)ob;\n@@ -879,0 +888,1 @@\n+            Array handle = (Array)ob;\n@@ -884,1 +894,1 @@\n-                    (((long) Preconditions.checkIndex(index, array.length, Preconditions.AIOOBE_FORMATTER)) << handle.ashift) + handle.abase);\n+                    offset({#if[Object]?handle, }array, index));\n@@ -889,1 +899,0 @@\n-            Array handle = (Array)ob;\n@@ -891,0 +900,1 @@\n+            Array handle = (Array)ob;\n@@ -896,1 +906,1 @@\n-                    (((long) Preconditions.checkIndex(index, array.length, Preconditions.AIOOBE_FORMATTER)) << handle.ashift) + handle.abase,\n+                    offset({#if[Object]?handle, }array, index),\n@@ -903,1 +913,0 @@\n-            Array handle = (Array)ob;\n@@ -905,0 +914,1 @@\n+            Array handle = (Array)ob;\n@@ -910,1 +920,1 @@\n-                    (((long) Preconditions.checkIndex(index, array.length, Preconditions.AIOOBE_FORMATTER)) << handle.ashift) + handle.abase,\n+                    offset({#if[Object]?handle, }array, index),\n@@ -917,1 +927,0 @@\n-            Array handle = (Array)ob;\n@@ -919,0 +928,1 @@\n+            Array handle = (Array)ob;\n@@ -924,1 +934,1 @@\n-                    (((long) Preconditions.checkIndex(index, array.length, Preconditions.AIOOBE_FORMATTER)) << handle.ashift) + handle.abase,\n+                    offset({#if[Object]?handle, }array, index),\n@@ -931,1 +941,0 @@\n-            Array handle = (Array)ob;\n@@ -933,0 +942,1 @@\n+            Array handle = (Array)ob;\n@@ -938,1 +948,1 @@\n-                    (((long) Preconditions.checkIndex(index, array.length, Preconditions.AIOOBE_FORMATTER)) << handle.ashift) + handle.abase,\n+                    offset({#if[Object]?handle, }array, index),\n@@ -945,1 +955,0 @@\n-            Array handle = (Array)ob;\n@@ -947,0 +956,1 @@\n+            Array handle = (Array)ob;\n@@ -952,1 +962,1 @@\n-                    (((long) Preconditions.checkIndex(index, array.length, Preconditions.AIOOBE_FORMATTER)) << handle.ashift) + handle.abase,\n+                    offset({#if[Object]?handle, }array, index),\n@@ -959,1 +969,0 @@\n-            Array handle = (Array)ob;\n@@ -961,0 +970,1 @@\n+            Array handle = (Array)ob;\n@@ -966,1 +976,1 @@\n-                    (((long) Preconditions.checkIndex(index, array.length, Preconditions.AIOOBE_FORMATTER)) << handle.ashift) + handle.abase,\n+                    offset({#if[Object]?handle, }array, index),\n@@ -973,1 +983,0 @@\n-            Array handle = (Array)ob;\n@@ -975,0 +984,1 @@\n+            Array handle = (Array)ob;\n@@ -980,1 +990,1 @@\n-                    (((long) Preconditions.checkIndex(index, array.length, Preconditions.AIOOBE_FORMATTER)) << handle.ashift) + handle.abase,\n+                    offset({#if[Object]?handle, }array, index),\n@@ -987,1 +997,0 @@\n-            Array handle = (Array)ob;\n@@ -989,0 +998,1 @@\n+            Array handle = (Array)ob;\n@@ -994,1 +1004,1 @@\n-                    (((long) Preconditions.checkIndex(index, array.length, Preconditions.AIOOBE_FORMATTER)) << handle.ashift) + handle.abase,\n+                    offset({#if[Object]?handle, }array, index),\n@@ -1001,1 +1011,0 @@\n-            Array handle = (Array)ob;\n@@ -1003,0 +1012,1 @@\n+            Array handle = (Array)ob;\n@@ -1008,1 +1018,1 @@\n-                    (((long) Preconditions.checkIndex(index, array.length, Preconditions.AIOOBE_FORMATTER)) << handle.ashift) + handle.abase,\n+                    offset({#if[Object]?handle, }array, index),\n@@ -1015,1 +1025,0 @@\n-            Array handle = (Array)ob;\n@@ -1017,0 +1026,1 @@\n+            Array handle = (Array)ob;\n@@ -1022,1 +1032,1 @@\n-                    (((long) Preconditions.checkIndex(index, array.length, Preconditions.AIOOBE_FORMATTER)) << handle.ashift) + handle.abase,\n+                    offset({#if[Object]?handle, }array, index),\n@@ -1028,1 +1038,0 @@\n-            Array handle = (Array)ob;\n@@ -1030,0 +1039,1 @@\n+            Array handle = (Array)ob;\n@@ -1035,1 +1045,1 @@\n-                    (((long) Preconditions.checkIndex(index, array.length, Preconditions.AIOOBE_FORMATTER)) << handle.ashift) + handle.abase,\n+                    offset({#if[Object]?handle, }array, index),\n@@ -1041,1 +1051,0 @@\n-            Array handle = (Array)ob;\n@@ -1043,0 +1052,1 @@\n+            Array handle = (Array)ob;\n@@ -1048,1 +1058,1 @@\n-                    (((long) Preconditions.checkIndex(index, array.length, Preconditions.AIOOBE_FORMATTER)) << handle.ashift) + handle.abase,\n+                    offset({#if[Object]?handle, }array, index),\n@@ -1056,1 +1066,0 @@\n-            Array handle = (Array)ob;\n@@ -1059,1 +1068,1 @@\n-                    (((long) Preconditions.checkIndex(index, array.length, Preconditions.AIOOBE_FORMATTER)) << handle.ashift) + handle.abase,\n+                    offset(array, index),\n@@ -1065,1 +1074,0 @@\n-            Array handle = (Array)ob;\n@@ -1068,1 +1076,1 @@\n-                    (((long) Preconditions.checkIndex(index, array.length, Preconditions.AIOOBE_FORMATTER)) << handle.ashift) + handle.abase,\n+                    offset(array, index),\n@@ -1074,1 +1082,0 @@\n-            Array handle = (Array)ob;\n@@ -1077,1 +1084,1 @@\n-                    (((long) Preconditions.checkIndex(index, array.length, Preconditions.AIOOBE_FORMATTER)) << handle.ashift) + handle.abase,\n+                    offset(array, index),\n@@ -1085,1 +1092,0 @@\n-            Array handle = (Array)ob;\n@@ -1088,1 +1094,1 @@\n-                                       (((long) Preconditions.checkIndex(index, array.length, Preconditions.AIOOBE_FORMATTER)) << handle.ashift) + handle.abase,\n+                                       offset(array, index),\n@@ -1094,1 +1100,0 @@\n-            Array handle = (Array)ob;\n@@ -1097,1 +1102,1 @@\n-                                       (((long) Preconditions.checkIndex(index, array.length, Preconditions.AIOOBE_FORMATTER)) << handle.ashift) + handle.abase,\n+                                       offset(array, index),\n@@ -1103,1 +1108,0 @@\n-            Array handle = (Array)ob;\n@@ -1106,1 +1110,1 @@\n-                                       (((long) Preconditions.checkIndex(index, array.length, Preconditions.AIOOBE_FORMATTER)) << handle.ashift) + handle.abase,\n+                                       offset(array, index),\n@@ -1112,1 +1116,0 @@\n-            Array handle = (Array)ob;\n@@ -1115,1 +1118,1 @@\n-                                       (((long) Preconditions.checkIndex(index, array.length, Preconditions.AIOOBE_FORMATTER)) << handle.ashift) + handle.abase,\n+                                       offset(array, index),\n@@ -1121,1 +1124,0 @@\n-            Array handle = (Array)ob;\n@@ -1124,1 +1126,1 @@\n-                                       (((long) Preconditions.checkIndex(index, array.length, Preconditions.AIOOBE_FORMATTER)) << handle.ashift) + handle.abase,\n+                                       offset(array, index),\n@@ -1130,1 +1132,0 @@\n-            Array handle = (Array)ob;\n@@ -1133,1 +1134,1 @@\n-                                       (((long) Preconditions.checkIndex(index, array.length, Preconditions.AIOOBE_FORMATTER)) << handle.ashift) + handle.abase,\n+                                       offset(array, index),\n@@ -1139,1 +1140,0 @@\n-            Array handle = (Array)ob;\n@@ -1142,1 +1142,1 @@\n-                                       (((long) Preconditions.checkIndex(index, array.length, Preconditions.AIOOBE_FORMATTER)) << handle.ashift) + handle.abase,\n+                                       offset(array, index),\n@@ -1148,1 +1148,0 @@\n-            Array handle = (Array)ob;\n@@ -1151,1 +1150,1 @@\n-                                       (((long) Preconditions.checkIndex(index, array.length, Preconditions.AIOOBE_FORMATTER)) << handle.ashift) + handle.abase,\n+                                       offset(array, index),\n@@ -1157,1 +1156,0 @@\n-            Array handle = (Array)ob;\n@@ -1160,1 +1158,1 @@\n-                                       (((long) Preconditions.checkIndex(index, array.length, Preconditions.AIOOBE_FORMATTER)) << handle.ashift) + handle.abase,\n+                                       offset(array, index),\n@@ -1166,0 +1164,7 @@\n+#if[Object]\n+#else[Object]\n+\n+        \/\/ Must be initialized after FORM is ready\n+        static final Array INSTANCE = new Array(false);\n+        static final Array EXACT_INSTANCE = new Array(true);\n+#end[Object]\n","filename":"src\/java.base\/share\/classes\/java\/lang\/invoke\/X-VarHandle.java.template","additions":74,"deletions":69,"binary":false,"changes":143,"status":"modified"}]}