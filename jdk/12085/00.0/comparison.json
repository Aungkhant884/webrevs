{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2003, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2003, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -610,2 +610,2 @@\n-            byte[] profile = new byte[profileSize];\n-            iis.readFully(profile, 0, profileSize);\n+            byte[] profile = ReaderUtil.\n+                    staggeredReadByteStream(iis, profileSize);\n@@ -614,6 +614,4 @@\n-            try {\n-                if (metadata.colorSpace == PROFILE_LINKED &&\n-                    isLinkedProfileAllowed() &&\n-                    !isUncOrDevicePath(profile))\n-                {\n-                    String path = new String(profile, \"windows-1252\");\n+            if (metadata.colorSpace == PROFILE_LINKED &&\n+                isLinkedProfileAllowed())\n+            {\n+                String path = new String(profile, \"windows-1252\");\n@@ -621,8 +619,5 @@\n-                    colorSpace =\n-                        new ICC_ColorSpace(ICC_Profile.getInstance(path));\n-                } else {\n-                    colorSpace =\n-                        new ICC_ColorSpace(ICC_Profile.getInstance(profile));\n-                }\n-            } catch (Exception e) {\n-                colorSpace = ColorSpace.getInstance(ColorSpace.CS_sRGB);\n+                colorSpace =\n+                    new ICC_ColorSpace(ICC_Profile.getInstance(path));\n+            } else if (metadata.colorSpace == PROFILE_EMBEDDED) {\n+                colorSpace =\n+                    new ICC_ColorSpace(ICC_Profile.getInstance(profile));\n@@ -2043,1 +2038,1 @@\n-    private static Boolean isLinkedProfileDisabled = null;\n+    private static Boolean isLinkedProfileAllowed = null;\n@@ -2047,28 +2042,1 @@\n-        if (isLinkedProfileDisabled == null) {\n-            PrivilegedAction<Boolean> a = new PrivilegedAction<Boolean>() {\n-                @Override\n-                public Boolean run() {\n-                    return Boolean.getBoolean(\"sun.imageio.plugins.bmp.disableLinkedProfiles\");\n-                }\n-            };\n-            isLinkedProfileDisabled = AccessController.doPrivileged(a);\n-        }\n-        return !isLinkedProfileDisabled;\n-    }\n-\n-    private static Boolean isWindowsPlatform = null;\n-\n-    \/**\n-     * Verifies whether the byte array contains a unc path.\n-     * Non-UNC path examples:\n-     *  c:\\path\\to\\file  - simple notation\n-     *  \\\\?\\c:\\path\\to\\file - long notation\n-     *\n-     * UNC path examples:\n-     *  \\\\server\\share - a UNC path in simple notation\n-     *  \\\\?\\UNC\\server\\share - a UNC path in long notation\n-     *  \\\\.\\some\\device - a path to device.\n-     *\/\n-    @SuppressWarnings(\"removal\")\n-    private static boolean isUncOrDevicePath(byte[] p) {\n-        if (isWindowsPlatform == null) {\n+        if (isLinkedProfileAllowed == null) {\n@@ -2078,3 +2046,2 @@\n-                    String osname = System.getProperty(\"os.name\");\n-                    return (osname != null &&\n-                            osname.toLowerCase().startsWith(\"win\"));\n+                    return Boolean.\n+                        getBoolean(\"sun.imageio.bmp.enableLinkedProfiles\");\n@@ -2083,26 +2050,1 @@\n-            isWindowsPlatform = AccessController.doPrivileged(a);\n-        }\n-\n-        if (!isWindowsPlatform) {\n-            \/* no need for the check on platforms except windows *\/\n-            return false;\n-        }\n-\n-        \/* normalize prefix of the path *\/\n-        if (p[0] == '\/') p[0] = '\\\\';\n-        if (p[1] == '\/') p[1] = '\\\\';\n-        if (p[3] == '\/') p[3] = '\\\\';\n-\n-\n-        if ((p[0] == '\\\\') && (p[1] == '\\\\')) {\n-            if ((p[2] == '?') && (p[3] == '\\\\')) {\n-                \/\/ long path: whether unc or local\n-                return ((p[4] == 'U' || p[4] == 'u') &&\n-                        (p[5] == 'N' || p[5] == 'n') &&\n-                        (p[6] == 'C' || p[6] == 'c'));\n-            } else {\n-                \/\/ device path or short unc notation\n-                return true;\n-            }\n-        } else {\n-            return false;\n+            isLinkedProfileAllowed = AccessController.doPrivileged(a);\n@@ -2110,0 +2052,1 @@\n+        return isLinkedProfileAllowed;\n@@ -2112,1 +2055,0 @@\n-\n","filename":"src\/java.desktop\/share\/classes\/com\/sun\/imageio\/plugins\/bmp\/BMPImageReader.java","additions":18,"deletions":76,"binary":false,"changes":94,"status":"modified"},{"patch":"@@ -27,0 +27,1 @@\n+#include <strsafe.h>\n@@ -2411,1 +2412,1 @@\n-        wcscpy(lf.lfFaceName, fontNameW);\n+        StringCchCopyW(lf.lfFaceName, LF_FACESIZE, fontNameW);\n","filename":"src\/java.desktop\/windows\/native\/libawt\/windows\/awt_PrintJob.cpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"}]}