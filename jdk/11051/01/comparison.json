{"files":[{"patch":"@@ -1738,7 +1738,2 @@\n-  __ push_reg(t0);\n-  __ push_reg(x10);\n-  __ mv(x10, (address) &BytecodeCounter::_counter_value);\n-  __ mv(t0, 1);\n-  __ amoadd_d(zr, x10, t0, Assembler::aqrl);\n-  __ pop_reg(x10);\n-  __ pop_reg(t0);\n+  __ mv(x7, (address) &BytecodeCounter::_counter_value);\n+  __ atomic_addw(noreg, 1, x7);\n@@ -1747,1 +1742,4 @@\n-void TemplateInterpreterGenerator::histogram_bytecode(Template* t) { ; }\n+void TemplateInterpreterGenerator::histogram_bytecode(Template* t) {\n+  __ mv(x7, (address) &BytecodeHistogram::_counters[t->bytecode()]);\n+  __ atomic_addw(noreg, 1, x7);\n+}\n@@ -1749,1 +1747,20 @@\n-void TemplateInterpreterGenerator::histogram_bytecode_pair(Template* t) { ; }\n+void TemplateInterpreterGenerator::histogram_bytecode_pair(Template* t) {\n+  \/\/ Calculate new index for counter:\n+  \/\/   _index = (_index >> log2_number_of_codes) |\n+  \/\/            (bytecode << log2_number_of_codes);\n+  Register index_addr = t1;\n+  Register index = t0;\n+  __ mv(index_addr, (address) &BytecodePairHistogram::_index);\n+  __ lw(index, index_addr);\n+  __ mv(x7, ((int)t->bytecode()) << BytecodePairHistogram::log2_number_of_codes);\n+  __ srli(index, index, BytecodePairHistogram::log2_number_of_codes);\n+  __ orrw(index, x7, index);\n+  __ sw(index, index_addr);\n+  \/\/ Bump bucket contents:\n+  \/\/   _counters[_index] ++;\n+  Register counter_addr = t1;\n+  __ mv(x7, (address) &BytecodePairHistogram::_counters);\n+  __ slli(index, index, LogBytesPerInt);\n+  __ add(counter_addr, x7, index);\n+  __ atomic_addw(noreg, 1, counter_addr);\n+ }\n","filename":"src\/hotspot\/cpu\/riscv\/templateInterpreterGenerator_riscv.cpp","additions":26,"deletions":9,"binary":false,"changes":35,"status":"modified"}]}