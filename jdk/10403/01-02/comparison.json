{"files":[{"patch":"@@ -2086,1 +2086,1 @@\n-    volatile char* p1 = (volatile char*) alloca(1);\n+    char* p1 = (char*) alloca(1);\n@@ -2090,1 +2090,1 @@\n-      volatile char* p2 = (char*) alloca(to_alloc);\n+      char* p2 = (char*) alloca(to_alloc);\n@@ -2093,1 +2093,1 @@\n-      os::pretouch_memory((void*)p2, (void*)(p2 + to_alloc),\n+      os::pretouch_memory(p2, p2 + to_alloc,\n","filename":"src\/hotspot\/share\/runtime\/javaThread.cpp","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -30,0 +30,2 @@\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n@@ -74,1 +76,3 @@\n-                    \"TestAlwaysPreTouchStacks\", \"test\");\n+                    \"-XX:NativeMemoryTracking=summary\", \"-XX:+PrintNMTStatistics\",\n+                    \"TestAlwaysPreTouchStacks\",\n+                    \"test\");\n@@ -86,0 +90,31 @@\n+            \/\/ We want to see, in the final NMT printout, a committed thread stack size very close to reserved\n+            \/\/ stack size. Like this:\n+            \/\/ -                    Thread (reserved=10332400KB, committed=10284360KB)\n+            \/\/                      (thread #10021)\n+            \/\/                      (stack: reserved=10301560KB, committed=10253520KB)   <<<<\n+            \/\/\n+            \/\/ ... without -XX:+AlwaysPreTouchStacks, the committed\/reserved ratio for thread stacks should be\n+            \/\/ a lot lower, e.g.:\n+            \/\/ -                    Thread (reserved=10332400KB, committed=331828KB)\n+            \/\/                      (thread #10021)\n+            \/\/                      (stack: reserved=10301560KB, committed=300988KB)  <<<\n+\n+            output.shouldMatch(\"- *Thread.*reserved.*committed\");\n+            Pattern pat = Pattern.compile(\".*stack: reserved=(\\\\d+), committed=(\\\\d+).*\");\n+            boolean foundLine = false;\n+            for (String line : output.asLines()) {\n+                Matcher m = pat.matcher(line);\n+                if (m.matches()) {\n+                    long reserved = Long.parseLong(m.group(1));\n+                    long committed = Long.parseLong(m.group(2));\n+                    System.out.println(\">>>>> \" + line + \": \" + reserved + \" - \" + committed);\n+                    if (committed < (reserved \/ 2)) {\n+                        throw new RuntimeException(\"Expected a higher ratio between stack committed and reserved.\");\n+                    }\n+                    foundLine = true;\n+                    break;\n+                }\n+            }\n+            if (!foundLine) {\n+                throw new RuntimeException(\"Did not find expected NMT output\");\n+            }\n","filename":"test\/hotspot\/jtreg\/runtime\/Thread\/TestAlwaysPreTouchStacks.java","additions":36,"deletions":1,"binary":false,"changes":37,"status":"modified"}]}