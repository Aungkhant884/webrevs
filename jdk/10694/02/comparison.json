{"files":[{"patch":"@@ -85,2 +85,2 @@\n-    _young_card_merge_to_scan_ratio_seq(new TruncatedSeq(TruncatedSeqLength)),\n-    _mixed_card_merge_to_scan_ratio_seq(new TruncatedSeq(TruncatedSeqLength)),\n+    _young_card_scan_to_merge_ratio_seq(new TruncatedSeq(TruncatedSeqLength)),\n+    _mixed_card_scan_to_merge_ratio_seq(new TruncatedSeq(TruncatedSeqLength)),\n@@ -115,1 +115,1 @@\n-  _young_card_merge_to_scan_ratio_seq->add(young_card_merge_to_scan_ratio_defaults[index]);\n+  _young_card_scan_to_merge_ratio_seq->add(young_card_merge_to_scan_ratio_defaults[index]);\n@@ -191,3 +191,3 @@\n-void G1Analytics::report_card_merge_to_scan_ratio(double merge_to_scan_ratio, bool for_young_only_phase) {\n-  if  (for_young_only_phase) {\n-    _young_card_merge_to_scan_ratio_seq->add(merge_to_scan_ratio);\n+void G1Analytics::report_card_scan_to_merge_ratio(double merge_to_scan_ratio, bool for_young_only_phase) {\n+  if (for_young_only_phase) {\n+    _young_card_scan_to_merge_ratio_seq->add(merge_to_scan_ratio);\n@@ -195,1 +195,1 @@\n-    _mixed_card_merge_to_scan_ratio_seq->add(merge_to_scan_ratio);\n+    _mixed_card_scan_to_merge_ratio_seq->add(merge_to_scan_ratio);\n@@ -260,2 +260,2 @@\n-  if  (for_young_only_phase || !enough_samples_available(_mixed_card_merge_to_scan_ratio_seq)) {\n-    return (size_t)(rs_length * predict_in_unit_interval(_young_card_merge_to_scan_ratio_seq));\n+  if (for_young_only_phase || !enough_samples_available(_mixed_card_scan_to_merge_ratio_seq)) {\n+    return (size_t)(rs_length * predict_in_unit_interval(_young_card_scan_to_merge_ratio_seq));\n@@ -263,1 +263,1 @@\n-    return (size_t)(rs_length * predict_in_unit_interval(_mixed_card_merge_to_scan_ratio_seq));\n+    return (size_t)(rs_length * predict_in_unit_interval(_mixed_card_scan_to_merge_ratio_seq));\n","filename":"src\/hotspot\/share\/gc\/g1\/g1Analytics.cpp","additions":10,"deletions":10,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -52,1 +52,1 @@\n-  \/\/ The ratio between the number of merged cards and actually scanned cards, for\n+  \/\/ The ratio between the number of scanned cards and actually merged cards, for\n@@ -54,2 +54,2 @@\n-  TruncatedSeq* _young_card_merge_to_scan_ratio_seq;\n-  TruncatedSeq* _mixed_card_merge_to_scan_ratio_seq;\n+  TruncatedSeq* _young_card_scan_to_merge_ratio_seq;\n+  TruncatedSeq* _mixed_card_scan_to_merge_ratio_seq;\n@@ -131,1 +131,1 @@\n-  void report_card_merge_to_scan_ratio(double cards_per_entry_ratio, bool for_young_only_phase);\n+  void report_card_scan_to_merge_ratio(double cards_per_entry_ratio, bool for_young_only_phase);\n","filename":"src\/hotspot\/share\/gc\/g1\/g1Analytics.hpp","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -103,3 +103,1 @@\n-  \/\/ Returns the number of dirtied cards that were not yet dirty. This result may\n-  \/\/ be inaccurate as it does not perform the dirtying atomically.\n-  inline size_t mark_range_dirty(size_t start_card_index, size_t num_cards);\n+  inline void mark_range_dirty(size_t start_card_index, size_t num_cards);\n","filename":"src\/hotspot\/share\/gc\/g1\/g1CardTable.hpp","additions":1,"deletions":3,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -46,1 +46,1 @@\n-inline size_t G1CardTable::mark_range_dirty(size_t start_card_index, size_t num_cards) {\n+inline void G1CardTable::mark_range_dirty(size_t start_card_index, size_t num_cards) {\n@@ -50,2 +50,0 @@\n-  size_t result = 0;\n-\n@@ -60,1 +58,0 @@\n-      result += sizeof(value);\n@@ -70,1 +67,0 @@\n-          result++;\n@@ -77,2 +73,0 @@\n-\n-  return result;\n","filename":"src\/hotspot\/share\/gc\/g1\/g1CardTable.inline.hpp","additions":1,"deletions":7,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -115,1 +115,1 @@\n-    MergeRSDirtyCards,\n+    MergeRSCards,\n@@ -122,1 +122,1 @@\n-      \"Dirty Cards\" };\n+      \"Merged Cards\" };\n","filename":"src\/hotspot\/share\/gc\/g1\/g1GCPhaseTimes.hpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -805,6 +805,8 @@\n-    size_t const total_log_buffer_cards = p->sum_thread_work_items(G1GCPhaseTimes::MergeHCC, G1GCPhaseTimes::MergeHCCDirtyCards) +\n-                                          p->sum_thread_work_items(G1GCPhaseTimes::MergeLB, G1GCPhaseTimes::MergeLBDirtyCards);\n-    \/\/ Update prediction for card merge; MergeRSDirtyCards includes the cards from the Eager Reclaim phase.\n-    size_t const total_cards_merged = p->sum_thread_work_items(G1GCPhaseTimes::MergeRS, G1GCPhaseTimes::MergeRSDirtyCards) +\n-                                      p->sum_thread_work_items(G1GCPhaseTimes::OptMergeRS, G1GCPhaseTimes::MergeRSDirtyCards) +\n-                                      total_log_buffer_cards;\n+    \/\/ Update prediction for card merge.\n+    size_t const merged_cards_from_log_buffers = p->sum_thread_work_items(G1GCPhaseTimes::MergeHCC, G1GCPhaseTimes::MergeHCCDirtyCards) +\n+                                                 p->sum_thread_work_items(G1GCPhaseTimes::MergeLB, G1GCPhaseTimes::MergeLBDirtyCards);\n+    \/\/ MergeRSCards includes the cards from the Eager Reclaim phase.\n+    size_t const merged_cards_from_rs = p->sum_thread_work_items(G1GCPhaseTimes::MergeRS, G1GCPhaseTimes::MergeRSCards) +\n+                                        p->sum_thread_work_items(G1GCPhaseTimes::OptMergeRS, G1GCPhaseTimes::MergeRSCards);\n+    size_t const total_cards_merged = merged_cards_from_rs +\n+                                      merged_cards_from_log_buffers;\n@@ -834,3 +836,1 @@\n-    \/\/ Cards from the remembered sets are all cards not duplicated by cards from\n-    \/\/ the logs.\n-    \/\/ Due to duplicates in the log buffers, the number of actually scanned cards\n+    \/\/ Due to duplicates in the log buffers, the number of scanned cards\n@@ -838,4 +838,4 @@\n-    const size_t from_rs_length_cards = (total_cards_scanned > total_log_buffer_cards) ? total_cards_scanned - total_log_buffer_cards : 0;\n-    double merge_to_scan_ratio = 0.0;\n-    if (total_cards_scanned > 0) {\n-      merge_to_scan_ratio = (double) from_rs_length_cards \/ total_cards_scanned;\n+    const size_t scanned_cards_from_rs = (total_cards_scanned > merged_cards_from_log_buffers) ? total_cards_scanned - merged_cards_from_log_buffers : 0;\n+    double scan_to_merge_ratio = 0.0;\n+    if (merged_cards_from_rs > 0) {\n+      scan_to_merge_ratio = (double)scanned_cards_from_rs \/ merged_cards_from_rs;\n@@ -843,1 +843,1 @@\n-    _analytics->report_card_merge_to_scan_ratio(merge_to_scan_ratio, is_young_only_pause);\n+    _analytics->report_card_scan_to_merge_ratio(scan_to_merge_ratio, is_young_only_pause);\n","filename":"src\/hotspot\/share\/gc\/g1\/g1Policy.cpp","additions":14,"deletions":14,"binary":false,"changes":28,"status":"modified"},{"patch":"@@ -1119,2 +1119,2 @@\n-    void inc_cards_dirty(size_t increment = 1) {\n-      _merged[G1GCPhaseTimes::MergeRSDirtyCards] += increment;\n+    void inc_remset_cards(size_t increment = 1) {\n+      _merged[G1GCPhaseTimes::MergeRSCards] += increment;\n@@ -1175,1 +1175,0 @@\n-        _stats.inc_cards_dirty();\n@@ -1178,0 +1177,1 @@\n+      _stats.inc_remset_cards();\n@@ -1198,1 +1198,1 @@\n-      assert(tag < G1GCPhaseTimes::MergeRSDirtyCards, \"invalid tag %u\", tag);\n+      assert(tag < G1GCPhaseTimes::MergeRSCards, \"invalid tag %u\", tag);\n@@ -1208,2 +1208,2 @@\n-      size_t num_dirtied = _ct->mark_range_dirty(_region_base_idx + start_card_idx, length);\n-      _stats.inc_cards_dirty(num_dirtied);\n+      _ct->mark_range_dirty(_region_base_idx + start_card_idx, length);\n+      _stats.inc_remset_cards(length);\n","filename":"src\/hotspot\/share\/gc\/g1\/g1RemSet.cpp","additions":6,"deletions":6,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -132,0 +132,1 @@\n+        new LogMessageWithLevel(\"Merged Cards\", Level.DEBUG),\n","filename":"test\/hotspot\/jtreg\/gc\/g1\/TestGCLogMessages.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"}]}