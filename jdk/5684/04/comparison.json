{"files":[{"patch":"@@ -387,1 +387,4 @@\n-    \/\/ We enforce not holding locks of rank nosafepoint or lower while waiting.\n+    \/\/ For JavaThreads, we enforce not holding locks of rank nosafepoint or lower while waiting\n+    \/\/ because the held lock has a NoSafepointVerifier so waiting on a lower ranked lock will not be\n+    \/\/ able to check for safepoints first with a TBIVM.\n+    \/\/ For all threads, we enforce not holding the tty lock or below, since this could block progress also.\n@@ -389,1 +392,3 @@\n-    if (least != NULL && (least->rank() <= nosafepoint || least->rank() <= this->rank())) {\n+    if (least != NULL && ((least->rank() <= Mutex::nosafepoint && thread->is_Java_thread()) ||\n+                           least->rank() <= Mutex::tty ||\n+                           least->rank() <= this->rank())) {\n@@ -394,1 +399,3 @@\n-              \"Should not block(wait) while holding a lock of rank nosafepoint or below.\");\n+             thread->is_Java_thread() ?\n+              \"Should not block(wait) while holding a lock of rank nosafepoint or below.\" :\n+              \"Should not block(wait) while holding a lock of rank tty or below.\");\n","filename":"src\/hotspot\/share\/runtime\/mutex.cpp","additions":10,"deletions":3,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -223,0 +223,15 @@\n+\/\/ NonJavaThreads can't wait while holding tty lock or below.\n+class VM_MutexWaitTTY : public VM_GTestExecuteAtSafepoint {\n+ public:\n+  void doit() {\n+    Monitor* monitor_rank_tty = new Monitor(Mutex::tty, \"monitor_rank_tty\", Mutex::_safepoint_check_never);\n+    Monitor* monitor_rank_event = new Monitor(Mutex::event, \"monitor_rank_event\", Mutex::_safepoint_check_never);\n+\n+    monitor_rank_tty->lock_without_safepoint_check();\n+    monitor_rank_event->lock_without_safepoint_check();\n+    monitor_rank_event->wait_without_safepoint_check(1);\n+    monitor_rank_event->unlock();\n+    monitor_rank_tty->unlock();\n+  }\n+};\n+\n@@ -225,12 +240,4 @@\n-                   \"-- possible deadlock. Should not block\\\\(wait\\\\) while holding a lock of rank nosafepoint or below.\") {\n-  JavaThread* THREAD = JavaThread::current();\n-  ThreadInVMfromNative invm(THREAD);\n-\n-  Monitor* monitor_rank_tty = new Monitor(Mutex::tty, \"monitor_rank_tty\", Mutex::_safepoint_check_never);\n-  Monitor* monitor_rank_event = new Monitor(Mutex::event, \"monitor_rank_event\", Mutex::_safepoint_check_never);\n-\n-  monitor_rank_tty->lock_without_safepoint_check();\n-  monitor_rank_event->lock_without_safepoint_check();\n-  monitor_rank_event->wait_without_safepoint_check(1);\n-  monitor_rank_event->unlock();\n-  monitor_rank_tty->unlock();\n+                   \"-- possible deadlock. Should not block\\\\(wait\\\\) while holding a lock of rank tty or below.\") {\n+  VM_MutexWaitTTY op;\n+  ThreadInVMfromNative invm(JavaThread::current());\n+  VMThread::execute(&op);\n","filename":"test\/hotspot\/gtest\/runtime\/test_mutex.cpp","additions":19,"deletions":12,"binary":false,"changes":31,"status":"modified"}]}