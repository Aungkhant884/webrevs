{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2017, 2018, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2017, 2020, Oracle and\/or its affiliates. All rights reserved.\n@@ -28,0 +28,1 @@\n+#include \"classfile\/javaClasses.inline.hpp\"\n@@ -60,1 +61,2 @@\n-  if (G1StringDedup::is_enabled()) {\n+  if (G1StringDedup::is_enabled() &&\n+      java_lang_String::is_instance_inlined(obj)) {\n","filename":"src\/hotspot\/share\/gc\/g1\/g1FullGCMarker.inline.hpp","additions":4,"deletions":2,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -26,0 +26,1 @@\n+#include \"classfile\/systemDictionary.hpp\"\n@@ -78,0 +79,3 @@\n+    _string_klass_or_null(G1StringDedup::is_enabled()\n+                          ? SystemDictionary::String_klass()\n+                          : nullptr),\n@@ -82,0 +86,4 @@\n+  \/\/ Verify klass comparison with _string_klass_or_null is sufficient\n+  \/\/ to determine whether dedup is enabled and the object is a String.\n+  assert(SystemDictionary::String_klass()->is_final(), \"precondition\");\n+\n@@ -513,1 +521,4 @@\n-    if (G1StringDedup::is_enabled()) {\n+    \/\/ StringDedup::is_enabled() and java_lang_String::is_instance_inline\n+    \/\/ test of the obj, combined into a single comparison, using the klass\n+    \/\/ already in hand and avoiding the null check in is_instance.\n+    if (klass == _string_klass_or_null) {\n","filename":"src\/hotspot\/share\/gc\/g1\/g1ParScanThreadState.cpp","additions":12,"deletions":1,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -45,0 +45,1 @@\n+class Klass;\n@@ -86,0 +87,2 @@\n+  \/\/ Used to check whether string dedup should be applied to an object.\n+  Klass* _string_klass_or_null;\n","filename":"src\/hotspot\/share\/gc\/g1\/g1ParScanThreadState.hpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2014, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2014, 2020, Oracle and\/or its affiliates. All rights reserved.\n@@ -44,12 +44,5 @@\n-  if (java_lang_String::is_instance_inlined(obj)) {\n-    bool from_young = G1CollectedHeap::heap()->heap_region_containing(obj)->is_young();\n-    if (from_young && obj->age() < StringDeduplicationAgeThreshold) {\n-      \/\/ Candidate found. String is being evacuated from young to old but has not\n-      \/\/ reached the deduplication age threshold, i.e. has not previously been a\n-      \/\/ candidate during its life in the young generation.\n-      return true;\n-    }\n-  }\n-\n-  \/\/ Not a candidate\n-  return false;\n+  bool from_young = G1CollectedHeap::heap()->heap_region_containing(obj)->is_young();\n+  \/\/ Candidate if string is being evacuated from young to old but has not\n+  \/\/ reached the deduplication age threshold, i.e. has not previously been a\n+  \/\/ candidate during its life in the young generation.\n+  return from_young && (obj->age() < StringDeduplicationAgeThreshold);\n@@ -60,0 +53,1 @@\n+  assert(java_lang_String::is_instance(java_string), \"not a String\");\n@@ -66,1 +60,1 @@\n-  if (from_young && java_lang_String::is_instance_inlined(obj)) {\n+  if (from_young) {\n@@ -86,0 +80,1 @@\n+  assert(java_lang_String::is_instance(java_string), \"not a String\");\n","filename":"src\/hotspot\/share\/gc\/g1\/g1StringDedup.cpp","additions":9,"deletions":14,"binary":false,"changes":23,"status":"modified"},{"patch":"@@ -68,2 +68,2 @@\n-  static bool is_candidate_from_mark(oop obj);\n-  static bool is_candidate_from_evacuation(bool from_young, bool to_young, oop obj);\n+  static bool is_candidate_from_mark(oop java_string);\n+  static bool is_candidate_from_evacuation(bool from_young, bool to_young, oop java_string);\n@@ -78,0 +78,1 @@\n+  \/\/ Precondition for both is that java_string is a String.\n","filename":"src\/hotspot\/share\/gc\/g1\/g1StringDedup.hpp","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"}]}