{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2000, 2017, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -224,2 +224,2 @@\n-            \/\/ The last 2 etypes are now weak ones\n-            return Arrays.copyOfRange(result, 0, result.length - 2);\n+            \/\/ The last 4 etypes are now weak ones\n+            return Arrays.copyOfRange(result, 0, result.length - 4);\n","filename":"jdk\/src\/share\/classes\/sun\/security\/krb5\/internal\/crypto\/EType.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2010, 2011, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2010, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -45,1 +45,1 @@\n-                    \"default_tgs_enctypes=des3-cbc-sha1\");\n+                    \"default_tgs_enctypes=aes128-cts\");\n","filename":"jdk\/test\/sun\/security\/krb5\/auto\/NewSalt.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2010, 2011, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2010, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -29,0 +29,1 @@\n+ * @compile -XDignore.symbol.file W83.java\n@@ -33,1 +34,0 @@\n-import java.io.File;\n@@ -50,1 +50,2 @@\n-        KDC.saveConfig(OneKDC.KRB5_CONF, kdc);\n+        KDC.saveConfig(OneKDC.KRB5_CONF, kdc,\n+                \"allow_weak_crypto = true\");\n","filename":"jdk\/test\/sun\/security\/krb5\/auto\/W83.java","additions":4,"deletions":3,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2010, 2013, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2010, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -25,1 +25,1 @@\n- * @bug 6844909 8012679\n+ * @bug 6844909 8012679 8139348\n@@ -32,1 +32,0 @@\n-import java.io.File;\n@@ -36,0 +35,2 @@\n+import java.util.Arrays;\n+import java.util.List;\n@@ -37,0 +38,1 @@\n+import sun.security.krb5.EncryptionKey;\n@@ -41,0 +43,8 @@\n+\n+    static List<Integer> weakOnes = Arrays.asList(\n+            EncryptedData.ETYPE_DES_CBC_CRC,\n+            EncryptedData.ETYPE_DES_CBC_MD5,\n+            EncryptedData.ETYPE_DES3_CBC_HMAC_SHA1_KD,\n+            EncryptedData.ETYPE_ARCFOUR_HMAC\n+    );\n+\n@@ -42,0 +52,1 @@\n+\n@@ -47,2 +58,5 @@\n-        boolean expected = args.length != 0 && args[0].equals(\"true\");\n-        int[] etypes = EType.getBuiltInDefaults();\n+        \/\/ expected number of supported weak etypes\n+        int expected = 0;\n+        if (args.length != 0 && args[0].equals(\"true\")) {\n+            expected = weakOnes.size();\n+        }\n@@ -50,7 +64,5 @@\n-        boolean found = false;\n-        for (int i=0, length = etypes.length; i<length; i++) {\n-            if (etypes[i] == EncryptedData.ETYPE_DES_CBC_CRC ||\n-                    etypes[i] == EncryptedData.ETYPE_DES_CBC_MD4 ||\n-                    etypes[i] == EncryptedData.ETYPE_DES_CBC_MD5) {\n-                found = true;\n-            }\n+        \/\/ Ensure EType.getBuiltInDefaults() has the correct etypes\n+        if (Arrays.stream(EType.getBuiltInDefaults())\n+                .filter(weakOnes::contains)\n+                .count() != expected) {\n+            throw new Exception(\"getBuiltInDefaults fails\");\n@@ -58,2 +70,8 @@\n-        if (expected != found) {\n-            throw new Exception();\n+\n+        \/\/ Ensure keys generated have the correct etypes\n+        if (Arrays.stream(EncryptionKey.acquireSecretKeys(\n+                    \"password\".toCharArray(), \"salt\"))\n+                .map(EncryptionKey::getEType)\n+                .filter(weakOnes::contains)\n+                .count() != expected) {\n+            throw new Exception(\"acquireSecretKeys fails\");\n","filename":"jdk\/test\/sun\/security\/krb5\/etype\/WeakCrypto.java","additions":32,"deletions":14,"binary":false,"changes":46,"status":"modified"},{"patch":"@@ -1,2 +0,0 @@\n-[libdefaults]\n-allow_weak_crypto = false\n","filename":"jdk\/test\/sun\/security\/krb5\/etype\/weakcrypto.conf","additions":0,"deletions":2,"binary":false,"changes":2,"status":"deleted"},{"patch":"@@ -2,1 +2,1 @@\n-# Copyright (c) 2010, 2012, Oracle and\/or its affiliates. All rights reserved.\n+# Copyright (c) 2010, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -25,1 +25,1 @@\n-# @bug 6950546\n+# @bug 6950546 8139348\n@@ -65,0 +65,4 @@\n+# This test uses a krb5.conf file (onlythree.conf) in which\n+# only 2 etypes in the default_tkt_enctypes setting are enabled\n+# by default: aes128-cts(17), aes256-cts(18).\n+\n@@ -66,1 +70,1 @@\n-$CHECK 1 16 1 23 1 17 || exit 1\n+$CHECK 1 17 1 18 || exit 1\n@@ -68,1 +72,1 @@\n-$CHECK 0 16 0 23 0 17 || exit 1\n+$CHECK 0 17 0 18 || exit 1\n@@ -70,1 +74,1 @@\n-$CHECK 0 16 0 23 0 17 1 16 1 23 1 17 || exit 1\n+$CHECK 0 17 0 18 1 17 1 18 || exit 1\n@@ -72,1 +76,1 @@\n-$CHECK 0 16 0 23 0 17 1 16 1 23 1 17 2 16 2 23 2 17 || exit 1\n+$CHECK 0 17 0 18 1 17 1 18 2 17 2 18 || exit 1\n@@ -74,1 +78,1 @@\n-$CHECK 3 16 3 23 3 17 || exit 1\n+$CHECK 3 17 3 18 || exit 1\n@@ -76,1 +80,1 @@\n-$CHECK 3 16 3 23 3 17 4 16 4 23 4 17 || exit 1\n+$CHECK 3 17 3 18 4 17 4 18 || exit 1\n@@ -78,1 +82,1 @@\n-$CHECK 3 16 3 23 3 17 4 16 4 23 4 17 5 16 5 23 5 17 || exit 1\n+$CHECK 3 17 3 18 4 17 4 18 5 17 5 18 || exit 1\n@@ -80,1 +84,1 @@\n-$CHECK 3 16 3 23 3 17 4 16 4 23 4 17 5 16 5 23 5 17 6 16 6 23 6 17 || exit 1\n+$CHECK 3 17 3 18 4 17 4 18 5 17 5 18 6 17 6 18 || exit 1\n@@ -82,3 +86,1 @@\n-$CHECK 4 16 4 23 4 17 5 16 5 23 5 17 6 16 6 23 6 17 || exit 1\n-$KTAB -d me -e 16 6\n-$CHECK 4 16 4 23 4 17 5 16 5 23 5 17 6 23 6 17 || exit 1\n+$CHECK 4 17 4 18 5 17 5 18 6 17 6 18 || exit 1\n@@ -86,3 +88,3 @@\n-$CHECK 4 16 4 23 4 17 5 16 5 23 5 17 6 23 || exit 1\n-$KTAB -d me -e 16 5\n-$CHECK 4 16 4 23 4 17 5 23 5 17 6 23 || exit 1\n+$CHECK 4 17 4 18 5 17 5 18 6 18 || exit 1\n+$KTAB -d me -e 17 5\n+$CHECK 4 17 4 18 5 18 6 18 || exit 1\n@@ -90,1 +92,1 @@\n-$CHECK 4 16 5 17 6 23 || exit 1\n+$CHECK 4 17 6 18 || exit 1\n@@ -92,1 +94,1 @@\n-$CHECK 4 16 5 17 6 23 || exit 1\n+$CHECK 4 17 6 18 || exit 1\n","filename":"jdk\/test\/sun\/security\/krb5\/tools\/ktcheck.sh","additions":20,"deletions":18,"binary":false,"changes":38,"status":"modified"},{"patch":"@@ -3,1 +3,1 @@\n-default_tkt_enctypes = des3-cbc-sha1 rc4-hmac aes128-cts\n+default_tkt_enctypes = des-cbc-crc des-cbc-md5 des3-cbc-sha1 rc4-hmac aes128-cts aes256-cts\n","filename":"jdk\/test\/sun\/security\/krb5\/tools\/onlythree.conf","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}