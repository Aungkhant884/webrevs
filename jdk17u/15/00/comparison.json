{"files":[{"patch":"@@ -303,1 +303,1 @@\n-      \/\/ barriers are applied to parts of the header.\n+      \/\/ barriers are applied to parts of the header. Also adjust the length accordingly.\n@@ -305,5 +305,8 @@\n-      assert((src_offset->get_long() == arrayOopDesc::base_offset_in_bytes(T_OBJECT) && UseCompressedClassPointers) ||\n-             (src_offset->get_long() == arrayOopDesc::length_offset_in_bytes() && !UseCompressedClassPointers),\n-             \"unexpected offset for object array clone\");\n-      src_offset = phase->longcon(arrayOopDesc::base_offset_in_bytes(T_OBJECT));\n-      dest_offset = src_offset;\n+      jlong offset = src_offset->get_long();\n+      if (offset != arrayOopDesc::base_offset_in_bytes(T_OBJECT)) {\n+        assert(!UseCompressedClassPointers, \"should only happen without compressed class pointers\");\n+        assert((arrayOopDesc::base_offset_in_bytes(T_OBJECT) - offset) == BytesPerLong, \"unexpected offset\");\n+        length = phase->transform_later(new SubLNode(length, phase->longcon(1))); \/\/ Size is in longs\n+        src_offset = phase->longcon(arrayOopDesc::base_offset_in_bytes(T_OBJECT));\n+        dest_offset = src_offset;\n+      }\n","filename":"src\/hotspot\/share\/gc\/z\/c2\/zBarrierSetC2.cpp","additions":9,"deletions":6,"binary":false,"changes":15,"status":"modified"}]}