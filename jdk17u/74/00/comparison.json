{"files":[{"patch":"@@ -37,0 +37,1 @@\n+#include \"runtime\/stackWatermarkSet.hpp\"\n@@ -85,4 +86,9 @@\n-  if (is_entry_frame())\n-    return sender_for_entry_frame(map);\n-  else\n-    return sender_for_nonentry_frame(map);\n+  frame result = zeroframe()->is_entry_frame() ?\n+                 sender_for_entry_frame(map) :\n+                 sender_for_nonentry_frame(map);\n+\n+  if (map->process_frames()) {\n+    StackWatermarkSet::on_iteration(map->thread(), result);\n+  }\n+\n+  return result;\n","filename":"src\/hotspot\/cpu\/zero\/frame_zero.cpp","additions":10,"deletions":4,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -35,0 +35,2 @@\n+\n+  constexpr static bool supports_stack_watermark_barrier() { return true; }\n","filename":"src\/hotspot\/cpu\/zero\/vm_version_zero.hpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -203,0 +203,12 @@\n+    \/\/ If we are unwinding, notify the stack watermarks machinery.\n+    \/\/ Should do this before resetting the frame anchor.\n+    if (istate->msg() == BytecodeInterpreter::return_from_method ||\n+        istate->msg() == BytecodeInterpreter::do_osr) {\n+      stack_watermark_unwind_check(thread);\n+    } else {\n+      assert(istate->msg() == BytecodeInterpreter::call_method ||\n+             istate->msg() == BytecodeInterpreter::more_monitors ||\n+             istate->msg() == BytecodeInterpreter::throwing_exception,\n+             \"Should be one of these otherwise\");\n+    }\n+\n@@ -439,0 +451,4 @@\n+  \/\/ Notify the stack watermarks machinery that we are unwinding.\n+  \/\/ Should do this before resetting the frame anchor.\n+  stack_watermark_unwind_check(thread);\n+\n@@ -872,0 +888,10 @@\n+\n+void ZeroInterpreter::stack_watermark_unwind_check(JavaThread* thread) {\n+  \/\/ If frame pointer is in the danger zone, notify the runtime that\n+  \/\/ it needs to act before continuing the unwinding.\n+  uintptr_t fp = (uintptr_t)thread->last_Java_fp();\n+  uintptr_t watermark = thread->poll_data()->get_polling_word();\n+  if (fp > watermark) {\n+    InterpreterRuntime::at_unwind(thread);\n+  }\n+}\n","filename":"src\/hotspot\/cpu\/zero\/zeroInterpreter_zero.cpp","additions":26,"deletions":0,"binary":false,"changes":26,"status":"modified"},{"patch":"@@ -42,0 +42,3 @@\n+  \/\/ Stack watermark machinery\n+  static void stack_watermark_unwind_check(JavaThread* thread);\n+\n","filename":"src\/hotspot\/cpu\/zero\/zeroInterpreter_zero.hpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -110,1 +110,1 @@\n-#define SAFEPOINT                                                                                         \\\n+#define RETURN_SAFEPOINT                                                                                  \\\n@@ -1339,7 +1339,0 @@\n-      {\n-          \/\/ Allow a safepoint before returning to frame manager.\n-          SAFEPOINT;\n-\n-          goto handle_return;\n-      }\n-\n@@ -1348,1 +1341,1 @@\n-      {\n+      CASE(_return): {\n@@ -1350,1 +1343,1 @@\n-          SAFEPOINT;\n+          RETURN_SAFEPOINT;\n@@ -1355,1 +1348,0 @@\n-\n@@ -1363,6 +1355,0 @@\n-      CASE(_return): {\n-\n-          \/\/ Allow a safepoint before returning to frame manager.\n-          SAFEPOINT;\n-          goto handle_return;\n-      }\n","filename":"src\/hotspot\/share\/interpreter\/zero\/bytecodeInterpreter.cpp","additions":3,"deletions":17,"binary":false,"changes":20,"status":"modified"}]}