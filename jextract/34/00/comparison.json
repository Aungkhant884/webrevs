{"files":[{"patch":"@@ -9,2 +9,0 @@\n-version = '1.0'\n-\n@@ -27,0 +25,5 @@\n+def jextract_version = \"18\"\n+def jmods_dir = \"$buildDir\/jmods\"\n+def jextract_jmod_file = \"$jmods_dir\/jextract.jmod\"\n+def jextract_jmod_libs_dir = \"$buildDir\/jextract_jmod_libs\"\n+def jextract_jmod_conf_dir = \"$buildDir\/jextract_jmod_conf\";\n@@ -52,1 +55,1 @@\n-task createJextractImage(type: Exec) {\n+task copyLibClang(type: Copy) {\n@@ -55,0 +58,43 @@\n+    def dir_prefix_len = \"$buildDir\".length()\n+    def libs_dir = jextract_jmod_libs_dir.substring(dir_prefix_len)\n+    def conf_dir = jextract_jmod_conf_dir.substring(dir_prefix_len)\n+\n+    into(\"$buildDir\")\n+\n+    from(\"${libclang_dir}\") {\n+        include(\"*clang.*\")\n+        include(\"libLLVM.*\")\n+        into(libs_dir)\n+    }\n+\n+    from(\"$clang_include_dir\") {\n+        include(\"*.h\")\n+        into(conf_dir + \"\/jextract\")\n+    }\n+}\n+\n+task createJextractJmod(type: Exec) {\n+    dependsOn copyLibClang\n+\n+    \/\/ if these inputs or outputs change, gradle will rerun the task\n+    inputs.file(jar.archiveFile.get())\n+    outputs.file(jextract_jmod_file)\n+\n+    doFirst {\n+        delete(jextract_jmod_file)\n+    }\n+\n+    executable = \"${jdk18_home}\/bin\/jmod\"\n+    args = [\n+          \"create\",\n+          \"--module-version=$jextract_version\",\n+          \"--class-path=\" + jar.archiveFile.get(),\n+          \"--libs=$jextract_jmod_libs_dir\",\n+          \"--conf=$jextract_jmod_conf_dir\",\n+          \"${jextract_jmod_file}\"\n+    ]\n+}\n+\n+task createJextractImage(type: Exec) {\n+    dependsOn createJextractJmod\n+\n@@ -69,1 +115,1 @@\n-         \"--module-path=$buildDir\/libs\",\n+         \"--module-path=$jmods_dir\",\n@@ -78,22 +124,0 @@\n-task copyLibClang(type: Copy) {\n-    dependsOn createJextractImage\n-\n-    into(\"$buildDir\")\n-\n-    from(\"${libclang_dir}\") {\n-        include(\"*clang.*\")\n-        include(\"libLLVM.*\")\n-        into(\"jextract\/${os_lib_dir}\")\n-    }\n-\n-    from(\"$clang_include_dir\") {\n-        include(\"*.h\")\n-        into(\"jextract\/conf\/jextract\")\n-    }\n-}\n-\n-\/\/ jextract jdk image\n-task jextractapp() {\n-    dependsOn copyLibClang\n-}\n-\n@@ -101,1 +125,1 @@\n-assemble.dependsOn(jextractapp)\n+assemble.dependsOn(createJextractImage)\n@@ -105,1 +129,1 @@\n-    dependsOn jextractapp\n+    dependsOn createJextractImage\n@@ -127,1 +151,1 @@\n-         \"--module-path=$buildDir\/libs\" + File.pathSeparator + \"$jdk18_home\/jmods\",\n+         \"--module-path=$jmods_dir\" + File.pathSeparator + \"$jdk18_home\/jmods\",\n@@ -133,17 +157,0 @@\n-task prepareTestJDK(type: Copy) {\n-    dependsOn createRuntimeImageForTest\n-\n-    into(\"$buildDir\")\n-\n-    from(\"${libclang_dir}\") {\n-        include(\"*clang.*\")\n-        include(\"libLLVM.*\")\n-        into(\"jextract-jdk-test-image\/${os_lib_dir}\")\n-    }\n-\n-    from(\"$clang_include_dir\") {\n-        include(\"*.h\")\n-        into(\"jextract-jdk-test-image\/conf\/jextract\")\n-    }\n-}\n-\n@@ -174,1 +181,1 @@\n-    dependsOn prepareTestJDK,cmakeBuild\n+    dependsOn createRuntimeImageForTest,cmakeBuild\n","filename":"build.gradle","additions":54,"deletions":47,"binary":false,"changes":101,"status":"modified"}]}