{"files":[{"patch":"@@ -2011,2 +2011,7 @@\n-  if (!cm_thread()->in_progress() || _has_aborted) {\n-    \/\/ We haven't started a concurrent cycle or we have already aborted it. No need to do anything.\n+  \/\/ We haven't started a concurrent cycle no need to do anything; we might have\n+  \/\/ aborted the marking because of shutting down. The marking might have already\n+  \/\/ completed the abort (leading to in_progress() below to return false), however\n+  \/\/ this left marking state particularly in the shared marking bitmap that must\n+  \/\/ be cleaned up.\n+  \/\/ If there are multiple full gcs during shutdown we do too much work.\n+  if (!cm_thread()->in_progress() && !_g1h->concurrent_mark_is_terminating()) {\n@@ -2016,2 +2021,2 @@\n-  \/\/ Clear all marks in the next bitmap for the next marking cycle. This will allow us to skip the next\n-  \/\/ concurrent bitmap clearing.\n+  \/\/ Clear all marks in the next bitmap for the next marking cycle. This will allow\n+  \/\/ us to skip the next concurrent bitmap clearing.\n@@ -2031,3 +2036,2 @@\n-  _first_overflow_barrier_sync.abort();\n-  _second_overflow_barrier_sync.abort();\n-  _has_aborted = true;\n+\n+  abort_marking_threads();\n@@ -2044,0 +2048,7 @@\n+void G1ConcurrentMark::abort_marking_threads() {\n+  assert(!_root_regions.scan_in_progress(), \"still doing root region scan\");\n+  _has_aborted = true;\n+  _first_overflow_barrier_sync.abort();\n+  _second_overflow_barrier_sync.abort();\n+}\n+\n","filename":"src\/hotspot\/share\/gc\/g1\/g1ConcurrentMark.cpp","additions":18,"deletions":7,"binary":false,"changes":25,"status":"modified"},{"patch":"@@ -499,0 +499,5 @@\n+  \/\/ Notifies marking threads to abort. This is a best-effort notification. Does not\n+  \/\/ guarantee or update any state after the call. Root region scan must not be\n+  \/\/ running.\n+  void abort_marking_threads();\n+\n","filename":"src\/hotspot\/share\/gc\/g1\/g1ConcurrentMark.hpp","additions":5,"deletions":0,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -162,0 +162,9 @@\n+  if (in_progress()) {\n+    \/\/ We are not allowed to abort the marking threads during root region scan.\n+    \/\/ Needs to be done separately.\n+    _cm->root_regions()->abort();\n+    _cm->root_regions()->wait_until_scan_finished();\n+\n+    _cm->abort_marking_threads();\n+  }\n+\n","filename":"src\/hotspot\/share\/gc\/g1\/g1ConcurrentMarkThread.cpp","additions":9,"deletions":0,"binary":false,"changes":9,"status":"modified"}]}