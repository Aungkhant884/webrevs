{"files":[{"patch":"@@ -30,0 +30,1 @@\n+import java.awt.geom.AffineTransform;\n@@ -481,0 +482,3 @@\n+        Point userSpaceXY = AccessibilityGraphicsEnvironment.toUserSpace(x, y);\n+        x = userSpaceXY.x;\n+        y = userSpaceXY.y;\n@@ -1596,0 +1600,2 @@\n+\n+                                r = AccessibilityGraphicsEnvironment.toDeviceSpaceAbs(r);\n@@ -2260,0 +2266,1 @@\n+                            rect = AccessibilityGraphicsEnvironment.toDeviceSpaceAbs(rect);\n@@ -7341,0 +7348,178 @@\n+\n+    \/**\n+     * A helper class to handle coordinate conversion between screen and user spaces.\n+     * See {@link sun.java2d.SunGraphicsEnvironment}\n+     *\/\n+    private static abstract class AccessibilityGraphicsEnvironment extends GraphicsEnvironment {\n+        \/**\n+         * Returns the graphics configuration which bounds contain the given point in the user's space.\n+         *\n+         * See {@link sun.java2d.SunGraphicsEnvironment#getGraphicsConfigurationAtPoint(GraphicsConfiguration, double, double)}\n+         *\n+         * @param  x the x coordinate of the given point in the user's space\n+         * @param  y the y coordinate of the given point in the user's space\n+         * @return the graphics configuration\n+         *\/\n+        public static GraphicsConfiguration getGraphicsConfigurationAtPoint(double x, double y) {\n+            GraphicsConfiguration gc = GraphicsEnvironment.getLocalGraphicsEnvironment()\n+                    .getDefaultScreenDevice().getDefaultConfiguration();\n+            return getGraphicsConfigurationAtPoint(gc, x, y);\n+        }\n+\n+        \/**\n+         * Returns the graphics configuration which bounds contain the given point in the user's space.\n+         *\n+         * See {@link sun.java2d.SunGraphicsEnvironment#getGraphicsConfigurationAtPoint(GraphicsConfiguration, double, double)}\n+         *\n+         * @param  current the default configuration which is checked in the first\n+         *         place\n+         * @param  x the x coordinate of the given point in the user's space\n+         * @param  y the y coordinate of the given point in the user's space\n+         * @return the graphics configuration\n+         *\/\n+        public static GraphicsConfiguration getGraphicsConfigurationAtPoint(\n+                GraphicsConfiguration current, double x, double y) {\n+            if (containsUserSpacePoint(current, x, y)) {\n+                return current;\n+            }\n+            GraphicsEnvironment env = getLocalGraphicsEnvironment();\n+            for (GraphicsDevice device : env.getScreenDevices()) {\n+                GraphicsConfiguration config = device.getDefaultConfiguration();\n+                if (containsUserSpacePoint(config, x, y)) {\n+                    return config;\n+                }\n+            }\n+            return current;\n+        }\n+\n+        \/**\n+         * Returns the graphics configuration which bounds contain the given point in the device space.\n+         *\n+         * @param  x the x coordinate of the given point in the device space\n+         * @param  y the y coordinate of the given point in the device space\n+         * @return the graphics configuration\n+         *\/\n+        public static GraphicsConfiguration getGraphicsConfigurationAtDevicePoint(double x, double y) {\n+            GraphicsConfiguration gc = GraphicsEnvironment.getLocalGraphicsEnvironment()\n+                    .getDefaultScreenDevice().getDefaultConfiguration();\n+            return getGraphicsConfigurationAtDevicePoint(gc, x, y);\n+        }\n+\n+        \/**\n+         * Returns the graphics configuration which bounds contain the given point in the device space.\n+         *\n+         * @param  current the default configuration which is checked in the first\n+         *         place\n+         * @param  x the x coordinate of the given point in the device space\n+         * @param  y the y coordinate of the given point in the device space\n+         * @return the graphics configuration\n+         *\/\n+        public static GraphicsConfiguration getGraphicsConfigurationAtDevicePoint(\n+                GraphicsConfiguration current, double x, double y) {\n+            if (containsDeviceSpacePoint(current, x, y)) {\n+                return current;\n+            }\n+            GraphicsEnvironment env = getLocalGraphicsEnvironment();\n+            for (GraphicsDevice device : env.getScreenDevices()) {\n+                GraphicsConfiguration config = device.getDefaultConfiguration();\n+                if (containsDeviceSpacePoint(config, x, y)) {\n+                    return config;\n+                }\n+            }\n+            return current;\n+        }\n+\n+        private static boolean containsDeviceSpacePoint(GraphicsConfiguration config, double x, double y) {\n+            Rectangle bounds = config.getBounds();\n+            bounds = toDeviceSpaceAbs(config, bounds.x, bounds.y, bounds.width, bounds.height);\n+            return bounds.contains(x, y);\n+        }\n+\n+        private static boolean containsUserSpacePoint(GraphicsConfiguration config, double x, double y) {\n+            Rectangle bounds = config.getBounds();\n+            return bounds.contains(x, y);\n+        }\n+\n+        \/**\n+         * Converts absolute coordinates from the device\n+         * space to the user's space space using appropriate device transformation.\n+         *\n+         * @param  x absolute x coordinate in the device's space\n+         * @param  y absolute y coordinate in the device's space\n+         * @return the corresponding coordinates in user's space\n+         *\/\n+        public static Point toUserSpace(int x, int y) {\n+            GraphicsConfiguration gc = getGraphicsConfigurationAtDevicePoint(x, y);\n+            return toUserSpace(gc, x, y);\n+        }\n+\n+        \/**\n+         * Converts absolute coordinates from the device\n+         * space to the user's space using passed graphics configuration.\n+         *\n+         * @param  gc the graphics configuration to be used for transformation\n+         * @param  x absolute x coordinate in the device's space\n+         * @param  y absolute y coordinate in the device's space\n+         * @return the corresponding coordinates in user's space\n+         *\/\n+        public static Point toUserSpace(GraphicsConfiguration gc, int x, int y) {\n+            AffineTransform tx = gc.getDefaultTransform();\n+            Rectangle screen = gc.getBounds();\n+            int userX = screen.x + clipRound((x - screen.x) \/ tx.getScaleX());\n+            int userY = screen.y + clipRound((y - screen.y) \/ tx.getScaleY());\n+            return new Point(userX, userY);\n+        }\n+\n+        \/**\n+         * Converts the rectangle from the user's space to the device space using\n+         * appropriate device transformation.\n+         *\n+         * See {@link sun.java2d.SunGraphicsEnvironment#toDeviceSpaceAbs(Rectangle)}\n+         *\n+         * @param  rect the rectangle in the user's space\n+         * @return the rectangle which uses device space (pixels)\n+         *\/\n+        public static Rectangle toDeviceSpaceAbs(Rectangle rect) {\n+            GraphicsConfiguration gc = getGraphicsConfigurationAtPoint(rect.x, rect.y);\n+            return toDeviceSpaceAbs(gc, rect.x, rect.y, rect.width, rect.height);\n+        }\n+\n+        \/**\n+         * Converts absolute coordinates (x, y) and the size (w, h) from the user's\n+         * space to the device space using passed graphics configuration.\n+         *\n+         * See {@link sun.java2d.SunGraphicsEnvironment#toDeviceSpaceAbs(GraphicsConfiguration, int, int, int, int)}\n+         *\n+         * @param  gc the graphics configuration to be used for transformation\n+         * @param  x absolute coordinate in the user's space\n+         * @param  y absolute coordinate in the user's space\n+         * @param  w the width in the user's space\n+         * @param  h the height in the user's space\n+         * @return the rectangle which uses device space (pixels)\n+         *\/\n+        public static Rectangle toDeviceSpaceAbs(GraphicsConfiguration gc,\n+                                                 int x, int y, int w, int h) {\n+            AffineTransform tx = gc.getDefaultTransform();\n+            Rectangle screen = gc.getBounds();\n+            return new Rectangle(\n+                    screen.x + clipRound((x - screen.x) * tx.getScaleX()),\n+                    screen.y + clipRound((y - screen.y) * tx.getScaleY()),\n+                    clipRound(w * tx.getScaleX()),\n+                    clipRound(h * tx.getScaleY())\n+            );\n+        }\n+\n+        \/**\n+         * See {@link sun.java2d.pipe.Region#clipRound}\n+         *\/\n+        private static int clipRound(final double coordinate) {\n+            final double newv = coordinate - 0.5;\n+            if (newv < Integer.MIN_VALUE) {\n+                return Integer.MIN_VALUE;\n+            }\n+            if (newv > Integer.MAX_VALUE) {\n+                return Integer.MAX_VALUE;\n+            }\n+            return (int) Math.ceil(newv);\n+        }\n+    }\n","filename":"src\/jdk.accessibility\/windows\/classes\/com\/sun\/java\/accessibility\/internal\/AccessBridge.java","additions":185,"deletions":0,"binary":false,"changes":185,"status":"modified"}]}