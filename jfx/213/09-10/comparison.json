{"files":[{"patch":"@@ -510,0 +510,45 @@\n+    private void fillOrDrawShapeMasked(Graphics g, Shape shape, Paint paint, BasicStroke stroke, boolean isFill) {\n+\n+        FilterContext filterContext = getFilterContext(g);\n+        Rectangle clipRectangle = getClipRectNoClone();\n+\n+        PrDrawable imagePrDrawable = (PrDrawable)Effect.getCompatibleImage(filterContext,\n+                g.getRenderTarget().getContentWidth(), g.getRenderTarget().getContentHeight());\n+        Graphics g1 = imagePrDrawable.createGraphics();\n+        state.apply(g1);\n+        g1.setPaint(paint);\n+        if(stroke != null) {\n+            g1.setStroke(stroke);\n+        }\n+        if (isFill) {\n+            g1.fill(shape);\n+        } else {\n+            g1.draw(shape);\n+        }\n+        RTImage maskImage = (RTImage) (state.getClipMaskImageNoClone());\n+        Image nativeMaskImage = Image.fromByteBgraPreData(maskImage.getPixelBuffer(),\n+                maskImage.getWidth(), maskImage.getHeight(), 0, maskImage.getPixelScale());\n+        Texture maskTexture = g.getResourceFactory().createTexture(PixelFormat.BYTE_BGRA_PRE,\n+                Texture.Usage.STATIC, Texture.WrapMode.CLAMP_NOT_NEEDED,\n+                nativeMaskImage.getWidth(), nativeMaskImage.getHeight());\n+        maskTexture.update(nativeMaskImage, 0, 0, nativeMaskImage.getWidth(),\n+                nativeMaskImage.getHeight());\n+        PrDrawable maskPrDrawable = (PrDrawable)Effect.getCompatibleImage(filterContext,\n+                g.getRenderTarget().getContentWidth(), g.getRenderTarget().getContentHeight());\n+        Graphics g2 = maskPrDrawable.createGraphics();\n+        g2.drawTexture(maskTexture, clipRectangle.x, clipRectangle.y, clipRectangle.x + clipRectangle.width,\n+                clipRectangle.y + clipRectangle.height, 0, 0, nativeMaskImage.getWidth(), nativeMaskImage.getHeight());\n+        maskTexture.dispose();\n+\n+        Blend blend = new Blend(Blend.Mode.SRC_IN,\n+                new PassThrough(maskPrDrawable, g.getRenderTarget().getContentWidth(), g.getRenderTarget().getContentHeight()),\n+                new PassThrough(imagePrDrawable, g.getRenderTarget().getContentWidth(), g.getRenderTarget().getContentHeight()));\n+        Affine3D tx = new Affine3D(g.getTransformNoClone());\n+        g.setTransform(BaseTransform.IDENTITY_TRANSFORM);\n+        PrEffectHelper.render(blend, g, 0, 0, null);\n+        g.setTransform(tx);\n+\n+        Effect.releaseCompatibleImage(filterContext, imagePrDrawable);\n+        Effect.releaseCompatibleImage(filterContext, maskPrDrawable);\n+    }\n+\n@@ -532,33 +577,1 @@\n-                    Rectangle clipRectangle = getClipRectNoClone();\n-                    RTTexture paintRtTexture = g.getResourceFactory().createRTTexture(\n-                            clipRectangle.width, clipRectangle.height, Texture.WrapMode.CLAMP_NOT_NEEDED);\n-                    Graphics g1 = paintRtTexture.createGraphics();\n-                    g1.setPaint(paint);\n-                    g1.fillRect(0, 0, clipRectangle.width, clipRectangle.height);\n-\n-                    RTImage maskImage = (RTImage) (state.getClipMaskImageNoClone());\n-                    Image nativeMaskImage = Image.fromByteBgraPreData(maskImage.getPixelBuffer(), maskImage.getWidth(),\n-                            maskImage.getHeight(), 0, maskImage.getPixelScale());\n-                    Texture maskTexture = g.getResourceFactory().createTexture(PixelFormat.BYTE_BGRA_PRE,\n-                            Texture.Usage.STATIC, Texture.WrapMode.CLAMP_NOT_NEEDED,\n-                            nativeMaskImage.getWidth(), nativeMaskImage.getHeight());\n-                    maskTexture.update(nativeMaskImage, 0, 0, nativeMaskImage.getWidth(),\n-                            nativeMaskImage.getHeight());\n-                    RTTexture maskRtTexture = g.getResourceFactory().createRTTexture(clipRectangle.width,\n-                            clipRectangle.height, Texture.WrapMode.CLAMP_NOT_NEEDED);\n-                    Graphics g2 = maskRtTexture.createGraphics();\n-                    g2.drawTexture(maskTexture, 0, 0, clipRectangle.width, clipRectangle.height,\n-                            0, 0, nativeMaskImage.getWidth(), nativeMaskImage.getHeight());\n-                    maskTexture.dispose();\n-                    FilterContext filterContext = getFilterContext(g);\n-                    PrDrawable imagePrDrawable = PrDrawable.create(filterContext, paintRtTexture);\n-                    PrDrawable maskPrDrawable = PrDrawable.create(filterContext, maskRtTexture);\n-                    Blend blend = new Blend(Blend.Mode.SRC_IN,\n-                            new PassThrough(maskPrDrawable, nativeMaskImage.getWidth(), nativeMaskImage.getHeight()),\n-                            new PassThrough(imagePrDrawable, clipRectangle.width, clipRectangle.height));\n-                    Affine3D tx = new Affine3D(g.getTransformNoClone());\n-                    g.setTransform(BaseTransform.IDENTITY_TRANSFORM);\n-                    PrEffectHelper.render(blend, g, clipRectangle.x, clipRectangle.y, null);\n-                    g.setTransform(tx);\n-                    paintRtTexture.dispose();\n-                    maskRtTexture.dispose();\n+                    fillOrDrawShapeMasked(g, new RoundRectangle2D(x, y, w, h, 0, 0), paint, null, true);\n@@ -573,38 +586,0 @@\n-    private void fillShapeMasked(Graphics g, Shape shape, Paint paint) {\n-        Rectangle clipRectangle = getClipRectNoClone();\n-        RTTexture paintRtTexture = g.getResourceFactory().createRTTexture(\n-                clipRectangle.width, clipRectangle.height, Texture.WrapMode.CLAMP_NOT_NEEDED);\n-        Graphics g1 = paintRtTexture.createGraphics();\n-        state.apply(g1);\n-        g1.setPaint(paint);\n-        g1.fill(shape);\n-\n-        RTImage maskImage = (RTImage) (state.getClipMaskImageNoClone());\n-        Image nativeMaskImage = Image.fromByteBgraPreData(maskImage.getPixelBuffer(), maskImage.getWidth(),\n-                maskImage.getHeight(), 0, maskImage.getPixelScale());\n-        Texture maskTexture = g.getResourceFactory().createTexture(PixelFormat.BYTE_BGRA_PRE,\n-                Texture.Usage.STATIC, Texture.WrapMode.CLAMP_NOT_NEEDED,\n-                nativeMaskImage.getWidth(), nativeMaskImage.getHeight());\n-        maskTexture.update(nativeMaskImage, 0, 0, nativeMaskImage.getWidth(),\n-                nativeMaskImage.getHeight());\n-        RTTexture maskRtTexture = g.getResourceFactory().createRTTexture(clipRectangle.width,\n-                clipRectangle.height, Texture.WrapMode.CLAMP_NOT_NEEDED);\n-        Graphics g2 = maskRtTexture.createGraphics();\n-        g2.drawTexture(maskTexture, 0, 0, clipRectangle.width, clipRectangle.height,\n-                0, 0, nativeMaskImage.getWidth(), nativeMaskImage.getHeight());\n-        maskTexture.dispose();\n-        FilterContext filterContext = getFilterContext(g);\n-        PrDrawable imagePrDrawable = PrDrawable.create(filterContext, paintRtTexture);\n-        PrDrawable maskPrDrawable = PrDrawable.create(filterContext, maskRtTexture);\n-        Blend blend = new Blend(Blend.Mode.SRC_IN,\n-                new PassThrough(maskPrDrawable, clipRectangle.width, clipRectangle.height),\n-                new PassThrough(imagePrDrawable, clipRectangle.width, clipRectangle.height));\n-\n-        Affine3D tx = new Affine3D(g.getTransformNoClone());\n-        g.setTransform(BaseTransform.IDENTITY_TRANSFORM);\n-        PrEffectHelper.render(blend, g, clipRectangle.x, clipRectangle.y, null);\n-        g.setTransform(tx);\n-        paintRtTexture.dispose();\n-        maskRtTexture.dispose();\n-    }\n-\n@@ -641,1 +616,1 @@\n-                    fillShapeMasked(g, new RoundRectangle2D(x, y, w, h, arcW, arcH), paint);\n+                    fillOrDrawShapeMasked(g, new RoundRectangle2D(x, y, w, h, arcW, arcH), paint, null, true);\n@@ -1830,2 +1805,7 @@\n-                g.setPaint(paint);\n-                g.drawRect(x, y, w, h);\n+\n+                if (state.getClipMaskImageNoClone() != null) {\n+                    fillOrDrawShapeMasked(g, new RoundRectangle2D(x, y, w, h, 0, 0), paint, stroke, false);\n+                } else {\n+                    g.setPaint(paint);\n+                    g.drawRect(x, y, w, h);\n+                }\n@@ -1856,0 +1836,1 @@\n+                        g.setStroke(stroke);\n@@ -1860,3 +1841,6 @@\n-                        g.setPaint(paint);\n-                        g.setStroke(stroke);\n-                        g.draw(p2d);\n+                        if (state.getClipMaskImageNoClone() != null) {\n+                            fillOrDrawShapeMasked(g, p2d, paint, stroke, false);\n+                        } else {\n+                            g.setPaint(paint);\n+                            g.draw(p2d);\n+                        }\n@@ -1888,1 +1872,1 @@\n-                        fillShapeMasked(g, p2d, paint);\n+                        fillOrDrawShapeMasked(g, p2d, paint, null, true);\n","filename":"modules\/javafx.web\/src\/main\/java\/com\/sun\/javafx\/webkit\/prism\/WCGraphicsPrismContext.java","additions":62,"deletions":78,"binary":false,"changes":140,"status":"modified"}]}