{"files":[{"patch":"@@ -78,8 +78,1 @@\n-        final Scene scene = anchor.getScene();\n-        if (scene != null) {\n-            doAcceleratorInstall(items, scene);\n-        }\n-        \/\/ Scene change listener is added to the anchor for scenarios like,\n-        \/\/ 1. Installing accelerators when Control is added to Scene\n-        \/\/ 2. Removing accelerators when Control is removed from Scene\n-        \/\/ Remove previously added listener if any\n+\n@@ -87,4 +80,4 @@\n-        if (listenerW != null) {\n-            ChangeListener<Scene> listener = listenerW.get();\n-            if (listener != null) {\n-                anchor.sceneProperty().removeListener(listener);\n+        if (listenerW == null || listenerW.get() == null) {\n+            final Scene scene = anchor.getScene();\n+            if (scene != null) {\n+                doAcceleratorInstall(items, scene);\n@@ -92,1 +85,4 @@\n-            sceneChangeListenerMap.remove(anchor);\n+            \/\/ Scene change listener is added to the anchor for scenarios like,\n+            \/\/ 1. Installing accelerators when Control is added to Scene\n+            \/\/ 2. Removing accelerators when Control is removed from Scene\n+            anchor.sceneProperty().addListener(getSceneChangeListener(anchor, items));\n@@ -94,2 +90,0 @@\n-        \/\/ Add a new listener\n-        anchor.sceneProperty().addListener(getSceneChangeListener(anchor, items));\n","filename":"modules\/javafx.controls\/src\/main\/java\/com\/sun\/javafx\/scene\/control\/ControlAcceleratorSupport.java","additions":9,"deletions":15,"binary":false,"changes":24,"status":"modified"},{"patch":"@@ -28,0 +28,1 @@\n+import javafx.beans.value.ChangeListener;\n@@ -30,0 +31,1 @@\n+import javafx.scene.control.MenuButton;\n@@ -34,0 +36,1 @@\n+import test.com.sun.javafx.binding.ExpressionHelperUtility;\n@@ -40,0 +43,1 @@\n+import static org.junit.Assert.assertNotEquals;\n@@ -117,0 +121,41 @@\n+\n+    @Test\n+    public void testMemoryButtonSkinDoesntAddAdditionalListeners() {\n+        \/\/ JDK-8296409\n+        MenuItem menuItem = new MenuItem(\"Menu Item\");\n+        MenuButton menuButton = new MenuButton(\"Menu Button\", null, menuItem);\n+        StackPane root = new StackPane(menuButton);\n+        StageLoader sl = new StageLoader(root);\n+        assertEquals(1, getListenerCount(menuItem.acceleratorProperty()));\n+        root.getChildren().remove(menuButton);\n+        assertEquals(0, getListenerCount(menuItem.acceleratorProperty()));\n+        root.getChildren().add(menuButton);\n+        assertEquals(1, getListenerCount(menuItem.acceleratorProperty()));\n+        sl.dispose();\n+    }\n+\n+    @Test\n+    public void testMemoryButtonSkinDoesntAddAdditionalListenersOnSceneChange() {\n+        \/\/ JDK-8296409\n+        MenuItem menuItem = new MenuItem(\"Menu Item\");\n+        MenuButton menuButton = new MenuButton(\"Menu Button\", null, menuItem);\n+        StackPane root = new StackPane(menuButton);\n+        StackPane root2 = new StackPane();\n+        StageLoader sl1 = new StageLoader(root);\n+        StageLoader sl2 = new StageLoader(root2);\n+        assertEquals(1, getListenerCount(menuItem.acceleratorProperty()));\n+        ChangeListener originalChangeListener =\n+                ExpressionHelperUtility.getChangeListeners(menuItem.acceleratorProperty()).get(0);\n+        root2.getChildren().add(menuButton);\n+        assertEquals(1, getListenerCount(menuItem.acceleratorProperty()));\n+        ChangeListener secondChangeListener =\n+                ExpressionHelperUtility.getChangeListeners(menuItem.acceleratorProperty()).get(0);\n+        assertNotEquals(originalChangeListener, secondChangeListener);\n+        root.getChildren().add(menuButton);\n+        assertEquals(1, getListenerCount(menuItem.acceleratorProperty()));\n+        ChangeListener thirdChangeListener =\n+                ExpressionHelperUtility.getChangeListeners(menuItem.acceleratorProperty()).get(0);\n+        assertNotEquals(secondChangeListener,thirdChangeListener);\n+        sl1.dispose();\n+        sl2.dispose();\n+    }\n","filename":"modules\/javafx.controls\/src\/test\/java\/test\/javafx\/scene\/control\/ControlAcceleratorSupportTest.java","additions":45,"deletions":0,"binary":false,"changes":45,"status":"modified"}]}