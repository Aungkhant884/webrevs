{"files":[{"patch":"@@ -237,0 +237,22 @@\n+\n+static bool isOEMKey(UINT wKey)\n+{\n+    switch (wKey) {\n+        case VK_OEM_1:\n+        case VK_OEM_PLUS:\n+        case VK_OEM_COMMA:\n+        case VK_OEM_MINUS:\n+        case VK_OEM_PERIOD:\n+        case VK_OEM_2:\n+        case VK_OEM_3:\n+        case VK_OEM_4:\n+        case VK_OEM_5:\n+        case VK_OEM_6:\n+        case VK_OEM_7:\n+        case VK_OEM_8:\n+        case VK_OEM_102:\n+            return true;\n+    }\n+    return false;\n+}\n+\n@@ -240,2 +262,2 @@\n-    BYTE vkey = 0xFF & ::VkKeyScanEx((TCHAR)c,\n-            ::GetKeyboardLayout(GlassApplication::GetMainThreadId()));\n+    HKL keyboardLayout = ::GetKeyboardLayout(GlassApplication::GetMainThreadId());\n+    BYTE vkey = 0xFF & ::VkKeyScanEx((TCHAR)c, keyboardLayout);\n@@ -247,1 +269,46 @@\n-    return WindowsKeyToJavaKey(vkey);\n+    \/\/ To determine the correct key code we reproduce the algorithm in\n+    \/\/ ViewContainer::HandleViewKeyEvent in simplified form. For the OEM\n+    \/\/ keys we query for the unshifted character on that key and use it\n+    \/\/ to determine the Java code. For all other keys we use the table.\n+    jint jKeyCode = com_sun_glass_events_KeyEvent_VK_UNDEFINED;\n+    if (isOEMKey(vkey)) {\n+        \/\/ Map the virtual key code to an unshifted character.\n+        UINT keyCodeChar = LOWORD(::MapVirtualKeyEx(vkey, 2, keyboardLayout));\n+        switch (keyCodeChar) {\n+            case L'!':   jKeyCode = com_sun_glass_events_KeyEvent_VK_EXCLAMATION; break;\n+            case L'\"':   jKeyCode = com_sun_glass_events_KeyEvent_VK_DOUBLE_QUOTE; break;\n+            case L'#':   jKeyCode = com_sun_glass_events_KeyEvent_VK_NUMBER_SIGN; break;\n+            case L'$':   jKeyCode = com_sun_glass_events_KeyEvent_VK_DOLLAR; break;\n+            case L'&':   jKeyCode = com_sun_glass_events_KeyEvent_VK_AMPERSAND; break;\n+            case L'\\'':  jKeyCode = com_sun_glass_events_KeyEvent_VK_QUOTE; break;\n+            case L'(':   jKeyCode = com_sun_glass_events_KeyEvent_VK_LEFT_PARENTHESIS; break;\n+            case L')':   jKeyCode = com_sun_glass_events_KeyEvent_VK_RIGHT_PARENTHESIS; break;\n+            case L'*':   jKeyCode = com_sun_glass_events_KeyEvent_VK_ASTERISK; break;\n+            case L'+':   jKeyCode = com_sun_glass_events_KeyEvent_VK_PLUS; break;\n+            case L',':   jKeyCode = com_sun_glass_events_KeyEvent_VK_COMMA; break;\n+            case L'-':   jKeyCode = com_sun_glass_events_KeyEvent_VK_MINUS; break;\n+            case L'.':   jKeyCode = com_sun_glass_events_KeyEvent_VK_PERIOD; break;\n+            case L'\/':   jKeyCode = com_sun_glass_events_KeyEvent_VK_SLASH; break;\n+            case L':':   jKeyCode = com_sun_glass_events_KeyEvent_VK_COLON; break;\n+            case L';':   jKeyCode = com_sun_glass_events_KeyEvent_VK_SEMICOLON; break;\n+            case L'<':   jKeyCode = com_sun_glass_events_KeyEvent_VK_LESS; break;\n+            case L'=':   jKeyCode = com_sun_glass_events_KeyEvent_VK_EQUALS; break;\n+            case L'>':   jKeyCode = com_sun_glass_events_KeyEvent_VK_GREATER; break;\n+            case L'@':   jKeyCode = com_sun_glass_events_KeyEvent_VK_AT; break;\n+            case L'[':   jKeyCode = com_sun_glass_events_KeyEvent_VK_OPEN_BRACKET; break;\n+            case L'\\\\':  jKeyCode = com_sun_glass_events_KeyEvent_VK_BACK_SLASH; break;\n+            case L']':   jKeyCode = com_sun_glass_events_KeyEvent_VK_CLOSE_BRACKET; break;\n+            case L'^':   jKeyCode = com_sun_glass_events_KeyEvent_VK_CIRCUMFLEX; break;\n+            case L'_':   jKeyCode = com_sun_glass_events_KeyEvent_VK_UNDERSCORE; break;\n+            case L'`':   jKeyCode = com_sun_glass_events_KeyEvent_VK_BACK_QUOTE; break;\n+            case L'{':   jKeyCode = com_sun_glass_events_KeyEvent_VK_BRACELEFT; break;\n+            case L'}':   jKeyCode = com_sun_glass_events_KeyEvent_VK_BRACERIGHT; break;\n+            case 0x00A1: jKeyCode = com_sun_glass_events_KeyEvent_VK_INV_EXCLAMATION; break;\n+            case 0x20A0: jKeyCode = com_sun_glass_events_KeyEvent_VK_EURO_SIGN; break;\n+        }\n+    }\n+    else {\n+        jKeyCode = WindowsKeyToJavaKey(vkey);\n+    }\n+\n+    return jKeyCode;\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/win\/KeyTable.cpp","additions":70,"deletions":3,"binary":false,"changes":73,"status":"modified"}]}