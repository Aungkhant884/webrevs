{"files":[{"patch":"@@ -91,1 +91,1 @@\n-            \/\/ TODO this is insufficient as we need to check entire InputMap hierarchy\n+            \/\/ TODO: JDK-8250807: this is insufficient as we need to check entire InputMap hierarchy\n@@ -119,0 +119,1 @@\n+        \/\/ TODO: JDK-8250807: Traverse the child maps of getInputMap() and remove the mapping from them.\n","filename":"modules\/javafx.controls\/src\/main\/java\/com\/sun\/javafx\/scene\/control\/behavior\/BehaviorBase.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -29,6 +29,0 @@\n-import javafx.scene.control.ComboBoxBase;\n-import javafx.scene.control.SelectionModel;\n-import com.sun.javafx.scene.control.inputmap.InputMap;\n-\n-import static javafx.scene.input.KeyCode.DOWN;\n-import static javafx.scene.input.KeyCode.UP;\n@@ -37,10 +31,0 @@\n-\n-    \/***************************************************************************\n-     *                                                                         *\n-     * Constructors                                                            *\n-     *                                                                         *\n-     **************************************************************************\/\n-\n-    \/**\n-     *\n-     *\/\n@@ -49,30 +33,0 @@\n-\n-        \/\/ Add these bindings as a child input map, so they take precedence\n-        InputMap<ComboBoxBase<T>> comboBoxListViewInputMap = new InputMap<>(comboBox);\n-        comboBoxListViewInputMap.getMappings().addAll(\n-            new InputMap.KeyMapping(UP, e -> selectPrevious()),\n-            new InputMap.KeyMapping(DOWN, e -> selectNext())\n-        );\n-        addDefaultChildMap(getInputMap(), comboBoxListViewInputMap);\n-    }\n-\n-    \/***************************************************************************\n-     *                                                                         *\n-     * Key event handling                                                      *\n-     *                                                                         *\n-     **************************************************************************\/\n-\n-    private ComboBox<T> getComboBox() {\n-        return (ComboBox<T>) getNode();\n-    }\n-\n-    private void selectPrevious() {\n-        SelectionModel<T> sm = getComboBox().getSelectionModel();\n-        if (sm == null) return;\n-        sm.selectPrevious();\n-    }\n-\n-    private void selectNext() {\n-        SelectionModel<T> sm = getComboBox().getSelectionModel();\n-        if (sm == null) return;\n-        sm.selectNext();\n","filename":"modules\/javafx.controls\/src\/main\/java\/com\/sun\/javafx\/scene\/control\/behavior\/ComboBoxListViewBehavior.java","additions":0,"deletions":46,"binary":false,"changes":46,"status":"modified"},{"patch":"@@ -49,0 +49,2 @@\n+import java.util.function.Predicate;\n+import java.util.function.Supplier;\n@@ -81,1 +83,8 @@\n-        addDefaultMapping(listViewInputMap, FocusTraversalInputMap.getFocusTraversalMappings());\n+        Supplier<Boolean> isListViewOfComboBox =\n+                (Supplier<Boolean>) control.getProperties().get(\"editableComboBoxEditor\");\n+        Predicate<KeyEvent> pIsInComboBox = e -> isListViewOfComboBox != null;\n+        Predicate<KeyEvent> pIsInEditableComboBox =\n+                e -> isListViewOfComboBox != null && isListViewOfComboBox.get();\n+        if (isListViewOfComboBox == null) {\n+            addDefaultMapping(listViewInputMap, FocusTraversalInputMap.getFocusTraversalMappings());\n+        }\n@@ -83,4 +92,4 @@\n-            new KeyMapping(HOME, e -> selectFirstRow()),\n-            new KeyMapping(END, e -> selectLastRow()),\n-            new KeyMapping(new KeyBinding(HOME).shift(), e -> selectAllToFirstRow()),\n-            new KeyMapping(new KeyBinding(END).shift(), e -> selectAllToLastRow()),\n+            new KeyMapping(new KeyBinding(HOME), e -> selectFirstRow(), pIsInEditableComboBox),\n+            new KeyMapping(new KeyBinding(END), e -> selectLastRow(), pIsInEditableComboBox),\n+            new KeyMapping(new KeyBinding(HOME).shift(), e -> selectAllToFirstRow(), pIsInComboBox),\n+            new KeyMapping(new KeyBinding(END).shift(), e -> selectAllToLastRow(), pIsInComboBox),\n@@ -101,3 +110,3 @@\n-            new KeyMapping(new KeyBinding(A).shortcut(), e -> selectAll()),\n-            new KeyMapping(new KeyBinding(HOME).shortcut(), e -> focusFirstRow()),\n-            new KeyMapping(new KeyBinding(END).shortcut(), e -> focusLastRow()),\n+            new KeyMapping(new KeyBinding(A).shortcut(), e -> selectAll(), pIsInComboBox),\n+            new KeyMapping(new KeyBinding(HOME).shortcut(), e -> focusFirstRow(), pIsInComboBox),\n+            new KeyMapping(new KeyBinding(END).shortcut(), e -> focusLastRow(), pIsInComboBox),\n@@ -148,2 +157,2 @@\n-            new KeyMapping(new KeyBinding(HOME).shortcut().shift(), e -> discontinuousSelectAllToFirstRow()),\n-            new KeyMapping(new KeyBinding(END).shortcut().shift(), e -> discontinuousSelectAllToLastRow())\n+            new KeyMapping(new KeyBinding(HOME).shortcut().shift(), e -> discontinuousSelectAllToFirstRow(), pIsInComboBox),\n+            new KeyMapping(new KeyBinding(END).shortcut().shift(), e -> discontinuousSelectAllToLastRow(), pIsInComboBox)\n@@ -151,1 +160,0 @@\n-\n@@ -201,1 +209,0 @@\n-\n","filename":"modules\/javafx.controls\/src\/main\/java\/com\/sun\/javafx\/scene\/control\/behavior\/ListViewBehavior.java","additions":19,"deletions":12,"binary":false,"changes":31,"status":"modified"},{"patch":"@@ -32,0 +32,1 @@\n+import java.util.function.Supplier;\n@@ -507,0 +508,1 @@\n+                getProperties().put(\"editableComboBoxEditor\", (Supplier<Boolean>) () -> getSkinnable().isEditable());\n","filename":"modules\/javafx.controls\/src\/main\/java\/javafx\/scene\/control\/skin\/ComboBoxListViewSkin.java","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -28,0 +28,8 @@\n+import com.sun.javafx.scene.control.behavior.FocusTraversalInputMap;\n+import com.sun.javafx.scene.control.behavior.ListViewBehavior;\n+import com.sun.javafx.scene.control.inputmap.InputMap;\n+import com.sun.javafx.scene.control.inputmap.InputMap.KeyMapping;\n+import com.sun.javafx.scene.control.inputmap.KeyBinding;\n+import com.sun.javafx.tk.Toolkit;\n+\n+import test.com.sun.javafx.scene.control.infrastructure.ControlSkinFactory;\n@@ -30,1 +38,0 @@\n-import com.sun.javafx.tk.Toolkit;\n@@ -1337,0 +1344,171 @@\n+    @Test public void testEditorKeyInputsWhenPopupIsShowing() {\n+        final ComboBox<String> cb = new ComboBox<>(FXCollections.observableArrayList(\"a\", \"b\", \"c\"));\n+        cb.setEditable(true);\n+        StageLoader sl = new StageLoader(cb);\n+        KeyEventFirer keyboard = new KeyEventFirer(cb);\n+\n+        \/\/ Show the popup\n+        assertFalse(cb.isShowing());\n+        cb.requestFocus();\n+        cb.getEditor().setText(\"ABC DEF\");\n+        assertEquals(\"ABC DEF\", cb.getEditor().getText());\n+        keyboard.doDownArrowPress(KeyModifier.ALT);\n+        \/\/ Sanity\n+        assertTrue(cb.isShowing());\n+        assertEquals(0, cb.getEditor().getCaretPosition());\n+\n+        \/\/ LEFT, RIGHT keys with CTRL, SHIFT modifiers\n+        \/\/ Test RIGHT key\n+        keyboard.doRightArrowPress();\n+        assertEquals(1, cb.getEditor().getCaretPosition());\n+\n+        \/\/ Test KP_RIGHT key\n+        keyboard.doKeyPress(KeyCode.KP_RIGHT);\n+        assertEquals(2, cb.getEditor().getCaretPosition());\n+\n+        \/\/ Test LEFT key\n+        keyboard.doLeftArrowPress();\n+        assertEquals(1, cb.getEditor().getCaretPosition());\n+\n+        \/\/ Test KP_LEFT key\n+        keyboard.doKeyPress(KeyCode.KP_LEFT);\n+        assertEquals(0, cb.getEditor().getCaretPosition());\n+\n+        \/\/ Test SHIFT + RIGHT key\n+        keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT);\n+        assertEquals(\"A\", cb.getEditor().getSelectedText());\n+        assertEquals(1, cb.getEditor().getCaretPosition());\n+\n+        \/\/ Test SHIFT + LEFT key\n+        keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT);\n+        assertEquals(\"\", cb.getEditor().getSelectedText());\n+        assertEquals(0, cb.getEditor().getCaretPosition());\n+\n+        \/\/ Test CTRL + RIGHT key\n+        keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.CTRL);\n+        assertEquals(\"\", cb.getEditor().getSelectedText());\n+        assertEquals(4, cb.getEditor().getCaretPosition());\n+\n+        \/\/ Test CTRL + LEFT key\n+        keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.CTRL);\n+        assertEquals(\"\", cb.getEditor().getSelectedText());\n+        assertEquals(0, cb.getEditor().getCaretPosition());\n+\n+        \/\/ Test CTRL + SHIFT + RIGHT key\n+        keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.CTRL, KeyModifier.SHIFT);\n+        assertEquals(\"ABC \", cb.getEditor().getSelectedText());\n+        assertEquals(4, cb.getEditor().getCaretPosition());\n+\n+        \/\/ Test CTRL + SHIFT + LEFT key\n+        keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.CTRL, KeyModifier.SHIFT);\n+        assertEquals(\"\", cb.getEditor().getSelectedText());\n+        assertEquals(0, cb.getEditor().getCaretPosition());\n+\n+        \/\/ HOME, END keys with CTRL, SHIFT modifiers\n+        \/\/ Test END key\n+        keyboard.doKeyPress(KeyCode.END);\n+        assertEquals(7, cb.getEditor().getCaretPosition());\n+\n+        \/\/ Test HOME key\n+        keyboard.doKeyPress(KeyCode.HOME);\n+        assertEquals(0, cb.getEditor().getCaretPosition());\n+\n+        \/\/ Test SHIFT + END key\n+        keyboard.doKeyPress(KeyCode.END, KeyModifier.SHIFT);\n+        assertEquals(cb.getEditor().getText(), cb.getEditor().getSelectedText());\n+        assertEquals(7, cb.getEditor().getCaretPosition());\n+\n+        \/\/ Test SHIFT + HOME key\n+        keyboard.doKeyPress(KeyCode.HOME, KeyModifier.SHIFT);\n+        assertEquals(\"\", cb.getEditor().getSelectedText());\n+        assertEquals(0, cb.getEditor().getCaretPosition());\n+\n+        \/\/ Test CTRL + END key\n+        keyboard.doKeyPress(KeyCode.END, KeyModifier.CTRL);\n+        assertEquals(\"\", cb.getEditor().getSelectedText());\n+        assertEquals(7, cb.getEditor().getCaretPosition());\n+\n+        \/\/ Test CTRL + HOME key\n+        keyboard.doKeyPress(KeyCode.HOME, KeyModifier.CTRL);\n+        assertEquals(\"\", cb.getEditor().getSelectedText());\n+        assertEquals(0, cb.getEditor().getCaretPosition());\n+\n+        \/\/ Test CTRL + SHIFT + END key\n+        keyboard.doKeyPress(KeyCode.END, KeyModifier.CTRL, KeyModifier.SHIFT);\n+        assertEquals(cb.getEditor().getText(), cb.getEditor().getSelectedText());\n+        assertEquals(7, cb.getEditor().getCaretPosition());\n+\n+        \/\/ Test CTRL + SHIFT + HOME key\n+        keyboard.doKeyPress(KeyCode.HOME, KeyModifier.CTRL, KeyModifier.SHIFT);\n+        assertEquals(\"\", cb.getEditor().getSelectedText());\n+        assertEquals(0, cb.getEditor().getCaretPosition());\n+\n+        \/\/ Test CTRL + A key\n+        keyboard.doLeftArrowPress();\n+        assertEquals(\"\", cb.getEditor().getSelectedText());\n+        keyboard.doKeyPress(KeyCode.A, KeyModifier.getShortcutKey());\n+        assertEquals(cb.getEditor().getText(), cb.getEditor().getSelectedText());\n+\n+        \/\/ Sanity\n+        assertTrue(cb.isShowing());\n+\n+        sl.dispose();\n+    }\n+\n+    @Test public void testInterceptedKeyMappingsForComboBoxEditor() {\n+        final ComboBox<String> cb = new ComboBox<>(FXCollections.observableArrayList(\"a\", \"b\", \"c\"));\n+        StageLoader sl = new StageLoader(cb);\n+\n+        ListView listView = (ListView) ((ComboBoxListViewSkin)cb.getSkin()).getPopupContent();\n+        ListViewBehavior lvBehavior = (ListViewBehavior)ControlSkinFactory.getBehavior(listView.getSkin());\n+        InputMap<ListView<?>> lvInputMap = lvBehavior.getInputMap();\n+        ObservableList<?> inputMappings = lvInputMap.getMappings();\n+        \/\/ In ListViewBehavior KeyMappings for vertical orientation are added under 3rd child InputMap\n+        InputMap<ListView<?>> verticalInputMap = lvInputMap.getChildInputMaps().get(2);\n+        ObservableList<?> verticalInputMappings = verticalInputMap.getMappings();\n+\n+        cb.setEditable(true);\n+        testKeyMappingsForEditableCB(inputMappings);\n+        testCommonKeyMappings(inputMappings, verticalInputMappings);\n+\n+        cb.setEditable(false);\n+        testKeyMappingsForNonEditableCB(inputMappings);\n+        testCommonKeyMappings(inputMappings, verticalInputMappings);\n+\n+        sl.dispose();\n+    }\n+\n+    private void testKeyMappingsForEditableCB(ObservableList<?> inputMappings) {\n+        assertTrue(testInterceptor(inputMappings, new KeyBinding(KeyCode.HOME)));\n+        assertTrue(testInterceptor(inputMappings, new KeyBinding(KeyCode.END)));\n+    }\n+\n+    private void testKeyMappingsForNonEditableCB(ObservableList<?> inputMappings) {\n+        assertFalse(testInterceptor(inputMappings, new KeyBinding(KeyCode.HOME)));\n+        assertFalse(testInterceptor(inputMappings, new KeyBinding(KeyCode.END)));\n+    }\n+\n+    private void testCommonKeyMappings(ObservableList<?> inputMappings,\n+                                       ObservableList<?> verticalInputMappings) {\n+        \/\/ Verify FocusTraversalInputMap\n+        for(InputMap.Mapping<?> mapping : FocusTraversalInputMap.getFocusTraversalMappings()) {\n+            assertFalse(inputMappings.contains(mapping));\n+        }\n+\n+        \/\/ Verify default InputMap\n+        assertTrue(testInterceptor(inputMappings, new KeyBinding(KeyCode.HOME).shift()));\n+        assertTrue(testInterceptor(inputMappings, new KeyBinding(KeyCode.END).shift()));\n+        assertTrue(testInterceptor(inputMappings, new KeyBinding(KeyCode.HOME).shortcut()));\n+        assertTrue(testInterceptor(inputMappings, new KeyBinding(KeyCode.END).shortcut()));\n+        assertTrue(testInterceptor(inputMappings, new KeyBinding(KeyCode.A).shortcut()));\n+\n+        \/\/ Verify vertical child InputMap\n+        assertTrue(testInterceptor(verticalInputMappings, new KeyBinding(KeyCode.HOME).shortcut().shift()));\n+        assertTrue(testInterceptor(verticalInputMappings, new KeyBinding(KeyCode.END).shortcut().shift()));\n+    }\n+\n+    private boolean testInterceptor(ObservableList<?> mappings, KeyBinding binding) {\n+        int i = mappings.indexOf(new KeyMapping(binding, null));\n+        return ((KeyMapping)mappings.get(i)).getInterceptor().test(null);\n+    }\n+\n","filename":"modules\/javafx.controls\/src\/test\/java\/test\/javafx\/scene\/control\/ComboBoxTest.java","additions":179,"deletions":1,"binary":false,"changes":180,"status":"modified"},{"patch":"@@ -29,0 +29,1 @@\n+import com.sun.javafx.scene.control.behavior.FocusTraversalInputMap;\n@@ -30,0 +31,4 @@\n+import com.sun.javafx.scene.control.behavior.ListViewBehavior;\n+import com.sun.javafx.scene.control.inputmap.InputMap;\n+import com.sun.javafx.scene.control.inputmap.InputMap.KeyMapping;\n+import com.sun.javafx.scene.control.inputmap.KeyBinding;\n@@ -78,0 +83,2 @@\n+\n+import test.com.sun.javafx.scene.control.infrastructure.ControlSkinFactory;\n@@ -174,0 +181,34 @@\n+    @Test public void testCtrlAWhenSwitchingSelectionModel() {\n+        ListView<String> listView = new ListView<>();\n+        listView.getItems().addAll(\"a\", \"b\", \"c\", \"d\");\n+\n+        MultipleSelectionModel<String> sm;\n+        StageLoader sl = new StageLoader(listView);\n+        KeyEventFirer keyboard = new KeyEventFirer(listView);\n+\n+        MultipleSelectionModel<String> smMultiple = ListViewShim.<String>getListViewBitSetSelectionModel(listView);\n+        smMultiple.setSelectionMode(SelectionMode.MULTIPLE);\n+        MultipleSelectionModel<String> smSingle = ListViewShim.<String>getListViewBitSetSelectionModel(listView);\n+        smSingle.setSelectionMode(SelectionMode.SINGLE);\n+\n+        listView.setSelectionModel(smMultiple);\n+        sm = listView.getSelectionModel();\n+\n+        assertEquals(0, sm.getSelectedItems().size());\n+        sm.clearAndSelect(0);\n+        assertEquals(1, sm.getSelectedItems().size());\n+        keyboard.doKeyPress(KeyCode.A, KeyModifier.getShortcutKey());\n+        assertEquals(4, sm.getSelectedItems().size());\n+\n+        listView.setSelectionModel(smSingle);\n+        sm = listView.getSelectionModel();\n+\n+        assertEquals(0, sm.getSelectedItems().size());\n+        sm.clearAndSelect(0);\n+        assertEquals(1, sm.getSelectedItems().size());\n+        keyboard.doKeyPress(KeyCode.A, KeyModifier.getShortcutKey());\n+        assertEquals(1, sm.getSelectedItems().size());\n+\n+        sl.dispose();\n+    }\n+\n@@ -1468,0 +1509,27 @@\n+    @Test public void testCtrlAWhenSwitchingSelectionMode() {\n+        ListView<String> listView = new ListView<>();\n+        listView.getItems().addAll(\"a\", \"b\", \"c\", \"d\");\n+\n+        MultipleSelectionModel<String> sm = listView.getSelectionModel();\n+        StageLoader sl = new StageLoader(listView);\n+        KeyEventFirer keyboard = new KeyEventFirer(listView);\n+\n+        assertEquals(0, sm.getSelectedItems().size());\n+        sm.clearAndSelect(0);\n+        assertEquals(1, sm.getSelectedItems().size());\n+        keyboard.doKeyPress(KeyCode.A, KeyModifier.getShortcutKey());\n+        assertEquals(1, sm.getSelectedItems().size());\n+\n+        sm.setSelectionMode(SelectionMode.MULTIPLE);\n+        assertEquals(1, sm.getSelectedItems().size());\n+        keyboard.doKeyPress(KeyCode.A, KeyModifier.getShortcutKey());\n+        assertEquals(4, sm.getSelectedItems().size());\n+\n+        sm.setSelectionMode(SelectionMode.SINGLE);\n+        assertEquals(1, sm.getSelectedItems().size());\n+        keyboard.doKeyPress(KeyCode.A, KeyModifier.getShortcutKey());\n+        assertEquals(1, sm.getSelectedItems().size());\n+\n+        sl.dispose();\n+    }\n+\n@@ -1980,0 +2048,38 @@\n+    @Test public void testInterceptedKeyMappingsForComboBoxEditor() {\n+        ListView<String> listView = new ListView<>(FXCollections\n+                .observableArrayList(\"Item1\", \"Item2\"));\n+        StageLoader sl = new StageLoader(listView);\n+\n+        ListViewBehavior lvBehavior = (ListViewBehavior) ControlSkinFactory.getBehavior(listView.getSkin());\n+        InputMap<ListView<?>> lvInputMap = lvBehavior.getInputMap();\n+        ObservableList<?> inputMappings = lvInputMap.getMappings();\n+        \/\/ In ListViewBehavior KeyMappings for vertical orientation are added under 3rd child InputMap\n+        InputMap<ListView<?>> verticalInputMap = lvInputMap.getChildInputMaps().get(2);\n+        ObservableList<?> verticalInputMappings = verticalInputMap.getMappings();\n+\n+        \/\/ Verify FocusTraversalInputMap\n+        for(InputMap.Mapping<?> mapping : FocusTraversalInputMap.getFocusTraversalMappings()) {\n+            assertTrue(inputMappings.contains(mapping));\n+        }\n+\n+        \/\/ Verify default InputMap\n+        assertFalse(testInterceptor(inputMappings, new KeyBinding(KeyCode.HOME)));\n+        assertFalse(testInterceptor(inputMappings, new KeyBinding(KeyCode.END)));\n+        assertFalse(testInterceptor(inputMappings, new KeyBinding(KeyCode.HOME).shift()));\n+        assertFalse(testInterceptor(inputMappings, new KeyBinding(KeyCode.END).shift()));\n+        assertFalse(testInterceptor(inputMappings, new KeyBinding(KeyCode.HOME).shortcut()));\n+        assertFalse(testInterceptor(inputMappings, new KeyBinding(KeyCode.END).shortcut()));\n+        assertFalse(testInterceptor(inputMappings, new KeyBinding(KeyCode.A).shortcut()));\n+\n+        \/\/ Verify vertical child InputMap\n+        assertFalse(testInterceptor(verticalInputMappings, new KeyBinding(KeyCode.HOME).shortcut().shift()));\n+        assertFalse(testInterceptor(verticalInputMappings, new KeyBinding(KeyCode.END).shortcut().shift()));\n+\n+        sl.dispose();\n+    }\n+\n+    private boolean testInterceptor(ObservableList<?> mappings, KeyBinding binding) {\n+        int i = mappings.indexOf(new KeyMapping(binding, null));\n+        return ((KeyMapping)mappings.get(i)).getInterceptor().test(null);\n+    }\n+\n","filename":"modules\/javafx.controls\/src\/test\/java\/test\/javafx\/scene\/control\/ListViewTest.java","additions":106,"deletions":0,"binary":false,"changes":106,"status":"modified"}]}