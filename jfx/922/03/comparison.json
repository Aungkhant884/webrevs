{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2012, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2012, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -28,11 +28,1 @@\n-import com.sun.javafx.css.StyleManager;\n-\n-import com.sun.javafx.scene.control.Properties;\n-import com.sun.javafx.scene.control.behavior.ComboBoxBaseBehavior;\n-import com.sun.javafx.scene.control.skin.Utils;\n-import javafx.beans.property.StringProperty;\n-import javafx.css.StyleOrigin;\n-import javafx.css.StyleableBooleanProperty;\n-import javafx.css.CssMetaData;\n-\n-import javafx.css.converter.BooleanConverter;\n+import static javafx.scene.paint.Color.*;\n@@ -43,0 +33,1 @@\n+import java.util.Map;\n@@ -44,0 +35,6 @@\n+import javafx.beans.property.BooleanProperty;\n+import javafx.beans.property.StringProperty;\n+import javafx.css.CssMetaData;\n+import javafx.css.StyleOrigin;\n+import javafx.css.Styleable;\n+import javafx.css.StyleableBooleanProperty;\n@@ -45,0 +42,1 @@\n+import javafx.css.StyleableProperty;\n@@ -46,0 +44,3 @@\n+import javafx.css.converter.BooleanConverter;\n+import javafx.css.converter.SizeConverter;\n+import javafx.css.converter.StringConverter;\n@@ -48,0 +49,1 @@\n+import javafx.scene.control.ColorPicker;\n@@ -49,0 +51,2 @@\n+import javafx.scene.control.Label;\n+import javafx.scene.control.TextField;\n@@ -51,0 +55,1 @@\n+import javafx.scene.paint.Color;\n@@ -53,2 +58,3 @@\n-import javafx.css.converter.SizeConverter;\n-import javafx.css.converter.StringConverter;\n+import com.sun.javafx.css.StyleManager;\n+import com.sun.javafx.scene.control.ListenerHelper;\n+import com.sun.javafx.scene.control.Properties;\n@@ -56,12 +62,2 @@\n-\n-import java.util.Map;\n-\n-import javafx.scene.control.ColorPicker;\n-import javafx.scene.control.TextField;\n-import javafx.beans.property.BooleanProperty;\n-import javafx.css.Styleable;\n-import javafx.css.StyleableProperty;\n-import javafx.scene.control.Label;\n-import javafx.scene.paint.Color;\n-\n-import static javafx.scene.paint.Color.*;\n+import com.sun.javafx.scene.control.behavior.ComboBoxBaseBehavior;\n+import com.sun.javafx.scene.control.skin.Utils;\n@@ -110,1 +106,0 @@\n-\/\/        control.setInputMap(behavior.getInputMap());\n@@ -113,1 +108,2 @@\n-        registerChangeListener(control.valueProperty(), e -> updateColor());\n+\n+        ListenerHelper.get(this).addChangeListener(control.valueProperty(), (ev) -> updateColor());\n","filename":"modules\/javafx.controls\/src\/main\/java\/javafx\/scene\/control\/skin\/ColorPickerSkin.java","additions":24,"deletions":28,"binary":false,"changes":52,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2010, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2010, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -28,0 +28,2 @@\n+import java.util.List;\n+\n@@ -29,2 +31,0 @@\n-import javafx.scene.control.SkinBase;\n-import com.sun.javafx.scene.control.behavior.ComboBoxBaseBehavior;\n@@ -35,0 +35,1 @@\n+import javafx.scene.control.SkinBase;\n@@ -39,1 +40,2 @@\n-import java.util.List;\n+import com.sun.javafx.scene.control.ListenerHelper;\n+import com.sun.javafx.scene.control.behavior.ComboBoxBaseBehavior;\n@@ -113,0 +115,2 @@\n+        ListenerHelper lh = ListenerHelper.get(this);\n+\n@@ -114,1 +118,1 @@\n-        getSkinnable().focusedProperty().addListener((observable, oldValue, newValue) -> {\n+        lh.addChangeListener(getSkinnable().focusedProperty(), (observable, oldValue, newValue) -> {\n@@ -122,1 +126,2 @@\n-        registerChangeListener(control.editableProperty(), e -> {\n+\n+        lh.addChangeListener(control.editableProperty(), e -> {\n@@ -126,1 +131,2 @@\n-        registerChangeListener(control.showingProperty(), e -> {\n+\n+        lh.addChangeListener(control.showingProperty(), e -> {\n@@ -133,1 +139,2 @@\n-        registerChangeListener(control.valueProperty(), e -> updateDisplayArea());\n+\n+        lh.addChangeListener(control.valueProperty(), e -> updateDisplayArea());\n","filename":"modules\/javafx.controls\/src\/main\/java\/javafx\/scene\/control\/skin\/ComboBoxBaseSkin.java","additions":15,"deletions":8,"binary":false,"changes":23,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2010, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2010, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -28,3 +28,0 @@\n-import com.sun.javafx.scene.control.behavior.ComboBoxBaseBehavior;\n-import com.sun.javafx.scene.control.behavior.ComboBoxListViewBehavior;\n-\n@@ -34,2 +31,0 @@\n-import javafx.beans.InvalidationListener;\n-import javafx.beans.WeakInvalidationListener;\n@@ -58,1 +53,2 @@\n-import javafx.scene.input.*;\n+import javafx.scene.input.KeyCode;\n+import javafx.scene.input.MouseEvent;\n@@ -62,0 +58,5 @@\n+import com.sun.javafx.scene.control.IDisconnectable;\n+import com.sun.javafx.scene.control.ListenerHelper;\n+import com.sun.javafx.scene.control.behavior.ComboBoxBaseBehavior;\n+import com.sun.javafx.scene.control.behavior.ComboBoxListViewBehavior;\n+\n@@ -103,1 +104,1 @@\n-\n+    private IDisconnectable selectedItemWatcher;\n@@ -120,2 +121,0 @@\n-    private final InvalidationListener itemsObserver;\n-\n@@ -144,1 +143,0 @@\n-\/\/        control.setInputMap(behavior.getInputMap());\n@@ -149,1 +147,3 @@\n-        itemsObserver = observable -> {\n+        ListenerHelper lh = ListenerHelper.get(this);\n+\n+        lh.addInvalidationListener(control.itemsProperty(), (x) -> {\n@@ -152,2 +152,1 @@\n-        };\n-        control.itemsProperty().addListener(new WeakInvalidationListener(itemsObserver));\n+        });\n@@ -171,1 +170,1 @@\n-        registerChangeListener(control.itemsProperty(), e -> {\n+        lh.addChangeListener(control.itemsProperty(), e -> {\n@@ -175,3 +174,3 @@\n-        registerChangeListener(control.promptTextProperty(), e -> updateDisplayNode());\n-        registerChangeListener(control.cellFactoryProperty(), e -> updateCellFactory());\n-        registerChangeListener(control.visibleRowCountProperty(), e -> {\n+        lh.addChangeListener(control.promptTextProperty(), e -> updateDisplayNode());\n+        lh.addChangeListener(control.cellFactoryProperty(), e -> updateCellFactory());\n+        lh.addChangeListener(control.visibleRowCountProperty(), e -> {\n@@ -181,2 +180,2 @@\n-        registerChangeListener(control.converterProperty(), e -> updateListViewItems());\n-        registerChangeListener(control.buttonCellProperty(), e -> {\n+        lh.addChangeListener(control.converterProperty(), e -> updateListViewItems());\n+        lh.addChangeListener(control.buttonCellProperty(), e -> {\n@@ -186,1 +185,1 @@\n-        registerChangeListener(control.valueProperty(), e -> {\n+        lh.addChangeListener(control.valueProperty(), e -> {\n@@ -190,1 +189,1 @@\n-        registerChangeListener(control.editableProperty(), e -> updateEditable());\n+        lh.addChangeListener(control.editableProperty(), e -> updateEditable());\n@@ -196,1 +195,2 @@\n-        comboBox.sceneProperty().addListener(o -> {\n+\n+        lh.addInvalidationListener(comboBox.sceneProperty(), (o) -> {\n@@ -576,6 +576,12 @@\n-        SingleSelectionModel<T> selectionModel = comboBox.getSelectionModel();\n-        if (selectionModel != null) {\n-            selectionModel.selectedItemProperty().addListener(o -> {\n-                listViewSelectionDirty = true;\n-            });\n-        }\n+        ListenerHelper lh = ListenerHelper.get(this);\n+        lh.addChangeListener(comboBox.selectionModelProperty(), true, (src, oldsm, newsm) -> {\n+            if (selectedItemWatcher != null) {\n+                selectedItemWatcher.disconnect();\n+            }\n+\n+            if (newsm != null) {\n+                selectedItemWatcher = lh.addInvalidationListener(newsm.selectedItemProperty(), (x) -> {\n+                    listViewSelectionDirty = true;\n+                });\n+            }\n+        });\n","filename":"modules\/javafx.controls\/src\/main\/java\/javafx\/scene\/control\/skin\/ComboBoxListViewSkin.java","additions":35,"deletions":29,"binary":false,"changes":64,"status":"modified"},{"patch":"@@ -30,0 +30,1 @@\n+import com.sun.javafx.scene.control.ListenerHelper;\n@@ -53,0 +54,1 @@\n+import javafx.scene.input.InputMethodEvent;\n@@ -107,0 +109,2 @@\n+    private EventHandler<? super InputMethodEvent> inputMethodTextChangedHandler;\n+\n@@ -136,0 +140,2 @@\n+        ListenerHelper lh = ListenerHelper.get(this);\n+\n@@ -137,1 +143,1 @@\n-        comboBoxBase.focusedProperty().addListener((ov, t, hasFocus) -> {\n+        lh.addChangeListener(comboBoxBase.focusedProperty(), (ov, t, hasFocus) -> {\n@@ -144,1 +150,1 @@\n-        comboBoxBase.addEventFilter(KeyEvent.ANY, ke -> {\n+        lh.addEventFilter(comboBoxBase, KeyEvent.ANY, (ke) -> {\n@@ -172,0 +178,1 @@\n+    }\n@@ -173,0 +180,2 @@\n+    @Override\n+    public void install() {\n@@ -175,1 +184,1 @@\n-            comboBoxBase.setOnInputMethodTextChanged(event -> {\n+            inputMethodTextChangedHandler = event -> {\n@@ -181,1 +190,2 @@\n-            });\n+            };\n+            comboBoxBase.setOnInputMethodTextChanged(inputMethodTextChangedHandler);\n@@ -204,0 +214,12 @@\n+    @Override\n+    public void dispose() {\n+        removeTextFieldEventFilters();\n+\n+        if (inputMethodTextChangedHandler != null) {\n+            if (comboBoxBase.getOnInputMethodTextChanged() == inputMethodTextChangedHandler) {\n+                comboBoxBase.setOnInputMethodTextChanged(null);\n+            }\n+        }\n+\n+        super.dispose();\n+    }\n@@ -347,0 +369,9 @@\n+    private void removeTextFieldEventFilters() {\n+        if (textField != null) {\n+            textField.removeEventFilter(MouseEvent.DRAG_DETECTED, textFieldMouseEventHandler);\n+            textField.removeEventFilter(DragEvent.ANY, textFieldDragEventHandler);\n+\n+            comboBoxBase.setInputMethodRequests(null);\n+        }\n+    }\n+\n@@ -352,6 +383,1 @@\n-            if (textField != null) {\n-                textField.removeEventFilter(MouseEvent.DRAG_DETECTED, textFieldMouseEventHandler);\n-                textField.removeEventFilter(DragEvent.ANY, textFieldDragEventHandler);\n-\n-                comboBoxBase.setInputMethodRequests(null);\n-            }\n+            removeTextFieldEventFilters();\n@@ -477,1 +503,3 @@\n-        popup.addEventHandler(MouseEvent.MOUSE_CLICKED, t -> {\n+\n+        ListenerHelper lh = ListenerHelper.get(this);\n+        lh.addEventHandler(popup, MouseEvent.MOUSE_CLICKED, t -> {\n@@ -484,1 +512,1 @@\n-        popup.addEventHandler(WindowEvent.WINDOW_HIDDEN, t -> {\n+        lh.addEventHandler(popup, WindowEvent.WINDOW_HIDDEN, t -> {\n@@ -491,8 +519,9 @@\n-        InvalidationListener layoutPosListener = o -> {\n-            popupNeedsReconfiguring = true;\n-            reconfigurePopup();\n-        };\n-        getSkinnable().layoutXProperty().addListener(layoutPosListener);\n-        getSkinnable().layoutYProperty().addListener(layoutPosListener);\n-        getSkinnable().widthProperty().addListener(layoutPosListener);\n-        getSkinnable().heightProperty().addListener(layoutPosListener);\n+        lh.addInvalidationListener(() -> {\n+                popupNeedsReconfiguring = true;\n+                reconfigurePopup();\n+            },\n+            getSkinnable().layoutXProperty(),\n+            getSkinnable().layoutYProperty(),\n+            getSkinnable().widthProperty(),\n+            getSkinnable().heightProperty()\n+        );\n@@ -501,2 +530,3 @@\n-        getSkinnable().sceneProperty().addListener(o -> {\n-            if (((ObservableValue)o).getValue() == null) {\n+        \/\/ FIX npe\n+        lh.addInvalidationListener(getSkinnable().sceneProperty(), (obs) -> {\n+            if (((ObservableValue)obs).getValue() == null) {\n@@ -508,1 +538,0 @@\n-\n","filename":"modules\/javafx.controls\/src\/main\/java\/javafx\/scene\/control\/skin\/ComboBoxPopupControl.java","additions":52,"deletions":23,"binary":false,"changes":75,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2013, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2013, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -32,3 +32,0 @@\n-import com.sun.javafx.scene.control.DatePickerContent;\n-import com.sun.javafx.scene.control.DatePickerHijrahContent;\n-import com.sun.javafx.scene.control.behavior.ComboBoxBaseBehavior;\n@@ -45,0 +42,4 @@\n+import com.sun.javafx.scene.control.DatePickerContent;\n+import com.sun.javafx.scene.control.DatePickerHijrahContent;\n+import com.sun.javafx.scene.control.ListenerHelper;\n+import com.sun.javafx.scene.control.behavior.ComboBoxBaseBehavior;\n@@ -89,1 +90,2 @@\n-\/\/        control.setInputMap(behavior.getInputMap());\n+\n+        ListenerHelper lh = ListenerHelper.get(this);\n@@ -93,1 +95,1 @@\n-        arrow.paddingProperty().addListener(new InvalidationListener() {\n+        lh.addInvalidationListener(arrow.paddingProperty(), new InvalidationListener() {\n@@ -96,0 +98,1 @@\n+\n@@ -110,1 +113,1 @@\n-        registerChangeListener(control.chronologyProperty(), e -> {\n+        lh.addChangeListener(control.chronologyProperty(), e -> {\n@@ -115,2 +118,2 @@\n-        registerChangeListener(control.converterProperty(), e -> updateDisplayNode());\n-        registerChangeListener(control.dayCellFactoryProperty(), e -> {\n+        lh.addChangeListener(control.converterProperty(), e -> updateDisplayNode());\n+        lh.addChangeListener(control.dayCellFactoryProperty(), e -> {\n@@ -121,1 +124,1 @@\n-        registerChangeListener(control.showWeekNumbersProperty(), e -> {\n+        lh.addChangeListener(control.showWeekNumbersProperty(), e -> {\n@@ -127,1 +130,1 @@\n-        registerChangeListener(control.valueProperty(), e -> {\n+        lh.addChangeListener(control.valueProperty(), e -> {\n@@ -136,1 +139,1 @@\n-        registerChangeListener(control.showingProperty(), e -> {\n+        lh.addChangeListener(control.showingProperty(), e -> {\n","filename":"modules\/javafx.controls\/src\/main\/java\/javafx\/scene\/control\/skin\/DatePickerSkin.java","additions":15,"deletions":12,"binary":false,"changes":27,"status":"modified"},{"patch":"@@ -164,0 +164,1 @@\n+                \/\/\n@@ -165,3 +166,2 @@\n-                ColorPicker.class,\n-                ComboBox.class,\n-                DatePicker.class,\n+\n+                \/\/\n@@ -169,0 +169,2 @@\n+\n+                \/\/\n@@ -170,0 +172,2 @@\n+\n+                \/\/\n@@ -171,0 +175,2 @@\n+\n+                \/\/\n@@ -172,0 +178,2 @@\n+\n+                \/\/\n@@ -173,0 +181,2 @@\n+\n+                \/\/\n","filename":"modules\/javafx.controls\/src\/test\/java\/test\/javafx\/scene\/control\/skin\/SkinMemoryLeakTest.java","additions":13,"deletions":3,"binary":false,"changes":16,"status":"modified"}]}