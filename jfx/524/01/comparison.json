{"files":[{"patch":"@@ -354,0 +354,2 @@\n+    \/\/ treeItem at time of startEdit - fix for JDK-8267094\n+    private TreeItem<T> treeItemAtStartEdit;\n@@ -387,0 +389,1 @@\n+        treeItemAtStartEdit = getTreeItem();\n@@ -427,0 +430,1 @@\n+        treeItemAtStartEdit = null;\n@@ -438,0 +442,3 @@\n+            TreeItem<T> editingItem = treeItemAtStartEdit;\n+            T value = editingItem != null ? editingItem.getValue() : null;\n+\n@@ -449,2 +456,2 @@\n-                    getTreeItem(),\n-                    getItem(),\n+                    editingItem,\n+                    value,\n@@ -453,0 +460,1 @@\n+        treeItemAtStartEdit = null;\n","filename":"modules\/javafx.controls\/src\/main\/java\/javafx\/scene\/control\/TreeCell.java","additions":10,"deletions":2,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -34,1 +34,0 @@\n-import org.junit.Ignore;\n@@ -88,15 +87,0 @@\n-    }\n-\n-    \/**\n-     * Extracted from testCancelOffEditingIndex to formally ignore\n-     * FIXME: move the assert to the other method, once the issue is solved\n-     *\/\n-    @Ignore(\"JDK-8267094\")\n-    @Test\n-    public void testCancelOffEditingIndexEventIndex() {\n-        cell.updateIndex(editingIndex);\n-        TreeItem<String> editingItem = tree.getTreeItem(editingIndex);\n-        tree.edit(editingItem);\n-        List<EditEvent<String>> events = new ArrayList<>();\n-        tree.setOnEditCancel(events::add);\n-        cell.updateIndex(cellIndex);\n","filename":"modules\/javafx.controls\/src\/test\/java\/test\/javafx\/scene\/control\/TreeCellEditingTest.java","additions":0,"deletions":16,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -28,0 +28,16 @@\n+import java.lang.ref.WeakReference;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Ignore;\n+import org.junit.Test;\n+\n+import com.sun.javafx.tk.Toolkit;\n+\n+import static javafx.scene.control.ControlShim.*;\n+import static org.junit.Assert.*;\n+import static test.com.sun.javafx.scene.control.infrastructure.ControlSkinFactory.*;\n+import static test.com.sun.javafx.scene.control.infrastructure.ControlTestUtils.*;\n+\n@@ -37,0 +53,1 @@\n+import javafx.scene.control.TreeView.EditEvent;\n@@ -38,7 +55,2 @@\n-import org.junit.Before;\n-import org.junit.Ignore;\n-import org.junit.Test;\n-\n-import static javafx.scene.control.ControlShim.*;\n-import static test.com.sun.javafx.scene.control.infrastructure.ControlTestUtils.*;\n-import static org.junit.Assert.*;\n+import test.com.sun.javafx.scene.control.infrastructure.StageLoader;\n+import test.com.sun.javafx.scene.control.infrastructure.VirtualFlowTestUtils;\n@@ -59,0 +71,1 @@\n+    private StageLoader stageLoader;\n@@ -73,0 +86,5 @@\n+    @After\n+    public void cleanup() {\n+        if (stageLoader != null) stageLoader.dispose();\n+    }\n+\n@@ -689,0 +707,140 @@\n+    @Test\n+    public void testEditCancelEventAfterCancelOnCell() {\n+        tree.setEditable(true);\n+        cell.updateTreeView(tree);\n+        int editingIndex = 1;\n+        TreeItem<String> editingItem = tree.getTreeItem(editingIndex);\n+        cell.updateIndex(editingIndex);\n+        tree.edit(editingItem);\n+        List<EditEvent<String>> events = new ArrayList<>();\n+        tree.setOnEditCancel(events::add);\n+        cell.cancelEdit();\n+        assertEquals(1, events.size());\n+        assertEquals(\"editing location of cancel event\", editingItem, events.get(0).getTreeItem());\n+    }\n+\n+    @Test\n+    public void testEditCancelEventAfterCancelOnTree() {\n+        tree.setEditable(true);\n+        cell.updateTreeView(tree);\n+        int editingIndex = 1;\n+        TreeItem<String> editingItem = tree.getTreeItem(editingIndex);\n+        cell.updateIndex(editingIndex);\n+        tree.edit(editingItem);\n+        List<EditEvent<String>> events = new ArrayList<>();\n+        tree.setOnEditCancel(events::add);\n+        tree.edit(null);\n+        assertEquals(1, events.size());\n+        assertEquals(\"editing location of cancel event\", editingItem, events.get(0).getTreeItem());\n+    }\n+\n+    @Test\n+    public void testEditCancelEventAfterCellReuse() {\n+        tree.setEditable(true);\n+        cell.updateTreeView(tree);\n+        int editingIndex = 1;\n+        TreeItem<String> editingItem = tree.getTreeItem(editingIndex);\n+        cell.updateIndex(editingIndex);\n+        tree.edit(editingItem);\n+        List<EditEvent<String>> events = new ArrayList<>();\n+        tree.setOnEditCancel(events::add);\n+        cell.updateIndex(0);\n+        assertEquals(1, events.size());\n+        assertEquals(\"editing location of cancel event\", editingItem, events.get(0).getTreeItem());\n+    }\n+\n+    @Test\n+    public void testEditCancelEventAfterCollapse() {\n+        stageLoader = new StageLoader(tree);\n+        tree.setEditable(true);\n+        int editingIndex = 1;\n+        TreeItem<String> editingItem = tree.getTreeItem(editingIndex);\n+        tree.edit(editingItem);\n+        List<EditEvent<String>> events = new ArrayList<>();\n+        tree.setOnEditCancel(events::add);\n+        root.setExpanded(false);\n+        Toolkit.getToolkit().firePulse();\n+        assertEquals(1, events.size());\n+        assertEquals(\"editing location of cancel event\", editingItem, events.get(0).getTreeItem());\n+    }\n+\n+    @Test\n+    public void testEditCancelEventAfterModifyItems() {\n+        stageLoader = new StageLoader(tree);\n+        tree.setEditable(true);\n+        int editingIndex = 2;\n+        TreeItem<String> editingItem = tree.getTreeItem(editingIndex);\n+        tree.edit(editingItem);\n+        List<EditEvent<String>> events = new ArrayList<>();\n+        tree.setOnEditCancel(events::add);\n+        root.getChildren().add(0, new TreeItem<>(\"added\"));\n+        Toolkit.getToolkit().firePulse();\n+        assertEquals(1, events.size());\n+        assertEquals(\"editing location of cancel event\", editingItem, events.get(0).getTreeItem());\n+    }\n+\n+    \/**\n+     * Test that removing the editing item implicitly cancels an ongoing\n+     * edit and fires a correct cancel event.\n+     *\/\n+    @Test\n+    public void testEditCancelEventAfterRemoveEditingItem() {\n+        stageLoader = new StageLoader(tree);\n+        tree.setEditable(true);\n+        int editingIndex = 2;\n+        TreeItem<String> editingItem = tree.getTreeItem(editingIndex);\n+        tree.edit(editingItem);\n+        List<EditEvent<String>> events = new ArrayList<>();\n+        tree.setOnEditCancel(events::add);\n+        root.getChildren().remove(editingItem);\n+        Toolkit.getToolkit().firePulse();\n+        assertNull(\"removing item must cancel edit on tree\", tree.getEditingItem());\n+        assertEquals(1, events.size());\n+        assertEquals(\"editing location of cancel event\", editingItem, events.get(0).getTreeItem());\n+    }\n+\n+    \/**\n+     * Test that removing the editing item does not cause a memory leak.\n+     *\/\n+    @Test\n+    public void testEditCancelMemoryLeakAfterRemoveEditingItem() {\n+        stageLoader = new StageLoader(tree);\n+        tree.setEditable(true);\n+        \/\/ the item to test for being gc'ed\n+        TreeItem<String> editingItem = new TreeItem<>(\"added\");\n+        WeakReference<TreeItem<?>> itemRef = new WeakReference<>(editingItem);\n+        root.getChildren().add(0, editingItem);\n+        Toolkit.getToolkit().firePulse();\n+        tree.edit(editingItem);\n+        root.getChildren().remove(editingItem);\n+        Toolkit.getToolkit().firePulse();\n+        assertNull(\"removing item must cancel edit on tree\", tree.getEditingItem());\n+        editingItem = null;\n+        attemptGC(itemRef);\n+        assertEquals(\"treeItem must be gc'ed\", null, itemRef.get());\n+    }\n+\n+    \/**\n+     * Test that removing a committed editing item does not cause a memory leak.\n+     *\/\n+    @Test\n+    public void testEditCommitMemoryLeakAfterRemoveEditingItem() {\n+        stageLoader = new StageLoader(tree);\n+        tree.setEditable(true);\n+        \/\/ the item to test for being gc'ed\n+        TreeItem<String> editingItem = new TreeItem<>(\"added\");\n+        WeakReference<TreeItem<?>> itemRef = new WeakReference<>(editingItem);\n+        root.getChildren().add(0, editingItem);\n+        int editingIndex = tree.getRow(editingItem);\n+        Toolkit.getToolkit().firePulse();\n+        tree.edit(editingItem);\n+        TreeCell<String> editingCell = (TreeCell<String>) VirtualFlowTestUtils.getCell(tree, editingIndex);\n+        editingCell.commitEdit(\"added changed\");\n+        root.getChildren().remove(editingItem);\n+        Toolkit.getToolkit().firePulse();\n+        assertNull(\"removing item must cancel edit on tree\", tree.getEditingItem());\n+        editingItem = null;\n+        attemptGC(itemRef);\n+        assertEquals(\"treeItem must be gc'ed\", null, itemRef.get());\n+    }\n+\n","filename":"modules\/javafx.controls\/src\/test\/java\/test\/javafx\/scene\/control\/TreeCellTest.java","additions":165,"deletions":7,"binary":false,"changes":172,"status":"modified"}]}