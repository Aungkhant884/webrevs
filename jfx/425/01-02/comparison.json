{"files":[{"patch":"@@ -249,2 +249,1 @@\n-static UniCharCount queryKeyboard(TISInputSourceRef keyboard, unsigned short keyCode,\n-                                  BOOL shifted, BOOL forAccelerator,\n+static UniCharCount queryKeyboard(TISInputSourceRef keyboard, unsigned short keyCode, UInt32 modifiers,\n@@ -259,13 +258,0 @@\n-    UInt32 modifierMask = 0;\n-    if (shifted)\n-        modifierMask |= (1 << (shiftKeyBit - 8));\n-\n-    \/\/ Java key codes are used in accelerator processing so we will try to match them\n-    \/\/ the same way Apple handles key equivalents e.g. by asking for the Cmd character.\n-    \/\/ This is necessary on non-ASCII layouts such as Cyrillic or Arabic to ensure the\n-    \/\/ translation produces an ASCII key. Exactly how this is done is specific to the\n-    \/\/ keyboard but for non-ASCII keyboards it generally generates some variant of\n-    \/\/ QWERTY.\n-    if (forAccelerator)\n-        modifierMask |= (1 << (cmdKeyBit - 8));\n-\n@@ -276,1 +262,1 @@\n-                                     modifierMask,\n+                                     modifiers >> 8,\n@@ -284,0 +270,5 @@\n+    \/\/ The Unicode Hex layout can yield a string of length 1 consisting of a\n+    \/\/ code point of 0.\n+    if (actualLength == 1 && buffer[0] == 0)\n+        actualLength = 0;\n+    \n@@ -296,1 +287,12 @@\n-\/\/ This is only valid for keys in the area that is sensitive to layout changes.\n+\/\/ This is only valid for keys in the layout-sensitive area.\n+static jint getJavaCodeForMacKeyAndModifiers(TISInputSourceRef keyboard, unsigned short keyCode, UInt32 modifiers)\n+{\n+    jint result = com_sun_glass_events_KeyEvent_VK_UNDEFINED;\n+    UniChar unicode[8];\n+    UniCharCount length = queryKeyboard(keyboard, keyCode, modifiers, unicode, 8);\n+    if (length == 1)\n+        result = getJavaCodeForASCII(unicode[0]);\n+    return result;\n+}\n+\n+\/\/ This is only valid for keys in the layout-sensitive area.\n@@ -304,4 +306,6 @@\n-    UniChar unicode[8];\n-    UniCharCount length = queryKeyboard(keyboard, keyCode, NO, YES, unicode, 8);\n-    if (length == 1)\n-        result = getJavaCodeForASCII(unicode[0]);\n+    \/\/ Java key codes are used in accelerator processing so we will try to match them\n+    \/\/ the same way Apple handles key equivalents e.g. by asking for the Cmd character.\n+    \/\/ This is necessary on non-ASCII layouts such as Cyrillic or Arabic to ensure the\n+    \/\/ translation produces an ASCII key. Exactly how this is done is specific to the\n+    \/\/ keyboard but for non-ASCII keyboards it generally generates some variant of\n+    \/\/ QWERTY.\n@@ -309,2 +313,5 @@\n-    \/\/ If we didn't get a hit try looking at the shifted variant. Even if we did get a\n-    \/\/ hit we favor digits and letters over punctuation. This brings the French\n+    \/\/ First just Cmd.\n+    result = getJavaCodeForMacKeyAndModifiers(keyboard, keyCode, cmdKey);\n+\n+    \/\/ If we didn't get a hit try looking at the Shifted variant. Even if we did get a\n+    \/\/ hit we favor numerals and letters over punctuation. This brings the French\n@@ -312,1 +319,1 @@\n-    \/\/ the canonical keycodes.\n+    \/\/ the canonical key codes.\n@@ -315,2 +322,10 @@\n-        length = queryKeyboard(keyboard, keyCode, YES, YES, unicode, 8);\n-        if (length == 1)\n+        jint trial = getJavaCodeForMacKeyAndModifiers(keyboard, keyCode, cmdKey | shiftKey);\n+        if (isLetterOrDigit(trial))\n+            result = trial;\n+        else if (result == com_sun_glass_events_KeyEvent_VK_UNDEFINED)\n+            result = trial;\n+\n+        \/\/ A handful of keyboards (Azeri, Turkmen, and Sami variants) can only access\n+        \/\/ critical letters like Q by using the Option key in conjunction with Cmd.\n+        \/\/ In this API the Cmd flag suppresses the Option flag so we ommit Cmd.\n+        if (!isLetterOrDigit(result))\n@@ -318,4 +333,4 @@\n-            jint trial = getJavaCodeForASCII(unicode[0]);\n-            if (result == com_sun_glass_events_KeyEvent_VK_UNDEFINED)\n-                result = trial; \/\/ Something is better than nothing\n-            else if (isLetterOrDigit(trial))\n+            jint trial = getJavaCodeForMacKeyAndModifiers(keyboard, keyCode, optionKey);\n+            if (isLetterOrDigit(trial))\n+                result = trial;\n+            else if (result == com_sun_glass_events_KeyEvent_VK_UNDEFINED)\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/mac\/GlassKey.m","additions":45,"deletions":30,"binary":false,"changes":75,"status":"modified"}]}