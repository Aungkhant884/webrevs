{"files":[{"patch":"@@ -150,0 +150,1 @@\n+        \"-framework\", \"Carbon\",\n","filename":"buildSrc\/mac.gradle","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -34,0 +34,2 @@\n+#import <Carbon\/Carbon.h>\n+\n@@ -181,0 +183,162 @@\n+static BOOL macKeyCodeIsLayoutSensitive(unsigned int keyCode)\n+{\n+    \/\/ Mac key codes that generate different characters based on the keyboard layout\n+    \/\/ lie in two ranges with a few exceptions.\n+    switch (keyCode)\n+    {\n+        case 0x24: \/\/ Enter\n+        case 0x30: \/\/ Tab\n+        case 0x31: \/\/ Space\n+            return NO;\n+    }\n+\n+    if (keyCode >= 0x00 && keyCode <= 0x32)\n+        return YES;\n+\n+    if (keyCode >= 0x5D && keyCode <= 0x5F)\n+        return YES;\n+\n+    return NO;\n+}\n+\n+static jint getJavaCodeForASCII(UniChar ascii)\n+{\n+    if (ascii >= L'0' && ascii <= L'9')\n+        return ascii;\n+    if (ascii >= L'a' && ascii <= L'z')\n+        return ascii + (L'A' - L'a');\n+    if (ascii >= L'A' && ascii <= L'Z')\n+        return ascii;\n+\n+    switch (ascii)\n+    {\n+        case L' ': return com_sun_glass_events_KeyEvent_VK_SPACE;\n+        case L'!': return com_sun_glass_events_KeyEvent_VK_EXCLAMATION;\n+        case L'\"': return com_sun_glass_events_KeyEvent_VK_DOUBLE_QUOTE;\n+        case L'#': return com_sun_glass_events_KeyEvent_VK_NUMBER_SIGN;\n+        case L'$': return com_sun_glass_events_KeyEvent_VK_DOLLAR;\n+        case L'&': return com_sun_glass_events_KeyEvent_VK_AMPERSAND;\n+        case L'\\'':return com_sun_glass_events_KeyEvent_VK_QUOTE;\n+        case L'(': return com_sun_glass_events_KeyEvent_VK_LEFT_PARENTHESIS;\n+        case L')': return com_sun_glass_events_KeyEvent_VK_RIGHT_PARENTHESIS;\n+        case L'*': return com_sun_glass_events_KeyEvent_VK_ASTERISK;\n+        case L'+': return com_sun_glass_events_KeyEvent_VK_PLUS;\n+        case L',': return com_sun_glass_events_KeyEvent_VK_COMMA;\n+        case L'-': return com_sun_glass_events_KeyEvent_VK_MINUS;\n+        case L'.': return com_sun_glass_events_KeyEvent_VK_PERIOD;\n+        case L'\/': return com_sun_glass_events_KeyEvent_VK_SLASH;\n+        case L':': return com_sun_glass_events_KeyEvent_VK_COLON;\n+        case L';': return com_sun_glass_events_KeyEvent_VK_SEMICOLON;\n+        case L'<': return com_sun_glass_events_KeyEvent_VK_LESS;\n+        case L'=': return com_sun_glass_events_KeyEvent_VK_EQUALS;\n+        case L'>': return com_sun_glass_events_KeyEvent_VK_GREATER;\n+        case L'@': return com_sun_glass_events_KeyEvent_VK_AT;\n+        case L'[': return com_sun_glass_events_KeyEvent_VK_OPEN_BRACKET;\n+        case L'\\\\':return com_sun_glass_events_KeyEvent_VK_BACK_SLASH;\n+        case L']': return com_sun_glass_events_KeyEvent_VK_CLOSE_BRACKET;\n+        case L'^': return com_sun_glass_events_KeyEvent_VK_CIRCUMFLEX;\n+        case L'_': return com_sun_glass_events_KeyEvent_VK_UNDERSCORE;\n+        case L'`': return com_sun_glass_events_KeyEvent_VK_BACK_QUOTE;\n+        case L'{': return com_sun_glass_events_KeyEvent_VK_BRACELEFT;\n+        case L'}': return com_sun_glass_events_KeyEvent_VK_BRACERIGHT;\n+    }\n+\n+    return com_sun_glass_events_KeyEvent_VK_UNDEFINED;\n+};\n+\n+static UniCharCount queryKeyboard(TISInputSourceRef keyboard, unsigned short keyCode, UInt32 modifiers,\n+                                  UniChar* buffer, UniCharCount bufferSize)\n+{\n+    CFDataRef uchr = (CFDataRef)TISGetInputSourceProperty(keyboard,\n+                                                          kTISPropertyUnicodeKeyLayoutData);\n+    if (uchr == NULL)\n+        return 0;\n+    const UCKeyboardLayout *layout = (const UCKeyboardLayout*)CFDataGetBytePtr(uchr);\n+\n+    UInt32 deadKeyState = 0;\n+    UniCharCount actualLength = 0;\n+    OSStatus status = UCKeyTranslate(layout,\n+                                     keyCode, kUCKeyActionDown,\n+                                     modifiers >> 8,\n+                                     LMGetKbdType(),\n+                                     kUCKeyTranslateNoDeadKeysMask, &deadKeyState,\n+                                     bufferSize, &actualLength,\n+                                     buffer);\n+    if (status != noErr)\n+        actualLength = 0;\n+\n+    \/\/ The Unicode Hex layout can yield a string of length 1 consisting of a\n+    \/\/ code point of 0.\n+    if (actualLength == 1 && buffer[0] == 0)\n+        actualLength = 0;\n+\n+    return actualLength;\n+}\n+\n+static BOOL isLetterOrDigit(jint javaKeyCode)\n+{\n+    if (javaKeyCode >= '0' && javaKeyCode <= '9')\n+        return YES;\n+    if (javaKeyCode >= 'A' && javaKeyCode <= 'Z')\n+        return YES;\n+    return NO;\n+}\n+\n+\/\/ This is only valid for keys in the layout-sensitive area.\n+static jint getJavaCodeForMacKeyAndModifiers(TISInputSourceRef keyboard, unsigned short keyCode, UInt32 modifiers)\n+{\n+    jint result = com_sun_glass_events_KeyEvent_VK_UNDEFINED;\n+    UniChar unicode[8];\n+    UniCharCount length = queryKeyboard(keyboard, keyCode, modifiers, unicode, 8);\n+    if (length == 1)\n+        result = getJavaCodeForASCII(unicode[0]);\n+    return result;\n+}\n+\n+\/\/ This is only valid for keys in the layout-sensitive area.\n+static jint getJavaCodeForMacKey(unsigned short keyCode)\n+{\n+    jint result = com_sun_glass_events_KeyEvent_VK_UNDEFINED;\n+    TISInputSourceRef keyboard = TISCopyCurrentKeyboardLayoutInputSource();\n+    if (keyboard == NULL)\n+        return result;\n+\n+    \/\/ Java key codes are used in accelerator processing so we will try to match them\n+    \/\/ the same way Apple handles key equivalents e.g. by asking for the Cmd character.\n+    \/\/ This is necessary on non-ASCII layouts such as Cyrillic or Arabic to ensure the\n+    \/\/ translation produces an ASCII key. Exactly how this is done is specific to the\n+    \/\/ keyboard but for non-ASCII keyboards it generally generates some variant of\n+    \/\/ QWERTY.\n+\n+    \/\/ First just Cmd.\n+    result = getJavaCodeForMacKeyAndModifiers(keyboard, keyCode, cmdKey);\n+\n+    \/\/ If we didn't get a hit try looking at the Shifted variant. Even if we did get a\n+    \/\/ hit we favor numerals and letters over punctuation. This brings the French\n+    \/\/ keyboard in line with Windows; the digits are shifted but are still considered\n+    \/\/ the canonical key codes.\n+    if (!isLetterOrDigit(result))\n+    {\n+        jint trial = getJavaCodeForMacKeyAndModifiers(keyboard, keyCode, cmdKey | shiftKey);\n+        if (isLetterOrDigit(trial))\n+            result = trial;\n+        else if (result == com_sun_glass_events_KeyEvent_VK_UNDEFINED)\n+            result = trial;\n+\n+        \/\/ A handful of keyboards (Azeri, Turkmen, and Sami variants) can only access\n+        \/\/ critical letters like Q by using the Option key in conjunction with Cmd.\n+        \/\/ In this API the Cmd flag suppresses the Option flag so we ommit Cmd.\n+        if (!isLetterOrDigit(result))\n+        {\n+            jint trial = getJavaCodeForMacKeyAndModifiers(keyboard, keyCode, optionKey);\n+            if (isLetterOrDigit(trial))\n+                result = trial;\n+            else if (result == com_sun_glass_events_KeyEvent_VK_UNDEFINED)\n+                result = trial;\n+        }\n+    }\n+\n+    CFRelease(keyboard);\n+    return result;\n+}\n+\n@@ -237,0 +401,5 @@\n+    if (macKeyCodeIsLayoutSensitive(keyCode))\n+    {\n+        return getJavaCodeForMacKey(keyCode);\n+    }\n+\n@@ -284,0 +453,2 @@\n+    BOOL found = NO;\n+    \/\/ Find a key code based on the US QWERTY layout\n@@ -289,1 +460,23 @@\n-            return YES;\n+            found = YES;\n+            break;\n+        }\n+    }\n+\n+    if (!found)\n+        return NO;\n+\n+    if (!macKeyCodeIsLayoutSensitive(*outMacKeyCode))\n+        return YES;\n+\n+    \/\/ If the QWERTY key is in the layout sensitive area search the other keys in that\n+    \/\/ area. We may not find a key so returning NO is possible.\n+    for (unsigned short trialKey = 0x00; trialKey <= 0x7E; ++trialKey)\n+    {\n+        if (macKeyCodeIsLayoutSensitive(trialKey))\n+        {\n+            jint trialCode = getJavaCodeForMacKey(trialKey);\n+            if (trialCode == javaKeyCode)\n+            {\n+                *outMacKeyCode = trialKey;\n+                return YES;\n+            }\n@@ -293,1 +486,0 @@\n-    \/\/ ??? unknown VK\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/mac\/GlassKey.m","additions":194,"deletions":2,"binary":false,"changes":196,"status":"modified"}]}