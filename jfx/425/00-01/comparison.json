{"files":[{"patch":"@@ -186,4 +186,1 @@\n-    \/\/ lie in two ranges with a few exceptions. For the purpose of Java key code\n-    \/\/ mapping we pretend that the top row of number keys always produce digits even\n-    \/\/ though that is not true on some keyboards e.g. French. This matches the behavior\n-    \/\/ of JavaFX on Windows and the historical behavior of JavaFX on Mac.\n+    \/\/ lie in two ranges with a few exceptions.\n@@ -192,10 +189,0 @@\n-        case 0x12: \/\/ 1\n-        case 0x13: \/\/ 2\n-        case 0x14: \/\/ 3\n-        case 0x15: \/\/ 4\n-        case 0x17: \/\/ 5\n-        case 0x16: \/\/ 6\n-        case 0x1A: \/\/ 7\n-        case 0x1C: \/\/ 8\n-        case 0x19: \/\/ 9\n-        case 0x1D: \/\/ 0\n@@ -300,1 +287,1 @@\n-static UniCharCount getCharsForMacKey(unsigned short keyCode, BOOL shifted, BOOL forAccelerator, UniChar* buffer, UniCharCount bufferSize)\n+static BOOL isLetterOrDigit(jint javaKeyCode)\n@@ -302,9 +289,5 @@\n-    TISInputSourceRef keyboard = TISCopyCurrentKeyboardLayoutInputSource();\n-    if (keyboard == NULL)\n-        return 0;\n-\n-    UniCharCount length = queryKeyboard(keyboard, keyCode,\n-                                        shifted, forAccelerator,\n-                                        buffer, bufferSize);\n-    CFRelease(keyboard);\n-    return length;\n+    if (javaKeyCode >= '0' && javaKeyCode <= '9')\n+        return YES;\n+    if (javaKeyCode >= 'A' && javaKeyCode <= 'Z')\n+        return YES;\n+    return NO;\n@@ -316,0 +299,5 @@\n+    jint result = com_sun_glass_events_KeyEvent_VK_UNDEFINED;\n+    TISInputSourceRef keyboard = TISCopyCurrentKeyboardLayoutInputSource();\n+    if (keyboard == NULL)\n+        return result;\n+\n@@ -317,1 +305,1 @@\n-    UniCharCount length = getCharsForMacKey(keyCode, NO, YES, unicode, 8);\n+    UniCharCount length = queryKeyboard(keyboard, keyCode, NO, YES, unicode, 8);\n@@ -319,2 +307,21 @@\n-        return getJavaCodeForASCII(unicode[0]);\n-    return 0;\n+        result = getJavaCodeForASCII(unicode[0]);\n+\n+    \/\/ If we didn't get a hit try looking at the shifted variant. Even if we did get a\n+    \/\/ hit we favor digits and letters over punctuation. This brings the French\n+    \/\/ keyboard in line with Windows; the digits are shifted but are still considered\n+    \/\/ the canonical keycodes.\n+    if (!isLetterOrDigit(result))\n+    {\n+        length = queryKeyboard(keyboard, keyCode, YES, YES, unicode, 8);\n+        if (length == 1)\n+        {\n+            jint trial = getJavaCodeForASCII(unicode[0]);\n+            if (result == com_sun_glass_events_KeyEvent_VK_UNDEFINED)\n+                result = trial; \/\/ Something is better than nothing\n+            else if (isLetterOrDigit(trial))\n+                result = trial;\n+        }\n+    }\n+\n+    CFRelease(keyboard);\n+    return result;\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/mac\/GlassKey.m","additions":34,"deletions":27,"binary":false,"changes":61,"status":"modified"}]}