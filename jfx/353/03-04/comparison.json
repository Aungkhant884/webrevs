{"files":[{"patch":"@@ -686,2 +686,3 @@\n-\n-            if (index == (lastGetIndex + 1) && lastGetValue < itemCount) {\n+            if (lastGetIndex == index) {\n+                return lastGetValue;\n+            } else if (index == (lastGetIndex + 1) && lastGetValue < itemCount) {\n@@ -720,0 +721,1 @@\n+            if(index <= lastGetValue) reset();\n@@ -742,0 +744,1 @@\n+                if(index <= lastGetValue) reset();\n@@ -748,0 +751,1 @@\n+                if(index <= lastGetValue) reset();\n@@ -782,19 +786,0 @@\n-                    int pos = 0;\n-                    int start = 0;\n-                    int end = 0;\n-\n-                    \/\/ starting from pos, we keep going until the value is\n-                    \/\/ not the next value\n-                    int startValue = sortedNewIndices.get(pos++);\n-                    start = indexOf(startValue);\n-                    end = start + 1;\n-                    int endValue = startValue;\n-                    while (pos < size) {\n-                        int previousEndValue = endValue;\n-                        endValue = sortedNewIndices.get(pos++);\n-                        ++end;\n-                        if (previousEndValue != (endValue - 1)) {\n-                            _nextAdd(start, end);\n-                            start = end;\n-                            continue;\n-                        }\n@@ -802,4 +787,15 @@\n-                        \/\/ special case for when we get to the point where the loop is about to end\n-                        \/\/ and we have uncommitted changes to fire.\n-                        if (pos == size) {\n-                            _nextAdd(start, end);\n+                    int startIndex = indexOf(sortedNewIndices.get(0));\n+                    int endIndex = startIndex + 1;\n+\n+                    for (int i = 1; i < sortedNewIndices.size(); ++i) {\n+                        int currentValue = get(endIndex);\n+                        int currentNewValue = sortedNewIndices.get(i);\n+                        if (currentValue != currentNewValue) {\n+                            _nextAdd(startIndex, endIndex);\n+                            while (get(endIndex) != currentNewValue) ++endIndex;\n+                            startIndex = endIndex++;\n+                        } else {\n+                            ++endIndex;\n+                        }\n+                        if (i == sortedNewIndices.size() - 1) {\n+                            _nextAdd(startIndex, endIndex);\n@@ -819,0 +815,1 @@\n+            reset();\n@@ -830,0 +827,1 @@\n+            if(index <= lastGetValue) reset();\n","filename":"modules\/javafx.controls\/src\/main\/java\/javafx\/scene\/control\/MultipleSelectionModelBase.java","additions":23,"deletions":25,"binary":false,"changes":48,"status":"modified"},{"patch":"@@ -1452,4 +1452,16 @@\n-    public void test_8256397() throws InterruptedException {\n-        testFactory_8256397(0, new int[]{2,3}, new Integer[]{0, 2, 3});\n-        testFactory_8256397(1, new int[]{0,3}, new Integer[]{0, 1, 3});\n-        testFactory_8256397(3, new int[]{0}, new Integer[]{0, 3});\n+    public void testSelectedIndicesChangeEvents() throws InterruptedException {\n+\n+        testSelectedIndicesChangeEventsFactory(0, new int[]{2,3}, 1, new int[]{5,7},\n+                new int[][]{new int[]{1}, new int[]{5,7}});\n+\n+        testSelectedIndicesChangeEventsFactory(1, new int[]{3,4}, 0, new int[]{5,7},\n+                new int[][]{new int[]{0}, new int[]{5,7}});\n+\n+        testSelectedIndicesChangeEventsFactory(0, new int[]{1, 3,4, 5, 7}, 6, new int[]{8,9},\n+                new int[][]{new int[]{6}, new int[]{8,9}});\n+\n+        testSelectedIndicesChangeEventsFactory(5, new int[]{6, 7}, 2, new int[]{1,0},\n+                new int[][]{new int[]{0,1,2}});\n+\n+        testSelectedIndicesChangeEventsFactory(2, new int[]{3, 6,7}, 0, new int[]{1,4,5,8,9},\n+                new int[][]{new int[]{0,1},new int[]{4,5},new int[]{8,9}});\n@@ -1457,1 +1469,2 @@\n-    public void testFactory_8256397(int selected, int[] selectedI, Integer[] added) throws InterruptedException {\n+\n+    public ListView creatListViewWithMultipleSelection() {\n@@ -1463,0 +1476,18 @@\n+        listView.getItems().add(\"item-4\");\n+        listView.getItems().add(\"item-5\");\n+        listView.getItems().add(\"item-6\");\n+        listView.getItems().add(\"item-7\");\n+        listView.getItems().add(\"item-8\");\n+        listView.getItems().add(\"item-9\");\n+        listView.getItems().add(\"item-10\");\n+        listView.getSelectionModel().setSelectionMode(SelectionMode.MULTIPLE);\n+        return listView;\n+    }\n+\n+    public void testSelectedIndicesChangeEventsFactory(int initialSelected, int[] initialSelectedI, int selected, int[] selectedI, int[][] expected) throws InterruptedException {\n+        ListView<String> listView = creatListViewWithMultipleSelection();\n+        listView.getSelectionModel().selectIndices(initialSelected,initialSelectedI);\n+        testSelectedIndicesChangeHelper(listView, selected, selectedI, expected);\n+    }\n+    public void testSelectedIndicesChangeHelper(ListView listView, int selected, int[] selectedI, int[][] expected) {\n+        List<int[]> expectedEntries = new LinkedList<>(Arrays.asList(expected));\n@@ -1464,1 +1495,0 @@\n-        selectionModel.setSelectionMode(SelectionMode.MULTIPLE);\n@@ -1468,1 +1498,2 @@\n-                    assertEquals(added, c.getAddedSubList().toArray());\n+                    assertEquals(Arrays.stream(expectedEntries.get(0)).boxed().collect(Collectors.toList()), c.getAddedSubList());\n+                    expectedEntries.remove(0);\n@@ -1474,0 +1505,1 @@\n+\n@@ -1475,0 +1507,2 @@\n+\n+        assertTrue(\"A ListEvent was missing: \" + Arrays.deepToString(expectedEntries.toArray()), expectedEntries.isEmpty());\n","filename":"modules\/javafx.controls\/src\/test\/java\/test\/javafx\/scene\/control\/MultipleSelectionModelImplTest.java","additions":41,"deletions":7,"binary":false,"changes":48,"status":"modified"}]}