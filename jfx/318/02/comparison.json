{"files":[{"patch":"@@ -270,0 +270,2 @@\n+        if (getSkinnable() == null) return;\n+\n@@ -274,0 +276,11 @@\n+        getSkinnable().getTabs().removeListener(weakTabsListener);\n+        tabHeaderArea.removeListeners();\n+\n+\n+        \/\/ Control and Skin share the list of children, so children that are\n+        \/\/ added by Skin are actually added to control's list of children,\n+        \/\/ so a skin should remove the children that it adds.\n+        getChildren().remove(tabHeaderArea);\n+        for (Tab tab : getSkinnable().getTabs()) {\n+            removeTabContent(tab);\n+        }\n@@ -582,0 +595,2 @@\n+    ListChangeListener<Tab> tabsListener;\n+    WeakListChangeListener<Tab> weakTabsListener;\n@@ -583,1 +598,1 @@\n-        getSkinnable().getTabs().addListener((ListChangeListener<Tab>) c -> {\n+        tabsListener = c -> {\n@@ -662,1 +677,3 @@\n-        });\n+        };\n+        weakTabsListener = new WeakListChangeListener<>(tabsListener);\n+        getSkinnable().getTabs().addListener(weakTabsListener);\n@@ -676,3 +693,1 @@\n-                contentRegion.removeListeners(tab);\n-                getChildren().remove(contentRegion);\n-                tabContentRegions.remove(contentRegion);\n+                removeTabContent(contentRegion);\n@@ -684,0 +699,6 @@\n+    private void removeTabContent(TabContentRegion contentRegion) {\n+        contentRegion.dispose();\n+        tabContentRegions.remove(contentRegion);\n+        getChildren().remove(contentRegion);\n+    }\n+\n@@ -1211,0 +1232,8 @@\n+\n+        void removeListeners() {\n+            for (Node child : headersRegion.getChildren()) {\n+                TabHeaderSkin header = (TabHeaderSkin) child;\n+                header.removeListeners(header.getTab());\n+            }\n+            controlButtons.removeListeners();\n+        }\n@@ -1545,0 +1574,1 @@\n+            tab.getStyleClass().removeListener(weakStyleClassListener);\n@@ -1696,1 +1726,1 @@\n-        private void removeListeners(Tab tab) {\n+        private void removeListeners() {\n@@ -1701,0 +1731,5 @@\n+        public void dispose() {\n+            getChildren().clear();\n+            removeListeners();\n+        }\n+\n@@ -1788,5 +1823,2 @@\n-            tabPane.sideProperty().addListener(valueModel -> {\n-                Side tabPosition = getSkinnable().getSide();\n-                downArrow.setRotate(tabPosition.equals(Side.BOTTOM)? 180.0F : 0.0F);\n-            });\n-            tabPane.getTabs().addListener((ListChangeListener<Tab>) c -> setupPopupMenu());\n+            tabPane.sideProperty().addListener(weakSidePropListener);\n+            tabPane.getTabs().addListener(weakTabsListenerForPopup);\n@@ -1801,0 +1833,15 @@\n+        InvalidationListener sidePropListener =  e -> {\n+            Side tabPosition = getSkinnable().getSide();\n+            downArrow.setRotate(tabPosition.equals(Side.BOTTOM)? 180.0F : 0.0F);\n+        };\n+        ListChangeListener<Tab> tabsListenerForPopup = e -> setupPopupMenu();\n+        WeakInvalidationListener weakSidePropListener =\n+                new WeakInvalidationListener(sidePropListener);\n+        WeakListChangeListener weakTabsListenerForPopup =\n+                new WeakListChangeListener<>(tabsListenerForPopup);\n+\n+        void removeListeners() {\n+            getSkinnable().sideProperty().removeListener(weakSidePropListener);\n+            getSkinnable().getTabs().removeListener(weakTabsListenerForPopup);\n+        }\n+\n@@ -2061,5 +2108,1 @@\n-        getSkinnable().tabDragPolicyProperty().addListener((observable, oldValue, newValue) -> {\n-            if (oldValue != newValue) {\n-                updateListeners();\n-            }\n-        });\n+        registerChangeListener(getSkinnable().tabDragPolicyProperty(), inv -> updateListeners());\n","filename":"modules\/javafx.controls\/src\/main\/java\/javafx\/scene\/control\/skin\/TabPaneSkin.java","additions":59,"deletions":16,"binary":false,"changes":75,"status":"modified"},{"patch":"@@ -40,0 +40,1 @@\n+import javafx.scene.control.skin.TabPaneSkin;\n@@ -45,0 +46,2 @@\n+import javafx.scene.control.Tab;\n+import javafx.scene.control.TabPane;\n@@ -260,0 +263,62 @@\n+\/\/-------- TabPane\n+    @Test\n+    public void testChildrenCountAfterSkinIsReplaced() {\n+      TabPane tabPane = new TabPane();\n+      tabPane.getTabs().addAll(new Tab(\"0\"), new Tab(\"1\"));\n+      showControl(tabPane, false);\n+      assertEquals(3, tabPane.getChildrenUnmodifiable().size());\n+      TabPaneSkin skin1 = (TabPaneSkin)createAlternativeSkin(tabPane);\n+      assertEquals(6, tabPane.getChildrenUnmodifiable().size());\n+      tabPane.setSkin(skin1);\n+      assertEquals(3, tabPane.getChildrenUnmodifiable().size());\n+    }\n+\n+    @Test\n+    public void testChildrenCountAfterSkinIsRemoved() {\n+      TabPane tabPane = new TabPane();\n+      assertEquals(0, tabPane.getChildrenUnmodifiable().size());\n+      tabPane.getTabs().addAll(new Tab(\"0\"), new Tab(\"1\"));\n+      showControl(tabPane, false);\n+      assertEquals(3, tabPane.getChildrenUnmodifiable().size());\n+      root.getChildren().remove(tabPane);\n+      assertTrue(tabPane.getSkin() instanceof TabPaneSkin);\n+      assertEquals(3, tabPane.getChildrenUnmodifiable().size());\n+      tabPane.setSkin(null);\n+      assertNull(tabPane.getSkin());\n+      assertEquals(0, tabPane.getChildrenUnmodifiable().size());\n+    }\n+\n+    @Test\n+    public void testNPEWhenAddTabsAfterSkinIsReplaced() {\n+      TabPane tabPane = new TabPane();\n+      tabPane.getTabs().addAll(new Tab(\"0\"), new Tab(\"1\"));\n+      showControl(tabPane, false);\n+      replaceSkin(tabPane);\n+      tabPane.getTabs().addAll(new Tab(\"2\"), new Tab(\"3\"));\n+    }\n+\n+    @Test\n+    public void testNPEWhenRemTabAfterSkinIsReplaced() {\n+      TabPane tabPane = new TabPane();\n+      tabPane.getTabs().addAll(new Tab(\"0\"), new Tab(\"1\"));\n+      showControl(tabPane, false);\n+      replaceSkin(tabPane);\n+      tabPane.getTabs().remove(0);\n+    }\n+\n+    @Test\n+    public void testAddRemTabsAfterSkinIsReplaced() {\n+      TabPane tabPane = new TabPane();\n+      tabPane.getTabs().addAll(new Tab(\"0\"), new Tab(\"1\"));\n+      showControl(tabPane, false);\n+      assertEquals(2, tabPane.getTabs().size());\n+      assertEquals(3, tabPane.getChildrenUnmodifiable().size());\n+      replaceSkin(tabPane);\n+      tabPane.getTabs().addAll(new Tab(\"2\"), new Tab(\"3\"));\n+      assertEquals(4, tabPane.getTabs().size());\n+      assertEquals(5, tabPane.getChildrenUnmodifiable().size());\n+      tabPane.getTabs().clear();\n+      assertEquals(0, tabPane.getTabs().size());\n+      assertEquals(1, tabPane.getChildrenUnmodifiable().size());\n+    }\n+\n","filename":"modules\/javafx.controls\/src\/test\/java\/test\/javafx\/scene\/control\/skin\/SkinCleanupTest.java","additions":65,"deletions":0,"binary":false,"changes":65,"status":"modified"},{"patch":"@@ -118,2 +118,0 @@\n-                \/\/ @Ignore(\"8242621\")\n-                TabPane.class,\n","filename":"modules\/javafx.controls\/src\/test\/java\/test\/javafx\/scene\/control\/skin\/SkinMemoryLeakTest.java","additions":0,"deletions":2,"binary":false,"changes":2,"status":"modified"}]}