{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2021, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -28,2 +28,0 @@\n-import java.net.URLDecoder;\n-import java.nio.charset.Charset;\n@@ -106,1 +104,0 @@\n-        Charset charset = Charset.defaultCharset();\n@@ -115,3 +112,1 @@\n-            base64 ?\n-                Base64.getDecoder().decode(data) :\n-                URLDecoder.decode(data.replace(\"+\", \"%2B\"), charset).getBytes(charset));\n+            base64 ? Base64.getDecoder().decode(data) : decodePercentEncoding(data));\n@@ -211,0 +206,79 @@\n+    \/**\n+     * Decodes percent-encoded text as specified by RFC 3986, section 2.1\n+     * This method does not make any assumptions about the allowed character set.\n+     *\n+     * @param input the input string\n+     * @return the decoded byte array\n+     *\/\n+    private static byte[] decodePercentEncoding(String input) {\n+        enum ExpectedCharacter {\n+            DEFAULT,\n+            FIRST_HEX_DIGIT,\n+            SECOND_HEX_DIGIT\n+        }\n+\n+        ExpectedCharacter expectedCharacter = ExpectedCharacter.DEFAULT;\n+        byte[] output = new byte[computePayloadSize(input)];\n+        int firstDigit = 0;\n+\n+        for (int i = 0, j = 0; i < input.length(); ++i) {\n+            char c = input.charAt(i);\n+\n+            expectedCharacter = switch (expectedCharacter) {\n+                case DEFAULT -> {\n+                    if (c == '%') {\n+                        yield ExpectedCharacter.FIRST_HEX_DIGIT;\n+                    } else {\n+                        output[j++] = (byte)c;\n+                        yield ExpectedCharacter.DEFAULT;\n+                    }\n+                }\n+\n+                case FIRST_HEX_DIGIT -> {\n+                    firstDigit = hexDigit(c);\n+                    yield ExpectedCharacter.SECOND_HEX_DIGIT;\n+                }\n+\n+                case SECOND_HEX_DIGIT -> {\n+                    output[j++] = (byte)(firstDigit << 4 | hexDigit(c));\n+                    yield ExpectedCharacter.DEFAULT;\n+                }\n+            };\n+        }\n+\n+        if (expectedCharacter != ExpectedCharacter.DEFAULT) {\n+            throw new IllegalArgumentException(\"Incomplete character escape sequence\");\n+        }\n+\n+        return output;\n+    }\n+\n+    \/**\n+     * Computes the payload size of the percent-encoded string.\n+     *\n+     * @param input the input string\n+     * @return the payload size in bytes\n+     *\/\n+    private static int computePayloadSize(String input) {\n+        int count = 0;\n+\n+        for (int i = 0, max = input.length(); i < max; ++i) {\n+            if (input.charAt(i) == '%') {\n+                i += 2;\n+            }\n+\n+            ++count;\n+        }\n+\n+        return count;\n+    }\n+\n+    private static int hexDigit(char c) {\n+        int digit = Character.digit(c, 16);\n+        if (digit < 0) {\n+            throw new IllegalArgumentException(\"Invalid symbol in character escape sequence\");\n+        }\n+\n+        return digit;\n+    }\n+\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/javafx\/util\/DataURI.java","additions":81,"deletions":7,"binary":false,"changes":88,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2021, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -29,1 +29,3 @@\n-import org.junit.Test;\n+import org.junit.jupiter.api.Test;\n+import java.net.URLEncoder;\n+import java.nio.charset.StandardCharsets;\n@@ -31,1 +33,1 @@\n-import static org.junit.Assert.*;\n+import static org.junit.jupiter.api.Assertions.*;\n@@ -35,0 +37,10 @@\n+    @Test\n+    public void testNullIsInvalid() {\n+        assertNull(DataURI.tryParse(null));\n+    }\n+\n+    @Test\n+    public void testEmptyStringIsInvalid() {\n+        assertNull(DataURI.tryParse(\"\"));\n+    }\n+\n@@ -43,1 +55,1 @@\n-    @Test(expected = IllegalArgumentException.class)\n+    @Test\n@@ -47,1 +59,1 @@\n-        DataURI uri = DataURI.tryParse(data);\n+        assertThrows(IllegalArgumentException.class, () -> DataURI.tryParse(data));\n@@ -177,0 +189,30 @@\n+    @Test\n+    public void testPercentEncodedTextIsDecodedAccordingToRFC3986() {\n+        \/\/ We use URLEncoder here to escape the emoji character using percent-encoding.\n+        \/\/ When DataURI parses its payload, it automatically converts percent-encoded characters back to octets.\n+        String input = URLEncoder.encode(\"ðŸ™‚\", StandardCharsets.UTF_8);\n+        String output = new String(DataURI.tryParse(\"data:,\" + input).getData(), StandardCharsets.UTF_8);\n+        assertEquals(\"ðŸ™‚\", output);\n+\n+        \/\/ In the next case, URLEncoder replaces the space character with '+'.\n+        \/\/ Since DataURI does not know about this special encoding, the '+' character is retained.\n+        input = URLEncoder.encode(\"Hello ðŸ™‚!\", StandardCharsets.UTF_8);\n+        output = new String(DataURI.tryParse(\"data:,\" + input).getData(), StandardCharsets.UTF_8);\n+        assertEquals(\"Hello+ðŸ™‚!\", output);\n+    }\n+\n+    @Test\n+    public void testPercentEncodedTextContainsInvalidEscapeSequence() {\n+        var ex = assertThrows(IllegalArgumentException.class, () -> DataURI.tryParse(\"data:,%XY\"));\n+        assertTrue(ex.getMessage().startsWith(\"Invalid\"));\n+\n+        ex = assertThrows(IllegalArgumentException.class, () -> DataURI.tryParse(\"data:,%5G\"));\n+        assertTrue(ex.getMessage().startsWith(\"Invalid\"));\n+\n+        ex = assertThrows(IllegalArgumentException.class, () -> DataURI.tryParse(\"data:,%0\"));\n+        assertTrue(ex.getMessage().startsWith(\"Incomplete\"));\n+\n+        ex = assertThrows(IllegalArgumentException.class, () -> DataURI.tryParse(\"data:,%\"));\n+        assertTrue(ex.getMessage().startsWith(\"Incomplete\"));\n+    }\n+\n","filename":"modules\/javafx.graphics\/src\/test\/java\/test\/com\/sun\/javafx\/util\/DataURITest.java","additions":47,"deletions":5,"binary":false,"changes":52,"status":"modified"}]}