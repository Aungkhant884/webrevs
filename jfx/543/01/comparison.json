{"files":[{"patch":"@@ -54,0 +54,1 @@\n+import javax.print.attribute.standard.Destination;\n@@ -71,0 +72,4 @@\n+import java.net.MalformedURLException;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n@@ -335,1 +340,1 @@\n-        String name =  pJob2D.getJobName();\n+        String name = pJob2D.getJobName();\n@@ -340,0 +345,14 @@\n+\n+    private void updateOutputFile() {\n+        Destination dest =\n+            (Destination)printReqAttrSet.get(Destination.class);\n+        if (dest != null) {\n+            try {\n+                settings.setOutputFile(dest.getURI().toURL().toString());\n+            } catch (MalformedURLException e) {\n+            }\n+        } else {\n+            settings.setOutputFile(\"\");\n+        }\n+    }\n+\n@@ -396,1 +415,1 @@\n-     * it means that we are u  sing the printer default.\n+     * it means that we are using the printer default.\n@@ -581,0 +600,1 @@\n+        updateOutputFile();\n@@ -594,0 +614,1 @@\n+        syncOutputFile();\n@@ -609,0 +630,17 @@\n+    private void syncOutputFile() {\n+        printReqAttrSet.remove(Destination.class);\n+        String file = settings.getOutputFile();\n+        if (file != null && !file.isEmpty()) {\n+            try {\n+                 URL url = new URL(file);\n+                 if (!\"file\".equals(url.getProtocol())) {\n+                     return;\n+                 }\n+                 URI uri = url.toURI();\n+                 Destination d = new Destination(uri);\n+                 printReqAttrSet.add(d);\n+            } catch (MalformedURLException | URISyntaxException e) {\n+            }\n+        }\n+    }\n+\n@@ -800,0 +838,7 @@\n+            String file = settings.getOutputFile();\n+            if (!file.isEmpty()) {\n+                try {\n+                     security.checkWrite((new URL(file)).getPath());\n+                } catch (MalformedURLException e) {\n+                }\n+            }\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/prism\/j2d\/print\/J2DPrinterJob.java","additions":47,"deletions":2,"binary":false,"changes":49,"status":"modified"},{"patch":"@@ -465,0 +465,91 @@\n+    \/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/  START OUTPUTFILE \/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\n+\n+    private static final String DEFAULT_OUTPUTFILE = \"\";\n+    private SimpleStringProperty outputFile;\n+\n+    \/**\n+     * A {@code StringProperty} representing the {@code java.net.URL}\n+     * encoded name of a filesystem file, to which the platform printer\n+     * driver should spool the rendered print data.\n+     * <p>\n+     * Applications can use this to request print-to-file behaviour where\n+     * the native print system is capabale of spooling the output to a\n+     * filesystem file, rather than the printer device.\n+     * <p>\n+     * This is often useful where the printer driver generates a format\n+     * such as Postscript or PDF, and the application intends to distribute\n+     * the result instead of printing it, or for some other reason the\n+     * application does not want physical media (paper) emitted by the printer.\n+     * <p>\n+     * If the application does not have permission to write to the specified\n+     * file, a {@code SecurityException} may be thrown when printing.\n+     * If the print system does not support print-to-file, then this\n+     * <p>\n+     * setting will be ignored.\n+     * If the URL specifies a non-existent path, or does not specify\n+     * a writable file it may be ignored, or a SecurityException may be thrown.\n+     * The default value is an empty string, which is interpreted as unset,\n+     * which means output is sent to the printer.\n+     *\n+     * @return the name of a printer spool file\n+     * @since 17\n+     *\/\n+    public final StringProperty outputFileProperty() {\n+        if (outputFile == null) {\n+            outputFile =\n+                new SimpleStringProperty(JobSettings.this, \"outputFile\",\n+                                         DEFAULT_OUTPUTFILE) {\n+\n+                @Override\n+                public void set(String value) {\n+                    if (!isJobNew()) {\n+                        return;\n+                    }\n+                    if (value == null) {\n+                        value = DEFAULT_OUTPUTFILE;\n+                    }\n+                    super.set(value);\n+                }\n+\n+                @Override\n+                public void bind(ObservableValue<? extends String>\n+                                 rawObservable) {\n+                    throw new\n+                        RuntimeException(\"OutputFile property cannot be bound\");\n+                }\n+\n+                @Override\n+                public void bindBidirectional(Property<String> other) {\n+                    throw new\n+                        RuntimeException(\"OutputFile property cannot be bound\");\n+                }\n+\n+                @Override\n+                public String toString() {\n+                     return get();\n+                }\n+            };\n+        }\n+        return outputFile;\n+    }\n+\n+    \/**\n+     * Get the output file path name.\n+     * @return the output file as a string encoded {@code java.net.URL}\n+     * @since 17\n+     *\/\n+    public String getOutputFile() {\n+        return outputFileProperty().get();\n+    }\n+\n+\n+    \/**\n+     * Set the output file.\n+     * @param urlString the output file as a string encoded {@code java.net.URL}\n+     * @since 17\n+     *\/\n+    public void setOutputFile(String urlString) {\n+        outputFileProperty().set(urlString);\n+    }\n+    \/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/  END OUTPUTFILE \/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\n+\n","filename":"modules\/javafx.graphics\/src\/main\/java\/javafx\/print\/JobSettings.java","additions":91,"deletions":0,"binary":false,"changes":91,"status":"modified"},{"patch":"@@ -0,0 +1,164 @@\n+\/*\n+ * Copyright (c) 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+import java.io.File;\n+import java.net.URL;\n+import java.net.MalformedURLException;\n+\n+import javafx.application.Platform;\n+import javafx.collections.FXCollections;\n+import javafx.collections.ObservableList;\n+import javafx.print.*;\n+\n+import javafx.application.Application;\n+import javafx.geometry.Rectangle2D;\n+import javafx.scene.Group;\n+import javafx.scene.Node;\n+import javafx.scene.Scene;\n+import javafx.scene.control.Button;\n+import javafx.scene.control.Label;\n+import javafx.scene.control.TextArea;\n+import javafx.scene.layout.*;\n+import javafx.scene.paint.Color;\n+import javafx.scene.text.Text;\n+import javafx.stage.Screen;\n+import javafx.stage.Stage;\n+\n+public class PrintToFileTest extends Application {\n+\n+    private final int WIDTH = 400;\n+    private final int HEIGHT = 400;\n+\n+    private volatile boolean passed = false;\n+    private volatile boolean failed = false;\n+    private Scene scene;\n+    private VBox root;\n+\n+    public static void main(String[] args) {\n+        launch(args);\n+    }\n+\n+    public void start(Stage stage) {\n+        stage.setWidth(WIDTH);\n+        stage.setHeight(HEIGHT);\n+        stage.setTitle(\"Printing to file test\");\n+        Rectangle2D bds = Screen.getPrimary().getVisualBounds();\n+        stage.setX((bds.getWidth() - WIDTH) \/ 2);\n+        stage.setY((bds.getHeight() - HEIGHT) \/ 2);\n+        stage.setScene(createScene());\n+        stage.show();\n+    }\n+\n+    static final String instructions =\n+        \"This tests that programmatically specifying print to file works.\\n\" +\n+        \"Select the Print button to run the test\\n\";\n+\n+    static final String noprinter =\n+            \"There are no printers installed. This test cannot be run\\n\";\n+\n+    private TextArea createInfo(String msg) {\n+        TextArea t = new TextArea(msg);\n+        t.setWrapText(true);\n+        t.setEditable(false);\n+        return t;\n+    }\n+\n+    private Scene createScene() {\n+\n+        root = new VBox();\n+        scene = new Scene(root);\n+\n+        String msg = instructions;\n+        if (Printer.getDefaultPrinter() == null) {\n+            msg = noprinter;\n+        }\n+        TextArea info = createInfo(msg);\n+        root.getChildren().add(info);\n+\n+        Button print = new Button(\"Print\");\n+        print.setLayoutX(80);\n+        print.setLayoutY(200);\n+        print.setOnAction(e -> runTest());\n+        root.getChildren().add(print);\n+\n+        return scene;\n+    }\n+\n+    public void runTest() {\n+        new Thread(() -> {\n+            passed = false;\n+            failed = false;\n+            System.out.println(\"START OF PRINT JOB\");\n+            PrinterJob job = PrinterJob.createPrinterJob();\n+            JobSettings settings = job.getJobSettings();\n+            File f = new File(\"printtofiletest.prn\");\n+            f.delete();\n+            try {\n+                URL url = f.toURL();\n+                String urlStr = url.toString();\n+                settings.outputFileProperty().set(urlStr);\n+            } catch (MalformedURLException e) {\n+                System.out.println(e);\n+                failed = true;\n+            }\n+\n+            Platform.runLater(() -> {\n+                Text t = new Text(\"file=\"+settings.getOutputFile());\n+                root.getChildren().add(t);\n+            });\n+            Text printNode = new Text(\"\\n\\nTEST\\nabc\\ndef\");\n+            job.printPage(printNode);\n+            job.endJob();\n+            if (f.exists()) {\n+                System.out.println(\"created file\");\n+                passed = true;\n+                f.delete();\n+            } else {\n+                failed = true;\n+            }\n+            System.out.println(\"END OF PRINT JOB\");\n+        }).start();\n+        new Thread(() -> {\n+            while (!passed && !failed) {\n+                try {\n+                    Thread.sleep(500);\n+                } catch (InterruptedException e) {\n+                }\n+            }\n+            Platform.runLater(() -> displayMessage());\n+\n+        }).start();\n+    }\n+\n+    private void displayMessage() {\n+        Text t = new Text();\n+        if (passed) {\n+            t.setText(\"TEST PASSED!\");\n+        } else {\n+            t.setText(\"TEST FAILED!\");\n+        }\n+        root.getChildren().add(t);\n+    }\n+}\n","filename":"tests\/manual\/printing\/PrintToFileTest.java","additions":164,"deletions":0,"binary":false,"changes":164,"status":"added"}]}