{"files":[{"patch":"@@ -74,3 +74,1 @@\n-    GdkKeymapKey *keys;\n-    gint n_keys;\n-    if (gdk_keyval == -1) {\n+    if (gdk_keyval == -1)\n@@ -78,4 +76,2 @@\n-    }\n-    gdk_keymap_get_entries_for_keyval(gdk_keymap_get_default(),\n-            gdk_keyval, &keys, &n_keys);\n-    if (n_keys < 1) {\n+    int keycode = find_gdk_keycode_for_keyval(gdk_keyval);\n+    if (keycode == -1)\n@@ -83,2 +79,0 @@\n-    }\n-\n@@ -86,1 +80,1 @@\n-                      keys[0].keycode,\n+                      keycode,\n@@ -89,1 +83,0 @@\n-    g_free(keys);\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/gtk\/GlassRobot.cpp","additions":4,"deletions":11,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -287,0 +287,57 @@\n+static int search_keys(GdkKeymapKey* keys, gint n_keys, int search_group)\n+{\n+    int result = -1;\n+    for (gint i = 0; i < n_keys; ++i)\n+    {\n+        if (keys[i].group == search_group &&\n+            keys[i].level == 0)\n+        {\n+            result = keys[i].keycode;\n+            break;\n+        }\n+    }\n+    return result;\n+}\n+\n+extern \"C\" {\n+    static int get_current_keyboard_group();\n+}\n+\n+int find_gdk_keycode_for_keyval(gint keyval)\n+{\n+    Display *xdisplay = gdk_x11_get_default_xdisplay();\n+    GdkKeymapKey *keys = nullptr;\n+    gint n_keys = 0;\n+    GdkKeymap* keymap = gdk_keymap_get_default();\n+\n+    \/\/ GDK assigns different keyvals to upper and lower case\n+    \/\/ letters. We're looking for the level 0 character that\n+    \/\/ was originally used to assign the code in get_glass_key.\n+    keyval = gdk_keyval_to_lower(keyval);\n+    if (!gdk_keymap_get_entries_for_keyval(keymap, keyval, &keys, &n_keys))\n+        return -1;\n+\n+    int result = -1;\n+    if (n_keys == 1)\n+    {\n+        result = keys[0].keycode;\n+    }\n+    else\n+    {\n+        int group = get_current_keyboard_group();\n+        result = search_keys(keys, n_keys, group);\n+\n+        \/\/ Java VK codes are Latin which means we might not be able\n+        \/\/ to find them on non-Latin layouts. The equivalent logic\n+        \/\/ in get_glass_key just assumes the first layout is Latin.\n+        \/\/ And for fixed-function keys like Space the GDK API is\n+        \/\/ likely to return results on group 0 even if it's not the\n+        \/\/ current group.\n+        if (result < 0 && group != 0)\n+            result = search_keys(keys, n_keys, 0);\n+    }\n+\n+    g_free(keys);\n+    return result;\n+}\n+\n@@ -368,0 +425,16 @@\n+\/*\n+  * Determine which keyboard layout is active. This is the group\n+  * number in the Xkb state. There is no direct way to query this\n+  * in Gdk.\n+  *\/\n+ static gint get_current_keyboard_group()\n+ {\n+     Display* display = gdk_x11_display_get_xdisplay(gdk_display_get_default());\n+     if (isXkbAvailable(display)) {\n+         XkbStateRec xkbState;\n+         XkbGetState(display, XkbUseCoreKbd, &xkbState);\n+         return xkbState.group;\n+     }\n+     return -1;\n+ }\n+\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/gtk\/glass_key.cpp","additions":73,"deletions":0,"binary":false,"changes":73,"status":"modified"},{"patch":"@@ -37,1 +37,1 @@\n-\n+int find_gdk_keycode_for_keyval(gint keyval);\n@@ -39,1 +39,0 @@\n-\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/gtk\/glass_key.h","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"}]}