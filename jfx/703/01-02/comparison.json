{"files":[{"patch":"@@ -1582,1 +1582,1 @@\n-      default: false\n+      default: true\n","filename":"modules\/javafx.web\/src\/main\/native\/Source\/WTF\/Scripts\/Preferences\/WebPreferences.yaml","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -860,1 +860,1 @@\n-    if (page->isClosing() && m_localStorage)\n+    if (m_localStorage)\n","filename":"modules\/javafx.web\/src\/main\/native\/Source\/WebCore\/page\/DOMWindow.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2011, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -32,0 +32,4 @@\n+import static org.junit.Assert.fail;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n@@ -33,0 +37,3 @@\n+import static java.lang.String.format;\n+import java.io.RandomAccessFile;\n+import java.nio.channels.FileLock;\n@@ -35,0 +42,4 @@\n+import java.io.IOException;\n+import java.util.Random;\n+\n+\n@@ -40,1 +51,0 @@\n-import org.junit.Test;\n@@ -44,6 +54,18 @@\n-    @Test\n-    public void testLocalStorage() throws Exception {\n-        final WebEngine webEngine = getEngine();\n-        webEngine.setJavaScriptEnabled(true);\n-        webEngine.setUserDataDirectory(new File(\"\/tmp\/java-store\"));\n-        checkLocalStorageAfterWindowClose(webEngine);\n+    private static final File LOCAL_STORAGE_DIR = new File(\"LocalStorageDir\");\n+    private static final File PRE_LOCKED = new File(\"zoo_local_storage\");\n+\n+    private static RandomAccessFile preLockedRaf;\n+    private static FileLock preLockedLock;\n+    private static final Random random = new Random();\n+\n+    private static void deleteRecursively(File file) throws IOException {\n+        if (file.isDirectory()) {\n+            for (File f : file.listFiles()) {\n+                deleteRecursively(f);\n+            }\n+        }\n+        if (!file.delete()) {\n+            \/\/ If WebKit takes time to close the file, better\n+            \/\/ delete it during VM shutdown.\n+            file.deleteOnExit();\n+        }\n@@ -51,0 +73,1 @@\n+\n@@ -55,0 +78,1 @@\n+    \/* test localstorage instance *\/\n@@ -64,0 +88,42 @@\n+    @BeforeClass\n+    public static void beforeClass() throws IOException {\n+        PRE_LOCKED.mkdirs();\n+        File preLockedFile = new File(PRE_LOCKED, \".lock\");\n+        preLockedRaf = new RandomAccessFile(preLockedFile, \"rw\");\n+        preLockedLock = preLockedRaf.getChannel().tryLock();\n+        if (preLockedLock == null) {\n+            fail(format(\"Directory [%s] is already locked \"\n+                    + \"externally\", PRE_LOCKED));\n+        }\n+    }\n+\n+    @AfterClass\n+    public static void afterClass() throws IOException {\n+        preLockedLock.release();\n+        preLockedRaf.close();\n+        deleteRecursively(LOCAL_STORAGE_DIR);\n+        deleteRecursively(PRE_LOCKED);\n+    }\n+\n+    @Test\n+    public void testLocalStorage() throws Exception {\n+        final WebEngine webEngine = getEngine();\n+        webEngine.setJavaScriptEnabled(true);\n+        webEngine.setUserDataDirectory(LOCAL_STORAGE_DIR);\n+        checkLocalStorageAfterWindowClose(webEngine);\n+    }\n+\n+    \/* test localstorage set data before window.close and check data after window.close *\/\n+    @Test\n+    public void testLocalStorageData() {\n+        load(new File(\"src\/test\/resources\/test\/html\/localstorage.html\"));\n+        submit(() -> {\n+            WebView view = getView();\n+            view.getEngine().executeScript(\"test_local_storage_set();\"); \/\/ set data\n+            getEngine().executeScript(\"window.close();\");\n+            \/\/get data\n+            String s = (String) view.getEngine().executeScript(\"document.getElementById('key').innerText;\");\n+            assertEquals(s, \"1001\");\n+        });\n+    }\n+\n@@ -80,0 +146,1 @@\n+            view.getEngine().executeScript(\"test_local_storage_set();\"); \/\/ set data\n","filename":"modules\/javafx.web\/src\/test\/java\/test\/javafx\/scene\/web\/LocalStorageTest.java","additions":75,"deletions":8,"binary":false,"changes":83,"status":"modified"}]}