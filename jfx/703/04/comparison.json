{"files":[{"patch":"@@ -1582,1 +1582,1 @@\n-      default: false\n+      default: true\n","filename":"modules\/javafx.web\/src\/main\/native\/Source\/WTF\/Scripts\/Preferences\/WebPreferences.yaml","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -850,1 +850,0 @@\n-    auto* page = document->page();\n@@ -853,4 +852,2 @@\n-    if (!page || !page->isClosing()) {\n-        if (m_localStorage)\n-            return m_localStorage.get();\n-    }\n+    if (m_localStorage)\n+        return m_localStorage.get();\n@@ -858,0 +855,1 @@\n+    auto* page = document->page();\n@@ -861,3 +859,1 @@\n-    if (page->isClosing())\n-        return nullptr;\n-\n+    \/\/ Check if localstorage setting is disabled, then return nullptr\n","filename":"modules\/javafx.web\/src\/main\/native\/Source\/WebCore\/page\/DOMWindow.cpp","additions":4,"deletions":8,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -0,0 +1,149 @@\n+\/*\n+ * Copyright (c) 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package test.javafx.scene.web;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.fail;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+import static java.lang.String.format;\n+import java.io.RandomAccessFile;\n+import java.nio.channels.FileLock;\n+import java.util.concurrent.FutureTask;\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.Random;\n+\n+\n+import javafx.scene.web.WebEngineShim;\n+import javafx.concurrent.Worker;\n+import javafx.scene.web.WebView;\n+import javafx.scene.web.WebEngine;\n+\n+\n+public class LocalStorageTest extends TestBase {\n+\n+    private static final File LOCAL_STORAGE_DIR = new File(\"LocalStorageDir\");\n+    private static final File PRE_LOCKED = new File(\"zoo_local_storage\");\n+\n+    private static void deleteRecursively(File file) throws IOException {\n+        if (file.isDirectory()) {\n+            for (File f : file.listFiles()) {\n+                deleteRecursively(f);\n+            }\n+        }\n+        if (!file.delete()) {\n+            \/\/ If WebKit takes time to close the file, better\n+            \/\/ delete it during VM shutdown.\n+            file.deleteOnExit();\n+        }\n+    }\n+\n+    private WebEngine createWebEngine() {\n+        return submit(() -> new WebEngine());\n+    }\n+\n+    \/* test localstorage instance *\/\n+    void checkLocalStorageAfterWindowClose(WebEngine webEngine) {\n+        load(new File(\"src\/test\/resources\/test\/html\/localstorage.html\"));\n+        submit(() -> {\n+            assertNotNull(webEngine.executeScript(\"localStorage;\"));\n+            getEngine().executeScript(\"window.close();\");\n+            assertNotNull(webEngine.executeScript(\"localStorage;\"));\n+        });\n+    }\n+\n+    @BeforeClass\n+    public static void beforeClass() throws IOException {\n+        PRE_LOCKED.mkdirs();\n+    }\n+\n+    @AfterClass\n+    public static void afterClass() throws IOException {\n+        deleteRecursively(LOCAL_STORAGE_DIR);\n+        deleteRecursively(PRE_LOCKED);\n+    }\n+\n+    @Test\n+    public void testLocalStorage() throws Exception {\n+        final WebEngine webEngine = getEngine();\n+        webEngine.setJavaScriptEnabled(true);\n+        webEngine.setUserDataDirectory(LOCAL_STORAGE_DIR);\n+        checkLocalStorageAfterWindowClose(webEngine);\n+    }\n+\n+    \/* test localstorage set data before window.close and check data after window.close *\/\n+    @Test\n+    public void testLocalStorageData() {\n+        final WebEngine webEngine = getEngine();\n+        webEngine.setJavaScriptEnabled(true);\n+        webEngine.setUserDataDirectory(LOCAL_STORAGE_DIR);\n+        load(new File(\"src\/test\/resources\/test\/html\/localstorage.html\"));\n+        submit(() -> {\n+            WebView view = getView();\n+            view.getEngine().executeScript(\"test_local_storage_set();\"); \/\/ set data\n+            getEngine().executeScript(\"window.close();\");\n+            \/\/get data\n+            String s = (String) view.getEngine().executeScript(\"document.getElementById('key').innerText;\");\n+            assertEquals(\"1001\", s);\n+        });\n+    }\n+\n+    @Test\n+    public void testLocalStorageSet() {\n+        final WebEngine webEngine = getEngine();\n+        webEngine.setJavaScriptEnabled(true);\n+        webEngine.setUserDataDirectory(LOCAL_STORAGE_DIR);\n+        load(new File(\"src\/test\/resources\/test\/html\/localstorage.html\"));\n+        submit(() -> {\n+            WebView view = getView();\n+            view.getEngine().executeScript(\"test_local_storage_set();\");\n+            String s = (String) view.getEngine().executeScript(\"document.getElementById('key').innerText;\");\n+            assertEquals(\"1001\", s);\n+        });\n+    }\n+\n+    @Test\n+    public void testLocalStoargeClear() {\n+        final WebEngine webEngine = getEngine();\n+        webEngine.setJavaScriptEnabled(true);\n+        webEngine.setUserDataDirectory(LOCAL_STORAGE_DIR);\n+        load(new File(\"src\/test\/resources\/test\/html\/localstorage.html\"));\n+        submit(() -> {\n+            WebView view = getView();\n+            view.getEngine().executeScript(\"test_local_storage_set();\"); \/\/ set data\n+            view.getEngine().executeScript(\"delete_items();\");\n+            String s = (String) view.getEngine().executeScript(\"document.getElementById('key').innerText;\");\n+            boolean res = (s == null || s.length() == 0);\n+            assertTrue(res);\n+        });\n+    }\n+}\n\\ No newline at end of file\n","filename":"modules\/javafx.web\/src\/test\/java\/test\/javafx\/scene\/web\/LocalStorageTest.java","additions":149,"deletions":0,"binary":false,"changes":149,"status":"added"},{"patch":"@@ -0,0 +1,27 @@\n+<html>\n+<body>\n+\n+<h2>The localStorage Property Test<\/h2>\n+\n+<p id=\"key\"><\/p>\n+\n+<script>\n+\n+ \/\/ Test set and get Items API\n+ function test_local_storage_set() {\n+   \/\/ Set Item\n+   localStorage.setItem(\"key\", \"1001\");\n+   \/\/ getItem\n+   document.getElementById(\"key\").innerHTML = localStorage.getItem(\"key\");\n+ }\n+\n+ \/\/ test clear() API\n+ function delete_items() {\n+  localStorage.clear();\n+  document.getElementById(\"key\").innerHTML = localStorage.getItem(\"key\");\n+ }\n+\n+<\/script>\n+\n+<\/body>\n+<\/html>\n","filename":"modules\/javafx.web\/src\/test\/resources\/test\/html\/localstorage.html","additions":27,"deletions":0,"binary":false,"changes":27,"status":"added"}]}