{"files":[{"patch":"@@ -32,0 +32,1 @@\n+#include <X11\/XKBlib.h>\n@@ -348,0 +349,19 @@\n+\/*\n+ * Function to determine whether the Xkb extention is available. This is a\n+ * precaution against X protocol errors, although it should be available on all\n+ * Linux systems.\n+ *\/\n+\n+static Bool xkbInitialized = False;\n+static Bool xkbAvailable = False;\n+\n+static Bool isXkbAvailable(Display *display) {\n+    if (!xkbInitialized) {\n+        int xkbMajor = XkbMajorVersion;\n+        int xkbMinor = XkbMinorVersion;\n+        xkbAvailable = XkbQueryExtension(display, NULL, NULL, NULL, &xkbMajor, &xkbMinor);\n+        xkbInitialized = True;\n+    }\n+    return xkbAvailable;\n+}\n+\n@@ -356,3 +376,6 @@\n-#ifdef GLASS_GTK3\n-    GdkKeymap *keyMap = gdk_keymap_get_default();\n-    gboolean lockState = FALSE;\n+    Display* display = gdk_x11_display_get_xdisplay(gdk_display_get_default());\n+    if (!isXkbAvailable(display)) {\n+        return com_sun_glass_events_KeyEvent_KEY_LOCK_UNKNOWN;\n+    }\n+\n+    Atom atom = None;\n@@ -361,1 +384,1 @@\n-            lockState = gdk_keymap_get_caps_lock_state(keyMap);\n+            atom = XInternAtom(display, \"Caps Lock\", True);\n@@ -365,1 +388,1 @@\n-            lockState = gdk_keymap_get_num_lock_state(keyMap);\n+            atom = XInternAtom(display, \"Num Lock\", True);\n@@ -367,0 +390,1 @@\n+    }\n@@ -368,2 +392,2 @@\n-        default:\n-            return com_sun_glass_events_KeyEvent_KEY_LOCK_UNKNOWN;\n+    if (atom == None) {\n+        return com_sun_glass_events_KeyEvent_KEY_LOCK_UNKNOWN;\n@@ -371,5 +395,10 @@\n-    return lockState ? com_sun_glass_events_KeyEvent_KEY_LOCK_ON\n-                     : com_sun_glass_events_KeyEvent_KEY_LOCK_OFF;\n-#else \/* GLASS_GTK3 *\/\n-    \/\/ Caps Lock detection is not reliable in GTK 2, and Num Lock detection is\n-    \/\/ only available in GTK 3.\n+\n+    Bool isLocked = False;\n+    if (XkbGetNamedIndicator(display, atom, NULL, &isLocked, NULL, NULL)) {\n+        if (isLocked) {\n+            return com_sun_glass_events_KeyEvent_KEY_LOCK_ON;\n+        } else {\n+            return com_sun_glass_events_KeyEvent_KEY_LOCK_OFF;\n+        }\n+    }\n+\n@@ -377,1 +406,0 @@\n-#endif \/* GLASS_GTK3 *\/\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/gtk\/glass_key.cpp","additions":41,"deletions":13,"binary":false,"changes":54,"status":"modified"},{"patch":"@@ -103,4 +103,2 @@\n-            \/\/ A result should always be present on Windows and Mac\n-            if (PlatformUtil.isWindows() || PlatformUtil.isMac()) {\n-                assertTrue(capsLockState.isPresent());\n-            }\n+            \/\/ A result should always be present\n+            assertTrue(capsLockState.isPresent());\n@@ -116,2 +114,2 @@\n-            \/\/ A result should always be present on Windows and never on Mac\n-            if (PlatformUtil.isWindows()) {\n+            \/\/ A result should always be present on Windows and Linux\n+            if (PlatformUtil.isWindows() || PlatformUtil.isLinux()) {\n@@ -120,0 +118,1 @@\n+            \/\/ A result should never be present on Mac\n","filename":"tests\/system\/src\/test\/java\/test\/robot\/javafx\/application\/KeyLockedTest.java","additions":5,"deletions":6,"binary":false,"changes":11,"status":"modified"}]}