{"files":[{"patch":"@@ -858,0 +858,2 @@\n+            int oldIndex = computeCurrentIndex(oldCount);\n+            double oldOffset = computeViewportOffset(getPosition(), oldCount);\n@@ -860,1 +862,1 @@\n-            recalculateEstimatedSize();\n+            recalculateAndImproveEstimatedSize(DEFAULT_IMPROVEMENT, oldIndex, oldOffset);\n@@ -863,0 +865,2 @@\n+            double boff = computeBaseOffset(oldIndex);\n+            absoluteOffset = boff + oldOffset;\n@@ -2894,0 +2898,4 @@\n+        return computeViewportOffset(position, getCellCount());\n+    }\n+\n+    private double computeViewportOffset(double position, int localCellCount) {\n@@ -2896,1 +2904,1 @@\n-        double estSize = estimatedSize \/ getCellCount();\n+        double estSize = estimatedSize \/ localCellCount;\n@@ -2902,1 +2910,1 @@\n-        for (int i = 0; i < getCellCount(); i++) {\n+        for (int i = 0; i < localCellCount; i++) {\n@@ -2981,0 +2989,12 @@\n+    private double computeBaseOffset(int index) {\n+        double baseOffset = 0d;\n+        int currentCellCount = getCellCount();\n+        double estSize = estimatedSize \/ currentCellCount;\n+        for (int i = 0; i < index; i++) {\n+            double nextSize = getCellSize(i);\n+            if (nextSize < 0) nextSize = estSize;\n+            baseOffset += nextSize;\n+        }\n+        return baseOffset;\n+    }\n+\n@@ -2982,0 +3002,4 @@\n+        return computeCurrentIndex(getCellCount());\n+    }\n+\n+    private int computeCurrentIndex(int currentCellCount) {\n@@ -2983,1 +3007,0 @@\n-        int currentCellCount = getCellCount();\n","filename":"modules\/javafx.controls\/src\/main\/java\/javafx\/scene\/control\/skin\/VirtualFlow.java","additions":27,"deletions":4,"binary":false,"changes":31,"status":"modified"},{"patch":"@@ -100,1 +100,1 @@\n-                return flow.isVertical() ? (c.getIndex() == 29 ? 200 : 100) : (c.getIndex() == 29 ? 100 : 25);\n+                return flow.isVertical() ? (getIndex() == 29 ? 200 : 100) : (getIndex() == 29 ? 100 : 25);\n@@ -115,1 +115,1 @@\n-                return flow.isVertical() ? (c.getIndex() == 29 ? 100 : 25) : (c.getIndex() == 29 ? 200 : 100);\n+                return flow.isVertical() ? (getIndex() == 29 ? 100 : 25) : (getIndex() == 29 ? 200 : 100);\n@@ -1225,0 +1225,32 @@\n+    @Test\n+    \/\/ see JDK-8306447\n+    public void testPositionCellRemainsConstantWithManyItems() {\n+        flow.setVertical(true);\n+        flow.setCellCount(100);\n+        flow.resize(300, 300);\n+        \/\/ scroll up and down, to populate the size cache\n+        for (int i = 0; i < 20; i++) {\n+            flow.scrollPixels(1);\n+            pulse();\n+            flow.scrollPixels(-1);\n+            pulse();\n+        }\n+        flow.scrollPixels(911);\n+        pulse();\n+\n+        IndexedCell vc = flow.getCell(33);\n+        double cellPosition = flow.getCellPosition(vc);\n+        \/\/ cell 33 should be at (32 x 25 + 1 x 100) - 911 = -11\n+        assertEquals(\"Wrong first cell position\", -11d, cellPosition, 0d);\n+\n+        for (int i = 1; i < 10; i++) {\n+            flow.setCellCount(100 + i);\n+            pulse();\n+            vc = flow.getCell(33);\n+            cellPosition = flow.getCellPosition(vc);\n+            assertEquals(\"First cell position changed after adding \" + i + \" cells on large irregular list\", -11d, cellPosition, 0d);\n+        }\n+    }\n+\n+\n+\n","filename":"modules\/javafx.controls\/src\/test\/java\/test\/javafx\/scene\/control\/skin\/VirtualFlowTest.java","additions":34,"deletions":2,"binary":false,"changes":36,"status":"modified"}]}