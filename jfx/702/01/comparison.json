{"files":[{"patch":"@@ -188,1 +188,94 @@\n-void JavaKeyToWindowsKey(jint jkey, UINT &vkey, UINT &modifiers)\n+static UINT const oemKeys[] = {\n+    VK_OEM_1,\n+    VK_OEM_PLUS,\n+    VK_OEM_COMMA,\n+    VK_OEM_MINUS,\n+    VK_OEM_PERIOD,\n+    VK_OEM_2,\n+    VK_OEM_3,\n+    VK_OEM_4,\n+    VK_OEM_5,\n+    VK_OEM_6,\n+    VK_OEM_7,\n+    VK_OEM_8,\n+    VK_OEM_102\n+};\n+static constexpr size_t numOEMKeys = sizeof(oemKeys) \/ sizeof(oemKeys[0]);\n+\n+static BOOL isOEMKey(UINT vkey)\n+{\n+    for (size_t i = 0; i < numOEMKeys; ++i)\n+    {\n+        if (oemKeys[i] == vkey)\n+            return true;\n+    }\n+    return false;\n+}\n+\n+jint OEMCharToJavaKey(UINT ch, bool deadKey)\n+{\n+    jint jKeyCode = com_sun_glass_events_KeyEvent_VK_UNDEFINED;\n+    if (deadKey)\n+    {\n+        switch (ch) {\n+            case L'`':   jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_GRAVE; break;\n+            case L'\\'':  jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_ACUTE; break;\n+            case 0x00B4: jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_ACUTE; break;\n+            case L'^':   jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_CIRCUMFLEX; break;\n+            case L'~':   jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_TILDE; break;\n+            case 0x02DC: jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_TILDE; break;\n+            case 0x00AF: jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_MACRON; break;\n+            case 0x02D8: jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_BREVE; break;\n+            case 0x02D9: jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_ABOVEDOT; break;\n+            case L'\"':   jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_DIAERESIS; break;\n+            case 0x00A8: jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_DIAERESIS; break;\n+            case 0x02DA: jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_ABOVERING; break;\n+            case 0x02DD: jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_DOUBLEACUTE; break;\n+            case 0x02C7: jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_CARON; break;            \/\/ aka hacek\n+            case L',':   jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_CEDILLA; break;\n+            case 0x00B8: jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_CEDILLA; break;\n+            case 0x02DB: jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_OGONEK; break;\n+            case 0x037A: jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_IOTA; break;             \/\/ ASCII ???\n+            case 0x309B: jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_VOICED_SOUND; break;\n+            case 0x309C: jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_SEMIVOICED_SOUND; break;\n+        }\n+    }\n+    else\n+    {\n+        switch (ch) {\n+            case L'!':   jKeyCode = com_sun_glass_events_KeyEvent_VK_EXCLAMATION; break;\n+            case L'\"':   jKeyCode = com_sun_glass_events_KeyEvent_VK_DOUBLE_QUOTE; break;\n+            case L'#':   jKeyCode = com_sun_glass_events_KeyEvent_VK_NUMBER_SIGN; break;\n+            case L'$':   jKeyCode = com_sun_glass_events_KeyEvent_VK_DOLLAR; break;\n+            case L'&':   jKeyCode = com_sun_glass_events_KeyEvent_VK_AMPERSAND; break;\n+            case L'\\'':  jKeyCode = com_sun_glass_events_KeyEvent_VK_QUOTE; break;\n+            case L'(':   jKeyCode = com_sun_glass_events_KeyEvent_VK_LEFT_PARENTHESIS; break;\n+            case L')':   jKeyCode = com_sun_glass_events_KeyEvent_VK_RIGHT_PARENTHESIS; break;\n+            case L'*':   jKeyCode = com_sun_glass_events_KeyEvent_VK_ASTERISK; break;\n+            case L'+':   jKeyCode = com_sun_glass_events_KeyEvent_VK_PLUS; break;\n+            case L',':   jKeyCode = com_sun_glass_events_KeyEvent_VK_COMMA; break;\n+            case L'-':   jKeyCode = com_sun_glass_events_KeyEvent_VK_MINUS; break;\n+            case L'.':   jKeyCode = com_sun_glass_events_KeyEvent_VK_PERIOD; break;\n+            case L'\/':   jKeyCode = com_sun_glass_events_KeyEvent_VK_SLASH; break;\n+            case L':':   jKeyCode = com_sun_glass_events_KeyEvent_VK_COLON; break;\n+            case L';':   jKeyCode = com_sun_glass_events_KeyEvent_VK_SEMICOLON; break;\n+            case L'<':   jKeyCode = com_sun_glass_events_KeyEvent_VK_LESS; break;\n+            case L'=':   jKeyCode = com_sun_glass_events_KeyEvent_VK_EQUALS; break;\n+            case L'>':   jKeyCode = com_sun_glass_events_KeyEvent_VK_GREATER; break;\n+            case L'@':   jKeyCode = com_sun_glass_events_KeyEvent_VK_AT; break;\n+            case L'[':   jKeyCode = com_sun_glass_events_KeyEvent_VK_OPEN_BRACKET; break;\n+            case L'\\\\':  jKeyCode = com_sun_glass_events_KeyEvent_VK_BACK_SLASH; break;\n+            case L']':   jKeyCode = com_sun_glass_events_KeyEvent_VK_CLOSE_BRACKET; break;\n+            case L'^':   jKeyCode = com_sun_glass_events_KeyEvent_VK_CIRCUMFLEX; break;\n+            case L'_':   jKeyCode = com_sun_glass_events_KeyEvent_VK_UNDERSCORE; break;\n+            case L'`':   jKeyCode = com_sun_glass_events_KeyEvent_VK_BACK_QUOTE; break;\n+            case L'{':   jKeyCode = com_sun_glass_events_KeyEvent_VK_BRACELEFT; break;\n+            case L'}':   jKeyCode = com_sun_glass_events_KeyEvent_VK_BRACERIGHT; break;\n+            case 0x00A1: jKeyCode = com_sun_glass_events_KeyEvent_VK_INV_EXCLAMATION; break;\n+            case 0x20A0: jKeyCode = com_sun_glass_events_KeyEvent_VK_EURO_SIGN; break;\n+        }\n+    }\n+    return jKeyCode;\n+}\n+\n+void JavaKeyToWindowsKey(jint jkey, UINT &vkey, UINT& modifiers)\n@@ -190,0 +283,6 @@\n+    vkey = 0;\n+    modifiers = 0;\n+\n+    if (jkey == com_sun_glass_events_KeyEvent_VK_UNDEFINED)\n+        return;\n+\n@@ -193,2 +292,1 @@\n-            modifiers = 0;\n-            return;\n+            break;\n@@ -198,2 +296,20 @@\n-    vkey = 0;\n-    modifiers = 0;\n+    if (!vkey || isOEMKey(vkey)) {\n+        \/\/ The table is missing entries for keys that don't appear on US\n+        \/\/ layouts, like KeyCode.PLUS. Even if we found a key it may be\n+        \/\/ an OEM key and the relationship between OEM keys and the\n+        \/\/ characters they generate is not fixed even for US English\n+        \/\/ layouts. So in these instances we search through the OEM keys\n+        \/\/ looking for the Java code.\n+        vkey = 0;\n+        for (size_t i = 0; i < numOEMKeys; ++i)\n+        {\n+            UINT ch = ::MapVirtualKey(oemKeys[i], 2);\n+            bool deadKey = (ch & 0x80000000);\n+            jint trialCode = OEMCharToJavaKey(LOWORD(ch), deadKey);\n+            if (trialCode == jkey)\n+            {\n+                vkey = oemKeys[i];\n+                break;\n+            }\n+        }\n+    }\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/win\/KeyTable.cpp","additions":121,"deletions":5,"binary":false,"changes":126,"status":"modified"},{"patch":"@@ -32,1 +32,1 @@\n-\n+jint OEMCharToJavaKey(UINT ch, bool deadKey);\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/win\/KeyTable.h","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -409,24 +409,1 @@\n-                switch (wChar[0]) {\n-                    case L'`':   jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_GRAVE; break;\n-                    case L'\\'':  jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_ACUTE; break;\n-                    case 0x00B4: jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_ACUTE; break;\n-                    case L'^':   jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_CIRCUMFLEX; break;\n-                    case L'~':   jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_TILDE; break;\n-                    case 0x02DC: jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_TILDE; break;\n-                    case 0x00AF: jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_MACRON; break;\n-                    case 0x02D8: jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_BREVE; break;\n-                    case 0x02D9: jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_ABOVEDOT; break;\n-                    case L'\"':   jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_DIAERESIS; break;\n-                    case 0x00A8: jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_DIAERESIS; break;\n-                    case 0x02DA: jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_ABOVERING; break;\n-                    case 0x02DD: jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_DOUBLEACUTE; break;\n-                    case 0x02C7: jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_CARON; break;            \/\/ aka hacek\n-                    case L',':   jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_CEDILLA; break;\n-                    case 0x00B8: jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_CEDILLA; break;\n-                    case 0x02DB: jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_OGONEK; break;\n-                    case 0x037A: jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_IOTA; break;             \/\/ ASCII ???\n-                    case 0x309B: jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_VOICED_SOUND; break;\n-                    case 0x309C: jKeyCode = com_sun_glass_events_KeyEvent_VK_DEAD_SEMIVOICED_SOUND; break;\n-\n-                    default:     jKeyCode = com_sun_glass_events_KeyEvent_VK_UNDEFINED; break;\n-                };\n+                jKeyCode = OEMCharToJavaKey(wChar[0], true);\n@@ -434,34 +411,1 @@\n-                switch (wChar[0]) {\n-                    case L'!':   jKeyCode = com_sun_glass_events_KeyEvent_VK_EXCLAMATION; break;\n-                    case L'\"':   jKeyCode = com_sun_glass_events_KeyEvent_VK_DOUBLE_QUOTE; break;\n-                    case L'#':   jKeyCode = com_sun_glass_events_KeyEvent_VK_NUMBER_SIGN; break;\n-                    case L'$':   jKeyCode = com_sun_glass_events_KeyEvent_VK_DOLLAR; break;\n-                    case L'&':   jKeyCode = com_sun_glass_events_KeyEvent_VK_AMPERSAND; break;\n-                    case L'\\'':  jKeyCode = com_sun_glass_events_KeyEvent_VK_QUOTE; break;\n-                    case L'(':   jKeyCode = com_sun_glass_events_KeyEvent_VK_LEFT_PARENTHESIS; break;\n-                    case L')':   jKeyCode = com_sun_glass_events_KeyEvent_VK_RIGHT_PARENTHESIS; break;\n-                    case L'*':   jKeyCode = com_sun_glass_events_KeyEvent_VK_ASTERISK; break;\n-                    case L'+':   jKeyCode = com_sun_glass_events_KeyEvent_VK_PLUS; break;\n-                    case L',':   jKeyCode = com_sun_glass_events_KeyEvent_VK_COMMA; break;\n-                    case L'-':   jKeyCode = com_sun_glass_events_KeyEvent_VK_MINUS; break;\n-                    case L'.':   jKeyCode = com_sun_glass_events_KeyEvent_VK_PERIOD; break;\n-                    case L'\/':   jKeyCode = com_sun_glass_events_KeyEvent_VK_SLASH; break;\n-                    case L':':   jKeyCode = com_sun_glass_events_KeyEvent_VK_COLON; break;\n-                    case L';':   jKeyCode = com_sun_glass_events_KeyEvent_VK_SEMICOLON; break;\n-                    case L'<':   jKeyCode = com_sun_glass_events_KeyEvent_VK_LESS; break;\n-                    case L'=':   jKeyCode = com_sun_glass_events_KeyEvent_VK_EQUALS; break;\n-                    case L'>':   jKeyCode = com_sun_glass_events_KeyEvent_VK_GREATER; break;\n-                    case L'@':   jKeyCode = com_sun_glass_events_KeyEvent_VK_AT; break;\n-                    case L'[':   jKeyCode = com_sun_glass_events_KeyEvent_VK_OPEN_BRACKET; break;\n-                    case L'\\\\':  jKeyCode = com_sun_glass_events_KeyEvent_VK_BACK_SLASH; break;\n-                    case L']':   jKeyCode = com_sun_glass_events_KeyEvent_VK_CLOSE_BRACKET; break;\n-                    case L'^':   jKeyCode = com_sun_glass_events_KeyEvent_VK_CIRCUMFLEX; break;\n-                    case L'_':   jKeyCode = com_sun_glass_events_KeyEvent_VK_UNDERSCORE; break;\n-                    case L'`':   jKeyCode = com_sun_glass_events_KeyEvent_VK_BACK_QUOTE; break;\n-                    case L'{':   jKeyCode = com_sun_glass_events_KeyEvent_VK_BRACELEFT; break;\n-                    case L'}':   jKeyCode = com_sun_glass_events_KeyEvent_VK_BRACERIGHT; break;\n-                    case 0x00A1: jKeyCode = com_sun_glass_events_KeyEvent_VK_INV_EXCLAMATION; break;\n-                    case 0x20A0: jKeyCode = com_sun_glass_events_KeyEvent_VK_EURO_SIGN; break;\n-\n-                    default:     jKeyCode = com_sun_glass_events_KeyEvent_VK_UNDEFINED; break;\n-                }\n+                jKeyCode = OEMCharToJavaKey(wChar[0], false);\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/win\/ViewContainer.cpp","additions":2,"deletions":58,"binary":false,"changes":60,"status":"modified"}]}