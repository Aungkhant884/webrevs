{"files":[{"patch":"@@ -151,0 +151,2 @@\n+    private static final Object LOCK = new Object();\n+\n@@ -408,0 +410,16 @@\n+    private EmbeddedSceneInterface getScenePeer() {\n+        EmbeddedSceneInterface lScenePeer;\n+        synchronized(LOCK) {\n+            lScenePeer = scenePeer;\n+        }\n+        return lScenePeer;\n+    }\n+\n+    private EmbeddedStageInterface getStagePeer() {\n+        EmbeddedStageInterface lStagePeer;\n+        synchronized(LOCK) {\n+            lStagePeer = stagePeer;\n+        }\n+        return lStagePeer;\n+    }\n+\n@@ -409,1 +427,2 @@\n-        if (scenePeer == null || !isFxEnabled()) {\n+        EmbeddedSceneInterface lScenePeer = getScenePeer();\n+        if (lScenePeer == null || !isFxEnabled()) {\n@@ -458,1 +477,1 @@\n-            scenePeer.scrollEvent(AbstractEvents.MOUSEEVENT_VERTICAL_WHEEL,\n+            lScenePeer.scrollEvent(AbstractEvents.MOUSEEVENT_VERTICAL_WHEEL,\n@@ -469,1 +488,1 @@\n-            scenePeer.mouseEvent(\n+            lScenePeer.mouseEvent(\n@@ -483,1 +502,1 @@\n-            scenePeer.menuEvent(e.getX(), e.getY(), fxXOnScreen, fxYOnScreen, false);\n+            lScenePeer.menuEvent(e.getX(), e.getY(), fxXOnScreen, fxYOnScreen, false);\n@@ -503,1 +522,2 @@\n-                if (stagePeer != null) {\n+                EmbeddedStageInterface lStagePeer = getStagePeer();\n+                if (lStagePeer != null) {\n@@ -505,1 +525,1 @@\n-                    stagePeer.setFocused(true, focusCause);\n+                    lStagePeer.setFocused(true, focusCause);\n@@ -542,1 +562,2 @@\n-        if (scenePeer == null || !isFxEnabled()) {\n+        EmbeddedSceneInterface lScenePeer = getScenePeer();\n+        if (lScenePeer == null || !isFxEnabled()) {\n@@ -550,1 +571,1 @@\n-        scenePeer.keyEvent(\n+        lScenePeer.keyEvent(\n@@ -570,2 +591,4 @@\n-        if (stagePeer != null) {\n-            stagePeer.setSize(pWidth, pHeight);\n+        EmbeddedSceneInterface lScenePeer = getScenePeer();\n+        EmbeddedStageInterface lStagePeer = getStagePeer();\n+        if (lStagePeer != null) {\n+            lStagePeer.setSize(pWidth, pHeight);\n@@ -573,2 +596,2 @@\n-        if (scenePeer != null) {\n-            scenePeer.setSize(pWidth, pHeight);\n+        if (lScenePeer != null) {\n+            lScenePeer.setSize(pWidth, pHeight);\n@@ -609,0 +632,1 @@\n+        EmbeddedSceneInterface lScenePeer = getScenePeer();\n@@ -636,2 +660,2 @@\n-            if (scenePeer != null) {\n-                scenePeer.setPixelScaleFactors((float) newScaleFactorX,\n+            if (lScenePeer != null) {\n+                lScenePeer.setPixelScaleFactors((float) newScaleFactorX,\n@@ -661,1 +685,2 @@\n-        if (stagePeer == null) {\n+        EmbeddedStageInterface lStagePeer = getStagePeer();\n+        if (lStagePeer == null) {\n@@ -665,1 +690,1 @@\n-        stagePeer.setLocation(screenX, screenY);\n+        lStagePeer.setLocation(screenX, screenY);\n@@ -698,1 +723,2 @@\n-        if ((stage == null) || (stagePeer == null) || !isFxEnabled()) {\n+        EmbeddedStageInterface lStagePeer = getStagePeer();\n+        if ((stage == null) || (lStagePeer == null) || !isFxEnabled()) {\n@@ -713,1 +739,1 @@\n-        stagePeer.setFocused(focused, focusCause);\n+        lStagePeer.setFocused(focused, focusCause);\n@@ -732,1 +758,2 @@\n-        if (scenePeer == null || pWidth <= 0 || pHeight <= 0) {\n+        EmbeddedSceneInterface lScenePeer = getScenePeer();\n+        if (lScenePeer == null || pWidth <= 0 || pHeight <= 0) {\n@@ -740,1 +767,1 @@\n-                                             scenePeer.getPixelFormat(), null, false));\n+                                             lScenePeer.getPixelFormat(), null, false));\n@@ -767,0 +794,1 @@\n+        EmbeddedSceneInterface lScenePeer = getScenePeer();\n@@ -773,1 +801,1 @@\n-        scenePeer.inputMethodEvent(\n+        lScenePeer.inputMethodEvent(\n@@ -791,1 +819,2 @@\n-        if (scenePeer == null) {\n+        EmbeddedSceneInterface lScenePeer = getScenePeer();\n+        if (lScenePeer == null) {\n@@ -803,1 +832,1 @@\n-        if (scenePeer != null && !scenePeer.getPixels(buf, pWidth, pHeight)) {\n+        if (!lScenePeer.getPixels(buf, pWidth, pHeight)) {\n@@ -832,1 +861,1 @@\n-                scenePeer.setPixelScaleFactors((float) newScaleFactorX,\n+                lScenePeer.setPixelScaleFactors((float) newScaleFactorX,\n@@ -856,1 +885,2 @@\n-        if (isPreferredSizeSet() || scenePeer == null) {\n+        EmbeddedSceneInterface lScenePeer = getScenePeer();\n+        if (isPreferredSizeSet() || lScenePeer == null) {\n@@ -889,1 +919,2 @@\n-                if (JFXPanel.this.stagePeer != null &&\n+                EmbeddedStageInterface lStagePeer = getStagePeer();\n+                if (lStagePeer != null &&\n@@ -893,1 +924,1 @@\n-                    JFXPanel.this.stagePeer.focusUngrab();\n+                    lStagePeer.focusUngrab();\n@@ -907,1 +938,2 @@\n-                        if (JFXPanel.this.stagePeer != null) {\n+                        EmbeddedStageInterface lStagePeer = getStagePeer();\n+                        if (lStagePeer != null) {\n@@ -915,1 +947,1 @@\n-                            JFXPanel.this.stagePeer.focusUngrab();\n+                            lStagePeer.focusUngrab();\n@@ -951,1 +983,1 @@\n-        EmbeddedSceneInterface scene = scenePeer;\n+        EmbeddedSceneInterface scene = getScenePeer();\n@@ -1001,2 +1033,6 @@\n-            stagePeer = embeddedStage;\n-            if (stagePeer == null) {\n+            EmbeddedStageInterface lStagePeer;\n+            synchronized(LOCK) {\n+                lStagePeer = stagePeer;\n+            }\n+            lStagePeer = embeddedStage;\n+            if (lStagePeer == null) {\n@@ -1006,1 +1042,4 @@\n-                stagePeer.setSize(pWidth, pHeight);\n+                lStagePeer.setSize(pWidth, pHeight);\n+            }\n+            synchronized(LOCK) {\n+                stagePeer = lStagePeer;\n@@ -1009,2 +1048,6 @@\n-                if (stagePeer != null && JFXPanel.this.isFocusOwner()) {\n-                    stagePeer.setFocused(true, AbstractEvents.FOCUSEVENT_ACTIVATED);\n+                EmbeddedStageInterface tmpStagePeer;\n+                synchronized(LOCK) {\n+                    tmpStagePeer = stagePeer;\n+                }\n+                if (tmpStagePeer != null && JFXPanel.this.isFocusOwner()) {\n+                    tmpStagePeer.setFocused(true, AbstractEvents.FOCUSEVENT_ACTIVATED);\n@@ -1018,1 +1061,5 @@\n-            if (scenePeer == embeddedScene) {\n+            EmbeddedSceneInterface lScenePeer;\n+            synchronized(LOCK) {\n+                lScenePeer = scenePeer;\n+            }\n+            if (lScenePeer == embeddedScene) {\n@@ -1021,2 +1068,2 @@\n-            scenePeer = embeddedScene;\n-            if (scenePeer == null) {\n+            lScenePeer = embeddedScene;\n+            if (lScenePeer == null) {\n@@ -1032,1 +1079,5 @@\n-                scenePeer.setSize(pWidth, pHeight);\n+                lScenePeer.setSize(pWidth, pHeight);\n+            }\n+            lScenePeer.setPixelScaleFactors((float) scaleFactorX, (float) scaleFactorY);\n+            synchronized(LOCK) {\n+                scenePeer = lScenePeer;\n@@ -1034,1 +1085,0 @@\n-            scenePeer.setPixelScaleFactors((float) scaleFactorX, (float) scaleFactorY);\n@@ -1037,1 +1087,5 @@\n-                dnd = new SwingDnD(JFXPanel.this, scenePeer);\n+                EmbeddedSceneInterface tmpScenePeer;\n+                synchronized(LOCK) {\n+                    tmpScenePeer = scenePeer;\n+                }\n+                dnd = new SwingDnD(JFXPanel.this, tmpScenePeer);\n@@ -1039,2 +1093,2 @@\n-                if (scenePeer != null) {\n-                    scenePeer.setDragStartListener(dnd.getDragStartListener());\n+                if (tmpScenePeer != null) {\n+                    tmpScenePeer.setDragStartListener(dnd.getDragStartListener());\n","filename":"modules\/javafx.swing\/src\/main\/java\/javafx\/embed\/swing\/JFXPanel.java","additions":97,"deletions":43,"binary":false,"changes":140,"status":"modified"},{"patch":"@@ -0,0 +1,126 @@\n+\/*\n+ * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+package test.javafx.embed.swing;\n+\n+import javafx.application.Application;\n+import javafx.application.Platform;\n+import javafx.embed.swing.JFXPanel;\n+import javafx.scene.Scene;\n+import javafx.scene.web.WebView;\n+import javafx.stage.Stage;\n+\n+import javax.swing.JFrame;\n+import javax.swing.SwingUtilities;\n+import javax.swing.WindowConstants;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.CountDownLatch;\n+\n+import org.junit.After;\n+import org.junit.AfterClass;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+import test.util.Util;\n+\n+public class JFXPanelNPETest {\n+    private static WebView webView;\n+    private static JFrame jFrame;\n+    private static JFXPanel contentPane;\n+    private static AtomicBoolean failure;\n+    \/\/ Used to launch the application before running any test\n+    private static final CountDownLatch launchLatch = new CountDownLatch(1);\n+\n+    \/\/ Application class. An instance is created and initialized before running\n+    \/\/ the first test, and it lives through the execution of all tests.\n+    public static class MyApp extends Application {\n+        @Override\n+        public void start(Stage primaryStage) throws Exception {\n+            Platform.setImplicitExit(false);\n+            Assert.assertTrue(Platform.isFxApplicationThread());\n+            Assert.assertNotNull(primaryStage);\n+\n+            launchLatch.countDown();\n+        }\n+    }\n+\n+    @BeforeClass\n+    public static void doSetupOnce() throws Exception {\n+        Util.launch(launchLatch, MyApp.class);\n+        Assert.assertEquals(0, launchLatch.getCount());\n+    }\n+\n+    @AfterClass\n+    public static void doTeardownOnce() {\n+        Util.shutdown();\n+    }\n+\n+    @After\n+    public void doCleanup() {\n+        if (jFrame != null) {\n+            SwingUtilities.invokeLater(() -> jFrame.dispose());\n+        }\n+    }\n+\n+    @Test\n+    public void testSceneNPE() throws Exception {\n+        failure = new AtomicBoolean(false);\n+        Thread.setDefaultUncaughtExceptionHandler(new Thread.UncaughtExceptionHandler() {\n+            @Override\n+            public void uncaughtException(Thread t, Throwable e) {\n+                e.printStackTrace();\n+                failure.set(true);\n+            }\n+        });\n+        SwingUtilities.invokeAndWait(JFXPanelNPETest::createUI);\n+        for (int i = 0; i < 300; i++) {\n+            SwingUtilities.invokeLater(contentPane::repaint);\n+            Platform.runLater(() -> contentPane.setScene(null));\n+            Thread.sleep(100);\n+            Platform.runLater(() -> contentPane.setScene(webView.getScene()));\n+            Thread.sleep(100);\n+        }\n+        System.out.println(\"failure = \" + failure.get());\n+        Assert.assertFalse(failure.get());\n+    }\n+\n+    protected static void createUI() {\n+        jFrame = new JFrame();\n+        contentPane = new JFXPanel();\n+        Platform.runLater(() -> fx(contentPane));\n+        jFrame.setContentPane(contentPane);\n+        jFrame.setDefaultCloseOperation(WindowConstants.EXIT_ON_CLOSE);\n+        jFrame.setSize(400,400);\n+        jFrame.setVisible(true);\n+    }\n+\n+    private static void fx(final JFXPanel contentPane) {\n+        webView = new WebView();\n+        final var engine = webView.getEngine();\n+        engine.loadContent(\"hello!\");\n+        contentPane.setScene(new Scene(webView));\n+    }\n+}\n+\n","filename":"tests\/system\/src\/test\/java\/test\/javafx\/embed\/swing\/JFXPanelNPETest.java","additions":126,"deletions":0,"binary":false,"changes":126,"status":"added"}]}