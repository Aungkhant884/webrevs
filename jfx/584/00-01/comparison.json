{"files":[{"patch":"@@ -406,0 +406,3 @@\n+    private final Map<TKPulseListener,AccessControlContext> cleanupListeners =\n+            new WeakHashMap<TKPulseListener,AccessControlContext>();\n+    @SuppressWarnings(\"removal\")\n@@ -440,0 +443,2 @@\n+        final Map<TKPulseListener,AccessControlContext> cleanupList =\n+                new WeakHashMap<TKPulseListener,AccessControlContext>();\n@@ -445,0 +450,2 @@\n+            cleanupList.putAll(cleanupListeners);\n+            cleanupListeners.clear();\n@@ -455,0 +462,3 @@\n+        for (@SuppressWarnings(\"removal\") Map.Entry<TKPulseListener,AccessControlContext> entry : cleanupList.entrySet()) {\n+            runPulse(entry.getKey(), entry.getValue());\n+        }\n@@ -506,0 +516,5 @@\n+    public void addCleanupListener(TKPulseListener listener) {\n+        AccessControlContext acc = AccessController.getContext();\n+        cleanupListeners.put(listener,acc);\n+    }\n+\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/javafx\/tk\/Toolkit.java","additions":15,"deletions":0,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -548,0 +548,1 @@\n+            checkCleanDirtyNodes();\n@@ -721,0 +722,15 @@\n+    private boolean cleanupAdded = false;\n+    private TKPulseListener cleanupListener = () -> {\n+        cleanupAdded = false;\n+        \/\/ JDK-8269907 - This is important, to avoid memoryleaks in dirtyNodes and Parent.removed\n+        scenePulseListener.synchronizeSceneNodes();\n+    };\n+    private void checkCleanDirtyNodes() {\n+        if(!cleanupAdded) {\n+            if((window.get() == null || !window.get().isShowing()) && dirtyNodesSize > 0) {\n+                Toolkit.getToolkit().addCleanupListener(cleanupListener);\n+                cleanupAdded = true;\n+            }\n+        }\n+    }\n+\n@@ -4103,11 +4119,0 @@\n-        private void checkCleanDirtyNodes() {\n-            if(window == null || !window.get().isShowing()) {\n-                setAllowPGAccess(true);\n-                if(Scene.this.dirtyNodes != null) {\n-                    scenePulseListener.syncAll(getRoot()); \/\/ clear removedList in Parent\n-                }\n-                Scene.this.dirtyNodes = null;\n-                setAllowPGAccess(false);\n-            }\n-        }\n-\n","filename":"modules\/javafx.graphics\/src\/main\/java\/javafx\/scene\/Scene.java","additions":16,"deletions":11,"binary":false,"changes":27,"status":"modified"}]}