{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2010, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2010, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -31,1 +31,1 @@\n-\n+import javafx.beans.WeakInvalidationListener;\n@@ -51,2 +51,0 @@\n-\n-import com.sun.javafx.scene.control.ListenerHelper;\n@@ -101,3 +99,1 @@\n-        ListenerHelper lh = ListenerHelper.get(this);\n-\n-        lh.addChangeListener(control.indexProperty(), (ev) -> {\n+        control.indexProperty().addListener(new WeakInvalidationListener((x) -> {\n@@ -105,1 +101,1 @@\n-        });\n+        }));\n@@ -107,1 +103,1 @@\n-        lh.addChangeListener(control.treeItemProperty(), (ev) -> {\n+        control.treeItemProperty().addListener(new WeakInvalidationListener((x) -> {\n@@ -112,1 +108,1 @@\n-        });\n+        }));\n@@ -119,1 +115,0 @@\n-        ListenerHelper lh = ListenerHelper.get(this);\n@@ -122,1 +117,1 @@\n-            lh.addInvalidationListener(getSkinnable().treeTableViewProperty(), (ev) -> {\n+            getSkinnable().treeTableViewProperty().addListener(new WeakInvalidationListener((x) -> {\n@@ -125,1 +120,1 @@\n-            });\n+            }));\n@@ -127,1 +122,1 @@\n-            lh.addChangeListener(treeTableView.treeColumnProperty(), (ev) -> {\n+            treeTableView.treeColumnProperty().addListener(new WeakInvalidationListener((x) -> {\n@@ -132,2 +127,4 @@\n-                getSkinnable().requestLayout();\n-            });\n+                if (getSkinnable() != null) {\n+                    getSkinnable().requestLayout();\n+                }\n+            }));\n@@ -137,1 +134,1 @@\n-                lh.addChangeListener(fixedCellSizeProperty, (ev) -> {\n+                fixedCellSizeProperty.addListener(new WeakInvalidationListener((x) -> {\n@@ -140,1 +137,1 @@\n-                });\n+                }));\n@@ -150,1 +147,3 @@\n-                    lh.addChangeListener(getVirtualFlow().widthProperty(), (ev) -> treeTableView.requestLayout());\n+                    getVirtualFlow().widthProperty().addListener(new WeakInvalidationListener((x) -> {\n+                        treeTableView.requestLayout();\n+                    }));\n@@ -335,1 +334,1 @@\n-        treeItem = getSkinnable().getTreeItem();\n+        treeItem = (getSkinnable() == null) ? null : getSkinnable().getTreeItem();\n","filename":"modules\/javafx.controls\/src\/main\/java\/javafx\/scene\/control\/skin\/TreeTableRowSkin.java","additions":19,"deletions":20,"binary":false,"changes":39,"status":"modified"},{"patch":"@@ -28,1 +28,5 @@\n-import com.sun.javafx.tk.Toolkit;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+import java.lang.ref.WeakReference;\n@@ -47,0 +51,1 @@\n+import com.sun.javafx.tk.Toolkit;\n@@ -50,5 +55,1 @@\n-\n-import static org.junit.jupiter.api.Assertions.assertNotEquals;\n-import static org.junit.jupiter.api.Assertions.assertTrue;\n-import static org.junit.jupiter.api.Assertions.assertNotNull;\n-import static org.junit.jupiter.api.Assertions.assertEquals;\n+import test.util.memory.JMemoryBuddy;\n@@ -211,4 +212,4 @@\n-        int top = 10;\n-        int right = 20;\n-        int bottom = 30;\n-        int left = 40;\n+        int top = 11;\n+        int right = 23;\n+        int bottom = 37;\n+        int left = 49;\n@@ -218,1 +219,2 @@\n-        treeTableView.setFixedCellSize(24);\n+        treeTableView.setFixedCellSize(23);\n+        Toolkit.getToolkit().firePulse();\n@@ -241,0 +243,1 @@\n+        assertNotEquals(cell, VirtualFlowTestUtils.getCell(treeTableView, 0));\n@@ -323,0 +326,14 @@\n+    \/** TreeTableView.refresh() must release all discarded cells JDK-8307538 *\/\n+    @Test\n+    public void cellsMustBeCollectableAfterRefresh() {\n+        IndexedCell<?> row = VirtualFlowTestUtils.getCell(treeTableView, 0);\n+        assertNotNull(row);\n+        WeakReference<Object> ref = new WeakReference<>(row);\n+        row = null;\n+\n+        treeTableView.refresh();\n+        Toolkit.getToolkit().firePulse();\n+\n+        JMemoryBuddy.assertCollectable(ref);\n+    }\n+\n","filename":"modules\/javafx.controls\/src\/test\/java\/test\/javafx\/scene\/control\/skin\/TreeTableRowSkinTest.java","additions":28,"deletions":11,"binary":false,"changes":39,"status":"modified"}]}