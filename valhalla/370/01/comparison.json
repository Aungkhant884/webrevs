{"files":[{"patch":"@@ -0,0 +1,48 @@\n+\/*\n+ * Copyright (c) 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package com.sun.source.tree;\n+\n+\/**\n+ * A tree node for a {@code default} instance initializion expression.\n+ *\n+ * For example:\n+ * <pre>\n+ *   Optional<String>.default\n+ * <\/pre>\n+ *\n+ * @jls todo\n+ *\n+ * @since valhalla\n+ *\/\n+public interface DefaultValueTree extends ExpressionTree {\n+\n+    \/**\n+     * Returns the name of the class of the instance being initialized.\n+     * @return the name\n+     *\/\n+    ExpressionTree getType();\n+\n+}\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/source\/tree\/DefaultValueTree.java","additions":48,"deletions":0,"binary":false,"changes":48,"status":"added"},{"patch":"@@ -256,0 +256,7 @@\n+        \/**\n+         * Used for instances of {@link DefaultValueTree}.\n+         *\n+         * @since valhalla\n+         *\/\n+        DEFAULT_VALUE(DefaultValueTree.class),\n+\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/source\/tree\/Tree.java","additions":7,"deletions":0,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -172,0 +172,8 @@\n+    \/**\n+     * Visits a DefaultValue node.\n+     * @param node the node being visited\n+     * @param p a parameter value\n+     * @return a result value\n+     *\/\n+    R visitDefaultValue(DefaultValueTree node, P p);\n+\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/source\/tree\/TreeVisitor.java","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -302,0 +302,12 @@\n+    \/**\n+     * {@inheritDoc} This implementation calls {@code defaultAction}.\n+     *\n+     * @param node {@inheritDoc}\n+     * @param p {@inheritDoc}\n+     * @return  the result of {@code defaultAction}\n+     *\/\n+    @Override\n+    public R visitDefaultValue(DefaultValueTree node, P p) {\n+        return defaultAction(node, p);\n+    }\n+\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/source\/util\/SimpleTreeVisitor.java","additions":12,"deletions":0,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -388,0 +388,12 @@\n+    \/**\n+     * {@inheritDoc} This implementation scans the children in left to right order.\n+     *\n+     * @param node  {@inheritDoc}\n+     * @param p  {@inheritDoc}\n+     * @return the result of scanning\n+     *\/\n+    @Override\n+    public R visitDefaultValue(DefaultValueTree node, P p) {\n+        return scan(node.getType(), p);\n+    }\n+\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/source\/util\/TreeScanner.java","additions":12,"deletions":0,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -4257,1 +4257,1 @@\n-                tree.name == names._class || tree.name == names._default)\n+                tree.name == names._class)\n@@ -4259,4 +4259,0 @@\n-            if (tree.name == names._default && !allowPrimitiveClasses) {\n-                log.error(DiagnosticFlag.SOURCE_LEVEL, tree.pos(),\n-                        Feature.PRIMITIVE_CLASSES.error(sourceName));\n-            }\n@@ -4284,9 +4280,4 @@\n-                if (tree.name == names._default) {\n-                    result = check(tree, litType(BOT).constType(null),\n-                            KindSelector.VAL, resultInfo);\n-                } else {\n-                    log.error(tree.pos(), Errors.TypeVarCantBeDeref);\n-                    result = tree.type = types.createErrorType(tree.name, site.tsym, site);\n-                    tree.sym = tree.type.tsym;\n-                    return;\n-                }\n+                log.error(tree.pos(), Errors.TypeVarCantBeDeref);\n+                result = tree.type = types.createErrorType(tree.name, site.tsym, site);\n+                tree.sym = tree.type.tsym;\n+                return;\n@@ -4436,3 +4427,1 @@\n-                } else if (name == names._default) {\n-                    return new VarSymbol(STATIC, names._default, site, site.tsym);\n-                } else if (name == names.ref && site.isPrimitiveClass() && resultInfo.pkind.contains(KindSelector.TYP)) {\n+               } else if (name == names.ref && site.isPrimitiveClass() && resultInfo.pkind.contains(KindSelector.TYP)) {\n@@ -4451,4 +4440,0 @@\n-                if (name == names._default) {\n-                    \/\/ Be sure to return the default value before examining bounds\n-                    return new VarSymbol(STATIC, names._default, site, site.tsym);\n-                }\n@@ -4479,1 +4464,1 @@\n-                \/\/ .class and .default is allowed for these.\n+                \/\/ .class is allowed for these.\n@@ -4484,2 +4469,0 @@\n-                } else if (name == names._default) {\n-                    return new VarSymbol(STATIC, names._default, site, site.tsym);\n@@ -4901,0 +4884,23 @@\n+    public void visitDefaultValue(JCDefaultValue tree) {\n+        if (!allowPrimitiveClasses) {\n+            log.error(DiagnosticFlag.SOURCE_LEVEL, tree.pos(),\n+                    Feature.PRIMITIVE_CLASSES.error(sourceName));\n+        }\n+\n+        \/\/ Attribute the qualifier expression, and determine its symbol (if any).\n+        Type site = attribTree(tree.clazz, env, new ResultInfo(KindSelector.TYP, Type.noType));\n+        if (!pkind().contains(KindSelector.TYP_PCK))\n+            site = capture(site); \/\/ Capture field access\n+\n+        Symbol sym = switch (site.getTag()) {\n+                case PACKAGE, WILDCARD -> throw new AssertionError(tree);\n+                case ERROR -> types.createErrorType(names._default, site.tsym, site).tsym;\n+                default -> new VarSymbol(STATIC, names._default, site, site.tsym);\n+        };\n+\n+        if (site.hasTag(TYPEVAR) && sym.kind != ERR) {\n+            site = types.skipTypeVars(site, true);\n+        }\n+        result = checkId(tree, site, sym, env, resultInfo);\n+    }\n+\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/comp\/Attr.java","additions":30,"deletions":24,"binary":false,"changes":54,"status":"modified"},{"patch":"@@ -36,1 +36,0 @@\n-import com.sun.tools.javac.tree.JCTree.JCSwitchExpression;\n@@ -368,0 +367,7 @@\n+        @Override\n+        public void visitDefaultValue(JCDefaultValue tree) {\n+            SourceRange sr = new SourceRange(startPos(tree), endPos(tree));\n+            sr.mergeWith(csp(tree.clazz));\n+            result = sr;\n+        }\n+        \n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/jvm\/CRTable.java","additions":7,"deletions":1,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -2351,10 +2351,0 @@\n-        } else if (tree.name == names._default) {\n-            if (tree.type.asElement().isPrimitiveClass()) {\n-                code.emitop2(defaultvalue, checkDimension(tree.pos(), tree.type), PoolWriter::putClass);\n-            } else if (tree.type.isReference()) {\n-                code.emitop0(aconst_null);\n-            } else {\n-                code.emitop0(zero(Code.typecode(tree.type)));\n-            }\n-            result = items.makeStackItem(tree.type);\n-            return;\n@@ -2417,0 +2407,12 @@\n+    public void visitDefaultValue(JCDefaultValue tree) {\n+        if (tree.type.asElement().isPrimitiveClass()) {\n+            code.emitop2(defaultvalue, checkDimension(tree.pos(), tree.type), PoolWriter::putClass);\n+        } else if (tree.type.isReference()) {\n+            code.emitop0(aconst_null);\n+        } else {\n+            code.emitop0(zero(Code.typecode(tree.type)));\n+        }\n+        result = items.makeStackItem(tree.type);\n+        return;\n+    }\n+\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/jvm\/Gen.java","additions":12,"deletions":10,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -203,1 +203,2 @@\n-                    rhs = make.Select(type, new VarSymbol(STATIC, names._default, currentClass.type, currentClass.sym));\n+                    rhs = make.DefaultValue(type);\n+                    rhs.type = currentClass.type;\n@@ -338,1 +339,1 @@\n-        if (fieldAccess.name != names._class && fieldAccess.name != names._default) {  \/\/ TODO: this and super ??\n+        if (fieldAccess.name != names._class) {  \/\/ TODO: this and super ??\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/jvm\/TransValues.java","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -1360,1 +1360,1 @@\n-                                t = to(F.at(pos).Select(t, names._default));\n+                                t = to(F.at(pos).DefaultValue(t));\n@@ -1437,1 +1437,1 @@\n-                                    t =  toP(F.at(token.pos).Select(t, names._default));\n+                                    t =  toP(F.at(token.pos).DefaultValue(t));\n@@ -2280,1 +2280,5 @@\n-                t = toP(F.at(pos).Select(t, selector == CLASS ? names._class : names._default));\n+                if (selector == CLASS) {\n+                    t = toP(F.at(pos).Select(t, names._class));\n+                } else {\n+                    t = toP(F.at(pos).DefaultValue(t));\n+                }\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/parser\/JavacParser.java","additions":7,"deletions":3,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -256,0 +256,4 @@\n+        \/** Default values, of type DefaultValueTree.\n+         *\/\n+        DEFAULT_VALUE,\n+\n@@ -1361,0 +1365,26 @@\n+    \/**\n+     * A \"Identifier<TA1, TA2>.default\" construction.\n+     *\/\n+    public static class JCDefaultValue extends JCPolyExpression implements DefaultValueTree {\n+        public JCExpression clazz;\n+\n+        protected JCDefaultValue(JCExpression clazz) {\n+            this.clazz = clazz;\n+        }\n+        @Override\n+        public void accept(Visitor v) { v.visitDefaultValue(this); }\n+\n+        @DefinedBy(Api.COMPILER_TREE)\n+        public Kind getKind() { return Kind.DEFAULT_VALUE; }\n+        @Override @DefinedBy(Api.COMPILER_TREE)\n+        public JCExpression getType() { return clazz; }\n+        @Override @DefinedBy(Api.COMPILER_TREE)\n+        public <R,D> R accept(TreeVisitor<R,D> v, D d) {\n+            return v.visitDefaultValue(this, d);\n+        }\n+        @Override\n+        public Tag getTag() {\n+            return DEFAULT_VALUE;\n+        }\n+    }\n+\n@@ -3212,0 +3242,1 @@\n+        JCDefaultValue DefaultValue(JCExpression type);\n@@ -3290,0 +3321,1 @@\n+        public void visitDefaultValue(JCDefaultValue that) { visitTree(that); }\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/tree\/JCTree.java","additions":32,"deletions":0,"binary":false,"changes":32,"status":"modified"},{"patch":"@@ -746,0 +746,9 @@\n+    public void visitDefaultValue(JCDefaultValue tree) {\n+        try {\n+            printExpr(tree.clazz, TreeInfo.postfixPrec);\n+            print(\".default\");\n+        } catch (IOException e) {\n+            throw new UncheckedIOException(e);\n+        }\n+    }\n+\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/tree\/Pretty.java","additions":9,"deletions":0,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -201,0 +201,7 @@\n+    @DefinedBy(Api.COMPILER_TREE)\n+    public JCTree visitDefaultValue(DefaultValueTree node, P p) {\n+        JCDefaultValue t = (JCDefaultValue) node;\n+        JCExpression clazz = copy(t.clazz, p);\n+        return M.at(t.pos).DefaultValue(clazz);\n+    }\n+\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/tree\/TreeCopier.java","additions":7,"deletions":0,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -490,0 +490,2 @@\n+            case DEFAULT_VALUE:\n+                return getStartPos(((JCDefaultValue) tree).clazz);\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/tree\/TreeInfo.java","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -301,0 +301,6 @@\n+    public JCDefaultValue DefaultValue(JCExpression type) {\n+        JCDefaultValue tree = new JCDefaultValue(type);\n+        tree.pos = pos;\n+        return tree;\n+    }\n+\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/tree\/TreeMaker.java","additions":6,"deletions":0,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -189,0 +189,4 @@\n+    public void visitDefaultValue(JCDefaultValue tree) {\n+        scan(tree.clazz);\n+    }\n+\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/tree\/TreeScanner.java","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -383,0 +383,5 @@\n+    public void visitDefaultValue(JCDefaultValue tree) {\n+        tree.clazz = translate(tree.clazz);\n+        result = tree;\n+    }\n+\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/tree\/TreeTranslator.java","additions":5,"deletions":0,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -14,0 +14,6 @@\n+\n+    public E makeDefault() {\n+        E e = E.default;\n+        return e;\n+    }\n+\n","filename":"test\/langtools\/tools\/javac\/valhalla\/lworld-values\/UncheckedDefault.java","additions":6,"deletions":0,"binary":false,"changes":6,"status":"modified"}]}