{"files":[{"patch":"@@ -112,1 +112,3 @@\n-\n+#ifdef ASSERT\n+  Node* ctrl = kit.control();\n+#endif\n@@ -134,1 +136,0 @@\n-\n@@ -136,0 +137,1 @@\n+  assert(ctrl == kit.control(), \"Control flow was added although we bailed out\");\n@@ -2223,7 +2225,2 @@\n-    Node* cls = null_check(argument(4));\n-    if (stopped()) {\n-      return true;\n-    }\n-    Node* kls = load_klass_from_mirror(cls, false, NULL, 0);\n-    const TypeKlassPtr* kls_t = _gvn.type(kls)->isa_klassptr();\n-    if (!kls_t->klass_is_exact()) {\n+    const TypeInstPtr* cls = _gvn.type(argument(4))->isa_instptr();\n+    if (cls == NULL || cls->const_oop() == NULL) {\n@@ -2232,2 +2229,2 @@\n-    ciKlass* klass = kls_t->klass();\n-    if (!klass->is_inlinetype()) {\n+    ciType* mirror_type = cls->const_oop()->as_instance()->java_mirror_type();\n+    if (!mirror_type->is_inlinetype()) {\n@@ -2236,6 +2233,1 @@\n-    inline_klass = klass->as_inline_klass();\n-  }\n-\n-  receiver = null_check(receiver);\n-  if (stopped()) {\n-    return true;\n+    inline_klass = mirror_type->as_inline_klass();\n@@ -2405,0 +2397,4 @@\n+  receiver = null_check(receiver);\n+  if (stopped()) {\n+    return true;\n+  }\n@@ -2501,0 +2497,3 @@\n+  if (!value->is_InlineType()) {\n+    return false;\n+  }\n@@ -2507,4 +2506,0 @@\n-  if (!value->is_InlineType()) {\n-    return false;\n-  }\n-\n@@ -2512,1 +2507,0 @@\n-\n@@ -2519,6 +2513,0 @@\n-\n-  receiver = null_check(receiver);\n-  if (stopped()) {\n-    return true;\n-  }\n-\n@@ -2528,1 +2516,0 @@\n-\n@@ -2534,1 +2521,4 @@\n-  set_result(vt->finish_larval(this));\n+  receiver = null_check(receiver);\n+  if (stopped()) {\n+    return true;\n+  }\n@@ -2536,0 +2526,1 @@\n+  set_result(vt->finish_larval(this));\n@@ -3259,0 +3250,1 @@\n+  bool requires_null_check = false;\n@@ -3265,7 +3257,3 @@\n-      if (!obj->is_InlineType() && tm->as_klass()->is_inlinetype()) {\n-        \/\/ Casting to .val, check for null\n-        obj = null_check(obj);\n-        if (stopped()) {\n-          return true;\n-        }\n-      }\n+      \/\/ Check for null if casting to .val\n+      requires_null_check = !obj->is_InlineType() && tm->as_klass()->is_inlinetype();\n+\n@@ -3275,0 +3263,3 @@\n+        if (requires_null_check) {\n+          obj = null_check(obj);\n+        }\n@@ -3295,0 +3286,3 @@\n+  if (requires_null_check) {\n+    obj = null_check(obj);\n+  }\n@@ -3313,1 +3307,1 @@\n-    if (EnableValhalla && !obj->is_InlineType()) {\n+    if (EnableValhalla && !obj->is_InlineType() && !requires_null_check) {\n","filename":"src\/hotspot\/share\/opto\/library_call.cpp","additions":32,"deletions":38,"binary":false,"changes":70,"status":"modified"}]}