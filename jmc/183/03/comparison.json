{"files":[{"patch":"@@ -40,0 +40,1 @@\n+if \"%1\" == \"--packageAgent\" goto packageAgent\n@@ -118,0 +119,16 @@\n+:packageAgent\n+@REM generate a unique id for window title\n+@REM allow to filter uniquely to get PID associated later\n+for \/f \"skip=1\" %%A in ('wmic os get localdatetime ^| findstr .') do (set LOCALDATETIME=%%A)\n+set TIMESTAMP=%LOCALDATETIME:~0,14%\n+set PACKAGE_LOG=%cd%\\build_%TIMESTAMP%.5.package.log\n+cd agent\n+call mvn install --log-file \"%PACKAGE_LOG%\"\n+cd ..\n+if %ERRORLEVEL% == 0  (\n+\techo You can nor run agent, see agent\/README.md\n+) else {\n+\texit \/B 1\n+}\n+exit \/B 0\n+\n@@ -124,0 +141,3 @@\n+cd agent\n+call mvn clean\n+cd ..\n","filename":"build.bat","additions":20,"deletions":0,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -10,0 +10,1 @@\n+JMC_DIR=\"\"\n@@ -23,0 +24,17 @@\n+function installCore() {\n+    local timestamp=\"$1\"\n+    local installLog=\"${BASEDIR}\/build_${timestamp}.3.install.log\"\n+    pushd core 1> \/dev\/null || {\n+        err_log \"directory core not found\"\n+        exit 1\n+    }\n+\n+    echo \"$(date +%T) installing core artifacts - logging output to ${installLog}\"\n+    mvn clean install --log-file \"${installLog}\"\n+\n+    popd 1> \/dev\/null || {\n+        err_log \"could not go to project root directory\"\n+        exit 1\n+    }\n+}\n+\n@@ -24,1 +42,1 @@\n-    local timestamp=\"$(date +%Y%m%d%H%M%S)\"\n+    local timestamp=$1\n@@ -27,1 +45,1 @@\n-    local installLog=\"${BASEDIR}\/build_${timestamp}.3.install.log\"\n+    \n@@ -50,13 +68,1 @@\n-    }\n-    pushd core 1> \/dev\/null || {\n-        err_log \"directory core not found\"\n-        exit 1\n-    }\n-\n-    echo \"$(date +%T) installing core artifacts - logging output to ${installLog}\"\n-    mvn clean install --log-file \"${installLog}\"\n-\n-    popd 1> \/dev\/null || {\n-        err_log \"could not go to project root directory\"\n-        exit 1\n-    }\n+    }  \n@@ -77,0 +83,1 @@\n+        printf \" \\t%s\\t%s\\n\" \"--installCore\" \"install JMC core\"\n@@ -78,0 +85,1 @@\n+        printf \" \\t%s\\t%s\\n\" \"--packageAgent\" \"to package Agent\"\n@@ -80,0 +88,1 @@\n+        printf \" \\t%s\\t%s\\n\" \"--runAgentExample\" \"to run Agent Example once it was packaged\"\n@@ -95,1 +104,3 @@\n-    startJetty\n+    local timestamp=$1\n+    startJetty $timestamp\n+    installCore $timestamp\n@@ -101,2 +112,4 @@\n-    startJetty\n-    local packageLog=\"${BASEDIR}\/build_$(date +%Y%m%d%H%M%S).4.package.log\"\n+        \n+    startJetty $timestamp\n+    installCore $timestamp\n+    local packageLog=\"${BASEDIR}\/build_${timestamp}.4.package.log\"\n@@ -116,0 +129,25 @@\n+function packageAgent() {\n+    local timestamp=$1\n+    local packageLog=\"${BASEDIR}\/build_${timestamp}.5.package.log\"\n+\n+    pushd agent 1> \/dev\/null || {\n+        err_log \"directory agent not found\"\n+        exit 1\n+    }\n+    \n+    echo \"$(date +%T) packaging jmc agent - logging output to ${packageLog}\"\n+    mvn package --log-file \"${packageLog}\"\n+\n+    popd 1> \/dev\/null || {\n+        err_log \"could not go to project root directory\"\n+        exit 1\n+    }\n+\n+    if [[ \"${OSTYPE}\" =~ \"linux\"* ]] || [[ \"${OSTYPE}\" =~ \"darwin\"* ]]; then\n+       printf \"%s\\n\" \"You can nor run agent by calling \\\"${PROGNAME} --runAgentExample\\\"\"\n+    else\n+        err_log \"unknown OS type: \\\"${OSTYPE}\\\". Please coheck package in \\\"${JMC_DIR}\/agent\/target\\\"\"\n+        exit 1\n+    fi\n+}\n+\n@@ -130,0 +168,10 @@\n+    pushd agent 1> \/dev\/null || {\n+        err_log \"directory agent not found\"\n+        exit 1\n+    }\n+    mvn clean\n+    popd 1> \/dev\/null || {\n+        err_log \"could not go to project root directory\"\n+        exit 1\n+    }\n+\n@@ -160,0 +208,32 @@\n+function runAgentExample(){\n+    checkJava\n+    if [[ \"${OSTYPE}\" =~ \"linux\"* ]] || [[ \"${OSTYPE}\" =~ \"darwin\"* ]]; then\n+       printf \"%s\\n\" \"try to execute an agent example\"\n+    else\n+        err_log \"unknown OS type: \\\"${OSTYPE}\\\". Please coheck package ${JMC_DIR}\/agent README.MD\"\n+        exit 1\n+    fi\n+\n+\n+    local javaVersion=`java -version 2>&1 | head -1 | cut -d '\"' -f 2 | sed 's\/^1\\.\/\/' | cut -d '.' -f 1`\n+    printf \"Java Version:%d\\n\" \"${javaVersion}\"\n+    local pathToAgentTargetDir=\"${JMC_DIR}\/agent\/target\"\n+    local pathToAgentJar=\"${pathToAgentTargetDir}\/org.openjdk.jmc.agent-1.0.0-SNAPSHOT.jar\"\n+    printf \"Agent path:%s\\n\" \"${pathToAgentJar}\"\n+    if [ -f \"${pathToAgentJar}\" ]; then\n+        if [ \"$javaVersion\" -lt \"8\" ]; then\n+            echo \"min. required java version is 8\"\n+            exit 1\n+        elif [ \"$javaVersion\" -eq \"8\" ]; then\n+            java -XX:+UnlockCommercialFeatures -XX:+FlightRecorder -javaagent:${pathToAgentJar}=${pathToAgentTargetDir}\/test-classes\/org\/openjdk\/jmc\/agent\/test\/jfrprobes_template.xml -cp ${pathToAgentJar}:${pathToAgentTargetDir}\/test-classes\/ org.openjdk.jmc.agent.test.InstrumentMe\n+        elif [ \"$javaVersion\" -lt \"13\" ]; then \n+            java --add-opens java.base\/jdk.internal.misc=ALL-UNNAMED -XX:+FlightRecorder -javaagent:${pathToAgentJar}=${pathToAgentTargetDir}\/test-classes\/org\/openjdk\/jmc\/agent\/test\/jfrprobes_template.xml -cp ${pathToAgentJar}:${pathToAgentTargetDir}\/test-classes\/ org.openjdk.jmc.agent.test.InstrumentMe\n+        else \n+            java --add-opens java.base\/jdk.internal.misc=ALL-UNNAMED -javaagent:${pathToAgentJar}=${pathToAgentTargetDir}\/test-classes\/org\/openjdk\/jmc\/agent\/test\/jfrprobes_template.xml -cp ${pathToAgentJar}:${pathToAgentTargetDir}\/test-classes\/ org.openjdk.jmc.agent.test.InstrumentMe\n+        fi\n+    else\n+        err_log \"Agent not found in \\\"${pathToAgentJar}\\\". Did you call --packageAgent before?\"\n+        exit 1\n+    fi\n+}\n+\n@@ -161,0 +241,1 @@\n+    local timestamp=\"$(date +%Y%m%d%H%M%S)\"\n@@ -171,1 +252,4 @@\n-                runUiTests\n+                runUiTests $timestamp\n+                ;;\n+            --installCore)\n+                installCore $timestamp\n@@ -174,1 +258,4 @@\n-                packageJmc\n+                packageJmc $timestamp\n+                ;;\n+            --packageAgent)\n+                packageAgent $timestamp\n@@ -182,0 +269,3 @@\n+            --runAgentExample)\n+                runAgentExample\n+                ;;\n@@ -192,0 +282,7 @@\n+function checkJava() {\n+    if ! command -v   java &> \/dev\/null ; then\n+        err_log \"It seems you do not have java installed. Please ensure you have it installed and executable as \\\"java\\\".\"\n+        exit 1\n+    fi\n+}\n+\n@@ -198,4 +295,1 @@\n-    if ! command -v   java &> \/dev\/null ; then\n-        err_log \"It seems you do not have java installed. Please ensure you have it installed and executable as \\\"java\\\".\"\n-        exit 1\n-    fi\n+    checkJava\n@@ -204,0 +298,1 @@\n+    JMC_DIR=$(pwd)\n","filename":"build.sh","additions":119,"deletions":24,"binary":false,"changes":143,"status":"modified"}]}