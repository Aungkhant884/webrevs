{"files":[{"patch":"@@ -59,0 +59,1 @@\n+import java.util.concurrent.Callable;\n@@ -64,0 +65,1 @@\n+import java.util.concurrent.Future;\n@@ -107,0 +109,1 @@\n+import org.openjdk.jmc.flightrecorder.ui.ItemCollectionToolkit;\n@@ -160,5 +163,0 @@\n-\tprivate TraceNode currentRoot;\n-\tprivate CompletableFuture<TraceNode> currentModelCalculator;\n-\tprivate boolean threadRootAtTop = true;\n-\tprivate boolean icicleViewActive = true;\n-\tprivate IItemCollection currentItems;\n@@ -168,0 +166,6 @@\n+\tprivate boolean threadRootAtTop = true;\n+\tprivate boolean icicleViewActive = true;\n+\tprivate IItemCollection currentItems;\n+\tprivate ModelState modelState = ModelState.NONE;\n+\tprivate ModelRebuildCallable modelRebuildCallable;\n+\tprivate Future<Void> modelCalculationFuture;\n@@ -189,0 +193,4 @@\n+\tprivate enum ModelState {\n+\t\tINIT, CALCULATION, READY, ABORTED, NONE;\n+\t}\n+\n@@ -205,1 +213,1 @@\n-\t\t\t\trebuildModel(currentItems);\n+\t\t\t\ttriggerRebuildTask(currentItems);\n@@ -275,0 +283,32 @@\n+\tprivate static class ModelRebuildCallable implements Callable<Void> {\n+\n+\t\tprivate volatile boolean isInvalid;\n+\t\tprivate FlameGraphView view;\n+\t\tprivate IItemCollection items;\n+\n+\t\tprivate ModelRebuildCallable(FlameGraphView view, IItemCollection items) {\n+\t\t\tthis.view = view;\n+\t\t\tthis.items = items;\n+\t\t}\n+\n+\t\tprivate void setInvalid() {\n+\t\t\tthis.isInvalid = true;\n+\t\t}\n+\n+\t\t@Override\n+\t\tpublic Void call() throws Exception {\n+\t\t\tview.modelState = ModelState.CALCULATION;\n+\t\t\tStacktraceModel model = new StacktraceModel(view.threadRootAtTop, view.frameSeparator, items);\n+\t\t\tTraceNode root = TraceTreeUtils.createRootWithDescription(items, model.getRootFork().getBranchCount());\n+\t\t\tTraceNode traceNode = TraceTreeUtils.createTree(root, model);\n+\t\t\tString jsonModel = view.toJSonModel(traceNode).toString();\n+\t\t\tif (isInvalid) {\n+\t\t\t\tview.modelState = ModelState.ABORTED;\n+\t\t\t\treturn null;\n+\t\t\t}\n+\t\t\tview.modelState = ModelState.READY;\n+\t\t\tDisplayToolkit.inDisplayThread().execute(() -> view.setModel(items, jsonModel));\n+\t\t\treturn null;\n+\t\t}\n+\t}\n+\n@@ -334,8 +374,6 @@\n-\t\t\tsetItems(AdapterUtil.getAdapter(first, IItemCollection.class));\n-\t\t}\n-\t}\n-\n-\tprivate void setItems(IItemCollection items) {\n-\t\tif (items != null) {\n-\t\t\tcurrentItems = items;\n-\t\t\trebuildModel(items);\n+\t\t\tIItemCollection items = AdapterUtil.getAdapter(first, IItemCollection.class);\n+\t\t\tif (items == null) {\n+\t\t\t\ttriggerRebuildTask(ItemCollectionToolkit.build(Stream.empty()));\n+\t\t\t} else if (!items.equals(currentItems)) {\n+\t\t\t\ttriggerRebuildTask(items);\n+\t\t\t}\n@@ -345,4 +383,5 @@\n-\tprivate void rebuildModel(IItemCollection items) {\n-\t\t\/\/ Release old model before building the new\n-\t\tif (currentModelCalculator != null) {\n-\t\t\tcurrentModelCalculator.cancel(true);\n+\tprivate void triggerRebuildTask(IItemCollection items) {\n+\t\t\/\/ Release old model calculation before building a new\n+\t\tif (modelCalculationFuture != null) {\n+\t\t\tmodelRebuildCallable.setInvalid();\n+\t\t\tmodelCalculationFuture.cancel(true);\n@@ -350,4 +389,0 @@\n-\t\tcurrentModelCalculator = getModelPreparer(items, frameSeparator, true);\n-\t\tcurrentModelCalculator.thenAcceptAsync(this::setModel, DisplayToolkit.inDisplayThread())\n-\t\t\t\t.exceptionally(FlameGraphView::handleModelBuildException);\n-\t}\n@@ -355,7 +390,4 @@\n-\tprivate CompletableFuture<TraceNode> getModelPreparer(\n-\t\tfinal IItemCollection items, final FrameSeparator separator, final boolean materializeSelectedBranches) {\n-\t\treturn CompletableFuture.supplyAsync(() -> {\n-\t\t\tStacktraceModel model = new StacktraceModel(threadRootAtTop, frameSeparator, items);\n-\t\t\tTraceNode root = TraceTreeUtils.createRootWithDescription(items, model.getRootFork().getBranchCount());\n-\t\t\treturn TraceTreeUtils.createTree(root, model);\n-\t\t}, MODEL_EXECUTOR);\n+\t\tmodelState = ModelState.INIT;\n+\t\tcurrentItems = items;\n+\t\tmodelRebuildCallable = new ModelRebuildCallable(this, items);\n+\t\tmodelCalculationFuture = MODEL_EXECUTOR.submit(modelRebuildCallable);\n@@ -364,4 +396,3 @@\n-\tprivate void setModel(TraceNode root) {\n-\t\tif (!browser.isDisposed() && !root.equals(currentRoot)) {\n-\t\t\tcurrentRoot = root;\n-\t\t\tsetViewerInput(root);\n+\tprivate void setModel(final IItemCollection items, final String json) {\n+\t\tif (ModelState.READY.equals(modelState) && items.equals(currentItems) && !browser.isDisposed()) {\n+\t\t\tsetViewerInput(json);\n@@ -371,1 +402,1 @@\n-\tprivate void setViewerInput(TraceNode root) {\n+\tprivate void setViewerInput(String json) {\n@@ -379,0 +410,9 @@\n+\t\t\tprivate boolean loaded = false;\n+\n+\t\t\t@Override\n+\t\t\tpublic void changed(ProgressEvent event) {\n+\t\t\t\tif (loaded) {\n+\t\t\t\t\tbrowser.removeProgressListener(this);\n+\t\t\t\t}\n+\t\t\t}\n+\n@@ -381,1 +421,0 @@\n-\t\t\t\tbrowser.removeProgressListener(this);\n@@ -384,2 +423,1 @@\n-\n-\t\t\t\tbrowser.execute(String.format(\"processGraph(%s, %s);\", toJSon(root), icicleViewActive));\n+\t\t\t\tbrowser.execute(String.format(\"processGraph(%s, %s);\", json, icicleViewActive));\n@@ -387,0 +425,1 @@\n+\t\t\t\tloaded = true;\n@@ -447,1 +486,1 @@\n-\t\t\t\/\/ noop\n+\t\t\t\/\/ noop : model calculation is canceled when is still running\n@@ -453,15 +492,1 @@\n-\tprivate static Void handleModelBuildException(Throwable ex) {\n-\t\tif (!(ex.getCause() instanceof CancellationException)) {\n-\t\t\tFlightRecorderUI.getDefault().getLogger().log(Level.SEVERE, \"Failed to build stacktrace view model\", ex); \/\/$NON-NLS-1$\n-\t\t}\n-\t\treturn null;\n-\t}\n-\n-\tprivate static String toJSon(TraceNode root) {\n-\t\tif (root == null) {\n-\t\t\treturn \"\\\"\\\"\";\n-\t\t}\n-\t\treturn render(root);\n-\t}\n-\n-\tprivate static String render(TraceNode root) {\n+\tprivate StringBuilder toJSonModel(TraceNode root) {\n@@ -473,1 +498,1 @@\n-\t\treturn builder.toString();\n+\t\treturn builder;\n","filename":"application\/org.openjdk.jmc.flightrecorder.flameview\/src\/main\/java\/org\/openjdk\/jmc\/flightrecorder\/flameview\/views\/FlameGraphView.java","additions":79,"deletions":54,"binary":false,"changes":133,"status":"modified"}]}