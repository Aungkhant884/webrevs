{"files":[{"patch":"@@ -64,1 +64,1 @@\n-  * method to close the task scope. The API is intended to be used with the {@code\n+ * method to close the task scope. The API is intended to be used with the {@code\n@@ -93,1 +93,1 @@\n- * <h2>Sub-classes with policies for common cases<\/h2>\n+ * <h2>Subclasses with policies for common cases<\/h2>\n@@ -95,1 +95,1 @@\n- * Two sub-classes of StructuredTaskScope are defined to implement policy for common cases:\n+ * Two subclasses of StructuredTaskScope are defined to implement policy for common cases:\n@@ -168,1 +168,1 @@\n- * down and caus {@link #join() join} to wakeup when some condition arises.\n+ * down and cause {@link #join() join} to wakeup when some condition arises.\n@@ -170,2 +170,2 @@\n- * <p> A sub-class will typically define methods to make available results, state, or\n- * other outcome to code that executes after the {@code join} method. A sub-class that collects\n+ * <p> A subclass will typically define methods to make available results, state, or\n+ * other outcome to code that executes after the {@code join} method. A subclass that collects\n@@ -173,1 +173,1 @@\n- * results. A sub-class that implements a policy to shut down when a task fails may define\n+ * results. A subclass that implements a policy to shut down when a task fails may define\n@@ -210,1 +210,1 @@\n- *   its own task scope. A thread started in task scope \"A\" opens task scope \"B\" establishes\n+ *   its own task scope. A thread started in task scope \"A\" that opens task scope \"B\" establishes\n@@ -213,1 +213,1 @@\n- *   \"B\", then open task scope \"C\" (before it closes \"B\"), then the enclosing task scope \"B\"\n+ *   \"B\", then opens task scope \"C\" (before it closes \"B\"), then the enclosing task scope \"B\"\n@@ -254,0 +254,8 @@\n+ * <h2>Memory consistency effects<\/h2>\n+ * <p>Actions in the owner thread of, or a thread contained in, the task scope prior to\n+ * {@linkplain #fork forking} of a {@code Callable} task\n+ * <a href=\"..\/..\/..\/..\/java.base\/java\/util\/concurrent\/package-summary.html#MemoryVisibility\"><i>happen-before<\/i><\/a>\n+ * any actions taken by that task, which in turn <i>happen-before<\/i> the task result\n+ * is retrieved via its {@code Future}, or <i>happen-before<\/i> any actions taken in\n+ * a thread after {@linkplain #join() joining} of the task scope.\n+ *\n@@ -272,1 +280,2 @@\n-    \/\/ the set of \"tracked\" Future objects, created lazily\n+    \/\/ the set of \"tracked\" Future objects waiting to be returned by Future.get, created lazily\n+    \/\/ assigned to non-null value in method track, read by any thread\n@@ -276,0 +285,1 @@\n+    \/\/ accessed only by owner thread\n@@ -282,1 +292,3 @@\n-    private volatile int state;\n+    \/\/ read from any thread\n+    \/\/ write is guarded by shutdownLock (-> SHUTDOWN) or by owner thread (-> CLOSED)\n+    private volatile int state; \/\/ = OPEN;\n@@ -365,1 +377,1 @@\n-     * Invoked when a task completes before the scope is shutdown.\n+     * Invoked when a task completes before the scope is shut down.\n@@ -387,1 +399,1 @@\n-     * the cancel a task before the task scope is shutdown, then the {@code handleComplete}\n+     * the cancel a task before the task scope is shut down, then the {@code handleComplete}\n@@ -400,1 +412,2 @@\n-     * invoked from another thread.\n+     * invoked from another thread. All other methods on the returned {@code Future} object,\n+     * such as {@link Future#get() get}, are not restricted.\n@@ -417,3 +430,1 @@\n-        @SuppressWarnings(\"unchecked\")\n-        Callable<T> t = (Callable<T>) task;\n-        var future = new FutureImpl<T>(this, t);\n+        var future = new FutureImpl<U>(this, task);\n@@ -426,1 +437,1 @@\n-            if (thread == null)\n+            if (thread == null) {\n@@ -428,0 +439,1 @@\n+            }\n@@ -451,3 +463,1 @@\n-        @SuppressWarnings(\"unchecked\")\n-        var f = (Future<U>) future;\n-        return f;\n+        return future;\n@@ -480,1 +490,1 @@\n-     * Wait for all threads to finish or the task scope to shutdown. This method waits\n+     * Wait for all threads to finish or the task scope to shut down. This method waits\n@@ -482,1 +492,1 @@\n-     * {@link #handleComplete(Future) handleComplete} method), the {@link #shutdown()\n+     * {@link #handleComplete(Future) handleComplete} method), or the {@link #shutdown()\n@@ -503,1 +513,1 @@\n-     * Wait for all threads to finish or the task scope to shutdown, up to the given\n+     * Wait for all threads to finish or the task scope to shut down, up to the given\n@@ -591,1 +601,1 @@\n-     * Shutdown the task scope without closing it. Shutting down a task scope prevents new\n+     * Shut down the task scope without closing it. Shutting down a task scope prevents new\n@@ -696,1 +706,1 @@\n-    private static class FutureImpl<V> extends FutureTask<V> {\n+    private static final class FutureImpl<V> extends FutureTask<V> {\n@@ -699,3 +709,4 @@\n-        FutureImpl(StructuredTaskScope<V> scope, Callable<V> task) {\n-            super(task);\n-            this.scope = scope;\n+        @SuppressWarnings(\"unchecked\")\n+        FutureImpl(StructuredTaskScope<? super V> scope, Callable<? extends V> task) {\n+            super((Callable<V>) task);\n+            this.scope = (StructuredTaskScope<V>) scope;\n@@ -855,1 +866,1 @@\n-         * Shutdown the given task scope when invoked for the first time with a task\n+         * Shut down the given task scope when invoked for the first time with a task\n@@ -922,0 +933,3 @@\n+         * <p> The behavior of this method is unspecified if called before this task\n+         * scope is {@linkplain #join() joined}.\n+         *\n@@ -927,0 +941,1 @@\n+         * @see #join()\n@@ -949,0 +964,3 @@\n+         * <p> The behavior of this method is unspecified if called before this task\n+         * scope is {@linkplain #join() joined}.\n+         *\n@@ -955,0 +973,1 @@\n+         * @see #join()\n@@ -1036,1 +1055,1 @@\n-         * Shutdown the given task scope when invoked for the first time with a task\n+         * Shut down the given task scope when invoked for the first time with a task\n@@ -1097,0 +1116,3 @@\n+         * <p> The behavior of this method is unspecified if called before this task\n+         * scope is {@linkplain #join() joined}.\n+         *\n@@ -1099,0 +1121,1 @@\n+         * @see #join()\n@@ -1117,0 +1140,3 @@\n+         * <p> The behavior of this method is unspecified if called before this task\n+         * scope is {@linkplain #join() joined}.\n+         *\n@@ -1120,0 +1146,1 @@\n+         * @see #join()\n@@ -1138,0 +1165,3 @@\n+         * <p> The behavior of this method is unspecified if called before this task\n+         * scope is {@linkplain #join() joined}.\n+         *\n@@ -1141,0 +1171,1 @@\n+         * @see #join()\n","filename":"src\/jdk.incubator.concurrent\/share\/classes\/jdk\/incubator\/concurrent\/StructuredTaskScope.java","additions":62,"deletions":31,"binary":false,"changes":93,"status":"modified"}]}