{"files":[{"patch":"@@ -37,2 +37,2 @@\n-inline void FreezeBase::patch_chunk_pd(intptr_t* vsp, intptr_t* hsp) {\n-  *(vsp - frame::sender_sp_offset) = *(hsp - frame::sender_sp_offset);\n+inline void FreezeBase::patch_chunk_pd(intptr_t* frame_sp, intptr_t* heap_sp) {\n+  *(frame_sp - frame::sender_sp_offset) = *(heap_sp - frame::sender_sp_offset);\n@@ -65,1 +65,1 @@\n-frame FreezeBase::new_hframe(frame& f, frame& caller) {\n+frame FreezeBase::new_heap_frame(frame& f, frame& caller) {\n@@ -88,1 +88,4 @@\n-    fp = *(intptr_t**)(f.sp() - frame::sender_sp_offset); \/\/ we need to re-read fp because it may be an oop and we might have had a safepoint in finalize_freeze, after constructing f.\n+    \/\/ We need to re-read fp out of the frame because it may be an oop and we might have\n+    \/\/ had a safepoint in finalize_freeze, after constructing f.\n+    fp = *(intptr_t**)(f.sp() - frame::sender_sp_offset);\n+\n@@ -179,1 +182,1 @@\n-template<typename FKind> frame ThawBase::new_frame(const frame& hf, frame& caller, bool bottom) {\n+template<typename FKind> frame ThawBase::new_stack_frame(const frame& hf, frame& caller, bool bottom) {\n@@ -183,1 +186,1 @@\n-    intptr_t* hsp = hf.unextended_sp();\n+    intptr_t* heap_sp = hf.unextended_sp();\n@@ -186,2 +189,2 @@\n-    intptr_t* vsp = caller.unextended_sp() - fsize;\n-    intptr_t* fp = vsp + (hf.fp() - hsp);\n+    intptr_t* frame_sp = caller.unextended_sp() - fsize;\n+    intptr_t* fp = frame_sp + (hf.fp() - heap_sp);\n@@ -190,1 +193,1 @@\n-      vsp--;\n+      frame_sp--;\n@@ -193,1 +196,1 @@\n-    assert(vsp == unextended_sp, \"\");\n+    assert(frame_sp == unextended_sp, \"\");\n@@ -195,1 +198,1 @@\n-    frame f(vsp, vsp, fp, hf.pc());\n+    frame f(frame_sp, frame_sp, fp, hf.pc());\n@@ -204,1 +207,1 @@\n-    intptr_t* vsp = caller.unextended_sp() - fsize;\n+    intptr_t* frame_sp = caller.unextended_sp() - fsize;\n@@ -209,1 +212,1 @@\n-      vsp   -= argsize;\n+      frame_sp   -= argsize;\n@@ -211,1 +214,1 @@\n-      assert(caller.sp() == vsp + (fsize-argsize), \"\");\n+      assert(caller.sp() == frame_sp + (fsize-argsize), \"\");\n@@ -213,1 +216,1 @@\n-      vsp = align(hf, vsp, caller, bottom);\n+      frame_sp = align(hf, frame_sp, caller, bottom);\n@@ -219,1 +222,1 @@\n-      ? vsp + fsize - frame::sender_sp_offset \/\/ on AArch64, this value is used for the safepoint stub\n+      ? frame_sp + fsize - frame::sender_sp_offset \/\/ on AArch64, this value is used for the safepoint stub\n@@ -221,1 +224,1 @@\n-    return frame(vsp, vsp, fp, hf.pc(), hf.cb(), hf.oop_map(), false); \/\/ TODO PERF : this computes deopt state; is it necessary?\n+    return frame(frame_sp, frame_sp, fp, hf.pc(), hf.cb(), hf.oop_map(), false); \/\/ TODO PERF : this computes deopt state; is it necessary?\n@@ -225,1 +228,1 @@\n-inline intptr_t* ThawBase::align(const frame& hf, intptr_t* vsp, frame& caller, bool bottom) {\n+inline intptr_t* ThawBase::align(const frame& hf, intptr_t* frame_sp, frame& caller, bool bottom) {\n@@ -227,1 +230,1 @@\n-  if (((intptr_t)vsp & 0xf) != 0) {\n+  if (((intptr_t)frame_sp & 0xf) != 0) {\n@@ -229,1 +232,1 @@\n-    vsp--;\n+    frame_sp--;\n@@ -232,1 +235,1 @@\n-  assert(is_aligned(vsp, frame::frame_alignment), \"\");\n+  assert(is_aligned(frame_sp, frame::frame_alignment), \"\");\n@@ -235,1 +238,1 @@\n-  return vsp;\n+  return frame_sp;\n","filename":"src\/hotspot\/cpu\/aarch64\/continuation_aarch64.inline.hpp","additions":25,"deletions":22,"binary":false,"changes":47,"status":"modified"},{"patch":"@@ -59,1 +59,1 @@\n-template<typename FKind> frame FreezeBase::new_hframe(frame& f, frame& caller) {\n+template<typename FKind> frame FreezeBase::new_heap_frame(frame& f, frame& caller) {\n@@ -72,1 +72,1 @@\n-inline void FreezeBase::patch_chunk_pd(intptr_t* vsp, intptr_t* hsp) {\n+inline void FreezeBase::patch_chunk_pd(intptr_t* frame_sp, intptr_t* heap_sp) {\n@@ -81,1 +81,1 @@\n-template<typename FKind> frame ThawBase::new_frame(const frame& hf, frame& caller, bool bottom) {\n+template<typename FKind> frame ThawBase::new_stack_frame(const frame& hf, frame& caller, bool bottom) {\n@@ -94,1 +94,1 @@\n-inline intptr_t* ThawBase::align(const frame& hf, intptr_t* vsp, frame& caller, bool bottom) {\n+inline intptr_t* ThawBase::align(const frame& hf, intptr_t* frame_sp, frame& caller, bool bottom) {\n","filename":"src\/hotspot\/cpu\/arm\/continuation_arm.inline.hpp","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -59,1 +59,1 @@\n-template<typename FKind> frame FreezeBase::new_hframe(frame& f, frame& caller) {\n+template<typename FKind> frame FreezeBase::new_heap_frame(frame& f, frame& caller) {\n@@ -72,1 +72,1 @@\n-inline void FreezeBase::patch_chunk_pd(intptr_t* vsp, intptr_t* hsp) {\n+inline void FreezeBase::patch_chunk_pd(intptr_t* frame_sp, intptr_t* heap_sp) {\n@@ -81,1 +81,1 @@\n-template<typename FKind> frame ThawBase::new_frame(const frame& hf, frame& caller, bool bottom) {\n+template<typename FKind> frame ThawBase::new_stack_frame(const frame& hf, frame& caller, bool bottom) {\n@@ -94,1 +94,1 @@\n-inline intptr_t* ThawBase::align(const frame& hf, intptr_t* vsp, frame& caller, bool bottom) {\n+inline intptr_t* ThawBase::align(const frame& hf, intptr_t* frame_sp, frame& caller, bool bottom) {\n","filename":"src\/hotspot\/cpu\/ppc\/continuation_ppc.inline.hpp","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -59,1 +59,1 @@\n-template<typename FKind> frame FreezeBase::new_hframe(frame& f, frame& caller) {\n+template<typename FKind> frame FreezeBase::new_heap_frame(frame& f, frame& caller) {\n@@ -72,1 +72,1 @@\n-inline void FreezeBase::patch_chunk_pd(intptr_t* vsp, intptr_t* hsp) {\n+inline void FreezeBase::patch_chunk_pd(intptr_t* frame_sp, intptr_t* heap_sp) {\n@@ -81,1 +81,1 @@\n-template<typename FKind> frame ThawBase::new_frame(const frame& hf, frame& caller, bool bottom) {\n+template<typename FKind> frame ThawBase::new_stack_frame(const frame& hf, frame& caller, bool bottom) {\n@@ -94,1 +94,1 @@\n-inline intptr_t* ThawBase::align(const frame& hf, intptr_t* vsp, frame& caller, bool bottom) {\n+inline intptr_t* ThawBase::align(const frame& hf, intptr_t* frame_sp, frame& caller, bool bottom) {\n","filename":"src\/hotspot\/cpu\/s390\/continuation_s390.inline.hpp","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -52,2 +52,2 @@\n-inline void FreezeBase::patch_chunk_pd(intptr_t* vsp, intptr_t* hsp) {\n-  *(vsp - frame::sender_sp_offset) = *(hsp - frame::sender_sp_offset);\n+inline void FreezeBase::patch_chunk_pd(intptr_t* frame_sp, intptr_t* heap_sp) {\n+  *(frame_sp - frame::sender_sp_offset) = *(heap_sp - frame::sender_sp_offset);\n@@ -79,1 +79,1 @@\n-frame FreezeBase::new_hframe(frame& f, frame& caller) {\n+frame FreezeBase::new_heap_frame(frame& f, frame& caller) {\n@@ -90,1 +90,1 @@\n-    fp = caller.unextended_sp() - (locals + frame::sender_sp_offset) + (overlap_caller ? ContinuationHelper::InterpretedFrame::stack_argsize(f) : 0);\n+    fp = caller.unextended_sp() - (locals + frame::sender_sp_offset) + (overlap_caller ?  ContinuationHelper::InterpretedFrame::stack_argsize(f) : 0);\n@@ -102,1 +102,4 @@\n-    fp = *(intptr_t**)(f.sp() - frame::sender_sp_offset); \/\/ we need to re-read fp because it may be an oop and we might have had a safepoint in finalize_freeze, after constructing f.\n+    \/\/ We need to re-read fp out of the frame because it may be an oop and we might have\n+    \/\/ had a safepoint in finalize_freeze, after constructing f.\n+    fp = *(intptr_t**)(f.sp() - frame::sender_sp_offset);\n+\n@@ -194,1 +197,1 @@\n-template<typename FKind> frame ThawBase::new_frame(const frame& hf, frame& caller, bool bottom) {\n+template<typename FKind> frame ThawBase::new_stack_frame(const frame& hf, frame& caller, bool bottom) {\n@@ -198,1 +201,1 @@\n-    intptr_t* hsp = hf.unextended_sp();\n+    intptr_t* heap_sp = hf.unextended_sp();\n@@ -201,2 +204,2 @@\n-    intptr_t* vsp = caller.unextended_sp() - fsize;\n-    intptr_t* fp = vsp + (hf.fp() - hsp);\n+    intptr_t* frame_sp = caller.unextended_sp() - fsize;\n+    intptr_t* fp = frame_sp + (hf.fp() - heap_sp);\n@@ -204,1 +207,1 @@\n-    assert(vsp == unextended_sp, \"\");\n+    assert(frame_sp == unextended_sp, \"\");\n@@ -206,1 +209,1 @@\n-    frame f(vsp, vsp, fp, hf.pc());\n+    frame f(frame_sp, frame_sp, fp, hf.pc());\n@@ -214,1 +217,1 @@\n-    intptr_t* vsp = caller.unextended_sp() - fsize;\n+    intptr_t* frame_sp = caller.unextended_sp() - fsize;\n@@ -219,1 +222,1 @@\n-      vsp   -= argsize;\n+      frame_sp   -= argsize;\n@@ -221,1 +224,1 @@\n-      assert(caller.sp() == vsp + (fsize-argsize), \"\");\n+      assert(caller.sp() == frame_sp + (fsize-argsize), \"\");\n@@ -223,1 +226,1 @@\n-      vsp = align(hf, vsp, caller, bottom);\n+      frame_sp = align(hf, frame_sp, caller, bottom);\n@@ -228,2 +231,3 @@\n-    intptr_t* fp = *(intptr_t**)(hf.sp() - frame::sender_sp_offset); \/\/ we need to re-read fp because it may be an oop and we might have fixed the frame.\n-    return frame(vsp, vsp, fp, hf.pc(), hf.cb(), hf.oop_map(), false); \/\/ TODO PERF : this computes deopt state; is it necessary?\n+    \/\/ we need to re-read fp because it may be an oop and we might have fixed the frame.\n+    intptr_t* fp = *(intptr_t**)(hf.sp() - frame::sender_sp_offset);\n+    return frame(frame_sp, frame_sp, fp, hf.pc(), hf.cb(), hf.oop_map(), false); \/\/ TODO PERF : this computes deopt state; is it necessary?\n@@ -233,1 +237,1 @@\n-inline intptr_t* ThawBase::align(const frame& hf, intptr_t* vsp, frame& caller, bool bottom) {\n+inline intptr_t* ThawBase::align(const frame& hf, intptr_t* frame_sp, frame& caller, bool bottom) {\n@@ -235,1 +239,1 @@\n-  if (((intptr_t)vsp & 0xf) != 0) {\n+  if (((intptr_t)frame_sp & 0xf) != 0) {\n@@ -237,1 +241,1 @@\n-    vsp--;\n+    frame_sp--;\n@@ -240,1 +244,1 @@\n-  assert(is_aligned(vsp, frame::frame_alignment), \"\");\n+  assert(is_aligned(frame_sp, frame::frame_alignment), \"\");\n@@ -243,1 +247,1 @@\n-  return vsp;\n+  return frame_sp;\n","filename":"src\/hotspot\/cpu\/x86\/continuation_x86.inline.hpp","additions":26,"deletions":22,"binary":false,"changes":48,"status":"modified"},{"patch":"@@ -59,1 +59,1 @@\n-template<typename FKind> frame FreezeBase::new_hframe(frame& f, frame& caller) {\n+template<typename FKind> frame FreezeBase::new_heap_frame(frame& f, frame& caller) {\n@@ -72,1 +72,1 @@\n-inline void FreezeBase::patch_chunk_pd(intptr_t* vsp, intptr_t* hsp) {\n+inline void FreezeBase::patch_chunk_pd(intptr_t* frame_sp, intptr_t* heap_sp) {\n@@ -81,1 +81,1 @@\n-template<typename FKind> frame ThawBase::new_frame(const frame& hf, frame& caller, bool bottom) {\n+template<typename FKind> frame ThawBase::new_stack_frame(const frame& hf, frame& caller, bool bottom) {\n@@ -94,1 +94,1 @@\n-inline intptr_t* ThawBase::align(const frame& hf, intptr_t* vsp, frame& caller, bool bottom) {\n+inline intptr_t* ThawBase::align(const frame& hf, intptr_t* frame_sp, frame& caller, bool bottom) {\n","filename":"src\/hotspot\/cpu\/zero\/continuation_zero.inline.hpp","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -204,1 +204,1 @@\n-template<typename ConfigT> static inline int freeze0(JavaThread* current, intptr_t* const sp);\n+template<typename ConfigT> static inline int freeze_internal(JavaThread* current, intptr_t* const sp);\n@@ -212,2 +212,2 @@\n-static inline int prepare_thaw0(JavaThread* thread, bool return_barrier);\n-template<typename ConfigT> static inline intptr_t* thaw0(JavaThread* thread, const thaw_kind kind);\n+static inline int prepare_thaw_internal(JavaThread* thread, bool return_barrier);\n+template<typename ConfigT> static inline intptr_t* thaw_internal(JavaThread* thread, const thaw_kind kind);\n@@ -225,1 +225,1 @@\n-    return freeze0<SelfT>(thread, sp);\n+    return freeze_internal<SelfT>(thread, sp);\n@@ -229,1 +229,1 @@\n-    return thaw0<SelfT>(thread, kind);\n+    return thaw_internal<SelfT>(thread, kind);\n@@ -540,1 +540,1 @@\n-  return prepare_thaw0(thread, return_barrier);\n+  return prepare_thaw_internal(thread, return_barrier);\n@@ -953,1 +953,1 @@\n-  inline void patch_chunk_pd(intptr_t* vsp, intptr_t* hsp);\n+  inline void patch_chunk_pd(intptr_t* frame_sp, intptr_t* heap_sp);\n@@ -977,1 +977,1 @@\n-  template<typename FKind> frame new_hframe(frame& f, frame& caller);\n+  template<typename FKind> frame new_heap_frame(frame& f, frame& caller);\n@@ -995,1 +995,1 @@\n-  inline bool is_chunk_available(intptr_t* top_sp\n+  inline bool is_chunk_available(intptr_t* frame_sp\n@@ -1001,1 +1001,1 @@\n-  template <bool chunk_available> bool freeze_fast(intptr_t* top_sp);\n+  template <bool chunk_available> bool freeze_fast(intptr_t* frame_sp);\n@@ -1083,1 +1083,1 @@\n-bool Freeze<ConfigT>::is_chunk_available(intptr_t* top_sp\n+bool Freeze<ConfigT>::is_chunk_available(intptr_t* frame_sp\n@@ -1094,1 +1094,1 @@\n-  \/\/ assert(CodeCache::find_blob(*(address*)(top_sp - SENDER_SP_RET_ADDRESS_OFFSET)) == StubRoutines::cont_doYield_stub(), \"\"); -- fails on Windows\n+  \/\/ assert(CodeCache::find_blob(*(address*)(frame_sp - SENDER_SP_RET_ADDRESS_OFFSET)) == StubRoutines::cont_doYield_stub(), \"\"); -- fails on Windows\n@@ -1096,1 +1096,1 @@\n-  intptr_t* const stack_top     = top_sp + frame::metadata_words;\n+  intptr_t* const stack_top     = frame_sp + frame::metadata_words;\n@@ -1116,1 +1116,1 @@\n-bool Freeze<ConfigT>::freeze_fast(intptr_t* top_sp) {\n+bool Freeze<ConfigT>::freeze_fast(intptr_t* frame_sp) {\n@@ -1122,1 +1122,1 @@\n-  intptr_t* const cont_stack_top    = top_sp + frame::metadata_words;\n+  intptr_t* const cont_stack_top    = frame_sp + frame::metadata_words;\n@@ -1134,1 +1134,1 @@\n-  bool is_chunk_available0 = is_chunk_available(top_sp, &is_chunk_available_size);\n+  bool is_chunk_available0 = is_chunk_available(frame_sp, &is_chunk_available_size);\n@@ -1170,1 +1170,1 @@\n-    assert(!is_chunk_available(top_sp), \"\");\n+    assert(!is_chunk_available(frame_sp), \"\");\n@@ -1560,1 +1560,14 @@\n-NOINLINE freeze_result FreezeBase::recurse_freeze_interpreted_frame(frame& f, frame& caller, int callee_argsize, bool callee_interpreted) {\n+#ifdef ASSERT\n+static void verify_frame_top(const frame& f, intptr_t* top) {\n+  ResourceMark rm;\n+  InterpreterOopMap mask;\n+  f.interpreted_frame_oop_map(&mask);\n+  assert(top <= ContinuationHelper::InterpretedFrame::frame_top(f, &mask),\n+         \"frame_sp: \" INTPTR_FORMAT \" Interpreted::frame_top: \" INTPTR_FORMAT,\n+           p2i(top), p2i(ContinuationHelper::InterpretedFrame::frame_top(f, &mask)));\n+}\n+#endif \/\/ ASSERT\n+\n+NOINLINE freeze_result FreezeBase::recurse_freeze_interpreted_frame(frame& f, frame& caller,\n+                                                                    int callee_argsize,\n+                                                                    bool callee_interpreted) {\n@@ -1563,0 +1576,2 @@\n+    \/\/ yes.\n+    \/\/ ContinuationHelper::InterpretedFrame::adjust_unextended_sp(f)  ?? but why?\n@@ -1567,0 +1582,1 @@\n+                 \/\/ is this ever at safepoint? maybe was for preempt?\n@@ -1573,1 +1589,1 @@\n-  intptr_t* const vsp = ContinuationHelper::InterpretedFrame::frame_top(f, callee_argsize, callee_interpreted);\n+  intptr_t* const frame_sp = ContinuationHelper::InterpretedFrame::frame_top(f, callee_argsize, callee_interpreted);\n@@ -1577,1 +1593,1 @@\n-  const int fsize = f.fp() + frame::metadata_words + locals - vsp;\n+  const int fsize = f.fp() + frame::metadata_words + locals - frame_sp;\n@@ -1579,9 +1595,1 @@\n-#ifdef ASSERT\n-  {\n-    ResourceMark rm;\n-    InterpreterOopMap mask;\n-    f.interpreted_frame_oop_map(&mask);\n-    assert(vsp <= ContinuationHelper::InterpretedFrame::frame_top(f, &mask), \"vsp: \" INTPTR_FORMAT \" Interpreted::frame_top: \" INTPTR_FORMAT,\n-           p2i(vsp), p2i(ContinuationHelper::InterpretedFrame::frame_top(f, &mask)));\n-  }\n-#endif\n+  DEBUG_ONLY(verify_frame_top(f, frame_sp));\n@@ -1605,1 +1613,1 @@\n-  frame hf = new_hframe<ContinuationHelper::InterpretedFrame>(f, caller);\n+  frame hf = new_heap_frame<ContinuationHelper::InterpretedFrame>(f, caller);\n@@ -1607,2 +1615,2 @@\n-  intptr_t* hsp = ContinuationHelper::InterpretedFrame::frame_top(hf, callee_argsize, callee_interpreted);\n-  assert(ContinuationHelper::InterpretedFrame::frame_bottom(hf) == hsp + fsize, \"\");\n+  intptr_t* heap_sp = ContinuationHelper::InterpretedFrame::frame_top(hf, callee_argsize, callee_interpreted);\n+  assert(ContinuationHelper::InterpretedFrame::frame_bottom(hf) == heap_sp + fsize, \"\");\n@@ -1613,2 +1621,2 @@\n-  copy_to_chunk(vsp, hsp, fsize - locals); \/\/ copy rest\n-  assert(!bottom || !caller.is_interpreted_frame() || (hsp + fsize) == (caller.unextended_sp() + argsize), \"\");\n+  copy_to_chunk(frame_sp, heap_sp, fsize - locals); \/\/ copy rest\n+  assert(!bottom || !caller.is_interpreted_frame() || (heap_sp + fsize) == (caller.unextended_sp() + argsize), \"\");\n@@ -1631,1 +1639,1 @@\n-  intptr_t* const vsp = ContinuationHelper::CompiledFrame::frame_top(f, callee_argsize, callee_interpreted);\n+  intptr_t* const frame_sp = ContinuationHelper::CompiledFrame::frame_top(f, callee_argsize, callee_interpreted);\n@@ -1633,1 +1641,1 @@\n-  const int fsize = ContinuationHelper::CompiledFrame::frame_bottom(f) + argsize - vsp;\n+  const int fsize = ContinuationHelper::CompiledFrame::frame_bottom(f) + argsize - frame_sp;\n@@ -1651,1 +1659,1 @@\n-  frame hf = new_hframe<ContinuationHelper::CompiledFrame>(f, caller);\n+  frame hf = new_heap_frame<ContinuationHelper::CompiledFrame>(f, caller);\n@@ -1653,1 +1661,1 @@\n-  intptr_t* hsp = ContinuationHelper::CompiledFrame::frame_top(hf, callee_argsize, callee_interpreted);\n+  intptr_t* heap_sp = ContinuationHelper::CompiledFrame::frame_top(hf, callee_argsize, callee_interpreted);\n@@ -1655,2 +1663,2 @@\n-  copy_to_chunk(vsp, hsp, fsize);\n-  assert(!bottom || !caller.is_compiled_frame() || (hsp + fsize) == (caller.unextended_sp() + argsize), \"\");\n+  copy_to_chunk(frame_sp, heap_sp, fsize);\n+  assert(!bottom || !caller.is_compiled_frame() || (heap_sp + fsize) == (caller.unextended_sp() + argsize), \"\");\n@@ -1672,1 +1680,1 @@\n-  intptr_t* const vsp = ContinuationHelper::StubFrame::frame_top(f, 0, 0);\n+  intptr_t* const frame_sp = ContinuationHelper::StubFrame::frame_top(f, 0, 0);\n@@ -1676,1 +1684,1 @@\n-    f.cb()->name(), _size, fsize, p2i(vsp), p2i(vsp+fsize));\n+    f.cb()->name(), _size, fsize, p2i(frame_sp), p2i(frame_sp+fsize));\n@@ -1706,3 +1714,3 @@\n-  frame hf = new_hframe<ContinuationHelper::StubFrame>(f, caller);\n-  intptr_t* hsp = ContinuationHelper::StubFrame::frame_top(hf, 0, 0);\n-  copy_to_chunk(vsp, hsp, fsize);\n+  frame hf = new_heap_frame<ContinuationHelper::StubFrame>(f, caller);\n+  intptr_t* heap_sp = ContinuationHelper::StubFrame::frame_top(hf, 0, 0);\n+  copy_to_chunk(frame_sp, heap_sp, fsize);\n@@ -1952,1 +1960,1 @@\n-static inline int freeze0(JavaThread* current, intptr_t* const sp) {\n+static inline int freeze_internal(JavaThread* current, intptr_t* const sp) {\n@@ -1954,2 +1962,0 @@\n-  \/\/ This was a bug once?\n-  \/\/ assert(current->deferred_updates() == nullptr || current->deferred_updates()->count() == 0, \"\");\n@@ -1983,3 +1989,0 @@\n-  bool fast = can_freeze_fast(current);\n-  assert(!fast || current->held_monitor_count() == 0, \"\");\n-\n@@ -1988,0 +1991,1 @@\n+  bool fast = can_freeze_fast(current);\n@@ -2066,1 +2070,1 @@\n-static inline int prepare_thaw0(JavaThread* thread, bool return_barrier) {\n+static inline int prepare_thaw_internal(JavaThread* thread, bool return_barrier) {\n@@ -2080,0 +2084,1 @@\n+  \/\/ Comment needed: Why would the tail chunk be empty? Why do you get the parent?\n@@ -2090,0 +2095,1 @@\n+  \/\/ Only make space for the topmost chunk.\n@@ -2099,0 +2105,2 @@\n+  \/\/ 300 is an estimate for stack size taken for this native code, in addition to StackShadowPages\n+  \/\/ for the Java frames in the check below.\n@@ -2146,1 +2154,1 @@\n-  void thaw(const frame& hf, frame& caller, int num_frames, bool top);\n+  void thaw_one_frame(const frame& heap_frame, frame& caller, int num_frames, bool top);\n@@ -2162,1 +2170,1 @@\n-  template<typename FKind> frame new_frame(const frame& hf, frame& caller, bool bottom);\n+  template<typename FKind> frame new_stack_frame(const frame& hf, frame& caller, bool bottom);\n@@ -2164,1 +2172,1 @@\n-  inline intptr_t* align(const frame& hf, intptr_t* vsp, frame& caller, bool bottom);\n+  inline intptr_t* align(const frame& hf, intptr_t* frame_sp, frame& caller, bool bottom);\n@@ -2189,0 +2197,1 @@\n+  \/\/ Comment in assert needed: is entryPC in the heap? or enterSpecial stub frame?\n@@ -2199,0 +2208,1 @@\n+  \/\/ I have no idea what config does in this function.\n@@ -2206,1 +2216,0 @@\n-  assert(chunk != nullptr, \"\");\n@@ -2208,1 +2217,0 @@\n-  assert(!chunk->is_empty(), \"\");\n@@ -2223,0 +2231,1 @@\n+  \/\/ Below this heuristic, we thaw the whole chunk, above it we thaw just one frame.\n@@ -2341,3 +2350,0 @@\n-  assert(!_cont.is_empty(), \"\");\n-  assert(chunk != nullptr, \"\");\n-  assert(!chunk->is_empty(), \"\");\n@@ -2352,0 +2358,1 @@\n+  \/\/ Does this need ifdef JFR around it? Or can we remove all the conditional JFR inclusions (better)?\n@@ -2366,1 +2373,1 @@\n-  frame hf = _stream.to_frame();\n+  frame heap_frame = _stream.to_frame();\n@@ -2370,2 +2377,2 @@\n-    assert(hf.is_heap_frame(), \"should have created a relative frame\");\n-    hf.print_on(&ls);\n+    assert(heap_frame.is_heap_frame(), \"should have created a relative frame\");\n+    heap_frame.print_on(&ls);\n@@ -2374,3 +2381,3 @@\n-  frame f;\n-  thaw(hf, f, num_frames, true);\n-  finish_thaw(f); \/\/ f is now the topmost thawed frame\n+  frame caller;\n+  thaw_one_frame(heap_frame, caller, num_frames, true);\n+  finish_thaw(caller); \/\/ caller is now the topmost thawed frame\n@@ -2385,1 +2392,1 @@\n-  intptr_t* sp = f.sp();\n+  intptr_t* sp = caller.sp();\n@@ -2402,1 +2409,1 @@\n-void ThawBase::thaw(const frame& hf, frame& caller, int num_frames, bool top) {\n+void ThawBase::thaw_one_frame(const frame& heap_frame, frame& caller, int num_frames, bool top) {\n@@ -2406,1 +2413,1 @@\n-  assert(!hf.is_empty(), \"\");\n+  assert(!heap_frame.is_empty(), \"\");\n@@ -2408,5 +2415,5 @@\n-  if (top && hf.is_safepoint_blob_frame()) {\n-    assert(ContinuationHelper::Frame::is_stub(hf.cb()), \"cb: %s\", hf.cb()->name());\n-    recurse_thaw_stub_frame(hf, caller, num_frames);\n-  } else if (!hf.is_interpreted_frame()) {\n-    recurse_thaw_compiled_frame(hf, caller, num_frames, false);\n+  if (top && heap_frame.is_safepoint_blob_frame()) {\n+    assert(ContinuationHelper::Frame::is_stub(heap_frame.cb()), \"cb: %s\", heap_frame.cb()->name());\n+    recurse_thaw_stub_frame(heap_frame, caller, num_frames);\n+  } else if (!heap_frame.is_interpreted_frame()) {\n+    recurse_thaw_compiled_frame(heap_frame, caller, num_frames, false);\n@@ -2414,1 +2421,1 @@\n-    recurse_thaw_interpreted_frame(hf, caller, num_frames);\n+    recurse_thaw_interpreted_frame(heap_frame, caller, num_frames);\n@@ -2440,1 +2447,1 @@\n-    thaw(_stream.to_frame(), caller, num_frames - 1, false);\n+    thaw_one_frame(_stream.to_frame(), caller, num_frames - 1, false);\n@@ -2526,1 +2533,1 @@\n-  frame f = new_frame<ContinuationHelper::InterpretedFrame>(hf, caller, bottom);\n+  frame f = new_stack_frame<ContinuationHelper::InterpretedFrame>(hf, caller, bottom);\n@@ -2528,2 +2535,2 @@\n-  intptr_t* const vsp = f.sp();\n-  intptr_t* const hsp = hf.unextended_sp();\n+  intptr_t* const frame_sp = f.sp();\n+  intptr_t* const heap_sp = hf.unextended_sp();\n@@ -2533,1 +2540,1 @@\n-  const int fsize = ContinuationHelper::InterpretedFrame::frame_bottom(hf) - hsp;\n+  const int fsize = ContinuationHelper::InterpretedFrame::frame_bottom(hf) - heap_sp;\n@@ -2535,2 +2542,2 @@\n-  assert(!bottom || vsp + fsize >= _cont.entrySP() - 2, \"\");\n-  assert(!bottom || vsp + fsize <= _cont.entrySP(), \"\");\n+  assert(!bottom || frame_sp + fsize >= _cont.entrySP() - 2, \"\");\n+  assert(!bottom || frame_sp + fsize <= _cont.entrySP(), \"\");\n@@ -2538,1 +2545,1 @@\n-  assert(ContinuationHelper::InterpretedFrame::frame_bottom(f) == vsp + fsize, \"\");\n+  assert(ContinuationHelper::InterpretedFrame::frame_bottom(f) == frame_sp + fsize, \"\");\n@@ -2547,1 +2554,1 @@\n-  copy_from_chunk(hsp, vsp, fsize - locals); \/\/ copy rest\n+  copy_from_chunk(heap_sp, frame_sp, fsize - locals); \/\/ copy rest\n@@ -2598,3 +2605,3 @@\n-  frame f = new_frame<ContinuationHelper::CompiledFrame>(hf, caller, bottom);\n-  intptr_t* const vsp = f.sp();\n-  intptr_t* const hsp = hf.unextended_sp();\n+  frame f = new_stack_frame<ContinuationHelper::CompiledFrame>(hf, caller, bottom);\n+  intptr_t* const frame_sp = f.sp();\n+  intptr_t* const heap_sp = hf.unextended_sp();\n@@ -2606,2 +2613,2 @@\n-  intptr_t* from = hsp - frame::metadata_words;\n-  intptr_t* to   = vsp - frame::metadata_words;\n+  intptr_t* from = heap_sp - frame::metadata_words;\n+  intptr_t* to   = frame_sp - frame::metadata_words;\n@@ -2642,1 +2649,1 @@\n-    clear_bitmap_bits(hsp + ContinuationHelper::CompiledFrame::size(hf), added_argsize);\n+    clear_bitmap_bits(heap_sp + ContinuationHelper::CompiledFrame::size(hf), added_argsize);\n@@ -2673,3 +2680,3 @@\n-  frame f = new_frame<ContinuationHelper::StubFrame>(hf, caller, false);\n-  intptr_t* vsp = f.sp();\n-  intptr_t* hsp = hf.sp();\n+  frame f = new_stack_frame<ContinuationHelper::StubFrame>(hf, caller, false);\n+  intptr_t* frame_sp = f.sp();\n+  intptr_t* heap_sp = hf.sp();\n@@ -2677,1 +2684,1 @@\n-  copy_from_chunk(hsp - frame::metadata_words, vsp - frame::metadata_words,\n+  copy_from_chunk(heap_sp - frame::metadata_words, frame_sp - frame::metadata_words,\n@@ -2750,1 +2757,1 @@\n-static inline intptr_t* thaw0(JavaThread* thread, const thaw_kind kind) {\n+static inline intptr_t* thaw_internal(JavaThread* thread, const thaw_kind kind) {\n","filename":"src\/hotspot\/share\/runtime\/continuation.cpp","additions":102,"deletions":95,"binary":false,"changes":197,"status":"modified"}]}