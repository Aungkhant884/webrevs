{"files":[{"patch":"@@ -229,1 +229,1 @@\n-JvmtiVTMTDisabler::print_info(JavaThread* thread) {\n+JvmtiVTMTDisabler::print_info() {\n@@ -232,1 +232,2 @@\n-    tty->print_cr(\"Thread %s VTMT state %s. Stacktrace:\", java_thread->name(), (java_thread->is_in_VTMT() ? \"true\": \"false\"));\n+    ResourceMark rm;\n+    tty->print_cr(\"Thread %s, is_in_VTMT = %s. Stacktrace:\", java_thread->name(), (java_thread->is_in_VTMT() ? \"true\": \"false\"));\n@@ -235,0 +236,1 @@\n+    tty->print_cr(\"\");\n@@ -243,5 +245,4 @@\n-  ThreadBlockInVM tbivm(thread);\n-  MonitorLocker ml(JvmtiVTMT_lock, Mutex::_no_safepoint_check_flag);\n-\n-  assert(!thread->is_in_VTMT(), \"VTMT sanity check\");\n-  _VTMT_disable_count++;\n+  int attempts = 10;\n+  {\n+    ThreadBlockInVM tbivm(thread);\n+    MonitorLocker ml(JvmtiVTMT_lock, Mutex::_no_safepoint_check_flag);\n@@ -249,2 +250,2 @@\n-  \/\/ Block while some mount\/unmount transitions are in progress.\n-  \/\/ Debug version fails and print diagnostic information\n+    assert(!thread->is_in_VTMT(), \"VTMT sanity check\");\n+    _VTMT_disable_count++;\n@@ -252,8 +253,7 @@\n-  \/\/DEBUG_ONLY(int attempts = 10);\n-  while (_VTMT_count > 0) {\n-    ml.wait(1000);\n-    \/*\n-     Temporary disabled until fixed\n-    if (--attempts == 0) {\n-      print_info(thread);\n-      assert(false, \"stuck in VTMT disabler for 10 seconds.\");\n+    \/\/ Block while some mount\/unmount transitions are in progress.\n+    \/\/ Debug version fails and print diagnostic information\n+    while (_VTMT_count > 0) {\n+      if (ml.wait(1000)) {\n+        attempts--;\n+      }\n+      DEBUG_ONLY(if (attempts == 0) break;)\n@@ -261,1 +261,9 @@\n-    *\/\n+    assert(!thread->is_VTMT_disabler(), \"VTMT sanity check\");\n+    if (attempts != 0) {\n+      thread->set_is_VTMT_disabler(true);\n+    }\n+  }\n+#ifdef ASSERT\n+  if (attempts == 0) {\n+    print_info();\n+    assert(false, \"stuck in VTMT disabler for 10 seconds.\");\n@@ -263,2 +271,1 @@\n-  assert(!thread->is_VTMT_disabler(), \"VTMT sanity check\");\n-  thread->set_is_VTMT_disabler(true);\n+#endif\n","filename":"src\/hotspot\/share\/prims\/jvmtiThreadState.cpp","additions":27,"deletions":20,"binary":false,"changes":47,"status":"modified"},{"patch":"@@ -88,1 +88,1 @@\n-  DEBUG_ONLY(static void print_info(JavaThread* thread);)\n+  DEBUG_ONLY(static void print_info();)\n","filename":"src\/hotspot\/share\/prims\/jvmtiThreadState.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}