{"files":[{"patch":"@@ -616,1 +616,1 @@\n-  \/\/ The second condition is needed to hide notification methods. \n+  \/\/ The second condition is needed to hide notification methods.\n@@ -1499,1 +1499,1 @@\n-  } \n+  }\n@@ -1687,1 +1687,1 @@\n-  \n+\n@@ -1784,1 +1784,1 @@\n-    \n+\n@@ -2205,0 +2205,23 @@\n+#ifdef ASSERT\n+void\n+PrintStackTraceClosure::do_thread(Thread *target) {\n+  JavaThread *java_thread = JavaThread::cast(target);\n+  Thread *current_thread = Thread::current();\n+  assert(SafepointSynchronize::is_at_safepoint() ||\n+      java_thread->is_handshake_safe_for(current_thread),\n+         \"call by myself \/ at safepoint \/ at handshake\");\n+  if (java_thread->has_last_Java_frame()) {\n+    RegisterMap reg_map(java_thread, true, true);\n+    ResourceMark rm(current_thread);\n+    HandleMark hm(current_thread);\n+    javaVFrame *jvf = JvmtiEnvBase::get_last_java_vframe(java_thread, &reg_map);\n+    while (jvf != NULL) {\n+      tty->print_cr(\"  %s:%d\",\n+                    jvf->method()->external_name(),\n+                    jvf->method()->line_number_from_bci(jvf->bci()));\n+      jvf = jvf->java_sender();\n+    }\n+  }\n+}\n+#endif\n+\n","filename":"src\/hotspot\/share\/prims\/jvmtiEnvBase.cpp","additions":27,"deletions":4,"binary":false,"changes":31,"status":"modified"},{"patch":"@@ -544,0 +544,10 @@\n+#ifdef ASSERT\n+\/\/ HandshakeClosure to print stack trace in JvmtiVTMTDisabler error handling\n+class PrintStackTraceClosure : public HandshakeClosure {\n+ public:\n+  PrintStackTraceClosure()\n+      : HandshakeClosure(\"PrintStackTraceClosure\") {}\n+  void do_thread(Thread *target);\n+};\n+#endif\n+\n@@ -650,1 +660,1 @@\n-private: \n+private:\n@@ -662,1 +672,1 @@\n-  \n+\n@@ -794,1 +804,1 @@\n-                              jvmtiFrameInfo* frame_buffer, jint* count_ptr) \n+                              jvmtiFrameInfo* frame_buffer, jint* count_ptr)\n","filename":"src\/hotspot\/share\/prims\/jvmtiEnvBase.hpp","additions":13,"deletions":3,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -36,0 +36,1 @@\n+#include \"runtime\/stackFrameStream.inline.hpp\"\n@@ -37,0 +38,1 @@\n+#include \"prims\/jvmtiEnvBase.hpp\"\n@@ -225,0 +227,13 @@\n+#ifdef ASSERT\n+void\n+JvmtiVTMTDisabler::print_info(JavaThread* thread) {\n+  tty->print_cr(\"VTMT disabled with count = %d.\\n\", _VTMT_count);\n+  for (JavaThreadIteratorWithHandle jtiwh; JavaThread *java_thread = jtiwh.next(); ) {\n+    tty->print_cr(\"Thread %s VTMT state %s. Stacktrace:\", java_thread->name(), (java_thread->is_in_VTMT() ? \"true\": \"false\"));\n+    \/\/ Handshake with target\n+    PrintStackTraceClosure pstc;\n+    Handshake::execute(&pstc, java_thread);\n+  }\n+}\n+#endif\n+\n@@ -235,0 +250,11 @@\n+  \/\/ Debug version fails and print diagnostic information\n+#ifdef ASSERT\n+  int attempts = 10;\n+  while (_VTMT_count > 0) {\n+    ml.wait(1000);\n+    if (--attempts == 0) {\n+      print_info(thread);\n+      assert(false, \"stuck in VTMT disabler for 10 seconds.\");\n+    }\n+  }\n+#else\n@@ -236,1 +262,1 @@\n-    ml.wait();\n+    ml.wait(;\n@@ -238,0 +264,1 @@\n+#endif\n","filename":"src\/hotspot\/share\/prims\/jvmtiThreadState.cpp","additions":28,"deletions":1,"binary":false,"changes":29,"status":"modified"},{"patch":"@@ -87,0 +87,3 @@\n+#ifdef ASSERT\n+  static void print_info(JavaThread* thread);\n+#endif\n","filename":"src\/hotspot\/share\/prims\/jvmtiThreadState.hpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"}]}