{"files":[{"patch":"@@ -2205,1 +2205,1 @@\n-\n+#ifdef ASSERT\n@@ -2213,1 +2213,0 @@\n-  int count = 0;\n@@ -2218,1 +2217,0 @@\n-\n@@ -2221,1 +2219,3 @@\n-      tty->print_cr(\"%s\", jvf->method()->external_name());\n+      tty->print_cr(\"  %s:%d\",\n+                    jvf->method()->external_name(),\n+                    jvf->method()->line_number_from_bci(jvf->bci()));\n@@ -2226,0 +2226,1 @@\n+#endif\n","filename":"src\/hotspot\/share\/prims\/jvmtiEnvBase.cpp","additions":5,"deletions":4,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -544,1 +544,2 @@\n-\/\/ HandshakeClosure to print stack trace.\n+#ifdef ASSERT\n+\/\/ HandshakeClosure to print stack trace in JvmtiVTMTDisabler error handling\n@@ -551,0 +552,1 @@\n+#endif\n","filename":"src\/hotspot\/share\/prims\/jvmtiEnvBase.hpp","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -227,0 +227,13 @@\n+#ifdef ASSERT\n+void\n+JvmtiVTMTDisabler::print_info(JavaThread* thread) {\n+  tty->print_cr(\"VTMT disabled with count = %d.\\n\", _VTMT_count);\n+  for (JavaThreadIteratorWithHandle jtiwh; JavaThread *java_thread = jtiwh.next(); ) {\n+    tty->print_cr(\"Thread %s VTMT state %s. Stacktrace:\", java_thread->name(), (java_thread->is_in_VTMT() ? \"true\": \"false\"));\n+    \/\/ Handshake with target\n+    PrintStackTraceClosure pstc;\n+    Handshake::execute(&pstc, java_thread);\n+  }\n+}\n+#endif\n+\n@@ -237,0 +250,2 @@\n+  \/\/ Debug version fails and print diagnostic information\n+#ifdef ASSERT\n@@ -240,12 +255,3 @@\n-    attempts--;\n-    if (attempts <= 0) {\n-      tty->print_cr(\"VTMT disabled with count = %d. ThreadList: \\n\", _VTMT_count);\n-      for (JavaThreadIteratorWithHandle jtiwh; JavaThread *java_thread = jtiwh.next(); ) {\n-        tty->print_cr(\"Thread %s VTMT state %s. Info:\", java_thread->name(), (java_thread->is_in_VTMT() ? \"true\": \"false\"));\n-        \/\/ Handshake with target\n-        ResourceMark rm(thread);\n-        HandleMark   hm(thread);\n-        PrintStackTraceClosure pstc;\n-        Handshake::execute(&pstc, java_thread);\n-      }\n-      guarantee(--attempts > 0, \"stuck in VTMT disabler.\");\n+    if (--attempts == 0) {\n+      print_info(thread);\n+      assert(false, \"stuck in VTMT disabler for 10 seconds.\");\n@@ -254,0 +260,5 @@\n+#else\n+  while (_VTMT_count > 0) {\n+    ml.wait(;\n+  }\n+#endif\n","filename":"src\/hotspot\/share\/prims\/jvmtiThreadState.cpp","additions":23,"deletions":12,"binary":false,"changes":35,"status":"modified"},{"patch":"@@ -87,0 +87,3 @@\n+#ifdef ASSERT\n+  static void print_info(JavaThread* thread);\n+#endif\n","filename":"src\/hotspot\/share\/prims\/jvmtiThreadState.hpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"}]}