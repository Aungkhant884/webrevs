{"files":[{"patch":"@@ -92,1 +92,6 @@\n-        Collection<String> messages = Utils.tryWith(\"sudo\", \"kill\", \"-TERM\", Long.toString(pid));\n+        long dtracePid = Utils.getPid(dtraceProcess);\n+        if (dtracePid == 0) {\n+            throw new IllegalStateException(\"Cannot determine dtrace process PID\");\n+        }\n+\n+        Collection<String> messages = Utils.tryWith(\"sudo\", \"kill\", \"-TERM\", Long.toString(dtracePid));\n@@ -97,0 +102,1 @@\n+        \/\/ Wait for dtrace to finish.\n@@ -98,3 +104,4 @@\n-            \/\/ dtrace would exit with non-zero exit code due to TERM,\n-            \/\/ so we cannot test for errcode == 0 on this path.\n-            dtraceProcess.waitFor();\n+            int errcode = dtraceProcess.waitFor();\n+            if (errcode != 0) {\n+                throw new IllegalStateException(\"Non-zero error code from dtrace: \" + errcode);\n+            }\n","filename":"jmh-core\/src\/main\/java\/org\/openjdk\/jmh\/profile\/DTraceAsmProfiler.java","additions":11,"deletions":4,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -443,0 +443,48 @@\n+    \/**\n+     * Gets the PID of the target process.\n+     * @param process to poll\n+     * @return PID, or zero if no PID is found\n+     *\/\n+    public static long getPid(Process process) {\n+        \/\/ Step 1. Try Process.pid, available since Java 9.\n+        try {\n+            Method m = Process.class.getMethod(\"pid\");\n+            Object pid = m.invoke(process);\n+            if (pid instanceof Long) {\n+                return (long) pid;\n+            }\n+        } catch (NoSuchMethodException | InvocationTargetException | IllegalAccessException e) {\n+            \/\/ Fallthrough\n+        }\n+\n+        \/\/ Step 2. Try to hack into the JDK 8 UNIXProcess.\n+        try {\n+            Class<?> c = Class.forName(\"java.lang.UNIXProcess\");\n+            Field f = c.getDeclaredField(\"pid\");\n+            setAccessible(process, f);\n+            Object o = f.get(process);\n+            if (o instanceof Integer) {\n+                return (int) o;\n+            }\n+        } catch (NoSuchFieldException | ClassNotFoundException | IllegalAccessException e) {\n+            \/\/ Fallthrough.\n+        }\n+\n+        \/\/ Step 3. Try to hack into JDK 9+ ProcessImpl.\n+        \/\/ Renamed from UNIXProcess with JDK-8071481.\n+        try {\n+            Class<?> c = Class.forName(\"java.lang.ProcessImpl\");\n+            Field f = c.getDeclaredField(\"pid\");\n+            setAccessible(process, f);\n+            Object o = f.get(process);\n+            if (o instanceof Integer) {\n+                return (int) o;\n+            }\n+        } catch (NoSuchFieldException | ClassNotFoundException | IllegalAccessException e) {\n+            \/\/ Fallthrough.\n+        }\n+\n+        \/\/ No dice, return bad PID.\n+        return 0;\n+    }\n+\n","filename":"jmh-core\/src\/main\/java\/org\/openjdk\/jmh\/util\/Utils.java","additions":48,"deletions":0,"binary":false,"changes":48,"status":"modified"},{"patch":"@@ -30,0 +30,1 @@\n+import java.io.IOException;\n@@ -35,2 +36,12 @@\n-    public void testPID() {\n-        Assert.assertFalse(Utils.getPid() == 0);\n+    public void testPID_Current() {\n+        Assert.assertNotSame(0, Utils.getPid());\n+    }\n+\n+    @Test\n+    public void testPID_Other() throws IOException, InterruptedException {\n+        if (!Utils.isWindows()) {\n+            ProcessBuilder pb = new ProcessBuilder().command(\"sleep\", \"1\");\n+            Process p = pb.start();\n+            Assert.assertNotSame(0, Utils.getPid(p));\n+            p.waitFor();\n+        }\n","filename":"jmh-core\/src\/test\/java\/org\/openjdk\/jmh\/util\/TestUtil.java","additions":13,"deletions":2,"binary":false,"changes":15,"status":"modified"}]}