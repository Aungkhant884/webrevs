{"files":[{"patch":"@@ -188,2 +188,4 @@\n-        FileChannel channel = null;\n-        FileLock lock = null;\n+\n+        final String tailMsg = \" the JMH lock (\" + JMH_LOCK_FILE + \"), exiting. Use -Djmh.ignoreLock=true to forcefully continue.\";\n+\n+        File lockFile;\n@@ -191,0 +193,3 @@\n+            lockFile = new File(JMH_LOCK_FILE);\n+            lockFile.createNewFile();\n+\n@@ -193,11 +198,4 @@\n-            File file = new File(JMH_LOCK_FILE);\n-            file.createNewFile();\n-            file.setWritable(true, false);\n-\n-            channel = new RandomAccessFile(file, \"rw\").getChannel();\n-\n-            try {\n-                lock = channel.tryLock();\n-            } catch (OverlappingFileLockException e) {\n-                \/\/ fall-through\n-            }\n+            lockFile.setWritable(true, false);\n+        } catch (IOException e) {\n+            throw new RunnerException(\"ERROR: Unable to create\" + tailMsg, e);\n+        }\n@@ -205,0 +203,2 @@\n+        try (RandomAccessFile raf = new RandomAccessFile(lockFile, \"rw\");\n+             FileLock lock = raf.getChannel().tryLock()) {\n@@ -206,1 +206,2 @@\n-                throw new RunnerException(\"ERROR: Unable to acquire the JMH lock (\" + JMH_LOCK_FILE + \"): already taken by another JMH instance, exiting. Use -Djmh.ignoreLock=true to forcefully continue.\");\n+                \/\/ Lock acquisition failed, pretend this was the overlap.\n+                throw new OverlappingFileLockException();\n@@ -208,1 +209,0 @@\n-\n@@ -210,0 +210,2 @@\n+        } catch (OverlappingFileLockException e) {\n+            throw new RunnerException(\"ERROR: Another JMH instance might be running. Unable to acquire\" + tailMsg);\n@@ -211,10 +213,1 @@\n-            throw new RunnerException(\"ERROR: Exception while trying to acquire the JMH lock (\" + JMH_LOCK_FILE + \"), exiting. Use -Djmh.ignoreLock=true to forcefully continue.\", e);\n-        } finally {\n-            try {\n-                if (lock != null) {\n-                    lock.release();\n-                }\n-            } catch (IOException e) {\n-                \/\/ do nothing\n-            }\n-            FileUtils.safelyClose(channel);\n+            throw new RunnerException(\"ERROR: Unexpected exception while trying to acquire\" + tailMsg, e);\n","filename":"jmh-core\/src\/main\/java\/org\/openjdk\/jmh\/runner\/Runner.java","additions":18,"deletions":25,"binary":false,"changes":43,"status":"modified"}]}