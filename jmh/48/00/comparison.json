{"files":[{"patch":"@@ -28,1 +28,1 @@\n-import org.openjdk.jmh.util.JDKVersion;\n+import org.openjdk.jmh.util.Utils;\n@@ -240,0 +240,3 @@\n+    private static BlackholeMode blackholeMode;\n+    private static BlackholeDetectMode blackholeDetectMode;\n+\n@@ -241,0 +244,4 @@\n+        if (blackholeMode != null) {\n+            return blackholeMode;\n+        }\n+\n@@ -244,1 +251,2 @@\n-                return BlackholeMode.valueOf(prop);\n+                blackholeMode = BlackholeMode.valueOf(prop);\n+                blackholeDetectMode = BlackholeDetectMode.FORCED;\n@@ -248,0 +256,6 @@\n+        } else if (compilerBlackholesAvailable()) {\n+            blackholeMode = BlackholeMode.COMPILER;\n+            blackholeDetectMode = BlackholeDetectMode.AUTO;\n+        } else {\n+            blackholeMode = BlackholeMode.FULL_DONTINLINE;\n+            blackholeDetectMode = BlackholeDetectMode.FALLBACK;\n@@ -249,1 +263,7 @@\n-        return BlackholeMode.FULL_DONTINLINE;\n+\n+        return blackholeMode;\n+    }\n+\n+    private static BlackholeDetectMode blackholeDetectMode() {\n+        blackholeMode();\n+        return blackholeDetectMode;\n@@ -254,1 +274,1 @@\n-        out.print(\"# Blackhole mode: \" + mode.desc());\n+        out.print(\"# Blackhole mode: \" + mode.desc() + \" (\" + blackholeDetectMode().desc() + \")\");\n@@ -259,1 +279,1 @@\n-        COMPILER(true, false, \"compiler-assisted (EXPERIMENTAL, check generated code)\"),\n+        COMPILER(true, false, \"compiler-assisted\"),\n@@ -261,1 +281,1 @@\n-        FULL(false, false, \"full (DIAGNOSTIC)\"),\n+        FULL(false, false, \"full\"),\n@@ -285,0 +305,53 @@\n+    private enum BlackholeDetectMode {\n+        FALLBACK(\"fallback\"),\n+        AUTO(\"auto-detected, use -D\" + BLACKHOLE_PROP_NAME + \" to override\"),\n+        FORCED(\"forced\"),\n+        ;\n+\n+        final String desc;\n+\n+        BlackholeDetectMode(String desc) {\n+            this.desc = desc;\n+        }\n+\n+        public String desc() {\n+            return desc;\n+        }\n+    }\n+\n+    private static boolean compilerBlackholesAvailable() {\n+        \/\/ Step 1. See if there were any error messages from CompilerOracle\n+        {\n+            List<String> cmd = new ArrayList<>();\n+            cmd.add(Utils.getCurrentJvm());\n+            cmd.add(\"-XX:+UnlockExperimentalVMOptions\");\n+            cmd.add(\"-XX:CompileCommand=quiet\");\n+            cmd.add(\"-XX:CompileCommand=blackhole,some\/fake\/Class.method\");\n+            cmd.add(\"-version\");\n+\n+            Collection<String> log = Utils.runWith(cmd);\n+            for (String l : log) {\n+                if (l.contains(\"CompilerOracle\")) return false;\n+                if (l.contains(\"CompileCommand\")) return false;\n+            }\n+        }\n+\n+        \/\/ Step 2. See that CompilerOracle accepted the command explicitly\n+        {\n+            List<String> cmd = new ArrayList<>();\n+            cmd.add(Utils.getCurrentJvm());\n+            cmd.add(\"-XX:+UnlockExperimentalVMOptions\");\n+            cmd.add(\"-XX:CompileCommand=blackhole,some\/fake\/Class.method\");\n+            cmd.add(\"-version\");\n+\n+            Collection<String> log = Utils.runWith(cmd);\n+            for (String l : log) {\n+                if (l.contains(\"CompilerOracle\")) return true;\n+                if (l.contains(\"CompileCommand\")) return true;\n+            }\n+        }\n+\n+        \/\/ Err on the side of the caution: compiler blackholes are not available.\n+        return false;\n+    }\n+\n","filename":"jmh-core\/src\/main\/java\/org\/openjdk\/jmh\/runner\/CompilerHints.java","additions":79,"deletions":6,"binary":false,"changes":85,"status":"modified"}]}