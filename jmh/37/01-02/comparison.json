{"files":[{"patch":"@@ -48,0 +48,1 @@\n+import java.util.HashSet;\n@@ -58,1 +59,0 @@\n-    private static final String DEFAULT_EVENT = \"cpu\";\n@@ -66,2 +66,1 @@\n-    private final List<String> events;\n-    private final String onlyEvent;\n+    private final String outputFilePrefix;\n@@ -73,1 +72,1 @@\n-    private boolean isVersion1x = false;\n+    private boolean isVersion1x;\n@@ -75,2 +74,2 @@\n-    private boolean warmupStarted = false;\n-    private boolean measurementStarted = false;\n+    private boolean warmupStarted;\n+    private boolean measurementStarted;\n@@ -86,2 +85,2 @@\n-                \"Output format(s). Supported: \" + EnumSet.allOf(OutputType.class).toString() + \".\")\n-                .withRequiredArg().ofType(OutputType.class).withValuesSeparatedBy(\",\").describedAs(\"format+\").defaultsTo(OutputType.text);\n+                \"Output format(s). Supported: \" + EnumSet.allOf(OutputType.class) + \".\")\n+                .withRequiredArg().ofType(OutputType.class).withValuesSeparatedBy(\",\").describedAs(\"format+\");\n@@ -100,2 +99,10 @@\n-                \"Event(s) to sample: cpu, alloc, lock, wall, itimer; com.foo.Bar.methodName; any event from `perf list` e.g. cache-misses\")\n-                .withRequiredArg().ofType(String.class).describedAs(\"event\").defaultsTo(DEFAULT_EVENT);\n+                \"Event to sample: cpu, alloc, lock, wall, itimer; com.foo.Bar.methodName; any event from `perf list` e.g. cache-misses\")\n+                .withRequiredArg().ofType(String.class).describedAs(\"event\").defaultsTo(\"cpu\");\n+\n+        String secondaryEventOk = \"May be captured as a secondary event under output=jfr.\";\n+        OptionSpec<String> optAlloc = parser.accepts(\"alloc\",\n+                \"Enable allocation profiling. Optional argument (e.g. =512k) reduces sampling from the default of one-sample-per-TLAB. \" + secondaryEventOk)\n+                .withOptionalArg().ofType(String.class).describedAs(\"sample bytes\");\n+        OptionSpec<String> optLock = parser.accepts(\"lock\",\n+                \"Enable lock profiling. Optional argument (e.g. =1ms) limits capture based on lock duration. \" + secondaryEventOk)\n+                .withOptionalArg().ofType(String.class).describedAs(\"duration\");\n@@ -195,2 +202,1 @@\n-            this.events = optEvent.values(set);\n-            builder.appendMulti(optEvent);\n+\n@@ -228,3 +234,2 @@\n-            this.traces = optTraces.value(set);\n-            this.flat = optFlat.value(set);\n-            this.profilerConfig = profilerOptions.toString();\n+            traces = optTraces.value(set);\n+            flat = optFlat.value(set);\n@@ -243,0 +248,1 @@\n+            verbose = optVerbose.value(set);\n@@ -245,2 +251,2 @@\n-                if (version.startsWith(\"1.\")) {\n-                    isVersion1x = true;\n+                if (verbose) {\n+                    System.out.println(\"[async-profiler] version=\" + version);\n@@ -248,0 +254,1 @@\n+                isVersion1x = version.startsWith(\"1.\");\n@@ -251,3 +258,41 @@\n-            this.direction = optDirection.value(set);\n-            this.output = optOutput.values(set);\n-            if (events.size() > 1) {\n+            direction = optDirection.value(set);\n+\n+            \/\/ Secondary events are those that may be collected simultaneously with a primary event in a JFR profile.\n+            \/\/ To be used as such, we require they are specifed with the lock and alloc option, rather than event=lock,\n+            \/\/ event=alloc.\n+            HashSet<String> secondaryEvents = new HashSet<>();\n+\n+            if (set.has(optAlloc)) {\n+                secondaryEvents.add(\"alloc\");\n+                builder.append(optAlloc);\n+            }\n+\n+            if (set.has(optLock)) {\n+                secondaryEvents.add(\"lock\");\n+                builder.append(optLock);\n+            }\n+\n+            if (set.has(optEvent)) {\n+                builder.append(optEvent);\n+                outputFilePrefix = set.valueOf(optEvent);\n+            } else {\n+                if (secondaryEvents.size() == 0) {\n+                    \/\/ Default to the cpu event if no events at all are selected.\n+                    builder.appendRaw(\"event=cpu\");\n+                    outputFilePrefix = \"cpu\";\n+                } else if (secondaryEvents.size() == 1) {\n+                    \/\/ No primary event, one secondary -- promote it to the primary event. This means any output\n+                    \/\/ format is allowed and the event name will be included in the output file name.\n+                    outputFilePrefix = secondaryEvents.iterator().next();\n+                    secondaryEvents.clear();\n+                } else {\n+                    outputFilePrefix = \"profile\";\n+                }\n+            }\n+\n+            List<OutputType> output = new ArrayList<>(optOutput.values(set));\n+            if (secondaryEvents.isEmpty()) {\n+                if (output.isEmpty()) {\n+                    output.add(OutputType.text);\n+                }\n+            } else {\n@@ -257,2 +302,4 @@\n-                if (output.size() > 1 || output.get(0) != OutputType.jfr) {\n-                    throw new ProfilerException(\"When multiple events are selected, the only output=jfr is supported, found: \" + output);\n+                if (output.isEmpty()) {\n+                    output.add(OutputType.jfr);\n+                } else if (output.size() > 1 || output.get(0) != OutputType.jfr) {\n+                    throw new ProfilerException(\"When multiple events are selected, only output=\" + OutputType.jfr.name() + \" is supported, found: \" + output);\n@@ -260,3 +307,0 @@\n-                onlyEvent = null;\n-            } else {\n-                onlyEvent = events.get(0);\n@@ -264,1 +308,3 @@\n-            this.verbose = optVerbose.value(set);\n+            builder.appendMulti(optOutput, output);\n+            this.output = output;\n+            profilerConfig = profilerOptions.toString();\n@@ -297,3 +343,1 @@\n-            File jfrFile = new File(trialOutDir, \"profile.jfr\");\n-            generated.add(jfrFile);\n-            fileConfig = \",file=\" + jfrFile.getAbsolutePath();\n+            fileConfig = \",file=\" + outputFile(trialOutDir, \"%s.jfr\").getAbsolutePath();\n@@ -322,1 +366,1 @@\n-            trialOutDir = new File(this.outDir, fileName);\n+            trialOutDir = new File(outDir, fileName);\n@@ -330,3 +374,3 @@\n-        StringWriter output = new StringWriter();\n-        PrintWriter pw = new PrintWriter(output);\n-        for (OutputType outputType : this.output) {\n+        StringWriter outputWriter = new StringWriter();\n+        PrintWriter printWriter = new PrintWriter(outputWriter);\n+        for (OutputType outputType : output) {\n@@ -338,1 +382,1 @@\n-                            pw.println(line);\n+                            printWriter.println(line);\n@@ -341,1 +385,1 @@\n-                        e.printStackTrace();\n+                        throw new RuntimeException(e);\n@@ -361,0 +405,1 @@\n+                    \/\/ JFR is already dumped into file by async-profiler.\n@@ -365,1 +410,1 @@\n-        pw.println(\"Async profiler results:\");\n+        printWriter.println(\"Async profiler results:\");\n@@ -367,2 +412,2 @@\n-            pw.print(\"  \");\n-            pw.println(file.getPath());\n+            printWriter.print(\"  \");\n+            printWriter.println(file.getPath());\n@@ -370,2 +415,2 @@\n-        pw.flush();\n-        pw.close();\n+        printWriter.flush();\n+        printWriter.close();\n@@ -373,1 +418,1 @@\n-        return new TextResult(output.toString(), \"async\");\n+        return new TextResult(outputWriter.toString(), \"async\");\n@@ -377,4 +422,1 @@\n-        if (onlyEvent == null) {\n-            throw new IllegalStateException(\"Expected only one event, found: \" + events);\n-        }\n-        File output = new File(specificOutDir, String.format(fileNameFormatString, onlyEvent));\n+        File output = outputFile(specificOutDir, fileNameFormatString);\n@@ -382,0 +424,5 @@\n+        return output;\n+    }\n+\n+    private File outputFile(File specificOutDir, String fileNameFormatString) {\n+        File output = new File(specificOutDir, String.format(fileNameFormatString, outputFilePrefix));\n@@ -436,1 +483,5 @@\n-            profilerOptions.append(optionName).append('=').append(optionSet.valueOf(option).toString());\n+            profilerOptions.append(optionName);\n+            T arg = optionSet.valueOf(option);\n+            if (arg != null) {\n+                profilerOptions.append('=').append(arg);\n+            }\n@@ -456,1 +507,1 @@\n-        private <T> void appendMulti(OptionSpec<T> option) {\n+        <T> void appendMulti(OptionSpec<T> option) {\n@@ -459,4 +510,9 @@\n-                String optionName = option.options().iterator().next();\n-                for (T value : optionSet.valuesOf(option)) {\n-                    profilerOptions.append(',').append(optionName).append('=').append(value.toString());\n-                }\n+                List<T> ts = optionSet.valuesOf(option);\n+                appendMulti(option, ts);\n+            }\n+        }\n+\n+        private <T> void appendMulti(OptionSpec<T> option, List<T> ts) {\n+            String optionName = option.options().iterator().next();\n+            for (T value : ts) {\n+                profilerOptions.append(',').append(optionName).append('=').append(value.toString());\n","filename":"jmh-core\/src\/main\/java\/org\/openjdk\/jmh\/profile\/AsyncProfiler.java","additions":107,"deletions":51,"binary":false,"changes":158,"status":"modified"}]}