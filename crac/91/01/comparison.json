{"files":[{"patch":"@@ -33,0 +33,1 @@\n+import java.util.WeakHashMap;\n@@ -37,0 +38,4 @@\n+import jdk.internal.crac.Core;\n+import jdk.crac.Context;\n+import jdk.crac.Resource;\n+\n@@ -43,1 +48,1 @@\n-class JarFileFactory implements URLJarFile.URLJarFileCloseController {\n+class JarFileFactory implements URLJarFile.URLJarFileCloseController, jdk.internal.crac.JDKResource {\n@@ -53,1 +58,3 @@\n-    private JarFileFactory() { }\n+    private JarFileFactory() {\n+        Core.Priority.NORMAL.getContext().register(this);\n+    }\n@@ -262,0 +269,25 @@\n+\n+    @Override\n+    public void beforeCheckpoint(Context<? extends Resource> context) throws Exception {\n+        \/\/ Need to clear cached entries that are held by the factory only (e.g.\n+        \/\/ after JarURLInputStream.close with useCaches == true).  Creating a\n+        \/\/ temporary weak cache and triggering GC to get know JARs really in\n+        \/\/ use.\n+        synchronized (instance) {\n+            WeakHashMap<JarFile, URL> weakMap = new WeakHashMap<>(urlCache);\n+            fileCache.clear();\n+            urlCache.clear();\n+\n+            System.gc();\n+\n+            weakMap.forEach((JarFile jarFile, URL url) -> {\n+                String key = urlKey(url);\n+                urlCache.put(jarFile, url);\n+                fileCache.put(key, jarFile);\n+            });\n+        }\n+    }\n+\n+    @Override\n+    public void afterRestore(Context<? extends Resource> context) throws Exception {\n+    }\n","filename":"src\/java.base\/windows\/classes\/sun\/net\/www\/protocol\/jar\/JarFileFactory.java","additions":34,"deletions":2,"binary":false,"changes":36,"status":"modified"},{"patch":"@@ -33,0 +33,3 @@\n+#include <windows.h>\n+#include <winternl.h>\n+\n@@ -97,3 +100,40 @@\n-Java_java_io_FileDescriptor_nativeDescription0(JNIEnv *env, jobject this) {\n-    return (*env)->NewStringUTF(env, \"(not implemented)\");\n-}\n\\ No newline at end of file\n+Java_java_io_FileDescriptor_nativeDescription0(JNIEnv* env, jobject this) {\n+    HANDLE handle = (HANDLE)(*env)->GetLongField(env, this, IO_handle_fdID);\n+    #define BufferSize 1024\n+    char lpszFilePath[BufferSize] = {'\\0'};\n+\n+    HMODULE hNtdllDll = GetModuleHandle(TEXT(\"ntdll.dll\"));\n+    if (!hNtdllDll) {\n+        JNU_ThrowIOExceptionWithLastError(env, \"LoadLibrary ntdll.dll failed\");\n+        return NULL;\n+    }\n+\n+    typedef NTSTATUS(WINAPI* NtQueryObjectFunc)(HANDLE, OBJECT_INFORMATION_CLASS, PVOID, ULONG, PULONG);\n+    NtQueryObjectFunc ntQueryObject = (NtQueryObjectFunc)GetProcAddress(hNtdllDll, \"NtQueryObject\");\n+\n+    if (!ntQueryObject) {\n+        JNU_ThrowIOExceptionWithLastError(env, \"GetProcAddress failed\");\n+    } else {\n+        char tmp[BufferSize];\n+        PUBLIC_OBJECT_TYPE_INFORMATION *objTypeInfo = (PUBLIC_OBJECT_TYPE_INFORMATION *)tmp;\n+        ULONG retLen;\n+        NTSTATUS status = ntQueryObject(handle, ObjectTypeInformation, objTypeInfo, sizeof(tmp), &retLen);\n+        if (0 != status) {\n+            JNU_ThrowIOExceptionWithLastError(env, \"NtQueryObject failed\");\n+        } else {\n+            PCWSTR typeName = objTypeInfo->TypeName.Buffer;\n+            const BOOL hasFilepath = (0 == wcscmp(L\"File\", typeName) || 0 == wcscmp(L\"Directory\", typeName));\n+            if (!hasFilepath || !GetFinalPathNameByHandleA(handle, lpszFilePath, BufferSize, FILE_NAME_OPENED)) {\n+                int len = snprintf(lpszFilePath, sizeof(lpszFilePath) - 1, \"Handle %p, \", handle);\n+                if (0 > len) {\n+                    len = 0;\n+                }\n+                WideCharToMultiByte(CP_ACP, 0, typeName, -1, lpszFilePath + len, sizeof(lpszFilePath) - len, NULL, NULL);\n+            }\n+        }\n+    }\n+\n+    CloseHandle(hNtdllDll);\n+\n+    return (*env)->NewStringUTF(env, lpszFilePath);\n+}\n","filename":"src\/java.base\/windows\/native\/libjava\/FileDescriptor_md.c","additions":43,"deletions":3,"binary":false,"changes":46,"status":"modified"},{"patch":"@@ -40,1 +40,0 @@\n- * @requires (os.family == \"linux\")\n","filename":"test\/jdk\/jdk\/crac\/JarFileFactoryCacheTest\/JarFileFactoryCacheTest.java","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -26,0 +26,1 @@\n+import jdk.test.lib.crac.CracEngine;\n@@ -29,0 +30,1 @@\n+import java.io.File;\n@@ -37,1 +39,0 @@\n- * @requires (os.family == \"linux\")\n@@ -42,1 +43,1 @@\n-        CracProcess cp = new CracBuilder().captureOutput(true)\n+        CracProcess cp = new CracBuilder().engine(CracEngine.SIMULATE).captureOutput(true)\n@@ -47,2 +48,2 @@\n-                .shouldMatch(\"CheckpointOpenFileException: \/etc\/passwd\") \/\/ RandomAccessFile should have the expected format\n-                .shouldMatch(\"\/etc\/group\") \/\/ others are allowed to specify the path in some format\n+                .shouldMatch(\"CheckpointOpenFileException: filename1.txt\") \/\/ RandomAccessFile should have the expected format\n+                .shouldMatch(\"filename2.txt\") \/\/ others are allowed to specify the path in some format\n@@ -54,2 +55,6 @@\n-        try (var file1 = new RandomAccessFile(\"\/etc\/passwd\", \"r\");\n-             var file2 = new FileInputStream(\"\/etc\/group\")) {\n+        {\n+            new File(\"filename1.txt\").createNewFile();\n+            new File(\"filename2.txt\").createNewFile();\n+        }\n+        try (var file1 = new RandomAccessFile(\"filename1.txt\", \"r\");\n+             var file2 = new FileInputStream(\"filename2.txt\")) {\n","filename":"test\/jdk\/jdk\/crac\/fileDescriptors\/OpenFileDetectionTest.java","additions":11,"deletions":6,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -26,0 +26,1 @@\n+import jdk.test.lib.crac.CracEngine;\n@@ -40,1 +41,0 @@\n- * @requires (os.family == \"linux\")\n@@ -45,1 +45,1 @@\n-        CracProcess cp = new CracBuilder().captureOutput(true)\n+        CracProcess cp = new CracBuilder().engine(CracEngine.SIMULATE).captureOutput(true)\n","filename":"test\/jdk\/jdk\/crac\/fileDescriptors\/OpenSocketDetectionTest.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"}]}