{"files":[{"patch":"@@ -105,4 +105,3 @@\n-    HMODULE hNtdllDll = GetModuleHandle(TEXT(\"ntdll.dll\"));\n-    if (!hNtdllDll) {\n-        JNU_ThrowIOExceptionWithLastError(env, \"GetModuleHandle ntdll.dll failed\");\n-        return NULL;\n+    const DWORD dwFileType = GetFileType(handle);\n+    if (FILE_TYPE_DISK != dwFileType || !GetFinalPathNameByHandleA(handle, lpszFilePath, BufferSize, FILE_NAME_OPENED)) {\n+        snprintf(lpszFilePath, sizeof(lpszFilePath) - 1, \"Handle 0x%p, type %lu\", handle, dwFileType);\n@@ -111,27 +110,0 @@\n-    typedef NTSTATUS(WINAPI* NtQueryObjectFunc)(HANDLE, OBJECT_INFORMATION_CLASS, PVOID, ULONG, PULONG);\n-    NtQueryObjectFunc ntQueryObject = (NtQueryObjectFunc)GetProcAddress(hNtdllDll, \"NtQueryObject\");\n-\n-    if (!ntQueryObject) {\n-        JNU_ThrowIOExceptionWithLastError(env, \"GetProcAddress failed\");\n-    } else {\n-        char tmp[BufferSize];\n-        PUBLIC_OBJECT_TYPE_INFORMATION *objTypeInfo = (PUBLIC_OBJECT_TYPE_INFORMATION *)tmp;\n-        ULONG retLen;\n-        NTSTATUS status = ntQueryObject(handle, ObjectTypeInformation, objTypeInfo, sizeof(tmp), &retLen);\n-        if (0 != status) {\n-            JNU_ThrowIOExceptionWithLastError(env, \"NtQueryObject failed\");\n-        } else {\n-            PCWSTR typeName = objTypeInfo->TypeName.Buffer;\n-            const BOOL hasFilepath = (0 == wcscmp(L\"File\", typeName) || 0 == wcscmp(L\"Directory\", typeName));\n-            if (!hasFilepath || !GetFinalPathNameByHandleA(handle, lpszFilePath, BufferSize, FILE_NAME_OPENED)) {\n-                int len = snprintf(lpszFilePath, sizeof(lpszFilePath) - 1, \"Handle %p, \", handle);\n-                if (0 > len) {\n-                    len = 0;\n-                }\n-                WideCharToMultiByte(CP_ACP, 0, typeName, -1, lpszFilePath + len, sizeof(lpszFilePath) - len, NULL, NULL);\n-            }\n-        }\n-    }\n-\n-    CloseHandle(hNtdllDll);\n-\n","filename":"src\/java.base\/windows\/native\/libjava\/FileDescriptor_md.c","additions":3,"deletions":31,"binary":false,"changes":34,"status":"modified"}]}