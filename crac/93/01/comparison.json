{"files":[{"patch":"@@ -48,0 +48,1 @@\n+#include \"gc\/g1\/g1UncommitRegionTask.hpp\"\n@@ -1148,0 +1149,4 @@\n+  virtual void wait_for_collection_finish() {\n+    G1UncommitRegionTask::wait_if_active();\n+  }\n+\n","filename":"src\/hotspot\/share\/gc\/g1\/g1CollectedHeap.hpp","additions":5,"deletions":0,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -30,0 +30,1 @@\n+#include \"runtime\/thread.inline.hpp\"\n@@ -132,0 +133,1 @@\n+    _active_sem.signal();\n@@ -136,0 +138,20 @@\n+\n+void G1UncommitRegionTask::_wait_if_active() {\n+  \/\/ Not valid: assert_at_safepoint();\n+  assert(Thread::current_or_null() != NULL, \"no current thread\");\n+  \/\/ Not valid: assert(Thread::current()->is_VM_thread(), \"\");\n+  assert(Thread::current()->is_active_Java_thread(), \"unexpected thread type\");\n+  assert(strcmp(Thread::current()->name(), \"main\") == 0, \"unexpected thread\");\n+  assert(Thread::current()->as_Java_thread()->thread_state() == _thread_in_vm, \"unexpected thread state\");\n+\n+  while (_active) {\n+    _active_sem.wait();\n+  }\n+}\n+\n+void G1UncommitRegionTask::wait_if_active() {\n+  \/\/ Otherwise G1 GC is not in use.\n+  if (_instance) {\n+    _instance->_wait_if_active();\n+  }\n+}\n","filename":"src\/hotspot\/share\/gc\/g1\/g1UncommitRegionTask.cpp","additions":22,"deletions":0,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -29,0 +29,1 @@\n+#include \"runtime\/semaphore.hpp\"\n@@ -38,1 +39,1 @@\n-  static const uint UncommitInitialDelayMs = 100;\n+  static const uint UncommitInitialDelayMs = 10*1000; \/\/ FIXME: for reproducibility: 10*1000\n@@ -50,0 +51,1 @@\n+  Semaphore _active_sem;\n@@ -64,0 +66,2 @@\n+  void _wait_if_active();\n+\n@@ -67,0 +71,1 @@\n+  static void wait_if_active();\n","filename":"src\/hotspot\/share\/gc\/g1\/g1UncommitRegionTask.hpp","additions":6,"deletions":1,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -368,0 +368,3 @@\n+  \/\/ G1UncommitRegionTask may be still pending after collect() has returned.\n+  virtual void wait_for_collection_finish() {}\n+\n","filename":"src\/hotspot\/share\/gc\/shared\/collectedHeap.hpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -408,0 +408,1 @@\n+  Universe::heap()->wait_for_collection_finish();\n","filename":"src\/hotspot\/share\/runtime\/crac.cpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"}]}