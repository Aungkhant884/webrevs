{"files":[{"patch":"@@ -247,2 +247,1 @@\n-            checkpointInProgress = true;\n-            CountDownLatch finishCleanup = null;\n+\n@@ -250,17 +249,2 @@\n-            if (Thread.currentThread().isDaemon()) {\n-                \/\/ Create a non-daemon thread while notification is performed.\n-                \/\/ The notifications are done on the original thread.\n-                CountDownLatch start = new CountDownLatch(1);\n-                CountDownLatch finish = new CountDownLatch(1);\n-                finishCleanup = finish;\n-                keepAliveThread = new Thread(() -> {\n-                    start.countDown();\n-                    try {\n-                        finish.await();\n-                    } catch (InterruptedException e) {\n-                        throw new RuntimeException(e);\n-                    }\n-                });\n-                keepAliveThread.setDaemon(false);\n-                keepAliveThread.start();\n-            }\n+            CountDownLatch finishCleanup = null;\n+\n@@ -268,0 +252,21 @@\n+                checkpointInProgress = true;\n+\n+                \/\/ Create a non-daemon thread while notification is performed\n+                \/\/ to avoid VM exit. The notifications are done on the original\n+                \/\/ thread.\n+                if (Thread.currentThread().isDaemon()) {\n+                    CountDownLatch start = new CountDownLatch(1);\n+                    CountDownLatch finish = new CountDownLatch(1);\n+                    finishCleanup = finish;\n+                    keepAliveThread = new Thread(() -> {\n+                        start.countDown();\n+                        try {\n+                            finish.await();\n+                        } catch (InterruptedException e) {\n+                            throw new RuntimeException(e);\n+                        }\n+                    });\n+                    keepAliveThread.setDaemon(false);\n+                    keepAliveThread.start();\n+                }\n+\n@@ -273,0 +278,1 @@\n+\n@@ -278,1 +284,0 @@\n-                        throw new RuntimeException(e);\n@@ -281,0 +286,2 @@\n+\n+                checkpointInProgress = false;\n","filename":"src\/java.base\/share\/classes\/jdk\/crac\/Core.java","additions":27,"deletions":20,"binary":false,"changes":47,"status":"modified"},{"patch":"@@ -94,3 +94,1 @@\n-                if (!Thread.currentThread().isDaemon()) {\n-                    throw new RuntimeException(\"beforeCheckpoint called from non-daemon thread\");\n-                }\n+                assert Thread.currentThread().isDaemon() : \"beforeCheckpoint is expected to be called from daemon thread\";\n","filename":"test\/jdk\/jdk\/crac\/DaemonAfterRestore.java","additions":1,"deletions":3,"binary":false,"changes":4,"status":"modified"}]}