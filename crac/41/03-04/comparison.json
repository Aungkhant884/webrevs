{"files":[{"patch":"@@ -225,1 +225,1 @@\n-  product(uint64_t, CPUFeatures, 0, \"CPU feature set, \"                     \\\n+  product(ccstr, CPUFeatures, NULL, \"CPU feature set, \"                     \\\n@@ -227,1 +227,3 @@\n-      \"get an error during -XX:CRaCRestoreFrom on a different machine\")     \\\n+      \"get an error during -XX:CRaCRestoreFrom on a different machine; \"    \\\n+      \"-XX:CPUFeatures=native is the default; \"                             \\\n+      \"-XX:CPUFeatures=generic is compatible but not as slow as 0\")\n","filename":"src\/hotspot\/cpu\/x86\/globals_x86.hpp","additions":4,"deletions":2,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -618,1 +618,28 @@\n-void VM_Version::get_processor_features(bool use_CPUFeatures) {\n+uint64_t VM_Version::CPUFeatures_parse(const char *ccstr) {\n+  assert(ccstr, \"CPUFeatures_parse NULL\");\n+  if (strcmp(ccstr, \"native\") == 0) {\n+    return Abstract_VM_Version::features();\n+  }\n+  if (strcmp(ccstr, \"generic\") == 0) {\n+    \/\/ FIXME: This is for: Intel(R) Xeon(R) CPU E5-2630 v3 @ 2.40GHz\n+    return 0 | CPU_CX8 | CPU_CMOV | CPU_FXSR | CPU_MMX | CPU_SSE | CPU_SSE2\n+      | CPU_SSE3 | CPU_SSSE3 | CPU_SSE4_1 | CPU_SSE4_2 | CPU_POPCNT | CPU_LZCNT\n+      | CPU_TSC | CPU_AVX | CPU_AVX2 | CPU_AES | CPU_ERMS | CPU_CLMUL\n+      | CPU_BMI1 | CPU_BMI2 | CPU_FMA | CPU_VZEROUPPER | CPU_FLUSH | CPU_HV;\n+  }\n+  char *endptr;\n+  errno = 0;\n+  unsigned long long ull = strtoull(ccstr, &endptr, 0);\n+  if (!errno && (!endptr || !*endptr))\n+    return ull;\n+  char buf[512];\n+  int res = jio_snprintf(\n+\t      buf, sizeof(buf),\n+\t      \"Improperly specified VM option 'CPUFeatures=%s'\", ccstr);\n+  assert(res > 0, \"not enough temporary space allocated\");\n+  vm_exit_during_initialization(buf);\n+  \/\/ NOTREACHED\n+  return 0;\n+}\n+\n+void VM_Version::get_processor_features() {\n@@ -645,2 +672,4 @@\n-  if (use_CPUFeatures && !FLAG_IS_DEFAULT(CPUFeatures)) {\n-    uint64_t features_missing = CPUFeatures & ~_features;\n+  assert(!CPUFeatures == FLAG_IS_DEFAULT(CPUFeatures), \"CPUFeatures parsing\");\n+  if (CPUFeatures) {\n+    uint64_t CPUFeatures_x64 = CPUFeatures_parse(CPUFeatures);\n+    uint64_t features_missing = CPUFeatures_x64 & ~_features;\n@@ -650,5 +679,5 @@\n-                  buf, sizeof(buf),\n-                  \"Specified -XX:CPUFeatures=0x\" UINT64_FORMAT_X\n-                  \"; this machine's CPU features are 0x\" UINT64_FORMAT_X\n-                  \"; missing features of this CPU are 0x\" UINT64_FORMAT_X \" \",\n-                  CPUFeatures, _features, features_missing);\n+\t\t  buf, sizeof(buf),\n+\t\t  \"Specified -XX:CPUFeatures=0x\" UINT64_FORMAT_X\n+\t\t  \"; this machine's CPU features are 0x\" UINT64_FORMAT_X\n+\t\t  \"; missing features of this CPU are 0x\" UINT64_FORMAT_X \" \",\n+\t\t  CPUFeatures_x64, _features, features_missing);\n@@ -661,1 +690,1 @@\n-    _features = CPUFeatures;\n+    _features = CPUFeatures_x64;\n@@ -1907,1 +1936,1 @@\n-void VM_Version::initialize_features(bool use_CPUFeatures) {\n+void VM_Version::initialize_features() {\n@@ -1922,1 +1951,1 @@\n-  get_processor_features(use_CPUFeatures);\n+  get_processor_features();\n","filename":"src\/hotspot\/cpu\/x86\/vm_version_x86.cpp","additions":40,"deletions":11,"binary":false,"changes":51,"status":"modified"},{"patch":"@@ -710,1 +710,3 @@\n-  static void get_processor_features(bool use_CPUFeatures);\n+  static void get_processor_features();\n+\n+  static uint64_t CPUFeatures_parse(const char *ccstr);\n@@ -750,1 +752,1 @@\n-  static void initialize_features(bool use_CPUFeatures = true);\n+  static void initialize_features();\n","filename":"src\/hotspot\/cpu\/x86\/vm_version_x86.hpp","additions":4,"deletions":2,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -6210,1 +6210,1 @@\n-  VM_Version::initialize_features(false);\n+  VM_Version::initialize_features();\n@@ -6212,0 +6212,1 @@\n+  \/\/ Abstract_VM_Version::features() may be less than current CPU's features as they have been already masked by the CPUFeatures argument (if it is present).\n@@ -6219,1 +6220,0 @@\n-                \"; this machine's CPU features are 0x\" UINT64_FORMAT_X\n@@ -6222,2 +6222,1 @@\n-                features_saved, Abstract_VM_Version::features(),\n-                features_missing);\n+                features_saved, features_missing);\n@@ -6246,3 +6245,0 @@\n-\n-  CPUFeatures = features_saved;\n-  VM_Version::initialize_features(true);\n","filename":"src\/hotspot\/os\/linux\/os_linux.cpp","additions":3,"deletions":7,"binary":false,"changes":10,"status":"modified"}]}