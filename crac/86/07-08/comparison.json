{"files":[{"patch":"@@ -107,0 +107,1 @@\n+static const int crac_min_pid_default = 128;\n@@ -195,1 +196,1 @@\n-    const int last_pid_file = open(last_pid_filename, O_WRONLY|O_CREAT|O_TRUNC, 0666);\n+    const int last_pid_file = open(last_pid_filename, O_WRONLY|O_TRUNC, 0666);\n@@ -200,1 +201,1 @@\n-    if (0 > write(last_pid_file, buf, len)) {\n+    if (len > write(last_pid_file, buf, len)) {\n@@ -202,1 +203,1 @@\n-}\n+    }\n@@ -348,16 +349,15 @@\n-    const int is_min_pid_valid = !is_min_pid_set || 0 < crac_min_pid;\n-    if (is_checkpoint && is_min_pid_valid) {\n-        const int crac_min_pid_default = 128;\n-        const int min_pid = is_min_pid_set ? crac_min_pid : crac_min_pid_default;\n-\n-        if (1 == getpid() || (is_min_pid_set && getpid() < min_pid)) {\n-            \/\/ Move PID value for new processes to a desired value\n-            \/\/ to avoid PID conflicts on restore.\n-            {\n-                const int res = set_last_pid(min_pid);\n-                if (EPERM == res || EACCES == res || EROFS == res) {\n-                    spin_last_pid(min_pid);\n-                } else if (0 != res) {\n-                    fprintf(stderr, \"set_last_pid: %s\\n\", strerror(res));\n-                    exit(1);\n-                }\n+    const int is_init = 1 == getpid();\n+    if (is_init && !is_min_pid_set) {\n+        crac_min_pid = crac_min_pid_default;\n+    }\n+    const int needs_pid_adjust = getpid() < crac_min_pid;\n+    if (is_checkpoint && (is_init || needs_pid_adjust)) {\n+        \/\/ Move PID value for new processes to a desired value\n+        \/\/ to avoid PID conflicts on restore.\n+        if (needs_pid_adjust) {\n+            const int res = set_last_pid(crac_min_pid);\n+            if (EPERM == res || EACCES == res || EROFS == res) {\n+                spin_last_pid(crac_min_pid);\n+            } else if (0 != res) {\n+                fprintf(stderr, \"set_last_pid: %s\\n\", strerror(res));\n+                exit(1);\n@@ -365,0 +365,1 @@\n+        }\n@@ -366,19 +367,12 @@\n-            \/\/ Avoid unexpected process completion when checkpointing under docker container run\n-            \/\/ by creating the main process waiting for children before exit.\n-            g_child_pid = fork();\n-            if (0 == g_child_pid && getpid() < min_pid) {\n-                if (is_min_pid_set) {\n-                    fprintf(stderr, \"Error: Can't adjust PID to min PID %d, current PID %d\\n\", min_pid, (int)getpid());\n-                    exit(1);\n-                } else {\n-                    fprintf(stderr,\n-                            \"Warning: Can't adjust PID to min PID %d, current PID %d.\\n\"\n-                            \"This message can be suppressed by '-XX:CRaCMinPid=1' option\\n\",\n-                            min_pid, (int)getpid());\n-                }\n-            }\n-            if (0 < g_child_pid) {\n-                \/\/ The main process should forward signals to the child.\n-                setup_sighandler();\n-                const int status = wait_for_children();\n-                exit(status);\n+        \/\/ Avoid unexpected process completion when checkpointing under docker container run\n+        \/\/ by creating the main process waiting for children before exit.\n+        g_child_pid = fork();\n+        if (0 == g_child_pid && needs_pid_adjust && getpid() < crac_min_pid) {\n+            if (is_min_pid_set) {\n+                fprintf(stderr, \"Error: Can't adjust PID to min PID %d, current PID %d\\n\", crac_min_pid, (int)getpid());\n+                exit(1);\n+            } else {\n+                fprintf(stderr,\n+                        \"Warning: Can't adjust PID to min PID %d, current PID %d.\\n\"\n+                        \"This message can be suppressed by '-XX:CRaCMinPid=1' option\\n\",\n+                        crac_min_pid, (int)getpid());\n@@ -387,0 +381,6 @@\n+        if (0 < g_child_pid) {\n+            \/\/ The main process should forward signals to the child.\n+            setup_sighandler();\n+            const int status = wait_for_children();\n+            exit(status);\n+        }\n","filename":"src\/java.base\/share\/native\/launcher\/main.c","additions":38,"deletions":38,"binary":false,"changes":76,"status":"modified"}]}