{"files":[{"patch":"@@ -1415,2 +1415,2 @@\n-    _features = feature_flags();\n-    LINUX_ONLY(_glibc_features = glibc_flags();)\n+    _features = _cpuid_info.feature_flags();\n+    LINUX_ONLY(_glibc_features = _cpuid_info.glibc_flags();)\n@@ -2724,23 +2724,3 @@\n-#define SAVE_SET \\\n-    SAVE(_cpu) \\\n-    SAVE(_model) \\\n-    SAVE(_stepping) \\\n-    SAVE(_features) \\\n-    SAVE(_glibc_features) \\\n-    SAVE(_logical_processors_per_package) \\\n-    SAVE(_L1_data_cache_line_size) \\\n-    \/**\/\n-#define SAVE(n) auto save##n = VM_Version::n;\n-  SAVE_SET\n-#undef SAVE\n-\n-#define SUPPORTS_SET \\\n-    SUPPORTS(supports_cx8) \\\n-    SUPPORTS(supports_atomic_getset4) \\\n-    SUPPORTS(supports_atomic_getset8) \\\n-    SUPPORTS(supports_atomic_getadd4) \\\n-    SUPPORTS(supports_atomic_getadd8) \\\n-    \/**\/\n-#define SUPPORTS(x) bool x##_saved = Abstract_VM_Version::x();\n-  SUPPORTS_SET\n-#undef SUPPORTS\n+  VM_Version::CpuidInfo cpuid_info = { 0, };\n+  get_cpu_info_stub(&cpuid_info);\n+  cpuid_info.assert_is_initialized();\n@@ -2748,1 +2728,6 @@\n-  get_processor_features_hardware();\n+  uint64_t       new_cpu_features = 0;\n+  uint64_t new_cpu_glibc_features = 0;\n+  if (cpuid_info.extended_cpu_family() > 4) { \/\/ it supports CPUID\n+    new_cpu_features = cpuid_info.feature_flags();\n+    LINUX_ONLY(new_cpu_glibc_features = cpuid_info.glibc_flags();)\n+  }\n@@ -2750,2 +2735,2 @@\n-  uint64_t       features_missing =       save_features & ~      _features;\n-  uint64_t glibc_features_missing = save_glibc_features & ~_glibc_features;\n+  uint64_t       features_missing =       _features & ~      new_cpu_features;\n+  uint64_t glibc_features_missing = _glibc_features & ~new_cpu_glibc_features;\n@@ -2759,1 +2744,1 @@\n-    nonlibc_tty_print_uint64_comma_uint64(_features & save_features, _glibc_features & save_glibc_features);\n+    nonlibc_tty_print_uint64_comma_uint64(new_cpu_features & _features, new_cpu_glibc_features & _glibc_features);\n@@ -2762,1 +2747,1 @@\n-    nonlibc_tty_print_uint64_comma_uint64(save_features, save_glibc_features);\n+    nonlibc_tty_print_uint64_comma_uint64(_features, _glibc_features);\n@@ -2766,21 +2751,0 @@\n-  auto supports_exit = [&](const char *supports, bool file, bool this_cpu) {\n-    char buf[512];\n-    int res = jio_snprintf(\n-                buf, sizeof(buf),\n-                \"Specified -XX:CRaCRestoreFrom file contains feature \\\"%s\\\" value %d while this CPU has value %d\",\n-                supports, file, this_cpu);\n-    assert(res > 0, \"not enough temporary space allocated\");\n-    vm_exit_during_initialization(buf);\n-  };\n-#define SUPPORTS(x)                                           \\\n-  if (x##_saved != Abstract_VM_Version::x()) {                \\\n-    supports_exit( #x , Abstract_VM_Version::x(), x##_saved); \\\n-  }\n-  SUPPORTS_SET\n-#undef SUPPORTS\n-#undef SUPPORTS_SET\n-\n-#define SAVE(n) VM_Version::n = save##n;\n-  SAVE_SET\n-#undef SAVE\n-\n@@ -3639,1 +3603,1 @@\n-uint64_t VM_Version::feature_flags() {\n+uint64_t VM_Version::CpuidInfo::feature_flags() const {\n@@ -3641,1 +3605,1 @@\n-  if (_cpuid_info.std_cpuid1_edx.bits.cmpxchg8 != 0)\n+  if (std_cpuid1_edx.bits.cmpxchg8 != 0)\n@@ -3643,1 +3607,1 @@\n-  if (_cpuid_info.std_cpuid1_edx.bits.cmov != 0)\n+  if (std_cpuid1_edx.bits.cmov != 0)\n@@ -3645,1 +3609,1 @@\n-  if (_cpuid_info.std_cpuid1_edx.bits.clflush != 0)\n+  if (std_cpuid1_edx.bits.clflush != 0)\n@@ -3653,2 +3617,2 @@\n-  if (_cpuid_info.std_cpuid1_edx.bits.fxsr != 0 || (is_amd_family() &&\n-      _cpuid_info.ext_cpuid1_edx.bits.fxsr != 0))\n+  if (std_cpuid1_edx.bits.fxsr != 0 || (is_amd_family() &&\n+      ext_cpuid1_edx.bits.fxsr != 0))\n@@ -3659,2 +3623,2 @@\n-  if (_cpuid_info.std_cpuid1_edx.bits.mmx != 0 || (is_amd_family() &&\n-      _cpuid_info.ext_cpuid1_edx.bits.mmx != 0))\n+  if (std_cpuid1_edx.bits.mmx != 0 || (is_amd_family() &&\n+      ext_cpuid1_edx.bits.mmx != 0))\n@@ -3662,1 +3626,1 @@\n-  if (_cpuid_info.std_cpuid1_edx.bits.sse != 0)\n+  if (std_cpuid1_edx.bits.sse != 0)\n@@ -3664,1 +3628,1 @@\n-  if (_cpuid_info.std_cpuid1_edx.bits.sse2 != 0)\n+  if (std_cpuid1_edx.bits.sse2 != 0)\n@@ -3666,1 +3630,1 @@\n-  if (_cpuid_info.std_cpuid1_ecx.bits.sse3 != 0)\n+  if (std_cpuid1_ecx.bits.sse3 != 0)\n@@ -3668,1 +3632,1 @@\n-  if (_cpuid_info.std_cpuid1_ecx.bits.ssse3 != 0)\n+  if (std_cpuid1_ecx.bits.ssse3 != 0)\n@@ -3670,1 +3634,1 @@\n-  if (_cpuid_info.std_cpuid1_ecx.bits.sse4_1 != 0)\n+  if (std_cpuid1_ecx.bits.sse4_1 != 0)\n@@ -3672,1 +3636,1 @@\n-  if (_cpuid_info.std_cpuid1_ecx.bits.sse4_2 != 0)\n+  if (std_cpuid1_ecx.bits.sse4_2 != 0)\n@@ -3674,1 +3638,1 @@\n-  if (_cpuid_info.std_cpuid1_ecx.bits.popcnt != 0)\n+  if (std_cpuid1_ecx.bits.popcnt != 0)\n@@ -3676,4 +3640,4 @@\n-  if (_cpuid_info.std_cpuid1_ecx.bits.avx != 0 &&\n-      _cpuid_info.std_cpuid1_ecx.bits.osxsave != 0 &&\n-      _cpuid_info.xem_xcr0_eax.bits.sse != 0 &&\n-      _cpuid_info.xem_xcr0_eax.bits.ymm != 0) {\n+  if (std_cpuid1_ecx.bits.avx != 0 &&\n+      std_cpuid1_ecx.bits.osxsave != 0 &&\n+      xem_xcr0_eax.bits.sse != 0 &&\n+      xem_xcr0_eax.bits.ymm != 0) {\n@@ -3682,1 +3646,1 @@\n-    if (_cpuid_info.std_cpuid1_ecx.bits.f16c != 0)\n+    if (std_cpuid1_ecx.bits.f16c != 0)\n@@ -3684,1 +3648,1 @@\n-    if (_cpuid_info.sef_cpuid7_ebx.bits.avx2 != 0)\n+    if (sef_cpuid7_ebx.bits.avx2 != 0)\n@@ -3686,4 +3650,4 @@\n-    if (_cpuid_info.sef_cpuid7_ebx.bits.avx512f != 0 &&\n-        _cpuid_info.xem_xcr0_eax.bits.opmask != 0 &&\n-        _cpuid_info.xem_xcr0_eax.bits.zmm512 != 0 &&\n-        _cpuid_info.xem_xcr0_eax.bits.zmm32 != 0) {\n+    if (sef_cpuid7_ebx.bits.avx512f != 0 &&\n+        xem_xcr0_eax.bits.opmask != 0 &&\n+        xem_xcr0_eax.bits.zmm512 != 0 &&\n+        xem_xcr0_eax.bits.zmm32 != 0) {\n@@ -3691,1 +3655,1 @@\n-      if (_cpuid_info.sef_cpuid7_ebx.bits.avx512cd != 0)\n+      if (sef_cpuid7_ebx.bits.avx512cd != 0)\n@@ -3693,1 +3657,1 @@\n-      if (_cpuid_info.sef_cpuid7_ebx.bits.avx512dq != 0)\n+      if (sef_cpuid7_ebx.bits.avx512dq != 0)\n@@ -3695,1 +3659,1 @@\n-      if (_cpuid_info.sef_cpuid7_ebx.bits.avx512ifma != 0)\n+      if (sef_cpuid7_ebx.bits.avx512ifma != 0)\n@@ -3697,1 +3661,1 @@\n-      if (_cpuid_info.sef_cpuid7_ebx.bits.avx512pf != 0)\n+      if (sef_cpuid7_ebx.bits.avx512pf != 0)\n@@ -3699,1 +3663,1 @@\n-      if (_cpuid_info.sef_cpuid7_ebx.bits.avx512er != 0)\n+      if (sef_cpuid7_ebx.bits.avx512er != 0)\n@@ -3701,1 +3665,1 @@\n-      if (_cpuid_info.sef_cpuid7_ebx.bits.avx512bw != 0)\n+      if (sef_cpuid7_ebx.bits.avx512bw != 0)\n@@ -3703,1 +3667,1 @@\n-      if (_cpuid_info.sef_cpuid7_ebx.bits.avx512vl != 0)\n+      if (sef_cpuid7_ebx.bits.avx512vl != 0)\n@@ -3705,1 +3669,1 @@\n-      if (_cpuid_info.sef_cpuid7_ecx.bits.avx512_vpopcntdq != 0)\n+      if (sef_cpuid7_ecx.bits.avx512_vpopcntdq != 0)\n@@ -3707,1 +3671,1 @@\n-      if (_cpuid_info.sef_cpuid7_ecx.bits.avx512_vpclmulqdq != 0)\n+      if (sef_cpuid7_ecx.bits.avx512_vpclmulqdq != 0)\n@@ -3709,1 +3673,1 @@\n-      if (_cpuid_info.sef_cpuid7_ecx.bits.vaes != 0)\n+      if (sef_cpuid7_ecx.bits.vaes != 0)\n@@ -3711,1 +3675,1 @@\n-      if (_cpuid_info.sef_cpuid7_ecx.bits.gfni != 0)\n+      if (sef_cpuid7_ecx.bits.gfni != 0)\n@@ -3713,1 +3677,1 @@\n-      if (_cpuid_info.sef_cpuid7_ecx.bits.avx512_vnni != 0)\n+      if (sef_cpuid7_ecx.bits.avx512_vnni != 0)\n@@ -3715,1 +3679,1 @@\n-      if (_cpuid_info.sef_cpuid7_ecx.bits.avx512_bitalg != 0)\n+      if (sef_cpuid7_ecx.bits.avx512_bitalg != 0)\n@@ -3717,1 +3681,1 @@\n-      if (_cpuid_info.sef_cpuid7_ecx.bits.avx512_vbmi != 0)\n+      if (sef_cpuid7_ecx.bits.avx512_vbmi != 0)\n@@ -3719,1 +3683,1 @@\n-      if (_cpuid_info.sef_cpuid7_ecx.bits.avx512_vbmi2 != 0)\n+      if (sef_cpuid7_ecx.bits.avx512_vbmi2 != 0)\n@@ -3723,1 +3687,1 @@\n-  if (_cpuid_info.std_cpuid1_ecx.bits.hv != 0)\n+  if (std_cpuid1_ecx.bits.hv != 0)\n@@ -3725,1 +3689,1 @@\n-  if (_cpuid_info.sef_cpuid7_ebx.bits.bmi1 != 0)\n+  if (sef_cpuid7_ebx.bits.bmi1 != 0)\n@@ -3727,1 +3691,1 @@\n-  if (_cpuid_info.std_cpuid1_edx.bits.tsc != 0)\n+  if (std_cpuid1_edx.bits.tsc != 0)\n@@ -3729,1 +3693,1 @@\n-  if (_cpuid_info.ext_cpuid7_edx.bits.tsc_invariance != 0)\n+  if (ext_cpuid7_edx.bits.tsc_invariance != 0)\n@@ -3731,1 +3695,1 @@\n-  if (_cpuid_info.std_cpuid1_ecx.bits.aes != 0)\n+  if (std_cpuid1_ecx.bits.aes != 0)\n@@ -3733,1 +3697,1 @@\n-  if (_cpuid_info.sef_cpuid7_ebx.bits.erms != 0)\n+  if (sef_cpuid7_ebx.bits.erms != 0)\n@@ -3735,1 +3699,1 @@\n-  if (_cpuid_info.sef_cpuid7_edx.bits.fast_short_rep_mov != 0)\n+  if (sef_cpuid7_edx.bits.fast_short_rep_mov != 0)\n@@ -3737,1 +3701,1 @@\n-  if (_cpuid_info.std_cpuid1_ecx.bits.clmul != 0)\n+  if (std_cpuid1_ecx.bits.clmul != 0)\n@@ -3739,1 +3703,1 @@\n-  if (_cpuid_info.sef_cpuid7_ebx.bits.rtm != 0)\n+  if (sef_cpuid7_ebx.bits.rtm != 0)\n@@ -3741,1 +3705,1 @@\n-  if (_cpuid_info.sef_cpuid7_ebx.bits.adx != 0)\n+  if (sef_cpuid7_ebx.bits.adx != 0)\n@@ -3743,1 +3707,1 @@\n-  if (_cpuid_info.sef_cpuid7_ebx.bits.bmi2 != 0)\n+  if (sef_cpuid7_ebx.bits.bmi2 != 0)\n@@ -3745,1 +3709,1 @@\n-  if (_cpuid_info.sef_cpuid7_ebx.bits.sha != 0)\n+  if (sef_cpuid7_ebx.bits.sha != 0)\n@@ -3747,1 +3711,1 @@\n-  if (_cpuid_info.std_cpuid1_ecx.bits.fma != 0)\n+  if (std_cpuid1_ecx.bits.fma != 0)\n@@ -3749,1 +3713,1 @@\n-  if (_cpuid_info.sef_cpuid7_ebx.bits.clflushopt != 0)\n+  if (sef_cpuid7_ebx.bits.clflushopt != 0)\n@@ -3751,1 +3715,1 @@\n-  if (_cpuid_info.ext_cpuid1_edx.bits.rdtscp != 0)\n+  if (ext_cpuid1_edx.bits.rdtscp != 0)\n@@ -3753,1 +3717,1 @@\n-  if (_cpuid_info.sef_cpuid7_ecx.bits.rdpid != 0)\n+  if (sef_cpuid7_ecx.bits.rdpid != 0)\n@@ -3758,2 +3722,2 @@\n-    if ((_cpuid_info.ext_cpuid1_edx.bits.tdnow != 0) ||\n-        (_cpuid_info.ext_cpuid1_ecx.bits.prefetchw != 0))\n+    if ((ext_cpuid1_edx.bits.tdnow != 0) ||\n+        (ext_cpuid1_ecx.bits.prefetchw != 0))\n@@ -3761,1 +3725,1 @@\n-    if (_cpuid_info.ext_cpuid1_ecx.bits.lzcnt != 0)\n+    if (ext_cpuid1_ecx.bits.lzcnt != 0)\n@@ -3763,1 +3727,1 @@\n-    if (_cpuid_info.ext_cpuid1_ecx.bits.sse4a != 0)\n+    if (ext_cpuid1_ecx.bits.sse4a != 0)\n@@ -3769,1 +3733,1 @@\n-    if (_cpuid_info.ext_cpuid1_ecx.bits.lzcnt != 0) {\n+    if (ext_cpuid1_ecx.bits.lzcnt != 0) {\n@@ -3772,1 +3736,1 @@\n-    if (_cpuid_info.ext_cpuid1_ecx.bits.prefetchw != 0) {\n+    if (ext_cpuid1_ecx.bits.prefetchw != 0) {\n@@ -3775,1 +3739,1 @@\n-    if (_cpuid_info.sef_cpuid7_ebx.bits.clwb != 0) {\n+    if (sef_cpuid7_ebx.bits.clwb != 0) {\n@@ -3778,1 +3742,1 @@\n-    if (_cpuid_info.sef_cpuid7_edx.bits.serialize != 0)\n+    if (sef_cpuid7_edx.bits.serialize != 0)\n@@ -3784,1 +3748,1 @@\n-    if (_cpuid_info.ext_cpuid1_ecx.bits.lzcnt != 0) {\n+    if (ext_cpuid1_ecx.bits.lzcnt != 0) {\n@@ -3787,1 +3751,1 @@\n-    if (_cpuid_info.ext_cpuid1_ecx.bits.prefetchw != 0) {\n+    if (ext_cpuid1_ecx.bits.prefetchw != 0) {\n@@ -3793,1 +3757,1 @@\n-  if (_cpuid_info.sef_cpuid7_ecx.bits.pku != 0) {\n+  if (sef_cpuid7_ecx.bits.pku != 0) {\n@@ -3796,1 +3760,1 @@\n-  if (_cpuid_info.sef_cpuid7_ecx.bits.ospke != 0) {\n+  if (sef_cpuid7_ecx.bits.ospke != 0) {\n@@ -3801,1 +3765,1 @@\n-  if (_cpuid_info.sef_cpuid7_ecx.bits.cet_ss != 0) {\n+  if (sef_cpuid7_ecx.bits.cet_ss != 0) {\n@@ -3804,1 +3768,1 @@\n-  if (_cpuid_info.sef_cpuid7_edx.bits.cet_ibt != 0) {\n+  if (sef_cpuid7_edx.bits.cet_ibt != 0) {\n","filename":"src\/hotspot\/cpu\/x86\/vm_version_x86.cpp","additions":85,"deletions":121,"binary":false,"changes":206,"status":"modified"},{"patch":"@@ -554,0 +554,51 @@\n+\n+    uint64_t feature_flags() const;\n+\n+#ifdef LINUX\n+    uint64_t glibc_flags() const {\n+      uint64_t result = 0;\n+      if (std_cpuid1_ecx.bits.movbe != 0)\n+        result |= GLIBC_MOVBE;\n+      if (std_cpuid1_ecx.bits.osxsave != 0)\n+        result |= GLIBC_OSXSAVE;\n+      if (std_cpuid1_ecx.bits.xsave != 0)\n+        result |= GLIBC_XSAVE;\n+      if (std_cpuid1_ecx.bits.cmpxchg16 != 0)\n+        result |= GLIBC_CMPXCHG16;\n+      if (std_cpuid1_ecx.bits.f16c != 0)\n+        result |= GLIBC_F16C;\n+      if (sef_cpuid7_ecx.bits.cet_ss != 0)\n+        result |= GLIBC_SHSTK;\n+      if (sef_cpuid7_edx.bits.cet_ibt != 0)\n+        result |= GLIBC_IBT;\n+      if (ext_cpuid1_ecx.bits.fma4 != 0)\n+        result |= GLIBC_FMA4;\n+      if (ext_cpuid1_ecx.bits.LahfSahf != 0)\n+        result |= GLIBC_LAHFSAHF;\n+      if (std_cpuid1_edx.bits.ht != 0)\n+        result |= GLIBC_HTT;\n+      return result;\n+    }\n+#endif \/\/LINUX\n+\n+    void assert_is_initialized() const {\n+      assert(std_cpuid1_eax.bits.family != 0, \"VM_Version not initialized\");\n+    }\n+\n+    \/\/ Extractors\n+    uint32_t extended_cpu_family() const {\n+      uint32_t result = std_cpuid1_eax.bits.family;\n+      result += std_cpuid1_eax.bits.ext_family;\n+      return result;\n+    }\n+\n+    uint32_t extended_cpu_model() const {\n+      uint32_t result = std_cpuid1_eax.bits.model;\n+      result |= std_cpuid1_eax.bits.ext_model << 4;\n+      return result;\n+    }\n+\n+    uint32_t cpu_stepping() const {\n+      uint32_t result = std_cpuid1_eax.bits.stepping;\n+      return result;\n+    }\n@@ -560,18 +611,1 @@\n-  \/\/ Extractors and predicates\n-  static uint32_t extended_cpu_family() {\n-    uint32_t result = _cpuid_info.std_cpuid1_eax.bits.family;\n-    result += _cpuid_info.std_cpuid1_eax.bits.ext_family;\n-    return result;\n-  }\n-\n-  static uint32_t extended_cpu_model() {\n-    uint32_t result = _cpuid_info.std_cpuid1_eax.bits.model;\n-    result |= _cpuid_info.std_cpuid1_eax.bits.ext_model << 4;\n-    return result;\n-  }\n-\n-  static uint32_t cpu_stepping() {\n-    uint32_t result = _cpuid_info.std_cpuid1_eax.bits.stepping;\n-    return result;\n-  }\n-\n+  \/\/ Extractor\n@@ -585,27 +619,0 @@\n-#ifdef LINUX\n-  static uint64_t glibc_flags() {\n-    uint64_t result = 0;\n-    if (_cpuid_info.std_cpuid1_ecx.bits.movbe != 0)\n-      result |= GLIBC_MOVBE;\n-    if (_cpuid_info.std_cpuid1_ecx.bits.osxsave != 0)\n-      result |= GLIBC_OSXSAVE;\n-    if (_cpuid_info.std_cpuid1_ecx.bits.xsave != 0)\n-      result |= GLIBC_XSAVE;\n-    if (_cpuid_info.std_cpuid1_ecx.bits.cmpxchg16 != 0)\n-      result |= GLIBC_CMPXCHG16;\n-    if (_cpuid_info.std_cpuid1_ecx.bits.f16c != 0)\n-      result |= GLIBC_F16C;\n-    if (_cpuid_info.sef_cpuid7_ecx.bits.cet_ss != 0)\n-      result |= GLIBC_SHSTK;\n-    if (_cpuid_info.sef_cpuid7_edx.bits.cet_ibt != 0)\n-      result |= GLIBC_IBT;\n-    if (_cpuid_info.ext_cpuid1_ecx.bits.fma4 != 0)\n-      result |= GLIBC_FMA4;\n-    if (_cpuid_info.ext_cpuid1_ecx.bits.LahfSahf != 0)\n-      result |= GLIBC_LAHFSAHF;\n-    if (_cpuid_info.std_cpuid1_edx.bits.ht != 0)\n-      result |= GLIBC_HTT;\n-    return result;\n-  }\n-#endif \/\/LINUX\n-\n@@ -631,1 +638,0 @@\n-  static uint64_t feature_flags();\n@@ -682,1 +688,13 @@\n-    assert(_cpuid_info.std_cpuid1_eax.bits.family != 0, \"VM_Version not initialized\");\n+    _cpuid_info.assert_is_initialized();\n+  }\n+\n+  static uint32_t extended_cpu_family() {\n+    return _cpuid_info.extended_cpu_family();\n+  }\n+\n+  static uint32_t extended_cpu_model() {\n+    return _cpuid_info.extended_cpu_model();\n+  }\n+\n+  static uint32_t cpu_stepping() {\n+    return _cpuid_info.cpu_stepping();\n","filename":"src\/hotspot\/cpu\/x86\/vm_version_x86.hpp","additions":65,"deletions":47,"binary":false,"changes":112,"status":"modified"}]}