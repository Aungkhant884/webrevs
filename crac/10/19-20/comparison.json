{"files":[{"patch":"@@ -118,10 +118,0 @@\n-    \/\/ checkpointRestore protects against the simultaneous\n-    \/\/ call of checkpointRestore from different threads.\n-        synchronized (checkpointRestoreLock) {\n-            \/\/ checkpointInProgress protects against recursive\n-            \/\/ checkpointRestore from resource's\n-            \/\/ beforeCheckpoint\/afterRestore methods\n-        if (checkpointInProgress) {\n-            throw new CheckpointException(\"Recursive checkpoint is not allowed\");\n-        }\n-        checkpointInProgress = true;\n@@ -219,5 +209,0 @@\n-        checkpointInProgress = false;\n-        if (FlagsHolder.TRACE_STARTUP_TIME) {\n-            System.out.println(\"STARTUPTIME \" + System.nanoTime() + \" restore-finish\");\n-        }\n-\n@@ -231,1 +216,0 @@\n-    }\n@@ -248,1 +232,26 @@\n-        checkpointRestore1(JCMD_STREAM_NULL, JCMD_OPERATION_NULL);\n+        checkpointRestoreLocked(JCMD_STREAM_NULL, JCMD_OPERATION_NULL);\n+    }\n+\n+    private static void checkpointRestoreLocked(long outputStream_p, long jcmd_p) throws\n+            CheckpointException,\n+            RestoreException {\n+        \/\/ checkpointRestoreLock protects against the simultaneous\n+        \/\/ call of checkpointRestore from different threads.\n+        synchronized (checkpointRestoreLock) {\n+            \/\/ checkpointInProgress protects against recursive\n+            \/\/ checkpointRestore from resource's\n+            \/\/ beforeCheckpoint\/afterRestore methods\n+            if (!checkpointInProgress) {\n+                checkpointInProgress = true;\n+                try {\n+                    checkpointRestore1(outputStream_p, jcmd_p);\n+                } finally {\n+                    if (FlagsHolder.TRACE_STARTUP_TIME) {\n+                        System.out.println(\"STARTUPTIME \" + System.nanoTime() + \" restore-finish\");\n+                    }\n+                    checkpointInProgress = false;\n+                }\n+            } else {\n+                throw new CheckpointException(\"Recursive checkpoint is not allowed\");\n+            }\n+        }\n@@ -256,1 +265,1 @@\n-            checkpointRestore1(outputStream_p, jcmd_p);\n+            checkpointRestoreLocked(outputStream_p, jcmd_p);\n","filename":"src\/java.base\/share\/classes\/jdk\/crac\/Core.java","additions":27,"deletions":18,"binary":false,"changes":45,"status":"modified"}]}