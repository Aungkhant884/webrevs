{"files":[{"patch":"@@ -1840,0 +1840,3 @@\n+#ifdef __APPLE__\n+    int res;\n+#endif\n@@ -1996,2 +1999,2 @@\n-        if (setsockopt(fd, IPPROTO_IP, (join ? IP_ADD_MEMBERSHIP:IP_DROP_MEMBERSHIP),\n-                       (char *) &mname, mname_len) < 0) {\n+        res = setsockopt(fd, IPPROTO_IP, (join ? IP_ADD_MEMBERSHIP:IP_DROP_MEMBERSHIP),\n+                       (char *) &mname, mname_len);\n@@ -2000,17 +2003,4 @@\n-            if (errno == ENOMEM) {\n-                if (setsockopt(fd, IPPROTO_IP, (join ? IP_ADD_MEMBERSHIP:IP_DROP_MEMBERSHIP),\n-                           (char *) &mname, mname_len) < 0 ) {\n-                        if (errno) {\n-                            if (join) {\n-                                NET_ThrowCurrent(env, \"setsockopt IP_ADD_MEMBERSHIP failed\");\n-                            } else {\n-                                if (errno == ENOENT)\n-                                    JNU_ThrowByName(env, JNU_JAVANETPKG \"SocketException\",\n-                                        \"Not a member of the multicast group\");\n-                                else\n-                                    NET_ThrowCurrent(env, \"setsockopt IP_DROP_MEMBERSHIP failed\");\n-                            }\n-                            return;\n-                        }\n-                }\n-            } else {\n+        if (res < 0 && errno == ENOMEM) {\n+            res = setsockopt(fd, IPPROTO_IP, (join ? IP_ADD_MEMBERSHIP:IP_DROP_MEMBERSHIP),\n+                       (char *) &mname, mname_len);\n+        }\n@@ -2018,0 +2008,2 @@\n+\n+        if (res < 0) {\n@@ -2050,3 +2042,0 @@\n-#ifdef __APPLE__\n-          }\n-#endif\n@@ -2121,2 +2110,2 @@\n-        if (setsockopt(fd, IPPROTO_IPV6, (join ? ADD_MEMBERSHIP : DRP_MEMBERSHIP),\n-                       (char *) &mname6, sizeof (mname6)) < 0) {\n+        res = setsockopt(fd, IPPROTO_IPV6, (join ? ADD_MEMBERSHIP : DRP_MEMBERSHIP),\n+                       (char *) &mname6, sizeof (mname6));\n@@ -2125,15 +2114,4 @@\n-            if (errno == ENOMEM) {\n-                if (setsockopt(fd, IPPROTO_IPV6, (join ? ADD_MEMBERSHIP : DRP_MEMBERSHIP),\n-                           (char *) &mname6, sizeof(mname6)) < 0) {\n-                    if (join) {\n-                        NET_ThrowCurrent(env, \"setsockopt \" S_ADD_MEMBERSHIP \" failed\");\n-                    } else {\n-                        if (errno == ENOENT) {\n-                           JNU_ThrowByName(env, JNU_JAVANETPKG \"SocketException\",\n-                                \"Not a member of the multicast group\");\n-                        } else {\n-                            NET_ThrowCurrent(env, \"setsockopt \" S_DRP_MEMBERSHIP \" failed\");\n-                        }\n-                    }\n-                }\n-            } else {\n+        if (res < 0 && errno == ENOMEM) {\n+            res = setsockopt(fd, IPPROTO_IPV6, (join ? ADD_MEMBERSHIP : DRP_MEMBERSHIP),\n+                       (char *) &mname6, sizeof(mname6));\n+        }\n@@ -2141,2 +2119,2 @@\n-\n-                if (join) {\n+        if (res < 0) {\n+            if (join) {\n@@ -2144,0 +2122,4 @@\n+            } else {\n+                if (errno == ENOENT) {\n+                   JNU_ThrowByName(env, JNU_JAVANETPKG \"SocketException\",\n+                        \"Not a member of the multicast group\");\n@@ -2145,6 +2127,1 @@\n-                    if (errno == ENOENT) {\n-                       JNU_ThrowByName(env, JNU_JAVANETPKG \"SocketException\",\n-                            \"Not a member of the multicast group\");\n-                    } else {\n-                        NET_ThrowCurrent(env, \"setsockopt \" S_DRP_MEMBERSHIP \" failed\");\n-                    }\n+                    NET_ThrowCurrent(env, \"setsockopt \" S_DRP_MEMBERSHIP \" failed\");\n@@ -2152,1 +2129,0 @@\n-#ifdef __APPLE__\n@@ -2154,1 +2130,0 @@\n-#endif\n","filename":"src\/java.base\/unix\/native\/libnet\/PlainDatagramSocketImpl.c","additions":24,"deletions":49,"binary":false,"changes":73,"status":"modified"}]}