{"files":[{"patch":"@@ -71,0 +71,33 @@\n+\/\/ Transfer via user-space buffers\n+void transfer(JNIEnv* env, jint dst, jint src, volatile jint* cancel)\n+{\n+    char buf[8192];\n+\n+    for (;;) {\n+        ssize_t n, pos, len;\n+        RESTARTABLE(read((int)src, &buf, sizeof(buf)), n);\n+        if (n <= 0) {\n+            if (n < 0)\n+                throwUnixException(env, errno);\n+            return;\n+        }\n+        if (cancel != NULL && *cancel != 0) {\n+            throwUnixException(env, ECANCELED);\n+            return;\n+        }\n+        pos = 0;\n+        len = n;\n+        do {\n+            char* bufp = buf;\n+            bufp += pos;\n+            RESTARTABLE(write((int)dst, bufp, len), n);\n+            if (n == -1) {\n+                throwUnixException(env, errno);\n+                return;\n+            }\n+            pos += n;\n+            len -= n;\n+        } while (len > 0);\n+    }\n+}\n+\n@@ -90,1 +123,6 @@\n-            throwUnixException(env, errno);\n+            if (errno == EINVAL || errno == ENOSYS) {\n+                \/\/ Fall back to copying via user-space buffers\n+                transfer(env, dst, src, cancel);\n+            } else {\n+                throwUnixException(env, errno);\n+            }\n@@ -117,29 +155,1 @@\n-    \/\/ Transfer via user-space buffers\n-    char buf[8192];\n-\n-    for (;;) {\n-        ssize_t n, pos, len;\n-        RESTARTABLE(read((int)src, &buf, sizeof(buf)), n);\n-        if (n <= 0) {\n-            if (n < 0)\n-                throwUnixException(env, errno);\n-            return;\n-        }\n-        if (cancel != NULL && *cancel != 0) {\n-            throwUnixException(env, ECANCELED);\n-            return;\n-        }\n-        pos = 0;\n-        len = n;\n-        do {\n-            char* bufp = buf;\n-            bufp += pos;\n-            RESTARTABLE(write((int)dst, bufp, len), n);\n-            if (n == -1) {\n-                throwUnixException(env, errno);\n-                return;\n-            }\n-            pos += n;\n-            len -= n;\n-        } while (len > 0);\n-    }\n+    transfer(env, dst, src, cancel);\n","filename":"src\/java.base\/unix\/native\/libnio\/fs\/UnixCopyFile.c","additions":40,"deletions":30,"binary":false,"changes":70,"status":"modified"}]}