{"files":[{"patch":"@@ -993,5 +993,6 @@\n-  if (thread != NULL) {\n-    if (thread->is_Java_thread()) {\n-      oop obj = thread->as_Java_thread()->threadObj();\n-      return (obj == NULL) ? 0 : java_lang_Thread::thread_id(obj);\n-    }\n+  if (thread != NULL && thread->is_Java_thread()) {\n+    Thread* current = Thread::current();\n+    guarantee(current != thread || thread->as_Java_thread()->is_oop_safe(),\n+              \"current cannot touch oops after its GC barrier is detached.\");\n+    oop obj = thread->as_Java_thread()->threadObj();\n+    return (obj == NULL) ? 0 : java_lang_Thread::thread_id(obj);\n","filename":"src\/hotspot\/share\/runtime\/sharedRuntime.cpp","additions":6,"deletions":5,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -124,0 +124,1 @@\n+#include \"services\/threadIdTable.hpp\"\n@@ -3581,0 +3582,7 @@\n+    if (ThreadIdTable::is_initialized()) {\n+      \/\/ This cleanup must be done before the current thread's GC barrier\n+      \/\/ is detached since we need to touch the threadObj oop.\n+      jlong tid = SharedRuntime::get_java_tid(p);\n+      ThreadIdTable::remove_thread(tid);\n+    }\n+\n","filename":"src\/hotspot\/share\/runtime\/thread.cpp","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -698,1 +698,1 @@\n-        \/\/ that has just passed the removal point in ThreadsSMRSupport::remove_thread()\n+        \/\/ that has just passed the removal point in Threads::remove().\n@@ -982,6 +982,0 @@\n-\n-  if (ThreadIdTable::is_initialized()) {\n-    jlong tid = SharedRuntime::get_java_tid(thread);\n-    ThreadIdTable::remove_thread(tid);\n-  }\n-\n","filename":"src\/hotspot\/share\/runtime\/threadSMR.cpp","additions":1,"deletions":7,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -111,1 +111,1 @@\n-          \/\/ that has just passed the removal point in ThreadsSMRSupport::remove_thread()\n+          \/\/ that has just passed the removal point in Threads::remove().\n","filename":"src\/hotspot\/share\/services\/threadIdTable.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}