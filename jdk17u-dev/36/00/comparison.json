{"files":[{"patch":"@@ -59,0 +59,2 @@\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n@@ -229,0 +231,1 @@\n+        String responder = responderURI.toString();\n@@ -231,1 +234,1 @@\n-            debug.println(\"connecting to OCSP service at: \" + responderURI);\n+            debug.println(\"connecting to OCSP service at: \" + responder);\n@@ -234,1 +237,1 @@\n-                responderURI.toString());\n+                responder);\n@@ -239,3 +242,6 @@\n-            String encodedGetReq = responderURI.toString() + \"\/\" +\n-                    URLEncoder.encode(Base64.getEncoder().encodeToString(bytes),\n-                            \"UTF-8\");\n+            StringBuilder encodedGetReq = new StringBuilder(responder);\n+            if (!responder.endsWith(\"\/\")) {\n+                encodedGetReq.append(\"\/\");\n+            }\n+            encodedGetReq.append(URLEncoder.encode(\n+                    Base64.getEncoder().encodeToString(bytes), UTF_8));\n@@ -244,1 +250,1 @@\n-                url = new URL(encodedGetReq);\n+                url = new URL(encodedGetReq.toString());\n","filename":"src\/java.base\/share\/classes\/sun\/security\/provider\/certpath\/OCSP.java","additions":12,"deletions":6,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -641,1 +641,4 @@\n-            respSignature.initVerify(cert.getPublicKey());\n+            SignatureUtil.initVerifyWithParam(respSignature,\n+                    cert.getPublicKey(),\n+                    SignatureUtil.getParamSpec(sigAlgId.getName(),\n+                            sigAlgId.getEncodedParams()));\n@@ -657,2 +660,2 @@\n-        } catch (InvalidKeyException | NoSuchAlgorithmException |\n-                 SignatureException e)\n+        } catch (InvalidAlgorithmParameterException | InvalidKeyException\n+                | NoSuchAlgorithmException | SignatureException e)\n","filename":"src\/java.base\/share\/classes\/sun\/security\/provider\/certpath\/OCSPResponse.java","additions":6,"deletions":3,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2018, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2018, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -173,2 +173,1 @@\n-            throws ProviderException, InvalidAlgorithmParameterException,\n-            InvalidKeyException {\n+            throws InvalidAlgorithmParameterException, InvalidKeyException {\n@@ -183,2 +182,1 @@\n-            throws ProviderException, InvalidAlgorithmParameterException,\n-            InvalidKeyException {\n+            throws InvalidAlgorithmParameterException, InvalidKeyException {\n@@ -192,2 +190,1 @@\n-            throws ProviderException, InvalidAlgorithmParameterException,\n-            InvalidKeyException {\n+            throws InvalidAlgorithmParameterException, InvalidKeyException {\n@@ -345,1 +342,1 @@\n-     * @param key public or private key\n+     * @param key private key\n@@ -348,1 +345,1 @@\n-    public static Signature fromKey(String sigAlg, Key key, String provider)\n+    public static Signature fromKey(String sigAlg, PrivateKey key, String provider)\n@@ -361,1 +358,1 @@\n-     * @param key public or private key\n+     * @param key private key\n@@ -364,1 +361,1 @@\n-    public static Signature fromKey(String sigAlg, Key key, Provider provider)\n+    public static Signature fromKey(String sigAlg, PrivateKey key, Provider provider)\n@@ -372,1 +369,1 @@\n-    private static Signature autoInitInternal(String alg, Key key, Signature s)\n+    private static Signature autoInitInternal(String alg, PrivateKey key, Signature s)\n@@ -377,6 +374,1 @@\n-            if (key instanceof PrivateKey) {\n-                SignatureUtil.initSignWithParam(s, (PrivateKey) key, params,\n-                        null);\n-            } else {\n-                SignatureUtil.initVerifyWithParam(s, (PublicKey) key, params);\n-            }\n+            SignatureUtil.initSignWithParam(s, key, params, null);\n","filename":"src\/java.base\/share\/classes\/sun\/security\/util\/SignatureUtil.java","additions":10,"deletions":18,"binary":false,"changes":28,"status":"modified"},{"patch":"@@ -315,1 +315,1 @@\n-    public byte[] getEncodedParams() throws IOException {\n+    public byte[] getEncodedParams() {\n","filename":"src\/java.base\/share\/classes\/sun\/security\/x509\/AlgorithmId.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1997, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1997, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -823,7 +823,1 @@\n-        if (sigAlgId == null)\n-            return null;\n-        try {\n-            return sigAlgId.getEncodedParams();\n-        } catch (IOException e) {\n-            return null;\n-        }\n+        return sigAlgId == null ? null : sigAlgId.getEncodedParams();\n","filename":"src\/java.base\/share\/classes\/sun\/security\/x509\/X509CRLImpl.java","additions":2,"deletions":8,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -1033,7 +1033,1 @@\n-        if (algId == null)\n-            return null;\n-        try {\n-            return algId.getEncodedParams();\n-        } catch (IOException e) {\n-            return null;\n-        }\n+        return algId == null ? null : algId.getEncodedParams();\n","filename":"src\/java.base\/share\/classes\/sun\/security\/x509\/X509CertImpl.java","additions":1,"deletions":7,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -41,0 +41,1 @@\n+import sun.security.util.SignatureUtil;\n@@ -367,2 +368,1 @@\n-        AlgorithmId signAlg = AlgorithmId.get(algName);\n-        byte[] encodedCert = encodeTopLevel(issuerCert, issuerKey, signAlg);\n+        byte[] encodedCert = encodeTopLevel(issuerCert, issuerKey, algName);\n@@ -395,2 +395,4 @@\n-            PrivateKey issuerKey, AlgorithmId signAlg)\n-            throws CertificateException, IOException {\n+            PrivateKey issuerKey, String algName)\n+            throws CertificateException, IOException, NoSuchAlgorithmException {\n+\n+        AlgorithmId signAlg = AlgorithmId.get(algName);\n@@ -400,2 +402,0 @@\n-        tbsCertBytes = encodeTbsCert(issuerCert, signAlg);\n-        topLevelItems.write(tbsCertBytes);\n@@ -403,1 +403,6 @@\n-            signatureBytes = signCert(issuerKey, signAlg);\n+            Signature sig = SignatureUtil.fromKey(signAlg.getName(), issuerKey, (Provider)null);\n+            \/\/ Rewrite signAlg, RSASSA-PSS needs some parameters.\n+            signAlg = SignatureUtil.fromSignature(sig, issuerKey);\n+            tbsCertBytes = encodeTbsCert(issuerCert, signAlg);\n+            sig.update(tbsCertBytes);\n+            signatureBytes = sig.sign();\n@@ -407,0 +412,1 @@\n+        topLevelItems.write(tbsCertBytes);\n@@ -521,19 +527,1 @@\n-    \/**\n-     * Digitally sign the X.509 certificate.\n-     *\n-     * @param issuerKey The private key of the issuing authority\n-     * @param signAlg The signature algorithm object\n-     *\n-     * @return The digital signature bytes.\n-     *\n-     * @throws GeneralSecurityException If any errors occur during the\n-     * digital signature process.\n-     *\/\n-    private byte[] signCert(PrivateKey issuerKey, AlgorithmId signAlg)\n-            throws GeneralSecurityException {\n-        Signature sig = Signature.getInstance(signAlg.getName());\n-        sig.initSign(issuerKey);\n-        sig.update(tbsCertBytes);\n-        return sig.sign();\n-    }\n- }\n+}\n","filename":"test\/jdk\/java\/security\/testlibrary\/CertificateBuilder.java","additions":15,"deletions":27,"binary":false,"changes":42,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -177,2 +177,1 @@\n-\n-        sigAlgId = AlgorithmId.get(\"Sha256withRSA\");\n+        sigAlgId = AlgorithmId.get(SignatureUtil.getDefaultSigAlgForKey(signerKey));\n@@ -1351,2 +1350,0 @@\n-                sigAlgId.derEncode(basicORItemStream);\n-\n@@ -1354,2 +1351,2 @@\n-                Signature sig = Signature.getInstance(sigAlgId.getName());\n-                sig.initSign(signerKey);\n+                Signature sig = SignatureUtil.fromKey(\n+                        sigAlgId.getName(), signerKey, (Provider)null);\n@@ -1358,0 +1355,3 @@\n+                \/\/ Rewrite signAlg, RSASSA-PSS needs some parameters.\n+                sigAlgId = SignatureUtil.fromSignature(sig, signerKey);\n+                sigAlgId.derEncode(basicORItemStream);\n","filename":"test\/jdk\/java\/security\/testlibrary\/SimpleOCSPServer.java","additions":7,"deletions":7,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, 2018, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -33,1 +33,2 @@\n- * @run main\/othervm HttpsUrlConnClient\n+ * @run main\/othervm HttpsUrlConnClient RSA SHA256withRSA\n+ * @run main\/othervm HttpsUrlConnClient RSASSA-PSS RSASSA-PSS\n@@ -63,1 +64,0 @@\n-import sun.security.validator.ValidatorException;\n@@ -76,0 +76,3 @@\n+    static String SIGALG;\n+    static String KEYALG;\n+\n@@ -140,0 +143,3 @@\n+        KEYALG = args[0];\n+        SIGALG = args[1];\n+\n@@ -517,1 +523,1 @@\n-        KeyPairGenerator keyGen = KeyPairGenerator.getInstance(\"RSA\");\n+        KeyPairGenerator keyGen = KeyPairGenerator.getInstance(KEYALG);\n@@ -543,1 +549,1 @@\n-                \"SHA256withRSA\");\n+                SIGALG);\n@@ -585,1 +591,1 @@\n-                \"SHA256withRSA\");\n+                SIGALG);\n@@ -647,1 +653,1 @@\n-                \"SHA256withRSA\");\n+                SIGALG);\n","filename":"test\/jdk\/javax\/net\/ssl\/Stapling\/HttpsUrlConnClient.java","additions":13,"deletions":7,"binary":false,"changes":20,"status":"modified"}]}