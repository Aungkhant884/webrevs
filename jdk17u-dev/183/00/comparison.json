{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2001, 2005, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2001, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -84,1 +84,0 @@\n-    debugMonitorEnter(classTrackLock);\n@@ -86,3 +85,1 @@\n-        \/\/ Class tracking not initialized, nobody's interested.\n-        debugMonitorExit(classTrackLock);\n-        return NULL;\n+      return NULL;\n@@ -90,0 +87,11 @@\n+\n+    \/* Allocate new bag outside classTrackLock lock to avoid deadlock.\n+     *\n+     * Note: jvmtiAllocate\/jvmtiDeallocate() may be blocked by ongoing safepoints.\n+     * It is dangerous to call them (via bagCreateBag\/bagDestroyBag()) while holding monitor(s),\n+     * because jvmti may post events, e.g. JVMTI_EVENT_OBJECT_FREE at safepoints and event processing\n+     * code may acquire the same monitor(s), e.g. classTrackLock in cbTrackingObjectFree(),\n+     * which can lead to deadlock.\n+     *\/\n+    struct bag* new_bag = bagCreateBag(sizeof(char*), 10);\n+    debugMonitorEnter(classTrackLock);\n@@ -91,1 +99,1 @@\n-    deletedSignatures = bagCreateBag(sizeof(char*), 10);\n+    deletedSignatures = new_bag;\n@@ -197,0 +205,3 @@\n+    \/\/ Allocate bag outside classTrackLock lock to avoid deadlock.\n+    \/\/ See comments in classTrack_processUnloads() for details.\n+    struct bag* new_bag = bagCreateBag(sizeof(char*), 1000);\n@@ -198,1 +209,1 @@\n-    deletedSignatures = bagCreateBag(sizeof(char*), 1000);\n+    deletedSignatures = new_bag;\n@@ -217,0 +228,3 @@\n+    struct bag* to_delete = deletedSignatures;\n+    deletedSignatures = NULL;\n+    debugMonitorExit(classTrackLock);\n@@ -218,4 +232,5 @@\n-    if (deletedSignatures != NULL) {\n-        bagEnumerateOver(deletedSignatures, cleanDeleted, NULL);\n-        bagDestroyBag(deletedSignatures);\n-        deletedSignatures = NULL;\n+    \/\/ Deallocate bag outside classTrackLock to avoid deadlock.\n+    \/\/ See comments in classTrack_processUnloads() for details.\n+    if (to_delete != NULL) {\n+      bagEnumerateOver(to_delete, cleanDeleted, NULL);\n+      bagDestroyBag(to_delete);\n@@ -223,2 +238,0 @@\n-\n-    debugMonitorExit(classTrackLock);\n","filename":"src\/jdk.jdwp.agent\/share\/native\/libjdwp\/classTrack.c","additions":26,"deletions":13,"binary":false,"changes":39,"status":"modified"}]}