{"files":[{"patch":"@@ -2,2 +2,2 @@\n- * Copyright (c) 1997, 2021, Oracle and\/or its affiliates. All rights reserved.\n- * Copyright (c) 2012, 2021 SAP SE. All rights reserved.\n+ * Copyright (c) 1997, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2012, 2022 SAP SE. All rights reserved.\n@@ -2945,0 +2945,1 @@\n+  beq(flag, cont);\n@@ -2946,1 +2947,2 @@\n-# ifdef ASSERT\n+  \/\/ Check for recursive locking.\n+  cmpd(flag, current_header, R16_thread);\n@@ -2948,7 +2950,6 @@\n-  \/\/ We have acquired the monitor, check some invariants.\n-  addi(\/*monitor=*\/temp, temp, -ObjectMonitor::owner_offset_in_bytes());\n-  \/\/ Invariant 1: _recursions should be 0.\n-  \/\/assert(ObjectMonitor::recursions_size_in_bytes() == 8, \"unexpected size\");\n-  asm_assert_mem8_is_zero(ObjectMonitor::recursions_offset_in_bytes(), temp,\n-                            \"monitor->_recursions should be 0\");\n-# endif\n+\n+  \/\/ Current thread already owns the lock. Just increment recursions.\n+  Register recursions = displaced_header;\n+  ld(recursions, ObjectMonitor::recursions_offset_in_bytes()-ObjectMonitor::owner_offset_in_bytes(), temp);\n+  addi(recursions, recursions, 1);\n+  std(recursions, ObjectMonitor::recursions_offset_in_bytes()-ObjectMonitor::owner_offset_in_bytes(), temp);\n@@ -2970,2 +2971,1 @@\n-  Label cont;\n-  Label object_has_monitor;\n+  Label cont, object_has_monitor, notRecursive;\n@@ -3042,3 +3042,2 @@\n-  xorr(temp, R16_thread, temp);      \/\/ Will be 0 if we are the owner.\n-  orr(temp, temp, displaced_header); \/\/ Will be 0 if there are 0 recursions.\n-  cmpdi(flag, temp, 0);\n+\n+  cmpd(flag, temp, R16_thread);\n@@ -3047,0 +3046,6 @@\n+  addic_(displaced_header, displaced_header, -1);\n+  blt(CCR0, notRecursive); \/\/ Not recursive if negative after decrement.\n+  std(displaced_header, ObjectMonitor::recursions_offset_in_bytes(), current_header);\n+  b(cont); \/\/ flag is already EQ here.\n+\n+  bind(notRecursive);\n","filename":"src\/hotspot\/cpu\/ppc\/macroAssembler_ppc.cpp","additions":20,"deletions":15,"binary":false,"changes":35,"status":"modified"}]}