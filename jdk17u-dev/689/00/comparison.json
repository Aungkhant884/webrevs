{"files":[{"patch":"@@ -742,0 +742,47 @@\n+\n+\/\/ Test that repeated allocation-deallocation cycles with the same block size\n+\/\/  do not increase metaspace usage after the initial allocation (the deallocated\n+\/\/  block should be reused by the next allocation).\n+static void test_repeatedly_allocate_and_deallocate(bool is_topmost) {\n+  if (Settings::handle_deallocations()) {\n+    \/\/ Test various sizes, including (important) the max. possible block size = 1 root chunk\n+    for (size_t blocksize = Metaspace::max_allocation_word_size(); blocksize >= 1; blocksize \/= 2) {\n+      size_t used1 = 0, used2 = 0, committed1 = 0, committed2 = 0;\n+      MetaWord* p = NULL, *p2 = NULL;\n+\n+      MetaspaceGtestContext context;\n+      MetaspaceArenaTestHelper helper(context, Metaspace::StandardMetaspaceType, false);\n+\n+      \/\/ First allocation\n+      helper.allocate_from_arena_with_tests_expect_success(&p, blocksize);\n+      if (!is_topmost) {\n+        \/\/ another one on top, size does not matter.\n+        helper.allocate_from_arena_with_tests_expect_success(0x10);\n+      }\n+\n+      \/\/ Measure\n+      helper.usage_numbers_with_test(&used1, &committed1, NULL);\n+\n+      \/\/ Dealloc, alloc several times with the same size.\n+      for (int i = 0; i < 5; i ++) {\n+        helper.deallocate_with_tests(p, blocksize);\n+        helper.allocate_from_arena_with_tests_expect_success(&p2, blocksize);\n+        \/\/ We should get the same pointer back.\n+        EXPECT_EQ(p2, p);\n+      }\n+\n+      \/\/ Measure again\n+      helper.usage_numbers_with_test(&used2, &committed2, NULL);\n+      EXPECT_EQ(used2, used1);\n+      EXPECT_EQ(committed1, committed2);\n+    }\n+  }\n+}\n+\n+TEST_VM(metaspace, MetaspaceArena_test_repeatedly_allocate_and_deallocate_top_allocation) {\n+  test_repeatedly_allocate_and_deallocate(true);\n+}\n+\n+TEST_VM(metaspace, MetaspaceArena_test_repeatedly_allocate_and_deallocate_nontop_allocation) {\n+  test_repeatedly_allocate_and_deallocate(false);\n+}\n","filename":"test\/hotspot\/gtest\/metaspace\/test_metaspacearena.cpp","additions":47,"deletions":0,"binary":false,"changes":47,"status":"modified"}]}