{"files":[{"patch":"@@ -2,1 +2,2 @@\n- * Copyright (c) 1999, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1999, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2022 SAP SE. All rights reserved.\n@@ -2174,0 +2175,28 @@\n+#ifdef __GLIBC__\n+\/\/ For Glibc, print a one-liner with the malloc tunables.\n+\/\/ Most important and popular is MALLOC_ARENA_MAX, but we are\n+\/\/ thorough and print them all.\n+static void print_glibc_malloc_tunables(outputStream* st) {\n+  static const char* var[] = {\n+      \/\/ the new variant\n+      \"GLIBC_TUNABLES\",\n+      \/\/ legacy variants\n+      \"MALLOC_CHECK_\", \"MALLOC_TOP_PAD_\", \"MALLOC_PERTURB_\",\n+      \"MALLOC_MMAP_THRESHOLD_\", \"MALLOC_TRIM_THRESHOLD_\",\n+      \"MALLOC_MMAP_MAX_\", \"MALLOC_ARENA_TEST\", \"MALLOC_ARENA_MAX\",\n+      NULL};\n+  st->print(\"glibc malloc tunables: \");\n+  bool printed = false;\n+  for (int i = 0; var[i] != NULL; i ++) {\n+    const char* const val = ::getenv(var[i]);\n+    if (val != NULL) {\n+      st->print(\"%s%s=%s\", (printed ? \", \" : \"\"), var[i], val);\n+      printed = true;\n+    }\n+  }\n+  if (!printed) {\n+    st->print(\"(default)\");\n+  }\n+}\n+#endif \/\/ __GLIBC__\n+\n@@ -2196,2 +2225,3 @@\n-  \/\/ Print glibc outstanding allocations.\n-  \/\/ (note: there is no implementation of mallinfo for muslc)\n+  \/\/ glibc only:\n+  \/\/ - Print outstanding allocations using mallinfo\n+  \/\/ - Print glibc tunables\n@@ -2205,3 +2235,4 @@\n-    \/\/ mallinfo is an old API. Member names mean next to nothing and, beyond that, are int.\n-    \/\/ So values may have wrapped around. Still useful enough to see how much glibc thinks\n-    \/\/ we allocated.\n+    \/\/ mallinfo is an old API. Member names mean next to nothing and, beyond that, are 32-bit signed.\n+    \/\/ So for larger footprints the values may have wrapped around. We try to detect this here: if the\n+    \/\/ process whole resident set size is smaller than 4G, malloc footprint has to be less than that\n+    \/\/ and the numbers are reliable.\n@@ -2218,2 +2249,4 @@\n-#endif \/\/ __GLIBC__\n-\n+  \/\/ Tunables\n+  print_glibc_malloc_tunables(st);\n+  st->cr();\n+#endif\n","filename":"src\/hotspot\/os\/linux\/os_linux.cpp","additions":41,"deletions":8,"binary":false,"changes":49,"status":"modified"}]}