{"files":[{"patch":"@@ -33,0 +33,1 @@\n+#include \"jfr\/support\/jfrThreadLocal.hpp\"\n@@ -297,6 +298,4 @@\n-static void prepare_dcmd_string_arena() {\n-  if (dcmd_arena == NULL) {\n-    dcmd_arena = new (mtTracing) Arena(mtTracing);\n-  } else {\n-    dcmd_arena->destruct_contents(); \/\/ will grow on next allocation\n-  }\n+static void prepare_dcmd_string_arena(JavaThread* jt) {\n+  dcmd_arena = JfrThreadLocal::dcmd_arena(jt);\n+  assert(dcmd_arena != nullptr, \"invariant\");\n+  dcmd_arena->destruct_contents(); \/\/ will grow on next allocation\n@@ -310,1 +309,1 @@\n-static const char* get_as_dcmd_arena_string(oop string, JavaThread* t) {\n+static const char* get_as_dcmd_arena_string(oop string) {\n@@ -331,1 +330,1 @@\n-  return string_oop != NULL ? get_as_dcmd_arena_string(string_oop, (JavaThread*)THREAD) : NULL;\n+  return string_oop != NULL ? get_as_dcmd_arena_string(string_oop) : NULL;\n@@ -380,1 +379,1 @@\n-  prepare_dcmd_string_arena();\n+  prepare_dcmd_string_arena(thread);\n","filename":"src\/hotspot\/share\/jfr\/dcmd\/jfrDcmds.cpp","additions":8,"deletions":9,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -37,0 +37,1 @@\n+#include \"memory\/arena.hpp\"\n@@ -49,0 +50,1 @@\n+  _dcmd_arena(nullptr),\n@@ -145,0 +147,4 @@\n+  if (_dcmd_arena != nullptr) {\n+    delete _dcmd_arena;\n+    _dcmd_arena = nullptr;\n+  }\n@@ -221,0 +227,12 @@\n+\n+Arena* JfrThreadLocal::dcmd_arena(JavaThread* jt) {\n+  assert(jt != nullptr, \"invariant\");\n+  JfrThreadLocal* tl = jt->jfr_thread_local();\n+  Arena* arena = tl->_dcmd_arena;\n+  if (arena != nullptr) {\n+    return arena;\n+  }\n+  arena = new (mtTracing) Arena(mtTracing);\n+  tl->_dcmd_arena = arena;\n+  return arena;\n+}\n","filename":"src\/hotspot\/share\/jfr\/support\/jfrThreadLocal.cpp","additions":18,"deletions":0,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -31,0 +31,1 @@\n+class Arena;\n@@ -45,0 +46,1 @@\n+  Arena* _dcmd_arena;\n@@ -222,0 +224,2 @@\n+  static Arena* dcmd_arena(JavaThread* jt);\n+\n","filename":"src\/hotspot\/share\/jfr\/support\/jfrThreadLocal.hpp","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"}]}