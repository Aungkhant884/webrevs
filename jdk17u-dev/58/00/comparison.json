{"files":[{"patch":"@@ -230,1 +230,1 @@\n-  if (nm != NULL && nm->oops_do_try_claim()) {\n+  if (nm != NULL) {\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahClosures.inline.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -82,1 +82,0 @@\n-  nmethod::oops_do_marking_prologue();\n@@ -90,4 +89,0 @@\n-ShenandoahCodeCacheRoots::~ShenandoahCodeCacheRoots() {\n-  nmethod::oops_do_marking_epilogue();\n-}\n-\n@@ -261,7 +256,29 @@\n- void ShenandoahHeapIterationRootScanner::roots_do(OopClosure* oops) {\n-   assert(Thread::current()->is_VM_thread(), \"Only by VM thread\");\n-   \/\/ Must use _claim_none to avoid interfering with concurrent CLDG iteration\n-   CLDToOopClosure clds(oops, ClassLoaderData::_claim_none);\n-   MarkingCodeBlobClosure code(oops, !CodeBlobToOopClosure::FixRelocations);\n-   ShenandoahParallelOopsDoThreadClosure tc_cl(oops, &code, NULL);\n-   AlwaysTrueClosure always_true;\n+class ShenandoahMarkCodeBlobClosure : public CodeBlobClosure {\n+private:\n+  OopClosure* const _oops;\n+  BarrierSetNMethod* const _bs_nm;\n+\n+public:\n+  ShenandoahMarkCodeBlobClosure(OopClosure* oops) :\n+    _oops(oops),\n+    _bs_nm(BarrierSet::barrier_set()->barrier_set_nmethod()) {}\n+\n+  virtual void do_code_blob(CodeBlob* cb) {\n+    nmethod* const nm = cb->as_nmethod_or_null();\n+    if (nm != nullptr) {\n+      if (_bs_nm != nullptr) {\n+        \/\/ Make sure it only sees to-space objects\n+        _bs_nm->nmethod_entry_barrier(nm);\n+      }\n+      ShenandoahNMethod* const snm = ShenandoahNMethod::gc_data(nm);\n+      assert(snm != nullptr, \"Sanity\");\n+      snm->oops_do(_oops, false \/*fix_relocations*\/);\n+    }\n+  }\n+};\n+\n+void ShenandoahHeapIterationRootScanner::roots_do(OopClosure* oops) {\n+  \/\/ Must use _claim_other to avoid interfering with concurrent CLDG iteration\n+  CLDToOopClosure clds(oops, ClassLoaderData::_claim_other);\n+  ShenandoahMarkCodeBlobClosure code(oops);\n+  ShenandoahParallelOopsDoThreadClosure tc_cl(oops, &code, NULL);\n@@ -269,1 +286,1 @@\n-   ResourceMark rm;\n+  ResourceMark rm;\n@@ -271,4 +288,4 @@\n-   \/\/ Process light-weight\/limited parallel roots then\n-   _vm_roots.oops_do(oops, 0);\n-   _weak_roots.oops_do<OopClosure>(oops, 0);\n-   _cld_roots.cld_do(&clds, 0);\n+  \/\/ Process light-weight\/limited parallel roots then\n+  _vm_roots.oops_do(oops, 0);\n+  _weak_roots.oops_do<OopClosure>(oops, 0);\n+  _cld_roots.cld_do(&clds, 0);\n@@ -276,4 +293,4 @@\n-   \/\/ Process heavy-weight\/fully parallel roots the last\n-   _code_roots.code_blobs_do(&code, 0);\n-   _thread_roots.threads_do(&tc_cl, 0);\n- }\n+  \/\/ Process heavy-weight\/fully parallel roots the last\n+  _code_roots.code_blobs_do(&code, 0);\n+  _thread_roots.threads_do(&tc_cl, 0);\n+}\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahRootProcessor.cpp","additions":38,"deletions":21,"binary":false,"changes":59,"status":"modified"},{"patch":"@@ -105,1 +105,0 @@\n-  ~ShenandoahCodeCacheRoots();\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahRootProcessor.hpp","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"}]}