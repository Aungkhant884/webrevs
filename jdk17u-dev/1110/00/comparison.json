{"files":[{"patch":"@@ -60,1 +60,1 @@\n-     * At this stage, there are at least 2 messages are in queue. Now, start\n+     * At this stage, there are at least 2 messages in queue. Now, start\n@@ -63,1 +63,1 @@\n-     * the a single Ping has to be replied). Then send a Close message. Now\n+     * a single Ping has to be replied). Then send a Close message. Now\n@@ -114,1 +114,1 @@\n-                    cfText.get(MAX_WAIT_SEC, TimeUnit.SECONDS);\n+                    cfText.get(waitSec, TimeUnit.SECONDS);\n@@ -127,0 +127,7 @@\n+            List<MockListener.Invocation> invocations = listener.invocations();\n+            cfClose = webSocket.sendClose(WebSocket.NORMAL_CLOSURE, \"ok\");\n+\n+            assertFalse(invocations.contains(new MockListener.OnError(webSocket, IOException.class)));\n+            assertFalse(cfText.isDone());\n+            assertFalse(cfPing.isDone());\n+            assertFalse(cfClose.isDone());\n@@ -129,7 +136,0 @@\n-        List<MockListener.Invocation> invocations = listener.invocations();\n-        cfClose = webSocket.sendClose(WebSocket.NORMAL_CLOSURE, \"ok\");\n-\n-        assertFalse(invocations.contains(new MockListener.OnError(webSocket, IOException.class)));\n-        assertFalse(cfText.isDone());\n-        assertFalse(cfPing.isDone());\n-        assertFalse(cfClose.isDone());\n","filename":"test\/jdk\/java\/net\/httpclient\/websocket\/BlowupOutputQueue.java","additions":10,"deletions":10,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -63,1 +63,1 @@\n-                    cfBinary.get(MAX_WAIT_SEC, TimeUnit.SECONDS);\n+                    cfBinary.get(waitSec, TimeUnit.SECONDS);\n@@ -77,1 +77,0 @@\n-            assertHangs(cfPing);\n@@ -81,1 +80,1 @@\n-            assertHangs(cfClose);\n+            assertAllHang(cfPing, cfClose);\n@@ -83,0 +82,4 @@\n+            webSocket.abort();\n+            assertFails(IOE, cfBinary);\n+            assertFails(IOE, cfPing);\n+            assertFails(IOE, cfClose);\n@@ -85,4 +88,0 @@\n-        webSocket.abort();\n-        assertFails(IOE, cfBinary);\n-        assertFails(IOE, cfPing);\n-        assertFails(IOE, cfClose);\n","filename":"test\/jdk\/java\/net\/httpclient\/websocket\/PendingBinaryPingClose.java","additions":6,"deletions":7,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -41,2 +41,0 @@\n-import static java.net.http.HttpClient.Builder.NO_PROXY;\n-import static java.net.http.HttpClient.newBuilder;\n@@ -65,1 +63,1 @@\n-                    cfBinary.get(MAX_WAIT_SEC, TimeUnit.SECONDS);\n+                    cfBinary.get(waitSec, TimeUnit.SECONDS);\n@@ -79,1 +77,0 @@\n-            assertHangs(cfPong);\n@@ -83,1 +80,1 @@\n-            assertHangs(cfClose);\n+            assertAllHang(cfPong, cfClose);\n@@ -85,0 +82,4 @@\n+            webSocket.abort();\n+            assertFails(IOE, cfBinary);\n+            assertFails(IOE, cfPong);\n+            assertFails(IOE, cfClose);\n@@ -87,4 +88,0 @@\n-        webSocket.abort();\n-        assertFails(IOE, cfBinary);\n-        assertFails(IOE, cfPong);\n-        assertFails(IOE, cfClose);\n","filename":"test\/jdk\/java\/net\/httpclient\/websocket\/PendingBinaryPongClose.java","additions":6,"deletions":9,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -44,1 +44,1 @@\n-    \/\/ receive buffer must be full. This has been heuristically determined.\n+    \/\/ receive buffer must be full.\n@@ -48,0 +48,1 @@\n+    long waitSec;\n@@ -66,0 +67,6 @@\n+    \/* shortcut *\/\n+    static void assertAllHang(CompletableFuture<?> cf1,\n+                              CompletableFuture<?> cf2) {\n+        assertHangs(CompletableFuture.anyOf(cf1, cf2));\n+    }\n+\n@@ -102,0 +109,5 @@\n+            if (iterations == 1) {\n+                waitSec = initialWaitSec();\n+            } else {\n+                waitSec = MAX_WAIT_SEC;\n+            }\n@@ -128,0 +140,4 @@\n+\n+    long initialWaitSec() {\n+        return 1;\n+    }\n","filename":"test\/jdk\/java\/net\/httpclient\/websocket\/PendingOperations.java","additions":17,"deletions":1,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -65,1 +65,1 @@\n-                    cfPing.get(MAX_WAIT_SEC, TimeUnit.SECONDS);\n+                    cfPing.get(waitSec, TimeUnit.SECONDS);\n@@ -77,1 +77,0 @@\n-            assertHangs(cfBinary);\n@@ -79,1 +78,1 @@\n-            assertHangs(cfClose);\n+            assertAllHang(cfBinary, cfClose);\n@@ -81,0 +80,4 @@\n+            webSocket.abort();\n+            assertFails(IOE, cfPing);\n+            assertFails(IOE, cfBinary);\n+            assertFails(IOE, cfClose);\n@@ -83,4 +86,6 @@\n-        webSocket.abort();\n-        assertFails(IOE, cfPing);\n-        assertFails(IOE, cfBinary);\n-        assertFails(IOE, cfClose);\n+    }\n+\n+    @Override\n+    long initialWaitSec() {\n+        \/\/ Some Windows machines increase buffer size after 1-2 seconds\n+        return isWindows() ? 3 : 1;\n","filename":"test\/jdk\/java\/net\/httpclient\/websocket\/PendingPingBinaryClose.java","additions":12,"deletions":7,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -68,1 +68,1 @@\n-                        cfPing.get(MAX_WAIT_SEC, TimeUnit.SECONDS);\n+                        cfPing.get(waitSec, TimeUnit.SECONDS);\n@@ -76,1 +76,1 @@\n-                        if (debug || done || (stop - start) > (MAX_WAIT_SEC * 1000L)\/2L)\n+                        if (debug || done || (stop - start) > (waitSec * 1000L)\/2L)\n@@ -82,1 +82,0 @@\n-                System.out.println(\"asserting that sendText hangs\");\n@@ -84,2 +83,0 @@\n-                assertHangs(cfText);\n-                System.out.println(\"asserting that sendClose hangs\");\n@@ -87,1 +84,2 @@\n-                assertHangs(cfClose);\n+                System.out.println(\"asserting that sendText and sendClose hang\");\n+                assertAllHang(cfText, cfClose);\n@@ -91,0 +89,4 @@\n+                webSocket.abort();\n+                assertFails(IOE, cfPing);\n+                assertFails(IOE, cfText);\n+                assertFails(IOE, cfClose);\n@@ -93,4 +95,0 @@\n-            webSocket.abort();\n-            assertFails(IOE, cfPing);\n-            assertFails(IOE, cfText);\n-            assertFails(IOE, cfClose);\n@@ -103,0 +101,6 @@\n+\n+    @Override\n+    long initialWaitSec() {\n+        \/\/ Some Windows machines increase buffer size after 1-2 seconds\n+        return isWindows() ? 3 : 1;\n+    }\n","filename":"test\/jdk\/java\/net\/httpclient\/websocket\/PendingPingTextClose.java","additions":14,"deletions":10,"binary":false,"changes":24,"status":"modified"},{"patch":"@@ -65,1 +65,1 @@\n-                    cfPong.get(MAX_WAIT_SEC, TimeUnit.SECONDS);\n+                    cfPong.get(waitSec, TimeUnit.SECONDS);\n@@ -77,1 +77,0 @@\n-            assertHangs(cfBinary);\n@@ -79,1 +78,1 @@\n-            assertHangs(cfClose);\n+            assertAllHang(cfBinary, cfClose);\n@@ -81,0 +80,4 @@\n+            webSocket.abort();\n+            assertFails(IOE, cfPong);\n+            assertFails(IOE, cfBinary);\n+            assertFails(IOE, cfClose);\n@@ -83,4 +86,6 @@\n-        webSocket.abort();\n-        assertFails(IOE, cfPong);\n-        assertFails(IOE, cfBinary);\n-        assertFails(IOE, cfClose);\n+    }\n+\n+    @Override\n+    long initialWaitSec() {\n+        \/\/ Some Windows machines increase buffer size after 1-2 seconds\n+        return isWindows() ? 3 : 1;\n","filename":"test\/jdk\/java\/net\/httpclient\/websocket\/PendingPongBinaryClose.java","additions":12,"deletions":7,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -65,1 +65,1 @@\n-                    cfPong.get(MAX_WAIT_SEC, TimeUnit.SECONDS);\n+                    cfPong.get(waitSec, TimeUnit.SECONDS);\n@@ -77,1 +77,0 @@\n-            assertHangs(cfText);\n@@ -79,1 +78,1 @@\n-            assertHangs(cfClose);\n+            assertAllHang(cfText, cfClose);\n@@ -81,0 +80,4 @@\n+            webSocket.abort();\n+            assertFails(IOE, cfPong);\n+            assertFails(IOE, cfText);\n+            assertFails(IOE, cfClose);\n@@ -83,4 +86,6 @@\n-        webSocket.abort();\n-        assertFails(IOE, cfPong);\n-        assertFails(IOE, cfText);\n-        assertFails(IOE, cfClose);\n+    }\n+\n+    @Override\n+    long initialWaitSec() {\n+        \/\/ Some Windows machines increase buffer size after 1-2 seconds\n+        return isWindows() ? 3 : 1;\n","filename":"test\/jdk\/java\/net\/httpclient\/websocket\/PendingPongTextClose.java","additions":12,"deletions":7,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -65,1 +65,1 @@\n-                    cfText.get(MAX_WAIT_SEC, TimeUnit.SECONDS);\n+                    cfText.get(waitSec, TimeUnit.SECONDS);\n@@ -79,1 +79,0 @@\n-            assertHangs(cfPing);\n@@ -83,1 +82,1 @@\n-            assertHangs(cfClose);\n+            assertAllHang(cfPing, cfClose);\n@@ -85,0 +84,4 @@\n+            webSocket.abort();\n+            assertFails(IOE, cfText);\n+            assertFails(IOE, cfPing);\n+            assertFails(IOE, cfClose);\n@@ -87,4 +90,0 @@\n-        webSocket.abort();\n-        assertFails(IOE, cfText);\n-        assertFails(IOE, cfPing);\n-        assertFails(IOE, cfClose);\n","filename":"test\/jdk\/java\/net\/httpclient\/websocket\/PendingTextPingClose.java","additions":6,"deletions":7,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -64,1 +64,1 @@\n-                    cfText.get(MAX_WAIT_SEC, TimeUnit.SECONDS);\n+                    cfText.get(waitSec, TimeUnit.SECONDS);\n@@ -78,1 +78,0 @@\n-            assertHangs(cfPong);\n@@ -82,1 +81,1 @@\n-            assertHangs(cfClose);\n+            assertAllHang(cfPong, cfClose);\n@@ -84,0 +83,4 @@\n+            webSocket.abort();\n+            assertFails(IOE, cfText);\n+            assertFails(IOE, cfPong);\n+            assertFails(IOE, cfClose);\n@@ -86,4 +89,0 @@\n-        webSocket.abort();\n-        assertFails(IOE, cfText);\n-        assertFails(IOE, cfPong);\n-        assertFails(IOE, cfClose);\n","filename":"test\/jdk\/java\/net\/httpclient\/websocket\/PendingTextPongClose.java","additions":6,"deletions":7,"binary":false,"changes":13,"status":"modified"}]}