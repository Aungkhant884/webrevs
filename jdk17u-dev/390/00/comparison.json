{"files":[{"patch":"@@ -817,0 +817,1 @@\n+  ResourceMark rm;\n@@ -818,0 +819,1 @@\n+\n@@ -819,1 +821,4 @@\n-    ret = pthread_create(&tid, &attr, (void* (*)(void*)) thread_native_entry, thread);\n+    int limit = 3;\n+    do {\n+      ret = pthread_create(&tid, &attr, (void* (*)(void*)) thread_native_entry, thread);\n+    } while (ret == EAGAIN && limit-- > 0);\n@@ -824,2 +829,2 @@\n-    log_info(os, thread)(\"Thread started (pthread id: \" UINTX_FORMAT \", attributes: %s). \",\n-      (uintx) tid, os::Posix::describe_pthread_attr(buf, sizeof(buf), &attr));\n+    log_info(os, thread)(\"Thread \\\"%s\\\" started (pthread id: \" UINTX_FORMAT \", attributes: %s). \",\n+                         thread->name(), (uintx) tid, os::Posix::describe_pthread_attr(buf, sizeof(buf), &attr));\n@@ -828,2 +833,2 @@\n-    log_warning(os, thread)(\"Failed to start thread - pthread_create failed (%d=%s) for attributes: %s.\",\n-      ret, os::errno_name(ret), os::Posix::describe_pthread_attr(buf, sizeof(buf), &attr));\n+    log_warning(os, thread)(\"Failed to start thread \\\"%s\\\" - pthread_create failed (%d=%s) for attributes: %s.\",\n+                            thread->name(), ret, os::errno_name(ret), os::Posix::describe_pthread_attr(buf, sizeof(buf), &attr));\n","filename":"src\/hotspot\/os\/aix\/os_aix.cpp","additions":10,"deletions":5,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -636,0 +636,2 @@\n+\n+    ResourceMark rm;\n@@ -637,1 +639,5 @@\n-    int ret = pthread_create(&tid, &attr, (void* (*)(void*)) thread_native_entry, thread);\n+    int ret = 0;\n+    int limit = 3;\n+    do {\n+      ret = pthread_create(&tid, &attr, (void* (*)(void*)) thread_native_entry, thread);\n+    } while (ret == EAGAIN && limit-- > 0);\n@@ -641,2 +647,2 @@\n-      log_info(os, thread)(\"Thread started (pthread id: \" UINTX_FORMAT \", attributes: %s). \",\n-        (uintx) tid, os::Posix::describe_pthread_attr(buf, sizeof(buf), &attr));\n+      log_info(os, thread)(\"Thread \\\"%s\\\" started (pthread id: \" UINTX_FORMAT \", attributes: %s). \",\n+                           thread->name(), (uintx) tid, os::Posix::describe_pthread_attr(buf, sizeof(buf), &attr));\n@@ -644,2 +650,2 @@\n-      log_warning(os, thread)(\"Failed to start thread - pthread_create failed (%s) for attributes: %s.\",\n-        os::errno_name(ret), os::Posix::describe_pthread_attr(buf, sizeof(buf), &attr));\n+      log_warning(os, thread)(\"Failed to start thread \\\"%s\\\" - pthread_create failed (%s) for attributes: %s.\",\n+                              thread->name(), os::errno_name(ret), os::Posix::describe_pthread_attr(buf, sizeof(buf), &attr));\n","filename":"src\/hotspot\/os\/bsd\/os_bsd.cpp","additions":11,"deletions":5,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -867,0 +867,1 @@\n+    ResourceMark rm;\n@@ -868,1 +869,5 @@\n-    int ret = pthread_create(&tid, &attr, (void* (*)(void*)) thread_native_entry, thread);\n+    int ret = 0;\n+    int limit = 3;\n+    do {\n+      ret = pthread_create(&tid, &attr, (void* (*)(void*)) thread_native_entry, thread);\n+    } while (ret == EAGAIN && limit-- > 0);\n@@ -872,2 +877,2 @@\n-      log_info(os, thread)(\"Thread started (pthread id: \" UINTX_FORMAT \", attributes: %s). \",\n-        (uintx) tid, os::Posix::describe_pthread_attr(buf, sizeof(buf), &attr));\n+      log_info(os, thread)(\"Thread \\\"%s\\\" started (pthread id: \" UINTX_FORMAT \", attributes: %s). \",\n+                           thread->name(), (uintx) tid, os::Posix::describe_pthread_attr(buf, sizeof(buf), &attr));\n@@ -875,2 +880,2 @@\n-      log_warning(os, thread)(\"Failed to start thread - pthread_create failed (%s) for attributes: %s.\",\n-        os::errno_name(ret), os::Posix::describe_pthread_attr(buf, sizeof(buf), &attr));\n+      log_warning(os, thread)(\"Failed to start thread \\\"%s\\\" - pthread_create failed (%s) for attributes: %s.\",\n+                              thread->name(), os::errno_name(ret), os::Posix::describe_pthread_attr(buf, sizeof(buf), &attr));\n","filename":"src\/hotspot\/os\/linux\/os_linux.cpp","additions":10,"deletions":5,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -749,8 +749,13 @@\n-  HANDLE thread_handle =\n-    (HANDLE)_beginthreadex(NULL,\n-                           (unsigned)stack_size,\n-                           (unsigned (__stdcall *)(void*)) thread_native_entry,\n-                           thread,\n-                           initflag,\n-                           &thread_id);\n-\n+  HANDLE thread_handle;\n+  int limit = 3;\n+  do {\n+    thread_handle =\n+      (HANDLE)_beginthreadex(NULL,\n+                             (unsigned)stack_size,\n+                             (unsigned (__stdcall *)(void*)) thread_native_entry,\n+                             thread,\n+                             initflag,\n+                             &thread_id);\n+  } while (thread_handle == NULL && errno == EAGAIN && limit-- > 0);\n+\n+  ResourceMark rm;\n@@ -759,2 +764,3 @@\n-    log_info(os, thread)(\"Thread started (tid: %u, attributes: %s)\",\n-      thread_id, describe_beginthreadex_attributes(buf, sizeof(buf), stack_size, initflag));\n+    log_info(os, thread)(\"Thread \\\"%s\\\" started (tid: %u, attributes: %s)\",\n+                         thread->name(), thread_id,\n+                         describe_beginthreadex_attributes(buf, sizeof(buf), stack_size, initflag));\n@@ -762,2 +768,2 @@\n-    log_warning(os, thread)(\"Failed to start thread - _beginthreadex failed (%s) for attributes: %s.\",\n-      os::errno_name(errno), describe_beginthreadex_attributes(buf, sizeof(buf), stack_size, initflag));\n+    log_warning(os, thread)(\"Failed to start thread \\\"%s\\\" - _beginthreadex failed (%s) for attributes: %s.\",\n+                            thread->name(), os::errno_name(errno), describe_beginthreadex_attributes(buf, sizeof(buf), stack_size, initflag));\n","filename":"src\/hotspot\/os\/windows\/os_windows.cpp","additions":18,"deletions":12,"binary":false,"changes":30,"status":"modified"},{"patch":"@@ -2912,0 +2912,3 @@\n+    ResourceMark rm(thread);\n+    log_warning(os, thread)(\"Failed to start the native thread for java.lang.Thread \\\"%s\\\"\",\n+                            JavaThread::name_for(JNIHandles::resolve_non_null(jthread)));\n","filename":"src\/hotspot\/share\/prims\/jvm.cpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -482,0 +482,7 @@\n+  \/\/ If the target hasn't been started yet then it is trivially\n+  \/\/ \"protected\". We assume the caller is the thread that will do\n+  \/\/ the starting.\n+  if (p->osthread() == NULL || p->osthread()->get_state() <= INITIALIZED) {\n+    return true;\n+  }\n+\n@@ -2193,1 +2200,1 @@\n-\/\/ descriptive string if there is no set name\n+\/\/ descriptive string if there is no set name.\n@@ -2217,0 +2224,13 @@\n+\/\/ Helper to extract the name from the thread oop for logging.\n+const char* JavaThread::name_for(oop thread_obj) {\n+  assert(thread_obj != NULL, \"precondition\");\n+  oop name = java_lang_Thread::name(thread_obj);\n+  const char* name_str;\n+  if (name != NULL) {\n+    name_str = java_lang_String::as_utf8_string(name);\n+  } else {\n+    name_str = \"<un-named>\";\n+  }\n+  return name_str;\n+}\n+\n","filename":"src\/hotspot\/share\/runtime\/thread.cpp","additions":21,"deletions":1,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -1379,0 +1379,1 @@\n+  static const char* name_for(oop thread_obj);\n","filename":"src\/hotspot\/share\/runtime\/thread.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2016, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2016, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -44,1 +44,1 @@\n-        output.shouldContain(\"Thread started\");\n+        output.shouldMatch(\"Thread .* started\");\n","filename":"test\/hotspot\/jtreg\/runtime\/logging\/ThreadLoggingTest.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"}]}