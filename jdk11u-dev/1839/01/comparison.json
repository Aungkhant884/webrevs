{"files":[{"patch":"@@ -651,1 +651,1 @@\n-sun\/security\/tools\/keytool\/NssTest.java                         8295343 linux-all\n+sun\/security\/tools\/keytool\/NssTest.java                         8295343,8204203 linux-all,windows-all\n","filename":"test\/jdk\/ProblemList.txt","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -31,0 +31,1 @@\n+import java.io.InputStream;\n@@ -350,0 +351,16 @@\n+        Path libPath = getNSSLibPath(library);\n+        if (libPath == null) {\n+            return null;\n+        }\n+\n+        String libDir = String.valueOf(libPath.getParent()) + File.separatorChar;\n+        System.out.println(\"nssLibDir: \" + libDir);\n+        System.setProperty(\"pkcs11test.nss.libdir\", libDir);\n+        return libDir;\n+    }\n+\n+    private static Path getNSSLibPath() throws Exception {\n+        return getNSSLibPath(nss_library);\n+    }\n+\n+    static Path getNSSLibPath(String library) throws Exception {\n@@ -361,1 +378,2 @@\n-        String nssLibDir = null;\n+\n+        Path nssLibPath = null;\n@@ -363,5 +381,3 @@\n-            if (new File(dir).exists() &&\n-                new File(dir + System.mapLibraryName(library)).exists()) {\n-                nssLibDir = dir;\n-                System.out.println(\"nssLibDir: \" + nssLibDir);\n-                System.setProperty(\"pkcs11test.nss.libdir\", nssLibDir);\n+            Path libPath = Paths.get(dir).resolve(System.mapLibraryName(library));\n+            if (Files.exists(libPath)) {\n+                nssLibPath = libPath;\n@@ -371,1 +387,1 @@\n-        if (nssLibDir == null) {\n+        if (nssLibPath == null) {\n@@ -375,1 +391,1 @@\n-        return nssLibDir;\n+        return nssLibPath;\n@@ -469,1 +485,1 @@\n-        String libfile = \"\";\n+        Path libfile = null;\n@@ -477,2 +493,2 @@\n-            String libdir = getNSSLibDir();\n-            if (libdir == null) {\n+            libfile = getNSSLibPath();\n+            if (libfile == null) {\n@@ -481,2 +497,1 @@\n-            libfile = libdir + System.mapLibraryName(library);\n-            try (FileInputStream is = new FileInputStream(libfile)) {\n+            try (InputStream is = Files.newInputStream(libfile)) {\n","filename":"test\/jdk\/sun\/security\/pkcs11\/PKCS11Test.java","additions":28,"deletions":13,"binary":false,"changes":41,"status":"modified"},{"patch":"@@ -25,3 +25,1 @@\n- *\n- *\n- * @summary Testing keytool\n+ * @test\n@@ -29,0 +27,1 @@\n+ * @summary Testing keytool\n@@ -57,0 +56,6 @@\n+ *\n+ * @library \/test\/lib\n+ * @modules java.base\/sun.security.tools.keytool\n+ *          java.base\/sun.security.util\n+ *          java.base\/sun.security.x509\n+ * @run main\/othervm\/timeout=600 -Dfile KeyToolTest\n@@ -71,0 +76,1 @@\n+\n","filename":"test\/jdk\/sun\/security\/tools\/keytool\/KeyToolTest.java","additions":9,"deletions":3,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -0,0 +1,63 @@\n+\/*\n+ * Copyright (c) 2018, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+\n+\/*\n+ * @test\n+ * @summary It tests (almost) all keytool behaviors with NSS.\n+ * @library \/test\/lib \/test\/jdk\/sun\/security\/pkcs11\n+ * @modules java.base\/sun.security.tools.keytool\n+ *          java.base\/sun.security.util\n+ *          java.base\/sun.security.x509\n+ * @run main\/othervm\/timeout=600 NssTest\n+ *\/\n+public class NssTest {\n+\n+    public static void main(String[] args) throws Exception {\n+        Path libPath = PKCS11Test.getNSSLibPath(\"softokn3\");\n+        if (libPath == null) {\n+            return;\n+        }\n+        System.out.println(\"Using NSS lib at \" + libPath);\n+\n+        copyFiles();\n+        System.setProperty(\"nss\", \"\");\n+        System.setProperty(\"nss.lib\", String.valueOf(libPath));\n+        KeyToolTest.main(args);\n+    }\n+\n+    private static void copyFiles() throws IOException {\n+        Path srcPath = Paths.get(System.getProperty(\"test.src\"));\n+        Files.copy(srcPath.resolve(\"p11-nss.txt\"), Paths.get(\"p11-nss.txt\"));\n+\n+        Path dbPath = srcPath.getParent().getParent()\n+                .resolve(\"pkcs11\").resolve(\"nss\").resolve(\"db\");\n+        Files.copy(dbPath.resolve(\"cert8.db\"), Paths.get(\"cert8.db\"));\n+        Files.copy(dbPath.resolve(\"key3.db\"), Paths.get(\"key3.db\"));\n+        Files.copy(dbPath.resolve(\"secmod.db\"), Paths.get(\"secmod.db\"));\n+    }\n+}\n","filename":"test\/jdk\/sun\/security\/tools\/keytool\/NssTest.java","additions":63,"deletions":0,"binary":false,"changes":63,"status":"added"},{"patch":"@@ -1,130 +0,0 @@\n-#\n-# Copyright (c) 2006, 2018, Oracle and\/or its affiliates. All rights reserved.\n-# DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n-#\n-# This code is free software; you can redistribute it and\/or modify it\n-# under the terms of the GNU General Public License version 2 only, as\n-# published by the Free Software Foundation.\n-#\n-# This code is distributed in the hope that it will be useful, but WITHOUT\n-# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n-# FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n-# version 2 for more details (a copy is included in the LICENSE file that\n-# accompanied this code).\n-#\n-# You should have received a copy of the GNU General Public License version\n-# 2 along with this work; if not, write to the Free Software Foundation,\n-# Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n-#\n-# Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n-# or visit www.oracle.com if you need additional information or have any\n-# questions.\n-#\n-\n-# @test\n-# @summary (almost) all keytool behaviors\n-# @author Weijun Wang\n-# @library \/test\/lib\n-# @build jdk.test.lib.util.FileUtils\n-# @run shell\/timeout=600 autotest.sh\n-# This test is only executed on several platforms\n-#\n-# set a few environment variables so that the shell-script can run stand-alone\n-# in the source directory\n-if [ \"${TESTSRC}\" = \"\" ] ; then\n-  TESTSRC=\".\"\n-fi\n-if [ \"${TESTCLASSES}\" = \"\" ] ; then\n-  TESTCLASSES=\".\"\n-fi\n-if [ \"${TESTJAVA}\" = \"\" ] ; then\n-  echo \"TESTJAVA not set.  Test cannot execute.\"\n-  echo \"FAILED!!!\"\n-  exit 1\n-fi\n-if [ \"${COMPILEJAVA}\" = \"\" ]; then\n-  COMPILEJAVA=\"${TESTJAVA}\"\n-fi\n-\n-find_one() {\n-  for TARGET_FILE in $@; do\n-    if [ -e \"$TARGET_FILE\" ]; then\n-      echo $TARGET_FILE\n-      return\n-    fi\n-  done\n-}\n-\n-FS=\"\/\"\n-${TESTJAVA}${FS}bin${FS}java -XshowSettings:properties -version 2> allprop\n-cat allprop | grep sun.arch.data.model | grep 32\n-if [ \"$?\" != \"0\" ]; then\n-  B32=false\n-else\n-  B32=true\n-fi\n-\n-# set platform-dependent variables\n-OS=`uname -s`\n-case \"$OS\" in\n-  SunOS )\n-    FS=\"\/\"\n-    LIBNAME=\"\/usr\/lib\/mps\/`isainfo -n`\/libsoftokn3.so\"\n-    ;;\n-  Linux )\n-    if [ $B32 = true ]; then\n-        LIBNAME=`find_one \\\n-            \"\/usr\/lib32\/libsoftokn3.so\" \\\n-            \"\/usr\/lib32\/nss\/libsoftokn3.so\" \\\n-            \"\/usr\/lib\/libsoftokn3.so\" \\\n-            \"\/usr\/lib\/i386-linux-gnu\/nss\/libsoftokn3.so\" \\\n-            \"\/usr\/lib\/nss\/libsoftokn3.so\"`\n-    else\n-        LIBNAME=`find_one \\\n-            \"\/usr\/lib64\/libsoftokn3.so\" \\\n-            \"\/usr\/lib\/x86_64-linux-gnu\/nss\/libsoftokn3.so\" \\\n-            \"\/usr\/lib\/nss\/libsoftokn3.so\"`\n-    fi\n-    ;;\n-  * )\n-    echo \"Will not run test on: ${OS}\"\n-    exit 0;\n-    ;;\n-esac\n-case \"$OS\" in\n-  Windows_* | CYGWIN* )\n-    PS=\";\"\n-    ;;\n-  * )\n-    PS=\":\"\n-    ;;\n-esac\n-\n-if [ \"$LIBNAME\" = \"\" ]; then\n-  echo \"Cannot find libsoftokn3.so\"\n-  exit 0\n-fi\n-\n-echo \"Using NSS lib at $LIBNAME\"\n-\n-EXTRAOPTS=\"--add-exports java.base\/sun.security.tools.keytool=ALL-UNNAMED \\\n- --add-exports java.base\/sun.security.util=ALL-UNNAMED \\\n- --add-exports java.base\/sun.security.x509=ALL-UNNAMED\"\n-${COMPILEJAVA}${FS}bin${FS}javac -classpath ${TESTCLASSPATH} ${TESTJAVACOPTS} ${TESTTOOLVMOPTS} ${EXTRAOPTS} -d . -XDignore.symbol.file \\\n-        ${TESTSRC}${FS}KeyToolTest.java || exit 10\n-\n-NSS=${TESTSRC}${FS}..${FS}..${FS}pkcs11${FS}nss\n-\n-cp ${TESTSRC}${FS}p11-nss.txt .\n-cp ${NSS}${FS}db${FS}cert8.db .\n-cp ${NSS}${FS}db${FS}key3.db .\n-cp ${NSS}${FS}db${FS}secmod.db .\n-\n-chmod u+w key3.db\n-chmod u+w cert8.db\n-echo | ${TESTJAVA}${FS}bin${FS}java -classpath .${PS}${TESTCLASSPATH} ${TESTVMOPTS} ${EXTRAOPTS} -Dnss \\\n-   -Dnss.lib=${LIBNAME} \\\n-   KeyToolTest\n-status=$?\n-\n-exit $status\n","filename":"test\/jdk\/sun\/security\/tools\/keytool\/autotest.sh","additions":0,"deletions":130,"binary":false,"changes":130,"status":"deleted"},{"patch":"@@ -1,81 +0,0 @@\n-#\n-# Copyright (c) 2009, 2018, Oracle and\/or its affiliates. All rights reserved.\n-# DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n-#\n-# This code is free software; you can redistribute it and\/or modify it\n-# under the terms of the GNU General Public License version 2 only, as\n-# published by the Free Software Foundation.\n-#\n-# This code is distributed in the hope that it will be useful, but WITHOUT\n-# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n-# FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n-# version 2 for more details (a copy is included in the LICENSE file that\n-# accompanied this code).\n-#\n-# You should have received a copy of the GNU General Public License version\n-# 2 along with this work; if not, write to the Free Software Foundation,\n-# Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n-#\n-# Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n-# or visit www.oracle.com if you need additional information or have any\n-# questions.\n-#\n-\n-# @test\n-# @summary (almost) all keytool behaviors\n-# @author Weijun Wang\n-# @library \/test\/lib\n-# @build jdk.test.lib.util.FileUtils\n-# @run shell\/timeout=600 standard.sh\n-# @key intermittent\n-\n-# This test is always excecuted.\n-#\n-# set a few environment variables so that the shell-script can run stand-alone\n-# in the source directory\n-if [ \"${TESTSRC}\" = \"\" ] ; then\n-  TESTSRC=\".\"\n-fi\n-if [ \"${TESTCLASSES}\" = \"\" ] ; then\n-  TESTCLASSES=\".\"\n-fi\n-if [ \"${TESTJAVA}\" = \"\" ] ; then\n-  JAVAC_CMD=`which javac`\n-  TESTJAVA=`dirname $JAVAC_CMD`\/..\n-  COMPILEJAVA=\"${TESTJAVA}\"\n-fi\n-\n-# set platform-dependent variables\n-OS=`uname -s`\n-case \"$OS\" in\n-  SunOS | Linux | Darwin | AIX | CYGWIN* )\n-    FS=\"\/\"\n-    ;;\n-  Windows_* )\n-    FS=\"\\\\\"\n-    ;;\n-  * )\n-    echo \"Unrecognized system!\"\n-    exit 1;\n-    ;;\n-esac\n-case \"$OS\" in\n-  Windows_* | CYGWIN* )\n-    PS=\";\"\n-    ;;\n-  * )\n-    PS=\":\"\n-    ;;\n-esac\n-\n-EXTRAOPTS=\"--add-exports java.base\/sun.security.tools.keytool=ALL-UNNAMED \\\n- --add-exports java.base\/sun.security.util=ALL-UNNAMED \\\n- --add-exports java.base\/sun.security.x509=ALL-UNNAMED\"\n-\n-${COMPILEJAVA}${FS}bin${FS}javac -classpath ${TESTCLASSPATH} ${TESTJAVACOPTS} ${TESTTOOLVMOPTS} ${EXTRAOPTS} -d . -XDignore.symbol.file ${TESTSRC}${FS}KeyToolTest.java || exit 10\n-\n-echo | ${TESTJAVA}${FS}bin${FS}java -classpath .${PS}${TESTCLASSPATH} ${TESTVMOPTS} ${EXTRAOPTS} -Dfile KeyToolTest\n-status=$?\n-\n-exit $status\n-\n","filename":"test\/jdk\/sun\/security\/tools\/keytool\/standard.sh","additions":0,"deletions":81,"binary":false,"changes":81,"status":"deleted"}]}