{"files":[{"patch":"@@ -2010,1 +2010,1 @@\n-#ifdef __OpenBSD__\n+#if defined(__OpenBSD__)\n@@ -2016,0 +2016,4 @@\n+#elif defined(__APPLE__)\n+  if (::mprotect(addr, size, prot) == 0) {\n+    return true;\n+  }\n@@ -2094,2 +2098,3 @@\n-bool os::pd_uncommit_memory(char* addr, size_t size) {\n-#ifdef __OpenBSD__\n+MACOS_ONLY(bool os::pd_uncommit_memory(char* addr, size_t size, bool executable))\n+NOT_MACOS(bool os::pd_uncommit_memory(char* addr, size_t size)) {\n+#if defined(__OpenBSD__)\n@@ -2099,0 +2104,11 @@\n+#elif defined(__APPLE__)\n+  if (executable) {\n+    if (::madvise(addr, size, MADV_FREE) != 0) {\n+      return false;\n+    }\n+    return ::mprotect(addr, size, PROT_NONE) == 0;\n+  } else {\n+    uintptr_t res = (uintptr_t) ::mmap(addr, size, PROT_NONE,\n+        MAP_PRIVATE|MAP_FIXED|MAP_NORESERVE|MAP_ANONYMOUS, -1, 0);\n+    return res  != (uintptr_t) MAP_FAILED;\n+  }\n@@ -2122,1 +2138,1 @@\n-static char* anon_mmap(char* requested_addr, size_t bytes, bool fixed) {\n+static char* anon_mmap(char* requested_addr, size_t bytes, bool fixed, bool executable = false) {\n@@ -2127,0 +2143,6 @@\n+#ifdef __APPLE__\n+  if (executable) {\n+    guarantee(!fixed, \"MAP_JIT (for execute) is incompatible with MAP_FIXED\");\n+    flags |= MAP_JIT;\n+  }\n+#endif\n@@ -2145,1 +2167,6 @@\n-char* os::pd_reserve_memory(size_t bytes, char* requested_addr,\n+MACOS_ONLY(char* os::pd_reserve_memory(size_t bytes, char* requested_addr,\n+                            size_t alignment_hint,\n+                            bool executable) {\n+  return anon_mmap(requested_addr, bytes, (requested_addr != NULL), executable);\n+})\n+NOT_MACOS(char* os::pd_reserve_memory(size_t bytes, char* requested_addr,\n@@ -2148,1 +2175,1 @@\n-}\n+})\n","filename":"src\/hotspot\/os\/bsd\/os_bsd.cpp","additions":33,"deletions":6,"binary":false,"changes":39,"status":"modified"},{"patch":"@@ -199,1 +199,2 @@\n-      base = os::reserve_memory(size, NULL, alignment, _fd_for_heap);\n+      base = MACOS_ONLY(os::reserve_memory(size, NULL, alignment, _fd_for_heap, _executable))\n+             NOT_MACOS(os::reserve_memory(size, NULL, alignment, _fd_for_heap));\n@@ -993,1 +994,2 @@\n-    if (!os::uncommit_memory(aligned_upper_new_high, upper_needs)) {\n+    if (MACOS_ONLY(!os::uncommit_memory(aligned_upper_new_high, upper_needs, _executable))\n+        NOT_MACOS(!os::uncommit_memory(aligned_upper_new_high, upper_needs))) {\n@@ -1004,1 +1006,2 @@\n-    if (!os::uncommit_memory(aligned_middle_new_high, middle_needs)) {\n+    if (MACOS_ONLY(!os::uncommit_memory(aligned_middle_new_high, middle_needs, _executable))\n+        NOT_MACOS(!os::uncommit_memory(aligned_middle_new_high, middle_needs))) {\n@@ -1015,1 +1018,2 @@\n-    if (!os::uncommit_memory(aligned_lower_new_high, lower_needs)) {\n+    if (MACOS_ONLY(!os::uncommit_memory(aligned_lower_new_high, lower_needs, _executable))\n+        NOT_MACOS(!os::uncommit_memory(aligned_lower_new_high, lower_needs))) {\n","filename":"src\/hotspot\/share\/memory\/virtualspace.cpp","additions":8,"deletions":4,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -1740,1 +1740,2 @@\n-char* os::reserve_memory(size_t bytes, char* addr, size_t alignment_hint, int file_desc) {\n+MACOS_ONLY(char* os::reserve_memory(size_t bytes, char* addr, size_t alignment_hint, int file_desc, bool executable))\n+NOT_MACOS(char* os::reserve_memory(size_t bytes, char* addr, size_t alignment_hint, int file_desc)) {\n@@ -1751,1 +1752,2 @@\n-    result = pd_reserve_memory(bytes, addr, alignment_hint);\n+    result = MACOS_ONLY(pd_reserve_memory(bytes, addr, alignment_hint, executable))\n+             NOT_MACOS(pd_reserve_memory(bytes, addr, alignment_hint));\n@@ -1821,1 +1823,2 @@\n-bool os::uncommit_memory(char* addr, size_t bytes) {\n+MACOS_ONLY(bool os::uncommit_memory(char* addr, size_t bytes, bool executable))\n+NOT_MACOS(bool os::uncommit_memory(char* addr, size_t bytes)) {\n@@ -1825,1 +1828,2 @@\n-    res = pd_uncommit_memory(addr, bytes);\n+    res = MACOS_ONLY(pd_uncommit_memory(addr, bytes, executable))\n+          NOT_MACOS(pd_uncommit_memory(addr, bytes));\n@@ -1830,1 +1834,2 @@\n-    res = pd_uncommit_memory(addr, bytes);\n+    res = MACOS_ONLY(pd_uncommit_memory(addr, bytes, executable))\n+          NOT_MACOS(pd_uncommit_memory(addr, bytes));\n","filename":"src\/hotspot\/share\/runtime\/os.cpp","additions":10,"deletions":5,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -114,2 +114,6 @@\n-  static char*  pd_reserve_memory(size_t bytes, char* addr = 0,\n-                                  size_t alignment_hint = 0);\n+\n+  MACOS_ONLY(static char*  pd_reserve_memory(size_t bytes, char* addr = 0,\n+                                             size_t alignment_hint = 0,\n+                                             bool executable = false);)\n+  NOT_MACOS(static char*  pd_reserve_memory(size_t bytes, char* addr = 0,\n+                                            size_t alignment_hint = 0);)\n@@ -130,1 +134,3 @@\n-  static bool   pd_uncommit_memory(char* addr, size_t bytes);\n+  MACOS_ONLY(static bool   pd_uncommit_memory(char* addr, size_t bytes,\n+                                              bool executable = false);)\n+  NOT_MACOS(static bool   pd_uncommit_memory(char* addr, size_t bytes);)\n@@ -328,2 +334,5 @@\n-  static char*  reserve_memory(size_t bytes, char* addr = 0,\n-                               size_t alignment_hint = 0, int file_desc = -1);\n+  MACOS_ONLY(static char*  reserve_memory(size_t bytes, char* addr = 0,\n+                                          size_t alignment_hint = 0, int file_desc = -1,\n+                                          bool executable = false);)\n+  NOT_MACOS(static char*  reserve_memory(size_t bytes, char* addr = 0,\n+                                         size_t alignment_hint = 0, int file_desc = -1);)\n@@ -346,1 +355,2 @@\n-  static bool   uncommit_memory(char* addr, size_t bytes);\n+  MACOS_ONLY(static bool   uncommit_memory(char* addr, size_t bytes, bool executable = false);)\n+  NOT_MACOS(static bool   uncommit_memory(char* addr, size_t bytes);)\n","filename":"src\/hotspot\/share\/runtime\/os.hpp","additions":16,"deletions":6,"binary":false,"changes":22,"status":"modified"}]}