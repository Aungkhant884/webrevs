{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2002, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2002, 2019, Oracle and\/or its affiliates. All rights reserved.\n@@ -34,5 +34,4 @@\n-        int localPort;\n-        new Thread(new Redirect()).start();\n-        while ((localPort = Redirect.listenPort) == -1) {\n-            Thread.sleep(1000);\n-        }\n+        try (Redirect server = new Redirect(new ServerSocket())) {\n+            ServerSocket ss = server.ssock;\n+            ss.bind(new InetSocketAddress(InetAddress.getLoopbackAddress(), 0));\n+            new Thread(server).start();\n@@ -40,6 +39,9 @@\n-        String page = \"http:\/\/localhost:\"+localPort+\"\/\";\n-        URL url = new URL(page);\n-        HttpURLConnection conn = (HttpURLConnection)url.openConnection();\n-        conn.connect();\n-        if (conn.getResponseCode() != 302) {\n-            throw new RuntimeException(\"Test failed. Should get RespCode: 302. Got:\"+conn.getResponseCode());\n+            URL url = new URL(\"http\", ss.getInetAddress().getHostAddress(), ss.getLocalPort(), \"\/\");\n+            String page = url.toString();\n+            HttpURLConnection conn = (HttpURLConnection) url.openConnection();\n+            conn.connect();\n+            if (conn.getResponseCode() != 302) {\n+                System.err.println(\"Bad response code received from: \" + page);\n+                throw new RuntimeException(\"Test failed. Should get RespCode: 302. Got:\" + conn.getResponseCode());\n+            }\n+            System.out.println(\"Received expected response code from: \" + page);\n@@ -50,2 +52,6 @@\n-class Redirect implements Runnable {\n-    public static int listenPort = -1; \/\/ port to listen for connections on\n+class Redirect implements Runnable, Closeable {\n+    final ServerSocket ssock;\n+    volatile boolean stopped;\n+    Redirect(ServerSocket ss) {\n+        ssock = ss;\n+    }\n@@ -64,1 +70,1 @@\n-    Socket sock;\n+    volatile Socket sock;\n@@ -67,5 +73,2 @@\n-            ServerSocket ssock = new ServerSocket();\n-            ssock.bind(null);\n-            listenPort = ssock.getLocalPort();\n-            sock = ssock.accept();\n-            sock.setTcpNoDelay(true);\n+            Socket s = sock = ssock.accept();\n+            s.setTcpNoDelay(true);\n@@ -73,3 +76,19 @@\n-            sock.shutdownOutput();\n-        } catch(IOException io) {\n-            throw new RuntimeException(io.getCause());\n+            s.shutdownOutput();\n+        } catch(Throwable t) {\n+            if (!stopped) {\n+                t.printStackTrace();\n+                throw new RuntimeException(String.valueOf(t), t);\n+            }\n+        }\n+    }\n+\n+    public void close() {\n+        Socket s = sock;\n+        boolean done = stopped;\n+        if (done) return;\n+        stopped = true;\n+        try {\n+            if (s != null) s.close();\n+        } catch (Throwable x) {\n+        } finally {\n+            try { ssock.close(); } catch (Throwable x) {}\n","filename":"test\/jdk\/sun\/net\/www\/protocol\/http\/ProtocolRedirect.java","additions":42,"deletions":23,"binary":false,"changes":65,"status":"modified"}]}