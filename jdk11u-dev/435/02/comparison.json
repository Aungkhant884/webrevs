{"files":[{"patch":"@@ -123,1 +123,1 @@\n-void ciMethodData::load_extra_data() {\n+void ciMethodData::load_remaining_extra_data() {\n@@ -132,0 +132,8 @@\n+  assert((mdo->data_size() == _data_size) && (mdo->extra_data_size() == _extra_data_size), \"sanity, unchanged\");\n+  assert(extra_data_base() == (DataLayout*)((address) _data + _data_size), \"sanity\");\n+\n+  \/\/ Copy the extra data once it is prepared (i.e. cache populated, no release of extra data lock anymore)\n+  Copy::disjoint_words_atomic((HeapWord*) mdo->extra_data_base(),\n+                              (HeapWord*)((address) _data + _data_size),\n+                              (_extra_data_size - mdo->parameters_size_in_bytes()) \/ HeapWordSize);\n+\n@@ -140,5 +148,0 @@\n-    \/\/ New traps in the MDO may have been added since we copied the\n-    \/\/ data (concurrent deoptimizations before we acquired\n-    \/\/ extra_data_lock above) or can be removed (a safepoint may occur\n-    \/\/ in the prepare_metadata call above) as we translate the copy:\n-    \/\/ update the copy as we go.\n@@ -146,7 +149,0 @@\n-    size_t entry_size = DataLayout::header_size_in_bytes();\n-    if (tag != DataLayout::no_tag) {\n-      ProfileData* src_data = dp_src->data_in();\n-      entry_size = src_data->size_in_bytes();\n-    }\n-    memcpy(dp_dst, dp_src, entry_size);\n-\n@@ -183,3 +179,25 @@\n-  \/\/ Snapshot the data -- actually, take an approximate snapshot of\n-  \/\/ the data.  Any concurrently executing threads may be changing the\n-  \/\/ data as we copy it.\n+  \/\/ Snapshot the data and extra parameter data first without the extra trap and arg info data.\n+  \/\/ Those are copied in a second step. Actually, an approximate snapshot of the data is taken.\n+  \/\/ Any concurrently executing threads may be changing the data as we copy it.\n+  \/\/\n+  \/\/ The first snapshot step requires two copies (data entries and parameter data entries) since\n+  \/\/ the MDO is laid out as follows:\n+  \/\/\n+  \/\/  data_base:        ---------------------------\n+  \/\/                    |       data entries      |\n+  \/\/                    |           ...           |\n+  \/\/  extra_data_base:  ---------------------------\n+  \/\/                    |    trap data entries    |\n+  \/\/                    |           ...           |\n+  \/\/                    | one arg info data entry |\n+  \/\/                    |    data for each arg    |\n+  \/\/                    |           ...           |\n+  \/\/  args_data_limit:  ---------------------------\n+  \/\/                    |  parameter data entries |\n+  \/\/                    |           ...           |\n+  \/\/  extra_data_limit: ---------------------------\n+  \/\/\n+  \/\/ _data_size = extra_data_base - data_base\n+  \/\/ _extra_data_size = extra_data_limit - extra_data_base\n+  \/\/ total_size = _data_size + _extra_data_size\n+  \/\/ args_data_limit = data_base + total_size - parameter_data_size\n@@ -197,1 +215,1 @@\n-                              total_size \/ HeapWordSize);\n+                              _data_size \/ HeapWordSize);\n@@ -199,0 +217,7 @@\n+  int parameters_data_size = mdo->parameters_size_in_bytes();\n+  if (parameters_data_size > 0) {\n+    \/\/ Snapshot the parameter data\n+    Copy::disjoint_words_atomic((HeapWord*) mdo->args_data_limit(),\n+                                (HeapWord*) ((address)_data + total_size - parameters_data_size),\n+                                parameters_data_size \/ HeapWordSize);\n+  }\n@@ -215,1 +240,3 @@\n-  load_extra_data();\n+  assert((DataLayout*) ((address)_data + total_size - parameters_data_size) == args_data_limit(),\n+      \"sanity - parameter data starts after the argument data of the single ArgInfoData entry\");\n+  load_remaining_extra_data();\n@@ -327,1 +354,1 @@\n-      return NULL; \/\/ ArgInfoData is at the end of extra data section.\n+      return NULL; \/\/ ArgInfoData is after the trap data right before the parameter data.\n@@ -738,1 +765,1 @@\n-      dp = end; \/\/ ArgInfoData is at the end of extra data section.\n+      dp = end; \/\/ ArgInfoData is after the trap data right before the parameter data.\n","filename":"src\/hotspot\/share\/ci\/ciMethodData.cpp","additions":47,"deletions":20,"binary":false,"changes":67,"status":"modified"},{"patch":"@@ -477,1 +477,1 @@\n-  void load_extra_data();\n+  void load_remaining_extra_data();\n","filename":"src\/hotspot\/share\/ci\/ciMethodData.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -2111,4 +2111,0 @@\n-  int parameters_size_in_bytes() const {\n-    ParametersTypeData* param = parameters_type_data();\n-    return param == NULL ? 0 : param->size_in_bytes();\n-  }\n@@ -2325,0 +2321,5 @@\n+  int parameters_size_in_bytes() const {\n+    ParametersTypeData* param = parameters_type_data();\n+    return param == NULL ? 0 : param->size_in_bytes();\n+  }\n+\n","filename":"src\/hotspot\/share\/oops\/methodData.hpp","additions":5,"deletions":4,"binary":false,"changes":9,"status":"modified"}]}