{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2016, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2016, 2019, Oracle and\/or its affiliates. All rights reserved.\n@@ -35,0 +35,1 @@\n+import java.util.ArrayList;\n@@ -87,1 +88,3 @@\n-            writeJar(args[1], null, args, 2, args.length);\n+            String jarFile = args[1];\n+            String[] classes = addInnerClasses(args, 2);\n+            writeJar_impl(jarFile, null, classes);\n@@ -92,2 +95,3 @@\n-            for (String arg : args) {\n-                writeClassToDisk(arg);\n+            String[] classes = addInnerClasses(args, 0);\n+            for (String cls : classes) {\n+                writeClassToDisk(cls);\n@@ -98,0 +102,27 @@\n+    \/\/ Add commonly used inner classes that are often omitted by mistake. Currently\n+    \/\/ we support only sun.hotspot.WhiteBox$WhiteBoxPermission. See JDK-8199290\n+    private static String[] addInnerClasses(String[] classes, int startIdx) {\n+        boolean seenWB = false;\n+        boolean seenWBInner = false;\n+        final String wb = \"sun.hotspot.WhiteBox\";\n+        final String wbInner = \"sun.hotspot.WhiteBox$WhiteBoxPermission\";\n+\n+        ArrayList<String> list = new ArrayList<>();\n+\n+        for (int i = startIdx; i < classes.length; i++) {\n+            String cls = classes[i];\n+            list.add(cls);\n+            switch (cls) {\n+            case wb:      seenWB      = true; break;\n+            case wbInner: seenWBInner = true; break;\n+            }\n+        }\n+        if (seenWB && !seenWBInner) {\n+            list.add(wbInner);\n+        }\n+\n+        String[] array = new String[list.size()];\n+        list.toArray(array);\n+        return array;\n+    }\n+\n@@ -125,1 +156,1 @@\n-    private static void writeJar(String jarFile, Manifest manifest, String classes[], int from, int to) throws Exception {\n+    private static void writeJar_impl(String jarFile, Manifest manifest, String classes[]) throws Exception {\n@@ -140,2 +171,2 @@\n-        for (int i=from; i<to; i++) {\n-            writeClassToDisk(zos, classes[i]);\n+        for (String cls : classes) {\n+            writeClassToDisk(zos, cls);\n@@ -160,1 +191,2 @@\n-        writeJar(jarFile, null, classes, 0, classes.length);\n+        classes = addInnerClasses(classes, 0);\n+        writeJar_impl(jarFile, null, classes);\n@@ -165,1 +197,2 @@\n-        writeJar(jarFile, manifest, classes, 0, classes.length);\n+        classes = addInnerClasses(classes, 0);\n+        writeJar_impl(jarFile, manifest, classes);\n","filename":"test\/lib\/ClassFileInstaller.java","additions":42,"deletions":9,"binary":false,"changes":51,"status":"modified"}]}