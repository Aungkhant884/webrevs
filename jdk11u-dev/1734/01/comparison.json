{"files":[{"patch":"@@ -51,8 +51,7 @@\n-        InputStream     in;\n-        OutputStream out;\n-        Socket  sock;\n-        StringBuffer response;\n-        ServerSocket server;\n-\n-        Server (ServerSocket s) throws IOException\n-        {\n+        private InputStream in;\n+        private OutputStream out;\n+        private Socket sock;\n+        private StringBuffer response;\n+        private ServerSocket server;\n+\n+        Server(ServerSocket s) throws IOException {\n@@ -62,4 +61,3 @@\n-        void waitFor (String s) throws IOException\n-        {\n-            byte[] w = s.getBytes ();\n-            for(int c=0; c<w.length; c++ ) {\n+        void waitFor(String s) throws IOException {\n+            byte[] w = s.getBytes();\n+            for (int c = 0; c < w.length; c++) {\n@@ -69,1 +67,1 @@\n-                    acceptConn ();\n+                    acceptConn();\n@@ -77,1 +75,1 @@\n-        boolean done = false;\n+        private boolean done = false;\n@@ -79,1 +77,1 @@\n-        public synchronized boolean finished () {\n+        public synchronized boolean finished() {\n@@ -83,1 +81,1 @@\n-        public synchronized void setFinished (boolean b) {\n+        public synchronized void setFinished(boolean b) throws IOException {\n@@ -85,0 +83,8 @@\n+            this.closeConn();\n+            server.close();\n+        }\n+\n+        void acceptConn() throws IOException {\n+            sock = server.accept();\n+            in = sock.getInputStream();\n+            out = sock.getOutputStream();\n@@ -87,5 +93,4 @@\n-        void acceptConn () throws IOException\n-        {\n-            sock = server.accept ();\n-            in = sock.getInputStream ();\n-            out = sock.getOutputStream ();\n+        void closeConn() throws IOException {\n+            in.close();\n+            out.close();\n+            sock.close();\n@@ -94,1 +99,1 @@\n-        public void run () {\n+        public void run() {\n@@ -96,13 +101,14 @@\n-                response = new StringBuffer (1024);\n-                acceptConn ();\n-                waitFor (\"POST\");\n-                waitFor (\"ZZZ\");\n-                Thread.sleep (500);\n-                sock.close ();\n-                acceptConn ();\n-                waitFor (\"POST\");\n-                waitFor (\"ZZZ\");\n-                response.append (\"HTTP\/1.1 200 OK\\r\\n\");\n-                response.append (\"Server: Microsoft-IIS\/5.0\");\n-                response.append (\"Date: Wed, 26 Jul 2000 14:17:04 GMT\\r\\n\\r\\n\");\n-                out.write (response.toString().getBytes());\n+                response = new StringBuffer(1024);\n+                acceptConn();\n+                waitFor(\"POST\");\n+                waitFor(\"ZZZ\");\n+                Thread.sleep(500);\n+                sock.close();\n+                acceptConn();\n+                waitFor(\"POST\");\n+                waitFor(\"ZZZ\");\n+                response.append(\"HTTP\/1.1 200 OK\\r\\n\");\n+                response.append(\"Server: Microsoft-IIS\/5.0\");\n+                response.append(\"Date: Wed, 26 Jul 2000 14:17:04 GMT\\r\\n\\r\\n\");\n+                out.write(response.toString().getBytes());\n+                out.flush();\n@@ -110,1 +116,1 @@\n-                    Thread.sleep (1000);\n+                    Thread.sleep(1000);\n@@ -112,1 +118,0 @@\n-                out.close();\n@@ -114,1 +119,3 @@\n-                System.err.println (\"Server Exception: \" + e);\n+                if (!done) {\n+                    System.err.println(\"Server Exception: \" + e);\n+                }\n@@ -116,1 +123,7 @@\n-                try { server.close(); } catch (IOException unused) {}\n+                try {\n+                    closeConn();\n+                } catch (IOException ioe) {\n+                    if (!done) {\n+                        ioe.printStackTrace();\n+                    }\n+                }\n@@ -121,2 +134,2 @@\n-    ServerSocket ss;\n-    Server server;\n+    private ServerSocket ss;\n+    private Server server;\n@@ -125,10 +138,4 @@\n-        try {\n-            if (args.length == 1 && args[0].equals (\"-i\")) {\n-                System.out.println (\"Press return when ready\");\n-                System.in.read ();\n-                System.out.println (\"Done\");\n-            }\n-            ResendPostBody t = new ResendPostBody ();\n-            t. execute ();\n-        } catch (IOException  e) {\n-            System.out.println (\"IOException\");\n+        if (args.length == 1 && args[0].equals(\"-i\")) {\n+            System.out.println(\"Press return when ready\");\n+            System.in.read();\n+            System.out.println(\"Done\");\n@@ -136,0 +143,2 @@\n+        ResendPostBody t = new ResendPostBody();\n+        t.execute();\n@@ -138,2 +147,1 @@\n-    public void execute () throws Exception {\n-\n+    public void execute() throws Exception {\n@@ -143,2 +151,3 @@\n-        server = new Server (ss);\n-        server.start ();\n+        server = new Server(ss);\n+        server.start();\n+\n@@ -149,1 +158,1 @@\n-        HttpURLConnection conURL =  (HttpURLConnection)url.openConnection();\n+        HttpURLConnection conURL = (HttpURLConnection) url.openConnection(Proxy.NO_PROXY);\n@@ -156,1 +165,1 @@\n-        conURL.setRequestProperty(\"Content-Length\", \"\"+b.length);\n+        conURL.setRequestProperty(\"Content-Length\", \"\" + b.length);\n@@ -160,1 +169,0 @@\n-\n@@ -162,1 +170,1 @@\n-                          OutStream.write(b, 0, b.length);\n+        OutStream.write(b, 0, b.length);\n@@ -167,0 +175,1 @@\n+        int resp = conURL.getResponseCode();\n@@ -168,2 +177,2 @@\n-        int resp = conURL.getResponseCode ();\n-        server.setFinished (true);\n+        server.setFinished(true);    \/\/ Set finished and close ServerSocket\n+        server.join();            \/\/ Join server thread\n@@ -172,2 +181,2 @@\n-            throw new RuntimeException (\"Response code was not 200: \" + resp);\n-  }\n+            throw new RuntimeException(\"Response code was not 200: \" + resp);\n+    }\n","filename":"test\/jdk\/java\/net\/URLConnection\/ResendPostBody.java","additions":72,"deletions":63,"binary":false,"changes":135,"status":"modified"}]}