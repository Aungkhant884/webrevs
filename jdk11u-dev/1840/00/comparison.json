{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2016, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2016, 2018, Oracle and\/or its affiliates. All rights reserved.\n@@ -33,1 +33,0 @@\n-import java.io.IOException;\n@@ -47,13 +46,13 @@\n-        for (int i = 0; i < 3; i++) {\n-            try {\n-                InputStream stream = url.openStream();\n-            } catch (FileNotFoundException expectedFirstTimeAround) {\n-                \/\/ should always reach this point since the path does not exist\n-            } catch (IOException expected) {\n-                System.out.println(\"caught expected \" + expected);\n-                int times = 1;\n-                do {\n-                    \/\/ give some time to close the connection...\n-                    System.out.println(\"sleeping... \" + times);\n-                    Thread.sleep(times * 1000);\n-                } while (server.activeClientsCount() > 0 && times++ < 5);\n+        try (server) {\n+            for (int i = 0; i < 3; i++) {\n+                try {\n+                    InputStream stream = url.openStream();\n+                } catch (FileNotFoundException expected) {\n+                    \/\/ should always reach this point since the path does not exist\n+                    System.out.println(\"caught expected \" + expected);\n+                    int times = 1;\n+                    do {\n+                        \/\/ give some time to close the connection...\n+                        System.out.println(\"sleeping... \" + times);\n+                        Thread.sleep(times * 1000);\n+                    } while (server.activeClientsCount() > 0 && times++ < 5);\n@@ -61,4 +60,5 @@\n-                if (server.activeClientsCount() > 0) {\n-                    server.killClients();\n-                    throw new RuntimeException(\"URLConnection didn't close the\" +\n-                            \" FTP connection on FileNotFoundException\");\n+                    if (server.activeClientsCount() > 0) {\n+                        server.killClients();\n+                        throw new RuntimeException(\"URLConnection didn't close the\" +\n+                                \" FTP connection on FileNotFoundException\");\n+                    }\n@@ -66,2 +66,0 @@\n-            } finally {\n-                server.terminate();\n","filename":"test\/jdk\/sun\/net\/ftp\/FtpURLConnectionLeak.java","additions":19,"deletions":21,"binary":false,"changes":40,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2006, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2006, 2018, Oracle and\/or its affiliates. All rights reserved.\n@@ -445,0 +445,6 @@\n+            \/\/ Below corrupted message style was intentional to test 8151586, please\n+            \/\/ make sure each message line not broken ftp communication (such as for\n+            \/\/ message line lenght >=4, the 4th char required '-' to allow\n+            \/\/ implementation thinks that it has seen multi-line reply '###-'\n+            \/\/ sequence), otherwise it will affect normal ftp tests which depends\n+            \/\/ on this.\n@@ -446,1 +452,1 @@\n-                    + \" (j2se 6.0) ready.\\n \\n                Please send commands\\n\"\n+                    + \" (j2se 6.0) ready.\\n \\n   -            Please send commands\\n\"\n","filename":"test\/jdk\/sun\/net\/www\/ftptest\/FtpCommandHandler.java","additions":8,"deletions":2,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2006, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2006, 2018, Oracle and\/or its affiliates. All rights reserved.\n@@ -50,1 +50,1 @@\n-public class FtpServer extends Thread {\n+public class FtpServer extends Thread implements AutoCloseable {\n@@ -137,0 +137,9 @@\n+\n+    @Override\n+    public void close() throws Exception {\n+        terminate();\n+        listener.close();\n+        if (activeClientsCount() > 0) {\n+            killClients();\n+        }\n+    }\n","filename":"test\/jdk\/sun\/net\/www\/ftptest\/FtpServer.java","additions":11,"deletions":2,"binary":false,"changes":13,"status":"modified"}]}