{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2012, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2012, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -97,0 +97,1 @@\n+#include \"os_linux.hpp\"\n@@ -2029,0 +2030,12 @@\n+\/\/ Physical memory of the host machine (including containers)\n+WB_ENTRY(jlong, WB_HostPhysicalMemory(JNIEnv* env, jobject o))\n+  LINUX_ONLY(return os::Linux::physical_memory();)\n+  return os::physical_memory();\n+WB_END\n+\n+\/\/ Physical swap of the host machine (including containers), Linux only.\n+WB_ENTRY(jlong, WB_HostPhysicalSwap(JNIEnv* env, jobject o))\n+  LINUX_ONLY(return (jlong)os::Linux::host_swap();)\n+  return -1; \/\/ Not used\/implemented on other platforms\n+WB_END\n+\n@@ -2308,0 +2321,2 @@\n+  {CC\"hostPhysicalMemory\",        CC\"()J\",            (void*)&WB_HostPhysicalMemory },\n+  {CC\"hostPhysicalSwap\",          CC\"()J\",            (void*)&WB_HostPhysicalSwap },\n","filename":"src\/hotspot\/share\/prims\/whitebox.cpp","additions":16,"deletions":1,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2017, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2017, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -38,1 +38,1 @@\n- * @run driver TestMemoryAwareness\n+ * @run main\/othervm -Xbootclasspath\/a:whitebox.jar -XX:+UnlockDiagnosticVMOptions -XX:+WhiteBoxAPI TestMemoryAwareness\n@@ -43,0 +43,1 @@\n+import sun.hotspot.WhiteBox;\n@@ -49,0 +50,1 @@\n+    private static final WhiteBox wb = WhiteBox.getWhiteBox();\n@@ -50,5 +52,6 @@\n-    private static String getHostMaxMemory() throws Exception {\n-        DockerRunOptions opts = Common.newOpts(imageName);\n-        String goodMem = Common.run(opts).firstMatch(\"total physical memory: (\\\\d+)\", 1);\n-        assertNotNull(goodMem, \"no match for 'total physical memory' in trace output\");\n-        return goodMem;\n+    private static String getHostMaxMemory() {\n+        return Long.valueOf(wb.hostPhysicalMemory()).toString();\n+    }\n+\n+    private static String getHostSwap() {\n+        return Long.valueOf(wb.hostPhysicalSwap()).toString();\n@@ -95,4 +98,3 @@\n-            final String hostMaxMem = getHostMaxMemory();\n-            testOperatingSystemMXBeanIgnoresMemLimitExceedingPhysicalMemory(hostMaxMem);\n-            testMetricsIgnoresMemLimitExceedingPhysicalMemory(hostMaxMem);\n-            testContainerMemExceedsPhysical(hostMaxMem);\n+            testOSMXBeanIgnoresMemLimitExceedingPhysicalMemory();\n+            testMetricsExceedingPhysicalMemory();\n+            testContainerMemExceedsPhysical();\n@@ -125,1 +127,1 @@\n-    private static void testContainerMemExceedsPhysical(final String hostMaxMem)\n+    private static void testContainerMemExceedsPhysical()\n@@ -128,0 +130,1 @@\n+        String hostMaxMem = getHostMaxMemory();\n@@ -207,2 +210,6 @@\n-        \/\/ the getTotalSwapSpaceSize and getFreeSwapSpaceSize return the system\n-        \/\/ values as the container setup isn't supported in that case.\n+        \/\/ the getTotalSwapSpaceSize either returns the system (or host) values, or 0\n+        \/\/ if a container memory limit is in place and gets detected. A value of 0 is because,\n+        \/\/ Metrics.getMemoryLimit() returns the same value as Metrics.getMemoryAndSwapLimit().\n+        \/\/\n+        \/\/ getFreeSwapSpaceSize() are a function of what getTotalSwapSpaceSize() returns. Either\n+        \/\/ a number > 0, or 0 if getTotalSwapSpaceSize() == 0.\n@@ -212,1 +219,2 @@\n-            out.shouldMatch(\"OperatingSystemMXBean.getTotalSwapSpaceSize: [0-9]+\");\n+            String hostSwap = getHostSwap();\n+            out.shouldMatch(\"OperatingSystemMXBean.getTotalSwapSpaceSize: (0|\" + hostSwap + \")\");\n@@ -223,1 +231,1 @@\n-    private static void testOperatingSystemMXBeanIgnoresMemLimitExceedingPhysicalMemory(final String hostMaxMem)\n+    private static void testOSMXBeanIgnoresMemLimitExceedingPhysicalMemory()\n@@ -225,0 +233,1 @@\n+        String hostMaxMem = getHostMaxMemory();\n@@ -230,1 +239,1 @@\n-    private static void testMetricsIgnoresMemLimitExceedingPhysicalMemory(final String hostMaxMem)\n+    private static void testMetricsExceedingPhysicalMemory()\n@@ -233,1 +242,1 @@\n-        String badMem = hostMaxMem + \"0\";\n+        String badMem = getHostMaxMemory() + \"0\";\n","filename":"test\/hotspot\/jtreg\/containers\/docker\/TestMemoryAwareness.java","additions":27,"deletions":18,"binary":false,"changes":45,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2012, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2012, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -545,0 +545,2 @@\n+  public native long hostPhysicalMemory();\n+  public native long hostPhysicalSwap();\n","filename":"test\/lib\/sun\/hotspot\/WhiteBox.java","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"}]}