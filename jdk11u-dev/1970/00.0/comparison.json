{"files":[{"patch":"@@ -72,1 +72,1 @@\n-        \/\/ Each KeyStore.TrustedCertificateEntry have 2 attributes:\n+        \/\/ Each KeyStore.TrustedCertificateEntry has 2 attributes:\n@@ -699,1 +699,0 @@\n-                Certificate certElem;\n@@ -851,0 +850,19 @@\n+            \/\/ Check whether a certificate with same alias already exists and is the same\n+            \/\/ If yes, we can return here - the existing entry must have the same\n+            \/\/ properties and trust settings\n+            if (entries.contains(alias.toLowerCase())) {\n+                int uniqueVal = 1;\n+                String originalAlias = alias;\n+                var co = entries.get(alias.toLowerCase());\n+                while (co != null) {\n+                    if (co instanceof TrustedCertEntry) {\n+                        var tco = (TrustedCertEntry)co;\n+                        if (tco.cert.equals(tce.cert)) {\n+                            return;\n+                        }\n+                    }\n+                    alias = originalAlias + \" \" + uniqueVal++;\n+                    co = entries.get(alias.toLowerCase());\n+                }\n+            }\n+\n@@ -852,1 +870,1 @@\n-            Map<String,String> tmpMap = new LinkedHashMap<>();\n+            Map<String, String> tmpMap = new LinkedHashMap<>();\n@@ -875,0 +893,1 @@\n+\n@@ -877,1 +896,1 @@\n-                    \/\/ If a self-signed certificate has an empty trust settings,\n+                    \/\/ If a self-signed certificate has trust settings without specific entries,\n@@ -890,1 +909,2 @@\n-                    \/\/ 1 = kSecTrustSettingsResultTrustRoot, 2 = kSecTrustSettingsResultTrustAsRoot\n+                    \/\/ 1 = kSecTrustSettingsResultTrustRoot, 2 = kSecTrustSettingsResultTrustAsRoot,\n+                    \/\/ 3 = kSecTrustSettingsResultDeny\n@@ -892,1 +912,1 @@\n-                    \/\/ for self-signed certificates (see doc for SecTrustSettingsCopyTrustSettings).\n+                    \/\/ (see doc for SecTrustSettingsCopyTrustSettings).\n@@ -895,0 +915,7 @@\n+\n+                    \/\/ If we find explicit distrust in some record, we ignore the certificate\n+                    if (\"3\".equals(result)) {\n+                        return;\n+                    }\n+\n+                    \/\/ Trust, if explicitly trusted or result is null and certificate is self signed\n@@ -914,0 +941,1 @@\n+\n@@ -920,8 +948,0 @@\n-            int uniqueVal = 1;\n-            String originalAlias = alias;\n-\n-            while (entries.containsKey(alias.toLowerCase())) {\n-                alias = originalAlias + \" \" + uniqueVal;\n-                uniqueVal++;\n-            }\n-\n","filename":"src\/java.base\/macosx\/classes\/apple\/security\/KeychainStore.java","additions":34,"deletions":14,"binary":false,"changes":48,"status":"modified"}]}