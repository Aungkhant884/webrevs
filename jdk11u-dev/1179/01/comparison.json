{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1998, 2018, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1998, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -492,3 +492,6 @@\n-\/\/ Select a nice fellow from the worklist to schedule next. If there is only\n-\/\/ one choice, then use it. Projections take top priority for correctness\n-\/\/ reasons - if I see a projection, then it is next.  There are a number of\n+\/\/ Select a nice fellow from the worklist to schedule next. If there is only one\n+\/\/ choice, then use it. CreateEx nodes that are initially ready must start their\n+\/\/ blocks and are given the highest priority, by being placed at the beginning\n+\/\/ of the worklist. Next after initially-ready CreateEx nodes are projections,\n+\/\/ which must follow their parents, and CreateEx nodes with local input\n+\/\/ dependencies. Next are constants and CheckCastPP nodes. There are a number of\n@@ -532,5 +535,6 @@\n-    if( n->is_Proj() ||         \/\/ Projections always win\n-        n->Opcode()== Op_Con || \/\/ So does constant 'Top'\n-        iop == Op_CreateEx ||   \/\/ Create-exception must start block\n-        iop == Op_CheckCastPP\n-        ) {\n+    if (iop == Op_CreateEx || n->is_Proj()) {\n+      \/\/ CreateEx nodes that are initially ready must start the block (after Phi\n+      \/\/ and Parm nodes which are pre-scheduled) and get top priority. This is\n+      \/\/ currently enforced by placing them at the beginning of the initial\n+      \/\/ worklist and selecting them eagerly here. After these, projections and\n+      \/\/ other CreateEx nodes are selected with equal priority.\n@@ -541,0 +545,12 @@\n+    if (n->Opcode() == Op_Con || iop == Op_CheckCastPP) {\n+      \/\/ Constants and CheckCastPP nodes have higher priority than the rest of\n+      \/\/ the nodes tested below. Record as current winner, but keep looking for\n+      \/\/ higher-priority nodes in the worklist.\n+      choice  = 4;\n+      \/\/ Latency and score are only used to break ties among low-priority nodes.\n+      latency = 0;\n+      score   = 0;\n+      idx     = i;\n+      continue;\n+    }\n+\n@@ -559,1 +575,1 @@\n-    uint n_choice  = 2;\n+    uint n_choice = 2;\n@@ -1048,2 +1064,2 @@\n-        \/\/ Force the CreateEx to the top of the list so it's processed\n-        \/\/ first and ends up at the start of the block.\n+        \/\/ Place CreateEx nodes that are initially ready at the beginning of the\n+        \/\/ worklist so they are selected first and scheduled at the block start.\n","filename":"src\/hotspot\/share\/opto\/lcm.cpp","additions":28,"deletions":12,"binary":false,"changes":40,"status":"modified"}]}