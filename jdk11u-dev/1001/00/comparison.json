{"files":[{"patch":"@@ -57,0 +57,3 @@\n+    private Path cgroupv1CgroupsJoinControllers;\n+    private Path cgroupv1SelfCgroupsJoinControllers;\n+    private Path cgroupv1MountInfoJoinControllers;\n@@ -85,0 +88,11 @@\n+    private String procSelfCgroupV1JoinControllers =\n+            \"9:freezer:\/\\n\" +\n+            \"8:rdma:\/\\n\" +\n+            \"7:blkio:\/user.slice\\n\" +\n+            \"6:devices:\/user.slice\\n\" +\n+            \"5:pids:\/user.slice\/user-1000.slice\/session-2.scope\\n\" +\n+            \"4:cpu,cpuacct,memory,net_cls,net_prio,hugetlb:\/user.slice\/user-1000.slice\/session-2.scope\\n\" +\n+            \"3:cpuset:\/\\n\" +\n+            \"2:perf_event:\/\\n\" +\n+            \"1:name=systemd:\/user.slice\/user-1000.slice\/session-2.scope\\n\" +\n+            \"0::\/user.slice\/user-1000.slice\/session-2.scope\\n\";\n@@ -96,0 +110,15 @@\n+    private String cgroupsNonZeroJoinControllers =\n+            \"#subsys_name hierarchy num_cgroups enabled\\n\" +\n+            \"cpuset\\t3\\t1\\t1\\n\" +\n+            \"cpu\\t4\\t153\\t1\\n\" +\n+            \"cpuacct\\t4\\t153\\t1\\n\" +\n+            \"blkio\\t7\\t87\\t1\\n\" +\n+            \"memory\\t4\\t153\\t1\\n\" +\n+            \"devices\\t6\\t87\\t1\\n\" +\n+            \"freezer\\t9\\t1\\t1\\n\" +\n+            \"net_cls\\t4\\t153\\t1\\n\" +\n+            \"perf_event\\t2\\t1\\t1\\n\" +\n+            \"net_prio\\t4\\t153\\t1\\n\" +\n+            \"hugetlb\\t4\\t153\\t1\\n\" +\n+            \"pids\\t5\\t95\\t1\\n\" +\n+            \"rdma\\t8\\t1\\t1\\n\";\n@@ -114,0 +143,12 @@\n+    private String mntInfoCgroupv1JoinControllers =\n+            \"31 22 0:26 \/ \/sys\/fs\/cgroup ro,nosuid,nodev,noexec shared:9 - tmpfs tmpfs ro,mode=755\\n\" +\n+            \"32 31 0:27 \/ \/sys\/fs\/cgroup\/unified rw,nosuid,nodev,noexec,relatime shared:10 - cgroup2 cgroup2 rw,nsdelegate\\n\" +\n+            \"33 31 0:28 \/ \/sys\/fs\/cgroup\/systemd rw,nosuid,nodev,noexec,relatime shared:11 - cgroup cgroup rw,xattr,name=systemd\\n\" +\n+            \"36 31 0:31 \/ \/sys\/fs\/cgroup\/perf_event rw,nosuid,nodev,noexec,relatime shared:15 - cgroup cgroup rw,perf_event\\n\" +\n+            \"37 31 0:32 \/ \/sys\/fs\/cgroup\/cpuset rw,nosuid,nodev,noexec,relatime shared:16 - cgroup cgroup rw,cpuset\\n\" +\n+            \"38 31 0:33 \/ \/sys\/fs\/cgroup\/cpu,cpuacct,net_cls,net_prio,hugetlb,memory rw,nosuid,nodev,noexec,relatime shared:17 - cgroup cgroup rw,cpu,cpuacct,memory,net_cls,net_prio,hugetlb\\n\" +\n+            \"39 31 0:34 \/ \/sys\/fs\/cgroup\/pids rw,nosuid,nodev,noexec,relatime shared:18 - cgroup cgroup rw,pids\\n\" +\n+            \"40 31 0:35 \/ \/sys\/fs\/cgroup\/devices rw,nosuid,nodev,noexec,relatime shared:19 - cgroup cgroup rw,devices\\n\" +\n+            \"41 31 0:36 \/ \/sys\/fs\/cgroup\/blkio rw,nosuid,nodev,noexec,relatime shared:20 - cgroup cgroup rw,blkio\\n\" +\n+            \"42 31 0:37 \/ \/sys\/fs\/cgroup\/rdma rw,nosuid,nodev,noexec,relatime shared:21 - cgroup cgroup rw,rdma\\n\" +\n+            \"43 31 0:38 \/ \/sys\/fs\/cgroup\/freezer rw,nosuid,nodev,noexec,relatime shared:22 - cgroup cgroup rw,freezer\\n\";\n@@ -179,0 +220,9 @@\n+\n+            cgroupv1CgroupsJoinControllers = Paths.get(existingDirectory.toString(), \"cgroups_cgv1_join_controllers\");\n+            Files.writeString(cgroupv1CgroupsJoinControllers, cgroupsNonZeroJoinControllers);\n+\n+            cgroupv1SelfCgroupsJoinControllers = Paths.get(existingDirectory.toString(), \"self_cgroup_cgv1_join_controllers\");\n+            Files.writeString(cgroupv1SelfCgroupsJoinControllers, procSelfCgroupV1JoinControllers);\n+\n+            cgroupv1MountInfoJoinControllers = Paths.get(existingDirectory.toString(), \"mntinfo_cgv1_join_controllers\");\n+            Files.writeString(cgroupv1MountInfoJoinControllers, mntInfoCgroupv1JoinControllers);\n@@ -196,0 +246,10 @@\n+    public void testCgroupv1JoinControllerCombo(WhiteBox wb) {\n+        String procCgroups = cgroupv1CgroupsJoinControllers.toString();\n+        String procSelfCgroup = cgroupv1SelfCgroupsJoinControllers.toString();\n+        String procSelfMountinfo = cgroupv1MountInfoJoinControllers.toString();\n+        int retval = wb.validateCgroup(procCgroups, procSelfCgroup, procSelfMountinfo);\n+        Asserts.assertEQ(CGROUPS_V1, retval, \"Join controllers should be properly detected\");\n+        Asserts.assertTrue(isValidCgroup(retval));\n+        System.out.println(\"testCgroupv1JoinControllerMounts PASSED!\");\n+    }\n+\n@@ -291,0 +351,1 @@\n+            test.testCgroupv1JoinControllerCombo(wb);\n","filename":"test\/hotspot\/jtreg\/containers\/cgroup\/CgroupSubsystemFactory.java","additions":61,"deletions":0,"binary":false,"changes":61,"status":"modified"},{"patch":"@@ -53,0 +53,2 @@\n+    private Path cgroupv1CgroupsJoinControllers;\n+    private Path cgroupv1MountInfoJoinControllers;\n@@ -60,0 +62,2 @@\n+    private Path cgroupv1MntInfoDoubleCpusets;\n+    private Path cgroupv1MntInfoDoubleCpusets2;\n@@ -61,0 +65,15 @@\n+    private String cgroupsNonZeroJoinControllers =\n+            \"#subsys_name hierarchy num_cgroups enabled\\n\" +\n+            \"cpuset\\t3\\t1\\t1\\n\" +\n+            \"cpu\\t4\\t153\\t1\\n\" +\n+            \"cpuacct\\t4\\t153\\t1\\n\" +\n+            \"blkio\\t7\\t87\\t1\\n\" +\n+            \"memory\\t4\\t153\\t1\\n\" +\n+            \"devices\\t6\\t87\\t1\\n\" +\n+            \"freezer\\t9\\t1\\t1\\n\" +\n+            \"net_cls\\t4\\t153\\t1\\n\" +\n+            \"perf_event\\t2\\t1\\t1\\n\" +\n+            \"net_prio\\t4\\t153\\t1\\n\" +\n+            \"hugetlb\\t4\\t153\\t1\\n\" +\n+            \"pids\\t5\\t95\\t1\\n\" +\n+            \"rdma\\t8\\t1\\t1\\n\";\n@@ -74,12 +93,24 @@\n-            \"31 30 0:27 \/ \/sys\/fs\/cgroup\/unified rw,nosuid,nodev,noexec,relatime shared:5 - cgroup2 cgroup2 rw,seclabel,nsdelegate\\n\" +\n-            \"32 30 0:28 \/ \/sys\/fs\/cgroup\/systemd rw,nosuid,nodev,noexec,relatime shared:6 - cgroup cgroup rw,seclabel,xattr,name=systemd\\n\" +\n-            \"35 30 0:31 \/ \/sys\/fs\/cgroup\/memory rw,nosuid,nodev,noexec,relatime shared:7 - cgroup cgroup rw,seclabel,memory\\n\" +\n-            \"36 30 0:32 \/ \/sys\/fs\/cgroup\/pids rw,nosuid,nodev,noexec,relatime shared:8 - cgroup cgroup rw,seclabel,pids\\n\" +\n-            \"37 30 0:33 \/ \/sys\/fs\/cgroup\/perf_event rw,nosuid,nodev,noexec,relatime shared:9 - cgroup cgroup rw,seclabel,perf_event\\n\" +\n-            \"38 30 0:34 \/ \/sys\/fs\/cgroup\/net_cls,net_prio rw,nosuid,nodev,noexec,relatime shared:10 - cgroup cgroup rw,seclabel,net_cls,net_prio\\n\" +\n-            \"39 30 0:35 \/ \/sys\/fs\/cgroup\/hugetlb rw,nosuid,nodev,noexec,relatime shared:11 - cgroup cgroup rw,seclabel,hugetlb\\n\" +\n-            \"40 30 0:36 \/ \/sys\/fs\/cgroup\/cpu,cpuacct rw,nosuid,nodev,noexec,relatime shared:12 - cgroup cgroup rw,seclabel,cpu,cpuacct\\n\" +\n-            \"41 30 0:37 \/ \/sys\/fs\/cgroup\/devices rw,nosuid,nodev,noexec,relatime shared:13 - cgroup cgroup rw,seclabel,devices\\n\" +\n-            \"42 30 0:38 \/ \/sys\/fs\/cgroup\/cpuset rw,nosuid,nodev,noexec,relatime shared:14 - cgroup cgroup rw,seclabel,cpuset\\n\" +\n-            \"43 30 0:39 \/ \/sys\/fs\/cgroup\/blkio rw,nosuid,nodev,noexec,relatime shared:15 - cgroup cgroup rw,seclabel,blkio\\n\" +\n-            \"44 30 0:40 \/ \/sys\/fs\/cgroup\/freezer rw,nosuid,nodev,noexec,relatime shared:16 - cgroup cgroup rw,seclabel,freezer\";\n+            \"31 30 0:27 \/ \/sys\/fs\/cgroup\/unified rw,nosuid,nodev,noexec,relatime shared:5 - cgroup2 none rw,seclabel,nsdelegate\\n\" +\n+            \"32 30 0:28 \/ \/sys\/fs\/cgroup\/systemd rw,nosuid,nodev,noexec,relatime shared:6 - cgroup none rw,seclabel,xattr,name=systemd\\n\" +\n+            \"35 30 0:31 \/ \/sys\/fs\/cgroup\/memory rw,nosuid,nodev,noexec,relatime shared:7 - cgroup none rw,seclabel,memory\\n\" +\n+            \"36 30 0:32 \/ \/sys\/fs\/cgroup\/pids rw,nosuid,nodev,noexec,relatime shared:8 - cgroup none rw,seclabel,pids\\n\" +\n+            \"37 30 0:33 \/ \/sys\/fs\/cgroup\/perf_event rw,nosuid,nodev,noexec,relatime shared:9 - cgroup none rw,seclabel,perf_event\\n\" +\n+            \"38 30 0:34 \/ \/sys\/fs\/cgroup\/net_cls,net_prio rw,nosuid,nodev,noexec,relatime shared:10 - cgroup none rw,seclabel,net_cls,net_prio\\n\" +\n+            \"39 30 0:35 \/ \/sys\/fs\/cgroup\/hugetlb rw,nosuid,nodev,noexec,relatime shared:11 - cgroup none rw,seclabel,hugetlb\\n\" +\n+            \"40 30 0:36 \/ \/sys\/fs\/cgroup\/cpu,cpuacct rw,nosuid,nodev,noexec,relatime shared:12 - cgroup none rw,seclabel,cpu,cpuacct\\n\" +\n+            \"41 30 0:37 \/ \/sys\/fs\/cgroup\/devices rw,nosuid,nodev,noexec,relatime shared:13 - cgroup none rw,seclabel,devices\\n\" +\n+            \"42 30 0:38 \/ \/sys\/fs\/cgroup\/cpuset rw,nosuid,nodev,noexec,relatime shared:14 - cgroup none rw,seclabel,cpuset\\n\" +\n+            \"43 30 0:39 \/ \/sys\/fs\/cgroup\/blkio rw,nosuid,nodev,noexec,relatime shared:15 - cgroup none rw,seclabel,blkio\\n\" +\n+            \"44 30 0:40 \/ \/sys\/fs\/cgroup\/freezer rw,nosuid,nodev,noexec,relatime shared:16 - cgroup none rw,seclabel,freezer\\n\";\n+    private String mntInfoCgroupv1JoinControllers =\n+            \"31 22 0:26 \/ \/sys\/fs\/cgroup ro,nosuid,nodev,noexec shared:9 - tmpfs tmpfs ro,mode=755\\n\" +\n+            \"32 31 0:27 \/ \/sys\/fs\/cgroup\/unified rw,nosuid,nodev,noexec,relatime shared:10 - cgroup2 cgroup2 rw,nsdelegate\\n\" +\n+            \"33 31 0:28 \/ \/sys\/fs\/cgroup\/systemd rw,nosuid,nodev,noexec,relatime shared:11 - cgroup cgroup rw,xattr,name=systemd\\n\" +\n+            \"36 31 0:31 \/ \/sys\/fs\/cgroup\/perf_event rw,nosuid,nodev,noexec,relatime shared:15 - cgroup cgroup rw,perf_event\\n\" +\n+            \"37 31 0:32 \/ \/sys\/fs\/cgroup\/cpuset rw,nosuid,nodev,noexec,relatime shared:16 - cgroup cgroup rw,cpuset\\n\" +\n+            \"38 31 0:33 \/ \/sys\/fs\/cgroup\/cpu,cpuacct,net_cls,net_prio,hugetlb,memory rw,nosuid,nodev,noexec,relatime shared:17 - cgroup cgroup rw,cpu,cpuacct,memory,net_cls,net_prio,hugetlb\\n\" +\n+            \"39 31 0:34 \/ \/sys\/fs\/cgroup\/pids rw,nosuid,nodev,noexec,relatime shared:18 - cgroup cgroup rw,pids\\n\" +\n+            \"40 31 0:35 \/ \/sys\/fs\/cgroup\/devices rw,nosuid,nodev,noexec,relatime shared:19 - cgroup cgroup rw,devices\\n\" +\n+            \"41 31 0:36 \/ \/sys\/fs\/cgroup\/blkio rw,nosuid,nodev,noexec,relatime shared:20 - cgroup cgroup rw,blkio\\n\" +\n+            \"42 31 0:37 \/ \/sys\/fs\/cgroup\/rdma rw,nosuid,nodev,noexec,relatime shared:21 - cgroup cgroup rw,rdma\\n\" +\n+            \"43 31 0:38 \/ \/sys\/fs\/cgroup\/freezer rw,nosuid,nodev,noexec,relatime shared:22 - cgroup cgroup rw,freezer\\n\";\n@@ -101,1 +132,1 @@\n-            \"28 21 0:25 \/ \/sys\/fs\/cgroup rw,nosuid,nodev,noexec,relatime shared:4 - cgroup2 cgroup2 rw,seclabel,nsdelegate\";\n+            \"28 21 0:25 \/ \/sys\/fs\/cgroup rw,nosuid,nodev,noexec,relatime shared:4 - cgroup2 none rw,seclabel,nsdelegate\";\n@@ -105,0 +136,3 @@\n+    private String mntInfoCgroupv1MoreCpusetLine = \"121 32 0:37 \/ \/cpuset rw,relatime shared:69 - cgroup none rw,cpuset\\n\";\n+    private String mntInfoCgroupsV1DoubleCpuset = mntInfoHybrid + mntInfoCgroupv1MoreCpusetLine;\n+    private String mntInfoCgroupsV1DoubleCpuset2 = mntInfoCgroupv1MoreCpusetLine + mntInfoHybrid;\n@@ -128,0 +162,12 @@\n+\n+            cgroupv1MntInfoDoubleCpusets = Paths.get(existingDirectory.toString(), \"mountinfo_cgroupv1_double_cpuset\");\n+            Files.writeString(cgroupv1MntInfoDoubleCpusets, mntInfoCgroupsV1DoubleCpuset);\n+\n+            cgroupv1MntInfoDoubleCpusets2 = Paths.get(existingDirectory.toString(), \"mountinfo_cgroupv1_double_cpuset2\");\n+            Files.writeString(cgroupv1MntInfoDoubleCpusets2, mntInfoCgroupsV1DoubleCpuset2);\n+\n+            cgroupv1CgroupsJoinControllers = Paths.get(existingDirectory.toString(), \"cgroups_cgv1_join_controllers\");\n+            Files.writeString(cgroupv1CgroupsJoinControllers, cgroupsNonZeroJoinControllers);\n+\n+            cgroupv1MountInfoJoinControllers = Paths.get(existingDirectory.toString(), \"mntinfo_cgv1_join_controllers\");\n+            Files.writeString(cgroupv1MountInfoJoinControllers, mntInfoCgroupv1JoinControllers);\n@@ -142,0 +188,11 @@\n+    @Test\n+    public void testCgroupv1JoinControllerCombo() throws IOException {\n+        String cgroups = cgroupv1CgroupsJoinControllers.toString();\n+        String mountInfo = cgroupv1MountInfoJoinControllers.toString();\n+        Optional<CgroupTypeResult> result = CgroupSubsystemFactory.determineType(mountInfo, cgroups);\n+\n+        assertTrue(\"Expected non-empty cgroup result\", result.isPresent());\n+        CgroupTypeResult res = result.get();\n+        assertFalse(\"Join controller combination expected as cgroups v1\", res.isCgroupV2());\n+    }\n+\n@@ -151,0 +208,16 @@\n+    @Test\n+    public void testCgroupv1MultipleCpusetMounts() throws IOException {\n+        doMultipleCpusetMountsTest(cgroupv1MntInfoDoubleCpusets);\n+        doMultipleCpusetMountsTest(cgroupv1MntInfoDoubleCpusets2);\n+    }\n+\n+    private void doMultipleCpusetMountsTest(Path info) throws IOException {\n+        String cgroups = cgroupv1CgInfoNonZeroHierarchy.toString();\n+        String mountInfo = info.toString();\n+        Optional<CgroupTypeResult> result = CgroupSubsystemFactory.determineType(mountInfo, cgroups);\n+\n+        assertTrue(\"Expected non-empty cgroup result\", result.isPresent());\n+        CgroupTypeResult res = result.get();\n+        assertFalse(\"Duplicate cpusets should not influence detection heuristic\", res.isCgroupV2());\n+    }\n+\n","filename":"test\/jdk\/jdk\/internal\/platform\/cgroup\/TestCgroupSubsystemFactory.java","additions":86,"deletions":13,"binary":false,"changes":99,"status":"modified"}]}