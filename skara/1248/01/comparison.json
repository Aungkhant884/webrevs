{"files":[{"patch":"@@ -31,0 +31,1 @@\n+import org.openjdk.skara.issuetracker.Link;\n@@ -82,62 +83,35 @@\n-            for (var link : jbsIssue.get().links()) {\n-                var relationship = link.relationship();\n-                if (relationship.isPresent() && relationship.get().equals(\"csr for\")) {\n-                    log.info(\"Found CSR for \" + describe(pr));\n-\n-                    var csr = link.issue().orElseThrow(\n-                            () -> new IllegalStateException(\"Link with title 'csr for' does not contain issue\")\n-                    );\n-\n-                    log.info(\"CSR for \" + describe(pr) + \" has id \" + csr.id());\n-\n-                    var resolution = csr.properties().get(\"resolution\");\n-                    if (resolution == null || resolution.isNull()) {\n-                        if (!pr.labelNames().contains(CSR_LABEL)) {\n-                            log.info(\"CSR issue resolution is null for \" + describe(pr) + \", adding the CSR label\");\n-                            pr.addLabel(CSR_LABEL);\n-                        } else {\n-                            log.info(\"CSR issue resolution is null for \" + describe(pr) + \", not removing the CSR label\");\n-                        }\n-                        continue;\n-                    }\n-                    var name = resolution.get(\"name\");\n-                    if (name == null || name.isNull()) {\n-                        if (!pr.labelNames().contains(CSR_LABEL)) {\n-                            log.info(\"CSR issue resolution name is null for \" + describe(pr) + \", adding the CSR label\");\n-                            pr.addLabel(CSR_LABEL);\n-                        } else {\n-                            log.info(\"CSR issue resolution name is null for \" + describe(pr) + \", not removing the CSR label\");\n-                        }\n-                        continue;\n-                    }\n-\n-                    if (csr.state() != Issue.State.CLOSED) {\n-                        if (!pr.labelNames().contains(CSR_LABEL)) {\n-                            log.info(\"CSR issue state is not closed for \" + describe(pr) + \", adding the CSR label\");\n-                            pr.addLabel(CSR_LABEL);\n-                        } else {\n-                            log.info(\"CSR issue state is not closed for \" + describe(pr) + \", not removing the CSR label\");\n-                        }\n-                        continue;\n-                    }\n-\n-                    if (!name.asString().equals(\"Approved\")) {\n-                        if (name.asString().equals(\"Withdrawn\")) {\n-                            \/\/ This condition is necessary to prevent the bot from adding the CSR label again.\n-                            \/\/ And the bot can't remove the CSR label automatically here.\n-                            \/\/ Because the PR author with the role of Committer may withdraw a CSR that\n-                            \/\/ a Reviewer had requested and integrate it without satisfying that requirement.\n-                            log.info(\"CSR closed and withdrawn for \" + describe(pr) + \", not revising (not adding and not removing) CSR label\");\n-                        } else if (!pr.labelNames().contains(CSR_LABEL)) {\n-                            log.info(\"CSR issue resolution is not 'Approved' for \" + describe(pr) + \", adding the CSR label\");\n-                            pr.addLabel(CSR_LABEL);\n-                        } else {\n-                            log.info(\"CSR issue resolution is not 'Approved' for \" + describe(pr) + \", not removing the CSR label\");\n-                        }\n-                        continue;\n-                    }\n-\n-                    if (pr.labelNames().contains(CSR_LABEL)) {\n-                        log.info(\"CSR closed and approved for \" + describe(pr) + \", removing CSR label\");\n-                        pr.removeLabel(CSR_LABEL);\n-                    }\n+            var csr = jbsIssue.get().links().stream()\n+                    .filter(link -> link.relationship().isPresent() && \"csr for\".equals(link.relationship().get()))\n+                    .findAny().flatMap(Link::issue).orElse(null);\n+            if (csr == null) {\n+                log.info(\"Not found CSR for \" + describe(pr));\n+            }\n+            log.info(\"Found CSR for \" + describe(pr) + \". It has id \" + csr.id());\n+\n+            var resolution = csr.properties().get(\"resolution\");\n+            if (resolution == null || resolution.isNull()) {\n+                if (!pr.labelNames().contains(CSR_LABEL)) {\n+                    log.info(\"CSR issue resolution is null for \" + describe(pr) + \", adding the CSR label\");\n+                    pr.addLabel(CSR_LABEL);\n+                } else {\n+                    log.info(\"CSR issue resolution is null for \" + describe(pr) + \", not removing the CSR label\");\n+                }\n+                continue;\n+            }\n+            var name = resolution.get(\"name\");\n+            if (name == null || name.isNull()) {\n+                if (!pr.labelNames().contains(CSR_LABEL)) {\n+                    log.info(\"CSR issue resolution name is null for \" + describe(pr) + \", adding the CSR label\");\n+                    pr.addLabel(CSR_LABEL);\n+                } else {\n+                    log.info(\"CSR issue resolution name is null for \" + describe(pr) + \", not removing the CSR label\");\n+                }\n+                continue;\n+            }\n+\n+            if (csr.state() != Issue.State.CLOSED) {\n+                if (!pr.labelNames().contains(CSR_LABEL)) {\n+                    log.info(\"CSR issue state is not closed for \" + describe(pr) + \", adding the CSR label\");\n+                    pr.addLabel(CSR_LABEL);\n+                } else {\n+                    log.info(\"CSR issue state is not closed for \" + describe(pr) + \", not removing the CSR label\");\n@@ -145,0 +119,22 @@\n+                continue;\n+            }\n+\n+            if (!name.asString().equals(\"Approved\")) {\n+                if (name.asString().equals(\"Withdrawn\")) {\n+                    \/\/ This condition is necessary to prevent the bot from adding the CSR label again.\n+                    \/\/ And the bot can't remove the CSR label automatically here.\n+                    \/\/ Because the PR author with the role of Committer may withdraw a CSR that\n+                    \/\/ a Reviewer had requested and integrate it without satisfying that requirement.\n+                    log.info(\"CSR closed and withdrawn for \" + describe(pr) + \", not revising (not adding and not removing) CSR label\");\n+                } else if (!pr.labelNames().contains(CSR_LABEL)) {\n+                    log.info(\"CSR issue resolution is not 'Approved' for \" + describe(pr) + \", adding the CSR label\");\n+                    pr.addLabel(CSR_LABEL);\n+                } else {\n+                    log.info(\"CSR issue resolution is not 'Approved' for \" + describe(pr) + \", not removing the CSR label\");\n+                }\n+                continue;\n+            }\n+\n+            if (pr.labelNames().contains(CSR_LABEL)) {\n+                log.info(\"CSR closed and approved for \" + describe(pr) + \", removing CSR label\");\n+                pr.removeLabel(CSR_LABEL);\n","filename":"bots\/csr\/src\/main\/java\/org\/openjdk\/skara\/bots\/csr\/CSRBot.java","additions":58,"deletions":62,"binary":false,"changes":120,"status":"modified"},{"patch":"@@ -99,29 +99,9 @@\n-            for (var link : jbsIssue.get().links()) {\n-                var relationship = link.relationship();\n-                if (relationship.isEmpty() || !relationship.get().equals(\"csr for\")) {\n-                    continue;\n-                }\n-                \/\/ Now the issue has a csr link.\n-                var csrIssue = link.issue().orElse(null);\n-                if (csrIssue == null) {\n-                    \/\/ The csr link exists but the csr issue doesn't exist.\n-                    \/\/ We should remind the user to remove the link firstly.\n-                    reply.println(\"the issue for this pull request, [\" + jbsIssue.get().id() + \"](\" + jbsIssue.get().webUrl()\n-                            + \"), has a invalid CSR link.\");\n-                    reply.println(\"So you can't directly indicate that a CSR request is not needed for this pull request. \");\n-                    reply.println(\"Please firstly remove the CSR link and then use the command `\/csr unneeded` again.\");\n-                    return;\n-                }\n-                var resolution = csrIssue.properties().get(\"resolution\");\n-                if (resolution == null || resolution.isNull()\n-                        || resolution.get(\"name\") == null || resolution.get(\"name\").isNull()\n-                        || csrIssue.state() != Issue.State.CLOSED\n-                        || !resolution.get(\"name\").asString().equals(\"Withdrawn\")) {\n-                    \/\/ The issue has a non-withdrawn csr issue, the bot should direct the user to withdraw the csr firstly.\n-                    reply.println(\"the issue for this pull request, [\" + jbsIssue.get().id() + \"](\" + jbsIssue.get().webUrl() + \"), has \" +\n-                            \"a non-withdrawn CSR request: [\" + csrIssue.id() + \"](\" + csrIssue.webUrl() + \"). \");\n-                    reply.println(\"So you can't directly indicate that a CSR request is not needed for this pull request. \");\n-                    reply.println(\"Please firstly withdraw the CSR request: [\" + csrIssue.id() + \"](\" + csrIssue.webUrl() + \"), \"\n-                            + \"and then use the command `\/csr unneeded` again.\");\n-                    return;\n-                }\n+\n+            var csrLink = jbsIssue.get().links().stream()\n+                    .filter(link -> link.relationship().isPresent() && \"csr for\".equals(link.relationship().get())).findAny();\n+            if (csrLink.isEmpty()) {\n+                \/\/ The issue has no csr link, the bot should just remove the csr label.\n+                pr.removeLabel(CSR_LABEL);\n+                reply.println(\"determined that a [CSR](https:\/\/wiki.openjdk.java.net\/display\/csr\/Main) request \" +\n+                        \"is not needed for this pull request.\");\n+                return;\n@@ -129,1 +109,26 @@\n-            \/\/ The issue has no csr or the csr has been withdrawn, the bot should just remove the csr label.\n+\n+            var csrIssue = csrLink.flatMap(Link::issue).orElse(null);\n+            if (csrIssue == null) {\n+                \/\/ The csr link exists but the csr issue doesn't exist.\n+                \/\/ We should remind the user to remove the link firstly.\n+                reply.println(\"the issue for this pull request, [\" + jbsIssue.get().id() + \"](\" + jbsIssue.get().webUrl()\n+                        + \"), has a invalid CSR link.\");\n+                reply.println(\"So you can't directly indicate that a CSR request is not needed for this pull request. \");\n+                reply.println(\"Please firstly remove the CSR link and then use the command `\/csr unneeded` again.\");\n+                return;\n+            }\n+            var resolution = csrIssue.properties().get(\"resolution\");\n+            if (resolution == null || resolution.isNull()\n+                    || resolution.get(\"name\") == null || resolution.get(\"name\").isNull()\n+                    || csrIssue.state() != Issue.State.CLOSED\n+                    || !resolution.get(\"name\").asString().equals(\"Withdrawn\")) {\n+                \/\/ The issue has a non-withdrawn csr issue, the bot should direct the user to withdraw the csr firstly.\n+                reply.println(\"the issue for this pull request, [\" + jbsIssue.get().id() + \"](\" + jbsIssue.get().webUrl() + \"), has \" +\n+                        \"a non-withdrawn CSR request: [\" + csrIssue.id() + \"](\" + csrIssue.webUrl() + \"). \");\n+                reply.println(\"So you can't directly indicate that a CSR request is not needed for this pull request. \");\n+                reply.println(\"Please firstly withdraw the CSR request: [\" + csrIssue.id() + \"](\" + csrIssue.webUrl() + \"), \"\n+                        + \"and then use the command `\/csr unneeded` again.\");\n+                return;\n+            }\n+\n+            \/\/ The csr has been withdrawn, the bot should just remove the csr label.\n@@ -159,9 +164,0 @@\n-        Issue csr = null;\n-        for (var link : jbsIssue.get().links()) {\n-            var relationship = link.relationship();\n-            if (relationship.isPresent() && relationship.get().equals(\"csr for\")) {\n-                csr = link.issue().orElseThrow(\n-                        () -> new IllegalStateException(\"Link with title 'csr for' does not contain issue\")\n-                );\n-            }\n-        }\n@@ -169,0 +165,3 @@\n+        var csr = jbsIssue.get().links().stream()\n+                .filter(link -> link.relationship().isPresent() && \"csr for\".equals(link.relationship().get()))\n+                .findAny().flatMap(Link::issue).orElse(null);\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CSRCommand.java","additions":38,"deletions":39,"binary":false,"changes":77,"status":"modified"},{"patch":"@@ -127,0 +127,3 @@\n+    \/**\n+     * Get the csr issue. Note: this `Issue` is not the issue in module `issuetracker`.\n+     *\/\n@@ -136,14 +139,6 @@\n-        org.openjdk.skara.issuetracker.Issue csr = null;\n-        for (var link : jbsIssue.get().links()) {\n-            var relationship = link.relationship();\n-            if (relationship.isEmpty() || !relationship.get().equals(\"csr for\")) {\n-                continue;\n-            }\n-            csr = link.issue().orElse(null);\n-            if (csr == null) {\n-                log.warning(\"The CSR \" + link + \" of the issue \" + issue + \" does not exist\");\n-            } else {\n-                break;\n-            }\n-        }\n-        if (csr != null) {\n+        org.openjdk.skara.issuetracker.Issue csr = jbsIssue.get().links().stream()\n+                .filter(link -> link.relationship().isPresent() && \"csr for\".equals(link.relationship().get()))\n+                .findAny().flatMap(Link::issue).orElse(null);\n+        if (csr == null) {\n+            log.warning(\"The CSR issue of the issue \" + issue + \" does not exist\");\n+        } else {\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CheckRun.java","additions":9,"deletions":14,"binary":false,"changes":23,"status":"modified"}]}