{"files":[{"patch":"@@ -2333,3 +2333,1 @@\n-            if (author.forge().supportsReviewBody()) {\n-                assertEquals(1, archiveContainsCount(archiveFolder.path(), \"Reason 1\"));\n-            }\n+            assertEquals(1, archiveContainsCount(archiveFolder.path(), \"Reason 1\"));\n@@ -2346,3 +2344,1 @@\n-            if (author.forge().supportsReviewBody()) {\n-                assertEquals(1, archiveContainsCount(archiveFolder.path(), \"Reason 2\"));\n-            }\n+            assertEquals(1, archiveContainsCount(archiveFolder.path(), \"Reason 2\"));\n@@ -2360,3 +2356,1 @@\n-            if (author.forge().supportsReviewBody()) {\n-                assertEquals(1, archiveContainsCount(archiveFolder.path(), \"Reason 3\"));\n-            }\n+            assertEquals(1, archiveContainsCount(archiveFolder.path(), \"Reason 3\"));\n","filename":"bots\/mlbridge\/src\/test\/java\/org\/openjdk\/skara\/bots\/mlbridge\/MailingListBridgeBotTests.java","additions":3,"deletions":9,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -747,14 +747,0 @@\n-    private void updateReviewedMessages(List<Comment> comments, List<Review> reviews) {\n-        var reviewTracker = new ReviewTracker(comments, reviews);\n-\n-        for (var added : reviewTracker.newReviews().entrySet()) {\n-            var body = added.getValue() + \"\\n\" +\n-                    \" ⚠️ Marking a PR as reviewed using the emoji buttons is deprecated and will not be supported in the near future. \" +\n-                    \"Please use the `Approve` button instead!\\n\\n\" +\n-                    \"This PR has been reviewed by \" +\n-                    formatReviewer(added.getKey().reviewer()) + \" - \" +\n-                    verdictToString(added.getKey().verdict()) + \".\";\n-            pr.addComment(body);\n-        }\n-    }\n-\n@@ -1083,5 +1069,0 @@\n-            \/\/ Post \/ update approval messages (only needed if the review itself can't contain a body)\n-            if (!pr.repository().forge().supportsReviewBody()) {\n-                updateReviewedMessages(comments, allReviews);\n-            }\n-\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CheckRun.java","additions":0,"deletions":19,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -1,67 +0,0 @@\n-\/*\n- * Copyright (c) 2019, Oracle and\/or its affiliates. All rights reserved.\n- * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n- *\n- * This code is free software; you can redistribute it and\/or modify it\n- * under the terms of the GNU General Public License version 2 only, as\n- * published by the Free Software Foundation.\n- *\n- * This code is distributed in the hope that it will be useful, but WITHOUT\n- * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n- * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n- * version 2 for more details (a copy is included in the LICENSE file that\n- * accompanied this code).\n- *\n- * You should have received a copy of the GNU General Public License version\n- * 2 along with this work; if not, write to the Free Software Foundation,\n- * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n- *\n- * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n- * or visit www.oracle.com if you need additional information or have any\n- * questions.\n- *\/\n-package org.openjdk.skara.bots.pr;\n-\n-import org.openjdk.skara.forge.Review;\n-import org.openjdk.skara.issuetracker.Comment;\n-\n-import java.util.*;\n-import java.util.regex.Pattern;\n-\n-class ReviewTracker {\n-    private final String reviewMarker = \"<!-- Review id marker (%d) -->\";\n-    private final Pattern reviewMarkerPattern = Pattern.compile(\n-            \"<!-- Review id marker \\\\((\\\\d+)\\\\) -->\");\n-\n-    private final Map<Review, String> newComments = new HashMap<>();\n-\n-    ReviewTracker(List<Comment> comments, List<Review> reviews) {\n-        var notified = new HashSet<Integer>();\n-\n-        \/\/ Calculate current state\n-        for (var comment : comments) {\n-            var reviewMarkerMatcher = reviewMarkerPattern.matcher(comment.body());\n-\n-            if (reviewMarkerMatcher.find()) {\n-                var reviewId = Integer.parseInt(reviewMarkerMatcher.group(1));\n-                notified.add(reviewId);\n-            }\n-        }\n-\n-        \/\/ Find all reviews without a body and a comment\n-        for (var review : reviews) {\n-            if (review.body().isPresent()) {\n-                \/\/ Ignore these\n-                continue;\n-            }\n-            \/\/ Not notified yet\n-            if (!notified.contains(review.id())) {\n-                newComments.put(review, String.format(reviewMarker, review.id()));\n-            }\n-        }\n-    }\n-\n-    Map<Review, String> newReviews() {\n-        return newComments;\n-    }\n-}\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/ReviewTracker.java","additions":0,"deletions":67,"binary":false,"changes":67,"status":"deleted"},{"patch":"@@ -388,64 +388,0 @@\n-    @Test\n-    void individualReviewComments(TestInfo testInfo) throws IOException {\n-        try (var credentials = new HostCredentials(testInfo);\n-             var tempFolder = new TemporaryDirectory()) {\n-            var author = credentials.getHostedRepository();\n-            var reviewer = credentials.getHostedRepository();\n-\n-            \/\/ This test is only relevant on hosts not supporting proper review comment bodies\n-            assumeTrue(!author.forge().supportsReviewBody());\n-\n-            var censusBuilder = credentials.getCensusBuilder()\n-                                           .addAuthor(author.forge().currentUser().id())\n-                                           .addReviewer(reviewer.forge().currentUser().id());\n-            var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();\n-\n-            \/\/ Populate the projects repository\n-            var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());\n-            var masterHash = localRepo.resolve(\"master\").orElseThrow();\n-            localRepo.push(masterHash, author.url(), \"master\", true);\n-\n-            \/\/ Make a change with a corresponding PR\n-            var editHash = CheckableRepository.appendAndCommit(localRepo);\n-            localRepo.push(editHash, author.url(), \"refs\/heads\/edit\", true);\n-            var pr = credentials.createPullRequest(author, \"master\", \"edit\", \"This is a pull request\");\n-\n-            \/\/ Check the status\n-            TestBotRunner.runPeriodicItems(checkBot);\n-            var comments = pr.comments();\n-            var commentCount = comments.size();\n-\n-            \/\/ Approve it as another user\n-            var approvalPr = reviewer.pullRequest(pr.id());\n-            approvalPr.addReview(Review.Verdict.APPROVED, \"Approved\");\n-\n-            \/\/ Check the status again\n-            TestBotRunner.runPeriodicItems(checkBot);\n-\n-            \/\/ There should now be two additional comments\n-            comments = pr.comments();\n-            assertEquals(commentCount + 2, comments.size());\n-            var comment = comments.get(commentCount);\n-            assertTrue(comment.body().contains(reviewer.forge().currentUser().username()));\n-            assertTrue(comment.body().contains(\"approved\"));\n-\n-            \/\/ Drop the review\n-            approvalPr.addReview(Review.Verdict.NONE, \"Unreviewed\");\n-\n-            \/\/ Check the status again\n-            TestBotRunner.runPeriodicItems(checkBot);\n-\n-            \/\/ There should now be yet another comment\n-            comments = pr.comments();\n-            assertEquals(commentCount + 3, comments.size());\n-            comment = comments.get(commentCount + 2);\n-            assertTrue(comment.body().contains(reviewer.forge().currentUser().username()));\n-            assertTrue(comment.body().contains(\"comment\"));\n-\n-            \/\/ No changes should not generate additional comments\n-            TestBotRunner.runPeriodicItems(checkBot);\n-            comments = pr.comments();\n-            assertEquals(commentCount + 3, comments.size());\n-        }\n-    }\n-\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/CheckTests.java","additions":0,"deletions":64,"binary":false,"changes":64,"status":"modified"},{"patch":"@@ -65,5 +65,0 @@\n-    @Override\n-    public boolean supportsReviewBody() {\n-        return false;\n-    }\n-\n","filename":"bots\/tester\/src\/test\/java\/org\/openjdk\/skara\/bots\/tester\/InMemoryHost.java","additions":0,"deletions":5,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -44,1 +44,0 @@\n-    boolean supportsReviewBody();\n","filename":"forge\/src\/main\/java\/org\/openjdk\/skara\/forge\/Forge.java","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -373,5 +373,0 @@\n-    @Override\n-    public boolean supportsReviewBody() {\n-        return true;\n-    }\n-\n","filename":"forge\/src\/main\/java\/org\/openjdk\/skara\/forge\/github\/GitHubHost.java","additions":0,"deletions":5,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -191,6 +191,0 @@\n-    @Override\n-    public boolean supportsReviewBody() {\n-        \/\/ GitLab CE does not support this\n-        return false;\n-    }\n-\n","filename":"forge\/src\/main\/java\/org\/openjdk\/skara\/forge\/gitlab\/GitLabHost.java","additions":0,"deletions":6,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -132,38 +132,2 @@\n-                               });\n-\n-        var awardApprovals = request.get(\"award_emoji\").execute().stream()\n-                                    .map(JSONValue::asObject)\n-                                    .filter(obj -> obj.get(\"name\").asString().equals(\"thumbsup\") ||\n-                                            obj.get(\"name\").asString().equals(\"thumbsdown\") ||\n-                                            obj.get(\"name\").asString().equals(\"question\"))\n-                                    .map(obj -> {\n-                                        var reviewer = repository.forge().user(obj.get(\"user\").get(\"username\").asString());\n-                                        Review.Verdict verdict;\n-                                        switch (obj.get(\"name\").asString()) {\n-                                            case \"thumbsup\":\n-                                                verdict = Review.Verdict.APPROVED;\n-                                                break;\n-                                            case \"thumbsdown\":\n-                                                verdict = Review.Verdict.DISAPPROVED;\n-                                                break;\n-                                            default:\n-                                                verdict = Review.Verdict.NONE;\n-                                                break;\n-                                        }\n-\n-                                        var createdAt = ZonedDateTime.parse(obj.get(\"updated_at\").asString());\n-\n-                                        \/\/ Find the latest commit that isn't created after our review\n-                                        var hash = commits.get(0).hash;\n-                                        for (var cd : commits) {\n-                                            if (createdAt.isAfter(cd.date)) {\n-                                                hash = cd.hash;\n-                                            }\n-                                        }\n-                                        var id = obj.get(\"id\").asInt();\n-                                        return new Review(createdAt, reviewer.get(), verdict, hash, id, null);\n-                                    });\n-\n-        return Stream.concat(approvals, awardApprovals)\n-                     .sorted(Comparator.comparing(Review::createdAt))\n-                     .collect(Collectors.toList());\n+                               }).toList();\n+        return approvals;\n","filename":"forge\/src\/main\/java\/org\/openjdk\/skara\/forge\/gitlab\/GitLabMergeRequest.java","additions":2,"deletions":38,"binary":false,"changes":40,"status":"modified"},{"patch":"@@ -162,5 +162,0 @@\n-    @Override\n-    public boolean supportsReviewBody() {\n-        return true;\n-    }\n-\n","filename":"test\/src\/main\/java\/org\/openjdk\/skara\/test\/TestHost.java","additions":0,"deletions":5,"binary":false,"changes":5,"status":"modified"}]}