{"files":[{"patch":"@@ -25,0 +25,1 @@\n+import org.openjdk.skara.bots.common.SolvesTracker;\n@@ -58,1 +59,1 @@\n-    private static void linkReply(PullRequest pr, PrintWriter writer) {\n+    private static void multipleIssueLinkReply(PullRequest pr, PrintWriter writer) {\n@@ -63,0 +64,5 @@\n+    private static void singleIssueLinkReply(PullRequest pr, PrintWriter writer) {\n+        writer.println(\"@\" + pr.author().username() + \" please create a [CSR](https:\/\/wiki.openjdk.org\/display\/csr\/Main) request, with the correct fix version, for the issue associated with this pull request.\" +\n+                \" This pull request cannot be integrated until the CSR request is approved.\");\n+    }\n+\n@@ -104,5 +110,0 @@\n-            var csrLinks = new StringBuilder();\n-            for (Matcher csr : csrs) {\n-                csrLinks.append(\"[\").append(csr.group(1)).append(\"](\").append(csr.group(2)).append(\")\").append(\" \");\n-            }\n-\n@@ -110,0 +111,4 @@\n+                var csrLinks = new StringBuilder();\n+                for (Matcher csr : csrs) {\n+                    csrLinks.append(\"[\").append(csr.group(1)).append(\"](\").append(csr.group(2)).append(\")\").append(\" \");\n+                }\n@@ -152,4 +157,0 @@\n-        var csrLinks = new StringBuilder();\n-        for (Matcher resolvedCSR : resolvedCSRs) {\n-            csrLinks.append(\"[\").append(resolvedCSR.group(1)).append(\"](\").append(resolvedCSR.group(2)).append(\")\").append(\" \");\n-        }\n@@ -157,0 +158,4 @@\n+            var csrLinks = new StringBuilder();\n+            for (Matcher resolvedCSR : resolvedCSRs) {\n+                csrLinks.append(\"[\").append(resolvedCSR.group(1)).append(\"](\").append(resolvedCSR.group(2)).append(\")\").append(\" \");\n+            }\n@@ -161,1 +166,6 @@\n-            linkReply(pr, reply);\n+            var issues = SolvesTracker.currentSolved(pr.repository().forge().currentUser(), pr.comments());\n+            if (issues.isEmpty()) {\n+                singleIssueLinkReply(pr, reply);\n+            } else {\n+                multipleIssueLinkReply(pr, reply);\n+            }\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CSRCommand.java","additions":21,"deletions":11,"binary":false,"changes":32,"status":"modified"},{"patch":"@@ -1180,1 +1180,1 @@\n-            var confFile = localRepo.show(Path.of(\".jcheck\/conf\"), localHash);\n+            var confFile = localRepo.lines(Path.of(\".jcheck\/conf\"), localHash);\n@@ -1183,2 +1183,1 @@\n-                String confFileContent = new String(confFile.get());\n-                var configuration = JCheckConfiguration.parse(confFileContent.lines().toList());\n+                var configuration = JCheckConfiguration.parse(confFile.get());\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CheckRun.java","additions":2,"deletions":3,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -113,4 +113,0 @@\n-            commentString = commentString + comments.stream()\n-                    .flatMap(comment -> comment.body().lines())\n-                    .filter(line -> line.startsWith(\"\/csr\"))\n-                    .collect(Collectors.joining());\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CheckWorkItem.java","additions":0,"deletions":4,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -441,0 +441,2 @@\n+            \/\/ Run csrIssueBot to update pr body\n+            TestBotRunner.runPeriodicItems(csrIssueBot);\n@@ -479,0 +481,2 @@\n+            \/\/ Run csrIssueBot to update the pr body\n+            TestBotRunner.runPeriodicItems(csrIssueBot);\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/CSRBotTests.java","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -27,0 +27,1 @@\n+import org.openjdk.skara.forge.PullRequestUtils;\n@@ -422,0 +423,1 @@\n+            issue.setProperty(\"issuetype\", JSON.of(\"Bug\"));\n@@ -432,0 +434,4 @@\n+            var csrIssueBot = new CSRIssueBot(issues, List.of(author), Map.of(bot.name(), prBot));\n+\n+            \/\/ Run issue bot once to initialize lastUpdatedAt\n+            TestBotRunner.runPeriodicItems(csrIssueBot);\n@@ -444,0 +450,1 @@\n+            PullRequestUtils.postPullRequestLinkComment(issue, pr);\n@@ -471,0 +478,1 @@\n+            TestBotRunner.runPeriodicItems(csrIssueBot);\n@@ -494,0 +502,1 @@\n+            issue.setProperty(\"issuetype\", JSON.of(\"Bug\"));\n@@ -504,0 +513,4 @@\n+            var csrIssueBot = new CSRIssueBot(issues, List.of(author), Map.of(bot.name(), prBot));\n+\n+            \/\/ Run issue bot once to initialize lastUpdatedAt\n+            TestBotRunner.runPeriodicItems(csrIssueBot);\n@@ -516,0 +529,1 @@\n+            PullRequestUtils.postPullRequestLinkComment(issue, pr);\n@@ -544,0 +558,1 @@\n+            TestBotRunner.runPeriodicItems(csrIssueBot);\n@@ -704,1 +719,1 @@\n-            var botRepo = credentials.getHostedRepository();\n+            var bot = credentials.getHostedRepository();\n@@ -708,2 +723,0 @@\n-            var bot = PullRequestBot.newBuilder().repo(botRepo).enableCsr(true)\n-                    .censusRepo(censusBuilder.build()).issueProject(issueProject).build();\n@@ -723,0 +736,8 @@\n+            var prBot = PullRequestBot.newBuilder().repo(bot).enableCsr(true)\n+                    .censusRepo(censusBuilder.build()).issueProject(issueProject).build();\n+\n+            var csrIssueBot = new CSRIssueBot(issueProject, List.of(author), Map.of(bot.name(), prBot));\n+\n+            \/\/ Run issue prBot once to initialize lastUpdatedAt\n+            TestBotRunner.runPeriodicItems(csrIssueBot);\n+\n@@ -750,1 +771,3 @@\n-            \/\/ Run bot. Request a CSR.\n+            PullRequestUtils.postPullRequestLinkComment(issue, pr);\n+\n+            \/\/ Run prBot. Request a CSR.\n@@ -752,1 +775,1 @@\n-            TestBotRunner.runPeriodicItems(bot);\n+            TestBotRunner.runPeriodicItems(prBot);\n@@ -758,1 +781,1 @@\n-            assertLastCommentContains(pr, \"please create a [CSR](https:\/\/wiki.openjdk.org\/display\/csr\/Main) request for any issue this pr solves\");\n+            assertLastCommentContains(pr, \"please create a [CSR](https:\/\/wiki.openjdk.org\/display\/csr\/Main) request\");\n@@ -763,1 +786,1 @@\n-            TestBotRunner.runPeriodicItems(bot);\n+            TestBotRunner.runPeriodicItems(prBot);\n@@ -779,1 +802,3 @@\n-            \/\/ Run bot. Request a CSR.\n+            PullRequestUtils.postPullRequestLinkComment(issue, pr);\n+\n+            \/\/ Run prBot. Request a CSR.\n@@ -781,1 +806,1 @@\n-            TestBotRunner.runPeriodicItems(bot);\n+            TestBotRunner.runPeriodicItems(prBot);\n@@ -787,1 +812,1 @@\n-            assertLastCommentContains(pr, \"please create a [CSR](https:\/\/wiki.openjdk.org\/display\/csr\/Main) request for any issue this pr solves\");\n+            assertLastCommentContains(pr, \"please create a [CSR](https:\/\/wiki.openjdk.org\/display\/csr\/Main) request\");\n@@ -792,1 +817,1 @@\n-            TestBotRunner.runPeriodicItems(bot);\n+            TestBotRunner.runPeriodicItems(prBot);\n@@ -808,1 +833,3 @@\n-            \/\/ Run bot. Request a CSR.\n+            PullRequestUtils.postPullRequestLinkComment(issue, pr);\n+\n+            \/\/ Run prBot. Request a CSR.\n@@ -810,1 +837,1 @@\n-            TestBotRunner.runPeriodicItems(bot);\n+            TestBotRunner.runPeriodicItems(prBot);\n@@ -816,1 +843,1 @@\n-            assertLastCommentContains(pr, \"please create a [CSR](https:\/\/wiki.openjdk.org\/display\/csr\/Main) request for any issue this pr solves\");\n+            assertLastCommentContains(pr, \"please create a [CSR](https:\/\/wiki.openjdk.org\/display\/csr\/Main) request\");\n@@ -821,1 +848,1 @@\n-            TestBotRunner.runPeriodicItems(bot);\n+            TestBotRunner.runPeriodicItems(prBot);\n@@ -829,1 +856,3 @@\n-            \/\/ Run bot. Request a CSR.\n+            \/\/ Run csrIssueBot to update the pr body\n+            TestBotRunner.runPeriodicItems(csrIssueBot);\n+            \/\/ Run prBot. Request a CSR.\n@@ -831,1 +860,1 @@\n-            TestBotRunner.runPeriodicItems(bot);\n+            TestBotRunner.runPeriodicItems(prBot);\n@@ -837,1 +866,1 @@\n-            TestBotRunner.runPeriodicItems(bot);\n+            TestBotRunner.runPeriodicItems(prBot);\n@@ -851,1 +880,3 @@\n-            \/\/ Run bot. Request a CSR.\n+            \/\/ Run csrIssueBot to update the pr body\n+            TestBotRunner.runPeriodicItems(csrIssueBot);\n+            \/\/ Run prBot. Request a CSR.\n@@ -853,1 +884,1 @@\n-            TestBotRunner.runPeriodicItems(bot);\n+            TestBotRunner.runPeriodicItems(prBot);\n@@ -859,1 +890,1 @@\n-            assertLastCommentContains(pr, \"please create a [CSR](https:\/\/wiki.openjdk.org\/display\/csr\/Main) request for any issue this pr solves\");\n+            assertLastCommentContains(pr, \"please create a [CSR](https:\/\/wiki.openjdk.org\/display\/csr\/Main) request\");\n@@ -864,1 +895,1 @@\n-            TestBotRunner.runPeriodicItems(bot);\n+            TestBotRunner.runPeriodicItems(prBot);\n@@ -876,1 +907,3 @@\n-            \/\/ Run bot. Request a CSR.\n+            TestBotRunner.runPeriodicItems(csrIssueBot);\n+\n+            \/\/ Run prBot. Request a CSR.\n@@ -878,1 +911,1 @@\n-            TestBotRunner.runPeriodicItems(bot);\n+            TestBotRunner.runPeriodicItems(prBot);\n@@ -884,1 +917,1 @@\n-            TestBotRunner.runPeriodicItems(bot);\n+            TestBotRunner.runPeriodicItems(prBot);\n@@ -903,1 +936,3 @@\n-            \/\/ Run bot.\n+            PullRequestUtils.postPullRequestLinkComment(issue, pr);\n+\n+            \/\/ Run prBot.\n@@ -905,1 +940,1 @@\n-            TestBotRunner.runPeriodicItems(bot);\n+            TestBotRunner.runPeriodicItems(prBot);\n@@ -912,0 +947,1 @@\n+            TestBotRunner.runPeriodicItems(csrIssueBot);\n@@ -914,1 +950,1 @@\n-            TestBotRunner.runPeriodicItems(bot);\n+            TestBotRunner.runPeriodicItems(prBot);\n@@ -920,1 +956,1 @@\n-            \/\/ re-run bot.\n+            \/\/ re-run prBot.\n@@ -922,1 +958,1 @@\n-            TestBotRunner.runPeriodicItems(bot);\n+            TestBotRunner.runPeriodicItems(prBot);\n@@ -928,1 +964,1 @@\n-            assertLastCommentContains(pr, \"please create a [CSR](https:\/\/wiki.openjdk.org\/display\/csr\/Main) request for any issue this pr solves\");\n+            assertLastCommentContains(pr, \"please create a [CSR](https:\/\/wiki.openjdk.org\/display\/csr\/Main) request\");\n@@ -954,0 +990,1 @@\n+            issue.setProperty(\"issuetype\", JSON.of(\"Bug\"));\n@@ -959,0 +996,4 @@\n+            var csrIssueBot = new CSRIssueBot(issues, List.of(author), Map.of(bot.name(), prBot));\n+\n+            \/\/ Run issue bot once to initialize lastUpdatedAt\n+            TestBotRunner.runPeriodicItems(csrIssueBot);\n@@ -971,0 +1012,1 @@\n+            PullRequestUtils.postPullRequestLinkComment(issue, pr);\n@@ -986,0 +1028,1 @@\n+            issue2.setProperty(\"issuetype\", JSON.of(\"Bug\"));\n@@ -992,0 +1035,2 @@\n+            PullRequestUtils.postPullRequestLinkComment(issue2, pr);\n+            TestBotRunner.runPeriodicItems(csrIssueBot);\n@@ -1007,0 +1052,1 @@\n+            TestBotRunner.runPeriodicItems(csrIssueBot);\n@@ -1029,0 +1075,1 @@\n+            TestBotRunner.runPeriodicItems(csrIssueBot);\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/CSRCommandTests.java","additions":78,"deletions":31,"binary":false,"changes":109,"status":"modified"},{"patch":"@@ -63,1 +63,0 @@\n-include 'bots:csr'\n","filename":"settings.gradle","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"}]}