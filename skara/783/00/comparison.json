{"files":[{"patch":"@@ -27,0 +27,1 @@\n+import org.openjdk.skara.issuetracker.Comment;\n@@ -36,0 +37,2 @@\n+    private static final String initialLabelMessage = \"<!-- PullRequestBot initial label help comment -->\";\n+\n@@ -50,0 +53,54 @@\n+    private Optional<Comment> findComment(List<Comment> comments, String marker) {\n+        var self = pr.repository().forge().currentUser();\n+        return comments.stream()\n+                       .filter(comment -> comment.author().equals(self))\n+                       .filter(comment -> comment.body().contains(marker))\n+                       .findAny();\n+    }\n+\n+    private void updateLabelMessage(List<Comment> comments, List<String> newLabels) {\n+        var existing = findComment(comments, initialLabelMessage);\n+        if (existing.isPresent()) {\n+            \/\/ Only add the comment once per PR\n+            return;\n+        }\n+\n+        var message = new StringBuilder();\n+        message.append(\"@\");\n+        message.append(pr.author().userName());\n+        message.append(\" \");\n+\n+        if (newLabels.isEmpty()) {\n+            message.append(\"To determine the appropriate audience for reviewing this pull request, one or more \");\n+            message.append(\"labels corresponding to different subsystems will normally be applied automatically. \");\n+            message.append(\"However, no automatic labelling rule matches the changes in this pull request. \");\n+            message.append(\"In order to have an RFR email automatically sent to the correct mailing list, you will \");\n+            message.append(\"need to add one or more labels manually using the `\/label add \\\"label\\\"` command. \");\n+            message.append(\"The following labels are valid: \");\n+            var labels = bot.labelConfiguration().allowed().stream()\n+                            .sorted()\n+                            .map(label -> \"`\" + label + \"`\")\n+                            .collect(Collectors.joining(\", \"));\n+            message.append(labels);\n+            message.append(\".\");\n+        } else {\n+            message.append(\"The following labels will be automatically applied to this pull request: \");\n+            var labels = newLabels.stream()\n+                                  .sorted()\n+                                  .map(label -> \"`\" + label + \"`\")\n+                                  .collect(Collectors.joining(\", \"));\n+            message.append(\"`\");\n+            message.append(labels);\n+            message.append(\"`. When this pull request is ready to be reviewed, an RFR email will be sent to the \");\n+            message.append(\"corresponding mailing list\");\n+            if (newLabels.size() > 1) {\n+                message.append(\"s\");\n+            }\n+            message.append(\". If you would like to change these labels, use the `\/label (add|remove) \\\"label\\\"` command.\");\n+        }\n+\n+        message.append(\"\\n\");\n+        message.append(initialLabelMessage);\n+        pr.addComment(message.toString());\n+    }\n+\n@@ -76,1 +133,1 @@\n-            newLabels.stream()\n+            var labelsToAdd = newLabels.stream()\n@@ -79,1 +136,3 @@\n-                     .forEach(pr::addLabel);\n+                                       .collect(Collectors.toList());\n+            updateLabelMessage(comments, labelsToAdd);\n+            labelsToAdd.forEach(pr::addLabel);\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/LabelerWorkItem.java","additions":61,"deletions":2,"binary":false,"changes":63,"status":"modified"},{"patch":"@@ -165,0 +165,2 @@\n+            assertLastCommentContains(pr, \"The following labels will be automatically applied\");\n+            assertLastCommentContains(pr, \"`2`\");\n@@ -234,0 +236,2 @@\n+            assertEquals(1, pr.comments().size());\n+            assertLastCommentContains(pr, \"The `1` label was successfully added.\");\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/LabelTests.java","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -36,0 +36,1 @@\n+import static org.openjdk.skara.bots.pr.PullRequestAsserts.assertLastCommentContains;\n@@ -72,0 +73,2 @@\n+            assertLastCommentContains(pr, \"However, no automatic labelling rule matches the changes in this pull request.\");\n+            assertLastCommentContains(pr, \"The following labels are valid: `test1`, `test2`\");\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/LabelerTests.java","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"}]}