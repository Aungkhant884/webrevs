{"files":[{"patch":"@@ -28,2 +28,1 @@\n-import org.openjdk.skara.issuetracker.Comment;\n-import org.openjdk.skara.issuetracker.IssueProject;\n+import org.openjdk.skara.issuetracker.*;\n@@ -38,1 +37,0 @@\n-import java.util.regex.Pattern;\n@@ -64,1 +62,0 @@\n-    static final Pattern ISSUE_ID_PATTERN = Pattern.compile(\"^(?:[A-Za-z][A-Za-z0-9]+-)?([0-9]+)$\");\n@@ -466,21 +463,0 @@\n-    private String updateTitle() {\n-        var title = pr.title();\n-        var m = ISSUE_ID_PATTERN.matcher(title);\n-        var project = issueProject();\n-\n-        var newTitle = title;\n-        if (m.matches() && project != null) {\n-            var id = m.group(1);\n-            var issue = project.issue(id);\n-            if (issue.isPresent()) {\n-                newTitle = id + \": \" + issue.get().title();\n-            }\n-        }\n-\n-        if (!title.equals(newTitle)) {\n-            pr.setTitle(newTitle);\n-        }\n-\n-        return newTitle;\n-    }\n-\n@@ -763,1 +739,1 @@\n-            var title = updateTitle();\n+            var title = pr.title();\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CheckRun.java","additions":2,"deletions":26,"binary":false,"changes":28,"status":"modified"},{"patch":"@@ -45,0 +45,1 @@\n+    static final Pattern ISSUE_ID_PATTERN = Pattern.compile(\"^(?:[A-Za-z][A-Za-z0-9]+-)?([0-9]+)$\");\n@@ -130,0 +131,22 @@\n+    private boolean updateTitle() {\n+        var title = pr.title();\n+        var m = ISSUE_ID_PATTERN.matcher(title);\n+        var project = bot.issueProject();\n+\n+        var newTitle = title;\n+        if (m.matches() && project != null) {\n+            var id = m.group(1);\n+            var issue = project.issue(id);\n+            if (issue.isPresent()) {\n+                newTitle = id + \": \" + issue.get().title();\n+            }\n+        }\n+\n+        if (!title.equals(newTitle)) {\n+            pr.setTitle(newTitle);\n+            return true;\n+        }\n+\n+        return false;\n+    }\n+\n@@ -152,0 +175,5 @@\n+            \/\/ If the title needs updating, we run the check again\n+            if (updateTitle()) {\n+                return List.of(new CheckWorkItem(bot, pr.repository().pullRequest(pr.id()), errorHandler));\n+            }\n+\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CheckWorkItem.java","additions":28,"deletions":0,"binary":false,"changes":28,"status":"modified"},{"patch":"@@ -1532,0 +1532,53 @@\n+    @Test\n+    void expandInvalidTitleWithNumericIssueId(TestInfo testInfo) throws IOException {\n+        try (var credentials = new HostCredentials(testInfo);\n+             var tempFolder = new TemporaryDirectory()) {\n+            var author = credentials.getHostedRepository();\n+            var reviewer = credentials.getHostedRepository();\n+            var issues = credentials.getIssueProject();\n+\n+            var censusBuilder = credentials.getCensusBuilder()\n+                                           .addAuthor(author.forge().currentUser().id())\n+                                           .addReviewer(reviewer.forge().currentUser().id());\n+            var checkBot = PullRequestBot.newBuilder()\n+                                         .repo(author)\n+                                         .censusRepo(censusBuilder.build())\n+                                         .issueProject(issues)\n+                                         .build();\n+\n+            var bug = issues.createIssue(\"My first bug\", List.of(\"A bug\"), Map.of());\n+            var numericId = bug.id().split(\"-\")[1];\n+\n+            \/\/ Populate the projects repository\n+            var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(),\n+                                                     Path.of(\"appendable.txt\"), Set.of(\"issues\"), \"0.9\");\n+            var masterHash = localRepo.resolve(\"master\").orElseThrow();\n+            localRepo.push(masterHash, author.url(), \"master\", true);\n+\n+            \/\/ Make a change with a corresponding PR\n+            var bugHash = CheckableRepository.appendAndCommit(localRepo);\n+            localRepo.push(bugHash, author.url(), \"bug\", true);\n+\n+            var bugPR = credentials.createPullRequest(author, \"master\", \"bug\", \"bad title\", true);\n+\n+            \/\/ Check the status (should not expand title)\n+            TestBotRunner.runPeriodicItems(checkBot);\n+            assertEquals(\"bad title\", bugPR.title());\n+            assertEquals(CheckStatus.FAILURE, bugPR.checks(bugHash).get(\"jcheck\").status());\n+            assertTrue(bugPR.checks(bugHash).get(\"jcheck\").summary().get().contains(\"The commit message does not reference any issue\"));\n+\n+            \/\/ Now update it\n+            bugPR.setTitle(numericId);\n+            bugPR = author.pullRequest(bugPR.id());\n+            assertEquals(numericId, bugPR.title());\n+\n+            \/\/ Check the status (should expand title)\n+            TestBotRunner.runPeriodicItems(checkBot);\n+            assertEquals(CheckStatus.SUCCESS, bugPR.checks(bugHash).get(\"jcheck\").status());\n+\n+            \/\/ Verify that the title is expanded\n+            bugPR = author.pullRequest(bugPR.id());\n+            assertEquals(numericId + \": \" + bug.title(), bugPR.title());\n+        }\n+    }\n+\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/CheckTests.java","additions":53,"deletions":0,"binary":false,"changes":53,"status":"modified"}]}