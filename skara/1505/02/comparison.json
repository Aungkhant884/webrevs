{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2019, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2019, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -32,0 +32,1 @@\n+import java.time.Duration;\n@@ -271,0 +272,5 @@\n+\n+    @Override\n+    public int deleteDeployKeys(Duration age) {\n+        return 0;\n+    }\n","filename":"bots\/tester\/src\/test\/java\/org\/openjdk\/skara\/bots\/tester\/InMemoryHostedRepository.java","additions":7,"deletions":1,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2018, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2018, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -211,0 +211,6 @@\n+\n+    \/**\n+     * Delete deploy keys which are older than 'age' in this repository\n+     * The return value is the count of deleted keys\n+     *\/\n+    int deleteDeployKeys(Duration age);\n","filename":"forge\/src\/main\/java\/org\/openjdk\/skara\/forge\/HostedRepository.java","additions":7,"deletions":1,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2018, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2018, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -27,0 +27,1 @@\n+import java.time.Duration;\n@@ -730,0 +731,13 @@\n+\n+    @Override\n+    public int deleteDeployKeys(Duration age) {\n+        var expired = request.get(\"keys\").execute()\n+                .stream()\n+                .filter(key -> ZonedDateTime.parse(key.get(\"created_at\").asString())\n+                        .isBefore(ZonedDateTime.now().minus(age)))\n+                .toList();\n+        for (var key : expired) {\n+            request.delete(\"keys\/\" + key.get(\"id\")).execute();\n+        }\n+        return expired.size();\n+    }\n","filename":"forge\/src\/main\/java\/org\/openjdk\/skara\/forge\/github\/GitHubRepository.java","additions":15,"deletions":1,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2018, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2018, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -831,0 +831,15 @@\n+\n+    @Override\n+    public int deleteDeployKeys(Duration age) {\n+        var expiredKeys = request.get(\"deploy_keys\").execute()\n+                .stream()\n+                .filter(key -> ZonedDateTime.parse(key.get(\"created_at\").asString())\n+                        .isBefore(ZonedDateTime.now().minus(age)))\n+                .toList();\n+        for (var key : expiredKeys) {\n+            request.delete(\"deploy_keys\/\" + key.get(\"id\"))\n+                    .header(\"Content-Type\", \"application\/json\")\n+                    .execute();\n+        }\n+        return expiredKeys.size();\n+    }\n","filename":"forge\/src\/main\/java\/org\/openjdk\/skara\/forge\/gitlab\/GitLabRepository.java","additions":16,"deletions":1,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -25,0 +25,1 @@\n+import java.time.Duration;\n@@ -262,0 +263,8 @@\n+\n+    @Test\n+    void testDeleteDeployKey() {\n+        var githubRepoOpt = githubHost.repository(\"zhaosongzs\/Test\");\n+        assumeTrue(githubRepoOpt.isPresent());\n+        var githubRepo = githubRepoOpt.get();\n+        githubRepo.deleteDeployKeys(Duration.ofHours(24));\n+    }\n","filename":"forge\/src\/test\/java\/org\/openjdk\/skara\/forge\/github\/GitHubRestApiTests.java","additions":9,"deletions":0,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -36,0 +36,1 @@\n+import java.time.Duration;\n@@ -279,0 +280,13 @@\n+\n+    @Test\n+    void testDeleteDeployKey() throws IOException {\n+        var settings = ManualTestSettings.loadManualTestSettings();\n+        var username = settings.getProperty(\"gitlab.user\");\n+        var token = settings.getProperty(\"gitlab.pat\");\n+        var credential = new Credential(username, token);\n+        var uri = URIBuilder.base(settings.getProperty(\"gitlab.uri\")).build();\n+        var gitLabHost = new GitLabHost(\"gitlab\", uri, false, credential, Set.of());\n+        var gitLabRepo = gitLabHost.repository(settings.getProperty(\"gitlab.repository\")).orElseThrow();\n+\n+        gitLabRepo.deleteDeployKeys(Duration.ofHours(24));\n+    }\n","filename":"forge\/src\/test\/java\/org\/openjdk\/skara\/forge\/gitlab\/GitLabRestApiTest.java","additions":14,"deletions":0,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2019, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2019, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -38,0 +38,1 @@\n+import java.time.Duration;\n@@ -53,0 +54,1 @@\n+    private Map<Integer, ZonedDateTime> deployKeys = new HashMap<>();\n@@ -434,0 +436,20 @@\n+\n+    @Override\n+    public int deleteDeployKeys(Duration age) {\n+        var expiredKeys = deployKeys.entrySet()\n+                .stream()\n+                .filter(entry -> entry.getValue().isBefore(ZonedDateTime.now().minus(age)))\n+                .toList();\n+        for (var key : expiredKeys) {\n+            deployKeys.remove(key.getKey());\n+        }\n+        return expiredKeys.size();\n+    }\n+\n+    public void addDeployKeys(int id, ZonedDateTime createTime) {\n+        deployKeys.put(id, createTime);\n+    }\n+\n+    public Map<Integer, ZonedDateTime> deployKeys() {\n+        return deployKeys;\n+    }\n","filename":"test\/src\/main\/java\/org\/openjdk\/skara\/test\/TestHostedRepository.java","additions":23,"deletions":1,"binary":false,"changes":24,"status":"modified"}]}