{"files":[{"patch":"@@ -48,1 +48,1 @@\n-    boolean isUpdateChange(PullRequest pr) {\n+    boolean requiresApproval(PullRequest pr) {\n","filename":"bots\/approval\/src\/main\/java\/org\/openjdk\/skara\/bots\/approval\/AbstractApprovalBot.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -27,1 +27,0 @@\n-import java.util.logging.Logger;\n@@ -36,1 +35,0 @@\n-    private final Logger log = Logger.getLogger(\"org.openjdk.skara.bots.approval\");\n@@ -55,1 +53,0 @@\n-            log.fine(\"Scheduling: \" + issueWorkItem);\n","filename":"bots\/approval\/src\/main\/java\/org\/openjdk\/skara\/bots\/approval\/ApprovalIssueBot.java","additions":0,"deletions":3,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -26,1 +26,0 @@\n-import java.util.ArrayList;\n@@ -29,0 +28,1 @@\n+import java.util.stream.Collectors;\n@@ -45,2 +45,1 @@\n-        var ret = new ArrayList<WorkItem>();\n-        PullRequestUtils.pullRequestCommentLink(issue).stream()\n+        return PullRequestUtils.pullRequestCommentLink(issue).stream()\n@@ -49,1 +48,1 @@\n-                .filter(pr -> pr.isOpen() && bot.isUpdateChange(pr))\n+                .filter(pr -> pr.isOpen() && bot.requiresApproval(pr))\n@@ -52,3 +51,1 @@\n-                .forEach(ret::add);\n-        ret.forEach(item -> log.fine(\"Scheduling: \" + item.toString() + \" due to update in \" + issue.id()));\n-        return ret;\n+                .collect(Collectors.toList());\n","filename":"bots\/approval\/src\/main\/java\/org\/openjdk\/skara\/bots\/approval\/ApprovalIssueWorkItem.java","additions":4,"deletions":7,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -27,1 +27,0 @@\n-import java.util.logging.Logger;\n@@ -36,1 +35,0 @@\n-    private final Logger log = Logger.getLogger(\"org.openjdk.skara.bots.approval\");\n@@ -51,1 +49,1 @@\n-            if (isUpdateChange(pr)) {\n+            if (requiresApproval(pr)) {\n@@ -54,1 +52,0 @@\n-                log.fine(\"Scheduling: \" + pullRequestWorkItem);\n","filename":"bots\/approval\/src\/main\/java\/org\/openjdk\/skara\/bots\/approval\/ApprovalPullRequestBot.java","additions":1,"deletions":4,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -57,1 +57,1 @@\n-                + \"The bot will close this pull request automatically.\", pr.author().username()));\n+                + \"This pull request will be closed.\", pr.author().username()));\n@@ -64,2 +64,2 @@\n-        if (!workItem.isUpdateChange()) {\n-            reply.println(\"this repository or the target branch of this pull request have not been configured to use the `approval` command.\");\n+        if (!workItem.requiresApproval()) {\n+            reply.println(\"the `approval` command can only be used on pull requests targeting branches and repositories that require approval.\");\n@@ -93,1 +93,1 @@\n-                        \/\/ the bot should remove the approval label at first.\n+                        \/\/ the bot should remove the approval label first.\n@@ -121,1 +121,1 @@\n-                    \/\/ the bot should remove the disapproval label at first.\n+                    \/\/ the bot should remove the disapproval label first.\n@@ -142,1 +142,1 @@\n-        return \"approve or disapprove an update change\";\n+        return \"approve or disapprove a pull request which needs maintainer's approval\";\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/ApprovalCommand.java","additions":6,"deletions":6,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -67,2 +67,1 @@\n-    \/\/ The `update change` is usually `backport change`.\n-    private static final String updateChangeSuggestionMarker = \"<!-- Update change pull request suggestion -->\";\n+    private static final String APPROVAL_SUGGESTION_MARKER = \"<!-- Approval suggestion comment -->\";\n@@ -194,1 +193,1 @@\n-        if (workItem.isUpdateChange()) {\n+        if (workItem.requiresApproval()) {\n@@ -204,1 +203,1 @@\n-                \/\/ The PR doesn't contain a right issue.\n+                \/\/ The PR doesn't have an issue.\n@@ -954,1 +953,1 @@\n-     * Add a suggestion comment to the pull requset which has an update change to direct the developers.\n+     * Add or update a suggestion comment to the pull request which needs the maintainer's approval to direct the developers.\n@@ -956,6 +955,1 @@\n-    private void addUpdateChangeSuggestionComment() {\n-        var existing = findComment(comments, updateChangeSuggestionMarker);\n-        if (existing.isPresent()) {\n-            \/\/ Only add the comment once per PR\n-            return;\n-        }\n+    private void updateApprovalSuggestionComment() {\n@@ -966,5 +960,17 @@\n-        var issue = Issue.fromStringRelaxed(pr.title()).flatMap(\n-                value -> issueProject() != null ? issueProject().issue(value.shortId()) : Optional.empty());\n-        var issueLink = \"\";\n-        if (issue.isPresent()) {\n-            issueLink = \"[\" + issue.get().id() + \"](\" + issue.get().webUrl() + \") \";\n+        message.append(\"\"\"\n+                This pull request requires [maintainer approval]\\\n+                (https:\/\/openjdk.org\/projects\/jdk-updates\/approval.html).\n+\n+                As a convenience, or if you don't have permission to post comments in JBS, \\\n+                you may use the command `\/request-approval` to supply the fix request comment \\\n+                and automatically set the correct request label.\n+                usage: `\/request-approval <comment-text>`\n+\n+                Please note that approval discussions should take place in the issue and not in the pull request.\n+                \"\"\");\n+        message.append(APPROVAL_SUGGESTION_MARKER);\n+        var existing = findComment(comments, APPROVAL_SUGGESTION_MARKER);\n+        if (existing.isPresent()) {\n+            pr.updateComment(existing.get().id(), message.toString());\n+        } else {\n+            pr.addComment(message.toString());\n@@ -972,31 +978,0 @@\n-        message.append(String.format(\"\"\"\n-                This is a change to the update repository or branch. Please add a comment to the main issue %s\\\n-                to state the related condition (the backport reason, the risk of the patch, the amount of \\\n-                work and so on). Below is an example for you:\n-\n-                ```\n-                Fix Request (%s)\n-                The code applies cleanly and the test in this change fails without the patch and succeeds \\\n-                after applying it. The risk of this backport is low because the change is little and the \\\n-                issue fixed by this change also exists in other update repositories.\n-                ```\n-\n-                If you don't have permission to add a comment in JBS. Please use the command `request-approval` \\\n-                to provide the related content, then the bot can help you add a comment by using the content \\\n-                you provided. Below is an example for you:\n-\n-                ```\n-                \/request-approval Fix Request (%s)\n-                The code applies cleanly and the test in this change fails without the patch and succeeds \\\n-                after applying it. The risk of this backport is low because the change is little and the \\\n-                issue fixed by this change also exists in other update repositories.\n-                ```\n-\n-                Please note you have to contact the maintainers directly in the main issue %s\\\n-                or by using the command `request-approval` repeatedly instead of in this pull request. \\\n-                And you don't need to add the fix request label manually to the issue like before, \\\n-                now the bot can help you add the label automatically when this pull request is ready \\\n-                for maintainers to approve.\n-                \"\"\", issueLink, pr.repository().name(), pr.repository().name(), issueLink));\n-        message.append(updateChangeSuggestionMarker);\n-        pr.addComment(message.toString());\n@@ -1006,1 +981,1 @@\n-     * Update labels of the issue and PR for the update change(usually backport).\n+     * Update labels of the issue and PR which need the maintainer's approval (usually backport).\n@@ -1008,1 +983,1 @@\n-    private void updateLabelsForUpdatesChange(boolean readyForApproval) {\n+    private void updateLabelsAboutApproval(boolean readyForApproval) {\n@@ -1182,7 +1157,7 @@\n-            if (workItem.isUpdateChange()) {\n-                var readyForApproval = visitor.messages().isEmpty() &&\n-                                       additionalErrors.isEmpty() &&\n-                                       additionalProgresses.entrySet().stream()\n-                                          .filter(entry -> !entry.getKey().equals(APPROVAL_PROGRESS))\n-                                          .allMatch(Map.Entry::getValue) &&\n-                                       integrationBlockers.isEmpty();\n+            if (workItem.requiresApproval()) {\n+                var additionalThingReady = additionalErrors.isEmpty() &&\n+                                           additionalProgresses.entrySet().stream()\n+                                             .filter(entry -> !entry.getKey().equals(APPROVAL_PROGRESS))\n+                                             .allMatch(Map.Entry::getValue) &&\n+                                           integrationBlockers.isEmpty();;\n+                var readyForApproval = visitor.messages().isEmpty() && additionalThingReady;\n@@ -1190,6 +1165,1 @@\n-                    readyForApproval = visitor.isReadyForReview() &&\n-                                       additionalErrors.isEmpty() &&\n-                                       additionalProgresses.entrySet().stream()\n-                                           .filter(entry -> !entry.getKey().equals(APPROVAL_PROGRESS))\n-                                           .allMatch(Map.Entry::getValue) &&\n-                                       integrationBlockers.isEmpty();\n+                    readyForApproval = visitor.isReadyForReview() && additionalThingReady;\n@@ -1198,1 +1168,1 @@\n-                addUpdateChangeSuggestionComment();\n+                updateApprovalSuggestionComment();\n@@ -1200,1 +1170,1 @@\n-                updateLabelsForUpdatesChange(readyForApproval);\n+                updateLabelsAboutApproval(readyForApproval);\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CheckRun.java","additions":34,"deletions":64,"binary":false,"changes":98,"status":"modified"},{"patch":"@@ -122,1 +122,1 @@\n-     * Get the backport request label name from the configuration.\n+     * Get the request label name from the configuration.\n@@ -139,1 +139,1 @@\n-     * Get the backport approval label name from the configuration.\n+     * Get the approval label name from the configuration.\n@@ -156,1 +156,1 @@\n-     * Get the backport disapproval label name from the configuration.\n+     * Get the disapproval label name from the configuration.\n@@ -173,1 +173,1 @@\n-     * Judge whether the change of this PR is an update change.\n+     * Judge whether the change of this PR needs the maintainer's approval.\n@@ -175,1 +175,1 @@\n-    boolean isUpdateChange() {\n+    boolean requiresApproval() {\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/PullRequestWorkItem.java","additions":5,"deletions":5,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -56,1 +56,1 @@\n-        if (!workItem.isUpdateChange()) {\n+        if (!workItem.requiresApproval()) {\n@@ -92,1 +92,1 @@\n-        return \"add a comment to the main issue of an update change\";\n+        return \"add a comment to the main issue of a pull request which needs maintainer's approval\";\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/RequestApprovalCommand.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -92,1 +92,1 @@\n-            \/\/ The update change suggestion should be added.\n+            \/\/ The maintainer's approval suggestion should be added.\n@@ -94,1 +94,1 @@\n-                    .filter(comment -> comment.body().contains(\"<!-- Update change pull request suggestion -->\"))\n+                    .filter(comment -> comment.body().contains(\"<!-- Approval suggestion comment -->\"))\n@@ -97,1 +97,1 @@\n-            \/\/ The progress about the update change should be added to the pr body.\n+            \/\/ The progress about the approval should be added to the pr body.\n@@ -120,1 +120,1 @@\n-            \/\/ The update change suggestion should be added only once.\n+            \/\/ The maintainer's approval suggestion should be added only once.\n@@ -122,1 +122,1 @@\n-                    .filter(comment -> comment.body().contains(\"<!-- Update change pull request suggestion -->\"))\n+                    .filter(comment -> comment.body().contains(\"<!-- Approval suggestion comment -->\"))\n@@ -125,1 +125,1 @@\n-            \/\/ The progress about the update change should be checked.\n+            \/\/ The progress about the maintainer's approval should be checked.\n@@ -154,1 +154,1 @@\n-            \/\/ The update change suggestion should be added only once.\n+            \/\/ The maintainer's approval suggestion should be added only once.\n@@ -156,1 +156,1 @@\n-                    .filter(comment -> comment.body().contains(\"<!-- Update change pull request suggestion -->\"))\n+                    .filter(comment -> comment.body().contains(\"<!-- Approval suggestion comment -->\"))\n@@ -159,1 +159,1 @@\n-            \/\/ The progress about the update change shouldn't be checked.\n+            \/\/ The progress about the maintainer's approval shouldn't be checked.\n@@ -188,1 +188,1 @@\n-            \/\/ The update change suggestion should be added only once.\n+            \/\/ The maintainer's approval suggestion should be added only once.\n@@ -190,1 +190,1 @@\n-                    .filter(comment -> comment.body().contains(\"<!-- Update change pull request suggestion -->\"))\n+                    .filter(comment -> comment.body().contains(\"<!-- Approval suggestion comment -->\"))\n@@ -193,1 +193,1 @@\n-            \/\/ The progress about the update change should be checked.\n+            \/\/ The progress about the maintainer's approval should be checked.\n@@ -267,1 +267,1 @@\n-            \/\/ The update change suggestion should be added.\n+            \/\/ The maintainer's approval suggestion should be added.\n@@ -269,1 +269,1 @@\n-                    .filter(comment -> comment.body().contains(\"<!-- Update change pull request suggestion -->\"))\n+                    .filter(comment -> comment.body().contains(\"<!-- Approval suggestion comment -->\"))\n@@ -272,1 +272,1 @@\n-            \/\/ The progress about the update change should be added to the pr body.\n+            \/\/ The progress about the maintainer's approval should be added to the pr body.\n@@ -294,1 +294,1 @@\n-            \/\/ The update change suggestion should be added only once.\n+            \/\/ The maintainer's approval suggestion should be added only once.\n@@ -296,1 +296,1 @@\n-                    .filter(comment -> comment.body().contains(\"<!-- Update change pull request suggestion -->\"))\n+                    .filter(comment -> comment.body().contains(\"<!-- Approval suggestion comment -->\"))\n@@ -299,1 +299,1 @@\n-            \/\/ The progress about the update change should be checked.\n+            \/\/ The progress about the maintainer's approval should be checked.\n@@ -344,1 +344,1 @@\n-            \/\/ The update change suggestion should be added.\n+            \/\/ The maintainer's approval suggestion should be added.\n@@ -346,1 +346,1 @@\n-                    .filter(comment -> comment.body().contains(\"<!-- Update change pull request suggestion -->\"))\n+                    .filter(comment -> comment.body().contains(\"<!-- Approval suggestion comment -->\"))\n@@ -349,1 +349,1 @@\n-            \/\/ The progress about the update change should be added to the pr body.\n+            \/\/ The progress about the maintainer's approval should be added to the pr body.\n@@ -371,1 +371,1 @@\n-            \/\/ The update change suggestion should be added only once.\n+            \/\/ The maintainer's approval suggestion should be added only once.\n@@ -373,1 +373,1 @@\n-                    .filter(comment -> comment.body().contains(\"<!-- Update change pull request suggestion -->\"))\n+                    .filter(comment -> comment.body().contains(\"<!-- Approval suggestion comment -->\"))\n@@ -376,1 +376,1 @@\n-            \/\/ The progress about the update change shouldn't be checked.\n+            \/\/ The progress about the maintainer's approval shouldn't be checked.\n@@ -448,2 +448,2 @@\n-                    .filter(comment -> comment.body().contains(\"this repository or the target branch \"\n-                            + \"of this pull request have not been configured to use the `approval` command\"))\n+                    .filter(comment -> comment.body().contains(\"the `approval` command can only be used on \"\n+                            + \"pull requests targeting branches and repositories that require approval.\"))\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/ApprovalCommandTests.java","additions":26,"deletions":26,"binary":false,"changes":52,"status":"modified"},{"patch":"@@ -42,1 +42,0 @@\n-import static org.junit.jupiter.api.Assumptions.assumeTrue;\n@@ -2208,1 +2207,1 @@\n-    void testUpdateChange(TestInfo testInfo) throws IOException {\n+    void testApprovalRequest(TestInfo testInfo) throws IOException {\n@@ -2243,1 +2242,1 @@\n-            \/\/ The update change suggestion should be added.\n+            \/\/ The maintainer's approval suggestion should be added.\n@@ -2245,1 +2244,1 @@\n-                    .filter(comment -> comment.body().contains(\"<!-- Update change pull request suggestion -->\"))\n+                    .filter(comment -> comment.body().contains(\"<!-- Approval suggestion comment -->\"))\n@@ -2248,1 +2247,1 @@\n-            \/\/ The progress about the update change should be added to the pr body.\n+            \/\/ The progress about the maintainer's approval should be added to the pr body.\n@@ -2264,1 +2263,1 @@\n-            \/\/ The update change suggestion should be added only once.\n+            \/\/ The maintainer's approval suggestion should be added only once.\n@@ -2266,1 +2265,1 @@\n-                    .filter(comment -> comment.body().contains(\"<!-- Update change pull request suggestion -->\"))\n+                    .filter(comment -> comment.body().contains(\"<!-- Approval suggestion comment -->\"))\n@@ -2269,1 +2268,1 @@\n-            \/\/ The progress about the update change shouldn't be checked.\n+            \/\/ The progress about the maintainer's approval shouldn't be checked.\n@@ -2288,1 +2287,1 @@\n-            \/\/ The update change suggestion should be added only once.\n+            \/\/ The maintainer's approval suggestion should be added only once.\n@@ -2290,1 +2289,1 @@\n-                    .filter(comment -> comment.body().contains(\"<!-- Update change pull request suggestion -->\"))\n+                    .filter(comment -> comment.body().contains(\"<!-- Approval suggestion comment -->\"))\n@@ -2293,1 +2292,1 @@\n-            \/\/ The progress about the update change shouldn't be checked.\n+            \/\/ The progress about the maintainer's approval shouldn't be checked.\n@@ -2315,1 +2314,1 @@\n-            \/\/ The update change suggestion should be added only once.\n+            \/\/ The maintainer's approval suggestion should be added only once.\n@@ -2317,1 +2316,1 @@\n-                    .filter(comment -> comment.body().contains(\"<!-- Update change pull request suggestion -->\"))\n+                    .filter(comment -> comment.body().contains(\"<!-- Approval suggestion comment -->\"))\n@@ -2320,1 +2319,1 @@\n-            \/\/ The progress about the update change shouldn't be checked.\n+            \/\/ The progress about the maintainer's approval shouldn't be checked.\n@@ -2339,1 +2338,1 @@\n-    void testUpdateChangeApproval(TestInfo testInfo) throws IOException {\n+    void testApprovalAndDisapproval(TestInfo testInfo) throws IOException {\n@@ -2390,1 +2389,1 @@\n-            \/\/ The update change suggestion should be added only once.\n+            \/\/ The maintainer's approval suggestion should be added only once.\n@@ -2392,1 +2391,1 @@\n-                    .filter(comment -> comment.body().contains(\"<!-- Update change pull request suggestion -->\"))\n+                    .filter(comment -> comment.body().contains(\"<!-- Approval suggestion comment -->\"))\n@@ -2395,1 +2394,1 @@\n-            \/\/ The progress about the update change should be checked.\n+            \/\/ The progress about the maintainer's approval should be checked.\n@@ -2426,1 +2425,1 @@\n-            \/\/ The update change suggestion should be added only once.\n+            \/\/ The maintainer's approval suggestion should be added only once.\n@@ -2428,1 +2427,1 @@\n-                    .filter(comment -> comment.body().contains(\"<!-- Update change pull request suggestion -->\"))\n+                    .filter(comment -> comment.body().contains(\"<!-- Approval suggestion comment -->\"))\n@@ -2431,1 +2430,1 @@\n-            \/\/ The progress about the update change shouldn't be checked.\n+            \/\/ The progress about the maintainer's approval shouldn't be checked.\n@@ -2464,1 +2463,1 @@\n-            \/\/ The update change suggestion should be added only once.\n+            \/\/ The maintainer's approval suggestion should be added only once.\n@@ -2466,1 +2465,1 @@\n-                    .filter(comment -> comment.body().contains(\"<!-- Update change pull request suggestion -->\"))\n+                    .filter(comment -> comment.body().contains(\"<!-- Approval suggestion comment -->\"))\n@@ -2469,1 +2468,1 @@\n-            \/\/ The progress about the update change should be checked.\n+            \/\/ The progress about the maintainer's approval should be checked.\n@@ -2490,1 +2489,1 @@\n-    void testNotUpdateChange(TestInfo testInfo) throws IOException {\n+    void testNotNeedApproval(TestInfo testInfo) throws IOException {\n@@ -2531,1 +2530,1 @@\n-            \/\/ The update change suggestion shouldn't be added.\n+            \/\/ The maintainer's approval suggestion shouldn't be added.\n@@ -2533,1 +2532,1 @@\n-                    .filter(comment -> comment.body().contains(\"<!-- Update change pull request suggestion -->\"))\n+                    .filter(comment -> comment.body().contains(\"<!-- Approval suggestion comment -->\"))\n@@ -2536,1 +2535,1 @@\n-            \/\/ The progress about the update change shouldn't be added to the pr body.\n+            \/\/ The progress about the maintainer's approval shouldn't be added to the pr body.\n@@ -2548,1 +2547,1 @@\n-    void testUpdateChangeWithCleanBackport(TestInfo testInfo) throws IOException {\n+    void testApprovalWithCleanBackport(TestInfo testInfo) throws IOException {\n@@ -2604,1 +2603,1 @@\n-            \/\/ The update change suggestion should be added.\n+            \/\/ The maintainer's approval suggestion should be added.\n@@ -2606,1 +2605,1 @@\n-                    .filter(comment -> comment.body().contains(\"<!-- Update change pull request suggestion -->\"))\n+                    .filter(comment -> comment.body().contains(\"<!-- Approval suggestion comment -->\"))\n@@ -2609,1 +2608,1 @@\n-            \/\/ The progress about the update change should be added to the pr body.\n+            \/\/ The progress about the maintainer's approval should be added to the pr body.\n@@ -2628,1 +2627,1 @@\n-            \/\/ The update change suggestion should be added only once.\n+            \/\/ The maintainer's approval suggestion should be added only once.\n@@ -2630,1 +2629,1 @@\n-                    .filter(comment -> comment.body().contains(\"<!-- Update change pull request suggestion -->\"))\n+                    .filter(comment -> comment.body().contains(\"<!-- Approval suggestion comment -->\"))\n@@ -2633,1 +2632,1 @@\n-            \/\/ The progress about the update change should be added to the pr body.\n+            \/\/ The progress about the maintainer's approval should be added to the pr body.\n@@ -2649,1 +2648,1 @@\n-            \/\/ The update change suggestion should be added only once.\n+            \/\/ The maintainer's approval suggestion should be added only once.\n@@ -2651,1 +2650,1 @@\n-                    .filter(comment -> comment.body().contains(\"<!-- Update change pull request suggestion -->\"))\n+                    .filter(comment -> comment.body().contains(\"<!-- Approval suggestion comment -->\"))\n@@ -2654,1 +2653,1 @@\n-            \/\/ The progress about the update change should be added to the pr body.\n+            \/\/ The progress about the maintainer's approval should be added to the pr body.\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/CheckTests.java","additions":37,"deletions":38,"binary":false,"changes":75,"status":"modified"}]}