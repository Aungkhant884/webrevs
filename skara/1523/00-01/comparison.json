{"files":[{"patch":"@@ -48,1 +48,1 @@\n-    private final Map<String, List<String>> issuePRMap;\n+    private final Map<String, List<PRRecord>> issuePRMap;\n@@ -52,1 +52,1 @@\n-                       Map<String, List<String>> issuePRMap) {\n+                       Map<String, List<PRRecord>> issuePRMap) {\n@@ -97,1 +97,1 @@\n-    PullRequestBot getPRBot(String repo){\n+    PullRequestBot getPRBot(String repo) {\n@@ -101,1 +101,1 @@\n-    Map<String, List<String>> issuePRMap() {\n+    Map<String, List<PRRecord>> issuePRMap() {\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CSRIssueBot.java","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -100,3 +100,3 @@\n-                .flatMap(id -> bot.repositories().stream()\n-                        .filter(r -> r.name().equals(id.split(\"#\")[0]))\n-                        .map(r -> r.pullRequest(id.split(\"#\")[1]))\n+                .flatMap(record -> bot.repositories().stream()\n+                        .filter(r -> r.name().equals(record.repoName()))\n+                        .map(r -> r.pullRequest(record.prId()))\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CSRIssueWorkItem.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -658,0 +658,1 @@\n+        \/\/ All the issues this pr related(except CSR and JEP)\n@@ -693,1 +694,1 @@\n-                                } else if (\"Bug\".equals(issueType.asString())) {\n+                                } else {\n@@ -702,6 +703,0 @@\n-                                } else if (\"Enhancement\".equals(issueType.asString())) {\n-                                    progressBody.append(\" (**Enhancement**)\");\n-                                    currentIssues.add(iss.get().id());\n-                                } else {\n-                                    progressBody.append(\" (⚠️ Uncommon issue type: \" + issueType.asString() + \")\");\n-                                    currentIssues.add(iss.get().id());\n@@ -745,2 +740,1 @@\n-            var map = workItem.bot.issuePRMap();\n-            var prId = pr.repository().name() + \"#\" + pr.id();\n+            var prRecord = new PRRecord(pr.repository().name(), pr.id());\n@@ -753,5 +747,1 @@\n-                    map.putIfAbsent(issueId, new LinkedList<>());\n-                    List<String> prIds = map.get(issueId);\n-                    if (!prIds.contains(prId)) {\n-                        prIds.add(prId);\n-                    }\n+                    workItem.bot.addIssuePRMapping(issueId, prRecord);\n@@ -763,4 +753,1 @@\n-                    List<String> prIds = map.get(oldIssueId);\n-                    if (prIds != null) {\n-                        prIds.remove(prId);\n-                    }\n+                    workItem.bot.removeIssuePRMapping(oldIssueId, prRecord);\n@@ -769,0 +756,1 @@\n+            log.info(\"Map after updated: \" + workItem.bot.issuePRMap());\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CheckRun.java","additions":6,"deletions":18,"binary":false,"changes":24,"status":"modified"},{"patch":"@@ -206,1 +206,0 @@\n-\n@@ -325,2 +324,2 @@\n-        var prId = pr.repository().name() + \"#\" + pr.id();\n-        if (!bot.initializedPRs().containsKey(prId)) {\n+        var prRecord = new PRRecord(pr.repository().name(), pr.id());\n+        if (!bot.initializedPRs().contains(prId)) {\n@@ -329,5 +328,1 @@\n-                bot.issuePRMap().putIfAbsent(issueId, new ArrayList<>());\n-                List<String> prIds = bot.issuePRMap().get(issueId);\n-                if (!prIds.contains(prId)) {\n-                    prIds.add(prId);\n-                }\n+                bot.addIssuePRMapping(issueId, prRecord);\n@@ -335,1 +330,1 @@\n-            bot.initializedPRs().put(prId, true);\n+            bot.initializedPRs().add(prId);\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CheckWorkItem.java","additions":4,"deletions":9,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -34,0 +34,1 @@\n+import java.util.LinkedList;\n@@ -44,1 +45,1 @@\n-    private final Map<String, List<String>> issuePRMap;\n+    private final Map<String, List<PRRecord>> issuePRMap;\n@@ -48,1 +49,1 @@\n-                    Map<String, List<String>> issuePRMap) {\n+                    Map<String, List<PRRecord>> issuePRMap) {\n@@ -82,3 +83,18 @@\n-        var items = issues.stream()\n-                .map(i -> (WorkItem) new IssueWorkItem(this, i, e -> poller.retryIssue(i)))\n-                .toList();\n+        var items = new LinkedList<WorkItem>();\n+        for (var issue : issues) {\n+            var prRecords = issuePRMap.get(issue.id());\n+            if (prRecords == null) {\n+                continue;\n+            }\n+            prRecords.stream()\n+                    .flatMap(record -> repositories.stream()\n+                            .filter(r -> r.name().equals(record.repoName()))\n+                            .map(r -> r.pullRequest(record.prId()))\n+                    )\n+                    .filter(Issue::isOpen)\n+                    \/\/ This will mix time stamps from the IssueTracker and the Forge hosting PRs, but it's the\n+                    \/\/ best we can do.\n+                    .map(pr -> new CheckWorkItem(pullRequestBotMap.get(pr.repository().name()), pr.id(),\n+                            e -> poller.retryIssue(issue), issue.updatedAt(), true, false, true))\n+                    .forEach(items::add);\n+        }\n@@ -98,5 +114,1 @@\n-    PullRequestBot getPRBot(String repo) {\n-        return pullRequestBotMap.get(repo);\n-    }\n-\n-    Map<String, List<String>> issuePRMap() {\n+    Map<String, List<PRRecord>> issuePRMap() {\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/IssueBot.java","additions":22,"deletions":10,"binary":false,"changes":32,"status":"modified"},{"patch":"@@ -1,117 +0,0 @@\n-\/*\n- * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n- * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n- *\n- * This code is free software; you can redistribute it and\/or modify it\n- * under the terms of the GNU General Public License version 2 only, as\n- * published by the Free Software Foundation.\n- *\n- * This code is distributed in the hope that it will be useful, but WITHOUT\n- * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n- * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n- * version 2 for more details (a copy is included in the LICENSE file that\n- * accompanied this code).\n- *\n- * You should have received a copy of the GNU General Public License version\n- * 2 along with this work; if not, write to the Free Software Foundation,\n- * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n- *\n- * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n- * or visit www.oracle.com if you need additional information or have any\n- * questions.\n- *\/\n-package org.openjdk.skara.bots.pr;\n-\n-import java.nio.file.Path;\n-import java.util.ArrayList;\n-import java.util.Collection;\n-import java.util.function.Consumer;\n-import java.util.logging.Logger;\n-\n-import org.openjdk.skara.bot.WorkItem;\n-import org.openjdk.skara.issuetracker.Issue;\n-\n-\/**\n- * The IssueWorkItem is read-only. Its purpose is to create PullRequestWorkItems for\n- * every pull request associated with an updated issue.\n- * It should only be triggered when an updated issue(exclude CSR and JEP) has been found.\n- *\/\n-class IssueWorkItem implements WorkItem {\n-    private final Logger log = Logger.getLogger(\"org.openjdk.skara.bots.pr\");\n-\n-    private final IssueBot bot;\n-    private final Issue issue;\n-    private final Consumer<RuntimeException> errorHandler;\n-\n-    public IssueWorkItem(IssueBot bot, Issue issue, Consumer<RuntimeException> errorHandler) {\n-        this.bot = bot;\n-        this.issue = issue;\n-        this.errorHandler = errorHandler;\n-    }\n-\n-    @Override\n-    public String toString() {\n-        return botName() + \"\/IssueWorkItem@\" + issue.id();\n-    }\n-\n-    \/**\n-     * Concurrency between IssueWorkItems is ok as long as they aren't processing the\n-     * same issue and are spawned from the same bot instance.\n-     *\/\n-    @Override\n-    public boolean concurrentWith(WorkItem other) {\n-        if (!(other instanceof IssueWorkItem otherItem)) {\n-            return true;\n-        }\n-\n-        if (!issue.project().name().equals(otherItem.issue.project().name())) {\n-            return true;\n-        }\n-\n-        if (!issue.id().equals(otherItem.issue.id())) {\n-            return true;\n-        }\n-\n-        if (!bot.equals(otherItem.bot)) {\n-            return true;\n-        }\n-        return false;\n-    }\n-\n-    @Override\n-    public Collection<WorkItem> run(Path scratchPath) {\n-        var ret = new ArrayList<WorkItem>();\n-\n-        \/\/ Get related prs according to the issue id\n-        var prIds = bot.issuePRMap().get(issue.id());\n-        if (prIds == null) {\n-            return ret;\n-        }\n-        prIds.stream()\n-                .flatMap(id -> bot.repositories().stream()\n-                        .filter(r -> r.name().equals(id.split(\"#\")[0]))\n-                        .map(r -> r.pullRequest(id.split(\"#\")[1]))\n-                )\n-                .filter(Issue::isOpen)\n-                \/\/ This will mix time stamps from the IssueTracker and the Forge hosting PRs, but it's the\n-                \/\/ best we can do.\n-                .map(pr -> new CheckWorkItem(bot.getPRBot(pr.repository().name()), pr.id(), errorHandler, issue.updatedAt(), true, false, true))\n-                .forEach(ret::add);\n-        return ret;\n-    }\n-\n-    @Override\n-    public String botName() {\n-        return bot.name();\n-    }\n-\n-    @Override\n-    public String workItemName() {\n-        return \"issue\";\n-    }\n-\n-    @Override\n-    public void handleRuntimeException(RuntimeException e) {\n-        errorHandler.accept(e);\n-    }\n-}\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/IssueWorkItem.java","additions":0,"deletions":117,"binary":false,"changes":117,"status":"deleted"},{"patch":"@@ -0,0 +1,65 @@\n+\/*\n+ * Copyright (c) 2023 Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+package org.openjdk.skara.bots.pr;\n+\n+import java.util.Objects;\n+\n+public class PRRecord {\n+    private String repoName;\n+    private String prId;\n+\n+    public PRRecord(String repoName, String prId) {\n+        this.repoName = repoName;\n+        this.prId = prId;\n+    }\n+\n+    public String repoName() {\n+        return repoName;\n+    }\n+\n+    public String prId() {\n+        return prId;\n+    }\n+\n+    @Override\n+    public boolean equals(Object obj) {\n+        if (this == obj) {\n+            return true;\n+        }\n+        if (obj == null || getClass() != obj.getClass()) {\n+            return false;\n+        }\n+        var other = (PRRecord) obj;\n+        return repoName.equals(other.repoName) && prId.equals(other.prId);\n+    }\n+\n+    @Override\n+    public int hashCode() {\n+        return Objects.hash(repoName, prId);\n+    }\n+\n+    @Override\n+    public String toString() {\n+        return repoName + \"#\" + prId;\n+    }\n+}\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/PRRecord.java","additions":65,"deletions":0,"binary":false,"changes":65,"status":"added"},{"patch":"@@ -76,2 +76,2 @@\n-    private final Map<String, List<String>> issuePRMap;\n-    private final Map<String, Boolean> initializedPRs = new ConcurrentHashMap<>();\n+    private final Map<String, List<PRRecord>> issuePRMap;\n+    private final Set<String> initializedPRs = new HashSet<>();\n@@ -92,1 +92,1 @@\n-                   Map<String, List<String>> issuePRMap) {\n+                   Map<String, List<PRRecord>> issuePRMap) {\n@@ -332,1 +332,1 @@\n-    public Map<String, List<String>> issuePRMap() {\n+    public Map<String, List<PRRecord>> issuePRMap() {\n@@ -336,1 +336,20 @@\n-    public Map<String, Boolean> initializedPRs() {\n+    public void addIssuePRMapping(String issueId, PRRecord prRecord) {\n+        issuePRMap.putIfAbsent(issueId, new LinkedList<>());\n+        synchronized (issuePRMap.get(issueId)) {\n+            List<PRRecord> prRecords = issuePRMap.get(issueId);\n+            if (!prRecords.contains(prRecord)) {\n+                prRecords.add(prRecord);\n+            }\n+        }\n+    }\n+\n+    public void removeIssuePRMapping(String issueId, PRRecord prRecord) {\n+        if (issuePRMap.get(issueId) != null) {\n+            synchronized (issuePRMap.get(issueId)) {\n+                List<PRRecord> prRecords = issuePRMap.get(issueId);\n+                prRecords.remove(prRecord);\n+            }\n+        }\n+    }\n+\n+    public Set<String> initializedPRs() {\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/PullRequestBot.java","additions":24,"deletions":5,"binary":false,"changes":29,"status":"modified"},{"patch":"@@ -67,1 +67,1 @@\n-    private Map<String, List<String>> issuePRMap;\n+    private Map<String, List<PRRecord>> issuePRMap;\n@@ -237,1 +237,1 @@\n-    public PullRequestBotBuilder issuePRMap(Map<String, List<String>> issuePRMap) {\n+    public PullRequestBotBuilder issuePRMap(Map<String, List<PRRecord>> issuePRMap) {\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/PullRequestBotBuilder.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -49,1 +49,1 @@\n-        var issueProjectToIssuePRMapMap = new HashMap<IssueProject, Map<String, List<String>>>();\n+        var issueProjectToIssuePRMapMap = new HashMap<IssueProject, Map<String, List<PRRecord>>>();\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/PullRequestBotFactory.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -59,1 +59,1 @@\n-            Map<String, List<String>> issuePRMap = new HashMap<>();\n+            Map<String, List<PRRecord>> issuePRMap = new HashMap<>();\n@@ -203,1 +203,1 @@\n-            Map<String, List<String>> issuePRMap = new HashMap<>();\n+            Map<String, List<PRRecord>> issuePRMap = new HashMap<>();\n@@ -255,1 +255,1 @@\n-            Map<String, List<String>> issuePRMap = new HashMap<>();\n+            Map<String, List<PRRecord>> issuePRMap = new HashMap<>();\n@@ -308,1 +308,1 @@\n-            Map<String, List<String>> issuePRMap = new HashMap<>();\n+            Map<String, List<PRRecord>> issuePRMap = new HashMap<>();\n@@ -355,1 +355,1 @@\n-            Map<String, List<String>> issuePRMap = new HashMap<>();\n+            Map<String, List<PRRecord>> issuePRMap = new HashMap<>();\n@@ -537,1 +537,1 @@\n-            Map<String, List<String>> issuePRMap = new HashMap<>();\n+            Map<String, List<PRRecord>> issuePRMap = new HashMap<>();\n@@ -639,1 +639,1 @@\n-            Map<String, List<String>> issuePRMap = new HashMap<>();\n+            Map<String, List<PRRecord>> issuePRMap = new HashMap<>();\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/CSRBotTests.java","additions":7,"deletions":7,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -475,1 +475,1 @@\n-            Map<String, List<String>> issuePRMap = new HashMap<>();\n+            Map<String, List<PRRecord>> issuePRMap = new HashMap<>();\n@@ -561,1 +561,1 @@\n-            Map<String, List<String>> issuePRMap = new HashMap<>();\n+            Map<String, List<PRRecord>> issuePRMap = new HashMap<>();\n@@ -808,1 +808,1 @@\n-            Map<String, List<String>> issuePRMap = new HashMap<>();\n+            Map<String, List<PRRecord>> issuePRMap = new HashMap<>();\n@@ -1072,1 +1072,1 @@\n-            Map<String, List<String>> issuePRMap = new HashMap<>();\n+            Map<String, List<PRRecord>> issuePRMap = new HashMap<>();\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/CSRCommandTests.java","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -805,1 +805,1 @@\n-            Map<String, List<String>> issuePRMap = new HashMap<>();\n+            Map<String, List<PRRecord>> issuePRMap = new HashMap<>();\n@@ -872,1 +872,1 @@\n-            Map<String, List<String>> issuePRMap = new HashMap<>();\n+            Map<String, List<PRRecord>> issuePRMap = new HashMap<>();\n@@ -975,1 +975,1 @@\n-            Map<String, List<String>> issuePRMap = new HashMap<>();\n+            Map<String, List<PRRecord>> issuePRMap = new HashMap<>();\n@@ -1059,1 +1059,1 @@\n-            Map<String, List<String>> issuePRMap = new HashMap<>();\n+            Map<String, List<PRRecord>> issuePRMap = new HashMap<>();\n@@ -1135,1 +1135,1 @@\n-            Map<String, List<String>> issuePRMap = new HashMap<>();\n+            Map<String, List<PRRecord>> issuePRMap = new HashMap<>();\n@@ -1651,1 +1651,1 @@\n-            Map<String, List<String>> issuePRMap = new HashMap<>();\n+            Map<String, List<PRRecord>> issuePRMap = new HashMap<>();\n@@ -1710,1 +1710,1 @@\n-            Map<String, List<String>> issuePRMap = new HashMap<>();\n+            Map<String, List<PRRecord>> issuePRMap = new HashMap<>();\n@@ -1751,1 +1751,1 @@\n-            Map<String, List<String>> issuePRMap = new HashMap<>();\n+            Map<String, List<PRRecord>> issuePRMap = new HashMap<>();\n@@ -1843,1 +1843,1 @@\n-            Map<String, List<String>> issuePRMap = new HashMap<>();\n+            Map<String, List<PRRecord>> issuePRMap = new HashMap<>();\n@@ -2016,1 +2016,1 @@\n-            Map<String, List<String>> issuePRMap = new HashMap<>();\n+            Map<String, List<PRRecord>> issuePRMap = new HashMap<>();\n@@ -2223,1 +2223,1 @@\n-            Map<String, List<String>> issuePRMap = new HashMap<>();\n+            Map<String, List<PRRecord>> issuePRMap = new HashMap<>();\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/CheckTests.java","additions":11,"deletions":11,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -58,1 +58,1 @@\n-            Map<String, List<String>> issuePRMap = new HashMap<>();\n+            Map<String, List<PRRecord>> issuePRMap = new HashMap<>();\n@@ -161,1 +161,1 @@\n-            Map<String, List<String>> issuePRMap = new HashMap<>();\n+            Map<String, List<PRRecord>> issuePRMap = new HashMap<>();\n@@ -225,1 +225,1 @@\n-            Map<String, List<String>> issuePRMap = new HashMap<>();\n+            Map<String, List<PRRecord>> issuePRMap = new HashMap<>();\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/IssueBotTests.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"}]}