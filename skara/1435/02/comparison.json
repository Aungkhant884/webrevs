{"files":[{"patch":"@@ -26,0 +26,1 @@\n+\n@@ -45,9 +46,2 @@\n-        try {\n-            confFile = pr.repository().fileContents(\".jcheck\/conf\", pr.headHash().hex());\n-        } catch (UncheckedRestException e) {\n-            if (e.getStatusCode() == 404) {\n-                confFile = pr.repository().fileContents(\".jcheck\/conf\", pr.targetRef());\n-            } else {\n-                throw e;\n-            }\n-        }\n+        confFile = pr.repository().fileContents(\".jcheck\/conf\", pr.headHash().hex())\n+                .orElse(pr.repository().fileContents(\".jcheck\/conf\", pr.targetRef()).orElseThrow());\n","filename":"bots\/common\/src\/main\/java\/org\/openjdk\/skara\/bots\/common\/BotUtils.java","additions":3,"deletions":9,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -395,1 +395,2 @@\n-                    var contents = pr.repository().fileContents(reviewComment.path(), reviewComment.hash().get().hex()).lines().collect(Collectors.toList());\n+                    var contents = pr.repository().fileContents(reviewComment.path(), reviewComment.hash().get().hex())\n+                            .orElseThrow().lines().collect(Collectors.toList());\n","filename":"bots\/mlbridge\/src\/main\/java\/org\/openjdk\/skara\/bots\/mlbridge\/ArchiveMessages.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -79,1 +79,1 @@\n-        var confFile = remoteRepo.fileContents(\".jcheck\/conf\", ref);\n+        var confFile = remoteRepo.fileContents(\".jcheck\/conf\", ref).orElseThrow();\n","filename":"bots\/mlbridge\/src\/main\/java\/org\/openjdk\/skara\/bots\/mlbridge\/CensusInstance.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -55,1 +55,1 @@\n-            confOverride = jcheckRepo.fileContents(jcheckName, jcheckRef).lines().collect(Collectors.toList());\n+            confOverride = jcheckRepo.fileContents(jcheckName, jcheckRef).orElseThrow().lines().collect(Collectors.toList());\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CheckablePullRequest.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -73,6 +73,3 @@\n-        try {\n-            conf = Optional.of(Arrays.stream(remoteRepo.fileContents(name, ref).split(\"\\n\")).toList());\n-        } catch (UncheckedRestException e) {\n-            if (e.getStatusCode() != 404) {\n-                throw e;\n-            }\n+        var contents = remoteRepo.fileContents(name, ref);\n+        if (contents.isPresent()) {\n+            conf = Optional.of(Arrays.stream(contents.get().split(\"\\n\")).toList());\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/LimitedCensusInstance.java","additions":3,"deletions":6,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -2383,1 +2383,0 @@\n-            \/\/ Check the status (should become ready immediately as reviewercount is overridden to 0)\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/CheckTests.java","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -101,1 +101,1 @@\n-                var jcheckConf = repo.fileContents(\".jcheck\/conf\", Branch.defaultFor(VCS.GIT).name());\n+                var jcheckConf = repo.fileContents(\".jcheck\/conf\", Branch.defaultFor(VCS.GIT).name()).orElseThrow();\n","filename":"bots\/tester\/src\/main\/java\/org\/openjdk\/skara\/bots\/tester\/TestBot.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -31,0 +31,1 @@\n+import javax.swing.text.html.Option;\n@@ -132,2 +133,2 @@\n-    public String fileContents(String filename, String ref) {\n-        return null;\n+    public Optional<String> fileContents(String filename, String ref) {\n+        return Optional.empty();\n","filename":"bots\/tester\/src\/test\/java\/org\/openjdk\/skara\/bots\/tester\/InMemoryHostedRepository.java","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -230,1 +230,1 @@\n-        var contributorsData = repository.fileContents(\"contributors.xml\", ref);\n+        var contributorsData = repository.fileContents(\"contributors.xml\", ref).orElseThrow();\n@@ -232,1 +232,1 @@\n-        var namespaceData = repository.fileContents(\"namespaces\/\" + name + \".xml\", ref);\n+        var namespaceData = repository.fileContents(\"namespaces\/\" + name + \".xml\", ref).orElseThrow();\n","filename":"census\/src\/main\/java\/org\/openjdk\/skara\/census\/Census.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -111,1 +111,2 @@\n-        var rules = skaraRemoteRepo.fileContents(\"config\/mailinglist\/rules\/jdk.json\", Branch.defaultFor(VCS.GIT).name());\n+        var rules = skaraRemoteRepo\n+                .fileContents(\"config\/mailinglist\/rules\/jdk.json\", Branch.defaultFor(VCS.GIT).name()).orElseThrow();\n","filename":"cli\/src\/main\/java\/org\/openjdk\/skara\/cli\/pr\/GitPrCreate.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -85,1 +85,5 @@\n-    String fileContents(String filename, String ref);\n+\n+    \/**\n+     * Returns contents of the file, if the file does not exist, returns Optional.empty().\n+     *\/\n+    Optional<String> fileContents(String filename, String ref);\n","filename":"forge\/src\/main\/java\/org\/openjdk\/skara\/forge\/HostedRepository.java","additions":5,"deletions":1,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -49,1 +49,1 @@\n-        var contents = repository.fileContents(filename, ref);\n+        var contents = repository.fileContents(filename, ref).orElseThrow();\n","filename":"forge\/src\/main\/java\/org\/openjdk\/skara\/forge\/LabelConfigurationHostedRepository.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -112,1 +112,1 @@\n-        var jsonText = repository.fileContents(filename, ref);\n+        var jsonText = repository.fileContents(filename, ref).orElseThrow();\n","filename":"forge\/src\/main\/java\/org\/openjdk\/skara\/forge\/LabelConfigurationJson.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -264,4 +264,13 @@\n-    public String fileContents(String filename, String ref) {\n-        var conf = request.get(\"contents\/\" + filename)\n-                          .param(\"ref\", ref)\n-                          .execute().asObject();\n+    public Optional<String> fileContents(String filename, String ref) {\n+        JSONValue conf;\n+        try {\n+            conf = request.get(\"contents\/\" + filename)\n+                    .param(\"ref\", ref)\n+                    .execute();\n+        } catch (UncheckedRestException e) {\n+            \/\/ returns Optional.empty() on 404 File Not Found\n+            if (e.getStatusCode() == 404 && e.getBody().contains(\"Not Found\")) {\n+                return Optional.empty();\n+            }\n+            throw e;\n+        }\n@@ -269,3 +278,3 @@\n-        return conf.get(\"content\").asString().lines()\n-                   .map(line -> new String(Base64.getDecoder().decode(line), StandardCharsets.UTF_8))\n-                   .collect(Collectors.joining());\n+        return Optional.of(conf.asObject().get(\"content\").asString().lines()\n+                .map(line -> new String(Base64.getDecoder().decode(line), StandardCharsets.UTF_8))\n+                .collect(Collectors.joining()));\n","filename":"forge\/src\/main\/java\/org\/openjdk\/skara\/forge\/github\/GitHubRepository.java","additions":16,"deletions":7,"binary":false,"changes":23,"status":"modified"},{"patch":"@@ -289,1 +289,1 @@\n-    public String fileContents(String filename, String ref) {\n+    public Optional<String> fileContents(String filename, String ref) {\n@@ -291,11 +291,24 @@\n-        var conf = request.get(\"repository\/files\/\" + confName)\n-                          .param(\"ref\", ref)\n-                          .onError(response -> {\n-                              log.warning(\"First time request returned bad status: \" + response.statusCode());\n-                              log.info(\"First time response body: \" + response.body());\n-                              \/\/ Retry once with additional escaping of the path fragment\n-                              var escapedConfName = URLEncoder.encode(confName, StandardCharsets.UTF_8);\n-                              return Optional.of(request.get(\"repository\/files\/\" + escapedConfName)\n-                                            .param(\"ref\", ref).execute());\n-                          })\n-                          .execute();\n+        JSONValue conf = null;\n+        try {\n+            conf = request.get(\"repository\/files\/\" + confName)\n+                    .param(\"ref\", ref)\n+                    .onError(response -> {\n+                        \/\/ Retry once with additional escaping of the path fragment\n+                        \/\/ Only retry when the error is exactly \"File Not Found\"\n+                        if (response.statusCode() == 404 && response.body().contains(\"File Not Found\")) {\n+                            log.warning(\"First time request returned bad status: \" + response.statusCode());\n+                            log.info(\"First time response body: \" + response.body());\n+                            var escapedConfName = URLEncoder.encode(confName, StandardCharsets.UTF_8);\n+                            return Optional.of(request.get(\"repository\/files\/\" + escapedConfName)\n+                                    .param(\"ref\", ref).execute());\n+                        }\n+                        return Optional.empty();\n+                    })\n+                    .execute();\n+        } catch (UncheckedRestException e) {\n+            \/\/ After retry, if the error is still 404 File Not Found, return Optional.empty().\n+            if (e.getStatusCode() == 404 && e.getBody().contains(\"File Not Found\")) {\n+                return Optional.empty();\n+            }\n+            throw e;\n+        }\n@@ -303,1 +316,1 @@\n-        return new String(content, StandardCharsets.UTF_8);\n+        return Optional.of(new String(content, StandardCharsets.UTF_8));\n","filename":"forge\/src\/main\/java\/org\/openjdk\/skara\/forge\/gitlab\/GitLabRepository.java","additions":26,"deletions":13,"binary":false,"changes":39,"status":"modified"},{"patch":"@@ -377,1 +377,2 @@\n-            throw new UncheckedRestException(\"Request returned bad status: \" + response.statusCode(), response.statusCode());\n+            throw new UncheckedRestException(\"Request returned bad status: \" + response.statusCode(),\n+                    response.statusCode(), response.body());\n","filename":"network\/src\/main\/java\/org\/openjdk\/skara\/network\/RestRequest.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -11,1 +11,3 @@\n-    public UncheckedRestException(String message, int statusCode) {\n+    String body;\n+\n+    public UncheckedRestException(String message, int statusCode, String body) {\n@@ -14,0 +16,1 @@\n+        this.body = body;\n@@ -19,0 +22,4 @@\n+\n+    public String getBody() {\n+        return body;\n+    }\n","filename":"network\/src\/main\/java\/org\/openjdk\/skara\/network\/UncheckedRestException.java","additions":8,"deletions":1,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -200,1 +200,1 @@\n-    public String fileContents(String filename, String ref) {\n+    public Optional<String> fileContents(String filename, String ref) {\n@@ -203,1 +203,1 @@\n-            return String.join(\"\\n\", lines.orElseThrow());\n+            return Optional.of(String.join(\"\\n\", lines.orElseThrow()));\n@@ -207,2 +207,1 @@\n-            \/\/ Make this method behave more like other remote repo implementations\n-            throw new UncheckedRestException(\"Can't find file \" + filename, 404);\n+            return Optional.empty();\n","filename":"test\/src\/main\/java\/org\/openjdk\/skara\/test\/TestHostedRepository.java","additions":3,"deletions":4,"binary":false,"changes":7,"status":"modified"}]}