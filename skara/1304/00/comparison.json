{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2018, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2018, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -844,2 +844,11 @@\n-        var endpoint = \"\/\" + repository.name() + \"\/-\/merge_requests\/\" + id() + \"\/diffs?commit_id=\" + hash.hex();\n-        return host.getWebUri(endpoint);\n+        var versionId = request.get(\"versions\").execute().stream()\n+                               .filter(version -> hash.hex().equals(version.get(\"head_commit_sha\").asString()))\n+                               .map(version -> String.valueOf(version.get(\"id\").asInt()))\n+                               .findFirst();\n+        String uri;\n+        if (versionId.isEmpty()) {\n+            uri = \"\/\" + repository.name() + \"\/-\/merge_requests\/\" + id() + \"\/diffs?commit_id=\" + hash.hex();\n+        } else {\n+            uri = \"\/\" + repository.name() + \"\/-\/merge_requests\/\" + id() + \"\/diffs?diff_id=\" + versionId.get();\n+        }\n+        return host.getWebUri(uri);\n","filename":"forge\/src\/main\/java\/org\/openjdk\/skara\/forge\/gitlab\/GitLabMergeRequest.java","additions":12,"deletions":3,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -55,2 +55,2 @@\n-        var username = settings.getProperty(\"username\");\n-        var token = settings.getProperty(\"token\");\n+        var username = settings.getProperty(\"github.user\");\n+        var token = settings.getProperty(\"github.pat\");\n","filename":"forge\/src\/test\/java\/org\/openjdk\/skara\/forge\/github\/GitHubRestApiTests.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -0,0 +1,62 @@\n+\/*\n+ * Copyright (c) 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+package org.openjdk.skara.forge.gitlab;\n+\n+import org.junit.jupiter.api.Disabled;\n+import org.junit.jupiter.api.Test;\n+import org.openjdk.skara.host.Credential;\n+import org.openjdk.skara.network.URIBuilder;\n+import org.openjdk.skara.test.ManualTestSettings;\n+import org.openjdk.skara.vcs.Hash;\n+\n+import java.io.IOException;\n+import java.util.Set;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+\/**\n+ * To be able to run the tests, you need to remove or comment out the @Disabled annotation first.\n+ *\/\n+@Disabled(\"Manual\")\n+public class GitLabRestApiTest {\n+\n+    @Test\n+    void testFilesUrl() throws IOException {\n+        var settings = ManualTestSettings.loadManualTestSettings();\n+        var username = settings.getProperty(\"gitlab.user\");\n+        var token = settings.getProperty(\"gitlab.pat\");\n+        var credential = new Credential(username, token);\n+        var uri = URIBuilder.base(settings.getProperty(\"gitlab.uri\")).build();\n+        var gitLabHost = new GitLabHost(\"gitlab\", uri, false, credential, Set.of());\n+        var gitLabRepo = gitLabHost.repository(settings.getProperty(\"gitlab.repository\")).orElseThrow();\n+        var gitLabMergeRequest = gitLabRepo.pullRequest(settings.getProperty(\"gitlab.merge.request.id\"));\n+\n+        \/\/ Test a version hash\n+        var versionUrl = gitLabMergeRequest.filesUrl(new Hash(settings.getProperty(\"gitlab.version.hash\")));\n+        assertEquals(settings.getProperty(\"gitlab.version.url\"), versionUrl.toString());\n+\n+        \/\/ Test a non-version hash\n+        var nonVersionUrl = gitLabMergeRequest.filesUrl(new Hash(settings.getProperty(\"gitlab.nonversion.hash\")));\n+        assertEquals(settings.getProperty(\"gitlab.nonversion.url\"), nonVersionUrl.toString());\n+    }\n+}\n","filename":"forge\/src\/test\/java\/org\/openjdk\/skara\/forge\/gitlab\/GitLabRestApiTest.java","additions":62,"deletions":0,"binary":false,"changes":62,"status":"added"}]}