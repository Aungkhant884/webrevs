{"files":[{"patch":"@@ -34,0 +34,1 @@\n+import java.time.*;\n@@ -63,0 +64,2 @@\n+    private Instant lastFullUpdate;\n+\n@@ -91,2 +94,5 @@\n-        this.currentLabels = new ConcurrentHashMap<>();\n-        this.updateCache = new PullRequestUpdateCache();\n+        currentLabels = new ConcurrentHashMap<>();\n+        updateCache = new PullRequestUpdateCache();\n+\n+        \/\/ Only check recently updated when starting up to avoid congestion\n+        lastFullUpdate = Instant.now();\n@@ -133,1 +139,1 @@\n-            if (updateCache.needsUpdate(pr)) {\n+            if (updateCache.needsUpdate(pr, Duration.ofMinutes(5))) {\n@@ -147,1 +153,13 @@\n-        return getWorkItems(remoteRepo.pullRequests());\n+        List<PullRequest> prs;\n+\n+        if (lastFullUpdate == null || lastFullUpdate.isBefore(Instant.now().minus(Duration.ofMinutes(10)))) {\n+            lastFullUpdate = Instant.now();\n+            log.info(\"Fetching all open pull requests\");\n+            prs = remoteRepo.pullRequests();\n+        } else {\n+            log.info(\"Fetching recently updated pull requests (open and closed)\");\n+            prs = remoteRepo.pullRequests(ZonedDateTime.now().minus(Duration.ofDays(1)));\n+        }\n+\n+\n+        return getWorkItems(prs);\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/PullRequestBot.java","additions":22,"deletions":4,"binary":false,"changes":26,"status":"modified"},{"patch":"@@ -27,1 +27,1 @@\n-import java.time.ZonedDateTime;\n+import java.time.*;\n@@ -36,0 +36,4 @@\n+        return needsUpdate(pr, Duration.ofHours(1));\n+    }\n+\n+    public synchronized boolean needsUpdate(PullRequest pr, Duration maxAge) {\n@@ -45,0 +49,1 @@\n+            log.info(\"Pull request not found in update cache - needs update \" + pr.repository().name() + \"#\" + pr.id());\n@@ -50,0 +55,6 @@\n+            log.info(\"Pull request has been updated - needs update \" + pr.repository().name() + \"#\" + pr.id());\n+            lastUpdates.put(uniqueId, update);\n+            return true;\n+        }\n+        if (lastUpdate.plus(maxAge).isBefore(ZonedDateTime.now())) {\n+            log.info(\"Pull request update cache entry has expired - needs update \" + pr.repository().name() + \"#\" + pr.id());\n","filename":"forge\/src\/main\/java\/org\/openjdk\/skara\/forge\/PullRequestUpdateCache.java","additions":12,"deletions":1,"binary":false,"changes":13,"status":"modified"}]}