{"files":[{"patch":"@@ -28,0 +28,1 @@\n+import org.gradle.api.GradleException;\n@@ -36,0 +37,11 @@\n+    private static boolean setProxyHostAndPortBasedOn(String protocol, URI uri) {\n+        var port = String.valueOf(uri.getPort() == -1 ? 80 : uri.getPort());\n+        if (System.getProperty(protocol + \".proxyHost\") == null) {\n+            System.setProperty(protocol + \".proxyHost\", uri.getHost());\n+            System.setProperty(protocol + \".proxyPort\", port);\n+            return true;\n+        }\n+\n+        return false;\n+    }\n+\n@@ -37,0 +49,1 @@\n+        var hasSetProxy = false;\n@@ -41,1 +54,1 @@\n-                var protocol = key.split(\"_\")[0];\n+                var protocol = key.split(\"_\")[0].toLowerCase();\n@@ -43,4 +56,3 @@\n-                    var uri = new URI(value);\n-                    if (System.getProperty(protocol + \".proxyHost\") == null && uri.getHost() != null) {\n-                        System.setProperty(protocol + \".proxyHost\", uri.getHost());\n-                        System.setProperty(protocol + \".proxyPort\", String.valueOf(uri.getPort()));\n+                    if (!value.startsWith(\"http:\/\/\") && !value.startsWith(\"https:\/\/\")) {\n+                        \/\/ Try to parse it as a http url - we only care about the host and port\n+                        value = \"http:\/\/\" + value;\n@@ -48,0 +60,2 @@\n+                    var uri = new URI(value);\n+                    hasSetProxy |= setProxyHostAndPortBasedOn(protocol, uri);\n@@ -49,1 +63,1 @@\n-                    \/\/ pass\n+                    throw new GradleException(\"Could not parse \" + value + \" as an URI\", e);\n@@ -55,5 +69,7 @@\n-        if (no_proxy != null && System.getProperty(\"http.nonProxyHosts\") == null) {\n-            var hosts = Arrays.stream(no_proxy.split(\",\"))\n-                              .map(s -> s.startsWith(\".\") ? \"*\" + s : s)\n-                              .collect(Collectors.toList());\n-            System.setProperty(\"http.nonProxyHosts\", String.join(\"|\", hosts));\n+        if (no_proxy != null) {\n+            if (System.getProperty(\"http.nonProxyHosts\") == null || hasSetProxy) {\n+                var hosts = Arrays.stream(no_proxy.split(\",\"))\n+                                  .map(s -> s.startsWith(\".\") ? \"*\" + s : s)\n+                                  .collect(Collectors.toList());\n+                System.setProperty(\"http.nonProxyHosts\", String.join(\"|\", hosts));\n+            }\n","filename":"buildSrc\/proxy\/src\/main\/java\/org\/openjdk\/skara\/gradle\/proxy\/ProxyPlugin.java","additions":27,"deletions":11,"binary":false,"changes":38,"status":"modified"}]}