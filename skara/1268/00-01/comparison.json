{"files":[{"patch":"@@ -305,0 +305,2 @@\n+        var authHeaders = addAuthHeaders(request);\n+\n@@ -308,3 +310,0 @@\n-                if (authGen != null) {\n-                    request.headers(authGen.getAuthHeaders(request).toArray(new String[0]));\n-                }\n@@ -313,3 +312,6 @@\n-                \/\/ the authorization mechanism a chance to refresh stale tokens.\n-                if (authGen == null || response.statusCode() != 401 || retryCount >= 2) {\n-                    break;\n+                \/\/ the authorization mechanism a chance to refresh stale tokens. Retry if\n+                \/\/ we get a new set of authorization headers.\n+                if (response.statusCode() == 401 && retryCount < 2 && authHeaders != null\n+                        && !authHeaders.equals(addAuthHeaders(request))) {\n+                    log.info(\"Failed authorization for request: \" + request.build().uri()\n+                            + \", retry count: \" + retryCount);\n@@ -317,1 +319,1 @@\n-                    log.info(\"Failed authorization for request: \" + request.build().uri() + \", retry count: \" + retryCount);\n+                    break;\n@@ -340,0 +342,17 @@\n+    \/**\n+     * Adds authorization headers to the request builder. Returns the headers that\n+     * were added or null if no authorization mechanism was defined.\n+     *\/\n+    private List<String> addAuthHeaders(HttpRequest.Builder request) {\n+        if (authGen != null) {\n+            var authHeaders = authGen.getAuthHeaders(request);\n+            for (int i = 0; i < authHeaders.size() - 1; i += 2) {\n+                String name  = authHeaders.get(i);\n+                String value = authHeaders.get(i + 1);\n+                request.setHeader(name, value);\n+            }\n+            return authHeaders;\n+        }\n+        return null;\n+    }\n+\n","filename":"network\/src\/main\/java\/org\/openjdk\/skara\/network\/RestRequest.java","additions":26,"deletions":7,"binary":false,"changes":33,"status":"modified"}]}