{"files":[{"patch":"@@ -173,3 +173,0 @@\n-        var headHash = pr.headHash();\n-        var originalCommits = localRepo.commitMetadata(baseHash, headHash);\n-\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CheckRun.java","additions":0,"deletions":3,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -118,2 +118,12 @@\n-            var headCommit = localRepo.commitMetadata(pr.headHash().hex() + \"^..\" + pr.headHash().hex()).get(0);\n-            author = headCommit.author();\n+            var headHash = pr.headHash();\n+            var headCommit = localRepo.lookup(headHash).get();\n+            var headAuthor = headCommit.author();\n+            var prAuthor = pr.author();\n+            if (!prAuthor.fullName().equals(prAuthor.userName())) {\n+                if (!headAuthor.name().equals(prAuthor.fullName())) {\n+                    throw new CommitFailure(\"The HEAD commit of this pull request, \" + headHash.abbreviate() +\n+                                            \", has a different author, `\" + headAuthor.name() + \"`\" +\n+                                            \", than the author of this pull request: `\" + prAuthor.fullName() + \"`\");\n+                }\n+            }\n+            author = headAuthor;\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CheckablePullRequest.java","additions":12,"deletions":2,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -1633,0 +1633,37 @@\n+\n+    @Test\n+    void differentAuthors(TestInfo testInfo) throws IOException {\n+        try (var credentials = new HostCredentials(testInfo);\n+             var tempFolder = new TemporaryDirectory();\n+             var pushedFolder = new TemporaryDirectory()) {\n+            var author = credentials.getHostedRepository();\n+            var reviewer = credentials.getHostedRepository();\n+            var committer = credentials.getHostedRepository();\n+\n+            var censusBuilder = credentials.getCensusBuilder()\n+                                           .addCommitter(committer.forge().currentUser().id())\n+                                           .addReviewer(reviewer.forge().currentUser().id());\n+            var mergeBot = PullRequestBot.newBuilder().repo(reviewer).censusRepo(censusBuilder.build()).build();\n+\n+            \/\/ Populate the projects repository\n+            var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());\n+            var masterHash = localRepo.resolve(\"master\").orElseThrow();\n+            assertFalse(CheckableRepository.hasBeenEdited(localRepo));\n+            localRepo.push(masterHash, author.url(), \"master\", true);\n+\n+            \/\/ Make a change with a corresponding PR with an empty e-mail\n+            var editHash = CheckableRepository.appendAndCommit(localRepo, \"Content\", \"A commit\", \"A Random User\", \"a.random.user@foo.com\");\n+            localRepo.push(editHash, author.url(), \"refs\/heads\/edit\", true);\n+            var pr = credentials.createPullRequest(author, \"master\", \"edit\", \"This is a pull request\");\n+\n+            \/\/ Run the bot\n+            TestBotRunner.runPeriodicItems(mergeBot);\n+\n+            \/\/ The bot should respond with a failure about different authors\n+            pr = author.pullRequest(pr.id());\n+            assertFalse(pr.labels().contains(\"rfr\"));\n+            assertTrue(pr.body().contains(\"The HEAD commit of this pull request\"));\n+            assertTrue(pr.body().contains(\"has a different author\"));\n+            assertTrue(pr.body().contains(\"than the author of this pull request\"));\n+        }\n+    }\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/CheckTests.java","additions":37,"deletions":0,"binary":false,"changes":37,"status":"modified"},{"patch":"@@ -808,1 +808,2 @@\n-            var editHash = CheckableRepository.appendAndCommit(localRepo, \"Content\", \"A commit\", \"Duke\", \"\");\n+            var authorFullName = author.forge().currentUser().fullName();\n+            var editHash = CheckableRepository.appendAndCommit(localRepo, \"Content\", \"A commit\", authorFullName, \"\");\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/IntegrateTests.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -61,1 +61,3 @@\n-            var editHash = CheckableRepository.appendAndCommit(localRepo);\n+            var authorFullName = author.forge().currentUser().fullName();\n+            var authorEmail = \"ta@none.none\";\n+            var editHash = CheckableRepository.appendAndCommit(localRepo, \"This is a new line\", \"Append commit\", authorFullName, authorEmail);\n@@ -109,2 +111,2 @@\n-                assertEquals(\"testauthor\", headCommit.author().name());\n-                assertEquals(\"ta@none.none\", headCommit.author().email());\n+                assertEquals(authorFullName, headCommit.author().name());\n+                assertEquals(authorEmail, headCommit.author().email());\n@@ -255,1 +257,2 @@\n-            var editHash = CheckableRepository.appendAndCommit(localRepo);\n+            var authorFullName = author.forge().currentUser().fullName();\n+            var editHash = CheckableRepository.appendAndCommit(localRepo, \"This is a new line\", \"Append commit\", authorFullName, \"ta@none.none\");\n@@ -279,1 +282,1 @@\n-            var updateHash = CheckableRepository.appendAndCommit(localRepo,\"Yet more stuff\");\n+            var updateHash = CheckableRepository.appendAndCommit(localRepo, \"Yet more stuff\", \"Append commit\", authorFullName, \"ta@none.none\");\n@@ -490,1 +493,2 @@\n-            var editHash = CheckableRepository.appendAndCommit(localRepo);\n+            var authorFullName = author.forge().currentUser().fullName();\n+            var editHash = CheckableRepository.appendAndCommit(localRepo, \"This is a new line\", \"Append commit\", authorFullName, \"ta@none.none\");\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/SponsorTests.java","additions":10,"deletions":6,"binary":false,"changes":16,"status":"modified"}]}