{"files":[{"patch":"@@ -62,1 +62,1 @@\n-    private static void csrUnneededReply(PrintWriter writer) {\n+    private static void csrUnneededReply(PullRequest pr, PrintWriter writer) {\n@@ -66,0 +66,3 @@\n+        if (pr.labelNames().contains(CSR_LABEL)) {\n+            pr.removeLabel(CSR_LABEL);\n+        }\n@@ -94,6 +97,0 @@\n-            if (!labels.contains(CSR_LABEL)) {\n-                \/\/ FIXME here, the PR may have an approved CSR. We should distinguish the situations\n-                \/\/ of having no csr request and having an approved csr request.\n-                csrUnneededReply(reply);\n-                return;\n-            }\n@@ -103,2 +100,1 @@\n-                pr.removeLabel(CSR_LABEL);\n-                csrUnneededReply(reply);\n+                csrUnneededReply(pr, reply);\n@@ -109,2 +105,1 @@\n-                pr.removeLabel(CSR_LABEL);\n-                csrUnneededReply(reply);\n+                csrUnneededReply(pr, reply);\n@@ -116,2 +111,1 @@\n-                pr.removeLabel(CSR_LABEL);\n-                csrUnneededReply(reply);\n+                csrUnneededReply(pr, reply);\n@@ -123,2 +117,1 @@\n-                pr.removeLabel(CSR_LABEL);\n-                csrUnneededReply(reply);\n+                csrUnneededReply(pr, reply);\n@@ -142,3 +135,2 @@\n-            \/\/ The csr has been withdrawn, the bot should just remove the csr label.\n-            pr.removeLabel(CSR_LABEL);\n-            csrUnneededReply(reply);\n+            \/\/ The csr has been withdrawn, the bot should just remove the csr label and reply the message.\n+            csrUnneededReply(pr, reply);\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CSRCommand.java","additions":10,"deletions":18,"binary":false,"changes":28,"status":"modified"},{"patch":"@@ -833,1 +833,8 @@\n-            \/\/ FIXME here, `\/csr unneeded` is not used because these is a bug at CSRCommand. See the FIXME at CSRCommand.\n+            \/\/ Use `\/csr unneeded`.\n+            pr.addComment(\"\/csr unneeded\");\n+            TestBotRunner.runPeriodicItems(bot);\n+            assertTrue(pr.body().contains(\"- [x] Change requires a CSR request to be approved\"));\n+            assertFalse(pr.labelNames().contains(\"csr\"));\n+            assertLastCommentContains(pr, \"The CSR requirement cannot be removed as there is already a CSR associated \" +\n+                    \"with the main issue of this pull request. Please withdraw the CSR\");\n+            assertLastCommentContains(pr, \"and then use the command `\/csr unneeded` again\");\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/CSRTests.java","additions":8,"deletions":1,"binary":false,"changes":9,"status":"modified"}]}