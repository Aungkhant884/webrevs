{"files":[{"patch":"@@ -35,0 +35,1 @@\n+    public static final String WEBREV_COMMENT_MARKER = \"<!-- mlbridge webrev comment -->\";\n","filename":"bots\/common\/src\/main\/java\/org\/openjdk\/skara\/bots\/common\/PullRequestConstants.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -43,0 +43,1 @@\n+import static org.openjdk.skara.bots.common.PullRequestConstants.WEBREV_COMMENT_MARKER;\n@@ -151,1 +152,0 @@\n-    private static final String webrevCommentMarker = \"<!-- mlbridge webrev comment -->\";\n@@ -161,1 +161,1 @@\n-                               .filter(comment -> comment.body().contains(webrevCommentMarker))\n+                               .filter(comment -> comment.body().contains(WEBREV_COMMENT_MARKER))\n@@ -166,1 +166,1 @@\n-        var comment = webrevCommentMarker + \"\\n\";\n+        var comment = WEBREV_COMMENT_MARKER + \"\\n\";\n","filename":"bots\/mlbridge\/src\/main\/java\/org\/openjdk\/skara\/bots\/mlbridge\/ArchiveWorkItem.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -728,0 +728,2 @@\n+        progressBody.append(\"\\n\\n### Webrev\\n\");\n+        progressBody.append(getWebrevCommentLink());\n@@ -731,0 +733,9 @@\n+    private String getWebrevCommentLink() {\n+        var webrevComment = comments.stream()\n+                .filter(comment -> comment.author().username().equals(\"mlbridge[bot]\"))\n+                .filter(comment -> comment.body().contains(WEBREV_COMMENT_MARKER))\n+                .findFirst();\n+        return webrevComment.map(comment -> \"[Link to Webrev Comment](\" + pr.commentUrl(comment).toString() + \")\")\n+                .orElse(\"Webrev comment has not been available now.\");\n+    }\n+\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CheckRun.java","additions":11,"deletions":0,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -46,0 +46,2 @@\n+import static org.openjdk.skara.bots.common.PullRequestConstants.WEBREV_COMMENT_MARKER;\n+\n@@ -97,0 +99,6 @@\n+            commentString = commentString + comments.stream()\n+                    .filter(comment -> comment.author().username().equals(\"mlbridge[bot]\"))\n+                    .flatMap(comment -> comment.body().lines())\n+                    .filter(line -> line.equals(WEBREV_COMMENT_MARKER))\n+                    .collect(Collectors.joining());\n+\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CheckWorkItem.java","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -2806,0 +2806,45 @@\n+\n+    @Test\n+    void testWebrevLinkinPRBody(TestInfo testInfo) throws IOException {\n+        try (var credentials = new HostCredentials(testInfo);\n+             var tempFolder = new TemporaryDirectory()) {\n+            var author = credentials.getHostedRepository();\n+            var reviewer = credentials.getHostedRepository();\n+            reviewer.forge().currentUser().changeUserName(\"mlbridge[bot]\");\n+\n+            var censusBuilder = credentials.getCensusBuilder()\n+                    .addAuthor(author.forge().currentUser().id())\n+                    .addReviewer(reviewer.forge().currentUser().id());\n+            var seedFolder = tempFolder.path().resolve(\"seed\");\n+            var prBot = PullRequestBot.newBuilder()\n+                    .repo(author)\n+                    .censusRepo(censusBuilder.build())\n+                    .censusLink(\"https:\/\/census.com\/{{contributor}}-profile\")\n+                    .seedStorage(seedFolder)\n+                    .build();\n+\n+            \/\/ Populate the projects repository\n+            var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());\n+            var masterHash = localRepo.resolve(\"master\").orElseThrow();\n+            localRepo.push(masterHash, author.authenticatedUrl(), \"master\", true);\n+\n+            \/\/ Make a change with a corresponding PR\n+            var editHash = CheckableRepository.appendAndCommit(localRepo);\n+            localRepo.push(editHash, author.authenticatedUrl(), \"refs\/heads\/edit\", true);\n+            var pr = credentials.createPullRequest(author, \"master\", \"edit\", \"This is a pull request\");\n+\n+            \/\/ Check the status\n+            TestBotRunner.runPeriodicItems(prBot);\n+\n+            var reviewPr = reviewer.pullRequest(pr.id());\n+            reviewPr.addComment(\"comment1\");\n+\n+            \/\/ This one should not trigger update\n+            TestBotRunner.runPeriodicItems(prBot);\n+\n+            \/\/ Add Webrev comment\n+            reviewPr.addComment(WEBREV_COMMENT_MARKER + \"\\n\" + \"00:Full(1afrv2f)\");\n+            TestBotRunner.runPeriodicItems(prBot);\n+            assertTrue(pr.store().body().contains(\"Link to Webrev Comment\"));\n+        }\n+    }\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/CheckTests.java","additions":45,"deletions":0,"binary":false,"changes":45,"status":"modified"},{"patch":"@@ -166,0 +166,4 @@\n+\n+    public void changeUserName(String username) {\n+        this.username = username;\n+    }\n","filename":"host\/src\/main\/java\/org\/openjdk\/skara\/host\/HostUser.java","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"}]}