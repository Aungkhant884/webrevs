{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2019, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -34,1 +34,2 @@\n-    public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, CommandInvocation command, List<Comment> allComments, PrintWriter reply) {\n+    public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, CommandInvocation command,\n+                       List<Comment> allComments, PrintWriter reply, List<String> labelsToAdd, List<String> labelsToRemove) {\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/AllowCommand.java","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -65,1 +65,2 @@\n-    public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, CommandInvocation command, List<Comment> allComments, PrintWriter reply) {\n+    public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, CommandInvocation command,\n+                       List<Comment> allComments, PrintWriter reply, List<String> labelsToAdd, List<String> labelsToRemove) {\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CSRCommand.java","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2021, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -25,1 +25,0 @@\n-import org.openjdk.skara.forge.HostedCommit;\n@@ -28,2 +27,0 @@\n-import org.openjdk.skara.vcs.*;\n-import org.openjdk.skara.vcs.openjdk.CommitMessageParsers;\n@@ -32,2 +29,0 @@\n-import java.io.IOException;\n-import java.io.UncheckedIOException;\n@@ -35,1 +30,0 @@\n-import java.util.ArrayList;\n@@ -37,2 +31,0 @@\n-import java.util.stream.Collectors;\n-import java.time.format.DateTimeFormatter;\n@@ -56,1 +48,2 @@\n-    public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, CommandInvocation command, List<Comment> allComments, PrintWriter reply)\n+    public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, CommandInvocation command,\n+                       List<Comment> allComments, PrintWriter reply, List<String> labelsToAdd, List<String> labelsToRemove)\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CleanCommand.java","additions":3,"deletions":10,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -36,2 +36,2 @@\n-    default void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, CommandInvocation command, List<Comment> allComments, PrintWriter reply)\n-    {\n+    default void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, CommandInvocation command,\n+                        List<Comment> allComments, PrintWriter reply, List<String> labelsToAdd, List<String> labelsToRemove) {\n@@ -39,16 +39,0 @@\n-\n-    \/**\n-     * Overload the method with a parameter `changeLabelsAfterComment`.\n-     * If the command need to change the labels after commenting to avoid a race condition,\n-     * please use this method with the argument `changeLabelsAfterComment` as true.\n-     * If you don't meet a race condition, please use another method without parameter `changeLabelsAfterComment`,\n-     * and never use this method with the argument `changeLabelsAfterComment` as false.\n-     *\n-     * @param changeLabelsAfterComment just a tag to distinguish another method\n-     * @return the labels to change\n-     *\/\n-    default LabelsToChange handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath,\n-                        CommandInvocation command, List<Comment> allComments, PrintWriter reply, boolean changeLabelsAfterComment) {\n-        return new LabelsToChange(null, null);\n-    }\n-\n@@ -70,4 +54,0 @@\n-\n-    default boolean changeLabelsAfterComment() {\n-        return false;\n-    }\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CommandHandler.java","additions":2,"deletions":22,"binary":false,"changes":24,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2019, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -87,1 +87,2 @@\n-    public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, CommandInvocation command, List<Comment> allComments, PrintWriter reply) {\n+    public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, CommandInvocation command,\n+                       List<Comment> allComments, PrintWriter reply, List<String> labelsToAdd, List<String> labelsToRemove) {\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/ContributorCommand.java","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -75,1 +75,2 @@\n-    public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, CommandInvocation command, List<Comment> allComments, PrintWriter reply) {\n+    public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, CommandInvocation command,\n+                       List<Comment> allComments, PrintWriter reply, List<String> labelsToAdd, List<String> labelsToRemove) {\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/IntegrateCommand.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2019, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -273,1 +273,2 @@\n-    public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, CommandInvocation command, List<Comment> allComments, PrintWriter reply) {\n+    public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, CommandInvocation command,\n+                       List<Comment> allComments, PrintWriter reply, List<String> labelsToAdd, List<String> labelsToRemove) {\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/IssueCommand.java","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -33,1 +33,0 @@\n-import java.util.ArrayList;\n@@ -80,3 +79,2 @@\n-    public LabelsToChange handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath,\n-                       CommandInvocation command, List<Comment> allComments, PrintWriter reply, boolean changeLabelsAfterComment) {\n-        LabelsToChange labelsToChange = new LabelsToChange(new ArrayList<>(), new ArrayList<>());\n+    public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, CommandInvocation command,\n+                       List<Comment> allComments, PrintWriter reply, List<String> labelsToAdd, List<String> labelsToRemove) {\n@@ -85,1 +83,1 @@\n-            return labelsToChange;\n+            return;\n@@ -91,1 +89,1 @@\n-            return labelsToChange;\n+            return;\n@@ -97,1 +95,1 @@\n-                labelsToChange.labelsToRemove().add(JEP_LABEL);\n+                labelsToRemove.add(JEP_LABEL);\n@@ -102,1 +100,1 @@\n-            return labelsToChange;\n+            return;\n@@ -110,1 +108,1 @@\n-            return labelsToChange;\n+            return;\n@@ -119,1 +117,1 @@\n-            return labelsToChange;\n+            return;\n@@ -138,1 +136,1 @@\n-                labelsToChange.labelsToRemove().add(JEP_LABEL);\n+                labelsToRemove.add(JEP_LABEL);\n@@ -145,1 +143,1 @@\n-                labelsToChange.labelsToAdd().add(JEP_LABEL);\n+                labelsToAdd.add(JEP_LABEL);\n@@ -148,1 +146,0 @@\n-        return labelsToChange;\n@@ -160,5 +157,0 @@\n-\n-    @Override\n-    public boolean changeLabelsAfterComment() {\n-        return true;\n-    }\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/JEPCommand.java","additions":10,"deletions":18,"binary":false,"changes":28,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -58,1 +58,2 @@\n-    public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, CommandInvocation command, List<Comment> allComments, PrintWriter reply) {\n+    public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, CommandInvocation command,\n+                       List<Comment> allComments, PrintWriter reply, List<String> labelsToAddExt, List<String> labelsToRemoveExt) {\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/LabelCommand.java","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -1,50 +0,0 @@\n-\/*\n- * Copyright (c) 2022, Oracle and\/or its affiliates. All rights reserved.\n- * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n- *\n- * This code is free software; you can redistribute it and\/or modify it\n- * under the terms of the GNU General Public License version 2 only, as\n- * published by the Free Software Foundation.\n- *\n- * This code is distributed in the hope that it will be useful, but WITHOUT\n- * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n- * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n- * version 2 for more details (a copy is included in the LICENSE file that\n- * accompanied this code).\n- *\n- * You should have received a copy of the GNU General Public License version\n- * 2 along with this work; if not, write to the Free Software Foundation,\n- * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n- *\n- * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n- * or visit www.oracle.com if you need additional information or have any\n- * questions.\n- *\/\n-package org.openjdk.skara.bots.pr;\n-\n-import org.openjdk.skara.forge.PullRequest;\n-\n-import java.util.List;\n-\n-public record LabelsToChange(List<String> labelsToAdd, List<String> labelsToRemove) {\n-    \/**\n-     * Change the labels in the pull request.\n-     * @param pr the pull request\n-     *\/\n-    public void changeLabels(PullRequest pr) {\n-        if (labelsToAdd != null && !labelsToAdd.isEmpty()) {\n-            for (var label : labelsToAdd) {\n-                if (!pr.labelNames().contains(label)) {\n-                    pr.addLabel(label);\n-                }\n-            }\n-        }\n-        if (labelsToRemove != null && !labelsToRemove.isEmpty()) {\n-            for (var label : labelsToRemove) {\n-                if (pr.labelNames().contains(label)) {\n-                    pr.removeLabel(label);\n-                }\n-            }\n-        }\n-    }\n-}\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/LabelsToChange.java","additions":0,"deletions":50,"binary":false,"changes":50,"status":"deleted"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2021, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -25,1 +25,0 @@\n-import org.openjdk.skara.forge.HostedCommit;\n@@ -29,2 +28,0 @@\n-import org.openjdk.skara.vcs.*;\n-import org.openjdk.skara.vcs.openjdk.CommitMessageParsers;\n@@ -33,2 +30,0 @@\n-import java.io.IOException;\n-import java.io.UncheckedIOException;\n@@ -36,1 +31,0 @@\n-import java.util.ArrayList;\n@@ -38,2 +32,0 @@\n-import java.util.stream.Collectors;\n-import java.time.format.DateTimeFormatter;\n@@ -57,1 +49,2 @@\n-    public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, CommandInvocation command, List<Comment> allComments, PrintWriter reply)\n+    public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, CommandInvocation command,\n+                       List<Comment> allComments, PrintWriter reply, List<String> labelsToAdd, List<String> labelsToRemove)\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/OpenCommand.java","additions":3,"deletions":10,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -67,1 +67,2 @@\n-        public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, CommandInvocation command, List<Comment> allComments, PrintWriter reply) {\n+        public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, CommandInvocation command,\n+                           List<Comment> allComments, PrintWriter reply, List<String> labelsToAdd, List<String> labelsToRemove) {\n@@ -107,1 +108,2 @@\n-        public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, CommandInvocation command, List<Comment> allComments, PrintWriter reply) {\n+        public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, CommandInvocation command,\n+                           List<Comment> allComments, PrintWriter reply, List<String> labelsToAdd, List<String> labelsToRemove) {\n@@ -150,0 +152,17 @@\n+    private void changeLabelsAfterComment(List<String> labelsToAdd, List<String> labelsToRemove){\n+        if (labelsToAdd != null && !labelsToAdd.isEmpty()) {\n+            for (var label : labelsToAdd) {\n+                if (!pr.labelNames().contains(label)) {\n+                    pr.addLabel(label);\n+                }\n+            }\n+        }\n+        if (labelsToRemove != null && !labelsToRemove.isEmpty()) {\n+            for (var label : labelsToRemove) {\n+                if (pr.labelNames().contains(label)) {\n+                    pr.removeLabel(label);\n+                }\n+            }\n+        }\n+    }\n+\n@@ -161,1 +180,35 @@\n-        if (handler.isEmpty()) {\n+        if (handler.isPresent()) {\n+            if (isCommit) {\n+                if (handler.get().allowedInCommit()) {\n+                    var hash = resultingCommitHash(allComments);\n+                    if (hash.isPresent()) {\n+                        var commit = pr.repository().commit(hash.get()).orElseThrow();\n+                        handler.get().handle(bot, commit, censusInstance, scratchPath, command, allComments, printer);\n+                    } else {\n+                        printer.print(\"The command `\");\n+                        printer.print(command.name());\n+                        printer.println(\"` can only be used in a pull request that has been integrated.\");\n+                    }\n+                } else {\n+                    printer.print(\"The command `\");\n+                    printer.print(command.name());\n+                    printer.println(\"` can only be used in open pull requests.\");\n+                }\n+            } else {\n+                if (handler.get().allowedInPullRequest()) {\n+                    if (command.id().startsWith(\"body\") && !handler.get().allowedInBody()) {\n+                        handler = Optional.of(new PullRequestCommandWorkItem.InvalidBodyCommandHandler());\n+                    }\n+                    var labelsToAdd = new ArrayList<String>();\n+                    var labelsToRemove = new ArrayList<String>();\n+                    handler.get().handle(bot, pr, censusInstance, scratchPath, command, allComments, printer, labelsToAdd, labelsToRemove);\n+                    pr.addComment(writer.toString());\n+                    changeLabelsAfterComment(labelsToAdd, labelsToRemove);\n+                    return;\n+                } else {\n+                    printer.print(\"The command `\");\n+                    printer.print(command.name());\n+                    printer.println(\"` can only be used in a pull request that has not yet been integrated.\");\n+                }\n+            }\n+        } else {\n@@ -165,40 +218,0 @@\n-            pr.addComment(writer.toString());\n-            return;\n-        }\n-\n-        if (isCommit && !handler.get().allowedInCommit()) {\n-            \/\/ isCommit && !handler.get().allowedInCommit() -> true\n-            printer.print(\"The command `\");\n-            printer.print(command.name());\n-            printer.println(\"` can only be used in open pull requests.\");\n-        } else if (isCommit) {\n-            \/\/ isCommit && handler.get().allowedInCommit() -> true\n-            var hash = resultingCommitHash(allComments);\n-            if (hash.isEmpty()) {\n-                printer.print(\"The command `\");\n-                printer.print(command.name());\n-                printer.println(\"` can only be used in a pull request that has been integrated.\");\n-                pr.addComment(writer.toString());\n-                return;\n-            }\n-            var commit = pr.repository().commit(hash.get()).orElseThrow();\n-            handler.get().handle(bot, commit, censusInstance, scratchPath, command, allComments, printer);\n-        } else if (!handler.get().allowedInPullRequest()) {\n-            \/\/ !isCommit && !handler.get().allowedInPullRequest() -> true\n-            printer.print(\"The command `\");\n-            printer.print(command.name());\n-            printer.println(\"` can only be used in a pull request that has not yet been integrated.\");\n-        } else {\n-            \/\/ !isCommit && handler.get().allowedInPullRequest() -> true\n-            if (command.id().startsWith(\"body\") && !handler.get().allowedInBody()) {\n-                handler = Optional.of(new PullRequestCommandWorkItem.InvalidBodyCommandHandler());\n-            }\n-            if (handler.get().changeLabelsAfterComment()) {\n-                var labelsToChange = handler.get().handle(bot, pr, censusInstance, scratchPath, command, allComments, printer, true);\n-                pr.addComment(writer.toString());\n-                \/\/ change labels after commenting\n-                labelsToChange.changeLabels(pr);\n-                return;\n-            } else {\n-                handler.get().handle(bot, pr, censusInstance, scratchPath, command, allComments, printer);\n-            }\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/PullRequestCommandWorkItem.java","additions":56,"deletions":43,"binary":false,"changes":99,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2019, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -34,1 +34,2 @@\n-    public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, CommandInvocation command, List<Comment> allComments, PrintWriter reply) {\n+    public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, CommandInvocation command,\n+                       List<Comment> allComments, PrintWriter reply, List<String> labelsToAdd, List<String> labelsToRemove) {\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/RejectCommand.java","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -70,1 +70,2 @@\n-    public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, CommandInvocation command, List<Comment> allComments, PrintWriter reply) {\n+    public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, CommandInvocation command,\n+                       List<Comment> allComments, PrintWriter reply, List<String> labelsToAdd, List<String> labelsToRemove) {\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/ReviewerCommand.java","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -76,1 +76,2 @@\n-    public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, CommandInvocation command, List<Comment> allComments, PrintWriter reply) {\n+    public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, CommandInvocation command,\n+                       List<Comment> allComments, PrintWriter reply, List<String> labelsToAdd, List<String> labelsToRemove) {\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/ReviewersCommand.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -40,1 +40,2 @@\n-    public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, CommandInvocation command, List<Comment> allComments, PrintWriter reply) {\n+    public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, CommandInvocation command,\n+                       List<Comment> allComments, PrintWriter reply, List<String> labelsToAdd, List<String> labelsToRemove) {\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/SponsorCommand.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2019, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -35,1 +35,2 @@\n-    public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, CommandInvocation command, List<Comment> allComments, PrintWriter reply) {\n+    public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, CommandInvocation command,\n+                       List<Comment> allComments, PrintWriter reply, List<String> labelsToAdd, List<String> labelsToRemove) {\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/SummaryCommand.java","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"}]}