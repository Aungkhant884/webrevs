{"files":[{"patch":"@@ -315,1 +315,1 @@\n-        return List.of(new CommandWorkItem(bot, updatedPR, errorHandler));\n+        return List.of(new PullRequestCommandWorkItem(bot, updatedPR, errorHandler));\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CheckWorkItem.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -59,1 +59,1 @@\n-                    bot.externalCommands().entrySet().stream()\n+                    bot.externalCommitCommands().entrySet().stream()\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CommitCommandWorkItem.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -45,1 +45,2 @@\n-    private final Map<String, String> externalCommands;\n+    private final Map<String, String> externalPullRequestCommands;\n+    private final Map<String, String> externalCommitCommands;\n@@ -67,2 +68,2 @@\n-    PullRequestBot(HostedRepository repo, HostedRepository censusRepo, String censusRef,\n-                   LabelConfiguration labelConfiguration, Map<String, String> externalCommands,\n+    PullRequestBot(HostedRepository repo, HostedRepository censusRepo, String censusRef, LabelConfiguration labelConfiguration,\n+                   Map<String, String> externalPullRequestCommands, Map<String, String> externalCommitCommands,\n@@ -79,1 +80,2 @@\n-        this.externalCommands = externalCommands;\n+        this.externalPullRequestCommands = externalPullRequestCommands;\n+        this.externalCommitCommands = externalCommitCommands;\n@@ -166,1 +168,1 @@\n-                    ret.add(new CommandWorkItem(this, pr, e -> updateCache.invalidate(pr)));\n+                    ret.add(new PullRequestCommandWorkItem(this, pr, e -> updateCache.invalidate(pr)));\n@@ -215,2 +217,6 @@\n-    Map<String, String> externalCommands() {\n-        return externalCommands;\n+    Map<String, String> externalPullRequestCommands() {\n+        return externalPullRequestCommands;\n+    }\n+\n+    Map<String, String> externalCommitCommands() {\n+        return externalCommitCommands;\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/PullRequestBot.java","additions":13,"deletions":7,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -40,1 +40,2 @@\n-    private Map<String, String> externalCommands = Map.of();\n+    private Map<String, String> externalPullRequestCommands = Map.of();\n+    private Map<String, String> externalCommitCommands = Map.of();\n@@ -79,2 +80,7 @@\n-    public PullRequestBotBuilder externalCommands(Map<String, String> externalCommands) {\n-        this.externalCommands = externalCommands;\n+    public PullRequestBotBuilder externalPullRequestCommands(Map<String, String> externalPullRequestCommands) {\n+        this.externalPullRequestCommands = externalPullRequestCommands;\n+        return this;\n+    }\n+\n+    public PullRequestBotBuilder externalCommitCommands(Map<String, String> externalCommitCommands) {\n+        this.externalCommitCommands = externalCommitCommands;\n@@ -155,1 +161,2 @@\n-        return new PullRequestBot(repo, censusRepo, censusRef, labelConfiguration, externalCommands,\n+        return new PullRequestBot(repo, censusRepo, censusRef, labelConfiguration,\n+                                  externalPullRequestCommands, externalCommitCommands,\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/PullRequestBotBuilder.java","additions":11,"deletions":4,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -45,4 +45,11 @@\n-        var external = new HashMap<String, String>();\n-        if (specific.contains(\"external\")) {\n-            for (var command : specific.get(\"external\").fields()) {\n-                external.put(command.name(), command.value().asString());\n+        var externalPullRequestCommands = new HashMap<String, String>();\n+        if (specific.contains(\"external\") && specific.get(\"external\").contains(\"pr\")) {\n+            for (var command : specific.get(\"external\").get(\"pr\").fields()) {\n+                externalPullRequestCommands.put(command.name(), command.value().asString());\n+            }\n+        }\n+\n+        var externalCommitCommands = new HashMap<String, String>();\n+        if (specific.contains(\"external\") && specific.get(\"external\").contains(\"commit\")) {\n+            for (var command : specific.get(\"external\").get(\"commit\").fields()) {\n+                externalCommitCommands.put(command.name(), command.value().asString());\n@@ -99,1 +106,2 @@\n-                                           .externalCommands(external)\n+                                           .externalPullRequestCommands(externalPullRequestCommands)\n+                                           .externalCommitCommands(externalCommitCommands)\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/PullRequestBotFactory.java","additions":13,"deletions":5,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -38,1 +38,1 @@\n-public class CommandWorkItem extends PullRequestWorkItem {\n+public class PullRequestCommandWorkItem extends PullRequestWorkItem {\n@@ -70,1 +70,1 @@\n-                    bot.externalCommands().entrySet().stream()\n+                    bot.externalPullRequestCommands().entrySet().stream()\n@@ -82,1 +82,1 @@\n-                    bot.externalCommands().entrySet().stream()\n+                    bot.externalPullRequestCommands().entrySet().stream()\n@@ -98,1 +98,1 @@\n-    CommandWorkItem(PullRequestBot bot, PullRequest pr, Consumer<RuntimeException> errorHandler) {\n+    PullRequestCommandWorkItem(PullRequestBot bot, PullRequest pr, Consumer<RuntimeException> errorHandler) {\n@@ -132,1 +132,1 @@\n-                          .filter(ci -> !bot.externalCommands().containsKey(ci.name()))\n+                          .filter(ci -> !bot.externalPullRequestCommands().containsKey(ci.name()))\n@@ -178,1 +178,1 @@\n-                        handler = Optional.of(new CommandWorkItem.InvalidBodyCommandHandler());\n+                        handler = Optional.of(new PullRequestCommandWorkItem.InvalidBodyCommandHandler());\n@@ -239,1 +239,1 @@\n-        return \"CommandWorkItem@\" + pr.repository().name() + \"#\" + pr.id();\n+        return \"PullRequestCommandWorkItem@\" + pr.repository().name() + \"#\" + pr.id();\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/PullRequestCommandWorkItem.java","additions":7,"deletions":7,"binary":false,"changes":14,"previous_filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CommandWorkItem.java","status":"renamed"},{"patch":"@@ -31,1 +31,1 @@\n-import java.util.List;\n+import java.util.*;\n@@ -167,0 +167,40 @@\n+\n+    @Test\n+    void externalCommitCommand(TestInfo testInfo) throws IOException {\n+        try (var credentials = new HostCredentials(testInfo);\n+             var tempFolder = new TemporaryDirectory()) {\n+            var author = credentials.getHostedRepository();\n+            var reviewer = credentials.getHostedRepository();\n+\n+            var censusBuilder = credentials.getCensusBuilder()\n+                                           .addAuthor(author.forge().currentUser().id())\n+                                           .addReviewer(reviewer.forge().currentUser().id());\n+            var seedFolder = tempFolder.path().resolve(\"seed\");\n+            var bot = PullRequestBot.newBuilder()\n+                                    .repo(author)\n+                                    .censusRepo(censusBuilder.build())\n+                                    .censusLink(\"https:\/\/census.com\/{{contributor}}-profile\")\n+                                    .externalCommitCommands(Map.of(\"external\", \"Help for external command\"))\n+                                    .seedStorage(seedFolder)\n+                                    .build();\n+\n+            \/\/ Populate the projects repository\n+            var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());\n+            var masterHash = localRepo.resolve(\"master\").orElseThrow();\n+            localRepo.push(masterHash, author.url(), \"master\", true);\n+\n+            \/\/ Make a change directly on master\n+            var editHash = CheckableRepository.appendAndCommit(localRepo);\n+            localRepo.push(editHash, author.url(), \"master\");\n+\n+            \/\/ Add a help command\n+            author.addCommitComment(editHash, \"\/help\");\n+            TestBotRunner.runPeriodicItems(bot);\n+\n+            \/\/ Look at the reply\n+            var replies = author.commitComments(editHash);\n+            CommitCommandAsserts.assertLastCommentContains(replies, \"Available commands\");\n+            CommitCommandAsserts.assertLastCommentContains(replies, \"external\");\n+            CommitCommandAsserts.assertLastCommentContains(replies, \"Help for external command\");\n+        }\n+    }\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/CommitCommandTests.java","additions":41,"deletions":1,"binary":false,"changes":42,"status":"modified"},{"patch":"@@ -35,1 +35,1 @@\n-class CommandTests {\n+class PullRequestCommandTests {\n@@ -279,1 +279,1 @@\n-                                         .externalCommands(Map.of(\"external\", \"Help for external command\"))\n+                                         .externalPullRequestCommands(Map.of(\"external\", \"Help for external command\"))\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/PullRequestCommandTests.java","additions":2,"deletions":2,"binary":false,"changes":4,"previous_filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/CommandTests.java","status":"renamed"}]}