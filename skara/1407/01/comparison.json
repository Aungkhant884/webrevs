{"files":[{"patch":"@@ -227,3 +227,1 @@\n-\n-        var census = CensusInstance.createCensusInstance(hostedRepositoryPool, bot.censusRepo(), bot.censusRef(), scratchPath.resolve(\"census\"), pr,\n-                                           bot.confOverrideRepository().orElse(null), bot.confOverrideName(), bot.confOverrideRef()).orElseThrow();\n+        CensusInstance census = null;\n@@ -233,0 +231,15 @@\n+        try {\n+            census = CensusInstance.createCensusInstance(hostedRepositoryPool, bot.censusRepo(), bot.censusRef(), scratchPath.resolve(\"census\"), pr,\n+                    bot.confOverrideRepository().orElse(null), bot.confOverrideName(), bot.confOverrideRef()).orElseThrow();\n+        } catch (InvalidJCheckConfException invalidJCheckConfException) {\n+            if (bot.confOverrideRepository().isEmpty()) {\n+                var text = \" ⚠️ @\" + pr.author().username() + \" The `.jcheck\/conf` in the target branch of this pull request is either invalid or missing completely. \"\n+                        + \"Until that is resolved, this pull request cannot be processed. Please notify the repository owner.\";\n+                addErrorComment(text, comments);\n+            } else {\n+                var text = \" ⚠️ @\" + pr.author().username() + \" The `.jcheck\/conf` in the override repo is either invalid or missing completely. \"\n+                        + \"Until that is resolved, this pull request cannot be processed. Please notify the repository owner.\";\n+                addErrorComment(text, comments);\n+            }\n+            return List.of();\n+        }\n@@ -254,1 +267,1 @@\n-                        addBackportErrorComment(text, comments);\n+                        addErrorComment(text, comments);\n@@ -270,1 +283,1 @@\n-                        addBackportErrorComment(text, comments);\n+                        addErrorComment(text, comments);\n@@ -281,1 +294,1 @@\n-                        addBackportErrorComment(text, comments);\n+                        addErrorComment(text, comments);\n@@ -311,1 +324,1 @@\n-                    addBackportErrorComment(text, comments);\n+                    addErrorComment(text, comments);\n@@ -327,1 +340,1 @@\n-                    addBackportErrorComment(text, comments);\n+                    addErrorComment(text, comments);\n@@ -335,1 +348,1 @@\n-                    addBackportErrorComment(text, comments);\n+                    addErrorComment(text, comments);\n@@ -391,1 +404,1 @@\n-    private void addBackportErrorComment(String text, List<Comment> comments) {\n+    private void addErrorComment(String text, List<Comment> comments) {\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CheckWorkItem.java","additions":23,"deletions":10,"binary":false,"changes":33,"status":"modified"},{"patch":"@@ -17,0 +17,5 @@\n+class InvalidJCheckConfException extends RuntimeException {\n+    public InvalidJCheckConfException(String message) {\n+        super(message);\n+    }\n+}\n@@ -42,1 +47,1 @@\n-                return Optional.empty();\n+                throw new InvalidJCheckConfException(\".jcheck\/conf is invalid or missing\");\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/LimitedCensusInstance.java","additions":6,"deletions":1,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -2176,0 +2176,48 @@\n+\n+    @Test\n+    void invalidJCheckConf(TestInfo testInfo) throws IOException {\n+        try (var credentials = new HostCredentials(testInfo);\n+             var tempFolder = new TemporaryDirectory()) {\n+            var author = credentials.getHostedRepository();\n+            var reviewer = credentials.getHostedRepository();\n+\n+            var censusBuilder = credentials.getCensusBuilder()\n+                    .addAuthor(author.forge().currentUser().id())\n+                    .addReviewer(reviewer.forge().currentUser().id());\n+            var seedFolder = tempFolder.path().resolve(\"seed\");\n+            var checkBot = PullRequestBot.newBuilder()\n+                    .repo(author)\n+                    .censusRepo(censusBuilder.build())\n+                    .censusLink(\"https:\/\/census.com\/{{contributor}}-profile\")\n+                    .seedStorage(seedFolder)\n+                    .build();\n+\n+            \/\/ Populate the projects repository\n+            var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());\n+\n+            \/\/ Remove .jcheck\/conf\n+            localRepo.remove(localRepo.root().resolve(\".jcheck\/conf\"));\n+            localRepo.commit(\"no conf\", \"testauthor\", \"ta@none.none\");\n+\n+            var masterHash = localRepo.resolve(\"master\").orElseThrow();\n+            localRepo.push(masterHash, author.url(), \"master\", true);\n+\n+            \/\/ Create a new branch\n+            var editBranch = localRepo.branch(masterHash, \"edit\");\n+            localRepo.checkout(editBranch);\n+            var editHash = CheckableRepository.appendAndCommit(localRepo);\n+            localRepo.push(editHash, author.url(), \"edit\", true);\n+\n+            var pr = credentials.createPullRequest(author, \"master\", \"edit\", \"This is a pull request\");\n+\n+            \/\/ Check the status\n+            TestBotRunner.runPeriodicItems(checkBot);\n+            var comments = pr.store().comments();\n+            assertTrue(comments.get(comments.size() - 1).body().contains(\" ⚠️ @\" + pr.author().username() + \" The `.jcheck\/conf` in the target branch of this pull request is either invalid or missing completely. \"\n+                    + \"Until that is resolved, this pull request cannot be processed. Please notify the repository owner.\"));\n+            \/\/ Make sure the warning message will be sent only once\n+            TestBotRunner.runPeriodicItems(checkBot);\n+            TestBotRunner.runPeriodicItems(checkBot);\n+            assertEquals(1, pr.store().comments().size());\n+        }\n+    }\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/CheckTests.java","additions":48,"deletions":0,"binary":false,"changes":48,"status":"modified"}]}