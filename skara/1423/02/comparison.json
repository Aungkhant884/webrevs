{"files":[{"patch":"@@ -54,2 +54,3 @@\n-    CheckWorkItem(PullRequestBot bot, String prId, Consumer<RuntimeException> errorHandler, ZonedDateTime prUpdatedAt) {\n-        super(bot, prId, errorHandler, prUpdatedAt);\n+    CheckWorkItem(PullRequestBot bot, String prId, Consumer<RuntimeException> errorHandler, ZonedDateTime prUpdatedAt,\n+            boolean needsReadyCheck) {\n+        super(bot, prId, errorHandler, prUpdatedAt, needsReadyCheck);\n@@ -271,1 +272,1 @@\n-                return List.of(new PullRequestCommandWorkItem(bot, prId, errorHandler, prUpdatedAt));\n+                return List.of(new PullRequestCommandWorkItem(bot, prId, errorHandler, prUpdatedAt, false));\n@@ -335,1 +336,1 @@\n-                    return List.of(new CheckWorkItem(bot, prId, errorHandler, prUpdatedAt));\n+                    return List.of(new CheckWorkItem(bot, prId, errorHandler, prUpdatedAt, false));\n@@ -375,1 +376,1 @@\n-                return List.of(new CheckWorkItem(bot, prId, errorHandler, prUpdatedAt));\n+                return List.of(new CheckWorkItem(bot, prId, errorHandler, prUpdatedAt, false));\n@@ -382,1 +383,1 @@\n-                return List.of(new CheckWorkItem(bot, prId, errorHandler, prUpdatedAt));\n+                return List.of(new CheckWorkItem(bot, prId, errorHandler, prUpdatedAt, false));\n@@ -415,1 +416,1 @@\n-        return List.of(new PullRequestCommandWorkItem(bot, prId, errorHandler, prUpdatedAt));\n+        return List.of(new PullRequestCommandWorkItem(bot, prId, errorHandler, prUpdatedAt, false));\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CheckWorkItem.java","additions":8,"deletions":7,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -42,1 +42,1 @@\n-        super(bot, prId, errorHandler, prUpdatedAt);\n+        super(bot, prId, errorHandler, prUpdatedAt, false);\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/LabelerWorkItem.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -115,30 +115,0 @@\n-    private boolean isReady(PullRequest pr) {\n-        var labels = new HashSet<>(pr.labelNames());\n-        for (var readyLabel : readyLabels) {\n-            if (!labels.contains(readyLabel)) {\n-                log.fine(\"PR is not yet ready - missing label '\" + readyLabel + \"'\");\n-                return false;\n-            }\n-        }\n-\n-        var comments = pr.comments();\n-        for (var readyComment : readyComments.entrySet()) {\n-            var commentFound = false;\n-            for (var comment : comments) {\n-                if (comment.author().username().equals(readyComment.getKey())) {\n-                    var matcher = readyComment.getValue().matcher(comment.body());\n-                    if (matcher.find()) {\n-                        commentFound = true;\n-                        break;\n-                    }\n-                }\n-            }\n-            if (!commentFound) {\n-                log.fine(\"PR is not yet ready - missing ready comment from '\" + readyComment.getKey() +\n-                                 \"containing '\" + readyComment.getValue().pattern() + \"'\");\n-                return false;\n-            }\n-        }\n-        return true;\n-    }\n-\n@@ -155,3 +125,0 @@\n-            if (!isReady(pr)) {\n-                continue;\n-            }\n@@ -159,1 +126,1 @@\n-                ret.add(new CheckWorkItem(this, pr.id(), e -> poller.retryPullRequest(pr), pr.updatedAt()));\n+                ret.add(new CheckWorkItem(this, pr.id(), e -> poller.retryPullRequest(pr), pr.updatedAt(), true));\n@@ -162,1 +129,1 @@\n-                ret.add(new PullRequestCommandWorkItem(this, pr.id(), e -> poller.retryPullRequest(pr), pr.updatedAt()));\n+                ret.add(new PullRequestCommandWorkItem(this, pr.id(), e -> poller.retryPullRequest(pr), pr.updatedAt(), true));\n@@ -215,0 +182,4 @@\n+    public Set<String> readyLabels() {\n+        return readyLabels;\n+    }\n+\n@@ -223,0 +194,4 @@\n+    public Map<String, Pattern> readyComments() {\n+        return readyComments;\n+    }\n+\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/PullRequestBot.java","additions":10,"deletions":35,"binary":false,"changes":45,"status":"modified"},{"patch":"@@ -49,2 +49,2 @@\n-            ZonedDateTime prUpdatedAt) {\n-        super(bot, prId, errorHandler, prUpdatedAt);\n+            ZonedDateTime prUpdatedAt, boolean needsReadyCheck) {\n+        super(bot, prId, errorHandler, prUpdatedAt, needsReadyCheck);\n@@ -215,1 +215,1 @@\n-            return List.of(new CheckWorkItem(bot, prId, errorHandler, prUpdatedAt));\n+            return List.of(new CheckWorkItem(bot, prId, errorHandler, prUpdatedAt, false));\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/PullRequestCommandWorkItem.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -29,0 +29,2 @@\n+import java.util.HashSet;\n+import java.util.List;\n@@ -37,0 +39,1 @@\n+    private static final Logger log = Logger.getLogger(PullRequestWorkItem.class.getName());\n@@ -40,0 +43,1 @@\n+    private final boolean needsReadyCheck;\n@@ -52,1 +56,1 @@\n-            ZonedDateTime prUpdatedAt) {\n+            ZonedDateTime prUpdatedAt, boolean needsReadyCheck) {\n@@ -57,0 +61,1 @@\n+        this.needsReadyCheck = needsReadyCheck;\n@@ -70,0 +75,33 @@\n+    private boolean isReady() {\n+        if (!needsReadyCheck) {\n+            return true;\n+        }\n+        var labels = new HashSet<>(pr.labelNames());\n+        for (var readyLabel : bot.readyLabels()) {\n+            if (!labels.contains(readyLabel)) {\n+                log.fine(\"PR is not yet ready - missing label '\" + readyLabel + \"'\");\n+                return false;\n+            }\n+        }\n+\n+        var comments = pr.comments();\n+        for (var readyComment : bot.readyComments().entrySet()) {\n+            var commentFound = false;\n+            for (var comment : comments) {\n+                if (comment.author().username().equals(readyComment.getKey())) {\n+                    var matcher = readyComment.getValue().matcher(comment.body());\n+                    if (matcher.find()) {\n+                        commentFound = true;\n+                        break;\n+                    }\n+                }\n+            }\n+            if (!commentFound) {\n+                log.fine(\"PR is not yet ready - missing ready comment from '\" + readyComment.getKey() +\n+                        \"containing '\" + readyComment.getValue().pattern() + \"'\");\n+                return false;\n+            }\n+        }\n+        return true;\n+    }\n+\n@@ -81,0 +119,4 @@\n+        \/\/ Check if PR is ready to be evaluated at all.\n+        if (!isReady()) {\n+            return List.of();\n+        }\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/PullRequestWorkItem.java","additions":43,"deletions":1,"binary":false,"changes":44,"status":"modified"}]}