{"files":[{"patch":"@@ -661,7 +661,1 @@\n-        \/\/ GitLab does not allow adding\/removing single labels, only setting the full list\n-        \/\/ We retrieve the list again here to try to minimize the race condition window\n-        var currentJson = request.get(\"\").execute().asObject();\n-        var labels = Stream.concat(currentJson.get(\"labels\").stream()\n-                                .map(JSONValue::asString),\n-                        Stream.of(label))\n-                .collect(Collectors.toSet());\n+        labels = null;\n@@ -669,1 +663,1 @@\n-                .body(\"labels\", String.join(\",\", labels))\n+                .body(\"add_labels\", label)\n@@ -679,1 +673,0 @@\n-        this.labels = labels.stream().sorted().toList();\n@@ -684,5 +677,1 @@\n-        var currentJson = request.get(\"\").execute().asObject();\n-        var labels = currentJson.get(\"labels\").stream()\n-                .map(JSONValue::asString)\n-                .filter(l -> !l.equals(label))\n-                .collect(Collectors.toSet());\n+        labels = null;\n@@ -690,1 +679,1 @@\n-                .body(\"labels\", String.join(\",\", labels))\n+                .body(\"remove_labels\", label)\n@@ -700,1 +689,0 @@\n-        this.labels = labels.stream().sorted().toList();\n@@ -713,1 +701,1 @@\n-        return labels.stream()\n+        return labelNames().stream()\n@@ -722,0 +710,6 @@\n+        if (labels == null) {\n+            labels = request.get(\"\").execute().get(\"labels\").stream()\n+                    .map(JSONValue::asString)\n+                    .sorted()\n+                    .collect(Collectors.toList());\n+        }\n","filename":"forge\/src\/main\/java\/org\/openjdk\/skara\/forge\/gitlab\/GitLabMergeRequest.java","additions":11,"deletions":17,"binary":false,"changes":28,"status":"modified"},{"patch":"@@ -78,0 +78,30 @@\n+\n+    @Test\n+    void testLabels() throws IOException {\n+        var settings = ManualTestSettings.loadManualTestSettings();\n+        var username = settings.getProperty(\"gitlab.user\");\n+        var token = settings.getProperty(\"gitlab.pat\");\n+        var credential = new Credential(username, token);\n+        var uri = URIBuilder.base(settings.getProperty(\"gitlab.uri\")).build();\n+        var gitLabHost = new GitLabHost(\"gitlab\", uri, false, credential, Set.of());\n+        var gitLabRepo = gitLabHost.repository(settings.getProperty(\"gitlab.repository\")).orElseThrow();\n+        var gitLabMergeRequest = gitLabRepo.pullRequest(settings.getProperty(\"gitlab.merge.request.id\"));\n+\n+        \/\/ Get the labels\n+        var labels = gitLabMergeRequest.labelNames();\n+        assertEquals(1, labels.size());\n+        assertEquals(\"test\", labels.get(0));\n+\n+        \/\/ Add a label\n+        gitLabMergeRequest.addLabel(\"test1\");\n+        labels = gitLabMergeRequest.labelNames();\n+        assertEquals(2, labels.size());\n+        assertEquals(\"test\", labels.get(0));\n+        assertEquals(\"test1\", labels.get(1));\n+\n+        \/\/ Remove a label\n+        gitLabMergeRequest.removeLabel(\"test1\");\n+        labels = gitLabMergeRequest.labelNames();\n+        assertEquals(1, labels.size());\n+        assertEquals(\"test\", labels.get(0));\n+    }\n","filename":"forge\/src\/test\/java\/org\/openjdk\/skara\/forge\/gitlab\/GitLabRestApiTest.java","additions":30,"deletions":0,"binary":false,"changes":30,"status":"modified"}]}