{"files":[{"patch":"@@ -293,0 +293,14 @@\n+            var backportHashMatcher = BACKPORT_HASH_TITLE_PATTERN.matcher(pr.title());\n+            var backportIssueMatcher = BACKPORT_ISSUE_TITLE_PATTERN.matcher(pr.title());\n+\n+            var backportDisabledText = \"<!-- backport error -->\\n\" +\n+                    \":warning: @\" + pr.author().username() + \" backport PR is not allowed in this repository, please close this pr.\" +\n+                    \" If it was unintentional, please modify the title of this PR.\";\n+\n+            if (!bot.enableBackport() && (backportHashMatcher.matches() || backportIssueMatcher.matches())) {\n+                addErrorComment(backportDisabledText, comments);\n+                return List.of();\n+            }\n+\n+            removeErrorComment(backportDisabledText, comments);\n+\n@@ -300,1 +314,0 @@\n-            var backportHashMatcher = BACKPORT_HASH_TITLE_PATTERN.matcher(pr.title());\n@@ -373,1 +386,0 @@\n-            var backportIssueMatcher = BACKPORT_ISSUE_TITLE_PATTERN.matcher(pr.title());\n@@ -473,0 +485,9 @@\n+    private void removeErrorComment(String text, List<Comment> comments) {\n+        var botUser = pr.repository().forge().currentUser();\n+        var oldComment = comments.stream()\n+                .filter(c -> c.author().equals(botUser))\n+                .filter(c -> c.body().equals(text))\n+                .findFirst();\n+        oldComment.ifPresent(comment -> pr.removeComment(comment));\n+    }\n+\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CheckWorkItem.java","additions":23,"deletions":2,"binary":false,"changes":25,"status":"modified"},{"patch":"@@ -69,0 +69,1 @@\n+    private final boolean enableBackport;\n@@ -81,1 +82,1 @@\n-                   boolean reviewCleanBackport, String mlbridgeBotName, boolean reviewMerge) {\n+                   boolean reviewCleanBackport, String mlbridgeBotName, boolean reviewMerge, boolean enableBackport) {\n@@ -109,0 +110,1 @@\n+        this.enableBackport = enableBackport;\n@@ -283,0 +285,4 @@\n+    public boolean enableBackport(){\n+        return enableBackport;\n+    }\n+\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/PullRequestBot.java","additions":7,"deletions":1,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -61,0 +61,1 @@\n+    private boolean enableBackport = true;\n@@ -200,0 +201,5 @@\n+    public PullRequestBotBuilder enableBackport(boolean enableBackport) {\n+        this.enableBackport = enableBackport;\n+        return this;\n+    }\n+\n@@ -207,1 +213,1 @@\n-                                  enableCsr, enableJep, reviewCleanBackport, mlbridgeBotName, reviewMerge);\n+                                  enableCsr, enableJep, reviewCleanBackport, mlbridgeBotName, reviewMerge, enableBackport);\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/PullRequestBotBuilder.java","additions":7,"deletions":1,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -188,0 +188,3 @@\n+            if(repo.value().contains(\"backport\")){\n+                botBuilder.enableBackport(repo.value().get(\"backport\").asBoolean());\n+            }\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/PullRequestBotFactory.java","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -2843,0 +2843,48 @@\n+\n+    @Test\n+    void backportDisabled(TestInfo testInfo) throws IOException {\n+        try (var credentials = new HostCredentials(testInfo);\n+             var tempFolder = new TemporaryDirectory()) {\n+            var author = credentials.getHostedRepository();\n+            var reviewer = credentials.getHostedRepository();\n+\n+            var censusBuilder = credentials.getCensusBuilder()\n+                    .addAuthor(author.forge().currentUser().id())\n+                    .addReviewer(reviewer.forge().currentUser().id());\n+            var seedFolder = tempFolder.path().resolve(\"seed\");\n+            var prBot = PullRequestBot.newBuilder()\n+                    .repo(author)\n+                    .censusRepo(censusBuilder.build())\n+                    .censusLink(\"https:\/\/census.com\/{{contributor}}-profile\")\n+                    .seedStorage(seedFolder)\n+                    .enableBackport(false)\n+                    .build();\n+\n+            \/\/ Populate the projects repository\n+            var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());\n+            var masterHash = localRepo.resolve(\"master\").orElseThrow();\n+            localRepo.push(masterHash, author.authenticatedUrl(), \"master\", true);\n+\n+            \/\/ Make a change with a corresponding PR\n+            var editHash = CheckableRepository.appendAndCommit(localRepo);\n+            localRepo.push(editHash, author.authenticatedUrl(), \"refs\/heads\/edit\", true);\n+            var pr = credentials.createPullRequest(author, \"master\", \"edit\", \"Backport 0123456789012345678901234567890123456789\");\n+\n+            \/\/ Check the status\n+            TestBotRunner.runPeriodicItems(prBot);\n+\n+            var comment = pr.store().comments().get(pr.store().comments().size() - 1);\n+            assertEquals(1, pr.store().comments().size());\n+            assertTrue(comment.body().contains(\"backport PR is not allowed in this repository\"));\n+\n+            pr.setTitle(\"Backport 123\");\n+            TestBotRunner.runPeriodicItems(prBot);\n+            comment = pr.store().comments().get(pr.store().comments().size() - 1);\n+            assertEquals(1, pr.store().comments().size());\n+            assertTrue(comment.body().contains(\"backport PR is not allowed in this repository\"));\n+\n+            pr.setTitle(\"SKARA-123\");\n+            TestBotRunner.runPeriodicItems(prBot);\n+            assertEquals(0, pr.store().comments().size());\n+        }\n+    }\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/CheckTests.java","additions":48,"deletions":0,"binary":false,"changes":48,"status":"modified"},{"patch":"@@ -71,0 +71,1 @@\n+                          \"backport\": false,\n@@ -88,0 +89,1 @@\n+                          \"backport\": true,\n@@ -166,0 +168,9 @@\n+            assertTrue(pullRequestBot1.enableBackport());\n+\n+            var pullRequestBot2 = (PullRequestBot) bots.get(1);\n+            assertEquals(\"PullRequestBot@repo5\", pullRequestBot2.toString());\n+            assertTrue(pullRequestBot2.enableBackport());\n+\n+            var pullRequestBot3 = (PullRequestBot) bots.get(2);\n+            assertEquals(\"PullRequestBot@repo2\", pullRequestBot3.toString());\n+            assertFalse(pullRequestBot3.enableBackport());\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/PullRequestBotFactoryTest.java","additions":11,"deletions":0,"binary":false,"changes":11,"status":"modified"}]}