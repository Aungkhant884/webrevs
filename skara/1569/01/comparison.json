{"files":[{"patch":"@@ -401,1 +401,1 @@\n-            var webrevGenerator = bot.webrevStorage().generator(pr, localRepo, webrevPath);\n+            var webrevGenerator = bot.webrevStorage().generator(pr, localRepo, webrevPath, hostedRepositoryPool);\n","filename":"bots\/mlbridge\/src\/main\/java\/org\/openjdk\/skara\/bots\/mlbridge\/ArchiveWorkItem.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -287,1 +287,2 @@\n-    private URI createAndArchive(PullRequest pr, Repository localRepository, Path scratchPath, Diff diff, Hash base, Hash head, String identifier) {\n+    private URI createAndArchive(PullRequest pr, Repository localRepository, Path scratchPath, Diff diff, Hash base, Hash head, String identifier,\n+                                 Repository jsonLocalStorage, Repository htmlLocalStorage) {\n@@ -298,2 +299,0 @@\n-                var jsonLocalStorage = Repository.materialize(scratchPath, jsonStorage.authenticatedUrl(),\n-                                                              \"+\" + storageRef + \":mlbridge_webrevs\");\n@@ -311,2 +310,0 @@\n-                var htmlLocalStorage = Repository.materialize(scratchPath, htmlStorage.authenticatedUrl(),\n-                                                              \"+\" + storageRef + \":mlbridge_webrevs\");\n@@ -328,1 +325,0 @@\n-\n@@ -331,0 +327,1 @@\n+\n@@ -334,1 +331,2 @@\n-    WebrevGenerator generator(PullRequest pr, Repository localRepository, Path scratchPath) {\n+    WebrevGenerator generator(PullRequest pr, Repository localRepository, Path scratchPath, HostedRepositoryPool hostedRepositoryPool) {\n+\n@@ -336,0 +334,20 @@\n+            Repository jsonLocalStorage = null;\n+            Repository htmlLocalStorage = null;\n+\n+            private void initializeLocalStorage() {\n+                if (jsonLocalStorage == null && !(jsonStorage == null)) {\n+                    try {\n+                        jsonLocalStorage = hostedRepositoryPool.checkout(jsonStorage, storageRef, scratchPath);\n+                    } catch (IOException e) {\n+                        throw new RuntimeException(e);\n+                    }\n+                }\n+                if (htmlLocalStorage == null && !(htmlStorage == null)) {\n+                    try {\n+                        htmlLocalStorage = hostedRepositoryPool.checkout(htmlStorage, storageRef, scratchPath);\n+                    } catch (IOException e) {\n+                        throw new RuntimeException(e);\n+                    }\n+                }\n+            }\n+\n@@ -338,1 +356,2 @@\n-                var uri = createAndArchive(pr, localRepository, scratchPath, null, base, head, identifier);\n+                initializeLocalStorage();\n+                var uri = createAndArchive(pr, localRepository, scratchPath, null, base, head, identifier, jsonLocalStorage, htmlLocalStorage);\n@@ -344,1 +363,2 @@\n-                var uri = createAndArchive(pr, localRepository, scratchPath, diff, diff.from(), diff.to(), identifier);\n+                initializeLocalStorage();\n+                var uri = createAndArchive(pr, localRepository, scratchPath, diff, diff.from(), diff.to(), identifier, jsonLocalStorage, htmlLocalStorage);\n","filename":"bots\/mlbridge\/src\/main\/java\/org\/openjdk\/skara\/bots\/mlbridge\/WebrevStorage.java","additions":29,"deletions":9,"binary":false,"changes":38,"status":"modified"},{"patch":"@@ -27,0 +27,1 @@\n+import org.openjdk.skara.forge.HostedRepositoryPool;\n@@ -73,1 +74,2 @@\n-            var generator = storage.generator(pr, prRepo, scratchFolder);\n+            var seedPath = tempFolder.path().resolve(\"seed\");\n+            var generator = storage.generator(pr, prRepo, scratchFolder, new HostedRepositoryPool(seedPath));\n@@ -126,1 +128,2 @@\n-            var generator = storage.generator(pr, prRepo, scratchFolder);\n+            var seedPath = tempFolder.path().resolve(\"seed\");\n+            var generator = storage.generator(pr, prRepo, scratchFolder, new HostedRepositoryPool(seedPath));\n@@ -210,1 +213,2 @@\n-            var generator = storage.generator(pr, prRepo, scratchFolder);\n+            var seedPath = tempFolder.path().resolve(\"seed\");\n+            var generator = storage.generator(pr, prRepo, scratchFolder, new HostedRepositoryPool(seedPath));\n","filename":"bots\/mlbridge\/src\/test\/java\/org\/openjdk\/skara\/bots\/mlbridge\/WebrevStorageTests.java","additions":7,"deletions":3,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -48,0 +48,1 @@\n+        private static Set<Path> healthySet = new HashSet<>();\n@@ -124,0 +125,1 @@\n+            healthySet.add(path);\n@@ -150,1 +152,1 @@\n-                if (!localRepoInstance.isHealthy()) {\n+                if (!isHealthy(localRepoInstance, path)) {\n@@ -167,0 +169,12 @@\n+\n+        private boolean isHealthy(Repository localRepoInstance, Path path) throws IOException {\n+            if (healthySet.contains(path)) {\n+                return true;\n+            } else {\n+                boolean isHealthy = localRepoInstance.isHealthy();\n+                if (isHealthy) {\n+                    healthySet.add(path);\n+                }\n+                return isHealthy;\n+            }\n+        }\n","filename":"forge\/src\/main\/java\/org\/openjdk\/skara\/forge\/HostedRepositoryPool.java","additions":15,"deletions":1,"binary":false,"changes":16,"status":"modified"}]}