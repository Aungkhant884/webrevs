{"files":[{"patch":"@@ -35,0 +35,1 @@\n+import java.util.function.Consumer;\n@@ -39,0 +40,1 @@\n+    private final Consumer<RuntimeException> onError;\n@@ -73,1 +75,1 @@\n-    CommitCommandWorkItem(PullRequestBot bot, CommitComment commitComment) {\n+    CommitCommandWorkItem(PullRequestBot bot, CommitComment commitComment, Consumer<RuntimeException> onError) {\n@@ -76,0 +78,1 @@\n+        this.onError = onError;\n@@ -165,0 +168,5 @@\n+\n+    @Override\n+    public void handleRuntimeException(RuntimeException e) {\n+        onError.accept(e);\n+    }\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CommitCommandWorkItem.java","additions":9,"deletions":1,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -60,1 +60,0 @@\n-    private final Set<String> commitCommandUsers;\n@@ -68,1 +67,1 @@\n-    private final Set<String> processedCommitComments;\n+    private final ConcurrentHashMap<String, Boolean> processedCommitComments;\n@@ -77,2 +76,1 @@\n-                   String confOverrideRef, String censusLink, List<HostUser> commitCommandUsers,\n-                   Map<String, HostedRepository> forks) {\n+                   String confOverrideRef, String censusLink, Map<String, HostedRepository> forks) {\n@@ -98,3 +96,0 @@\n-        this.commitCommandUsers = commitCommandUsers.stream()\n-                                                    .map(HostUser::id)\n-                                                    .collect(Collectors.toSet());\n@@ -109,1 +104,1 @@\n-        processedCommitComments = new HashSet<>();\n+        processedCommitComments = new ConcurrentHashMap<>();\n@@ -179,1 +174,3 @@\n-            ret.add(new CommitCommandWorkItem(this, commitComment));\n+            processedCommitComments.put(commitComment.id(), true);\n+            ret.add(new CommitCommandWorkItem(this, commitComment,\n+                                              e -> processedCommitComments.remove(commitComment.id())));\n@@ -188,2 +185,0 @@\n-        List<CommitComment> commitComments = List.of();\n-\n@@ -199,2 +194,2 @@\n-        if (!commitCommandUsers.isEmpty()) {\n-            commitComments = remoteRepo.recentCommitComments().stream()\n+        var commitComments = remoteRepo.recentCommitComments()\n+                                       .stream()\n@@ -202,1 +197,0 @@\n-                                       .filter(cc -> commitCommandUsers.contains(cc.author().id()))\n@@ -204,6 +198,0 @@\n-            if (!commitComments.isEmpty()) {\n-                processedCommitComments.addAll(commitComments.stream()\n-                                                             .map(Comment::id)\n-                                                             .collect(Collectors.toList()));\n-            }\n-        }\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/PullRequestBot.java","additions":8,"deletions":20,"binary":false,"changes":28,"status":"modified"},{"patch":"@@ -54,1 +54,0 @@\n-    private List<HostUser> commitCommandUsers = List.of();\n@@ -150,5 +149,0 @@\n-    public PullRequestBotBuilder commitCommandUsers(List<HostUser> commitCommandUsers) {\n-        this.commitCommandUsers = commitCommandUsers;\n-        return this;\n-    }\n-\n@@ -165,1 +159,1 @@\n-                                  confOverrideRef, censusLink, commitCommandUsers, forks);\n+                                  confOverrideRef, censusLink, forks);\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/PullRequestBotBuilder.java","additions":1,"deletions":7,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -144,8 +144,0 @@\n-            if (repo.value().contains(\"commitcommanders\")) {\n-                var allowed = repo.value().get(\"commitcommanders\").stream()\n-                                  .map(JSONValue::asString)\n-                                  .map(s -> HostUser.builder().id(s).build())\n-                                  .collect(Collectors.toList());\n-                botBuilder.commitCommandUsers(allowed);\n-            }\n-\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/PullRequestBotFactory.java","additions":0,"deletions":8,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -50,1 +50,0 @@\n-                                    .commitCommandUsers(List.of(author.forge().currentUser()))\n@@ -118,1 +117,0 @@\n-                                    .commitCommandUsers(List.of(author.forge().currentUser()))\n@@ -160,1 +158,0 @@\n-                                    .commitCommandUsers(List.of(author.forge().currentUser()))\n@@ -202,1 +199,0 @@\n-                                    .commitCommandUsers(List.of(author.forge().currentUser()))\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/BackportCommitCommandTests.java","additions":0,"deletions":4,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -49,1 +49,0 @@\n-                                    .commitCommandUsers(List.of(author.forge().currentUser()))\n@@ -95,1 +94,0 @@\n-                                    .commitCommandUsers(List.of(author.forge().currentUser()))\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/CommitCommandTests.java","additions":0,"deletions":2,"binary":false,"changes":2,"status":"modified"}]}