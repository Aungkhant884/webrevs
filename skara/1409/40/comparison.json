{"files":[{"patch":"@@ -80,1 +80,1 @@\n-        if (pr.state() == Issue.State.CLOSED) {\n+        if (pr.state() != Issue.State.OPEN) {\n","filename":"bots\/notify\/src\/main\/java\/org\/openjdk\/skara\/bots\/notify\/prbranch\/PullRequestBranchNotifier.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -165,1 +165,1 @@\n-            markIntegratedAndClosed(pr, prepushHash.get(), reply);\n+            markIntegratedAndMerged(bot, scratchPath, pr, prepushHash.get(), reply);\n@@ -244,1 +244,1 @@\n-                markIntegratedAndClosed(pr, amendedHash, reply);\n+                markIntegratedAndMerged(bot, scratchPath, pr, amendedHash, reply);\n@@ -328,1 +328,1 @@\n-    static void markIntegratedAndClosed(PullRequest pr, Hash hash, PrintWriter reply) {\n+    static void markIntegratedAndMerged(PullRequestBot bot, Path scratchPath, PullRequest pr, Hash hash, PrintWriter reply) {\n@@ -331,0 +331,7 @@\n+        try {\n+            Repository repository = new HostedRepositoryPool(bot.seedStorage().orElse(scratchPath.resolve(\"seeds\"))).seedRepository(pr.repository(), false);\n+            Hash tip = repository.fetch(pr.repository().url(), pr.targetRef(), false);\n+            repository.push(tip, pr.repository().url(), \"integration\/\" + pr.id() + \"\/\" + pr.targetRef(), true);\n+        } catch (IOException exception) {\n+            throw new UncheckedIOException(exception);\n+        }\n@@ -332,1 +339,1 @@\n-        pr.setState(PullRequest.State.CLOSED);\n+        pr.setState(PullRequest.State.RESOLVED);\n@@ -343,1 +350,2 @@\n-        reply.println(\":bulb: You may see a message that your pull request was closed with unmerged commits. This can be safely ignored.\");\n+        reply.println(\":bulb: You may see a message that your pull request was closed with unmerged commits, or that it was merged into a different branch. This can be safely ignored.\");\n+        reply.println(\"Your Pull Request was correctly integrated into the \" + pr.targetRef() + \" branch.\");\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/IntegrateCommand.java","additions":13,"deletions":5,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -52,1 +52,1 @@\n-            markIntegratedAndClosed(pr, prePushHash.get(), reply);\n+            IntegrateCommand.markIntegratedAndMerged(bot, scratchPath, pr, prePushHash.get(), reply);\n@@ -134,1 +134,1 @@\n-                markIntegratedAndClosed(pr, amendedHash, reply);\n+                IntegrateCommand.markIntegratedAndMerged(bot, scratchPath, pr, amendedHash, reply);\n@@ -147,4 +147,0 @@\n-    private void markIntegratedAndClosed(PullRequest pr, Hash amendedHash, PrintWriter reply) {\n-        IntegrateCommand.markIntegratedAndClosed(pr, amendedHash, reply);\n-    }\n-\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/SponsorCommand.java","additions":2,"deletions":6,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -87,1 +87,1 @@\n-        var reviews = request.get(\"pulls\/\" + json.get(\"number\").toString() + \"\/reviews\").execute().stream()\n+        var reviews = request.get(\"pulls\/\" + this.id() + \"\/reviews\").execute().stream()\n@@ -175,1 +175,1 @@\n-        request.post(\"pulls\/\" + json.get(\"number\").toString() + \"\/reviews\")\n+        request.post(\"pulls\/\" + this.id() + \"\/reviews\")\n@@ -182,1 +182,1 @@\n-        request.put(\"pulls\/\" + json.get(\"number\").toString() + \"\/reviews\/\" + id)\n+        request.put(\"pulls\/\" + this.id() + \"\/reviews\/\" + id)\n@@ -243,1 +243,1 @@\n-        var response = request.post(\"pulls\/\" + json.get(\"number\").toString() + \"\/comments\")\n+        var response = request.post(\"pulls\/\" + this.id() + \"\/comments\")\n@@ -254,1 +254,1 @@\n-        var response = request.post(\"pulls\/\" + json.get(\"number\").toString() + \"\/comments\")\n+        var response = request.post(\"pulls\/\" + this.id() + \"\/comments\")\n@@ -263,1 +263,1 @@\n-        var reviewComments = request.get(\"pulls\/\" + json.get(\"number\").toString() + \"\/comments\").execute().stream()\n+        var reviewComments = request.get(\"pulls\/\" + this.id() + \"\/comments\").execute().stream()\n@@ -307,1 +307,7 @@\n-        return json.get(\"base\").get(\"ref\").asString();\n+        if (this.state() == State.RESOLVED) {\n+            \/\/ Integrated special case\n+            return json.get(\"base\").get(\"ref\").asString()\n+                       .substring((\"integration\/\" + this.id() + \"\/\").length());\n+        } else {\n+            return json.get(\"base\").get(\"ref\").asString();\n+        }\n@@ -317,1 +323,1 @@\n-        request.patch(\"pulls\/\" + json.get(\"number\").toString())\n+        request.patch(\"pulls\/\" + this.id())\n@@ -333,1 +339,1 @@\n-        request.patch(\"pulls\/\" + json.get(\"number\").toString())\n+        request.patch(\"pulls\/\" + this.id())\n@@ -349,1 +355,1 @@\n-        return request.get(\"issues\/\" + json.get(\"number\").toString() + \"\/comments\").execute().stream()\n+        return request.get(\"issues\/\" + this.id() + \"\/comments\").execute().stream()\n@@ -357,1 +363,1 @@\n-        var comment = request.post(\"issues\/\" + json.get(\"number\").toString() + \"\/comments\")\n+        var comment = request.post(\"issues\/\" + this.id() + \"\/comments\")\n@@ -401,2 +407,32 @@\n-        if (json.get(\"state\").asString().equals(\"open\")) {\n-            return State.OPEN;\n+        return json.get(\"state\").asString().equals(\"open\") ? State.OPEN :\n+              (json.get(\"merged_at\").isNull() ? State.CLOSED : State.RESOLVED);\n+    }\n+\n+    @Override\n+    public void setState(State state) {\n+        if (state == State.RESOLVED) {\n+\n+           \/*\n+            *\n+            * SKARA-1663: Implement State.RESOLVED as a squash merge, until GitHub\n+            * allows for marking a Pull Request as merged in the future.\n+            *\n+            * If a method for actual merging is required, the following implementation\n+            * will suffice for the different types of merges GitHub allows for:\n+            *\n+            * request.put(\"pulls\/\" + this.id() + \"\/merge\").body(\"merge_method\", \"merge\")\n+            *        .execute();\n+            *\n+            * Where \"merge_method\" can be set to one of: \"rebase\", \"squash\", or \"merge\"\n+            *\n+            *\/\n+\n+            this.setTargetRef(\"integration\/\" + this.id() + \"\/\" + this.targetRef());\n+            request.put(\"pulls\/\" + this.id() + \"\/merge\")\n+                   .body(\"merge_method\", \"squash\")\n+                   .execute();\n+            this.repository().deleteBranch(\"integration\/\" + this.id() + \"\/\" + this.targetRef());\n+        } else {\n+            request.patch(\"pulls\/\" + this.id())\n+                   .body(\"state\", state == State.OPEN ? \"open\" : \"closed\")\n+                   .execute();\n@@ -404,1 +440,0 @@\n-        return State.CLOSED;\n@@ -530,7 +565,0 @@\n-    @Override\n-    public void setState(State state) {\n-        request.patch(\"pulls\/\" + json.get(\"number\").toString())\n-               .body(\"state\", state != State.OPEN ? \"closed\" : \"open\")\n-               .execute();\n-    }\n-\n@@ -541,1 +569,1 @@\n-        request.post(\"issues\/\" + json.get(\"number\").toString() + \"\/labels\")\n+        request.post(\"issues\/\" + this.id() + \"\/labels\")\n@@ -549,1 +577,1 @@\n-        request.delete(\"issues\/\" + json.get(\"number\").toString() + \"\/labels\/\" + label)\n+        request.delete(\"issues\/\" + this.id() + \"\/labels\/\" + label)\n@@ -567,1 +595,1 @@\n-        var newLabels = request.put(\"issues\/\" + json.get(\"number\").toString() + \"\/labels\")\n+        var newLabels = request.put(\"issues\/\" + this.id() + \"\/labels\")\n@@ -579,1 +607,1 @@\n-            labels = request.get(\"issues\/\" + json.get(\"number\").toString() + \"\/labels\").execute().stream()\n+            labels = request.get(\"issues\/\" + this.id() + \"\/labels\").execute().stream()\n@@ -624,1 +652,1 @@\n-        request.patch(\"issues\/\" + json.get(\"number\").toString()).body(param).execute();\n+        request.patch(\"issues\/\" + this.id()).body(param).execute();\n@@ -711,1 +739,1 @@\n-        return request.get(\"issues\/\" + json.get(\"number\").toString() + \"\/timeline\")\n+        return request.get(\"issues\/\" + this.id() + \"\/timeline\")\n@@ -724,1 +752,1 @@\n-        request.patch(\"pulls\/\" + json.get(\"number\").toString())\n+        request.patch(\"pulls\/\" + this.id())\n@@ -737,1 +765,1 @@\n-        var files = request.get(\"pulls\/\" + json.get(\"number\").toString() + \"\/files\")\n+        var files = request.get(\"pulls\/\" + this.id() + \"\/files\")\n@@ -750,1 +778,1 @@\n-        return request.get(\"issues\/\" + json.get(\"number\").toString() + \"\/timeline\")\n+        return request.get(\"issues\/\" + this.id() + \"\/timeline\")\n@@ -768,1 +796,1 @@\n-        var timelineJSON = request.get(\"issues\/\" + json.get(\"number\").toString() + \"\/timeline\")\n+        var timelineJSON = request.get(\"issues\/\" + this.id() + \"\/timeline\")\n","filename":"forge\/src\/main\/java\/org\/openjdk\/skara\/forge\/github\/GitHubPullRequest.java","additions":59,"deletions":31,"binary":false,"changes":90,"status":"modified"},{"patch":"@@ -346,2 +346,7 @@\n-        var targetRef = json.get(\"target_branch\").asString();\n-        return targetRef;\n+\tif (this.state() == State.RESOLVED) {\n+            \/\/ Integrated special case\n+            return json.get(\"target_branch\").asString()\n+                       .substring((\"integration\/\" + this.id() + \"\/\").length());\n+\t} else {\n+            return json.get(\"target_branch\").asString();\n+\t}\n@@ -439,2 +444,34 @@\n-        if (json.get(\"state\").asString().equals(\"opened\")) {\n-            return State.OPEN;\n+        final String state = json.get(\"state\").asString();\n+        return state.equals(\"opened\") ? State.OPEN :\n+              (state.equals(\"merged\") ? State.RESOLVED : State.CLOSED);\n+    }\n+\n+    @Override\n+    public void setState(State state) {\n+        if (state == State.RESOLVED) {\n+\n+            \/*\n+             *\n+             * SKARA-1663: Implement State.RESOLVED as a squash merge, until GitLab\n+             * allows for marking a Pull Request as merged in the future.\n+             *\n+             * If a method for actual merging is required, the following implementations\n+             * will suffice for the different types of merges GitLab allows for:\n+             *\n+             * (In order of merge methods: Rebase, Merge, and Squash)\n+             *\n+             * request.put(\"rebase\").execute();\n+             * request.put(\"merge\").body(JSON.object().put(\"squash\", false)).execute();\n+             * request.put(\"merge\").body(JSON.object().put(\"squash\", true)).execute();\n+             *\n+             *\/\n+\n+            this.setTargetRef(\"integration\/\" + this.id() + \"\/\" + this.targetRef());\n+            request.put(\"merge\")\n+                   .body(JSON.object().put(\"squash\", true))\n+                   .execute();\n+            this.repository().deleteBranch(\"integration\/\" + this.id() + \"\/\" + this.targetRef());\n+        } else {\n+            request.put(\"\")\n+                   .body(\"state_event\", state == State.OPEN ? \"reopen\" : \"close\")\n+                   .execute();\n@@ -442,1 +479,0 @@\n-        return State.CLOSED;\n@@ -641,7 +677,0 @@\n-    @Override\n-    public void setState(State state) {\n-        request.put(\"\")\n-               .body(\"state_event\", state != State.OPEN ? \"close\" : \"reopen\")\n-               .execute();\n-    }\n-\n","filename":"forge\/src\/main\/java\/org\/openjdk\/skara\/forge\/gitlab\/GitLabMergeRequest.java","additions":41,"deletions":12,"binary":false,"changes":53,"status":"modified"},{"patch":"@@ -604,0 +604,7 @@\n+        \/*\n+         * Specify what destination ref to update with what source object.\n+         * The format of a <refspec> parameter is an optional plus +, followed by\n+         * the source object, followed by a colon :, followed by the destination ref\n+         *\n+         * https:\/\/git-scm.com\/docs\/git-push\n+         *\/\n","filename":"vcs\/src\/main\/java\/org\/openjdk\/skara\/vcs\/git\/GitRepository.java","additions":7,"deletions":0,"binary":false,"changes":7,"status":"modified"}]}