{"files":[{"patch":"@@ -195,1 +195,24 @@\n-            Repository localRepo = materializeLocalRepo(bot, pr, scratchPath, \"integrate\");\n+            Repository localRepo = new HostedRepositoryPool(bot.seedStorage().orElse(scratchPath.resolve(\"seeds\")))\n+                    .materialize(pr.repository(), scratchPath.resolve(pr.headHash().hex()));\n+            localRepo.fetch(pr.repository().url(), pr.targetRef(), true);\n+            localRepo.checkout(new Branch(pr.targetRef()), false);\n+\n+            \/\/ See markIntegratedAndMerged for the logic for rogue mark as merged handling\n+            Commit currentMarkAsMergedCommit;\n+            Commit lastMarkAsMergedCommit;\n+\n+            final List<Commit> commits = localRepo.commits(2).asList();\n+            commits.forEach(commit -> log.fine(commit.toString()));\n+            currentMarkAsMergedCommit = isMarkAsMergeCommit(commits.get(0)) ? commits.get(0) : null;\n+            lastMarkAsMergedCommit =\n+                    (commits.size() == 2 ? (isMarkAsMergeCommit(commits.get(1)) ? commits.get(1) : null) : null);\n+\n+            if (lastMarkAsMergedCommit != null) {\n+                localRepo.reset(lastMarkAsMergedCommit.parents().get(0), true);\n+        \tlocalRepo.push(lastMarkAsMergedCommit.parents().get(0), pr.repository().url(), pr.targetRef(), true);\n+            } else if (currentMarkAsMergedCommit != null) {\n+                localRepo.reset(currentMarkAsMergedCommit.parents().get(0), true);\n+                localRepo.push(currentMarkAsMergedCommit.parents().get(0), pr.repository().url(), pr.targetRef(), true);\n+            }\n+\n+            localRepo = materializeLocalRepo(bot, pr, scratchPath, \"integrate\");\n@@ -340,1 +363,1 @@\n-                      .materialize(pr.repository(), scratchPath.resolve(hash.hex()));\n+                      .materialize(pr.repository(), scratchPath.resolve(pr.headHash().hex()));\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/IntegrateCommand.java","additions":25,"deletions":2,"binary":false,"changes":27,"status":"modified"},{"patch":"@@ -27,0 +27,2 @@\n+import org.openjdk.skara.vcs.Branch;\n+import org.openjdk.skara.vcs.Commit;\n@@ -28,0 +30,1 @@\n+import org.openjdk.skara.vcs.Repository;\n@@ -97,1 +100,24 @@\n-            var localRepo = IntegrateCommand.materializeLocalRepo(bot, pr, scratchPath, \"sponsor\");\n+            Repository localRepo = new HostedRepositoryPool(bot.seedStorage().orElse(scratchPath.resolve(\"seeds\")))\n+                    .materialize(pr.repository(), scratchPath.resolve(pr.headHash().hex()));\n+            localRepo.fetch(pr.repository().url(), pr.targetRef(), true);\n+            localRepo.checkout(new Branch(pr.targetRef()), false);\n+\n+            \/\/ See markIntegratedAndMerged for the logic for rogue mark as merged handling\n+            Commit currentMarkAsMergedCommit;\n+            Commit lastMarkAsMergedCommit;\n+\n+            final List<Commit> commits = localRepo.commits(2).asList();\n+            commits.forEach(commit -> log.fine(commit.toString()));\n+            currentMarkAsMergedCommit = IntegrateCommand.isMarkAsMergeCommit(commits.get(0)) ? commits.get(0) : null;\n+            lastMarkAsMergedCommit =\n+                    (commits.size() == 2 ? (IntegrateCommand.isMarkAsMergeCommit(commits.get(1)) ? commits.get(1) : null) : null);\n+\n+            if (lastMarkAsMergedCommit != null) {\n+                localRepo.reset(lastMarkAsMergedCommit.parents().get(0), true);\n+        \tlocalRepo.push(lastMarkAsMergedCommit.parents().get(0), pr.repository().url(), pr.targetRef(), true);\n+            } else if (currentMarkAsMergedCommit != null) {\n+                localRepo.reset(currentMarkAsMergedCommit.parents().get(0), true);\n+                localRepo.push(currentMarkAsMergedCommit.parents().get(0), pr.repository().url(), pr.targetRef(), true);\n+            }\n+\n+            localRepo = IntegrateCommand.materializeLocalRepo(bot, pr, scratchPath, \"sponsor\");\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/SponsorCommand.java","additions":27,"deletions":1,"binary":false,"changes":28,"status":"modified"}]}