{"files":[{"patch":"@@ -120,1 +120,1 @@\n-    private boolean ignoreComment(HostUser author, String body) {\n+    private boolean ignoreComment(HostUser author, String body, ZonedDateTime createdTime) {\n@@ -141,0 +141,8 @@\n+        \/\/ If the pull request was converted to draft, the comments\n+        \/\/ after the last converted time should be ignored.\n+        if (pr.isDraft()) {\n+            var lastDraftTime = pr.lastMarkedAsDraftTime();\n+            if (lastDraftTime.isPresent() && lastDraftTime.get().isBefore(createdTime)) {\n+                return true;\n+            }\n+        }\n@@ -341,1 +349,1 @@\n-                if (ignoreComment(comment.author(), comment.body())) {\n+                if (ignoreComment(comment.author(), comment.body(), comment.createdAt())) {\n@@ -351,1 +359,1 @@\n-                if (ignoreComment(review.reviewer(), review.body().orElse(\"\"))) {\n+                if (ignoreComment(review.reviewer(), review.body().orElse(\"\"), review.createdAt())) {\n@@ -363,1 +371,1 @@\n-                if (ignoreComment(reviewComment.author(), reviewComment.body())) {\n+                if (ignoreComment(reviewComment.author(), reviewComment.body(), reviewComment.createdAt())) {\n","filename":"bots\/mlbridge\/src\/main\/java\/org\/openjdk\/skara\/bots\/mlbridge\/ArchiveWorkItem.java","additions":12,"deletions":4,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2019, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2019, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -206,1 +206,0 @@\n-                .filter(pr -> !pr.isDraft())\n","filename":"bots\/mlbridge\/src\/main\/java\/org\/openjdk\/skara\/bots\/mlbridge\/MailingListBridgeBot.java","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -3554,0 +3554,30 @@\n+\n+            \/\/ Add a new comment before making it as draft.\n+            pr.addComment(\"This is a comment before making\");\n+\n+            \/\/ Make it as draft again.\n+            pr.makeDraft();\n+\n+            \/\/ Add a new comment after making it as draft.\n+            pr.addComment(\"This is a comment after making\");\n+\n+            \/\/ Run another archive pass.\n+            TestBotRunner.runPeriodicItems(mlBot);\n+\n+            \/\/ The archive should only contain the comments before making it as draft.\n+            Repository.materialize(archiveFolder.path(), archive.url(), \"master\");\n+            assertEquals(4, archiveContainsCount(archiveFolder.path(), \"RFR: 1234: This is a pull request\"));\n+            assertEquals(1, archiveContainsCount(archiveFolder.path(), \"This is a comment before making\"));\n+            assertFalse(archiveContains(archiveFolder.path(), \"This is a comment after making\"));\n+\n+            \/\/ Make it as not draft again.\n+            pr.makeNotDraft();\n+\n+            \/\/ Run another archive pass.\n+            TestBotRunner.runPeriodicItems(mlBot);\n+\n+            \/\/ The archive should now contain all the comments.\n+            Repository.materialize(archiveFolder.path(), archive.url(), \"master\");\n+            assertEquals(5, archiveContainsCount(archiveFolder.path(), \"RFR: 1234: This is a pull request\"));\n+            assertEquals(1, archiveContainsCount(archiveFolder.path(), \"This is a comment before making\"));\n+            assertEquals(1, archiveContainsCount(archiveFolder.path(), \"This is a comment after making\"));\n","filename":"bots\/mlbridge\/src\/test\/java\/org\/openjdk\/skara\/bots\/mlbridge\/MailingListBridgeBotTests.java","additions":30,"deletions":0,"binary":false,"changes":30,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2019, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2019, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -296,0 +296,5 @@\n+    @Override\n+    public Optional<ZonedDateTime> lastMarkedAsDraftTime() {\n+        return Optional.empty();\n+    }\n+\n","filename":"bots\/tester\/src\/test\/java\/org\/openjdk\/skara\/bots\/tester\/InMemoryPullRequest.java","additions":6,"deletions":1,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2018, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2018, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -166,0 +166,10 @@\n+    \/**\n+     * Return the last time the pull request was converted to draft.\n+     * If the pull request was created as draft, return the created time of the pull request.\n+     * If the pull request was always ready for review and never converted to draft, return empty.\n+     * If the restful api doesn't support draft pull request, return empty.\n+     * Note: if the pull request was created as draft, but later converted to ready\n+     *  and didn't convert to draft again, this method will return empty.\n+     *\/\n+    Optional<ZonedDateTime> lastMarkedAsDraftTime();\n+\n","filename":"forge\/src\/main\/java\/org\/openjdk\/skara\/forge\/PullRequest.java","additions":11,"deletions":1,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2018, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2018, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -706,0 +706,14 @@\n+    @Override\n+    public Optional<ZonedDateTime> lastMarkedAsDraftTime() {\n+        var lastMarkedAsDraftTime = request.get(\"issues\/\" + json.get(\"number\").toString() + \"\/timeline\")                .execute().stream()\n+                .map(JSONValue::asObject)\n+                .filter(obj -> obj.contains(\"event\"))\n+                .filter(obj -> obj.get(\"event\").asString().equals(\"convert_to_draft\"))\n+                .reduce((a, b) -> b)\n+                .map(obj -> ZonedDateTime.parse(obj.get(\"created_at\").asString()));\n+        if (lastMarkedAsDraftTime.isEmpty() && isDraft()) {\n+            return Optional.of(createdAt());\n+        }\n+        return lastMarkedAsDraftTime;\n+    }\n+\n","filename":"forge\/src\/main\/java\/org\/openjdk\/skara\/forge\/github\/GitHubPullRequest.java","additions":15,"deletions":1,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2018, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2018, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -784,0 +784,16 @@\n+    @Override\n+    public Optional<ZonedDateTime> lastMarkedAsDraftTime() {\n+        var draftMessage = \"marked this merge request as **draft**\";\n+        var notes = request.get(\"notes\").execute();\n+        var lastMarkedAsDraftTime = notes.stream()\n+                .map(JSONValue::asObject)\n+                .filter(obj -> obj.get(\"system\").asBoolean())\n+                .filter(obj -> draftMessage.equals(obj.get(\"body\").asString()))\n+                .reduce((a, b) -> a)\n+                .map(obj -> ZonedDateTime.parse(obj.get(\"created_at\").asString()));\n+        if (lastMarkedAsDraftTime.isEmpty() && isDraft()) {\n+            return Optional.of(createdAt());\n+        }\n+        return lastMarkedAsDraftTime;\n+    }\n+\n","filename":"forge\/src\/main\/java\/org\/openjdk\/skara\/forge\/gitlab\/GitLabMergeRequest.java","additions":17,"deletions":1,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2022, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -214,0 +214,10 @@\n+\n+    @Test\n+    void testLastMarkedAsDraftTime() {\n+        var githubRepoOpt = githubHost.repository(\"openjdk\/playground\");\n+        assumeTrue(githubRepoOpt.isPresent());\n+        var githubRepo = githubRepoOpt.get();\n+        var pr = githubRepo.pullRequest(\"129\");\n+        var lastMarkedAsDraftTime = pr.lastMarkedAsDraftTime();\n+        assertEquals(\"2023-02-11T11:51:12Z\", lastMarkedAsDraftTime.get().toString());\n+    }\n","filename":"forge\/src\/test\/java\/org\/openjdk\/skara\/forge\/github\/GitHubRestApiTests.java","additions":11,"deletions":1,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2022, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -221,0 +221,15 @@\n+\n+    @Test\n+    void testLastMarkedAsDraftTime() throws IOException {\n+        var settings = ManualTestSettings.loadManualTestSettings();\n+        var username = settings.getProperty(\"gitlab.user\");\n+        var token = settings.getProperty(\"gitlab.pat\");\n+        var credential = new Credential(username, token);\n+        var uri = URIBuilder.base(settings.getProperty(\"gitlab.uri\")).build();\n+        var gitLabHost = new GitLabHost(\"gitlab\", uri, false, credential, Set.of());\n+        var gitLabRepo = gitLabHost.repository(settings.getProperty(\"gitlab.repository\")).orElseThrow();\n+        var gitLabMergeRequest = gitLabRepo.pullRequest(settings.getProperty(\"gitlab.merge.request.id\"));\n+\n+        var lastMarkedAsDraftTime = gitLabMergeRequest.lastMarkedAsDraftTime();\n+        assertEquals(\"2023-02-11T08:43:52.408Z\", lastMarkedAsDraftTime.get().toString());\n+    }\n","filename":"forge\/src\/test\/java\/org\/openjdk\/skara\/forge\/gitlab\/GitLabRestApiTest.java","additions":16,"deletions":1,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -232,0 +232,5 @@\n+    @Override\n+    public Optional<ZonedDateTime> lastMarkedAsDraftTime() {\n+        return Optional.ofNullable(store().lastMarkedAsDraftTime());\n+    }\n+\n","filename":"test\/src\/main\/java\/org\/openjdk\/skara\/test\/TestPullRequest.java","additions":5,"deletions":0,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2019, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2019, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -51,0 +51,1 @@\n+    private ZonedDateTime lastMarkedAsDraftTime;\n@@ -59,1 +60,3 @@\n-        if (!draft) {\n+        if (draft) {\n+            lastMarkedAsDraftTime = ZonedDateTime.now();\n+        } else {\n@@ -132,1 +135,3 @@\n-        if (!draft) {\n+        if (draft) {\n+            lastMarkedAsDraftTime = ZonedDateTime.now();\n+        } else {\n@@ -144,0 +149,4 @@\n+\n+    public ZonedDateTime lastMarkedAsDraftTime() {\n+        return lastMarkedAsDraftTime;\n+    }\n","filename":"test\/src\/main\/java\/org\/openjdk\/skara\/test\/TestPullRequestStore.java","additions":12,"deletions":3,"binary":false,"changes":15,"status":"modified"}]}