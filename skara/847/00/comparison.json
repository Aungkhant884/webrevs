{"files":[{"patch":"@@ -32,0 +32,1 @@\n+    requires java.net.http;\n","filename":"bots\/notify\/src\/main\/java\/module-info.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -58,1 +58,1 @@\n-                var jbsVault = new JbsVault(vaultUrl, credential.password());\n+                var jbsVault = new JbsVault(vaultUrl, credential.password(), issueProject.webUrl());\n","filename":"bots\/notify\/src\/main\/java\/org\/openjdk\/skara\/bots\/notify\/issue\/IssueNotifierFactory.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -25,1 +25,2 @@\n-import org.openjdk.skara.network.RestRequest;\n+import org.openjdk.skara.json.JSON;\n+import org.openjdk.skara.network.*;\n@@ -30,1 +31,0 @@\n-import java.time.*;\n@@ -37,0 +37,1 @@\n+    private final URI authProbe;\n@@ -40,1 +41,0 @@\n-    private Instant expires;\n@@ -52,1 +52,1 @@\n-    JbsVault(URI vaultUri, String vaultToken) {\n+    JbsVault(URI vaultUri, String vaultToken, URI jiraUri) {\n@@ -57,0 +57,1 @@\n+        this.authProbe = URIBuilder.base(jiraUri).setPath(\"\/rest\/api\/2\/myself\").build();\n@@ -60,5 +61,8 @@\n-        if ((cookie == null) || Instant.now().isAfter(expires)) {\n-            var result = request.get(\"\").execute();\n-            cookie = result.get(\"data\").get(\"cookie.name\").asString() + \"=\" + result.get(\"data\").get(\"cookie.value\").asString();\n-            expires = Instant.now().plus(Duration.ofSeconds(result.get(\"lease_duration\").asInt()).dividedBy(2));\n-            log.info(\"Renewed Jira token (\" + cookie + \") - expires \" + expires);\n+        if (cookie != null) {\n+            var authProbeRequest = new RestRequest(authProbe, authId, () -> Arrays.asList(\"Cookie\", cookie));\n+            var res = authProbeRequest.get()\n+                                      .onError(error -> error.statusCode() >= 400 ? Optional.of(JSON.of(\"AUTH_ERROR\")) : Optional.empty())\n+                                      .execute();\n+            if (res.isObject() && !res.contains(\"AUTH_ERROR\")) {\n+                return cookie;\n+            }\n@@ -66,0 +70,5 @@\n+\n+        \/\/ Renewal time\n+        var result = request.get(\"\").execute();\n+        cookie = result.get(\"data\").get(\"cookie.name\").asString() + \"=\" + result.get(\"data\").get(\"cookie.value\").asString();\n+        log.info(\"Renewed Jira token (\" + cookie + \")\");\n","filename":"bots\/notify\/src\/main\/java\/org\/openjdk\/skara\/bots\/notify\/issue\/JbsVault.java","additions":18,"deletions":9,"binary":false,"changes":27,"status":"modified"},{"patch":"@@ -45,1 +45,1 @@\n-                var jiraVault = new JiraVault(vaultUrl, credential.password());\n+                var jiraVault = new JiraVault(vaultUrl, credential.password(), uri);\n","filename":"issuetracker\/src\/main\/java\/org\/openjdk\/skara\/issuetracker\/jira\/JiraIssueTrackerFactory.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -25,1 +25,2 @@\n-import org.openjdk.skara.network.RestRequest;\n+import org.openjdk.skara.json.JSON;\n+import org.openjdk.skara.network.*;\n@@ -30,1 +31,0 @@\n-import java.time.*;\n@@ -37,0 +37,1 @@\n+    private final URI authProbe;\n@@ -40,1 +41,0 @@\n-    private Instant expires;\n@@ -52,1 +52,1 @@\n-    JiraVault(URI vaultUri, String vaultToken) {\n+    JiraVault(URI vaultUri, String vaultToken, URI jiraUri) {\n@@ -57,0 +57,1 @@\n+        this.authProbe = URIBuilder.base(jiraUri).setPath(\"\/rest\/api\/2\/myself\").build();\n@@ -60,5 +61,8 @@\n-        if ((cookie == null) || Instant.now().isAfter(expires)) {\n-            var result = request.get(\"\").execute();\n-            cookie = result.get(\"data\").get(\"cookie.name\").asString() + \"=\" + result.get(\"data\").get(\"cookie.value\").asString();\n-            expires = Instant.now().plus(Duration.ofSeconds(result.get(\"lease_duration\").asInt()).dividedBy(2));\n-            log.info(\"Renewed Jira token (\" + cookie + \") - expires \" + expires);\n+        if (cookie != null) {\n+            var authProbeRequest = new RestRequest(authProbe, authId, () -> Arrays.asList(\"Cookie\", cookie));\n+            var res = authProbeRequest.get()\n+                    .onError(error -> error.statusCode() >= 400 ? Optional.of(JSON.of(\"AUTH_ERROR\")) : Optional.empty())\n+                    .execute();\n+            if (res.isObject() && !res.contains(\"AUTH_ERROR\")) {\n+                return cookie;\n+            }\n@@ -66,0 +70,5 @@\n+\n+        \/\/ Renewal time\n+        var result = request.get(\"\").execute();\n+        cookie = result.get(\"data\").get(\"cookie.name\").asString() + \"=\" + result.get(\"data\").get(\"cookie.value\").asString();\n+        log.info(\"Renewed Jira token (\" + cookie + \")\");\n","filename":"issuetracker\/src\/main\/java\/org\/openjdk\/skara\/issuetracker\/jira\/JiraVault.java","additions":18,"deletions":9,"binary":false,"changes":27,"status":"modified"}]}