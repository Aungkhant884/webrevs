{"files":[{"patch":"@@ -167,1 +167,1 @@\n-        if (!hasCsrIssueAndProgress(pr, csr)) {\n+        if (!hasCsrIssueAndProgress(pr, csr) && !isWithdrawnCSR(csr)) {\n@@ -256,0 +256,13 @@\n+\n+    private boolean isWithdrawnCSR(Issue csr) {\n+        if (csr.isClosed()) {\n+            var resolution = csr.properties().get(\"resolution\");\n+            if (resolution != null && !resolution.isNull()) {\n+                var name = resolution.get(\"name\");\n+                if (name != null && !name.isNull() && name.asString().equals(\"Withdrawn\")) {\n+                    return true;\n+                }\n+            }\n+        }\n+        return false;\n+    }\n","filename":"bots\/csr\/src\/main\/java\/org\/openjdk\/skara\/bots\/csr\/PullRequestWorkItem.java","additions":14,"deletions":1,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -508,0 +508,52 @@\n+\n+    @Test\n+    void testCsrUpdateMarkerWithWithdrawnCSRIssue(TestInfo testInfo) throws IOException {\n+        String csrUpdateMarker = \"<!-- csr: 'update' -->\";\n+        String progressMarker = \"<!-- Anything below this marker will be automatically updated, please do not edit manually! -->\";\n+        try (var credentials = new HostCredentials(testInfo);\n+             var tempFolder = new TemporaryDirectory()) {\n+            var repo = credentials.getHostedRepository();\n+            var issueProject = credentials.getIssueProject();\n+            var issue = issueProject.createIssue(\"This is an issue\", List.of(), Map.of());\n+            issue.setProperty(\"issuetype\", JSON.of(\"Bug\"));\n+            var csrPullRequestBot = new CSRPullRequestBot(repo, issueProject);\n+            var csrIssueBot = new CSRIssueBot(issueProject, List.of(repo));\n+\n+            \/\/ Run issue bot once to initialize lastUpdatedAt\n+            TestBotRunner.runPeriodicItems(csrIssueBot);\n+\n+            \/\/ Populate the projects repository\n+            var localRepoFolder = tempFolder.path().resolve(\"localrepo\");\n+            var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());\n+            var masterHash = localRepo.resolve(\"master\").orElseThrow();\n+            assertFalse(CheckableRepository.hasBeenEdited(localRepo));\n+            localRepo.push(masterHash, repo.url(), \"master\", true);\n+\n+            \/\/ Make a change with a corresponding PR\n+            var editHash = CheckableRepository.appendAndCommit(localRepo);\n+            localRepo.push(editHash, repo.url(), \"edit\", true);\n+            var pr = credentials.createPullRequest(repo, \"master\", \"edit\", issue.id() + \": This is an issue\");\n+            \/\/ Add the notification link to the PR in the issue. This is needed for the CSRIssueBot to\n+            \/\/ be able to trigger on CSR issue updates\n+            PullRequestUtils.postPullRequestLinkComment(issue, pr);\n+            \/\/ Run bot\n+            TestBotRunner.runPeriodicItems(csrPullRequestBot);\n+            \/\/ The bot shouldn't add the csr update marker\n+            assertFalse(pr.store().body().contains(csrUpdateMarker));\n+\n+            \/\/ Add a withdrawn csr issue.\n+            var csr = issueProject.createIssue(\"This is an CSR\", List.of(), Map.of());\n+            csr.setProperty(\"issuetype\", JSON.of(\"CSR\"));\n+            csr.setState(Issue.State.CLOSED);\n+            csr.setProperty(\"resolution\", JSON.object().put(\"name\", \"Withdrawn\"));\n+            issue.addLink(Link.create(csr, \"csr for\").build());\n+            \/\/ Run just the pull request bot\n+            TestBotRunner.runPeriodicItems(csrPullRequestBot);\n+            \/\/ Nothing should have happened\n+            assertFalse(pr.store().body().contains(csrUpdateMarker));\n+            \/\/ Run csr issue bot to trigger updates on the CSR issue\n+            TestBotRunner.runPeriodicItems(csrIssueBot);\n+            \/\/ The bot should not add the csr update marker\n+            assertFalse(pr.store().body().contains(csrUpdateMarker));\n+        }\n+    }\n","filename":"bots\/csr\/src\/test\/java\/org\/openjdk\/skara\/bots\/csr\/CSRBotTests.java","additions":52,"deletions":0,"binary":false,"changes":52,"status":"modified"}]}