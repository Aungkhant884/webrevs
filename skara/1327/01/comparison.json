{"files":[{"patch":"@@ -40,0 +40,2 @@\n+    private final static String CSR_UPDATE_MARKER = \"<!-- csr: 'update' -->\";\n+    private static final String PROGRESS_MARKER = \"<!-- Anything below this marker will be automatically updated, please do not edit manually! -->\";\n@@ -65,1 +67,1 @@\n-    public static Optional<JdkVersion> getVersion(PullRequest pullRequest) {\n+    private static Optional<JdkVersion> getVersion(PullRequest pullRequest) {\n@@ -75,0 +77,36 @@\n+    private boolean hasCsrIssueAndProgress(PullRequest pr, Issue csr) {\n+        var statusMessage = getStatusMessage(pr);\n+        return hasCsrIssue(statusMessage, csr) &&\n+               (statusMessage.contains(\"- [ ] Change requires a CSR request to be approved\") ||\n+                statusMessage.contains(\"- [x] Change requires a CSR request to be approved\"));\n+    }\n+\n+    private boolean hasCsrIssueAndProgressChecked(PullRequest pr, Issue csr) {\n+        var statusMessage = getStatusMessage(pr);\n+        return hasCsrIssue(statusMessage, csr) && statusMessage.contains(\"- [x] Change requires a CSR request to be approved\");\n+    }\n+\n+    private boolean hasCsrIssue(String statusMessage, Issue csr) {\n+        return statusMessage.contains(csr.id()) &&\n+               statusMessage.contains(csr.webUrl().toString()) &&\n+               statusMessage.contains(csr.title() + \" (**CSR**)\");\n+    }\n+\n+    private String getStatusMessage(PullRequest pr) {\n+        var lastIndex = pr.body().lastIndexOf(PROGRESS_MARKER);\n+        if (lastIndex == -1) {\n+            return \"\";\n+        } else {\n+            return pr.body().substring(lastIndex);\n+        }\n+    }\n+\n+    private void addUpdateMarker(PullRequest pr) {\n+        var statusMessage = getStatusMessage(pr);\n+        if (!statusMessage.contains(CSR_UPDATE_MARKER)) {\n+            pr.setBody(pr.body() + \"\\n\" + CSR_UPDATE_MARKER + \"\\n\");\n+        } else {\n+            log.info(\"The pull request \" + describe(pr) + \" has already had a csr update marker. Do not need to add it again.\");\n+        }\n+    }\n+\n@@ -104,1 +142,8 @@\n-            log.info(\"Found CSR for \" + describe(pr) + \". It has id \" + csr.id());\n+            log.info(\"Found CSR \" + csr.id() + \" for \" + describe(pr));\n+            if (!hasCsrIssueAndProgress(pr, csr)) {\n+                \/\/ If the PR body doesn't have the CSR issue or doesn't have the CSR progress,\n+                \/\/ this bot need to add the csr update marker so that the PR bot can update the message of the PR body.\n+                log.info(\"The PR body doesn't have the CSR issue or progress, adding the csr update marker for \" + describe(pr));\n+                addUpdateMarker(pr);\n+            }\n+\n@@ -156,0 +201,6 @@\n+            if (!hasCsrIssueAndProgressChecked(pr, csr)) {\n+                \/\/ If the PR body doesn't have the CSR issue or doesn't have the CSR progress or the CSR progress checkbox is not selected,\n+                \/\/ this bot need to add the csr update marker so that the PR bot can update the message of the PR body.\n+                log.info(\"CSR closed and approved for \" + describe(pr) + \", adding the csr update marker\");\n+                addUpdateMarker(pr);\n+            }\n","filename":"bots\/csr\/src\/main\/java\/org\/openjdk\/skara\/bots\/csr\/CSRBot.java","additions":53,"deletions":2,"binary":false,"changes":55,"status":"modified"},{"patch":"@@ -409,0 +409,71 @@\n+\n+    @Test\n+    void testCsrUpdateMarker(TestInfo testInfo) throws IOException {\n+        String csrUpdateMarker = \"<!-- csr: 'update' -->\";\n+        String progressMarker = \"<!-- Anything below this marker will be automatically updated, please do not edit manually! -->\";\n+        try (var credentials = new HostCredentials(testInfo);\n+             var tempFolder = new TemporaryDirectory()) {\n+            var repo = credentials.getHostedRepository();\n+            var issueProject = credentials.getIssueProject();\n+            var issue = issueProject.createIssue(\"This is an issue\", List.of(), Map.of());\n+            var bot = new CSRBot(repo, issueProject);\n+\n+            \/\/ Populate the projects repository\n+            var localRepoFolder = tempFolder.path().resolve(\"localrepo\");\n+            var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());\n+            var masterHash = localRepo.resolve(\"master\").orElseThrow();\n+            assertFalse(CheckableRepository.hasBeenEdited(localRepo));\n+            localRepo.push(masterHash, repo.url(), \"master\", true);\n+\n+            \/\/ Make a change with a corresponding PR\n+            var editHash = CheckableRepository.appendAndCommit(localRepo);\n+            localRepo.push(editHash, repo.url(), \"edit\", true);\n+            var pr = credentials.createPullRequest(repo, \"master\", \"edit\", issue.id() + \": This is an issue\");\n+            \/\/ Run bot\n+            TestBotRunner.runPeriodicItems(bot);\n+            \/\/ The bot shouldn't add the csr update marker\n+            assertFalse(pr.body().contains(csrUpdateMarker));\n+\n+            \/\/ Add the csr issue.\n+            var csr = issueProject.createIssue(\"This is an CSR\", List.of(), Map.of());\n+            csr.setState(Issue.State.OPEN);\n+            issue.addLink(Link.create(csr, \"csr for\").build());\n+            \/\/ Run bot\n+            TestBotRunner.runPeriodicItems(bot);\n+            \/\/ The bot should add the csr update marker\n+            assertTrue(pr.body().contains(csrUpdateMarker));\n+\n+            \/\/ Add csr issue and progress to the PR body\n+            pr.setBody(\"PR body\\n\" + progressMarker + csr.id() + csr.webUrl().toString() + csr.title() + \" (**CSR**)\"\n+                    + \"- [ ] Change requires a CSR request to be approved\");\n+            \/\/ Run bot\n+            TestBotRunner.runPeriodicItems(bot);\n+            \/\/ The bot shouldn't add the csr update marker\n+            assertFalse(pr.body().contains(csrUpdateMarker));\n+\n+            \/\/ Set csr status to closed and approved.\n+            csr.setState(Issue.State.CLOSED);\n+            csr.setProperty(\"resolution\", JSON.object().put(\"name\", \"Approved\"));\n+            \/\/ Run bot\n+            TestBotRunner.runPeriodicItems(bot);\n+            \/\/ The bot should add the csr update marker\n+            assertTrue(pr.body().contains(csrUpdateMarker));\n+\n+            \/\/ Add csr issue and selected progress to the PR body\n+            pr.setBody(\"PR body\\n\" + progressMarker + csr.id() + csr.webUrl().toString() + csr.title() + \" (**CSR**)\"\n+                    + \"- [x] Change requires a CSR request to be approved\");\n+            \/\/ Run bot\n+            TestBotRunner.runPeriodicItems(bot);\n+            \/\/ The bot shouldn't add the csr update marker\n+            assertFalse(pr.body().contains(csrUpdateMarker));\n+\n+            \/\/ Add csr update marker to the pull request body manually.\n+            pr.setBody(\"PR body\\n\" + progressMarker + csr.id() + csr.webUrl().toString() + csr.title() + \" (**CSR**)\"\n+                    + \"- [ ] Change requires a CSR request to be approved\" + csrUpdateMarker);\n+            \/\/ Run bot\n+            TestBotRunner.runPeriodicItems(bot);\n+            \/\/ The bot shouldn't add the csr update marker again. The PR should have only one csr update marker.\n+            assertTrue(pr.body().contains(csrUpdateMarker));\n+            assertEquals(pr.body().indexOf(csrUpdateMarker), pr.body().lastIndexOf(csrUpdateMarker));\n+        }\n+    }\n","filename":"bots\/csr\/src\/test\/java\/org\/openjdk\/skara\/bots\/csr\/CSRBotTests.java","additions":71,"deletions":0,"binary":false,"changes":71,"status":"modified"},{"patch":"@@ -36,0 +36,2 @@\n+    private static final String CSR_NEEDED_MARKER = \"<!-- csr: 'needed' -->\";\n+    private static final String CSR_UNNEEDED_MARKER = \"<!-- csr: 'unneeded' -->\";\n@@ -45,0 +47,1 @@\n+        writer.println(CSR_NEEDED_MARKER);\n@@ -62,0 +65,1 @@\n+        writer.println(CSR_UNNEEDED_MARKER);\n@@ -134,0 +138,1 @@\n+                reply.println(CSR_NEEDED_MARKER);\n@@ -146,0 +151,1 @@\n+            reply.println(CSR_NEEDED_MARKER);\n@@ -195,0 +201,1 @@\n+            reply.println(CSR_NEEDED_MARKER);\n@@ -199,0 +206,1 @@\n+            reply.println(CSR_NEEDED_MARKER);\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CSRCommand.java","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -45,1 +45,1 @@\n-    private final Pattern metadataComments = Pattern.compile(\"<!-- (?:(add|remove) (?:contributor|reviewer))|(?:summary: ')|(?:solves: ')|(?:additional required reviewers)|(?:jep: ')\");\n+    private final Pattern metadataComments = Pattern.compile(\"<!-- (?:(add|remove) (?:contributor|reviewer))|(?:summary: ')|(?:solves: ')|(?:additional required reviewers)|(?:jep: ')|(?:csr: ')\");\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CheckWorkItem.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -679,0 +679,1 @@\n+            assertFalse(pr.body().contains(\"Change requires a CSR request to be approved\"));\n@@ -689,0 +690,1 @@\n+            assertTrue(pr.body().contains(\"Change requires a CSR request to be approved\"));\n@@ -825,1 +827,0 @@\n-            pr.addComment(\"\/summary\\n\" + commitMessage);\n@@ -843,1 +844,0 @@\n-            pr.addComment(\"\/summary\\n\" + commitMessage);\n@@ -855,1 +855,0 @@\n-            pr.addComment(\"\/summary\\n\" + commitMessage);\n@@ -870,1 +869,0 @@\n-            pr.addComment(\"\/summary\\n\" + commitMessage);\n@@ -879,1 +877,0 @@\n-            pr.addComment(\"\/summary\\n\" + commitMessage);\n@@ -902,1 +899,0 @@\n-            pr.addComment(\"\/summary\\n\" + commitMessage);\n@@ -913,1 +909,0 @@\n-            pr.addComment(\"\/summary\\n\" + commitMessage);\n@@ -922,1 +917,0 @@\n-            pr.addComment(\"\/summary\\n\" + commitMessage);\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/CSRTests.java","additions":2,"deletions":8,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -2066,0 +2066,1 @@\n+            var csrUpdateMarker = \"\\n<!-- csr: 'update' -->\\n\";\n@@ -2114,0 +2115,2 @@\n+            \/\/ Simulate the CSRBot.\n+            pr.setBody(pr.body() + csrUpdateMarker);\n@@ -2115,1 +2118,0 @@\n-            pr.addComment(\"\/summary\\n\" + commitMessage);\n@@ -2120,2 +2122,2 @@\n-            assumeTrue(pr.body().contains(issue.id()));\n-            assumeTrue(pr.body().contains(issue.title()));\n+            assertTrue(pr.body().contains(issue.id()));\n+            assertTrue(pr.body().contains(issue.title()));\n@@ -2133,0 +2135,2 @@\n+            \/\/ Simulate the CSRBot.\n+            pr.setBody(pr.body() + csrUpdateMarker);\n@@ -2134,1 +2138,0 @@\n-            pr.addComment(\"\/summary\\n\" + commitMessage);\n@@ -2139,2 +2142,2 @@\n-            assumeTrue(pr.body().contains(issue.id()));\n-            assumeTrue(pr.body().contains(issue.title()));\n+            assertTrue(pr.body().contains(issue.id()));\n+            assertTrue(pr.body().contains(issue.title()));\n@@ -2152,0 +2155,2 @@\n+            \/\/ Simulate the CSRBot.\n+            pr.setBody(pr.body() + csrUpdateMarker);\n@@ -2153,1 +2158,0 @@\n-            pr.addComment(\"\/summary\\n\" + commitMessage);\n@@ -2158,2 +2162,2 @@\n-            assumeTrue(pr.body().contains(issue.id()));\n-            assumeTrue(pr.body().contains(issue.title()));\n+            assertTrue(pr.body().contains(issue.id()));\n+            assertTrue(pr.body().contains(issue.title()));\n@@ -2165,0 +2169,2 @@\n+            \/\/ Simulate the CSRBot.\n+            pr.setBody(pr.body() + csrUpdateMarker);\n@@ -2166,1 +2172,0 @@\n-            pr.addComment(\"\/summary\\n\" + commitMessage);\n@@ -2169,5 +2174,5 @@\n-            assumeTrue(pr.body().contains(\"### Issues\"));\n-            assumeTrue(pr.body().contains(issue.id()));\n-            assumeTrue(pr.body().contains(issue.title()));\n-            assumeTrue(pr.body().contains(csr.id()));\n-            assumeTrue(pr.body().contains(csr.title() + \" (**CSR**)\"));\n+            assertTrue(pr.body().contains(\"### Issues\"));\n+            assertTrue(pr.body().contains(issue.id()));\n+            assertTrue(pr.body().contains(issue.title()));\n+            assertTrue(pr.body().contains(csr.id()));\n+            assertTrue(pr.body().contains(csr.title() + \" (**CSR**)\"));\n@@ -2183,0 +2188,2 @@\n+            \/\/ Simulate the CSRBot.\n+            pr.setBody(pr.body() + csrUpdateMarker);\n@@ -2184,1 +2191,0 @@\n-            pr.addComment(\"\/summary\\n\" + commitMessage);\n@@ -2189,2 +2195,2 @@\n-            assumeTrue(pr.body().contains(issue.id()));\n-            assumeTrue(pr.body().contains(issue.title()));\n+            assertTrue(pr.body().contains(issue.id()));\n+            assertTrue(pr.body().contains(issue.title()));\n@@ -2202,0 +2208,2 @@\n+            \/\/ Simulate the CSRBot.\n+            pr.setBody(pr.body() + csrUpdateMarker);\n@@ -2203,1 +2211,0 @@\n-            pr.addComment(\"\/summary\\n\" + commitMessage);\n@@ -2207,4 +2214,4 @@\n-            assumeTrue(pr.body().contains(issue.id()));\n-            assumeTrue(pr.body().contains(issue.title()));\n-            assumeTrue(pr.body().contains(backportCsr.id()));\n-            assumeTrue(pr.body().contains(backportCsr.title() + \" (**CSR**)\"));\n+            assertTrue(pr.body().contains(issue.id()));\n+            assertTrue(pr.body().contains(issue.title()));\n+            assertTrue(pr.body().contains(backportCsr.id()));\n+            assertTrue(pr.body().contains(backportCsr.title() + \" (**CSR**)\"));\n@@ -2227,0 +2234,2 @@\n+            \/\/ Simulate the CSRBot.\n+            pr.setBody(pr.body() + csrUpdateMarker);\n@@ -2228,1 +2237,0 @@\n-            pr.addComment(\"\/summary\\n\" + commitMessage);\n@@ -2232,4 +2240,4 @@\n-            assumeTrue(pr.body().contains(issue.id()));\n-            assumeTrue(pr.body().contains(issue.title()));\n-            assumeTrue(pr.body().contains(backportCsr.id()));\n-            assumeTrue(pr.body().contains(backportCsr.title() + \" (**CSR**)\"));\n+            assertTrue(pr.body().contains(issue.id()));\n+            assertTrue(pr.body().contains(issue.title()));\n+            assertTrue(pr.body().contains(backportCsr.id()));\n+            assertTrue(pr.body().contains(backportCsr.title() + \" (**CSR**)\"));\n@@ -2243,0 +2251,2 @@\n+            \/\/ Simulate the CSRBot.\n+            pr.setBody(pr.body() + csrUpdateMarker);\n@@ -2244,1 +2254,0 @@\n-            pr.addComment(\"\/summary\\n\" + commitMessage);\n@@ -2249,2 +2258,2 @@\n-            assumeTrue(pr.body().contains(issue.id()));\n-            assumeTrue(pr.body().contains(issue.title()));\n+            assertTrue(pr.body().contains(issue.id()));\n+            assertTrue(pr.body().contains(issue.title()));\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/CheckTests.java","additions":40,"deletions":31,"binary":false,"changes":71,"status":"modified"}]}