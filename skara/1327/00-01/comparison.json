{"files":[{"patch":"@@ -40,1 +40,2 @@\n-    private final static String CSR_UPDATE_MARKER = \"\\n<!-- csr: 'update' -->\\n\";\n+    private final static String CSR_UPDATE_MARKER = \"<!-- csr: 'update' -->\";\n+    private static final String PROGRESS_MARKER = \"<!-- Anything below this marker will be automatically updated, please do not edit manually! -->\";\n@@ -77,3 +78,4 @@\n-        return hasCsrIssue(pr, csr) &&\n-                (pr.body().contains(\"- [ ] Change requires a CSR request to be approved\") ||\n-                 pr.body().contains(\"- [x] Change requires a CSR request to be approved\"));\n+        var statusMessage = getStatusMessage(pr);\n+        return hasCsrIssue(statusMessage, csr) &&\n+               (statusMessage.contains(\"- [ ] Change requires a CSR request to be approved\") ||\n+                statusMessage.contains(\"- [x] Change requires a CSR request to be approved\"));\n@@ -83,1 +85,2 @@\n-        return hasCsrIssue(pr, csr) && pr.body().contains(\"- [x] Change requires a CSR request to be approved\");\n+        var statusMessage = getStatusMessage(pr);\n+        return hasCsrIssue(statusMessage, csr) && statusMessage.contains(\"- [x] Change requires a CSR request to be approved\");\n@@ -86,4 +89,22 @@\n-    private boolean hasCsrIssue(PullRequest pr, Issue csr) {\n-        return pr.body().contains(csr.id()) &&\n-                pr.body().contains(csr.webUrl().toString()) &&\n-                pr.body().contains(csr.title() + \" (**CSR**)\");\n+    private boolean hasCsrIssue(String statusMessage, Issue csr) {\n+        return statusMessage.contains(csr.id()) &&\n+               statusMessage.contains(csr.webUrl().toString()) &&\n+               statusMessage.contains(csr.title() + \" (**CSR**)\");\n+    }\n+\n+    private String getStatusMessage(PullRequest pr) {\n+        var lastIndex = pr.body().lastIndexOf(PROGRESS_MARKER);\n+        if (lastIndex == -1) {\n+            return \"\";\n+        } else {\n+            return pr.body().substring(lastIndex);\n+        }\n+    }\n+\n+    private void addUpdateMarker(PullRequest pr) {\n+        var statusMessage = getStatusMessage(pr);\n+        if (!statusMessage.contains(CSR_UPDATE_MARKER)) {\n+            pr.setBody(pr.body() + \"\\n\" + CSR_UPDATE_MARKER + \"\\n\");\n+        } else {\n+            log.info(\"The pull request \" + describe(pr) + \" has already had a csr update marker. Do not need to add it again.\");\n+        }\n@@ -121,1 +142,1 @@\n-            log.info(\"Found CSR for \" + describe(pr) + \". It has id \" + csr.id());\n+            log.info(\"Found CSR \" + csr.id() + \" for \" + describe(pr));\n@@ -126,1 +147,1 @@\n-                pr.setBody(pr.body() + CSR_UPDATE_MARKER);\n+                addUpdateMarker(pr);\n@@ -184,1 +205,1 @@\n-                pr.setBody(pr.body() + CSR_UPDATE_MARKER);\n+                addUpdateMarker(pr);\n","filename":"bots\/csr\/src\/main\/java\/org\/openjdk\/skara\/bots\/csr\/CSRBot.java","additions":33,"deletions":12,"binary":false,"changes":45,"status":"modified"},{"patch":"@@ -413,0 +413,1 @@\n+        String progressMarker = \"<!-- Anything below this marker will be automatically updated, please do not edit manually! -->\";\n@@ -446,1 +447,1 @@\n-            pr.setBody(\"PR body\\n\" + csr.id() + csr.webUrl().toString() + csr.title() + \" (**CSR**)\"\n+            pr.setBody(\"PR body\\n\" + progressMarker + csr.id() + csr.webUrl().toString() + csr.title() + \" (**CSR**)\"\n@@ -462,1 +463,1 @@\n-            pr.setBody(\"PR body\\n\" + csr.id() + csr.webUrl().toString() + csr.title() + \" (**CSR**)\"\n+            pr.setBody(\"PR body\\n\" + progressMarker + csr.id() + csr.webUrl().toString() + csr.title() + \" (**CSR**)\"\n@@ -468,0 +469,9 @@\n+\n+            \/\/ Add csr update marker to the pull request body manually.\n+            pr.setBody(\"PR body\\n\" + progressMarker + csr.id() + csr.webUrl().toString() + csr.title() + \" (**CSR**)\"\n+                    + \"- [ ] Change requires a CSR request to be approved\" + csrUpdateMarker);\n+            \/\/ Run bot\n+            TestBotRunner.runPeriodicItems(bot);\n+            \/\/ The bot shouldn't add the csr update marker again. The PR should have only one csr update marker.\n+            assertTrue(pr.body().contains(csrUpdateMarker));\n+            assertEquals(pr.body().indexOf(csrUpdateMarker), pr.body().lastIndexOf(csrUpdateMarker));\n","filename":"bots\/csr\/src\/test\/java\/org\/openjdk\/skara\/bots\/csr\/CSRBotTests.java","additions":12,"deletions":2,"binary":false,"changes":14,"status":"modified"}]}