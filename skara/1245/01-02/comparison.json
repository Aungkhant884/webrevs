{"files":[{"patch":"@@ -79,30 +79,15 @@\n-            \/\/ Remove the csr label if the issue has no csr or the csr has been withdrawn.\n-            \/\/ If the issue has a non-withdrawn csr, the bot should direct the user to withdraw the csr firstly.\n-            if (labels.contains(CSR_LABEL)) {\n-                var issueProject = bot.issueProject();\n-                var issue = org.openjdk.skara.vcs.openjdk.Issue.fromStringRelaxed(pr.title());\n-                if (issueProject != null && issue.isPresent()) {\n-                    var jbsIssue = issueProject.issue(issue.get().shortId());\n-                    if (jbsIssue.isPresent()) {\n-                        for (var link : jbsIssue.get().links()) {\n-                            var relationship = link.relationship();\n-                            if (relationship.isPresent() && relationship.get().equals(\"csr for\")) {\n-                                var csrIssue = link.issue().orElse(null);\n-                                if (csrIssue != null) {\n-                                    var resolution = csrIssue.properties().get(\"resolution\");\n-                                    if (resolution == null || resolution.isNull()\n-                                            || resolution.get(\"name\") == null || resolution.get(\"name\").isNull()\n-                                            || csrIssue.state() != Issue.State.CLOSED\n-                                            || !resolution.get(\"name\").asString().equals(\"Withdrawn\")) {\n-                                        reply.println(\"the issue for this pull request, [\" + jbsIssue.get().id() + \"](\" + jbsIssue.get().webUrl() + \"), has \" +\n-                                                \"a non-withdrawn CSR request: [\" + csrIssue.id() + \"](\" + csrIssue.webUrl() + \"). \");\n-                                        reply.println(\"So you can't directly indicate that a CSR request is not needed for this pull request. \");\n-                                        reply.println(\"Please firstly withdraw the CSR request: [\" + csrIssue.id() + \"](\" + csrIssue.webUrl() + \"), \"\n-                                                + \"and then use the command `\/csr unneeded` again\");\n-                                        return;\n-                                    }\n-                                }\n-                            }\n-                        }\n-                    }\n-                }\n+            if (!labels.contains(CSR_LABEL)) {\n+                reply.println(\"determined that a [CSR](https:\/\/wiki.openjdk.java.net\/display\/csr\/Main) request \" +\n+                        \"is not needed for this pull request.\");\n+                return;\n+            }\n+            var issueProject = bot.issueProject();\n+            var issue = org.openjdk.skara.vcs.openjdk.Issue.fromStringRelaxed(pr.title());\n+            if (issueProject == null || issue.isEmpty()) {\n+                pr.removeLabel(CSR_LABEL);\n+                reply.println(\"determined that a [CSR](https:\/\/wiki.openjdk.java.net\/display\/csr\/Main) request \" +\n+                        \"is not needed for this pull request.\");\n+                return;\n+            }\n+            var jbsIssue = issueProject.issue(issue.get().shortId());\n+            if (jbsIssue.isEmpty()) {\n@@ -110,0 +95,33 @@\n+                reply.println(\"determined that a [CSR](https:\/\/wiki.openjdk.java.net\/display\/csr\/Main) request \" +\n+                        \"is not needed for this pull request.\");\n+                return;\n+            }\n+            for (var link : jbsIssue.get().links()) {\n+                var relationship = link.relationship();\n+                if (relationship.isEmpty() || !relationship.get().equals(\"csr for\")) {\n+                    continue;\n+                }\n+                \/\/ Now the issue has a csr link.\n+                var csrIssue = link.issue().orElse(null);\n+                if (csrIssue == null) {\n+                    \/\/ The csr link exists but the csr issue doesn't exist.\n+                    \/\/ We should remind the user to remove the link firstly.\n+                    reply.println(\"the issue for this pull request, [\" + jbsIssue.get().id() + \"](\" + jbsIssue.get().webUrl()\n+                            + \"), has a invalid CSR link.\");\n+                    reply.println(\"So you can't directly indicate that a CSR request is not needed for this pull request. \");\n+                    reply.println(\"Please firstly remove the CSR link and then use the command `\/csr unneeded` again.\");\n+                    return;\n+                }\n+                var resolution = csrIssue.properties().get(\"resolution\");\n+                if (resolution == null || resolution.isNull()\n+                        || resolution.get(\"name\") == null || resolution.get(\"name\").isNull()\n+                        || csrIssue.state() != Issue.State.CLOSED\n+                        || !resolution.get(\"name\").asString().equals(\"Withdrawn\")) {\n+                    \/\/ The issue has a non-withdrawn csr issue, the bot should direct the user to withdraw the csr firstly.\n+                    reply.println(\"the issue for this pull request, [\" + jbsIssue.get().id() + \"](\" + jbsIssue.get().webUrl() + \"), has \" +\n+                            \"a non-withdrawn CSR request: [\" + csrIssue.id() + \"](\" + csrIssue.webUrl() + \"). \");\n+                    reply.println(\"So you can't directly indicate that a CSR request is not needed for this pull request. \");\n+                    reply.println(\"Please firstly withdraw the CSR request: [\" + csrIssue.id() + \"](\" + csrIssue.webUrl() + \"), \"\n+                            + \"and then use the command `\/csr unneeded` again.\");\n+                    return;\n+                }\n@@ -111,0 +129,2 @@\n+            \/\/ The issue has no csr or the csr has been withdrawn, the bot should just remove the csr label.\n+            pr.removeLabel(CSR_LABEL);\n@@ -112,1 +132,1 @@\n-                          \"is not needed for this pull request.\");\n+                    \"is not needed for this pull request.\");\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CSRCommand.java","additions":51,"deletions":31,"binary":false,"changes":82,"status":"modified"}]}