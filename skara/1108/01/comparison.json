{"files":[{"patch":"@@ -300,1 +300,0 @@\n-        ArchiveItem lastCommentOrReview = generated.get(0);\n@@ -302,1 +301,0 @@\n-        eligible.add(lastCommentOrReview);\n@@ -305,3 +303,2 @@\n-                if (item.createdAt().isBefore(comment.createdAt()) && item.createdAt().isAfter(lastCommentOrReview.createdAt())) {\n-                    lastCommentOrReview = item;\n-                    eligible.add(lastCommentOrReview);\n+                if (item.createdAt().isBefore(comment.createdAt())) {\n+                    eligible.add(item);\n@@ -321,1 +318,9 @@\n-        return lastCommentOrReview;\n+        ArchiveItem lastRevisionItem = generated.get(0);\n+        for (var item : generated) {\n+            if (item.id().startsWith(\"ha\")) {\n+                if (item.createdAt().isBefore(comment.createdAt())) {\n+                    lastRevisionItem = item;\n+                }\n+            }\n+        }\n+        return lastRevisionItem;\n","filename":"bots\/mlbridge\/src\/main\/java\/org\/openjdk\/skara\/bots\/mlbridge\/ArchiveItem.java","additions":11,"deletions":6,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -26,1 +26,1 @@\n-import org.openjdk.skara.forge.PullRequest;\n+import org.openjdk.skara.forge.*;\n@@ -29,1 +29,2 @@\n-import org.openjdk.skara.test.HostCredentials;\n+import org.openjdk.skara.test.*;\n+import org.openjdk.skara.vcs.Repository;\n@@ -32,0 +33,1 @@\n+import java.net.URI;\n@@ -44,0 +46,5 @@\n+    private ArchiveItem fromPullRequest(PullRequest pr, Repository repo) throws IOException {\n+        var base = repo.resolve(\"master\").orElseThrow();\n+        return ArchiveItem.from(pr, repo, null, URI.create(\"http:\/\/www.example.com\"), \"\", null, null, ZonedDateTime.now(), ZonedDateTime.now(), base, base, \"\", \"\");\n+    }\n+\n@@ -50,1 +57,2 @@\n-        try (var credentials = new HostCredentials(testInfo)) {\n+        try (var credentials = new HostCredentials(testInfo);\n+             var tempFolder = new TemporaryDirectory()) {\n@@ -52,0 +60,1 @@\n+            var localRepo = CheckableRepository.init(tempFolder.path(), repo.repositoryType());\n@@ -61,0 +70,1 @@\n+            var a0 = fromPullRequest(pr, localRepo);\n@@ -64,1 +74,1 @@\n-            assertEquals(a2, ArchiveItem.findParent(List.of(a1, a2), createComment(user3, \"Plain reply\")));\n+            assertEquals(a0, ArchiveItem.findParent(List.of(a0, a1, a2), createComment(user3, \"Plain unrelated reply\")));\n@@ -66,3 +76,3 @@\n-            assertEquals(a1, ArchiveItem.findParent(List.of(a1, a2), createComment(user3, \"> First comment\\n\\nI agree\")));\n-            assertEquals(a1, ArchiveItem.findParent(List.of(a1, a2), createComment(user3, \"> First comment\\n>with two lines\\n\\nI agree\")));\n-            assertEquals(a1, ArchiveItem.findParent(List.of(a1, a2), createComment(user3, \"\\n> First comment\\n\\nI agree\")));\n+            assertEquals(a1, ArchiveItem.findParent(List.of(a0, a1, a2), createComment(user3, \"> First comment\\n\\nI agree\")));\n+            assertEquals(a1, ArchiveItem.findParent(List.of(a0, a1, a2), createComment(user3, \"> First comment\\n>with two lines\\n\\nI agree\")));\n+            assertEquals(a1, ArchiveItem.findParent(List.of(a0, a1, a2), createComment(user3, \"\\n> First comment\\n\\nI agree\")));\n@@ -70,2 +80,2 @@\n-            assertEquals(a1, ArchiveItem.findParent(List.of(a1, a2), createComment(user3, \"@user1 I agree\")));\n-            assertEquals(a1, ArchiveItem.findParent(List.of(a1, a2), createComment(user3, \"@user1\\nI agree\")));\n+            assertEquals(a1, ArchiveItem.findParent(List.of(a0, a1, a2), createComment(user3, \"@user1 I agree\")));\n+            assertEquals(a1, ArchiveItem.findParent(List.of(a0, a1, a2), createComment(user3, \"@user1\\nI agree\")));\n","filename":"bots\/mlbridge\/src\/test\/java\/org\/openjdk\/skara\/bots\/mlbridge\/ArchiveItemTests.java","additions":19,"deletions":9,"binary":false,"changes":28,"status":"modified"},{"patch":"@@ -25,0 +25,1 @@\n+import org.junit.jupiter.api.*;\n@@ -28,0 +29,2 @@\n+import org.openjdk.skara.json.JSON;\n+import org.openjdk.skara.mailinglist.*;\n@@ -29,1 +32,0 @@\n-import org.openjdk.skara.mailinglist.MailingListServerFactory;\n@@ -32,3 +34,0 @@\n-import org.openjdk.skara.json.JSON;\n-\n-import org.junit.jupiter.api.*;\n@@ -262,1 +261,1 @@\n-            pr.addComment(\"This is another comment\");\n+            pr.addComment(\"@\" + pr.author().username() +\" This is another comment\");\n@@ -1181,1 +1180,1 @@\n-            assertEquals(3, archiveContainsCount(archiveFolder.path(), \"First comment\"));\n+            assertEquals(2, archiveContainsCount(archiveFolder.path(), \"First comment\"));\n@@ -1299,1 +1298,2 @@\n-            pr.addComment(\"Second comment\\nfourth line\");\n+            var authorPr = author.pullRequest(pr.id());\n+            authorPr.addComment(\"Second comment\\nfourth line\");\n@@ -1308,1 +1308,1 @@\n-            \/\/ The first comment should be quoted more often than the second\n+            \/\/ The first comment should be replied to once, and the original post once\n@@ -1310,3 +1310,2 @@\n-            assertEquals(2, archiveContainsCount(archiveFolder.path(), \"First comment\"));\n-            assertEquals(3, archiveContainsCount(archiveFolder.path(), \"First comm\"));\n-            assertEquals(1, archiveContainsCount(archiveFolder.path(), \"Second comment\"));\n+            assertEquals(1, archiveContainsCount(archiveFolder.path(), Pattern.quote(reviewPr.author().fullName()) + \".* wrote\"));\n+            assertEquals(1, archiveContainsCount(archiveFolder.path(), Pattern.quote(pr.author().fullName()) + \".* wrote\"));\n@@ -2355,1 +2354,1 @@\n-            pr.addComment(\"Thanks for the review!\");\n+            pr.addComment(\"@\" + reviewer.forge().currentUser().username() + \" Thanks for the review!\");\n@@ -3110,1 +3109,1 @@\n-            pr.addComment(\"This is another comment\");\n+            pr.addComment(\"@\" + pr.author().username() + \" This is another comment\");\n","filename":"bots\/mlbridge\/src\/test\/java\/org\/openjdk\/skara\/bots\/mlbridge\/MailingListBridgeBotTests.java","additions":12,"deletions":13,"binary":false,"changes":25,"status":"modified"}]}