{"files":[{"patch":"@@ -60,2 +60,0 @@\n-    private final ConcurrentHashMap<String, Instant> scheduledRechecks;\n-    private final PullRequestUpdateCache updateCache;\n@@ -68,0 +66,1 @@\n+    private final PullRequestPoller poller;\n@@ -106,2 +105,1 @@\n-        scheduledRechecks = new ConcurrentHashMap<>();\n-        updateCache = new PullRequestUpdateCache();\n+        poller = new PullRequestPoller(repo, true, true, true);\n@@ -147,10 +145,0 @@\n-    private boolean checkHasExpired(PullRequest pr) {\n-        var expiresAt = scheduledRechecks.get(pr.webUrl().toString());\n-        if (expiresAt != null && Instant.now().isAfter(expiresAt)) {\n-            log.info(\"Check metadata has expired (expired at: \" + expiresAt + \") for PR #\" + pr.id());\n-            scheduledRechecks.remove(pr.webUrl().toString());\n-            return true;\n-        }\n-        return false;\n-    }\n-\n@@ -159,1 +147,1 @@\n-        scheduledRechecks.put(pr.webUrl().toString(), expiresAt);\n+        poller.retryPullRequest(pr, expiresAt);\n@@ -167,10 +155,8 @@\n-            if (updateCache.needsUpdate(pr) || checkHasExpired(pr)) {\n-                if (!isReady(pr)) {\n-                    continue;\n-                }\n-                if (pr.state() == Issue.State.OPEN) {\n-                    ret.add(new CheckWorkItem(this, pr.id(), e -> updateCache.invalidate(pr), pr.updatedAt()));\n-                } else {\n-                    \/\/ Closed PR's do not need to be checked\n-                    ret.add(new PullRequestCommandWorkItem(this, pr.id(), e -> updateCache.invalidate(pr), pr.updatedAt()));\n-                }\n+            if (!isReady(pr)) {\n+                continue;\n+            }\n+            if (pr.state() == Issue.State.OPEN) {\n+                ret.add(new CheckWorkItem(this, pr.id(), e -> poller.retryPullRequest(pr), pr.updatedAt()));\n+            } else {\n+                \/\/ Closed PR's do not need to be checked\n+                ret.add(new PullRequestCommandWorkItem(this, pr.id(), e -> poller.retryPullRequest(pr), pr.updatedAt()));\n@@ -185,11 +171,4 @@\n-        List<PullRequest> prs;\n-        if (lastFullUpdate == null || lastFullUpdate.isBefore(Instant.now().minus(Duration.ofMinutes(10)))) {\n-            lastFullUpdate = Instant.now();\n-            log.info(\"Fetching all open pull requests for \" + remoteRepo.name());\n-            prs = remoteRepo.pullRequests();\n-        } else {\n-            log.info(\"Fetching recently updated pull requests (open and closed) for \" + remoteRepo.name());\n-            prs = remoteRepo.pullRequests(ZonedDateTime.now().minus(Duration.ofDays(1)));\n-        }\n-\n-        return getWorkItems(prs);\n+        List<PullRequest> prs = poller.updatedPullRequests();\n+        List<WorkItem> workItems = getWorkItems(prs);\n+        poller.lastBatchHandled();\n+        return workItems;\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/PullRequestBot.java","additions":15,"deletions":36,"binary":false,"changes":51,"status":"modified"}]}