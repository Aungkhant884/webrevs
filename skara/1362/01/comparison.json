{"files":[{"patch":"@@ -62,1 +62,2 @@\n-    public void handle(PullRequestBot bot, HostedCommit commit, CensusInstance censusInstance, Path scratchPath, CommandInvocation command, List<Comment> allComments, PrintWriter reply) {\n+    public void handle(PullRequestBot bot, HostedCommit commit, LimitedCensusInstance censusInstance,\n+            Path scratchPath, CommandInvocation command, List<Comment> allComments, PrintWriter reply) {\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/BackportCommand.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -36,3 +36,1 @@\n-class CensusInstance {\n-    private final Census census;\n-    private final JCheckConfiguration configuration;\n+class CensusInstance extends LimitedCensusInstance {\n@@ -40,1 +38,0 @@\n-    private final Namespace namespace;\n@@ -43,2 +40,1 @@\n-        this.census = census;\n-        this.configuration = configuration;\n+        super(census, configuration, namespace);\n@@ -46,1 +42,0 @@\n-        this.namespace = namespace;\n@@ -83,7 +78,14 @@\n-        var repoName = censusRepo.url().getHost() + \"\/\" + censusRepo.name();\n-        var repoFolder = folder.resolve(URLEncoder.encode(repoName, StandardCharsets.UTF_8));\n-        try {\n-            hostedRepositoryPool.checkoutAllowStale(censusRepo, censusRef, repoFolder);\n-        } catch (IOException e) {\n-            throw new UncheckedIOException(\"Cannot materialize census to \" + repoFolder, e);\n-        }\n+        var limitedCensusInstance = createLimited(hostedRepositoryPool, censusRepo,\n+                censusRef, folder, repository, ref, confOverrideRepo, confOverrideName, confOverrideRef);\n+        return limitedCensusInstance.map(l ->\n+                new CensusInstance(l.census, l.configuration, project(l.configuration, l.census), l.namespace));\n+    }\n+\n+    \/**\n+     * The LimitedCensusInstance does not have a Project. Use this when the project\n+     * may be invalid or unavailable to avoid errors.\n+     *\/\n+    static Optional<LimitedCensusInstance> createLimited(HostedRepositoryPool hostedRepositoryPool,\n+            HostedRepository censusRepo, String censusRef, Path folder, HostedRepository repository, String ref,\n+            HostedRepository confOverrideRepo, String confOverrideName, String confOverrideRef) {\n+        Path repoFolder = getRepoFolder(hostedRepositoryPool, censusRepo, censusRef, folder);\n@@ -92,9 +94,2 @@\n-            Optional<JCheckConfiguration> configuration;\n-            if (confOverrideRepo == null) {\n-                configuration = configuration(hostedRepositoryPool, repository, \".jcheck\/conf\", ref);\n-            } else {\n-                configuration = configuration(hostedRepositoryPool,\n-                                              confOverrideRepo,\n-                                              confOverrideName,\n-                                              confOverrideRef);\n-            }\n+            Optional<JCheckConfiguration> configuration = jCheckConfiguration(hostedRepositoryPool,\n+                    repository, ref, confOverrideRepo, confOverrideName, confOverrideRef);\n@@ -105,1 +100,0 @@\n-            var project = project(configuration.get(), census);\n@@ -107,1 +101,1 @@\n-            return Optional.of(new CensusInstance(census, configuration.get(), project, namespace));\n+            return Optional.of(new LimitedCensusInstance(census, configuration.get(), namespace));\n@@ -113,2 +107,13 @@\n-    Census census() {\n-        return census;\n+    private static Optional<JCheckConfiguration> jCheckConfiguration(HostedRepositoryPool hostedRepositoryPool,\n+            HostedRepository repository, String ref, HostedRepository confOverrideRepo, String confOverrideName,\n+            String confOverrideRef) throws IOException {\n+        Optional<JCheckConfiguration> configuration;\n+        if (confOverrideRepo == null) {\n+            configuration = configuration(hostedRepositoryPool, repository, \".jcheck\/conf\", ref);\n+        } else {\n+            configuration = configuration(hostedRepositoryPool,\n+                    confOverrideRepo,\n+                    confOverrideName,\n+                    confOverrideRef);\n+        }\n+        return configuration;\n@@ -117,2 +122,9 @@\n-    JCheckConfiguration configuration() {\n-        return configuration;\n+    private static Path getRepoFolder(HostedRepositoryPool hostedRepositoryPool, HostedRepository censusRepo, String censusRef, Path folder) {\n+        var repoName = censusRepo.url().getHost() + \"\/\" + censusRepo.name();\n+        var repoFolder = folder.resolve(URLEncoder.encode(repoName, StandardCharsets.UTF_8));\n+        try {\n+            hostedRepositoryPool.checkoutAllowStale(censusRepo, censusRef, repoFolder);\n+        } catch (IOException e) {\n+            throw new UncheckedIOException(\"Cannot materialize census to \" + repoFolder, e);\n+        }\n+        return repoFolder;\n@@ -125,9 +137,0 @@\n-    Namespace namespace() {\n-        return namespace;\n-    }\n-\n-    Optional<Contributor> contributor(HostUser hostUser) {\n-        var contributor = namespace.get(hostUser.id());\n-        return Optional.ofNullable(contributor);\n-    }\n-\n@@ -161,0 +164,30 @@\n+\n+class LimitedCensusInstance {\n+\n+    protected final Census census;\n+    protected final JCheckConfiguration configuration;\n+    protected final Namespace namespace;\n+\n+    LimitedCensusInstance(Census census, JCheckConfiguration configuration, Namespace namespace) {\n+        this.census = census;\n+        this.configuration = configuration;\n+        this.namespace = namespace;\n+    }\n+\n+    Optional<Contributor> contributor(HostUser hostUser) {\n+        var contributor = namespace.get(hostUser.id());\n+        return Optional.ofNullable(contributor);\n+    }\n+\n+    Census census() {\n+        return census;\n+    }\n+\n+    JCheckConfiguration configuration() {\n+        return configuration;\n+    }\n+\n+    Namespace namespace() {\n+        return namespace;\n+    }\n+}\n\\ No newline at end of file\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CensusInstance.java","additions":71,"deletions":38,"binary":false,"changes":109,"status":"modified"},{"patch":"@@ -81,1 +81,1 @@\n-        public void handle(PullRequestBot bot, HostedCommit hash, CensusInstance censusInstance, Path scratchPath, CommandInvocation command, List<Comment> allComments, PrintWriter reply) {\n+        public void handle(PullRequestBot bot, HostedCommit hash, LimitedCensusInstance censusInstance, Path scratchPath, CommandInvocation command, List<Comment> allComments, PrintWriter reply) {\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CommandExtractor.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -45,1 +45,2 @@\n-    default void handle(PullRequestBot bot, HostedCommit commit, CensusInstance censusInstance, Path scratchPath, CommandInvocation command, List<Comment> allComments, PrintWriter reply) {\n+    default void handle(PullRequestBot bot, HostedCommit commit, LimitedCensusInstance censusInstance, Path scratchPath,\n+            CommandInvocation command, List<Comment> allComments, PrintWriter reply) {\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CommandHandler.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -89,1 +89,2 @@\n-    private void processCommand(Path scratchPath, HostedCommit commit, CensusInstance censusInstance, CommandInvocation command, List<CommitComment> allComments) {\n+    private void processCommand(Path scratchPath, HostedCommit commit, LimitedCensusInstance censusInstance,\n+            CommandInvocation command, List<CommitComment> allComments) {\n@@ -132,1 +133,1 @@\n-            var census = CensusInstance.create(hostedRepositoryPool, bot.censusRepo(), bot.censusRef(),\n+            var census = CensusInstance.createLimited(hostedRepositoryPool, bot.censusRepo(), bot.censusRef(),\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CommitCommandWorkItem.java","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -62,1 +62,2 @@\n-    public void handle(PullRequestBot bot, HostedCommit commit, CensusInstance censusInstance, Path scratchPath, CommandInvocation command, List<Comment> allComments, PrintWriter reply) {\n+    public void handle(PullRequestBot bot, HostedCommit commit, LimitedCensusInstance censusInstance,\n+            Path scratchPath, CommandInvocation command, List<Comment> allComments, PrintWriter reply) {\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/TagCommand.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"}]}