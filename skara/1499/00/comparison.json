{"files":[{"patch":"@@ -254,0 +254,11 @@\n+\n+        \/\/ If merge pr is not allowed, reply warning to the user and return\n+        var mergeDisabledText = \"<!-- merge error -->\\n\" +\n+                \":warning: @\" + pr.author().username() + \" merge PR is not allowed in this repository, please close this pr.\" +\n+                \" If it was unintentional, please modify the title of this PR.\";\n+        if (!bot.enableMerge() && PullRequestUtils.isMerge(pr)) {\n+            addErrorComment(mergeDisabledText, comments);\n+            return List.of();\n+        }\n+        removeErrorComment(mergeDisabledText, comments);\n+\n@@ -473,0 +484,9 @@\n+    private void removeErrorComment(String text, List<Comment> comments) {\n+        var botUser = pr.repository().forge().currentUser();\n+        var existing = comments.stream()\n+                .filter(c -> c.author().equals(botUser))\n+                .filter(c -> c.body().equals(text))\n+                .findFirst();\n+        existing.ifPresent(comment -> pr.removeComment(comment));\n+    }\n+\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CheckWorkItem.java","additions":20,"deletions":0,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -71,0 +71,1 @@\n+    private final boolean enableMerge;\n@@ -83,1 +84,2 @@\n-                   boolean reviewCleanBackport, String mlbridgeBotName, boolean reviewMerge, boolean processPR, boolean processCommit) {\n+                   boolean reviewCleanBackport, String mlbridgeBotName, boolean reviewMerge, boolean processPR, boolean processCommit,\n+                   boolean enableMerge) {\n@@ -113,0 +115,1 @@\n+        this.enableMerge = enableMerge;\n@@ -298,0 +301,4 @@\n+    public boolean enableMerge() {\n+        return enableMerge;\n+    }\n+\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/PullRequestBot.java","additions":8,"deletions":1,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -63,0 +63,1 @@\n+    private boolean enableMerge = true;\n@@ -212,0 +213,5 @@\n+    public PullRequestBotBuilder enableMerge(boolean enableMerge) {\n+        this.enableMerge = enableMerge;\n+        return this;\n+    }\n+\n@@ -220,1 +226,1 @@\n-                                  processPR, processCommit);\n+                                  processPR, processCommit, enableMerge);\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/PullRequestBotBuilder.java","additions":7,"deletions":1,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -188,0 +188,3 @@\n+            if (repo.value().contains(\"merge\")) {\n+                botBuilder.enableMerge(repo.value().get(\"merge\").asBoolean());\n+            }\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/PullRequestBotFactory.java","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -2843,0 +2843,48 @@\n+\n+    @Test\n+    void mergeDisabled(TestInfo testInfo) throws IOException {\n+        try (var credentials = new HostCredentials(testInfo);\n+             var tempFolder = new TemporaryDirectory()) {\n+            var author = credentials.getHostedRepository();\n+            var reviewer = credentials.getHostedRepository();\n+\n+            var censusBuilder = credentials.getCensusBuilder()\n+                    .addAuthor(author.forge().currentUser().id())\n+                    .addReviewer(reviewer.forge().currentUser().id());\n+            var seedFolder = tempFolder.path().resolve(\"seed\");\n+            var prBot = PullRequestBot.newBuilder()\n+                    .repo(author)\n+                    .censusRepo(censusBuilder.build())\n+                    .censusLink(\"https:\/\/census.com\/{{contributor}}-profile\")\n+                    .seedStorage(seedFolder)\n+                    .enableMerge(false)\n+                    .build();\n+\n+            \/\/ Populate the projects repository\n+            var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());\n+            var masterHash = localRepo.resolve(\"master\").orElseThrow();\n+            localRepo.push(masterHash, author.authenticatedUrl(), \"master\", true);\n+\n+            \/\/ Make a change with a corresponding PR\n+            var editHash = CheckableRepository.appendAndCommit(localRepo);\n+            localRepo.push(editHash, author.authenticatedUrl(), \"refs\/heads\/edit\", true);\n+            var pr = credentials.createPullRequest(author, \"master\", \"edit\", \"Merge dev\");\n+\n+            \/\/ Check the status\n+            TestBotRunner.runPeriodicItems(prBot);\n+\n+            var comment = pr.store().comments().get(pr.store().comments().size() - 1);\n+            assertEquals(1, pr.store().comments().size());\n+            assertTrue(comment.body().contains(\"merge PR is not allowed in this repository\"));\n+\n+            pr.setTitle(\"Merge test:dev\");\n+            TestBotRunner.runPeriodicItems(prBot);\n+            comment = pr.store().comments().get(pr.store().comments().size() - 1);\n+            assertEquals(1, pr.store().comments().size());\n+            assertTrue(comment.body().contains(\"merge PR is not allowed in this repository\"));\n+\n+            pr.setTitle(\"SKARA-123\");\n+            TestBotRunner.runPeriodicItems(prBot);\n+            assertEquals(0, pr.store().comments().size());\n+        }\n+    }\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/CheckTests.java","additions":48,"deletions":0,"binary":false,"changes":48,"status":"modified"},{"patch":"@@ -71,0 +71,1 @@\n+                          \"merge\": false,\n@@ -88,0 +89,1 @@\n+                          \"merge\": true,\n@@ -168,0 +170,9 @@\n+            assertTrue(pullRequestBot1.enableMerge());\n+\n+            var pullRequestBot2 = (PullRequestBot) bots.get(1);\n+            assertEquals(\"PullRequestBot@repo5\", pullRequestBot2.toString());\n+            assertTrue(pullRequestBot2.enableMerge());\n+\n+            var pullRequestBot3 = (PullRequestBot) bots.get(2);\n+            assertEquals(\"PullRequestBot@repo2\", pullRequestBot3.toString());\n+            assertFalse(pullRequestBot3.enableMerge());\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/PullRequestBotFactoryTest.java","additions":11,"deletions":0,"binary":false,"changes":11,"status":"modified"}]}