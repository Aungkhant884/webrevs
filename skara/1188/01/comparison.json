{"files":[{"patch":"@@ -26,1 +26,0 @@\n-import org.openjdk.skara.forge.PullRequest;\n@@ -117,1 +116,1 @@\n-            Hash backportHash = null;\n+            Hash backportHash;\n@@ -126,1 +125,1 @@\n-                                   .materialize(fork, localRepoDir);\n+                                   .materialize(targetRepo, localRepoDir);\n@@ -193,3 +192,1 @@\n-                                       .map(c -> {\n-                                           return c.fullName().isPresent() ? c.fullName().get() : c.username();\n-                                       })\n+                                       .map(c -> c.fullName().isPresent() ? c.fullName().get() : c.username())\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/BackportCommand.java","additions":3,"deletions":6,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -26,1 +26,0 @@\n-import org.openjdk.skara.issuetracker.Issue;\n@@ -30,0 +29,1 @@\n+import java.nio.file.Files;\n@@ -37,0 +37,1 @@\n+             var forkCredentials = new HostCredentials(testInfo);\n@@ -40,0 +41,1 @@\n+            var fork = forkCredentials.getHostedRepository();\n@@ -50,1 +52,1 @@\n-                                    .forks(Map.of(author.name(), author))\n+                                    .forks(Map.of(author.name(), fork))\n@@ -58,0 +60,3 @@\n+            \/\/ Initiate the fork repo\n+            localRepo.push(masterHash, fork.url(), \"master\", true);\n+\n@@ -203,0 +208,1 @@\n+             var forkCredentials = new HostCredentials(testInfo);\n@@ -206,0 +212,1 @@\n+            var fork = forkCredentials.getHostedRepository();\n@@ -216,1 +223,1 @@\n-                                    .forks(Map.of(author.name(), author))\n+                                    .forks(Map.of(author.name(), fork))\n@@ -221,2 +228,4 @@\n-            var masterHash = CheckableRepository.appendAndCommit(localRepo);\n-            localRepo.push(masterHash, author.url(), \"master\", true);\n+            var initialHash = localRepo.head();\n+\n+            \/\/ Initiate the fork repository\n+            localRepo.push(initialHash, fork.url(), \"master\", true);\n@@ -224,1 +233,1 @@\n-            \/\/ Make a change push it to edit branch\n+            \/\/ Make a change and push it to edit branch\n@@ -228,1 +237,3 @@\n-            var masterHash2 = CheckableRepository.appendAndCommit(localRepo);\n+            \/\/ Add another conflicting change in the master branch\n+            localRepo.checkout(initialHash);\n+            var masterHash2 = CheckableRepository.appendAndCommit(localRepo, \"a different line\");\n@@ -296,0 +307,69 @@\n+\n+    \/**\n+     * Tests backport with unrelated change in target and a common dependency\n+     * change in both target and source\n+     *\/\n+    @Test\n+    void complex(TestInfo testInfo) throws IOException {\n+        try (var credentials = new HostCredentials(testInfo);\n+             var forkCredentials = new HostCredentials(testInfo);\n+             var tempFolder = new TemporaryDirectory()) {\n+            var author = credentials.getHostedRepository();\n+            var reviewer = credentials.getHostedRepository();\n+            var fork = forkCredentials.getHostedRepository();\n+\n+            var censusBuilder = credentials.getCensusBuilder()\n+                    .addAuthor(author.forge().currentUser().id())\n+                    .addReviewer(reviewer.forge().currentUser().id());\n+            var seedFolder = tempFolder.path().resolve(\"seed\");\n+            var bot = PullRequestBot.newBuilder()\n+                    .repo(author)\n+                    .censusRepo(censusBuilder.build())\n+                    .censusLink(\"https:\/\/census.com\/{{contributor}}-profile\")\n+                    .seedStorage(seedFolder)\n+                    .forks(Map.of(author.name(), fork))\n+                    .build();\n+\n+            \/\/ Populate the projects repository\n+            var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());\n+            var masterHash = CheckableRepository.appendAndCommit(localRepo);\n+            localRepo.push(masterHash, author.url(), \"master\", true);\n+\n+            \/\/ Initiate the fork repo\n+            localRepo.push(masterHash, fork.url(), \"master\", true);\n+\n+            \/\/ Make an unrelated change in master\n+            var unrelated = localRepo.root().resolve(\"unrelated.txt\");\n+            Files.writeString(unrelated, \"Hello\");\n+            localRepo.add(unrelated);\n+            var unrelatedHash = localRepo.commit(\"Unrelated\", \"X\", \"x@y.z\");\n+            localRepo.push(unrelatedHash, author.url(), \"master\");\n+\n+            \/\/ Make a change in edit branch, without the unrelated change\n+            localRepo.checkout(masterHash);\n+            var editHashCommon = CheckableRepository.appendAndCommit(localRepo);\n+            localRepo.push(editHashCommon, author.url(), \"edit\");\n+\n+            \/\/ Make the same change in master\n+            localRepo.checkout(unrelatedHash);\n+            var masterHashCommon = CheckableRepository.appendAndCommit(localRepo);\n+            localRepo.push(masterHashCommon, author.url(), \"master\");\n+\n+            \/\/ Make another change in edit branch that will be the source of the backport\n+            localRepo.checkout(editHashCommon);\n+            var editHash = CheckableRepository.appendAndCommit(localRepo);\n+            localRepo.push(editHash, author.url(), \"edit\");\n+\n+            \/\/ Add a backport command\n+            author.addCommitComment(editHash, \"\/backport \" + author.name());\n+            TestBotRunner.runPeriodicItems(bot);\n+\n+            var recentCommitComments = author.recentCommitComments();\n+            assertEquals(2, recentCommitComments.size());\n+            var botReply = recentCommitComments.get(0);\n+            assertTrue(botReply.body().contains(\"backport\"));\n+            assertTrue(botReply.body().contains(\"was successfully created\"));\n+            assertTrue(botReply.body().contains(\"To create a pull request\"));\n+            assertTrue(botReply.body().contains(\"with this backport\"));\n+        }\n+    }\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/BackportCommitCommandTests.java","additions":87,"deletions":7,"binary":false,"changes":94,"status":"modified"},{"patch":"@@ -32,1 +32,0 @@\n-import java.nio.charset.StandardCharsets;\n@@ -44,2 +43,1 @@\n-             var tempFolder = new TemporaryDirectory();\n-             var pushedFolder = new TemporaryDirectory()) {\n+             var tempFolder = new TemporaryDirectory()) {\n@@ -105,1 +103,1 @@\n-            var prAsCommitter = author.pullRequest(pr.id());\n+            author.pullRequest(pr.id());\n@@ -143,2 +141,1 @@\n-             var tempFolder = new TemporaryDirectory();\n-             var pushedFolder = new TemporaryDirectory()) {\n+             var tempFolder = new TemporaryDirectory()) {\n@@ -207,1 +204,1 @@\n-            var prAsCommitter = author.pullRequest(pr.id());\n+            author.pullRequest(pr.id());\n@@ -245,2 +242,1 @@\n-             var tempFolder = new TemporaryDirectory();\n-             var pushedFolder = new TemporaryDirectory()) {\n+             var tempFolder = new TemporaryDirectory()) {\n@@ -311,1 +307,1 @@\n-            var prAsCommitter = author.pullRequest(pr.id());\n+            author.pullRequest(pr.id());\n@@ -350,2 +346,1 @@\n-             var tempFolder = new TemporaryDirectory();\n-             var pushedFolder = new TemporaryDirectory()) {\n+             var tempFolder = new TemporaryDirectory()) {\n@@ -397,2 +392,1 @@\n-             var tempFolder = new TemporaryDirectory();\n-             var pushedFolder = new TemporaryDirectory()) {\n+             var tempFolder = new TemporaryDirectory()) {\n@@ -466,2 +460,1 @@\n-             var tempFolder = new TemporaryDirectory();\n-             var pushedFolder = new TemporaryDirectory()) {\n+             var tempFolder = new TemporaryDirectory()) {\n@@ -534,2 +527,1 @@\n-             var tempFolder = new TemporaryDirectory(false);\n-             var pushedFolder = new TemporaryDirectory(false)) {\n+             var tempFolder = new TemporaryDirectory(false)) {\n@@ -597,2 +589,1 @@\n-             var tempFolder = new TemporaryDirectory(false);\n-             var pushedFolder = new TemporaryDirectory(false)) {\n+             var tempFolder = new TemporaryDirectory(false)) {\n@@ -668,2 +659,1 @@\n-             var tempFolder = new TemporaryDirectory(false);\n-             var pushedFolder = new TemporaryDirectory(false)) {\n+             var tempFolder = new TemporaryDirectory(false)) {\n@@ -739,2 +729,1 @@\n-             var tempFolder = new TemporaryDirectory(false);\n-             var pushedFolder = new TemporaryDirectory(false)) {\n+             var tempFolder = new TemporaryDirectory(false)) {\n@@ -813,2 +802,1 @@\n-             var tempFolder = new TemporaryDirectory();\n-             var pushedFolder = new TemporaryDirectory()) {\n+             var tempFolder = new TemporaryDirectory()) {\n@@ -872,1 +860,1 @@\n-            var prAsCommitter = author.pullRequest(pr.id());\n+            author.pullRequest(pr.id());\n@@ -910,2 +898,1 @@\n-             var tempFolder = new TemporaryDirectory();\n-             var pushedFolder = new TemporaryDirectory()) {\n+             var tempFolder = new TemporaryDirectory()) {\n@@ -1020,2 +1007,1 @@\n-             var tempFolder = new TemporaryDirectory();\n-             var pushedFolder = new TemporaryDirectory()) {\n+             var tempFolder = new TemporaryDirectory()) {\n@@ -1079,2 +1065,1 @@\n-             var tempFolder = new TemporaryDirectory();\n-             var pushedFolder = new TemporaryDirectory()) {\n+             var tempFolder = new TemporaryDirectory()) {\n@@ -1138,2 +1123,1 @@\n-             var tempFolder = new TemporaryDirectory();\n-             var pushedFolder = new TemporaryDirectory()) {\n+             var tempFolder = new TemporaryDirectory()) {\n@@ -1197,2 +1181,1 @@\n-             var tempFolder = new TemporaryDirectory();\n-             var pushedFolder = new TemporaryDirectory()) {\n+             var tempFolder = new TemporaryDirectory()) {\n@@ -1258,1 +1241,1 @@\n-            var prAsCommitter = author.pullRequest(pr.id());\n+            author.pullRequest(pr.id());\n@@ -1296,2 +1279,1 @@\n-             var tempFolder = new TemporaryDirectory();\n-             var pushedFolder = new TemporaryDirectory()) {\n+             var tempFolder = new TemporaryDirectory()) {\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/BackportTests.java","additions":22,"deletions":40,"binary":false,"changes":62,"status":"modified"}]}