{"files":[{"patch":"@@ -66,0 +66,2 @@\n+    private static final String INITIAL_GIT_HASH = \"4b825dc642cb6eb9a060e54bf8d69288fbee4904\";\n+\n@@ -369,1 +371,3 @@\n-                        history.setBranchHash(new Branch(ref.name()), listener.name(), ref.hash());\n+                        \/\/ Initial the hash for the branches in the first commit, so that the branches will not be treated as 'new'\n+                        \/\/ and the first commit will be treated as 'update', so we will get notifications\n+                        history.setBranchHash(new Branch(ref.name()), listener.name(), new Hash(INITIAL_GIT_HASH));\n@@ -371,2 +375,0 @@\n-                } else {\n-                    errors.addAll(handleRef(localRepo, history, ref, knownRefs, scratchPath));\n@@ -374,0 +376,1 @@\n+                errors.addAll(handleRef(localRepo, history, ref, knownRefs, scratchPath));\n","filename":"bots\/notify\/src\/main\/java\/org\/openjdk\/skara\/bots\/notify\/RepositoryWorkItem.java","additions":6,"deletions":3,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -138,2 +138,2 @@\n-            assertEquals(1, idempotent.updateCount);\n-            assertEquals(1, nonIdempotent.updateCount);\n+            assertEquals(2, idempotent.updateCount);\n+            assertEquals(2, nonIdempotent.updateCount);\n@@ -149,2 +149,2 @@\n-            assertEquals(2, idempotent.updateCount);\n-            assertEquals(2, nonIdempotent.updateCount);\n+            assertEquals(3, idempotent.updateCount);\n+            assertEquals(3, nonIdempotent.updateCount);\n@@ -155,2 +155,2 @@\n-            assertEquals(3, idempotent.updateCount);\n-            assertEquals(2, nonIdempotent.updateCount);\n+            assertEquals(4, idempotent.updateCount);\n+            assertEquals(3, nonIdempotent.updateCount);\n","filename":"bots\/notify\/src\/test\/java\/org\/openjdk\/skara\/bots\/notify\/UpdaterTests.java","additions":6,"deletions":6,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -78,1 +78,1 @@\n-            assertEquals(List.of(), findJsonFiles(jsonFolder, \"\"));\n+            assertEquals(1, findJsonFiles(jsonFolder, \"\").size());\n@@ -84,1 +84,1 @@\n-            assertEquals(1, jsonFiles.size());\n+            assertEquals(2, jsonFiles.size());\n@@ -86,0 +86,3 @@\n+            if (JSON.parse(jsonData).asArray().size() != 1) {\n+                jsonData = Files.readString(jsonFiles.get(1), StandardCharsets.UTF_8);\n+            }\n@@ -127,1 +130,1 @@\n-            assertEquals(List.of(), findJsonFiles(jsonFolder, \"\"));\n+            assertEquals(1, findJsonFiles(jsonFolder, \"\").size());\n@@ -138,1 +141,1 @@\n-            assertEquals(3, jsonFiles.size());\n+            assertEquals(4, jsonFiles.size());\n@@ -145,0 +148,3 @@\n+                    if (json.asArray().get(0).get(\"issue\").asArray().size() == 0) {\n+                        continue;\n+                    }\n","filename":"bots\/notify\/src\/test\/java\/org\/openjdk\/skara\/bots\/notify\/json\/JsonNotifierTests.java","additions":10,"deletions":4,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -28,0 +28,1 @@\n+import org.openjdk.skara.mailinglist.Conversation;\n@@ -36,0 +37,1 @@\n+import java.util.stream.Stream;\n@@ -82,1 +84,1 @@\n-            \/\/ No mail should be sent on the first run as there is no history\n+            \/\/ One mail should be sent on first commit\n@@ -84,1 +86,1 @@\n-            assertThrows(RuntimeException.class, () -> listServer.processIncoming(Duration.ofMillis(1)));\n+            listServer.processIncoming();\n@@ -92,0 +94,9 @@\n+            conversations.sort((c1, c2) -> {\n+                if (c2.first().date().isAfter(c1.first().date())) {\n+                    return 1;\n+                } else if (c2.first().date().isBefore(c1.first().date())) {\n+                    return -1;\n+                }\n+                return 0;\n+            });\n+            \/\/ get the latest email\n@@ -152,1 +163,1 @@\n-            \/\/ No mail should be sent on the first run as there is no history\n+            \/\/ One mail should be sent on first commit\n@@ -154,1 +165,1 @@\n-            assertThrows(RuntimeException.class, () -> listServer.processIncoming(Duration.ofMillis(1)));\n+            listServer.processIncoming();\n@@ -167,0 +178,9 @@\n+            conversations.sort((c1, c2) -> {\n+                if (c2.first().date().isAfter(c1.first().date())) {\n+                    return 1;\n+                } else if (c2.first().date().isBefore(c1.first().date())) {\n+                    return -1;\n+                }\n+                return 0;\n+            });\n+            \/\/ get the latest email\n@@ -224,1 +244,1 @@\n-            \/\/ No mail should be sent on the first run as there is no history\n+            \/\/ One mail should be sent on first commit\n@@ -226,1 +246,1 @@\n-            assertThrows(RuntimeException.class, () -> listServer.processIncoming(Duration.ofMillis(1)));\n+            listServer.processIncoming();\n@@ -245,0 +265,9 @@\n+            conversations.sort((c1, c2) -> {\n+                if (c2.first().date().isAfter(c1.first().date())) {\n+                    return 1;\n+                } else if (c2.first().date().isBefore(c1.first().date())) {\n+                    return -1;\n+                }\n+                return 0;\n+            });\n+            \/\/ get the latest email\n@@ -302,1 +331,1 @@\n-            \/\/ No mail should be sent on the first run as there is no history\n+            \/\/ One mail should be sent on first commit\n@@ -304,1 +333,1 @@\n-            assertThrows(RuntimeException.class, () -> listServer.processIncoming(Duration.ofMillis(1)));\n+            listServer.processIncoming();\n@@ -314,0 +343,9 @@\n+            conversations.sort((c1, c2) -> {\n+                if (c2.first().date().isAfter(c1.first().date())) {\n+                    return 1;\n+                } else if (c2.first().date().isBefore(c1.first().date())) {\n+                    return -1;\n+                }\n+                return 0;\n+            });\n+            \/\/ get the latest email\n@@ -369,1 +407,1 @@\n-            \/\/ No mail should be sent on the first run as there is no history\n+            \/\/ Two mails should be sent on first commit\n@@ -371,1 +409,2 @@\n-            assertThrows(RuntimeException.class, () -> listServer.processIncoming(Duration.ofMillis(1)));\n+            listServer.processIncoming();\n+            listServer.processIncoming();\n@@ -382,0 +421,9 @@\n+            conversations.sort((c1, c2) -> {\n+                if (c2.first().date().isAfter(c1.first().date())) {\n+                    return 1;\n+                } else if (c2.first().date().isBefore(c1.first().date())) {\n+                    return -1;\n+                }\n+                return 0;\n+            });\n+            \/\/ get the latest email\n@@ -408,0 +456,8 @@\n+            conversations.sort((c1, c2) -> {\n+                if (c2.first().date().isAfter(c1.first().date())) {\n+                    return 1;\n+                } else if (c2.first().date().isBefore(c1.first().date())) {\n+                    return -1;\n+                }\n+                return 0;\n+            });\n@@ -472,1 +528,1 @@\n-            \/\/ No mail should be sent on the first run as there is no history\n+            \/\/ Two mails should be sent on first commit\n@@ -474,1 +530,2 @@\n-            assertThrows(RuntimeException.class, () -> listServer.processIncoming(Duration.ofMillis(1)));\n+            listServer.processIncoming();\n+            listServer.processIncoming();\n@@ -502,1 +559,9 @@\n-            assertEquals(2, conversations.size());\n+            assertEquals(4, conversations.size());\n+            conversations.sort((c1, c2) -> {\n+                if (c2.first().date().isAfter(c1.first().date())) {\n+                    return 1;\n+                } else if (c2.first().date().isBefore(c1.first().date())) {\n+                    return -1;\n+                }\n+                return 0;\n+            });\n@@ -504,3 +569,0 @@\n-            if (secondEmail.subject().contains(\"RFR\")) {\n-                secondEmail = conversations.get(1).first();\n-            }\n@@ -551,1 +613,1 @@\n-            \/\/ No mail should be sent on the first run as there is no history\n+            \/\/ One mail should be sent on first commit\n@@ -553,1 +615,1 @@\n-            assertThrows(RuntimeException.class, () -> listServer.processIncoming(Duration.ofMillis(1)));\n+            listServer.processIncoming();\n@@ -587,2 +649,9 @@\n-            conversations.sort(Comparator.comparing(conversation -> conversation.first().subject()));\n-            assertEquals(2, conversations.size());\n+            conversations.sort((c1, c2) -> {\n+                if (c2.first().date().isAfter(c1.first().date())) {\n+                    return 1;\n+                } else if (c2.first().date().isBefore(c1.first().date())) {\n+                    return -1;\n+                }\n+                return 0;\n+            });\n+            assertEquals(3, conversations.size());\n@@ -590,2 +659,2 @@\n-            var prConversation = conversations.get(0);\n-            var pushConversation = conversations.get(1);\n+            var prConversation = conversations.get(1);\n+            var pushConversation = conversations.get(0);\n@@ -642,1 +711,1 @@\n-            \/\/ No mail should be sent on the first run as there is no history\n+            \/\/ One mail should be sent on first commit\n@@ -644,1 +713,1 @@\n-            assertThrows(RuntimeException.class, () -> listServer.processIncoming(Duration.ofMillis(1)));\n+            listServer.processIncoming();\n@@ -683,2 +752,9 @@\n-            conversations.sort(Comparator.comparing(conversation -> conversation.first().subject()));\n-            assertEquals(2, conversations.size());\n+            conversations.sort((c1, c2) -> {\n+                if (c2.first().date().isAfter(c1.first().date())) {\n+                    return 1;\n+                } else if (c2.first().date().isBefore(c1.first().date())) {\n+                    return -1;\n+                }\n+                return 0;\n+            });\n+            assertEquals(3, conversations.size());\n@@ -686,2 +762,2 @@\n-            var prConversation = conversations.get(0);\n-            var pushConversation = conversations.get(1);\n+            var prConversation = conversations.get(1);\n+            var pushConversation = conversations.get(0);\n@@ -740,1 +816,1 @@\n-            \/\/ No mail should be sent on the first run as there is no history\n+            \/\/ Two mails should be sent on first commit\n@@ -742,1 +818,2 @@\n-            assertThrows(RuntimeException.class, () -> listServer.processIncoming(Duration.ofMillis(1)));\n+            listServer.processIncoming();\n+            listServer.processIncoming();\n@@ -769,1 +846,9 @@\n-            assertEquals(1, conversations.size());\n+            conversations.sort((c1, c2) -> {\n+                if (c2.first().date().isAfter(c1.first().date())) {\n+                    return 1;\n+                } else if (c2.first().date().isBefore(c1.first().date())) {\n+                    return -1;\n+                }\n+                return 0;\n+            });\n+            assertEquals(3, conversations.size());\n@@ -781,2 +866,9 @@\n-            conversations.sort(Comparator.comparing(conversation -> conversation.first().subject()));\n-            assertEquals(2, conversations.size());\n+            conversations.sort((c1, c2) -> {\n+                if (c2.first().date().isAfter(c1.first().date())) {\n+                    return 1;\n+                } else if (c2.first().date().isBefore(c1.first().date())) {\n+                    return -1;\n+                }\n+                return 0;\n+            });\n+            assertEquals(4, conversations.size());\n@@ -784,1 +876,1 @@\n-            var pushConversation = conversations.get(1);\n+            var pushConversation = conversations.get(0);\n@@ -843,1 +935,1 @@\n-            \/\/ No mail should be sent on the first run as there is no history\n+            \/\/ One mail should be sent on first commit\n@@ -845,1 +937,1 @@\n-            assertThrows(RuntimeException.class, () -> listServer.processIncoming(Duration.ofMillis(1)));\n+            listServer.processIncoming();\n@@ -866,1 +958,1 @@\n-            assertEquals(4, conversations.size());\n+            assertEquals(5, conversations.size());\n@@ -902,1 +994,5 @@\n-                } else {\n+                } else if(email.subject().equals(\"git: test: 2 new changesets\")){\n+                    assertTrue(email.body().contains(\"Initial commit\"));\n+                    assertTrue(email.body().contains(\"Lock\"));\n+                }\n+                else {\n@@ -962,1 +1058,1 @@\n-            \/\/ No mail should be sent on the first run as there is no history\n+            \/\/ One mail should be sent on first commit\n@@ -964,1 +1060,1 @@\n-            assertThrows(RuntimeException.class, () -> listServer.processIncoming(Duration.ofMillis(1)));\n+            listServer.processIncoming();\n@@ -985,1 +1081,1 @@\n-            assertEquals(4, conversations.size());\n+            assertEquals(5, conversations.size());\n@@ -997,0 +1093,2 @@\n+                } else if(email.subject().equals(\"git: test: 2 new changesets\")){\n+                    assertEquals(EmailAddress.from(\"test\", \"test@test.test\"), email.author());\n@@ -1047,1 +1145,1 @@\n-            \/\/ No mail should be sent on the first run as there is no history\n+            \/\/ One mail should be sent on first commit\n@@ -1049,1 +1147,1 @@\n-            assertThrows(RuntimeException.class, () -> listServer.processIncoming(Duration.ofMillis(1)));\n+            listServer.processIncoming();\n@@ -1058,0 +1156,8 @@\n+            conversations.sort((c1, c2) -> {\n+                if (c2.first().date().isAfter(c1.first().date())) {\n+                    return 1;\n+                } else if (c2.first().date().isBefore(c1.first().date())) {\n+                    return -1;\n+                }\n+                return 0;\n+            });\n@@ -1076,4 +1182,10 @@\n-            var newConversation = mailmanList.conversations(Duration.ofDays(1)).stream()\n-                                             .filter(c -> !c.equals(conversations.get(0)))\n-                                             .findFirst().orElseThrow();\n-            email = newConversation.first();\n+            var newConversations = mailmanList.conversations(Duration.ofDays(1));\n+            newConversations.sort((c1, c2) -> {\n+                if (c2.first().date().isAfter(c1.first().date())) {\n+                    return 1;\n+                } else if (c2.first().date().isBefore(c1.first().date())) {\n+                    return -1;\n+                }\n+                return 0;\n+            });\n+            email = newConversations.get(0).first();\n@@ -1129,1 +1241,1 @@\n-            \/\/ No mail should be sent on the first run as there is no history\n+            \/\/ One mail should be sent on first commit\n@@ -1131,1 +1243,1 @@\n-            assertThrows(RuntimeException.class, () -> listServer.processIncoming(Duration.ofMillis(1)));\n+            listServer.processIncoming();\n@@ -1142,1 +1254,1 @@\n-            assertEquals(1, conversations.size());\n+            assertEquals(2, conversations.size());\n@@ -1151,1 +1263,1 @@\n-            assertEquals(2, conversations.size());\n+            assertEquals(3, conversations.size());\n","filename":"bots\/notify\/src\/test\/java\/org\/openjdk\/skara\/bots\/notify\/mailinglist\/MailingListNotifierTests.java","additions":163,"deletions":51,"binary":false,"changes":214,"status":"modified"}]}