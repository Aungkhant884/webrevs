{"files":[{"patch":"@@ -0,0 +1,41 @@\n+package org.openjdk.skara.bots.pr;\n+\n+import org.openjdk.skara.forge.HostedRepositoryPool;\n+import org.openjdk.skara.forge.PullRequest;\n+import org.openjdk.skara.forge.PullRequestUtils;\n+import org.openjdk.skara.issuetracker.Comment;\n+\n+import java.io.IOException;\n+import java.io.PrintWriter;\n+import java.io.UncheckedIOException;\n+import java.nio.file.Path;\n+import java.util.HashSet;\n+import java.util.List;\n+\n+public class CheckCommand implements CommandHandler {\n+    @Override\n+    public String description() {\n+        return \"run Jcheck again\";\n+    }\n+\n+    @Override\n+    public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, CommandInvocation command, List<Comment> allComments, PrintWriter reply) {\n+        try {\n+            var workItem = new CheckWorkItem(bot, pr, e -> {});\n+\n+            var path = scratchPath.resolve(\"check\").resolve(pr.repository().name());\n+            var seedPath = bot.seedStorage().orElse(scratchPath.resolve(\"seeds\"));\n+            var hostedRepositoryPool = new HostedRepositoryPool(seedPath);\n+            var localRepo = PullRequestUtils.materialize(hostedRepositoryPool, pr, path);\n+\n+            var allReviews = pr.reviews();\n+            var activeReviews = CheckablePullRequest.filterActiveReviews(allReviews);\n+            var activeLabels = new HashSet<>(pr.labels());\n+\n+            CheckRun.execute(workItem, pr, localRepo, allComments, allReviews, activeReviews, activeLabels, censusInstance, bot.ignoreStaleReviews());\n+        } catch (IOException e) {\n+            throw new UncheckedIOException(e);\n+        }\n+    }\n+\n+}\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CheckCommand.java","additions":41,"deletions":0,"binary":false,"changes":41,"status":"added"},{"patch":"@@ -58,1 +58,2 @@\n-            Map.entry(\"cc\", new LabelCommand(\"cc\"))\n+            Map.entry(\"cc\", new LabelCommand(\"cc\")),\n+            Map.entry(\"check\", new CheckCommand())\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CommandWorkItem.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -0,0 +1,47 @@\n+package org.openjdk.skara.bots.pr;\n+\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInfo;\n+import org.openjdk.skara.test.CheckableRepository;\n+import org.openjdk.skara.test.HostCredentials;\n+import org.openjdk.skara.test.TemporaryDirectory;\n+import org.openjdk.skara.test.TestBotRunner;\n+\n+import java.io.IOException;\n+\n+import static org.junit.jupiter.api.Assertions.assertFalse;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+public class CheckCommandTests {\n+    @Test\n+    public void testCheckRun(TestInfo testInfo) throws IOException {\n+        try (var credentials = new HostCredentials(testInfo);\n+             var tempFolder = new TemporaryDirectory()) {\n+            var author = credentials.getHostedRepository();\n+            var integrator = credentials.getHostedRepository();\n+\n+            var censusBuilder = credentials.getCensusBuilder()\n+                    .addReviewer(integrator.forge().currentUser().id())\n+                    .addCommitter(author.forge().currentUser().id());\n+            var prBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();\n+\n+            \/\/ Populate the projects repository\n+            var localRepoFolder = tempFolder.path().resolve(\"localrepo\");\n+            var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());\n+            var masterHash = localRepo.resolve(\"master\").orElseThrow();\n+            assertFalse(CheckableRepository.hasBeenEdited(localRepo));\n+            localRepo.push(masterHash, author.url(), \"master\", true);\n+\n+            \/\/ Make a change with a corresponding PR\n+            var editHash = CheckableRepository.appendAndCommit(localRepo);\n+            localRepo.push(editHash, author.url(), \"edit\", true);\n+            var pr = credentials.createPullRequest(author, \"master\", \"edit\", \"This is a pull request\");\n+            pr.addComment(\"\/check\");\n+\n+            assertFalse(pr.checks(editHash).containsKey(\"jcheck\"));\n+            TestBotRunner.runPeriodicItems(prBot);\n+            assertTrue(pr.checks(editHash).containsKey(\"jcheck\"));\n+        }\n+    }\n+\n+}\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/CheckCommandTests.java","additions":47,"deletions":0,"binary":false,"changes":47,"status":"added"}]}