{"files":[{"patch":"@@ -40,2 +40,9 @@\n-    D res = __atomic_add_fetch(dest, add_value, __ATOMIC_RELEASE);\n-    FULL_MEM_BARRIER;\n+    if (order != memory_order_relaxed) {\n+      FULL_MEM_BARRIER;\n+    }\n+\n+    D res = __atomic_add_fetch(dest, add_value, __ATOMIC_RELAXED);\n+\n+    if (order != memory_order_relaxed) {\n+      FULL_MEM_BARRIER;\n+    }\n@@ -57,2 +64,9 @@\n-  T res = __atomic_exchange_n(dest, exchange_value, __ATOMIC_RELEASE);\n-  FULL_MEM_BARRIER;\n+  if (order != memory_order_relaxed) {\n+    FULL_MEM_BARRIER;\n+  }\n+\n+  T res = __atomic_exchange_n(dest, exchange_value, __ATOMIC_RELAXED);\n+\n+  if (order != memory_order_relaxed) {\n+    FULL_MEM_BARRIER;\n+  }\n@@ -91,0 +105,4 @@\n+\n+  T old_value;\n+  long rc;\n+\n@@ -94,13 +112,12 @@\n-  T rv;\n-  int tmp;\n-  __asm volatile(\n-    \"1:\\n\\t\"\n-    \" addiw     %[tmp], %[cv], 0\\n\\t\" \/\/ make sure compare_value signed_extend\n-    \" lr.w.aq   %[rv], (%[dest])\\n\\t\"\n-    \" bne       %[rv], %[tmp], 2f\\n\\t\"\n-    \" sc.w.rl   %[tmp], %[ev], (%[dest])\\n\\t\"\n-    \" bnez      %[tmp], 1b\\n\\t\"\n-    \"2:\\n\\t\"\n-    : [rv] \"=&r\" (rv), [tmp] \"=&r\" (tmp)\n-    : [ev] \"r\" (exchange_value), [dest] \"r\" (dest), [cv] \"r\" (compare_value)\n-    : \"memory\");\n+\n+  __asm__ __volatile__ (\n+    \"1:  sext.w    %1, %3      \\n\\t\" \/\/ sign-extend compare_value\n+    \"    lr.w      %0, %2      \\n\\t\"\n+    \"    bne       %0, %1, 2f  \\n\\t\"\n+    \"    sc.w      %1, %4, %2  \\n\\t\"\n+    \"    bnez      %1, 1b      \\n\\t\"\n+    \"2:                        \\n\\t\"\n+    : \/*%0*\/\"=&r\" (old_value), \/*%1*\/\"=&r\" (rc), \/*%2*\/\"+A\" (*dest)\n+    : \/*%3*\/\"r\" (compare_value), \/*%4*\/\"r\" (exchange_value)\n+    : \"memory\" );\n+\n@@ -110,1 +127,1 @@\n-  return rv;\n+  return old_value;\n","filename":"src\/hotspot\/os_cpu\/linux_riscv\/atomic_linux_riscv.hpp","additions":35,"deletions":18,"binary":false,"changes":53,"status":"modified"}]}