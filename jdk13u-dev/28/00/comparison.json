{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1999, 2018, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1999, 2020, Oracle and\/or its affiliates. All rights reserved.\n@@ -28,4 +28,0 @@\n-import sun.awt.EmbeddedFrame;\n-import sun.awt.OSInfo;\n-import sun.swing.SwingAccessor;\n-\n@@ -33,1 +29,11 @@\n-import java.awt.*;\n+import java.awt.BorderLayout;\n+import java.awt.Component;\n+import java.awt.Container;\n+import java.awt.GraphicsConfiguration;\n+import java.awt.GraphicsEnvironment;\n+import java.awt.Insets;\n+import java.awt.Panel;\n+import java.awt.Point;\n+import java.awt.Rectangle;\n+import java.awt.Toolkit;\n+import java.awt.Window;\n@@ -41,0 +47,5 @@\n+\n+import sun.awt.EmbeddedFrame;\n+import sun.awt.OSInfo;\n+import sun.swing.SwingAccessor;\n+\n@@ -829,0 +840,2 @@\n+            pack();\n+            component.setVisible(true);\n@@ -832,4 +845,1 @@\n-            JComponent component = new JPanel(new BorderLayout(), true);\n-\n-            component.setOpaque(true);\n-            return component;\n+            return new JPanel(new BorderLayout(), true);\n@@ -850,2 +860,1 @@\n-\n-            component.setOpaque(contents.isOpaque());\n+            component.setVisible(false);\n@@ -853,0 +862,1 @@\n+            component.setOpaque(contents.isOpaque());\n@@ -854,1 +864,0 @@\n-            contents.invalidate();\n@@ -963,4 +972,1 @@\n-            \/\/ Set the visibility to false before adding to workaround a\n-            \/\/ bug in Solaris in which the Popup gets added at the wrong\n-            \/\/ location, which will result in a mouseExit, which will then\n-            \/\/ result in the ToolTip being removed.\n+\n@@ -968,10 +974,2 @@\n-                parent = ((RootPaneContainer)parent).getLayeredPane();\n-                Point p = SwingUtilities.convertScreenLocationToParent(parent,\n-                                                                       x, y);\n-                component.setVisible(false);\n-                component.setLocation(p.x, p.y);\n-                parent.add(component, JLayeredPane.POPUP_LAYER,\n-                                           0);\n-            } else {\n-                Point p = SwingUtilities.convertScreenLocationToParent(parent,\n-                                                                       x, y);\n+                parent = ((RootPaneContainer) parent).getLayeredPane();\n+            }\n@@ -979,2 +977,6 @@\n-                component.setLocation(p.x, p.y);\n-                component.setVisible(false);\n+            Point p = SwingUtilities.convertScreenLocationToParent(parent,\n+                                                                   x, y);\n+            component.setLocation(p.x, p.y);\n+            if (parent instanceof JLayeredPane) {\n+                parent.add(component, JLayeredPane.POPUP_LAYER, 0);\n+            } else {\n@@ -983,0 +985,1 @@\n+            pack();\n@@ -984,0 +987,1 @@\n+            component.revalidate();\n@@ -1007,1 +1011,1 @@\n-\n+            component.setVisible(false);\n@@ -1010,2 +1014,0 @@\n-            contents.invalidate();\n-            component.validate();\n","filename":"src\/java.desktop\/share\/classes\/javax\/swing\/PopupFactory.java","additions":34,"deletions":32,"binary":false,"changes":66,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2018, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2018, 2020, Oracle and\/or its affiliates. All rights reserved.\n@@ -24,1 +24,0 @@\n-import java.awt.Component;\n@@ -36,0 +35,1 @@\n+import javax.swing.JComponent;\n@@ -51,0 +51,2 @@\n+import javax.swing.Popup;\n+import javax.swing.PopupFactory;\n@@ -57,0 +59,2 @@\n+import sun.swing.MenuItemLayoutHelper;\n+\n@@ -62,1 +66,1 @@\n- * @bug 8201552 8213843\n+ * @bug 8201552 8213843 8213535\n@@ -66,0 +70,1 @@\n+ * @modules java.desktop\/sun.swing\n@@ -67,3 +72,3 @@\n- * @run main\/othervm\/timeout=200 StalePreferredSize\n- * @run main\/othervm\/timeout=200 -Dsun.java2d.uiScale=1 StalePreferredSize\n- * @run main\/othervm\/timeout=200 -Dsun.java2d.uiScale=2.25 StalePreferredSize\n+ * @run main\/othervm\/timeout=400 StalePreferredSize\n+ * @run main\/othervm\/timeout=400 -Dsun.java2d.uiScale=1 StalePreferredSize\n+ * @run main\/othervm\/timeout=400 -Dsun.java2d.uiScale=2.25 StalePreferredSize\n@@ -85,1 +90,2 @@\n-    static Component component;\n+    static Popup popup;\n+    static JComponent component;\n@@ -87,0 +93,1 @@\n+    static boolean addViaPopup;\n@@ -93,4 +100,9 @@\n-                for (final boolean html : new boolean[]{true, false}) {\n-                    for (String text : TEXT) {\n-                        if (html) {\n-                            text = \"<html>\" + text + \"<\/html>\";\n+                for (boolean usePopup : new boolean[]{true, false}) {\n+                    addViaPopup = usePopup;\n+                    System.err.println(\"Use popup: \" + usePopup);\n+                    for (final boolean html : new boolean[]{true, false}) {\n+                        for (String text : TEXT) {\n+                            if (html) {\n+                                text = \"<html>\" + text + \"<\/html>\";\n+                            }\n+                            test(text);\n@@ -98,1 +110,0 @@\n-                        test(text);\n@@ -108,1 +119,1 @@\n-        final List<Callable<Component>> comps = List.of(\n+        final List<Callable<JComponent>> comps = List.of(\n@@ -139,1 +150,1 @@\n-        for (final Callable<Component> creator : comps) {\n+        for (final Callable<JComponent> creator : comps) {\n@@ -144,1 +155,1 @@\n-    static void checkComponent(Callable<Component> creator) throws Exception {\n+    static void checkComponent(Callable<JComponent> creator) throws Exception {\n@@ -153,0 +164,1 @@\n+            component.setEnabled(false); \/\/ minimize paint\/focus events amount\n@@ -162,0 +174,2 @@\n+            \/\/ incorrect initial insets may ruin our size calculation\n+            frame.setUndecorated(true); \/\/ TODO JDK-8244388\n@@ -163,2 +177,1 @@\n-            frame.add(new JScrollPane(component));\n-            frame.setSize(300, 100);\n+            frame.setSize(700, 400);\n@@ -166,0 +179,13 @@\n+            if (addViaPopup) {\n+                \/\/ doing our best to show lightweight or mediumweight popup\n+                int x = frame.getX() + 50;\n+                int y = frame.getY() + 200;\n+                PopupFactory factory = PopupFactory.getSharedInstance();\n+                popup = factory.getPopup(frame, component, x, y);\n+                if (component instanceof JMenuItem) {\n+                    \/\/ TODO JDK-8244400\n+                    MenuItemLayoutHelper.clearUsedParentClientProperties((JMenuItem)component);\n+                }\n+            } else {\n+                frame.add(new JScrollPane(component));\n+            }\n@@ -167,0 +193,3 @@\n+            if (popup != null) {\n+                popup.show();\n+            }\n@@ -170,0 +199,4 @@\n+            if (!component.isValid()) {\n+                dispose();\n+                throw new RuntimeException(\"Component must be valid\");\n+            }\n@@ -182,1 +215,1 @@\n-            frame.dispose();\n+            dispose();\n@@ -200,0 +233,8 @@\n+    private static void dispose() {\n+        if (popup != null) {\n+            popup.hide();\n+            popup = null;\n+        }\n+        frame.dispose();\n+    }\n+\n","filename":"test\/jdk\/javax\/swing\/GraphicsConfigNotifier\/StalePreferredSize.java","additions":59,"deletions":18,"binary":false,"changes":77,"status":"modified"},{"patch":"@@ -3,1 +3,1 @@\n- * Copyright (c) 2012, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2012, 2020, Oracle and\/or its affiliates. All rights reserved.\n@@ -134,0 +134,1 @@\n+        frame.setLocationRelativeTo(null);\n","filename":"test\/jdk\/javax\/swing\/JPopupMenu\/6800513\/bug6800513.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2012, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2012, 2020, Oracle and\/or its affiliates. All rights reserved.\n@@ -117,0 +117,1 @@\n+        frame.setLocationRelativeTo(null);\n","filename":"test\/jdk\/javax\/swing\/JToolTip\/4846413\/bug4846413.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2011, 2013, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2011, 2020, Oracle and\/or its affiliates. All rights reserved.\n@@ -52,0 +52,1 @@\n+        setLocationRelativeTo(null);\n","filename":"test\/jdk\/javax\/swing\/PopupFactory\/6276087\/NonOpaquePopupMenuTest.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"}]}