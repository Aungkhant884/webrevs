{"files":[{"patch":"@@ -374,0 +374,1 @@\n+  stat_relocation()->at_collection_start();\n","filename":"src\/hotspot\/share\/gc\/z\/zGeneration.cpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -44,0 +44,22 @@\n+ZRelocationSetSelectorStats::ZRelocationSetSelectorStats() :\n+    _has_relocatable_pages(false) {\n+  for (uint i = 0; i <= ZPageAgeMax; ++i) {\n+    _small[i] = ZRelocationSetSelectorGroupStats();\n+    _medium[i] = ZRelocationSetSelectorGroupStats();\n+    _large[i] = ZRelocationSetSelectorGroupStats();\n+  }\n+}\n+\n+ZRelocationSetSelectorStats::ZRelocationSetSelectorStats(const ZRelocationSetSelectorGroup* small,\n+                                                         const ZRelocationSetSelectorGroup* medium,\n+                                                         const ZRelocationSetSelectorGroup* large,\n+                                                         bool has_relocatable_pages) :\n+    _has_relocatable_pages(has_relocatable_pages) {\n+  for (uint i = 0; i <= ZPageAgeMax; ++i) {\n+    const ZPageAge age = static_cast<ZPageAge>(i);\n+    _small[i] = small->stats(age);\n+    _medium[i] = medium->stats(age);\n+    _large[i] = large->stats(age);\n+  }\n+}\n+\n@@ -238,12 +260,2 @@\n-  ZRelocationSetSelectorStats stats;\n-\n-  for (uint i = 0; i <= ZPageAgeMax; ++i) {\n-    const ZPageAge age = static_cast<ZPageAge>(i);\n-    stats._small[i] = _small.stats(age);\n-    stats._medium[i] = _medium.stats(age);\n-    stats._large[i] = _large.stats(age);\n-  }\n-\n-  stats._has_relocatable_pages = total() > 0;\n-\n-  return stats;\n+  const bool has_relocatable_pages = total() > 0;\n+  return ZRelocationSetSelectorStats(&_small, &_medium, &_large, has_relocatable_pages);\n","filename":"src\/hotspot\/share\/gc\/z\/zRelocationSetSelector.cpp","additions":24,"deletions":12,"binary":false,"changes":36,"status":"modified"},{"patch":"@@ -34,0 +34,1 @@\n+class ZRelocationSetSelectorGroup;\n@@ -69,1 +70,1 @@\n-  size_t _has_relocatable_pages;\n+  bool _has_relocatable_pages;\n@@ -72,0 +73,6 @@\n+  ZRelocationSetSelectorStats();\n+  ZRelocationSetSelectorStats(const ZRelocationSetSelectorGroup* small,\n+                              const ZRelocationSetSelectorGroup* medium,\n+                              const ZRelocationSetSelectorGroup* large,\n+                              bool has_relocatable_pages);\n+\n@@ -76,0 +83,3 @@\n+  size_t live_bytes(ZPageAge age) const;\n+  size_t npages(ZPageAge age) const;\n+\n","filename":"src\/hotspot\/share\/gc\/z\/zRelocationSetSelector.hpp","additions":11,"deletions":1,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -56,4 +56,0 @@\n-inline bool ZRelocationSetSelectorStats::has_relocatable_pages() const {\n-  return _has_relocatable_pages;\n-}\n-\n@@ -72,0 +68,14 @@\n+inline size_t ZRelocationSetSelectorStats::live_bytes(ZPageAge age) const {\n+  return small(age).live() + medium(age).live() + large(age).live();\n+}\n+\n+inline size_t ZRelocationSetSelectorStats::npages(ZPageAge age) const {\n+  return small(age).npages_candidates() +\n+         medium(age).npages_candidates() +\n+         large(age).npages_candidates();\n+}\n+\n+inline bool ZRelocationSetSelectorStats::has_relocatable_pages() const {\n+  return _has_relocatable_pages;\n+}\n+\n","filename":"src\/hotspot\/share\/gc\/z\/zRelocationSetSelector.inline.hpp","additions":14,"deletions":4,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -1473,0 +1473,5 @@\n+void ZStatRelocation::at_collection_start() {\n+  _previous_selector_stats = _selector_stats;\n+  _selector_stats = {};\n+}\n+\n@@ -1486,1 +1491,1 @@\n-void ZStatRelocation::print_page_summary() {\n+void ZStatRelocation::print_page_summary() const {\n@@ -1494,0 +1499,9 @@\n+  struct ZStatRelocationSummary {\n+    size_t npages_candidates;\n+    size_t total;\n+    size_t live;\n+    size_t empty;\n+    size_t npages_selected;\n+    size_t relocate;\n+  };\n+\n@@ -1547,1 +1561,1 @@\n-void ZStatRelocation::print_age_table() {\n+void ZStatRelocation::print_age_table() const {\n@@ -1549,0 +1563,1 @@\n+\n@@ -1554,0 +1569,16 @@\n+  \/\/ Find range of pages to print\n+  const uint end = [&]() {\n+    for (uint i = 0; i <= ZPageAgeMax; ++i) {\n+      const ZPageAge age = static_cast<ZPageAge>(i);\n+      if (age == ZPageAge::old) {\n+        return i;\n+      }\n+\n+      if (_selector_stats.npages(age) == 0 && _previous_selector_stats.npages(age) == 0) {\n+        return i;\n+      }\n+    }\n+\n+    return ZPageAgeMax;\n+  }();\n+\n@@ -1559,1 +1590,0 @@\n-           .center(\"Garbage\")\n@@ -1565,4 +1595,9 @@\n-  size_t live[ZPageAgeMax + 1] = {};\n-  size_t total[ZPageAgeMax + 1] = {};\n-\n-  uint oldest_none_empty_age = 0;\n+  auto unit = [](size_t bytes) {\n+    if (bytes < K) {\n+      return \"B\";\n+    }\n+    if (bytes < M) {\n+      return \"K\";\n+    }\n+    return \"M\";\n+  };\n@@ -1570,13 +1605,3 @@\n-  for (uint i = 0; i <= ZPageAgeMax; ++i) {\n-    ZPageAge age = static_cast<ZPageAge>(i);\n-    auto summarize_pages = [&](const ZRelocationSetSelectorGroupStats& stats) {\n-      live[i] += stats.live();\n-      total[i] += stats.total();\n-    };\n-\n-    summarize_pages(_selector_stats.small(age));\n-    summarize_pages(_selector_stats.medium(age));\n-    summarize_pages(_selector_stats.large(age));\n-\n-    if (total[i] != 0) {\n-      oldest_none_empty_age = i;\n+  auto value = [](size_t bytes) {\n+    if (bytes < K) {\n+      return bytes;\n@@ -1584,1 +1609,5 @@\n-  }\n+    if (bytes < M) {\n+      return bytes \/ K;\n+    }\n+    return bytes \/ M;\n+  };\n@@ -1586,2 +1615,2 @@\n-  for (uint i = 0; i <= oldest_none_empty_age; ++i) {\n-    ZPageAge age = static_cast<ZPageAge>(i);\n+  for (uint i = 0; i < end; ++i) {\n+    const ZPageAge age = static_cast<ZPageAge>(i);\n@@ -1589,1 +1618,1 @@\n-    FormatBuffer<> age_str(\"\");\n+    FormatBuffer<> desc(\"\");\n@@ -1591,3 +1620,3 @@\n-      age_str.append(\"Eden\");\n-    } else if (age != ZPageAge::old) {\n-      age_str.append(\"Survivor %d\", i);\n+      desc.append(\"Eden\");\n+    } else {\n+      desc.append(\"Survivor %d\", i);\n@@ -1596,24 +1625,20 @@\n-    auto create_age_table = [&]() {\n-      if (live[i] == 0) {\n-        return age_table()\n-              .left(\"%s\", age_str.buffer())\n-              .left(ZTABLE_ARGS_NA);\n-      } else {\n-        return age_table()\n-              .left(\"%s\", age_str.buffer())\n-              .left(ZTABLE_ARGS(live[i]));\n-      }\n-    };\n-\n-    lt.print(\"%s\", create_age_table()\n-              .left(ZTABLE_ARGS(total[i] - live[i]))\n-              .left(SIZE_FORMAT_W(7) \" \/ \" SIZE_FORMAT,\n-                    _selector_stats.small(age).npages_candidates(),\n-                    _selector_stats.small(age).npages_selected())\n-              .left(SIZE_FORMAT_W(7) \" \/ \" SIZE_FORMAT,\n-                    _selector_stats.medium(age).npages_candidates(),\n-                    _selector_stats.medium(age).npages_selected())\n-              .left(SIZE_FORMAT_W(7) \" \/ \" SIZE_FORMAT,\n-                    _selector_stats.large(age).npages_candidates(),\n-                    _selector_stats.large(age).npages_selected())\n-              .end());\n+    const size_t prev_live_bytes = _previous_selector_stats.live_bytes(age);\n+    const size_t live_bytes = _selector_stats.live_bytes(age);\n+\n+    lt.print(\"%s\", age_table()\n+             .left(\"%s\", desc.buffer())\n+             .left(SIZE_FORMAT_W(8) \"%s\" \" -> \" SIZE_FORMAT \"%s\",\n+                   value(prev_live_bytes),\n+                   unit(prev_live_bytes),\n+                   value(live_bytes),\n+                   unit(live_bytes))\n+             .left(SIZE_FORMAT_W(7) \" -> \" SIZE_FORMAT,\n+                   _previous_selector_stats.small(age).npages_candidates(),\n+                   _selector_stats.small(age).npages_candidates())\n+             .left(SIZE_FORMAT_W(7) \" -> \" SIZE_FORMAT,\n+                   _previous_selector_stats.medium(age).npages_candidates(),\n+                   _selector_stats.medium(age).npages_candidates())\n+             .left(SIZE_FORMAT_W(7) \" -> \" SIZE_FORMAT,\n+                   _previous_selector_stats.large(age).npages_candidates(),\n+                   _selector_stats.large(age).npages_candidates())\n+             .end());\n","filename":"src\/hotspot\/share\/gc\/z\/zStat.cpp","additions":76,"deletions":51,"binary":false,"changes":127,"status":"modified"},{"patch":"@@ -513,9 +513,0 @@\n-struct ZStatRelocationSummary {\n-  size_t npages_candidates;\n-  size_t total;\n-  size_t live;\n-  size_t empty;\n-  size_t npages_selected;\n-  size_t relocate;\n-};\n-\n@@ -528,0 +519,1 @@\n+  ZRelocationSetSelectorStats _previous_selector_stats;\n@@ -534,4 +526,0 @@\n-  void print(const char* name,\n-             ZStatRelocationSummary selector_group,\n-             size_t in_place_count);\n-\n@@ -541,0 +529,1 @@\n+  void at_collection_start();\n@@ -545,2 +534,2 @@\n-  void print_page_summary();\n-  void print_age_table();\n+  void print_page_summary() const;\n+  void print_age_table() const;\n","filename":"src\/hotspot\/share\/gc\/z\/zStat.hpp","additions":4,"deletions":15,"binary":false,"changes":19,"status":"modified"}]}