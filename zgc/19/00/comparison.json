{"files":[{"patch":"@@ -130,1 +130,2 @@\n-    _stat_relocation(),\n+    _previous_stat_relocation(),\n+    _current_stat_relocation(),\n@@ -262,1 +263,1 @@\n-  stat_relocation()->at_select_relocation_set(selector.stats());\n+  current_stat_relocation()->at_select_relocation_set(selector.stats());\n@@ -371,0 +372,1 @@\n+  reset_relocation_stats();\n@@ -377,0 +379,5 @@\n+void ZGeneration::reset_relocation_stats() {\n+  _previous_stat_relocation = _current_stat_relocation;\n+  _current_stat_relocation.reset();\n+}\n+\n","filename":"src\/hotspot\/share\/gc\/z\/zGeneration.cpp","additions":9,"deletions":2,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -84,1 +84,2 @@\n-  ZStatRelocation       _stat_relocation;\n+  ZStatRelocation       _previous_stat_relocation;\n+  ZStatRelocation       _current_stat_relocation;\n@@ -101,0 +102,2 @@\n+  void reset_relocation_stats();\n+\n@@ -140,1 +143,2 @@\n-  ZStatRelocation* stat_relocation();\n+  const ZStatRelocation* previous_stat_relocation() const;\n+  ZStatRelocation* current_stat_relocation();\n","filename":"src\/hotspot\/share\/gc\/z\/zGeneration.hpp","additions":6,"deletions":2,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -106,2 +106,6 @@\n-inline ZStatRelocation* ZGeneration::stat_relocation() {\n-  return &_stat_relocation;\n+inline const ZStatRelocation* ZGeneration::previous_stat_relocation() const {\n+  return &_previous_stat_relocation;\n+}\n+\n+inline ZStatRelocation* ZGeneration::current_stat_relocation() {\n+  return &_current_stat_relocation;\n","filename":"src\/hotspot\/share\/gc\/z\/zGeneration.inline.hpp","additions":6,"deletions":2,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -1074,1 +1074,1 @@\n-    _generation->stat_relocation()->at_relocate_end(_small_allocator.in_place_count(), _medium_allocator.in_place_count());\n+    _generation->current_stat_relocation()->at_relocate_end(_small_allocator.in_place_count(), _medium_allocator.in_place_count());\n","filename":"src\/hotspot\/share\/gc\/z\/zRelocate.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -162,1 +162,1 @@\n-  _generation->stat_relocation()->at_install_relocation_set(_allocator.size());\n+  _generation->current_stat_relocation()->at_install_relocation_set(_allocator.size());\n","filename":"src\/hotspot\/share\/gc\/z\/zRelocationSet.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -44,0 +44,22 @@\n+ZRelocationSetSelectorStats::ZRelocationSetSelectorStats() :\n+    _has_relocatable_pages(false) {\n+    for (uint i = 0; i <= ZPageAgeMax; ++i) {\n+      _small[i] = ZRelocationSetSelectorGroupStats();\n+      _medium[i] = ZRelocationSetSelectorGroupStats();\n+      _large[i] = ZRelocationSetSelectorGroupStats();\n+    }\n+}\n+\n+ZRelocationSetSelectorStats::ZRelocationSetSelectorStats(const ZRelocationSetSelectorGroup* small,\n+                                                         const ZRelocationSetSelectorGroup* medium,\n+                                                         const ZRelocationSetSelectorGroup* large,\n+                                                         bool has_relocatable_pages) :\n+    _has_relocatable_pages(has_relocatable_pages) {\n+    for (uint i = 0; i <= ZPageAgeMax; ++i) {\n+      const ZPageAge age = static_cast<ZPageAge>(i);\n+      _small[i] = small->stats(age);\n+      _medium[i] = medium->stats(age);\n+      _large[i] = large->stats(age);\n+    }\n+}\n+\n@@ -238,12 +260,2 @@\n-  ZRelocationSetSelectorStats stats;\n-\n-  for (uint i = 0; i <= ZPageAgeMax; ++i) {\n-    const ZPageAge age = static_cast<ZPageAge>(i);\n-    stats._small[i] = _small.stats(age);\n-    stats._medium[i] = _medium.stats(age);\n-    stats._large[i] = _large.stats(age);\n-  }\n-\n-  stats._has_relocatable_pages = total() > 0;\n-\n-  return stats;\n+  const bool has_relocatable_pages = total() > 0;\n+  return ZRelocationSetSelectorStats(&_small, &_medium, &_large, has_relocatable_pages);\n","filename":"src\/hotspot\/share\/gc\/z\/zRelocationSetSelector.cpp","additions":24,"deletions":12,"binary":false,"changes":36,"status":"modified"},{"patch":"@@ -34,0 +34,1 @@\n+class ZRelocationSetSelectorGroup;\n@@ -59,0 +60,1 @@\n+  void reset();\n@@ -69,1 +71,1 @@\n-  size_t _has_relocatable_pages;\n+  bool _has_relocatable_pages;\n@@ -72,0 +74,5 @@\n+  ZRelocationSetSelectorStats();\n+  ZRelocationSetSelectorStats(const ZRelocationSetSelectorGroup* small,\n+                              const ZRelocationSetSelectorGroup* medium,\n+                              const ZRelocationSetSelectorGroup* large,\n+                              bool has_relocatable_pages);\n@@ -75,0 +82,2 @@\n+  size_t live_bytes(ZPageAge age) const;\n+  size_t npages(ZPageAge age) const;\n@@ -77,0 +86,2 @@\n+\n+  void reset();\n","filename":"src\/hotspot\/share\/gc\/z\/zRelocationSetSelector.hpp","additions":12,"deletions":1,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -56,4 +56,0 @@\n-inline bool ZRelocationSetSelectorStats::has_relocatable_pages() const {\n-  return _has_relocatable_pages;\n-}\n-\n@@ -72,0 +68,32 @@\n+inline void ZRelocationSetSelectorGroupStats::reset() {\n+  _npages_candidates = 0;\n+  _total = 0;\n+  _live = 0;\n+  _empty = 0;\n+  _npages_selected = 0;\n+  _relocate = 0;\n+}\n+\n+inline size_t ZRelocationSetSelectorStats::live_bytes(ZPageAge age) const {\n+  return small(age).live() + medium(age).live() + large(age).live();\n+}\n+\n+inline size_t ZRelocationSetSelectorStats::npages(ZPageAge age) const {\n+  return small(age).npages_candidates() +\n+         medium(age).npages_candidates() +\n+         large(age).npages_candidates();\n+}\n+\n+inline bool ZRelocationSetSelectorStats::has_relocatable_pages() const {\n+  return _has_relocatable_pages;\n+}\n+\n+inline void ZRelocationSetSelectorStats::reset() {\n+  for (uint i = 0; i <= ZPageAgeMax; ++i) {\n+    _small[i].reset();\n+    _medium[i].reset();\n+    _large[i].reset();\n+  }\n+  _has_relocatable_pages = false;\n+}\n+\n","filename":"src\/hotspot\/share\/gc\/z\/zRelocationSetSelector.inline.hpp","additions":32,"deletions":4,"binary":false,"changes":36,"status":"modified"},{"patch":"@@ -735,1 +735,1 @@\n-  generation->stat_relocation()->print_page_summary();\n+  generation->current_stat_relocation()->print_page_summary();\n@@ -737,1 +737,1 @@\n-    generation->stat_relocation()->print_age_table();\n+    generation->current_stat_relocation()->print_age_table(generation->previous_stat_relocation());\n@@ -1466,5 +1466,5 @@\n-    _forwarding_usage(),\n-    _small_selected(),\n-    _small_in_place_count(),\n-    _medium_selected(),\n-    _medium_in_place_count() {\n+    _forwarding_usage(0),\n+    _small_selected(0),\n+    _small_in_place_count(0),\n+    _medium_selected(0),\n+    _medium_in_place_count(0) {\n@@ -1486,1 +1486,10 @@\n-void ZStatRelocation::print_page_summary() {\n+struct ZStatRelocationSummary {\n+  size_t npages_candidates;\n+  size_t total;\n+  size_t live;\n+  size_t empty;\n+  size_t npages_selected;\n+  size_t relocate;\n+};\n+\n+void ZStatRelocation::print_page_summary() const {\n@@ -1547,1 +1556,1 @@\n-void ZStatRelocation::print_age_table() {\n+void ZStatRelocation::print_age_table(const ZStatRelocation* const previous) const {\n@@ -1559,1 +1568,0 @@\n-           .center(\"Garbage\")\n@@ -1565,4 +1573,0 @@\n-  size_t live[ZPageAgeMax + 1] = {};\n-  size_t total[ZPageAgeMax + 1] = {};\n-\n-  uint oldest_none_empty_age = 0;\n@@ -1571,14 +1575,1 @@\n-    ZPageAge age = static_cast<ZPageAge>(i);\n-    auto summarize_pages = [&](const ZRelocationSetSelectorGroupStats& stats) {\n-      live[i] += stats.live();\n-      total[i] += stats.total();\n-    };\n-\n-    summarize_pages(_selector_stats.small(age));\n-    summarize_pages(_selector_stats.medium(age));\n-    summarize_pages(_selector_stats.large(age));\n-\n-    if (total[i] != 0) {\n-      oldest_none_empty_age = i;\n-    }\n-  }\n+    const ZPageAge age = static_cast<ZPageAge>(i);\n@@ -1586,2 +1577,7 @@\n-  for (uint i = 0; i <= oldest_none_empty_age; ++i) {\n-    ZPageAge age = static_cast<ZPageAge>(i);\n+    if (_selector_stats.npages(age) == 0 &&\n+        previous->_selector_stats.npages(age) == 0) {\n+      break;\n+    }\n+    if (age == ZPageAge::old) {\n+      break;\n+    }\n@@ -1589,1 +1585,1 @@\n-    FormatBuffer<> age_str(\"\");\n+    FormatBuffer<> desc(\"\");\n@@ -1591,3 +1587,3 @@\n-      age_str.append(\"Eden\");\n-    } else if (age != ZPageAge::old) {\n-      age_str.append(\"Survivor %d\", i);\n+      desc.append(\"Eden\");\n+    } else {\n+      desc.append(\"Survivor %d\", i);\n@@ -1596,23 +1592,14 @@\n-    auto create_age_table = [&]() {\n-      if (live[i] == 0) {\n-        return age_table()\n-              .left(\"%s\", age_str.buffer())\n-              .left(ZTABLE_ARGS_NA);\n-      } else {\n-        return age_table()\n-              .left(\"%s\", age_str.buffer())\n-              .left(ZTABLE_ARGS(live[i]));\n-      }\n-    };\n-\n-    lt.print(\"%s\", create_age_table()\n-              .left(ZTABLE_ARGS(total[i] - live[i]))\n-              .left(SIZE_FORMAT_W(7) \" \/ \" SIZE_FORMAT,\n-                    _selector_stats.small(age).npages_candidates(),\n-                    _selector_stats.small(age).npages_selected())\n-              .left(SIZE_FORMAT_W(7) \" \/ \" SIZE_FORMAT,\n-                    _selector_stats.medium(age).npages_candidates(),\n-                    _selector_stats.medium(age).npages_selected())\n-              .left(SIZE_FORMAT_W(7) \" \/ \" SIZE_FORMAT,\n-                    _selector_stats.large(age).npages_candidates(),\n-                    _selector_stats.large(age).npages_selected())\n+    lt.print(\"%s\", age_table()\n+              .left(\"%s\", desc.buffer())\n+              .left(SIZE_FORMAT_W(8) \"M -> \" SIZE_FORMAT \"M\",\n+                    (previous->_selector_stats.live_bytes(age) \/ M),\n+                    (_selector_stats.live_bytes(age) \/ M))\n+              .left(SIZE_FORMAT_W(7) \" -> \" SIZE_FORMAT,\n+                    previous->_selector_stats.small(age).npages_candidates(),\n+                    _selector_stats.small(age).npages_candidates())\n+              .left(SIZE_FORMAT_W(7) \" -> \" SIZE_FORMAT,\n+                    previous->_selector_stats.medium(age).npages_candidates(),\n+                    _selector_stats.medium(age).npages_candidates())\n+              .left(SIZE_FORMAT_W(7) \" -> \" SIZE_FORMAT,\n+                    previous->_selector_stats.large(age).npages_candidates(),\n+                    _selector_stats.large(age).npages_candidates())\n@@ -1623,0 +1610,9 @@\n+void ZStatRelocation::reset() {\n+  _selector_stats.reset();\n+  _forwarding_usage = 0;\n+  _small_selected = 0;\n+  _small_in_place_count = 0;\n+  _medium_selected = 0;\n+  _medium_in_place_count = 0;\n+}\n+\n","filename":"src\/hotspot\/share\/gc\/z\/zStat.cpp","additions":53,"deletions":57,"binary":false,"changes":110,"status":"modified"},{"patch":"@@ -513,9 +513,0 @@\n-struct ZStatRelocationSummary {\n-  size_t npages_candidates;\n-  size_t total;\n-  size_t live;\n-  size_t empty;\n-  size_t npages_selected;\n-  size_t relocate;\n-};\n-\n@@ -534,3 +525,1 @@\n-  void print(const char* name,\n-             ZStatRelocationSummary selector_group,\n-             size_t in_place_count);\n+  ZRelocationSetSelectorStats* const selector_stats() const;\n@@ -544,0 +533,1 @@\n+  void reset();\n@@ -545,2 +535,2 @@\n-  void print_page_summary();\n-  void print_age_table();\n+  void print_page_summary() const;\n+  void print_age_table(const ZStatRelocation* const previous) const;\n","filename":"src\/hotspot\/share\/gc\/z\/zStat.hpp","additions":4,"deletions":14,"binary":false,"changes":18,"status":"modified"}]}