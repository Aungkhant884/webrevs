{"files":[{"patch":"@@ -130,2 +130,1 @@\n-    _previous_stat_relocation(),\n-    _current_stat_relocation(),\n+    _stat_relocation(),\n@@ -263,1 +262,1 @@\n-  current_stat_relocation()->at_select_relocation_set(selector.stats());\n+  stat_relocation()->at_select_relocation_set(selector.stats());\n@@ -372,1 +371,0 @@\n-  reset_relocation_stats();\n@@ -376,0 +374,1 @@\n+  stat_relocation()->at_collection_start();\n@@ -379,5 +378,0 @@\n-void ZGeneration::reset_relocation_stats() {\n-  _previous_stat_relocation = _current_stat_relocation;\n-  _current_stat_relocation.reset();\n-}\n-\n","filename":"src\/hotspot\/share\/gc\/z\/zGeneration.cpp","additions":3,"deletions":9,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -84,2 +84,1 @@\n-  ZStatRelocation       _previous_stat_relocation;\n-  ZStatRelocation       _current_stat_relocation;\n+  ZStatRelocation       _stat_relocation;\n@@ -102,2 +101,0 @@\n-  void reset_relocation_stats();\n-\n@@ -143,2 +140,1 @@\n-  const ZStatRelocation* previous_stat_relocation() const;\n-  ZStatRelocation* current_stat_relocation();\n+  ZStatRelocation* stat_relocation();\n","filename":"src\/hotspot\/share\/gc\/z\/zGeneration.hpp","additions":2,"deletions":6,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -106,6 +106,2 @@\n-inline const ZStatRelocation* ZGeneration::previous_stat_relocation() const {\n-  return &_previous_stat_relocation;\n-}\n-\n-inline ZStatRelocation* ZGeneration::current_stat_relocation() {\n-  return &_current_stat_relocation;\n+inline ZStatRelocation* ZGeneration::stat_relocation() {\n+  return &_stat_relocation;\n","filename":"src\/hotspot\/share\/gc\/z\/zGeneration.inline.hpp","additions":2,"deletions":6,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -1074,1 +1074,1 @@\n-    _generation->current_stat_relocation()->at_relocate_end(_small_allocator.in_place_count(), _medium_allocator.in_place_count());\n+    _generation->stat_relocation()->at_relocate_end(_small_allocator.in_place_count(), _medium_allocator.in_place_count());\n","filename":"src\/hotspot\/share\/gc\/z\/zRelocate.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -162,1 +162,1 @@\n-  _generation->current_stat_relocation()->at_install_relocation_set(_allocator.size());\n+  _generation->stat_relocation()->at_install_relocation_set(_allocator.size());\n","filename":"src\/hotspot\/share\/gc\/z\/zRelocationSet.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -46,5 +46,5 @@\n-    for (uint i = 0; i <= ZPageAgeMax; ++i) {\n-      _small[i] = ZRelocationSetSelectorGroupStats();\n-      _medium[i] = ZRelocationSetSelectorGroupStats();\n-      _large[i] = ZRelocationSetSelectorGroupStats();\n-    }\n+  for (uint i = 0; i <= ZPageAgeMax; ++i) {\n+    _small[i] = ZRelocationSetSelectorGroupStats();\n+    _medium[i] = ZRelocationSetSelectorGroupStats();\n+    _large[i] = ZRelocationSetSelectorGroupStats();\n+  }\n@@ -58,6 +58,6 @@\n-    for (uint i = 0; i <= ZPageAgeMax; ++i) {\n-      const ZPageAge age = static_cast<ZPageAge>(i);\n-      _small[i] = small->stats(age);\n-      _medium[i] = medium->stats(age);\n-      _large[i] = large->stats(age);\n-    }\n+  for (uint i = 0; i <= ZPageAgeMax; ++i) {\n+    const ZPageAge age = static_cast<ZPageAge>(i);\n+    _small[i] = small->stats(age);\n+    _medium[i] = medium->stats(age);\n+    _large[i] = large->stats(age);\n+  }\n","filename":"src\/hotspot\/share\/gc\/z\/zRelocationSetSelector.cpp","additions":11,"deletions":11,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -60,1 +60,0 @@\n-  void reset();\n@@ -79,0 +78,1 @@\n+\n@@ -82,0 +82,1 @@\n+\n@@ -86,2 +87,0 @@\n-\n-  void reset();\n","filename":"src\/hotspot\/share\/gc\/z\/zRelocationSetSelector.hpp","additions":2,"deletions":3,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -68,9 +68,0 @@\n-inline void ZRelocationSetSelectorGroupStats::reset() {\n-  _npages_candidates = 0;\n-  _total = 0;\n-  _live = 0;\n-  _empty = 0;\n-  _npages_selected = 0;\n-  _relocate = 0;\n-}\n-\n@@ -91,9 +82,0 @@\n-inline void ZRelocationSetSelectorStats::reset() {\n-  for (uint i = 0; i <= ZPageAgeMax; ++i) {\n-    _small[i].reset();\n-    _medium[i].reset();\n-    _large[i].reset();\n-  }\n-  _has_relocatable_pages = false;\n-}\n-\n","filename":"src\/hotspot\/share\/gc\/z\/zRelocationSetSelector.inline.hpp","additions":0,"deletions":18,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -735,1 +735,1 @@\n-  generation->current_stat_relocation()->print_page_summary();\n+  generation->stat_relocation()->print_page_summary();\n@@ -737,1 +737,1 @@\n-    generation->current_stat_relocation()->print_age_table(generation->previous_stat_relocation());\n+    generation->stat_relocation()->print_age_table();\n@@ -1466,5 +1466,10 @@\n-    _forwarding_usage(0),\n-    _small_selected(0),\n-    _small_in_place_count(0),\n-    _medium_selected(0),\n-    _medium_in_place_count(0) {\n+    _forwarding_usage(),\n+    _small_selected(),\n+    _small_in_place_count(),\n+    _medium_selected(),\n+    _medium_in_place_count() {\n+}\n+\n+void ZStatRelocation::at_collection_start() {\n+  _previous_selector_stats = _selector_stats;\n+  _selector_stats = {};\n@@ -1486,9 +1491,0 @@\n-struct ZStatRelocationSummary {\n-  size_t npages_candidates;\n-  size_t total;\n-  size_t live;\n-  size_t empty;\n-  size_t npages_selected;\n-  size_t relocate;\n-};\n-\n@@ -1503,0 +1499,9 @@\n+  struct ZStatRelocationSummary {\n+    size_t npages_candidates;\n+    size_t total;\n+    size_t live;\n+    size_t empty;\n+    size_t npages_selected;\n+    size_t relocate;\n+  };\n+\n@@ -1556,1 +1561,1 @@\n-void ZStatRelocation::print_age_table(const ZStatRelocation* const previous) const {\n+void ZStatRelocation::print_age_table() const {\n@@ -1558,0 +1563,1 @@\n+\n@@ -1563,0 +1569,16 @@\n+  \/\/ Find range of pages to print\n+  const uint end = [&]() {\n+    for (uint i = 0; i <= ZPageAgeMax; ++i) {\n+      const ZPageAge age = static_cast<ZPageAge>(i);\n+      if (age == ZPageAge::old) {\n+        return i;\n+      }\n+\n+      if (_selector_stats.npages(age) == 0 && _previous_selector_stats.npages(age) == 0) {\n+        return i;\n+      }\n+    }\n+\n+    return ZPageAgeMax;\n+  }();\n+\n@@ -1573,0 +1595,9 @@\n+  auto unit = [](size_t bytes) {\n+    if (bytes < K) {\n+      return \"B\";\n+    }\n+    if (bytes < M) {\n+      return \"K\";\n+    }\n+    return \"M\";\n+  };\n@@ -1574,6 +1605,3 @@\n-  for (uint i = 0; i <= ZPageAgeMax; ++i) {\n-    const ZPageAge age = static_cast<ZPageAge>(i);\n-\n-    if (_selector_stats.npages(age) == 0 &&\n-        previous->_selector_stats.npages(age) == 0) {\n-      break;\n+  auto value = [](size_t bytes) {\n+    if (bytes < K) {\n+      return bytes;\n@@ -1581,2 +1609,2 @@\n-    if (age == ZPageAge::old) {\n-      break;\n+    if (bytes < M) {\n+      return bytes \/ K;\n@@ -1584,0 +1612,5 @@\n+    return bytes \/ M;\n+  };\n+\n+  for (uint i = 0; i < end; ++i) {\n+    const ZPageAge age = static_cast<ZPageAge>(i);\n@@ -1592,0 +1625,3 @@\n+    const size_t prev_live_bytes = _previous_selector_stats.live_bytes(age);\n+    const size_t live_bytes = _selector_stats.live_bytes(age);\n+\n@@ -1593,14 +1629,16 @@\n-              .left(\"%s\", desc.buffer())\n-              .left(SIZE_FORMAT_W(8) \"M -> \" SIZE_FORMAT \"M\",\n-                    (previous->_selector_stats.live_bytes(age) \/ M),\n-                    (_selector_stats.live_bytes(age) \/ M))\n-              .left(SIZE_FORMAT_W(7) \" -> \" SIZE_FORMAT,\n-                    previous->_selector_stats.small(age).npages_candidates(),\n-                    _selector_stats.small(age).npages_candidates())\n-              .left(SIZE_FORMAT_W(7) \" -> \" SIZE_FORMAT,\n-                    previous->_selector_stats.medium(age).npages_candidates(),\n-                    _selector_stats.medium(age).npages_candidates())\n-              .left(SIZE_FORMAT_W(7) \" -> \" SIZE_FORMAT,\n-                    previous->_selector_stats.large(age).npages_candidates(),\n-                    _selector_stats.large(age).npages_candidates())\n-              .end());\n+             .left(\"%s\", desc.buffer())\n+             .left(SIZE_FORMAT_W(8) \"%s\" \" -> \" SIZE_FORMAT \"%s\",\n+                   value(prev_live_bytes),\n+                   unit(prev_live_bytes),\n+                   value(live_bytes),\n+                   unit(live_bytes))\n+             .left(SIZE_FORMAT_W(7) \" -> \" SIZE_FORMAT,\n+                   _previous_selector_stats.small(age).npages_candidates(),\n+                   _selector_stats.small(age).npages_candidates())\n+             .left(SIZE_FORMAT_W(7) \" -> \" SIZE_FORMAT,\n+                   _previous_selector_stats.medium(age).npages_candidates(),\n+                   _selector_stats.medium(age).npages_candidates())\n+             .left(SIZE_FORMAT_W(7) \" -> \" SIZE_FORMAT,\n+                   _previous_selector_stats.large(age).npages_candidates(),\n+                   _selector_stats.large(age).npages_candidates())\n+             .end());\n@@ -1610,9 +1648,0 @@\n-void ZStatRelocation::reset() {\n-  _selector_stats.reset();\n-  _forwarding_usage = 0;\n-  _small_selected = 0;\n-  _small_in_place_count = 0;\n-  _medium_selected = 0;\n-  _medium_in_place_count = 0;\n-}\n-\n","filename":"src\/hotspot\/share\/gc\/z\/zStat.cpp","additions":77,"deletions":48,"binary":false,"changes":125,"status":"modified"},{"patch":"@@ -519,0 +519,1 @@\n+  ZRelocationSetSelectorStats _previous_selector_stats;\n@@ -525,2 +526,0 @@\n-  ZRelocationSetSelectorStats* const selector_stats() const;\n-\n@@ -530,0 +529,1 @@\n+  void at_collection_start();\n@@ -533,1 +533,0 @@\n-  void reset();\n@@ -536,1 +535,1 @@\n-  void print_age_table(const ZStatRelocation* const previous) const;\n+  void print_age_table() const;\n","filename":"src\/hotspot\/share\/gc\/z\/zStat.hpp","additions":3,"deletions":4,"binary":false,"changes":7,"status":"modified"}]}