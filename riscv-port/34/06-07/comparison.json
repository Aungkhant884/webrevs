{"files":[{"patch":"@@ -1837,4 +1837,0 @@\n-#define CHECK_COND(...)                    if (__VA_ARGS__) {\n-#define CHECK_RVC()                        CHECK_COND(UseRVC && in_compressible_region())\n-#define CHECK_RETURN                       return; }\n-\n@@ -1847,1 +1843,1 @@\n-    CHECK_RVC()                                                                                \\\n+    if (check_rvc()) {                                                                         \\\n@@ -1849,1 +1845,1 @@\n-      CHECK_COND(Rs1 != x0 && Rs2 != x0 && ((src = Rs1, Rs2 == Rd) || (src = Rs2, Rs1 == Rd))) \\\n+      if (Rs1 != x0 && Rs2 != x0 && ((src = Rs1, Rs2 == Rd) || (src = Rs2, Rs1 == Rd))) {      \\\n@@ -1851,1 +1847,2 @@\n-      CHECK_RETURN                                                                             \\\n+        return;                                                                                \\\n+      }                                                                                        \\\n@@ -1853,1 +1850,1 @@\n-    _##NAME(Rd, Rs1, Rs2);                                                                     \\\n+    _add(Rd, Rs1, Rs2);                                                                        \\\n@@ -1862,1 +1859,1 @@\n-#define INSN(NAME, C_NAME)                                                                   \\\n+#define INSN(NAME, C_NAME, NORMAL_NAME)                                                      \\\n@@ -1864,4 +1861,4 @@\n-    CHECK_RVC()                                                                              \\\n-      CHECK_COND(Rd == Rs1 && Rd->is_compressed_valid() && Rs2->is_compressed_valid())       \\\n-        C_NAME(Rd, Rs2);                                                                     \\\n-      CHECK_RETURN                                                                           \\\n+    if (check_rvc() &&                                                                       \\\n+        (Rd == Rs1 && Rd->is_compressed_valid() && Rs2->is_compressed_valid())) {            \\\n+      C_NAME(Rd, Rs2);                                                                       \\\n+      return;                                                                                \\\n@@ -1869,1 +1866,1 @@\n-    _##NAME(Rd, Rs1, Rs2);                                                                   \\\n+    NORMAL_NAME(Rd, Rs1, Rs2);                                                               \\\n@@ -1872,2 +1869,2 @@\n-  INSN(sub,  c_sub);\n-  INSN(subw, c_subw);\n+  INSN(sub,  c_sub,  _sub);\n+  INSN(subw, c_subw, _subw);\n@@ -1879,1 +1876,1 @@\n-#define INSN(NAME, C_NAME)                                                                   \\\n+#define INSN(NAME, C_NAME, NORMAL_NAME)                                                      \\\n@@ -1881,1 +1878,1 @@\n-    CHECK_RVC()                                                                              \\\n+    if (check_rvc()) {                                                                       \\\n@@ -1883,2 +1880,2 @@\n-      CHECK_COND(Rs1->is_compressed_valid() && Rs2->is_compressed_valid() &&                 \\\n-        ((src = Rs1, Rs2 == Rd) || (src = Rs2, Rs1 == Rd)))                                  \\\n+      if (Rs1->is_compressed_valid() && Rs2->is_compressed_valid() &&                        \\\n+        ((src = Rs1, Rs2 == Rd) || (src = Rs2, Rs1 == Rd))) {                                \\\n@@ -1886,1 +1883,2 @@\n-      CHECK_RETURN                                                                           \\\n+        return;                                                                              \\\n+      }                                                                                      \\\n@@ -1888,1 +1886,1 @@\n-    _##NAME(Rd, Rs1, Rs2);                                                                   \\\n+    NORMAL_NAME(Rd, Rs1, Rs2);                                                               \\\n@@ -1891,4 +1889,4 @@\n-  INSN(andr, c_and);\n-  INSN(orr,  c_or);\n-  INSN(xorr, c_xor);\n-  INSN(addw, c_addw);\n+  INSN(andr, c_and,  _andr);\n+  INSN(orr,  c_or,   _orr);\n+  INSN(xorr, c_xor,  _xorr);\n+  INSN(addw, c_addw, _addw);\n@@ -1900,0 +1898,4 @@\n+  bool check_rvc() const {\n+    return UseRVC && in_compressible_region();\n+  }\n+\n@@ -1945,2 +1947,2 @@\n-    CHECK_RVC()                                                                              \\\n-      CHECK_COND(is_c_lwswsp(Rs, Rd, offset, true))                                          \\\n+    if (check_rvc()) {                                                                       \\\n+      if (is_c_lwswsp(Rs, Rd, offset, true)) {                                               \\\n@@ -1948,2 +1950,2 @@\n-      CHECK_RETURN                                                                           \\\n-      else CHECK_COND(is_c_lwsw(Rs, Rd, offset))                                             \\\n+        return;                                                                              \\\n+      } else if (is_c_lwsw(Rs, Rd, offset)) {                                                \\\n@@ -1951,1 +1953,2 @@\n-      CHECK_RETURN                                                                           \\\n+        return;                                                                              \\\n+      }                                                                                      \\\n@@ -1953,1 +1956,1 @@\n-    _##NAME(Rd, Rs, offset);                                                                 \\\n+    _lw(Rd, Rs, offset);                                                                     \\\n@@ -1964,2 +1967,2 @@\n-    CHECK_RVC()                                                                              \\\n-      CHECK_COND(is_c_ldsdsp(Rs, Rd, offset, true))                                          \\\n+    if (check_rvc()) {                                                                       \\\n+      if (is_c_ldsdsp(Rs, Rd, offset, true)) {                                               \\\n@@ -1967,2 +1970,2 @@\n-      CHECK_RETURN                                                                           \\\n-      else CHECK_COND(is_c_ldsd(Rs, Rd, offset))                                             \\\n+        return;                                                                              \\\n+      } else if (is_c_ldsd(Rs, Rd, offset)) {                                                \\\n@@ -1970,1 +1973,2 @@\n-      CHECK_RETURN                                                                           \\\n+        return;                                                                              \\\n+      }                                                                                      \\\n@@ -1972,1 +1976,1 @@\n-    _##NAME(Rd, Rs, offset);                                                                 \\\n+    _ld(Rd, Rs, offset);                                                                     \\\n@@ -1983,2 +1987,2 @@\n-    CHECK_RVC()                                                                              \\\n-      CHECK_COND(is_c_fldsdsp(Rs, offset))                                                   \\\n+    if (check_rvc()) {                                                                       \\\n+      if (is_c_fldsdsp(Rs, offset)) {                                                        \\\n@@ -1986,2 +1990,2 @@\n-      CHECK_RETURN                                                                           \\\n-      else CHECK_COND(is_c_fldsd(Rs, Rd, offset))                                            \\\n+        return;                                                                              \\\n+      } else if (is_c_fldsd(Rs, Rd, offset)) {                                               \\\n@@ -1989,1 +1993,2 @@\n-      CHECK_RETURN                                                                           \\\n+        return;                                                                              \\\n+      }                                                                                      \\\n@@ -1991,1 +1996,1 @@\n-    _##NAME(Rd, Rs, offset);                                                                 \\\n+    _fld(Rd, Rs, offset);                                                                    \\\n@@ -2002,2 +2007,2 @@\n-    CHECK_RVC()                                                                              \\\n-      CHECK_COND(is_c_ldsdsp(Rs, Rd, offset, false))                                         \\\n+    if (check_rvc()) {                                                                       \\\n+      if (is_c_ldsdsp(Rs, Rd, offset, false)) {                                              \\\n@@ -2005,2 +2010,2 @@\n-      CHECK_RETURN                                                                           \\\n-      else CHECK_COND(is_c_ldsd(Rs, Rd, offset))                                             \\\n+        return;                                                                              \\\n+      } else if (is_c_ldsd(Rs, Rd, offset)) {                                                \\\n@@ -2008,1 +2013,2 @@\n-      CHECK_RETURN                                                                           \\\n+        return;                                                                              \\\n+      }                                                                                      \\\n@@ -2010,1 +2016,1 @@\n-    _##NAME(Rd, Rs, offset);                                                                 \\\n+    _sd(Rd, Rs, offset);                                                                     \\\n@@ -2021,2 +2027,2 @@\n-    CHECK_RVC()                                                                              \\\n-      CHECK_COND(is_c_lwswsp(Rs, Rd, offset, false))                                         \\\n+    if (check_rvc()) {                                                                       \\\n+      if (is_c_lwswsp(Rs, Rd, offset, false)) {                                              \\\n@@ -2024,2 +2030,2 @@\n-      CHECK_RETURN                                                                           \\\n-      else CHECK_COND(is_c_lwsw(Rs, Rd, offset))                                             \\\n+        return;                                                                              \\\n+      } else if (is_c_lwsw(Rs, Rd, offset)) {                                                \\\n@@ -2027,1 +2033,2 @@\n-      CHECK_RETURN                                                                           \\\n+        return;                                                                              \\\n+      }                                                                                      \\\n@@ -2029,1 +2036,1 @@\n-    _##NAME(Rd, Rs, offset);                                                                 \\\n+    _sw(Rd, Rs, offset);                                                                     \\\n@@ -2040,2 +2047,2 @@\n-    CHECK_RVC()                                                                              \\\n-      CHECK_COND(is_c_fldsdsp(Rs, offset))                                                   \\\n+    if (check_rvc()) {                                                                       \\\n+      if (is_c_fldsdsp(Rs, offset)) {                                                        \\\n@@ -2043,2 +2050,2 @@\n-      CHECK_RETURN                                                                           \\\n-      else CHECK_COND(is_c_fldsd(Rs, Rd, offset))                                            \\\n+        return;                                                                              \\\n+      } else if (is_c_fldsd(Rs, Rd, offset)) {                                               \\\n@@ -2046,1 +2053,2 @@\n-      CHECK_RETURN                                                                           \\\n+        return;                                                                              \\\n+      }                                                                                      \\\n@@ -2048,1 +2056,1 @@\n-    _##NAME(Rd, Rs, offset);                                                                 \\\n+    _fsd(Rd, Rs, offset);                                                                    \\\n@@ -2060,1 +2068,1 @@\n-#define INSN(NAME, C_NAME)                                                                   \\\n+#define INSN(NAME, C_NAME, NORMAL_NAME)                                                      \\\n@@ -2062,5 +2070,5 @@\n-    CHECK_RVC()                                                                              \\\n-      CHECK_COND(offset != 0 && Rs2 == x0 && Rs1->is_compressed_valid() &&                   \\\n-        is_imm_in_range(offset, 8, 1))                                                       \\\n-        C_NAME(Rs1, offset);                                                                 \\\n-      CHECK_RETURN                                                                           \\\n+    if (check_rvc() &&                                                                       \\\n+        (offset != 0 && Rs2 == x0 && Rs1->is_compressed_valid() &&                           \\\n+        is_imm_in_range(offset, 8, 1))) {                                                    \\\n+      C_NAME(Rs1, offset);                                                                   \\\n+      return;                                                                                \\\n@@ -2068,1 +2076,1 @@\n-    _##NAME(Rs1, Rs2, offset);                                                               \\\n+    NORMAL_NAME(Rs1, Rs2, offset);                                                           \\\n@@ -2071,2 +2079,2 @@\n-  INSN(beq, c_beqz);\n-  INSN(bne, c_beqz);\n+  INSN(beq, c_beqz, _beq);\n+  INSN(bne, c_beqz, _bne);\n@@ -2082,4 +2090,3 @@\n-    CHECK_RVC()                                                                              \\\n-      CHECK_COND(offset != 0 && Rd == x0 && is_imm_in_range(offset, 11, 1))                  \\\n-        c_j(offset);                                                                         \\\n-      CHECK_RETURN                                                                           \\\n+    if (check_rvc() && offset != 0 && Rd == x0 && is_imm_in_range(offset, 11, 1)) {          \\\n+      c_j(offset);                                                                           \\\n+      return;                                                                                \\\n@@ -2087,1 +2094,1 @@\n-    _##NAME(Rd, offset);                                                                     \\\n+    _jal(Rd, offset);                                                                        \\\n@@ -2098,8 +2105,7 @@\n-    CHECK_RVC()                                                                              \\\n-      CHECK_COND(offset == 0 && Rs != x0)                                                    \\\n-        CHECK_COND(Rd == x1)                                                                 \\\n-          c_jalr(Rs);                                                                        \\\n-        CHECK_RETURN                                                                         \\\n-        else CHECK_COND(Rd == x0)                                                            \\\n-          c_jr(Rs);                                                                          \\\n-        CHECK_RETURN                                                                         \\\n+    if (check_rvc() && (offset == 0 && Rs != x0)) {                                          \\\n+      if (Rd == x1) {                                                                        \\\n+        c_jalr(Rs);                                                                          \\\n+        return;                                                                              \\\n+      } else if (Rd == x0) {                                                                 \\\n+        c_jr(Rs);                                                                            \\\n+        return;                                                                              \\\n@@ -2108,1 +2114,1 @@\n-    _##NAME(Rd, Rs, offset);                                                                 \\\n+    _jalr(Rd, Rs, offset);                                                                   \\\n@@ -2121,1 +2127,1 @@\n-    CHECK_RVC()                                                        \\\n+    if (check_rvc()) {                                                 \\\n@@ -2123,2 +2129,3 @@\n-    CHECK_RETURN                                                       \\\n-    _##NAME();                                                         \\\n+      return;                                                          \\\n+    }                                                                  \\\n+    _ebreak();                                                         \\\n@@ -2137,4 +2144,3 @@\n-    CHECK_RVC()                                                                              \\\n-      CHECK_COND(is_imm_in_range(imm, 6, 0) && Rd != x0)                                     \\\n-        c_li(Rd, imm);                                                                       \\\n-      CHECK_RETURN                                                                           \\\n+    if (check_rvc() && (is_imm_in_range(imm, 6, 0) && Rd != x0)) {                           \\\n+      c_li(Rd, imm);                                                                         \\\n+      return;                                                                                \\\n@@ -2142,1 +2148,1 @@\n-    _##NAME(Rd, imm);                                                                        \\\n+    _li(Rd, imm);                                                                            \\\n@@ -2152,2 +2158,2 @@\n-    CHECK_RVC()                                                                              \\\n-      CHECK_COND(Rd == Rs1 && is_imm_in_range(imm, 6, 0))                                    \\\n+    if (check_rvc()) {                                                                       \\\n+      if (Rd == Rs1 && is_imm_in_range(imm, 6, 0)) {                                         \\\n@@ -2155,2 +2161,2 @@\n-      CHECK_RETURN                                                                           \\\n-      else CHECK_COND(imm == 0 && Rd != x0 && Rs1 != x0)                                     \\\n+        return;                                                                              \\\n+      } else if (imm == 0 && Rd != x0 && Rs1 != x0) {                                        \\\n@@ -2158,3 +2164,3 @@\n-      CHECK_RETURN                                                                           \\\n-      else CHECK_COND(Rs1 == sp && imm != 0)                                                 \\\n-        CHECK_COND(Rd == Rs1 && (imm & 0b1111) == 0x0 && is_imm_in_range(imm, 10, 0))        \\\n+        return;                                                                              \\\n+      } else if (Rs1 == sp && imm != 0) {                                                    \\\n+        if (Rd == Rs1 && (imm & 0b1111) == 0x0 && is_imm_in_range(imm, 10, 0)) {             \\\n@@ -2162,2 +2168,2 @@\n-        CHECK_RETURN                                                                         \\\n-        else CHECK_COND(Rd->is_compressed_valid() && (imm & 0b11) == 0x0 && is_unsigned_imm_in_range(imm, 10, 0))                                      \\\n+          return;                                                                            \\\n+        } else if (Rd->is_compressed_valid() && (imm & 0b11) == 0x0 && is_unsigned_imm_in_range(imm, 10, 0)) { \\\n@@ -2165,1 +2171,2 @@\n-        CHECK_RETURN                                                                         \\\n+          return;                                                                            \\\n+        }                                                                                    \\\n@@ -2168,1 +2175,1 @@\n-    _##NAME(Rd, Rs1, imm);                                                                   \\\n+    _addi(Rd, Rs1, imm);                                                                     \\\n@@ -2179,4 +2186,3 @@\n-    CHECK_RVC()                                                                              \\\n-      CHECK_COND(Rd == Rs1 && Rd != x0 && is_imm_in_range(imm, 6, 0))                        \\\n-        c_addiw(Rd, imm);                                                                    \\\n-      CHECK_RETURN                                                                           \\\n+    if (check_rvc() && (Rd == Rs1 && Rd != x0 && is_imm_in_range(imm, 6, 0))) {              \\\n+      c_addiw(Rd, imm);                                                                      \\\n+      return;                                                                                \\\n@@ -2184,1 +2190,1 @@\n-    _##NAME(Rd, Rs1, imm);                                                                   \\\n+    _addiw(Rd, Rs1, imm);                                                                    \\\n@@ -2195,4 +2201,4 @@\n-    CHECK_RVC()                                                                              \\\n-      CHECK_COND(Rd == Rs1 && Rd->is_compressed_valid() && is_imm_in_range(imm, 6, 0))       \\\n-        c_andi(Rd, imm);                                                                     \\\n-      CHECK_RETURN                                                                           \\\n+    if (check_rvc() &&                                                                       \\\n+        (Rd == Rs1 && Rd->is_compressed_valid() && is_imm_in_range(imm, 6, 0))) {            \\\n+      c_andi(Rd, imm);                                                                       \\\n+      return;                                                                                \\\n@@ -2200,1 +2206,1 @@\n-    _##NAME(Rd, Rs1, imm);                                                                   \\\n+    _and_imm12(Rd, Rs1, imm);                                                                \\\n@@ -2213,4 +2219,3 @@\n-    CHECK_RVC()                                                                              \\\n-      CHECK_COND(Rd == Rs1 && Rd != x0 && shamt != 0)                                        \\\n-        c_slli(Rd, shamt);                                                                   \\\n-      CHECK_RETURN                                                                           \\\n+    if (check_rvc() && (Rd == Rs1 && Rd != x0 && shamt != 0)) {                              \\\n+      c_slli(Rd, shamt);                                                                     \\\n+      return;                                                                                \\\n@@ -2218,1 +2223,1 @@\n-    _##NAME(Rd, Rs1, shamt);                                                                 \\\n+    _slli(Rd, Rs1, shamt);                                                                   \\\n@@ -2227,1 +2232,1 @@\n-#define INSN(NAME, C_NAME)                                                                   \\\n+#define INSN(NAME, C_NAME, NORMAL_NAME)                                                      \\\n@@ -2229,4 +2234,3 @@\n-    CHECK_RVC()                                                                              \\\n-      CHECK_COND(Rd == Rs1 && Rd->is_compressed_valid() && shamt != 0)                       \\\n-        C_NAME(Rd, shamt);                                                                   \\\n-      CHECK_RETURN                                                                           \\\n+    if (check_rvc() && (Rd == Rs1 && Rd->is_compressed_valid() && shamt != 0)) {             \\\n+      C_NAME(Rd, shamt);                                                                     \\\n+      return;                                                                                \\\n@@ -2234,1 +2238,1 @@\n-    _##NAME(Rd, Rs1, shamt);                                                                 \\\n+    NORMAL_NAME(Rd, Rs1, shamt);                                                             \\\n@@ -2237,2 +2241,2 @@\n-  INSN(srai, c_srai);\n-  INSN(srli, c_srli);\n+  INSN(srai, c_srai, _srai);\n+  INSN(srli, c_srli, _srli);\n@@ -2248,4 +2252,3 @@\n-    CHECK_RVC()                                                                              \\\n-      CHECK_COND(Rd != x0 && Rd != x2 && imm != 0 && is_imm_in_range(imm, 18, 0))            \\\n-        c_lui(Rd, imm);                                                                      \\\n-      CHECK_RETURN                                                                           \\\n+    if (check_rvc() && (Rd != x0 && Rd != x2 && imm != 0 && is_imm_in_range(imm, 18, 0))) {  \\\n+      c_lui(Rd, imm);                                                                        \\\n+      return;                                                                                \\\n@@ -2253,1 +2256,1 @@\n-    _##NAME(Rd, imm);                                                                        \\\n+    _lui(Rd, imm);                                                                           \\\n@@ -2262,1 +2265,1 @@\n-    CHECK_RVC()                                                         \\\n+    if (check_rvc()) {                                                  \\\n@@ -2264,2 +2267,3 @@\n-    CHECK_RETURN                                                        \\\n-    _##NAME();                                                          \\\n+      return;                                                           \\\n+    }                                                                   \\\n+    _halt();                                                            \\\n@@ -2272,4 +2276,0 @@\n-#undef CHECK_RETURN\n-#undef CHECK_RVC\n-#undef CHECK_COND\n-\n","filename":"src\/hotspot\/cpu\/riscv\/assembler_riscv.hpp","additions":139,"deletions":139,"binary":false,"changes":278,"status":"modified"}]}