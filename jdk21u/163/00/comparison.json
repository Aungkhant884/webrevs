{"files":[{"patch":"@@ -62,1 +62,0 @@\n-  SHENANDOAH_CHECK_FLAG_SET(ShenandoahNMethodBarrier);\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/mode\/shenandoahIUMode.cpp","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -52,1 +52,0 @@\n-  SHENANDOAH_ERGO_DISABLE_FLAG(ShenandoahNMethodBarrier);\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/mode\/shenandoahPassiveMode.cpp","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -50,1 +50,0 @@\n-  SHENANDOAH_CHECK_FLAG_SET(ShenandoahNMethodBarrier);\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/mode\/shenandoahSATBMode.cpp","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -48,1 +48,1 @@\n-             ShenandoahNMethodBarrier ? new ShenandoahBarrierSetNMethod(heap) : nullptr,\n+             new ShenandoahBarrierSetNMethod(heap),\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahBarrierSet.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -107,0 +107,14 @@\n+bool ShenandoahCodeRoots::use_nmethod_barriers_for_mark() {\n+  \/\/ Continuations need nmethod barriers for scanning stack chunk nmethods.\n+  if (Continuations::enabled()) return true;\n+\n+  \/\/ Concurrent class unloading needs nmethod barriers.\n+  \/\/ When a nmethod is about to be executed, we need to make sure that all its\n+  \/\/ metadata are marked. The alternative is to remark thread roots at final mark\n+  \/\/ pause, which would cause latency issues.\n+  if (ShenandoahHeap::heap()->unload_classes()) return true;\n+\n+  \/\/ Otherwise, we can go without nmethod barriers.\n+  return false;\n+}\n+\n@@ -121,2 +135,7 @@\n-void ShenandoahCodeRoots::arm_nmethods() {\n-  assert(BarrierSet::barrier_set()->barrier_set_nmethod() != nullptr, \"Sanity\");\n+void ShenandoahCodeRoots::arm_nmethods_for_mark() {\n+  if (use_nmethod_barriers_for_mark()) {\n+    BarrierSet::barrier_set()->barrier_set_nmethod()->arm_all_nmethods();\n+  }\n+}\n+\n+void ShenandoahCodeRoots::arm_nmethods_for_evac() {\n@@ -166,1 +185,1 @@\n-  if (ShenandoahNMethodBarrier) {\n+  if (use_nmethod_barriers_for_mark()) {\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahCodeRoots.cpp","additions":22,"deletions":3,"binary":false,"changes":25,"status":"modified"},{"patch":"@@ -100,1 +100,2 @@\n-  static void arm_nmethods();\n+  static void arm_nmethods_for_mark();\n+  static void arm_nmethods_for_evac();\n@@ -105,0 +106,2 @@\n+  static bool use_nmethod_barriers_for_mark();\n+\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahCodeRoots.hpp","additions":4,"deletions":1,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -548,6 +548,3 @@\n-  \/\/ Arm nmethods for concurrent marking. When a nmethod is about to be executed,\n-  \/\/ we need to make sure that all its metadata are marked. alternative is to remark\n-  \/\/ thread roots at final mark pause, but it can be potential latency killer.\n-  if (heap->unload_classes()) {\n-    ShenandoahCodeRoots::arm_nmethods();\n-  }\n+\n+  \/\/ Arm nmethods for concurrent mark\n+  ShenandoahCodeRoots::arm_nmethods_for_mark();\n@@ -606,1 +603,1 @@\n-      ShenandoahCodeRoots::arm_nmethods();\n+      ShenandoahCodeRoots::arm_nmethods_for_evac();\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahConcurrentGC.cpp","additions":4,"deletions":7,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -184,5 +184,3 @@\n-      if (ClassUnloading) {\n-         \/\/ Disarm nmethods that armed in concurrent cycle.\n-         \/\/ In above case, update roots should disarm them\n-         ShenandoahCodeRoots::disarm_nmethods();\n-      }\n+      \/\/ Disarm nmethods that armed in concurrent cycle.\n+      \/\/ In above case, update roots should disarm them\n+      ShenandoahCodeRoots::disarm_nmethods();\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahDegeneratedGC.cpp","additions":3,"deletions":5,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -83,3 +83,1 @@\n-  assert(bs != nullptr || !ShenandoahNMethodBarrier,\n-        \"Must have nmethod barrier for concurrent GC\");\n-  if (bs != nullptr && bs->is_armed(nm)) {\n+  if (bs->is_armed(nm)) {\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahNMethod.inline.hpp","additions":1,"deletions":3,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -209,1 +209,1 @@\n-  CodeBlobToOopClosure* adjust_code_closure = (ClassUnloading && ShenandoahNMethodBarrier) ?\n+  CodeBlobToOopClosure* adjust_code_closure = ShenandoahCodeRoots::use_nmethod_barriers_for_mark() ?\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahRootProcessor.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -175,1 +175,1 @@\n-  CodeBlobToOopClosure* codes_cl = (ClassUnloading && ShenandoahNMethodBarrier) ?\n+  CodeBlobToOopClosure* codes_cl = ShenandoahCodeRoots::use_nmethod_barriers_for_mark() ?\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahRootProcessor.inline.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -92,1 +92,0 @@\n-  \/\/ Weak reference processing\n@@ -94,0 +93,6 @@\n+\n+  \/\/ Arm all nmethods. Even though this is STW mark, some marking code\n+  \/\/ piggybacks on nmethod barriers for special instances.\n+  ShenandoahCodeRoots::arm_nmethods_for_mark();\n+\n+  \/\/ Weak reference processing\n@@ -123,0 +128,3 @@\n+  \/\/ Mark is finished, can disarm the nmethods now.\n+  ShenandoahCodeRoots::disarm_nmethods();\n+\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahSTWMark.cpp","additions":9,"deletions":1,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -355,3 +355,0 @@\n-  product(bool, ShenandoahNMethodBarrier, true, DIAGNOSTIC,                 \\\n-          \"Turn on\/off NMethod entry barriers in Shenandoah\")               \\\n-                                                                            \\\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoah_globals.hpp","additions":0,"deletions":3,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -57,1 +57,0 @@\n-                new String[] { \"ShenandoahNMethodBarrier\" },\n","filename":"test\/hotspot\/jtreg\/gc\/shenandoah\/options\/TestSelectiveBarrierFlags.java","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -45,1 +45,0 @@\n-                \"ShenandoahNMethodBarrier\",\n@@ -53,1 +52,0 @@\n-                \"ShenandoahNMethodBarrier\",\n","filename":"test\/hotspot\/jtreg\/gc\/shenandoah\/options\/TestWrongBarrierDisable.java","additions":0,"deletions":2,"binary":false,"changes":2,"status":"modified"}]}