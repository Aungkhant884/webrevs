{"files":[{"patch":"@@ -50,1 +50,2 @@\n-    private int minStride, maxStride;\n+    private int stride;\n+    private int epoch;\n@@ -88,2 +89,1 @@\n-        OptionSpec<Integer> minStride = parser.accepts(\"minStride\", \"Minimum internal stride size. Larger value decreases \" +\n-                \"the synchronization overhead, but also reduces accuracy.\")\n+        OptionSpec<Integer> epoch = parser.accepts(\"epoch\", \"Internal epoch size. Larger value increases cache footprint.\")\n@@ -92,1 +92,1 @@\n-        OptionSpec<Integer> maxStride = parser.accepts(\"maxStride\", \"Maximum internal stride size. Larger value decreases \" +\n+        OptionSpec<Integer> stride = parser.accepts(\"stride\", \"Internal stride size. Larger value decreases \" +\n@@ -198,2 +198,2 @@\n-        this.minStride = 10;\n-        this.maxStride = 10000;\n+        this.stride = 256;\n+        this.epoch = 10240;\n@@ -206,2 +206,2 @@\n-            this.minStride = 1;\n-            this.maxStride = 1;\n+            this.stride = 1;\n+            this.epoch = 1;\n@@ -233,2 +233,2 @@\n-        this.minStride = orDefault(set.valueOf(minStride), this.minStride);\n-        this.maxStride = orDefault(set.valueOf(maxStride), this.maxStride);\n+        this.stride = orDefault(set.valueOf(stride), this.stride);\n+        this.epoch = orDefault(set.valueOf(epoch), this.epoch);\n@@ -273,7 +273,12 @@\n-        out.printf(\"  Hardware CPUs in use: %d, %s%n\", getCPUCount(), getSpinStyle());\n-        out.printf(\"  Test preset mode: \\\"%s\\\"%n\", mode);\n-        out.printf(\"  Writing the test results to \\\"%s\\\"%n\", resultFile);\n-        out.printf(\"  Parsing results to \\\"%s\\\"%n\", resultDir);\n-        out.printf(\"  Running each test matching \\\"%s\\\" for %d forks, %d iterations, %d ms each%n\", getTestFilter(), getForks(), getIterations(), getTime());\n-        out.printf(\"  Solo stride size will be autobalanced within [%d, %d] elements, but taking no more than %d Mb.%n\", getMinStride(), getMaxStride(), getMaxFootprintMb());\n-\n+        out.println(\"  Test configuration:\");\n+        out.printf(\"    Test preset mode: \\\"%s\\\"%n\", mode);\n+        out.printf(\"    Hardware CPUs in use: %d%n\", getCPUCount());\n+        out.printf(\"    Spinning style: %s%n\", getSpinStyle());\n+        out.printf(\"    Test selection: \\\"%s\\\"%n\", getTestFilter());\n+        out.printf(\"    Forks per test: %d%n\", getForks());\n+        out.printf(\"    Iterations per fork: %d%n\", getIterations());\n+        out.printf(\"    Time per iteration: %d ms%n\", getTime());\n+        out.printf(\"    Epoch size: %d elements, but taking no more than %d Mb%n\", getEpoch(), getMaxFootprintMb());\n+        out.printf(\"    Stride size: %d elements%n\", getStride());\n+        out.printf(\"    Test result blob: \\\"%s\\\"%n\", resultFile);\n+        out.printf(\"    Test results: \\\"%s\\\"%n\", resultDir);\n@@ -283,2 +288,2 @@\n-    public int getMinStride() {\n-        return minStride;\n+    public int getStride() {\n+        return stride;\n@@ -287,2 +292,2 @@\n-    public int getMaxStride() {\n-        return maxStride;\n+    public int getEpoch() {\n+        return epoch;\n","filename":"jcstress-core\/src\/main\/java\/org\/openjdk\/jcstress\/Options.java","additions":26,"deletions":21,"binary":false,"changes":47,"status":"modified"},{"patch":"@@ -382,1 +382,1 @@\n-        pw.println(\"        config.adjustStrides(new FootprintEstimator() {\");\n+        pw.println(\"        config.adjustEpoch(new FootprintEstimator() {\");\n@@ -450,3 +450,3 @@\n-        pw.println(\"        gs = new \" + s + \"[config.minStride];\");\n-        pw.println(\"        gr = new \" + r + \"[config.minStride];\");\n-        pw.println(\"        for (int c = 0; c < config.minStride; c++) {\");\n+        pw.println(\"        gs = new \" + s + \"[config.epoch];\");\n+        pw.println(\"        gr = new \" + r + \"[config.epoch];\");\n+        pw.println(\"        for (int c = 0; c < config.epoch; c++) {\");\n@@ -499,3 +499,2 @@\n-        pw.println(\"        int len = ls.length;\");\n-        pw.println(\"        int left = a * len \/ \" + actorsCount + \";\");\n-        pw.println(\"        int right = (a + 1) * len \/ \" + actorsCount + \";\");\n+        pw.println(\"        int left = a * config.epoch \/ \" + actorsCount + \";\");\n+        pw.println(\"        int right = (a + 1) * config.epoch \/ \" + actorsCount + \";\");\n@@ -541,22 +540,0 @@\n-        pw.println(\"    private void \" + AUX_PREFIX + \"update(WorkerSync sync) {\");\n-        pw.println(\"        \" + s + \"[] ls = gs;\");\n-        pw.println(\"        \" + r + \"[] lr = gr;\");\n-        pw.println(\"        int len = ls.length;\");\n-        pw.println();\n-        pw.println(\"        int newLen = sync.updateStride ? Math.max(config.minStride, Math.min(len * 2, config.maxStride)) : len;\");\n-        pw.println();\n-        pw.println(\"        if (newLen > len) {\");\n-        pw.println(\"            ls = Arrays.copyOf(ls, newLen);\");\n-        pw.println(\"            lr = Arrays.copyOf(lr, newLen);\");\n-        pw.println(\"            for (int c = len; c < newLen; c++) {\");\n-        pw.println(\"                ls[c] = new \" + s + \"();\");\n-        pw.println(\"                lr[c] = new \" + r + \"();\");\n-        pw.println(\"            }\");\n-        pw.println(\"            gs = ls;\");\n-        pw.println(\"            gr = lr;\");\n-        pw.println(\"         }\");\n-        pw.println();\n-        pw.println(\"        workerSync = new WorkerSync(control.isStopped, \" + actorsCount + \", config.spinLoopStyle);\");\n-        pw.println(\"    }\");\n-        pw.println();\n-\n@@ -578,3 +555,9 @@\n-            pw.println(\"            sync.preRun();\");\n-            pw.println(\"            \" + RUN_LOOP_PREFIX + a.getSimpleName() + \"(gs, gr);\");\n-            pw.println(\"            sync.postRun();\");\n+            pw.println(\"            int len = config.epoch;\");\n+            pw.println(\"            int stride = config.stride;\");\n+            pw.println(\"            int check = 0;\");\n+            pw.println(\"            for (int start = 0; start < len; start += stride) {\");\n+            pw.println(\"                int end = Math.min(len, start + stride);\");\n+            pw.println(\"                \" + RUN_LOOP_PREFIX + a.getSimpleName() + \"(gs, gr, start, end);\");\n+            pw.println(\"                check += \" + actorsCount + \";\");\n+            pw.println(\"                sync.awaitCheckpoint(check);\");\n+            pw.println(\"            }\");\n@@ -583,1 +566,1 @@\n-            pw.println(\"                \" + AUX_PREFIX + \"update(sync);\");\n+            pw.println(\"                workerSync = new WorkerSync(control.isStopped, \" + actorsCount + \", config.spinLoopStyle);\");\n@@ -589,1 +572,1 @@\n-            pw.println(\"    private void \" + RUN_LOOP_PREFIX + a.getSimpleName() + \"(\" + s + \"[] gs, \" + r + \"[] gr) {\");\n+            pw.println(\"    private void \" + RUN_LOOP_PREFIX + a.getSimpleName() + \"(\" + s + \"[] gs, \" + r + \"[] gr, int start, int end) {\");\n@@ -595,2 +578,1 @@\n-            pw.println(\"        int size = ls.length;\");\n-            pw.println(\"        for (int c = 0; c < size; c++) {\");\n+            pw.println(\"        for (int c = start; c < end; c++) {\");\n","filename":"jcstress-core\/src\/main\/java\/org\/openjdk\/jcstress\/infra\/processors\/JCStressTestProcessor.java","additions":18,"deletions":36,"binary":false,"changes":54,"status":"modified"},{"patch":"@@ -40,2 +40,2 @@\n-    public int minStride;\n-    public int maxStride;\n+    public int stride;\n+    public int epoch;\n@@ -51,2 +51,2 @@\n-        minStride = cfg.minStride;\n-        maxStride = cfg.maxStride;\n+        stride = cfg.stride;\n+        epoch = cfg.epoch;\n@@ -65,2 +65,2 @@\n-        minStride = dis.readInt();\n-        maxStride = dis.readInt();\n+        stride = dis.readInt();\n+        epoch = dis.readInt();\n@@ -83,2 +83,2 @@\n-        dos.writeInt(minStride);\n-        dos.writeInt(maxStride);\n+        dos.writeInt(stride);\n+        dos.writeInt(epoch);\n@@ -94,1 +94,1 @@\n-    public void adjustStrides(FootprintEstimator estimator) {\n+    public void adjustEpoch(FootprintEstimator estimator) {\n@@ -97,5 +97,1 @@\n-        while (true) {\n-            if (!tryWith(estimator, count)) {\n-                break;\n-            }\n-\n+        while (tryWith(estimator, count)) {\n@@ -105,4 +101,3 @@\n-            \/\/ do not go over the maxStride\n-            if (succCount >= maxStride) {\n-                succCount = maxStride;\n-                break;\n+            \/\/ do not go over the stride\n+            if (succCount >= epoch) {\n+                return;\n@@ -114,2 +109,1 @@\n-        maxStride = Math.min(maxStride, succCount);\n-        minStride = Math.min(minStride, succCount);\n+        epoch = succCount;\n","filename":"jcstress-core\/src\/main\/java\/org\/openjdk\/jcstress\/infra\/runners\/ForkedTestConfig.java","additions":14,"deletions":20,"binary":false,"changes":34,"status":"modified"},{"patch":"@@ -28,4 +28,4 @@\n-    HARD(\"using plain hard busywait.\"),\n-    THREAD_YIELD(\"using Thread.yield().\"),\n-    THREAD_SPIN_WAIT(\"using Thread.onSpinWait()\"),\n-    LOCKSUPPORT_PARK_NANOS(\"using LockSupport.parkNanos().\"),\n+    HARD(\"plain hard busywait\"),\n+    THREAD_YIELD(\"Thread.yield()\"),\n+    THREAD_SPIN_WAIT(\"Thread.onSpinWait()\"),\n+    LOCKSUPPORT_PARK_NANOS(\"LockSupport.parkNanos()\"),\n","filename":"jcstress-core\/src\/main\/java\/org\/openjdk\/jcstress\/infra\/runners\/SpinLoopStyle.java","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -48,2 +48,2 @@\n-    public int minStride;\n-    public int maxStride;\n+    public int stride;\n+    public int epoch;\n@@ -60,2 +60,2 @@\n-        minStride = opts.getMinStride();\n-        maxStride = opts.getMaxStride();\n+        stride = opts.getStride();\n+        epoch = opts.getEpoch();\n@@ -90,2 +90,2 @@\n-        if (minStride != that.minStride) return false;\n-        if (maxStride != that.maxStride) return false;\n+        if (stride != that.stride) return false;\n+        if (epoch != that.epoch) return false;\n","filename":"jcstress-core\/src\/main\/java\/org\/openjdk\/jcstress\/infra\/runners\/TestConfig.java","additions":6,"deletions":6,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -41,3 +41,0 @@\n-    public volatile boolean updateStride;\n-    private volatile int notStarted;\n-    private volatile int notFinished;\n@@ -46,0 +43,1 @@\n+    private volatile int checkpoint;\n@@ -47,2 +45,0 @@\n-    static final AtomicIntegerFieldUpdater<WorkerSync> UPDATER_NOT_STARTED = AtomicIntegerFieldUpdater.newUpdater(WorkerSync.class, \"notStarted\");\n-    static final AtomicIntegerFieldUpdater<WorkerSync> UPDATER_NOT_FINISHED = AtomicIntegerFieldUpdater.newUpdater(WorkerSync.class, \"notFinished\");\n@@ -51,0 +47,1 @@\n+    static final AtomicIntegerFieldUpdater<WorkerSync> UPDATER_CHECKPOINT = AtomicIntegerFieldUpdater.newUpdater(WorkerSync.class, \"checkpoint\");\n@@ -55,2 +52,0 @@\n-        this.notStarted = expectedWorkers;\n-        this.notFinished = expectedWorkers;\n@@ -61,17 +56,3 @@\n-    public void preRun() {\n-        \/\/ Do not need to rendezvous the workers: first iteration would\n-        \/\/ probably lack any rendezvous, but all subsequent ones would\n-        \/\/ rendezvous during postUpdate().\n-\n-        \/\/ Notify that we have started\n-        UPDATER_NOT_STARTED.decrementAndGet(this);\n-    }\n-\n-    public void postRun() {\n-        \/\/ If any thread lags behind, then we need to update our stride\n-        if (!updateStride && notStarted > 0) {\n-            updateStride = true;\n-        }\n-\n-        \/\/ Notify that we are finished\n-        UPDATER_NOT_FINISHED.decrementAndGet(this);\n+    public void awaitCheckpoint(int expected) {\n+        \/\/ Notify that we have rolled to the checkpoint\n+        UPDATER_CHECKPOINT.incrementAndGet(this);\n@@ -81,1 +62,1 @@\n-                while (notFinished > 0);\n+                while (checkpoint < expected);\n@@ -84,1 +65,1 @@\n-                while (notFinished > 0) Thread.yield();\n+                while (checkpoint < expected) Thread.yield();\n@@ -87,1 +68,1 @@\n-                while (notFinished > 0) Thread.onSpinWait();\n+                while (checkpoint < expected) Thread.onSpinWait();\n@@ -90,1 +71,1 @@\n-                while (notFinished > 0) LockSupport.parkNanos(1);\n+                while (checkpoint < expected) LockSupport.parkNanos(1);\n","filename":"jcstress-core\/src\/main\/java\/org\/openjdk\/jcstress\/infra\/runners\/WorkerSync.java","additions":9,"deletions":28,"binary":false,"changes":37,"status":"modified"},{"patch":"@@ -35,1 +35,0 @@\n-import sun.misc.Contended;\n@@ -49,1 +48,2 @@\n-    @Contended\n+    @sun.misc.Contended\n+    @jdk.internal.vm.annotation.Contended\n@@ -52,1 +52,2 @@\n-    @Contended\n+    @sun.misc.Contended\n+    @jdk.internal.vm.annotation.Contended\n","filename":"tests-custom\/src\/main\/java\/org\/openjdk\/jcstress\/tests\/fences\/UnfencedDekkerTest.java","additions":4,"deletions":3,"binary":false,"changes":7,"status":"modified"}]}