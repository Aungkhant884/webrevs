{"files":[{"patch":"@@ -208,6 +208,18 @@\n-        this.iters = 5;\n-        this.forks = 1;\n-        this.forksStressMultiplier = 5;\n-        this.strideSize = 256;\n-        this.strideCount = 40;\n-        this.pretouchHeap = true;\n+        this.timeBudget = optTimeBudget.value(set);\n+\n+        if (timeBudget.isZero()) {\n+            \/\/ Special, extra-fast mode, good only for sanity testing\n+            this.iters = 1;\n+            this.forks = 1;\n+            this.forksStressMultiplier = 1;\n+            this.strideSize = 1;\n+            this.strideCount = 1;\n+            this.pretouchHeap = false;\n+        } else {\n+            this.iters = 5;\n+            this.forks = 1;\n+            this.forksStressMultiplier = 5;\n+            this.strideSize = 256;\n+            this.strideCount = 40;\n+            this.pretouchHeap = true;\n+        }\n@@ -229,2 +241,0 @@\n-        this.timeBudget = optTimeBudget.value(set);\n-\n","filename":"jcstress-core\/src\/main\/java\/org\/openjdk\/jcstress\/Options.java","additions":18,"deletions":8,"binary":false,"changes":26,"status":"modified"},{"patch":"@@ -35,1 +35,4 @@\n-    int expectedIterations;\n+    final long endTime;\n+    final boolean zeroBudget;\n+    final int expectedIterations;\n+\n@@ -37,2 +40,0 @@\n-    long startTime;\n-    long timeBudget;\n@@ -42,2 +43,2 @@\n-        this.startTime = System.nanoTime();\n-        this.timeBudget = timeBudget.milliseconds();\n+        this.endTime = TimeUnit.NANOSECONDS.toMillis(System.nanoTime()) + timeBudget.milliseconds();\n+        this.zeroBudget = timeBudget.isZero();\n@@ -51,0 +52,4 @@\n+        if (isZero()) {\n+            return 0;\n+        }\n+\n@@ -52,0 +57,1 @@\n+        long timeLeft = timeLeftMs();\n@@ -53,2 +59,2 @@\n-        int msPerIter = (leftoverIterations > 0) ?\n-                (int) (timeLeftMs() \/ leftoverIterations) :\n+        int msPerIter = (timeLeft > 0 && leftoverIterations > 0) ?\n+                (int) (timeLeft \/ leftoverIterations) :\n@@ -57,2 +63,2 @@\n-        \/\/ At least 1ms\n-        msPerIter = Math.max(1, msPerIter);\n+        \/\/ Reserve a bit of iteration time for infrastructure, but never drop below 1ms\n+        msPerIter = Math.max(1, msPerIter - 30);\n@@ -63,2 +69,1 @@\n-        long timeSpent = TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - startTime);\n-        return timeBudget > timeSpent ? (timeBudget - timeSpent) : 0;\n+        return endTime - TimeUnit.NANOSECONDS.toMillis(System.nanoTime());\n@@ -69,2 +74,6 @@\n-        out.println(\"    Target completion in \" + ReportUtils.msToDate(timeLeftMs(), true));\n-        out.println(\"    Initial iteration time: \" + targetIterTimeMs() + \" ms\");\n+        if (isZero()) {\n+            out.println(\"    Zero budget, sanity test mode\");\n+        } else {\n+            out.println(\"    Target completion: in \" + ReportUtils.msToDate(timeLeftMs(), true));\n+            out.println(\"    Initial iteration time: \" + targetIterTimeMs() + \" ms\");\n+        }\n@@ -73,0 +82,4 @@\n+\n+    public boolean isZero() {\n+        return zeroBudget;\n+    }\n","filename":"jcstress-core\/src\/main\/java\/org\/openjdk\/jcstress\/TimeBudget.java","additions":26,"deletions":13,"binary":false,"changes":39,"status":"modified"},{"patch":"@@ -163,1 +163,2 @@\n-        String l0 = String.format(\"(Time Left: %s, Iteration Time: %d ms)\",\n+        String l0 = timeBudget.isZero() ? \"(Sanity test mode)\" :\n+                String.format(\"(Time budget: %s, %d ms iterations)\",\n","filename":"jcstress-core\/src\/main\/java\/org\/openjdk\/jcstress\/infra\/grading\/ConsoleReportPrinter.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -295,0 +295,6 @@\n+\n+        if (ms < 0) {\n+            result += \"overtime \";\n+            ms = -ms;\n+        }\n+\n","filename":"jcstress-core\/src\/main\/java\/org\/openjdk\/jcstress\/infra\/grading\/ReportUtils.java","additions":6,"deletions":0,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -65,0 +65,4 @@\n+\n+    public boolean isZero() {\n+        return (time == 0);\n+    }\n","filename":"jcstress-core\/src\/main\/java\/org\/openjdk\/jcstress\/util\/TimeValue.java","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"}]}