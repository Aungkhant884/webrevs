{"files":[{"patch":"@@ -50,0 +50,2 @@\n+    assert(C->post_loop_opts_phase(), \"no loop opts allowed\");\n+    C->reset_post_loop_opts_phase(); \/\/ ... but we know what we are doing\n@@ -62,0 +64,2 @@\n+\n+      C->process_for_post_loop_opts_igvn(igvn);\n@@ -63,0 +67,1 @@\n+    C->set_post_loop_opts_phase(); \/\/ now for real!\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/c2\/shenandoahSupport.cpp","additions":5,"deletions":0,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -1837,7 +1837,14 @@\n-  if (_for_post_loop_igvn.length() == 0) {\n-    return; \/\/ no work to do\n-  }\n-  while (_for_post_loop_igvn.length() > 0) {\n-    Node* n = _for_post_loop_igvn.pop();\n-    n->remove_flag(Node::NodeFlags::Flag_for_post_loop_opts_igvn);\n-    igvn._worklist.push(n);\n+  \/\/ Verify that all previous optimizations produced a valid graph\n+  \/\/ at least to this point, even if no loop optimizations were done.\n+  PhaseIdealLoop::verify(igvn);\n+\n+  C->set_post_loop_opts_phase(); \/\/ no more loop opts allowed\n+\n+  if (_for_post_loop_igvn.length() > 0) {\n+    while (_for_post_loop_igvn.length() > 0) {\n+      Node* n = _for_post_loop_igvn.pop();\n+      n->remove_flag(Node::NodeFlags::Flag_for_post_loop_opts_igvn);\n+      igvn._worklist.push(n);\n+    }\n+    igvn.optimize();\n+    assert(_for_post_loop_igvn.length() == 0, \"no more delayed nodes allowed\");\n@@ -1845,2 +1852,0 @@\n-  igvn.optimize();\n-  assert(_for_post_loop_igvn.length() == 0, \"no more delayed nodes allowed\");\n@@ -2255,1 +2260,0 @@\n-      TracePhase tp(\"idealLoopVerify\", &timers[_t_idealLoopVerify]);\n@@ -2290,2 +2294,1 @@\n-  \/\/ Ensure that major progress is now clear\n-  C->clear_major_progress();\n+  C->clear_major_progress(); \/\/ ensure that major progress is now clear\n@@ -2293,6 +2296,1 @@\n-  {\n-    \/\/ Verify that all previous optimizations produced a valid graph\n-    \/\/ at least to this point, even if no loop optimizations were done.\n-    TracePhase tp(\"idealLoopVerify\", &timers[_t_idealLoopVerify]);\n-    PhaseIdealLoop::verify(igvn);\n-  }\n+  process_for_post_loop_opts_igvn(igvn);\n@@ -2323,4 +2321,0 @@\n-  C->set_post_loop_opts_phase(); \/\/ no more loop opts allowed\n-\n-  process_for_post_loop_opts_igvn(igvn);\n-\n","filename":"src\/hotspot\/share\/opto\/compile.cpp","additions":16,"deletions":22,"binary":false,"changes":38,"status":"modified"},{"patch":"@@ -692,2 +692,3 @@\n-  bool     post_loop_opts_phase() { return _post_loop_opts_phase; }\n-  void set_post_loop_opts_phase() { _post_loop_opts_phase = true; }\n+  bool       post_loop_opts_phase() { return _post_loop_opts_phase;  }\n+  void   set_post_loop_opts_phase() { _post_loop_opts_phase = true;  }\n+  void reset_post_loop_opts_phase() { _post_loop_opts_phase = false; }\n","filename":"src\/hotspot\/share\/opto\/compile.hpp","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -1135,0 +1135,1 @@\n+    Compile::TracePhase tp(\"idealLoopVerify\", &timers[_t_idealLoopVerify]);\n","filename":"src\/hotspot\/share\/opto\/loopnode.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -67,2 +67,0 @@\n-compiler\/loopstripmining\/BackedgeNodeWithOutOfLoopControl.java 8255120 generic-all\n-\n","filename":"test\/hotspot\/jtreg\/ProblemList.txt","additions":0,"deletions":2,"binary":false,"changes":2,"status":"modified"}]}