{"files":[{"patch":"@@ -75,0 +75,4 @@\n+                        <phase>test<\/phase>\n+                        <goals>\n+                            <goal>test<\/goal>\n+                        <\/goals>\n@@ -76,1 +80,2 @@\n-                            <skip>true<\/skip>\n+                            <forkCount>4<\/forkCount>\n+                            <reuseForks>true<\/reuseForks>\n@@ -80,1 +85,1 @@\n-                        <id>tests-minus-coops-1g<\/id>\n+                        <id>tests-1g-minus-coops-minus-ccp<\/id>\n@@ -86,1 +91,1 @@\n-                            <argLine>-XX:-UseCompressedOops -Xmx1g<\/argLine>\n+                            <argLine>-Xmx1g -XX:-UseCompressedOops -XX:-UseCompressedClassPointers<\/argLine>\n@@ -92,1 +97,1 @@\n-                        <id>tests-plus-coops-1g<\/id>\n+                        <id>tests-1g-plus-coops-plus-ccp<\/id>\n@@ -98,1 +103,1 @@\n-                            <argLine>-XX:+UseCompressedOops -Xmx1g<\/argLine>\n+                            <argLine>-Xmx1g -XX:+UseCompressedOops -XX:+UseCompressedClassPointers<\/argLine>\n@@ -104,1 +109,1 @@\n-                        <id>tests-plus-coops-4g<\/id>\n+                        <id>tests-1g-plus-coops-minus-ccp<\/id>\n@@ -110,2 +115,38 @@\n-                            <argLine>-XX:+UseCompressedOops -Xmx4g<\/argLine>\n-                            <forkCount>1<\/forkCount>\n+                            <argLine>-Xmx1g -XX:+UseCompressedOops -XX:-UseCompressedClassPointers<\/argLine>\n+                            <forkCount>4<\/forkCount>\n+                            <reuseForks>true<\/reuseForks>\n+                        <\/configuration>\n+                    <\/execution>\n+                    <execution>\n+                        <id>tests-1g-minus-coops-plus-ccp<\/id>\n+                        <phase>test<\/phase>\n+                        <goals>\n+                            <goal>test<\/goal>\n+                        <\/goals>\n+                        <configuration>\n+                            <argLine>-Xmx1g -XX:-UseCompressedOops -XX:+UseCompressedClassPointers<\/argLine>\n+                            <forkCount>4<\/forkCount>\n+                            <reuseForks>true<\/reuseForks>\n+                        <\/configuration>\n+                    <\/execution>\n+                    <execution>\n+                        <id>tests-1g-minus-coops-minus-ccp-align16<\/id>\n+                        <phase>test<\/phase>\n+                        <goals>\n+                            <goal>test<\/goal>\n+                        <\/goals>\n+                        <configuration>\n+                            <argLine>-Xmx1g -XX:-UseCompressedOops -XX:-UseCompressedClassPointers -XX:ObjectAlignmentInBytes=16<\/argLine>\n+                            <forkCount>4<\/forkCount>\n+                            <reuseForks>true<\/reuseForks>\n+                        <\/configuration>\n+                    <\/execution>\n+                    <execution>\n+                        <id>tests-1g-plus-coops-plus-ccp-align16<\/id>\n+                        <phase>test<\/phase>\n+                        <goals>\n+                            <goal>test<\/goal>\n+                        <\/goals>\n+                        <configuration>\n+                            <argLine>-Xmx1g -XX:+UseCompressedOops -XX:+UseCompressedClassPointers -XX:ObjectAlignmentInBytes=16<\/argLine>\n+                            <forkCount>4<\/forkCount>\n@@ -116,1 +157,1 @@\n-                        <id>tests-minus-coops-1g-align16<\/id>\n+                        <id>tests-1g-plus-coops-minus-ccp-align16<\/id>\n@@ -122,1 +163,1 @@\n-                            <argLine>-XX:-UseCompressedOops -Xmx1g -XX:ObjectAlignmentInBytes=16<\/argLine>\n+                            <argLine>-Xmx1g -XX:+UseCompressedOops -XX:-UseCompressedClassPointers -XX:ObjectAlignmentInBytes=16<\/argLine>\n@@ -128,1 +169,1 @@\n-                        <id>tests-plus-coops-1g-align16<\/id>\n+                        <id>tests-1g-minus-coops-plus-ccp-align16<\/id>\n@@ -134,1 +175,1 @@\n-                            <argLine>-XX:+UseCompressedOops -Xmx1g -XX:ObjectAlignmentInBytes=16<\/argLine>\n+                            <argLine>-Xmx1g -XX:-UseCompressedOops -XX:+UseCompressedClassPointers -XX:ObjectAlignmentInBytes=16<\/argLine>\n@@ -140,1 +181,85 @@\n-                        <id>tests-plus-coops-4g-align16<\/id>\n+                        <id>tests-4g-minus-coops-minus-ccp<\/id>\n+                        <phase>test<\/phase>\n+                        <goals>\n+                            <goal>test<\/goal>\n+                        <\/goals>\n+                        <configuration>\n+                            <argLine>-Xmx4g -XX:-UseCompressedOops -XX:-UseCompressedClassPointers<\/argLine>\n+                            <forkCount>1<\/forkCount>\n+                            <reuseForks>true<\/reuseForks>\n+                        <\/configuration>\n+                    <\/execution>\n+                    <execution>\n+                        <id>tests-4g-plus-coops-plus-ccp<\/id>\n+                        <phase>test<\/phase>\n+                        <goals>\n+                            <goal>test<\/goal>\n+                        <\/goals>\n+                        <configuration>\n+                            <argLine>-Xmx4g -XX:+UseCompressedOops -XX:+UseCompressedClassPointers<\/argLine>\n+                            <forkCount>1<\/forkCount>\n+                            <reuseForks>true<\/reuseForks>\n+                        <\/configuration>\n+                    <\/execution>\n+                    <execution>\n+                        <id>tests-4g-plus-coops-minus-ccp<\/id>\n+                        <phase>test<\/phase>\n+                        <goals>\n+                            <goal>test<\/goal>\n+                        <\/goals>\n+                        <configuration>\n+                            <argLine>-Xmx4g -XX:+UseCompressedOops -XX:-UseCompressedClassPointers<\/argLine>\n+                            <forkCount>1<\/forkCount>\n+                            <reuseForks>true<\/reuseForks>\n+                        <\/configuration>\n+                    <\/execution>\n+                    <execution>\n+                        <id>tests-4g-minus-coops-plus-ccp<\/id>\n+                        <phase>test<\/phase>\n+                        <goals>\n+                            <goal>test<\/goal>\n+                        <\/goals>\n+                        <configuration>\n+                            <argLine>-Xmx4g -XX:-UseCompressedOops -XX:+UseCompressedClassPointers<\/argLine>\n+                            <forkCount>1<\/forkCount>\n+                            <reuseForks>true<\/reuseForks>\n+                        <\/configuration>\n+                    <\/execution>\n+                    <execution>\n+                        <id>tests-4g-minus-coops-minus-ccp-align16<\/id>\n+                        <phase>test<\/phase>\n+                        <goals>\n+                            <goal>test<\/goal>\n+                        <\/goals>\n+                        <configuration>\n+                            <argLine>-Xmx4g -XX:-UseCompressedOops -XX:-UseCompressedClassPointers -XX:ObjectAlignmentInBytes=16<\/argLine>\n+                            <forkCount>1<\/forkCount>\n+                            <reuseForks>true<\/reuseForks>\n+                        <\/configuration>\n+                    <\/execution>\n+                    <execution>\n+                        <id>tests-4g-plus-coops-plus-ccp-align16<\/id>\n+                        <phase>test<\/phase>\n+                        <goals>\n+                            <goal>test<\/goal>\n+                        <\/goals>\n+                        <configuration>\n+                            <argLine>-Xmx4g -XX:+UseCompressedOops -XX:+UseCompressedClassPointers -XX:ObjectAlignmentInBytes=16<\/argLine>\n+                            <forkCount>1<\/forkCount>\n+                            <reuseForks>true<\/reuseForks>\n+                        <\/configuration>\n+                    <\/execution>\n+                    <execution>\n+                        <id>tests-4g-plus-coops-minus-ccp-align16<\/id>\n+                        <phase>test<\/phase>\n+                        <goals>\n+                            <goal>test<\/goal>\n+                        <\/goals>\n+                        <configuration>\n+                            <argLine>-Xmx4g -XX:+UseCompressedOops -XX:-UseCompressedClassPointers -XX:ObjectAlignmentInBytes=16<\/argLine>\n+                            <forkCount>1<\/forkCount>\n+                            <reuseForks>true<\/reuseForks>\n+                        <\/configuration>\n+                    <\/execution>\n+                    <execution>\n+                        <id>tests-4g-minus-coops-plus-ccp-align16<\/id>\n@@ -146,1 +271,1 @@\n-                            <argLine>-XX:+UseCompressedOops -Xmx4g -XX:ObjectAlignmentInBytes=16<\/argLine>\n+                            <argLine>-Xmx4g -XX:-UseCompressedOops -XX:+UseCompressedClassPointers -XX:ObjectAlignmentInBytes=16<\/argLine>\n","filename":"jol-core\/pom.xml","additions":139,"deletions":14,"binary":false,"changes":153,"status":"modified"},{"patch":"@@ -82,0 +82,6 @@\n+    \/**\n+     * Return the address size for this model: the size of the native pointer.\n+     *\n+     * @return address size in bytes\n+     *\/\n+    int addressSize();\n","filename":"jol-core\/src\/main\/java\/org\/openjdk\/jol\/datamodel\/DataModel.java","additions":6,"deletions":0,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -96,0 +96,5 @@\n+    @Override\n+    public int addressSize() {\n+        return 4;\n+    }\n+\n","filename":"jol-core\/src\/main\/java\/org\/openjdk\/jol\/datamodel\/Model32.java","additions":5,"deletions":0,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -100,0 +100,5 @@\n+    @Override\n+    public int addressSize() {\n+        return 8;\n+    }\n+\n","filename":"jol-core\/src\/main\/java\/org\/openjdk\/jol\/datamodel\/Model64.java","additions":5,"deletions":0,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -98,0 +98,5 @@\n+    @Override\n+    public int addressSize() {\n+        return 8;\n+    }\n+\n","filename":"jol-core\/src\/main\/java\/org\/openjdk\/jol\/datamodel\/Model64_Lilliput.java","additions":5,"deletions":0,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -76,0 +76,5 @@\n+    @Override\n+    public int addressSize() {\n+        return VM.current().addressSize();\n+    }\n+\n","filename":"jol-core\/src\/main\/java\/org\/openjdk\/jol\/datamodel\/ModelVM.java","additions":5,"deletions":0,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -225,6 +225,1 @@\n-        StringBuilder sb = new StringBuilder();\n-        for (FieldLayout f : fields()) {\n-            sb.append(f).append(\"\\n\");\n-        }\n-        sb.append(\"size = \").append(size).append(\"\\n\");\n-        return sb.toString();\n+        return toPrintable();\n@@ -474,0 +469,1 @@\n+\n@@ -476,1 +472,3 @@\n-                model.equals(that.model);\n+                model.equals(that.model) &&\n+                isArray == that.isArray &&\n+                size == that.size;\n","filename":"jol-core\/src\/main\/java\/org\/openjdk\/jol\/info\/ClassLayout.java","additions":5,"deletions":7,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -34,1 +34,0 @@\n-import java.lang.IllegalStateException;\n@@ -83,0 +82,4 @@\n+            \/\/ Array bases are aligned by HeapWord size:\n+            \/\/  https:\/\/bugs.openjdk.java.net\/browse\/JDK-8139457\n+            base = MathUtil.align(base, Math.max(model.addressSize(), scale));\n+\n@@ -85,1 +88,0 @@\n-            base = MathUtil.align(base, Math.max(4, scale));\n","filename":"jol-core\/src\/main\/java\/org\/openjdk\/jol\/layouters\/HotSpotLayouter.java","additions":4,"deletions":2,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -15,1 +15,0 @@\n-    private static final DataModel[] MODELS = { new ModelVM() };\n@@ -28,1 +27,1 @@\n-        tryWith(1, 5, getVersion());\n+        tryWithClasses(1, 5, getVersion());\n@@ -33,1 +32,1 @@\n-        tryWith(2, 5, getVersion());\n+        tryWithClasses(2, 5, getVersion());\n@@ -36,1 +35,29 @@\n-    public void tryWith(int hierarchyDepth, int fieldsPerClass, int jdkVersion) throws Exception {\n+    @Test\n+    public void testArrays() {\n+        int version = getVersion();\n+        for (int c = 0; c < 128; c++) {\n+            tryWithArrays(new boolean[c], version);\n+            tryWithArrays(new byte[c],    version);\n+            tryWithArrays(new char[c],    version);\n+            tryWithArrays(new int[c],     version);\n+            tryWithArrays(new float[c],   version);\n+            tryWithArrays(new long[c],    version);\n+            tryWithArrays(new double[c],  version);\n+            tryWithArrays(new Object[c],  version);\n+        }\n+    }\n+\n+    public void tryWithArrays(Object array, int jdkVersion) {\n+        ClassLayout actual = ClassLayout.parseInstance(array);\n+        ClassData cd = ClassData.parseInstance(array);\n+\n+        HotSpotLayouter layouter = new HotSpotLayouter(new ModelVM(), jdkVersion);\n+        ClassLayout model = layouter.layout(cd);\n+\n+        System.out.println(actual);\n+        System.out.println(model);\n+\n+        Assert.assertEquals(model, actual);\n+    }\n+\n+    public void tryWithClasses(int hierarchyDepth, int fieldsPerClass, int jdkVersion) throws Exception {\n@@ -38,0 +65,2 @@\n+        HotSpotLayouter layouter = new HotSpotLayouter(new ModelVM(), jdkVersion);\n+\n@@ -42,18 +71,2 @@\n-            try {\n-                ClassLayout actual = ClassLayout.parseClass(cl);\n-\n-                Map<Layouter, ClassLayout> candidates = candidateLayouts(cl, jdkVersion);\n-\n-                if (!candidates.containsValue(actual)) {\n-                    System.out.println(actual.toPrintable());\n-                    for (Layouter l : candidates.keySet()) {\n-                        System.out.println(l);\n-                        System.out.println(candidates.get(l).toPrintable());\n-                    }\n-                    Assert.fail(\"Actual layout should have matched at least one model layout. Seed = \" + seed);\n-                }\n-            } catch (Exception e) {\n-                Assert.fail(\"Failed. Seed = \" + seed);\n-            }\n-        }\n-    }\n+            ClassLayout actual = ClassLayout.parseClass(cl);\n+            ClassData cd = ClassData.parseClass(cl);\n@@ -61,6 +74,2 @@\n-    private Map<Layouter, ClassLayout> candidateLayouts(Class<?> cl, int jdkVersion) {\n-        ClassData cd = ClassData.parseClass(cl);\n-        Map<Layouter, ClassLayout> layouts = new HashMap<>();\n-        for (DataModel model : MODELS) {\n-            HotSpotLayouter layouter = new HotSpotLayouter(model, jdkVersion);\n-            layouts.put(layouter, layouter.layout(cd));\n+            ClassLayout model = layouter.layout(cd);\n+            Assert.assertEquals(model, actual);\n@@ -68,1 +77,0 @@\n-        return layouts;\n","filename":"jol-core\/src\/test\/java\/org\/openjdk\/jol\/layouters\/HotspotLayouterRealTest.java","additions":37,"deletions":29,"binary":false,"changes":66,"status":"modified"}]}