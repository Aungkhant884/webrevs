{"files":[{"patch":"@@ -35,0 +35,1 @@\n+import java.nio.CharBuffer;\n@@ -942,0 +943,4 @@\n+     * @throws IllegalArgumentException if the provided {@code buffer} is a heap buffer but is not backed by an array.\n+     *                                  For example, buffers directly or indirectly obtained via\n+     *                                  ({@link CharBuffer#wrap(CharSequence)} or {@link CharBuffer#wrap(char[], int, int)}\n+     *                                  are not backed by an array.\n","filename":"src\/java.base\/share\/classes\/java\/lang\/foreign\/MemorySegment.java","additions":5,"deletions":0,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -472,1 +472,0 @@\n-        long bbAddress = NIO_ACCESS.getBufferAddress(bb);\n@@ -474,0 +473,4 @@\n+        if (!bb.isDirect() && base == null) {\n+            throw new IllegalArgumentException(\"The provided heap buffer is not backed by an array.\");\n+        }\n+        long bbAddress = NIO_ACCESS.getBufferAddress(bb);\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/foreign\/AbstractMemorySegmentImpl.java","additions":4,"deletions":1,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -0,0 +1,53 @@\n+\/*\n+ * Copyright (c) 2021, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ *  DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ *  This code is free software; you can redistribute it and\/or modify it\n+ *  under the terms of the GNU General Public License version 2 only, as\n+ *  published by the Free Software Foundation.\n+ *\n+ *  This code is distributed in the hope that it will be useful, but WITHOUT\n+ *  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ *  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ *  version 2 for more details (a copy is included in the LICENSE file that\n+ *  accompanied this code).\n+ *\n+ *  You should have received a copy of the GNU General Public License version\n+ *  2 along with this work; if not, write to the Free Software Foundation,\n+ *  Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ *   Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ *  or visit www.oracle.com if you need additional information or have any\n+ *  questions.\n+ *\n+ *\/\n+\n+import org.testng.annotations.*;\n+\n+import java.lang.foreign.MemorySegment;\n+import java.nio.CharBuffer;\n+\n+import static org.testng.Assert.*;\n+\n+\/*\n+ * @test\n+ * @bug 8294621\n+ * @summary test that StringCharBuffer is not accepted by MemorySegment::ofBuffer\n+ * @enablePreview\n+ * @run testng TestOfBufferIssue\n+ *\/\n+\n+public class TestOfBufferIssue {\n+\n+    @Test\n+    public void ensure8294621Fixed() {\n+        try {\n+            final CharBuffer cb = CharBuffer.wrap(\"Hello\");\n+            MemorySegment src2 = MemorySegment.ofBuffer(cb);\n+            fail(\"A StringCharBuffer is not allowed as an argument.\");\n+        } catch (IllegalArgumentException iae) {\n+            \/\/ Ignored. Happy path\n+        }\n+    }\n+\n+}\n","filename":"test\/jdk\/java\/foreign\/TestOfBufferIssue.java","additions":53,"deletions":0,"binary":false,"changes":53,"status":"added"}]}