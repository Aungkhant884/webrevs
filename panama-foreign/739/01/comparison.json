{"files":[{"patch":"@@ -84,1 +84,3 @@\n-        if (state == 0 || state - ((int)ASYNC_RELEASE_COUNT.getVolatile(this)) == 0) {\n+        int asyncCount = (int)ASYNC_RELEASE_COUNT.getVolatile(this);\n+        if ((state == 0 && asyncCount == 0)\n+                || ((state - asyncCount) == 0)) {\n@@ -87,1 +89,1 @@\n-            throw alreadyAcquired(state);\n+            throw alreadyAcquired(state - asyncCount);\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/foreign\/ConfinedSession.java","additions":4,"deletions":2,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -518,1 +518,1 @@\n-        emitStore(Object.class, nextScopeLocal); \/\/ store off one to release later\n+        \/\/ call acquire first here. So that if it fails, we don't call release\n@@ -520,0 +520,1 @@\n+        emitStore(Object.class, nextScopeLocal); \/\/ store off one to release later\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/foreign\/abi\/BindingSpecializer.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -0,0 +1,79 @@\n+\/*\n+ * Copyright (c) 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/*\n+ * @test\n+ * @enablePreview\n+ * @library ..\/ \/test\/lib\n+ * @requires ((os.arch == \"amd64\" | os.arch == \"x86_64\") & sun.arch.data.model == \"64\") | os.arch == \"aarch64\"\n+ * @run testng\/othervm --enable-native-access=ALL-UNNAMED TestDontRelease\n+ *\/\n+\n+import org.testng.annotations.Test;\n+\n+import java.lang.foreign.FunctionDescriptor;\n+import java.lang.foreign.MemorySegment;\n+import java.lang.foreign.MemorySession;\n+import java.lang.invoke.MethodHandle;\n+\n+import static java.lang.foreign.ValueLayout.ADDRESS;\n+import static java.lang.foreign.ValueLayout.JAVA_INT;\n+import static org.testng.Assert.assertTrue;\n+\n+public class TestDontRelease extends NativeTestHelper  {\n+\n+    static {\n+        System.loadLibrary(\"DontRelease\");\n+    }\n+\n+    @Test\n+    public void testDontRelease() {\n+        MethodHandle handle = downcallHandle(\"test_ptr\", FunctionDescriptor.ofVoid(ADDRESS));\n+        try (MemorySession session = MemorySession.openConfined()) {\n+            MemorySegment segment = session.allocate(JAVA_INT);\n+            session.whileAlive(() -> {\n+                Thread t = new Thread(() -> {\n+                    try {\n+                        \/\/ acquire of the segment should fail here,\n+                        \/\/ due to wrong thread\n+                        handle.invokeExact(segment);\n+                    } catch (Throwable e) {\n+                        \/\/ catch the exception.\n+                        assertTrue(e instanceof WrongThreadException);\n+                        assertTrue(e.getMessage().matches(\".*Attempted access outside owning thread.*\"));\n+                    }\n+                });\n+                t.start();\n+                try {\n+                    t.join();\n+                } catch (InterruptedException e) {\n+                    throw new RuntimeException(e);\n+                }\n+\n+                \/\/ the downcall above should not have called release on the session\n+                \/\/ so doing it here should succeed without error\n+            });\n+        }\n+    }\n+}\n+\n","filename":"test\/jdk\/java\/foreign\/dontrelease\/TestDontRelease.java","additions":79,"deletions":0,"binary":false,"changes":79,"status":"added"},{"patch":"@@ -30,5 +30,1 @@\n-EXPORT void test_args(void* ptr) {}\n-\n-EXPORT void test_return(void* (*cb)(void)) {\n-    cb();\n-}\n+EXPORT void test_ptr(void* ptr) {}\n","filename":"test\/jdk\/java\/foreign\/dontrelease\/libDontRelease.c","additions":1,"deletions":5,"binary":false,"changes":6,"previous_filename":"test\/jdk\/java\/foreign\/passheapsegment\/libPassHeapSegment.c","status":"copied"}]}