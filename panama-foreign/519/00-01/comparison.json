{"files":[{"patch":"@@ -138,1 +138,1 @@\n-                    cleanup.next = null; \/\/ Release, as long as two threads can't add same cleanup it's ok\n+                    cleanup.next = null; \/\/ Sanity, as long as two threads can't add same `cleanup` it's ok to release next\n@@ -155,1 +155,4 @@\n-            if (FST.getAcquire(this) != ResourceCleanup.CLOSED_LIST) {\n+            \/\/\n+            \/\/ That's a speculative check\n+            ResourceCleanup prev = (ResourceCleanup) FST.getAcquire(this);\n+            if (prev != ResourceCleanup.CLOSED_LIST) {\n@@ -157,1 +160,0 @@\n-                ResourceCleanup prev = null;\n@@ -159,3 +161,2 @@\n-                    prev = (ResourceCleanup) FST.getAcquire(this);\n-                    \/\/ no need to check for DUMMY, since only one thread can get here!\n-                    if (FST.weakCompareAndSetRelease(this, prev, ResourceCleanup.CLOSED_LIST)) {\n+                    \/\/ do atomic CAS (with full fence), to prevent races with add method\n+                    if (FST.compareAndSet(this, prev, ResourceCleanup.CLOSED_LIST)) {\n@@ -164,0 +165,2 @@\n+                    \/\/ Refresh prev\n+                    prev = (ResourceCleanup) FST.getAcquire(this);\n","filename":"src\/jdk.incubator.foreign\/share\/classes\/jdk\/internal\/foreign\/SharedScope.java","additions":9,"deletions":6,"binary":false,"changes":15,"status":"modified"}]}