{"files":[{"patch":"@@ -4089,1 +4089,1 @@\n-                                              Register tmp, int masklen, BasicType bt, int vec_enc) {\n+                                              int masklen, BasicType bt, int vec_enc) {\n@@ -4091,0 +4091,2 @@\n+  assert(masklen <= 32, \"\");\n+  bool need_clip = false;\n@@ -4093,4 +4095,2 @@\n-      vpmovmskb(tmp, mask, vec_enc);\n-      if (masklen < 16) {\n-        andq(tmp, (((jlong)1 << masklen) - 1));\n-      }\n+      vpmovmskb(dst, mask, vec_enc);\n+      need_clip = masklen < 16;\n@@ -4104,4 +4104,2 @@\n-      vpmovmskb(tmp, xtmp, Assembler::AVX_128bit);\n-      if (masklen < 16) {\n-        andq(tmp, (((jlong)1 << masklen) - 1));\n-      }\n+      vpmovmskb(dst, xtmp, Assembler::AVX_128bit);\n+      need_clip = masklen < 16;\n@@ -4111,4 +4109,2 @@\n-      vmovmskps(tmp, mask, vec_enc);\n-      if (masklen < 4) {\n-        andq(tmp, (((jlong)1 << masklen) - 1));\n-      }\n+      vmovmskps(dst, mask, vec_enc);\n+      need_clip = masklen < 4;\n@@ -4118,4 +4114,2 @@\n-      vmovmskpd(tmp, mask, vec_enc);\n-      if (masklen < 2) {\n-        andq(tmp, 1);\n-      }\n+      vmovmskpd(dst, mask, vec_enc);\n+      need_clip = masklen < 2;\n@@ -4127,1 +4121,5 @@\n-      popcntq(dst, tmp);\n+      if (need_clip) {\n+        \/\/ need_clip implies masklen < 32\n+        andl(dst, (1 << masklen) - 1);\n+      }\n+      popcntl(dst, dst);\n@@ -4130,3 +4128,7 @@\n-      mov64(dst, -1);\n-      bsrq(tmp, tmp);\n-      cmov(Assembler::notZero, dst, tmp);\n+      if (need_clip) {\n+        \/\/ need_clip implies masklen < 32\n+        andl(dst, (1 << masklen) - 1);\n+      }\n+      lzcntl(dst, dst);\n+      negl(dst);\n+      addl(dst, 31);\n@@ -4135,3 +4137,4 @@\n-      mov64(dst, masklen);\n-      bsfq(tmp, tmp);\n-      cmov(Assembler::notZero, dst, tmp);\n+      if (masklen < 32) {\n+        orl(dst, 1 << masklen);\n+      }\n+      tzcntl(dst, dst);\n@@ -4140,0 +4143,3 @@\n+      if (need_clip) {\n+        andq(dst, ((jlong)1 << masklen) - 1);\n+      }\n","filename":"src\/hotspot\/cpu\/x86\/c2_MacroAssembler_x86.cpp","additions":30,"deletions":24,"binary":false,"changes":54,"status":"modified"},{"patch":"@@ -230,1 +230,1 @@\n-                             Register tmp, int masklen, BasicType bt, int vec_enc);\n+                             int masklen, BasicType bt, int vec_enc);\n","filename":"src\/hotspot\/cpu\/x86\/c2_MacroAssembler_x86.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -8672,1 +8672,1 @@\n-                             $dst$$Register, mask_len, mbt, vlen_enc);\n+                             mask_len, mbt, vlen_enc);\n@@ -8694,1 +8694,1 @@\n-instruct vmask_truecount_avx(rRegI dst, vec mask, rRegL tmp, vec xtmp, rFlagsReg cr) %{\n+instruct vmask_truecount_avx(rRegI dst, vec mask, vec xtmp, rFlagsReg cr) %{\n@@ -8697,2 +8697,2 @@\n-  effect(TEMP_DEF dst, TEMP tmp, TEMP xtmp, KILL cr);\n-  format %{ \"vector_truecount_avx $dst, $mask \\t! using $tmp and $xtmp as TEMP\" %}\n+  effect(TEMP_DEF dst, TEMP xtmp, KILL cr);\n+  format %{ \"vector_truecount_avx $dst, $mask \\t! using $xtmp as TEMP\" %}\n@@ -8705,1 +8705,1 @@\n-                             $tmp$$Register, mask_len, mbt, vlen_enc);\n+                             mask_len, mbt, vlen_enc);\n@@ -8728,1 +8728,1 @@\n-instruct vmask_first_or_last_true_avx(rRegI dst, vec mask, rRegL tmp, vec xtmp, rFlagsReg cr) %{\n+instruct vmask_first_or_last_true_avx(rRegI dst, vec mask, vec xtmp, rFlagsReg cr) %{\n@@ -8732,2 +8732,2 @@\n-  effect(TEMP_DEF dst, TEMP tmp, TEMP xtmp, KILL cr);\n-  format %{ \"vector_mask_first_or_last_true_avx $dst, $mask \\t! using $tmp and $xtmp as TEMP\" %}\n+  effect(TEMP_DEF dst, TEMP xtmp, KILL cr);\n+  format %{ \"vector_mask_first_or_last_true_avx $dst, $mask \\t! using $xtmp as TEMP\" %}\n@@ -8740,1 +8740,1 @@\n-                             $tmp$$Register, mask_len, mbt, vlen_enc);\n+                             mask_len, mbt, vlen_enc);\n","filename":"src\/hotspot\/cpu\/x86\/x86.ad","additions":9,"deletions":9,"binary":false,"changes":18,"status":"modified"}]}