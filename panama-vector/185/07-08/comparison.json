{"files":[{"patch":"@@ -4515,1 +4515,1 @@\n-  vpxorq(xtmp2, xtmp2, xtmp2, vec_enc);\n+  vpxor(xtmp2, xtmp2, xtmp2, vec_enc);\n@@ -4538,1 +4538,0 @@\n-\n@@ -4542,0 +4541,1 @@\n+  assert(UsePopCountInstruction, \"\");\n","filename":"src\/hotspot\/cpu\/x86\/c2_MacroAssembler_x86.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -4127,1 +4127,1 @@\n-    if (UsePopCountInstruction && VM_Version::supports_avx2() && !VM_Version::supports_avx512_vpopcntdq()) {\n+    if (VM_Version::supports_avx2() && (!VM_Version::supports_avx512_vpopcntdq() || !UsePopCountInstruction)) {\n","filename":"src\/hotspot\/cpu\/x86\/stubGenerator_x86_32.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -7795,1 +7795,1 @@\n-    if (UsePopCountInstruction && VM_Version::supports_avx2() && !VM_Version::supports_avx512_vpopcntdq()) {\n+    if (VM_Version::supports_avx2() && (!VM_Version::supports_avx512_vpopcntdq() || !UsePopCountInstruction)) {\n","filename":"src\/hotspot\/cpu\/x86\/stubGenerator_x86_64.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -1705,1 +1705,1 @@\n-  if (supports_popcnt()) {\n+  if (supports_popcnt() || supports_avx512_vpopcntdq() || supports_avx512_bitalg()) {\n","filename":"src\/hotspot\/cpu\/x86\/vm_version_x86.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -1408,1 +1408,1 @@\n-      if (!UsePopCountInstruction || (UseAVX < 2)) {\n+      if (UseAVX < 2) {\n@@ -1413,1 +1413,1 @@\n-      if (!UsePopCountInstruction || (UseAVX <= 2)) {\n+      if (UseAVX < 2) {\n@@ -1644,0 +1644,5 @@\n+static inline bool is_pop_count_instr_target(BasicType bt) {\n+  return (is_subword_type(bt) && VM_Version::supports_avx512_bitalg()) ||\n+         (is_non_subword_integral_type(bt) && VM_Version::supports_avx512_vpopcntdq());\n+}\n+\n@@ -1897,10 +1902,5 @@\n-      if (((bt == T_INT && !VM_Version::supports_avx512_vpopcntdq()) ||\n-           (is_subword_type(bt) && !VM_Version::supports_avx512_bitalg())) &&\n-           (size_in_bits == 512) && !VM_Version::supports_avx512bw()) {\n-        return false;\n-      }\n-      break;\n-    case Op_PopCountVL:\n-      if (!VM_Version::supports_avx512_vpopcntdq() &&\n-          ((vlen <= 4) || ((vlen == 8) && !VM_Version::supports_avx512bw()))) {\n-        return false;\n+    case Op_PopCountVL: {\n+        if (!is_pop_count_instr_target(bt) &&\n+            (size_in_bits == 512) && !VM_Version::supports_avx512bw()) {\n+          return false;\n+        }\n@@ -2059,6 +2059,0 @@\n-      if ((is_subword_type(bt) && !VM_Version::supports_avx512_bitalg()) ||\n-          ((bt == T_INT) && !VM_Version::supports_avx512_vpopcntdq())) {\n-        return false;\n-      }\n-      return true;\n-\n@@ -2066,1 +2060,1 @@\n-      if (!VM_Version::supports_avx512_vpopcntdq()) {\n+      if (!is_pop_count_instr_target(bt)) {\n@@ -8636,1 +8630,0 @@\n-\n@@ -8638,5 +8631,5 @@\n-  predicate((((Matcher::vector_element_basic_type(n->in(1)) == T_INT ||\n-               Matcher::vector_element_basic_type(n->in(1)) == T_LONG)) &&\n-             VM_Version::supports_avx512_vpopcntdq()) ||\n-            (is_subword_type(Matcher::vector_element_basic_type(n->in(1))) &&\n-             VM_Version::supports_avx512_bitalg()));\n+  predicate(UsePopCountInstruction &&\n+            ((is_subword_type(Matcher::vector_element_basic_type(n->in(1))) &&\n+              VM_Version::supports_avx512_bitalg()) ||\n+             (is_non_subword_integral_type(Matcher::vector_element_basic_type(n->in(1))) &&\n+              VM_Version::supports_avx512_vpopcntdq())));\n@@ -8648,1 +8641,0 @@\n-    assert(UsePopCountInstruction, \"not enabled\");\n@@ -8664,5 +8656,5 @@\n-  predicate((((Matcher::vector_element_basic_type(n->in(1)) == T_INT ||\n-               Matcher::vector_element_basic_type(n->in(1)) == T_LONG)) &&\n-             VM_Version::supports_avx512_vpopcntdq()) ||\n-            (is_subword_type(Matcher::vector_element_basic_type(n->in(1))) &&\n-             VM_Version::supports_avx512_bitalg()));\n+  predicate(UsePopCountInstruction &&\n+            ((is_subword_type(Matcher::vector_element_basic_type(n->in(1))) &&\n+              VM_Version::supports_avx512_bitalg()) ||\n+             (is_non_subword_integral_type(Matcher::vector_element_basic_type(n->in(1))) &&\n+              VM_Version::supports_avx512_vpopcntdq())));\n@@ -8673,1 +8665,0 @@\n-    assert(UsePopCountInstruction, \"not enabled\");\n@@ -8684,1 +8675,2 @@\n-  predicate((!VM_Version::supports_avx512_vpopcntdq() && Matcher::vector_element_basic_type(n->in(1)) == T_INT) ||\n+  predicate(!UsePopCountInstruction ||\n+            (!VM_Version::supports_avx512_vpopcntdq() && Matcher::vector_element_basic_type(n->in(1)) == T_INT) ||\n@@ -8690,1 +8682,0 @@\n-    assert(UsePopCountInstruction, \"not enabled\");\n@@ -8700,1 +8691,1 @@\n-  predicate(!VM_Version::supports_avx512_vpopcntdq());\n+  predicate(!UsePopCountInstruction || !VM_Version::supports_avx512_vpopcntdq());\n@@ -8705,1 +8696,0 @@\n-    assert(UsePopCountInstruction, \"not enabled\");\n","filename":"src\/hotspot\/cpu\/x86\/x86.ad","additions":26,"deletions":36,"binary":false,"changes":62,"status":"modified"},{"patch":"@@ -724,0 +724,4 @@\n+inline bool is_non_subword_integral_type(BasicType t) {\n+  return t == T_INT || t == T_LONG;\n+}\n+\n","filename":"src\/hotspot\/share\/utilities\/globalDefinitions.hpp","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"}]}