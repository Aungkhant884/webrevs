{"files":[{"patch":"@@ -285,1 +285,0 @@\n-        Objects.requireNonNull(array);\n@@ -287,4 +286,6 @@\n-        int size = Array.getLength(array);\n-        MemorySegment addr = allocate(MemoryLayout.sequenceLayout(size, elementLayout));\n-        MemorySegment.copy(heapSegmentFactory.apply(array), elementLayout, 0,\n-                addr, elementLayout.withOrder(ByteOrder.nativeOrder()), 0, size);\n+        int size = array == null ? 0 : Array.getLength(array);\n+        MemorySegment addr = allocateArray(elementLayout, size);\n+        if (size > 0) {\n+            MemorySegment.copy(heapSegmentFactory.apply(array), elementLayout, 0,\n+                    addr, elementLayout.withOrder(ByteOrder.nativeOrder()), 0, size);\n+        }\n","filename":"src\/java.base\/share\/classes\/java\/lang\/foreign\/SegmentAllocator.java","additions":6,"deletions":5,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -124,1 +124,15 @@\n-            \"java.lang.foreign.FunctionDescriptor\/withAttribute(java.lang.String,java.lang.constant.Constable)\/1\/0\"\n+            \"java.lang.foreign.FunctionDescriptor\/withAttribute(java.lang.String,java.lang.constant.Constable)\/1\/0\",\n+            \"java.lang.foreign.SegmentAllocator\/allocateArray(java.lang.foreign.ValueLayout$OfByte,byte[])\/1\/0\",\n+            \"java.lang.foreign.SegmentAllocator\/allocateArray(java.lang.foreign.ValueLayout$OfShort,short[])\/1\/0\",\n+            \"java.lang.foreign.SegmentAllocator\/allocateArray(java.lang.foreign.ValueLayout$OfChar,char[])\/1\/0\",\n+            \"java.lang.foreign.SegmentAllocator\/allocateArray(java.lang.foreign.ValueLayout$OfInt,int[])\/1\/0\",\n+            \"java.lang.foreign.SegmentAllocator\/allocateArray(java.lang.foreign.ValueLayout$OfFloat,float[])\/1\/0\",\n+            \"java.lang.foreign.SegmentAllocator\/allocateArray(java.lang.foreign.ValueLayout$OfLong,long[])\/1\/0\",\n+            \"java.lang.foreign.SegmentAllocator\/allocateArray(java.lang.foreign.ValueLayout$OfDouble,double[])\/1\/0\",\n+            \"java.lang.foreign.MemorySession\/allocateArray(java.lang.foreign.ValueLayout$OfByte,byte[])\/1\/0\",\n+            \"java.lang.foreign.MemorySession\/allocateArray(java.lang.foreign.ValueLayout$OfShort,short[])\/1\/0\",\n+            \"java.lang.foreign.MemorySession\/allocateArray(java.lang.foreign.ValueLayout$OfChar,char[])\/1\/0\",\n+            \"java.lang.foreign.MemorySession\/allocateArray(java.lang.foreign.ValueLayout$OfInt,int[])\/1\/0\",\n+            \"java.lang.foreign.MemorySession\/allocateArray(java.lang.foreign.ValueLayout$OfFloat,float[])\/1\/0\",\n+            \"java.lang.foreign.MemorySession\/allocateArray(java.lang.foreign.ValueLayout$OfLong,long[])\/1\/0\",\n+            \"java.lang.foreign.MemorySession\/allocateArray(java.lang.foreign.ValueLayout$OfDouble,double[])\/1\/0\"\n","filename":"test\/jdk\/java\/foreign\/TestNulls.java","additions":15,"deletions":1,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -46,0 +46,1 @@\n+import java.util.concurrent.atomic.AtomicInteger;\n@@ -162,0 +163,26 @@\n+    @Test\n+    public void testArrayAllocateDelegation() {\n+        AtomicInteger calls = new AtomicInteger();\n+        SegmentAllocator allocator = new SegmentAllocator() {\n+            @Override\n+            public MemorySegment allocate(long bytesSize, long bytesAlignment) {\n+                return null;\n+            }\n+\n+            @Override\n+            public MemorySegment allocateArray(MemoryLayout elementLayout, long count) {\n+                calls.incrementAndGet();\n+                return null;\n+            };\n+        };\n+        allocator.allocateArray(ValueLayout.JAVA_BYTE);\n+        allocator.allocateArray(ValueLayout.JAVA_SHORT);\n+        allocator.allocateArray(ValueLayout.JAVA_CHAR);\n+        allocator.allocateArray(ValueLayout.JAVA_INT);\n+        allocator.allocateArray(ValueLayout.JAVA_FLOAT);\n+        allocator.allocateArray(ValueLayout.JAVA_LONG);\n+        allocator.allocateArray(ValueLayout.JAVA_DOUBLE);\n+        assertEquals(calls.get(), 7);\n+    }\n+\n+\n","filename":"test\/jdk\/java\/foreign\/TestSegmentAllocators.java","additions":27,"deletions":0,"binary":false,"changes":27,"status":"modified"}]}