{"files":[{"patch":"@@ -3601,0 +3601,6 @@\n+    if (p->is_exiting()) {\n+      \/\/ If we got here via JavaThread::exit(), then we remember that the\n+      \/\/ thread's GC barrier has been detached. We don't do this when we get\n+      \/\/ here from another path, e.g., cleanup_failed_attach_current_thread().\n+      p->set_terminated(JavaThread::_thread_gc_barrier_detached);\n+    }\n","filename":"src\/hotspot\/share\/runtime\/thread.cpp","additions":6,"deletions":0,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -907,1 +907,1 @@\n-    _not_terminated = 0xDEAD - 2,\n+    _not_terminated = 0xDEAD - 3,\n@@ -909,0 +909,1 @@\n+    _thread_gc_barrier_detached,                 \/\/ thread's GC barrier has been detached\n@@ -917,1 +918,1 @@\n-  \/\/   _not_terminated => _thread_exiting => _thread_terminated\n+  \/\/   _not_terminated => _thread_exiting => _thread_gc_barrier_detached => _thread_terminated\n@@ -1175,1 +1176,2 @@\n-  \/\/ thread has called JavaThread::exit() or is terminated\n+  \/\/ thread has called JavaThread::exit(), thread's GC barrier is detached\n+  \/\/ or thread is terminated\n@@ -1177,0 +1179,2 @@\n+  \/\/ thread's GC barrier is detached or thread is terminated\n+  bool is_gc_barrier_detached() const;\n@@ -1178,1 +1182,1 @@\n-  \/\/ against the two non-terminated values so that a freed JavaThread\n+  \/\/ against the three non-terminated values so that a freed JavaThread\n@@ -1181,1 +1185,2 @@\n-    return l_terminated != _not_terminated && l_terminated != _thread_exiting;\n+    return l_terminated != _not_terminated && l_terminated != _thread_exiting &&\n+           l_terminated != _thread_gc_barrier_detached;\n","filename":"src\/hotspot\/share\/runtime\/thread.hpp","additions":10,"deletions":5,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -264,1 +264,1 @@\n-  \/\/ JavaThread::exit() is seen more quickly.\n+  \/\/ JavaThread::set_terminated() is seen more quickly.\n@@ -266,1 +266,11 @@\n-  return l_terminated == _thread_exiting || check_is_terminated(l_terminated);\n+  return l_terminated == _thread_exiting ||\n+         l_terminated == _thread_gc_barrier_detached ||\n+         check_is_terminated(l_terminated);\n+}\n+\n+inline bool JavaThread::is_gc_barrier_detached() const {\n+  \/\/ Use load-acquire so that setting of _terminated by\n+  \/\/ JavaThread::set_terminated() is seen more quickly.\n+  TerminatedTypes l_terminated = Atomic::load_acquire(&_terminated);\n+  return l_terminated == _thread_gc_barrier_detached ||\n+         check_is_terminated(l_terminated);\n@@ -271,1 +281,1 @@\n-  \/\/ JavaThread::exit() is seen more quickly.\n+  \/\/ JavaThread::set_terminated() is seen more quickly.\n","filename":"src\/hotspot\/share\/runtime\/thread.inline.hpp","additions":13,"deletions":3,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -166,1 +166,2 @@\n-    \/\/ JavaThread::exit() skipped calling current_thread_exiting()\n+    \/\/ We did not get here via JavaThread::exit() so current_thread_exiting()\n+    \/\/ was not called, e.g., JavaThread::cleanup_failed_attach_current_thread().\n","filename":"src\/hotspot\/share\/services\/threadService.cpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"}]}