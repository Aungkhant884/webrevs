{"files":[{"patch":"@@ -614,1 +614,1 @@\n-    _result = JVMTI_ERROR_OPAQUE_FRAME; \/\/ deferred locals currently unsupported in continuations\n+    _result = JVMTI_ERROR_OPAQUE_FRAME; \/\/ deferred locals are not fully supported in continuations\n@@ -647,0 +647,12 @@\n+    if (fr.is_heap_frame()) { \/\/ we want this check after the check for JVMTI_ERROR_INVALID_SLOT\n+      assert(Continuation::is_frame_in_continuation(_jvf->thread(), fr), \"sanity check\");\n+      \/\/ If the topmost frame is a heap frame, then it hasn't been thawed. This can happen\n+      \/\/ if we are executing at a return barrier safepoint. The callee frame has been popped,\n+      \/\/ but the caller frame has not been thawed. We can't support a JVMTI SetLocal in the callee\n+      \/\/ frame at this point, because we aren't truly in the callee yet.\n+      \/\/ fr.is_heap_frame() is impossible if a continuation is at a single step or breakpoint.\n+      \/\/ In such cases the top frames can't be frozen because of an agent callback frame.\n+      _result = JVMTI_ERROR_OPAQUE_FRAME; \/\/ deferred locals are not fully supported in continuations\n+      return;\n+    }\n+\n","filename":"src\/hotspot\/share\/prims\/jvmtiImpl.cpp","additions":13,"deletions":1,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -114,0 +114,1 @@\n+serviceability\/jvmti\/vthread\/GetSetLocalTest\/GetSetLocalTest.java 8286836 generic-all\n","filename":"test\/hotspot\/jtreg\/ProblemList.txt","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -38,2 +38,1 @@\n-    static final int MSG_COUNT = 600*1000;\n-    static final SynchronousQueue<String> QUEUE = new SynchronousQueue<>();\n+    static SynchronousQueue<String> QUEUE;\n@@ -59,5 +58,1 @@\n-            for (int i = 0; i < MSG_COUNT; i++) {\n-                if (completed()) {\n-                    consumer.interrupt();\n-                    break;\n-                }\n+            while (!completed()) {\n@@ -66,1 +61,3 @@\n-        } catch (InterruptedException e) { }\n+            consumer.interrupt();\n+        } catch (InterruptedException e) {\n+        }\n@@ -71,1 +68,1 @@\n-            for (int i = 0; i < MSG_COUNT; i++) {\n+            while(true) {\n@@ -80,0 +77,1 @@\n+        QUEUE = new SynchronousQueue<>();\n@@ -104,1 +102,5 @@\n-        obj.runTest();\n+\n+        for (int i = 0; i < 200; i++) {\n+            obj.runTest();\n+        }\n+\n","filename":"test\/hotspot\/jtreg\/serviceability\/jvmti\/vthread\/GetSetLocalTest\/GetSetLocalTest.java","additions":12,"deletions":10,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -235,1 +235,1 @@\n-              int depth, int frame_count, Values *values) {\n+              int depth, int frame_count, Values *values, bool at_event) {\n@@ -291,1 +291,1 @@\n-  } else if (err == JVMTI_ERROR_OPAQUE_FRAME) {\n+  } else if (!at_event && err == JVMTI_ERROR_OPAQUE_FRAME) {\n@@ -312,1 +312,1 @@\n-test_GetSetLocal(jvmtiEnv *jvmti, JNIEnv* jni, jthread vthread, int depth, int frame_count) {\n+test_GetSetLocal(jvmtiEnv *jvmti, JNIEnv* jni, jthread vthread, int depth, int frame_count, bool at_event) {\n@@ -322,2 +322,2 @@\n-  LOG(\"test_GetSetLocal: test_SetLocal with values1\\n\");\n-  bool success = test_SetLocal(jvmti, jni, cthread, vthread, depth, frame_count, &values1);\n+  LOG(\"test_GetSetLocal: test_SetLocal at_event: %d with values1\\n\", at_event);\n+  bool success = test_SetLocal(jvmti, jni, cthread, vthread, depth, frame_count, &values1, at_event);\n@@ -337,2 +337,2 @@\n-    LOG(\"test_GetSetLocal: test_SetLocal with values0 to restore original local values\\n\");\n-    test_SetLocal(jvmti, jni, cthread, vthread, depth, frame_count, &values0);\n+    LOG(\"test_GetSetLocal: test_SetLocal at_event: %d with values0 to restore original local values\\n\", at_event);\n+    test_SetLocal(jvmti, jni, cthread, vthread, depth, frame_count, &values0, at_event);\n@@ -363,1 +363,1 @@\n-    test_GetSetLocal(jvmti, jni, vthread, depth, frame_count);\n+    test_GetSetLocal(jvmti, jni, vthread, depth, frame_count, true \/* at_event *\/);\n@@ -473,1 +473,1 @@\n-      test_GetSetLocal(jvmti, jni, vthread, depth, frame_count);\n+      test_GetSetLocal(jvmti, jni, vthread, depth, frame_count, false \/* !at_event *\/);\n@@ -490,1 +490,5 @@\n-  return completed;\n+  if (completed) {\n+    completed = JNI_FALSE;\n+    return JNI_TRUE;\n+  }\n+  return JNI_FALSE;\n","filename":"test\/hotspot\/jtreg\/serviceability\/jvmti\/vthread\/GetSetLocalTest\/libGetSetLocalTest.cpp","additions":14,"deletions":10,"binary":false,"changes":24,"status":"modified"}]}