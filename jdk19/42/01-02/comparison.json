{"files":[{"patch":"@@ -614,1 +614,1 @@\n-    _result = JVMTI_ERROR_OPAQUE_FRAME; \/\/ deferred locals currently unsupported in continuations\n+    _result = JVMTI_ERROR_OPAQUE_FRAME; \/\/ deferred locals are not fully supported in continuations\n@@ -649,2 +649,7 @@\n-      \/\/ the safepoint could be as we return to the return barrier but before we execute it (poll return)\n-      _result = JVMTI_ERROR_OPAQUE_FRAME; \/\/ deferred locals currently unsupported in continuations\n+      \/\/ If the topmost frame is a heap frame, then it hasn't been thawed. This can happen\n+      \/\/ if we are executing at a return barrier safepoint. The callee frame has been popped,\n+      \/\/ but the caller frame has not been thawed. We can't support a JVMTI SetLocal in the callee\n+      \/\/ frame at this point, because we aren't truly in the callee yet.\n+      \/\/ fr.is_heap_frame() is impossible if a continuation is at a single step or breakpoint.\n+      \/\/ In such cases the top frames can't be frozen because of an agent callback frame.\n+      _result = JVMTI_ERROR_OPAQUE_FRAME; \/\/ deferred locals are not fully supported in continuations\n","filename":"src\/hotspot\/share\/prims\/jvmtiImpl.cpp","additions":8,"deletions":3,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -114,0 +114,1 @@\n+serviceability\/jvmti\/vthread\/GetSetLocalTest\/GetSetLocalTest.java 8286836 generic-all\n","filename":"test\/hotspot\/jtreg\/ProblemList.txt","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -103,1 +103,1 @@\n-        for (int i = 0; i < 1000; i++) {\n+        for (int i = 0; i < 200; i++) {\n","filename":"test\/hotspot\/jtreg\/serviceability\/jvmti\/vthread\/GetSetLocalTest\/GetSetLocalTest.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -235,1 +235,1 @@\n-              int depth, int frame_count, Values *values) {\n+              int depth, int frame_count, Values *values, bool at_event) {\n@@ -291,1 +291,1 @@\n-  } else if (err == JVMTI_ERROR_OPAQUE_FRAME) {\n+  } else if (!at_event && err == JVMTI_ERROR_OPAQUE_FRAME) {\n@@ -312,1 +312,1 @@\n-test_GetSetLocal(jvmtiEnv *jvmti, JNIEnv* jni, jthread vthread, int depth, int frame_count) {\n+test_GetSetLocal(jvmtiEnv *jvmti, JNIEnv* jni, jthread vthread, int depth, int frame_count, bool at_event) {\n@@ -322,2 +322,2 @@\n-  LOG(\"test_GetSetLocal: test_SetLocal with values1\\n\");\n-  bool success = test_SetLocal(jvmti, jni, cthread, vthread, depth, frame_count, &values1);\n+  LOG(\"test_GetSetLocal: test_SetLocal at_event: %d with values1\\n\", at_event);\n+  bool success = test_SetLocal(jvmti, jni, cthread, vthread, depth, frame_count, &values1, at_event);\n@@ -337,2 +337,2 @@\n-    LOG(\"test_GetSetLocal: test_SetLocal with values0 to restore original local values\\n\");\n-    test_SetLocal(jvmti, jni, cthread, vthread, depth, frame_count, &values0);\n+    LOG(\"test_GetSetLocal: test_SetLocal at_event: %d with values0 to restore original local values\\n\", at_event);\n+    test_SetLocal(jvmti, jni, cthread, vthread, depth, frame_count, &values0, at_event);\n@@ -363,1 +363,1 @@\n-    test_GetSetLocal(jvmti, jni, vthread, depth, frame_count);\n+    test_GetSetLocal(jvmti, jni, vthread, depth, frame_count, true \/* at_event *\/);\n@@ -473,1 +473,1 @@\n-      test_GetSetLocal(jvmti, jni, vthread, depth, frame_count);\n+      test_GetSetLocal(jvmti, jni, vthread, depth, frame_count, false \/* !at_event *\/);\n","filename":"test\/hotspot\/jtreg\/serviceability\/jvmti\/vthread\/GetSetLocalTest\/libGetSetLocalTest.cpp","additions":9,"deletions":9,"binary":false,"changes":18,"status":"modified"}]}